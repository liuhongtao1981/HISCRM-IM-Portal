# ç§ä¿¡æ˜¾ç¤ºé—®é¢˜è¯Šæ–­æŠ¥å‘Š

## é—®é¢˜æè¿°

**ç°è±¡**: IM PC å®¢æˆ·ç«¯æ˜¾ç¤º"æš‚æ— ç§ä¿¡"

**å·²å®Œæˆçš„ä¿®å¤**:
- âœ… conversation_id æ ¼å¼ç»Ÿä¸€ (100% ä½¿ç”¨åŠ å¯† ID)
- âœ… sender_id "unknown" é—®é¢˜å·²è§£å†³ (0% unknown)
- âœ… æ•°æ®åº“æ•°æ®ç»“æ„æ­£ç¡®

**å¾…è¯Šæ–­**: WebSocket æ•°æ®ä¼ è¾“å’Œå®¢æˆ·ç«¯æ˜¾ç¤ºé€»è¾‘

---

## å¿«é€Ÿè¯Šæ–­æ­¥éª¤

### 1ï¸âƒ£ å¯åŠ¨ Master

```bash
cd E:\HISCRM-IM-main\packages\master
npm start
```

**ç­‰å¾…æ—¥å¿—è¾“å‡º**:
```
âœ… Master æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ (ç«¯å£ 3000)
âœ… Worker è‡ªåŠ¨å¯åŠ¨å¹¶æ³¨å†Œ
âœ… Worker å¼€å§‹çˆ¬å–æ•°æ®...
```

---

### 2ï¸âƒ£ è¿è¡Œè¯Šæ–­è„šæœ¬

**æ–°å¼€ä¸€ä¸ªç»ˆç«¯**:

```bash
cd E:\HISCRM-IM-main
node tests/debug-im-client-display.js
```

---

## è¯Šæ–­è„šæœ¬è¾“å‡ºè§£è¯»

### æƒ…å†µ A: æ•°æ®ç»“æ„æ­£ç¡® âœ…

```
âœ… æ‰¾åˆ°ç§ä¿¡ä¸»é¢˜
  isPrivate: true âœ“
  messageCount: 2 âœ“

âœ… æ‰¾åˆ°ç§ä¿¡æ¶ˆæ¯
  messageCategory: "private" âœ“

ğŸ¯ è¯Šæ–­ç»“è®º:
âœ… Master æ•°æ®ç»“æ„æ­£ç¡®
   - Topics åŒ…å« isPrivate=true
   - Messages åŒ…å« messageCategory="private"

ğŸ’¡ é—®é¢˜å¯èƒ½åœ¨å®¢æˆ·ç«¯
```

**ä¸‹ä¸€æ­¥**: æ£€æŸ¥ IM PC å®¢æˆ·ç«¯ â†’ [è·³è½¬åˆ°æ­¥éª¤ 3](#3ï¸âƒ£-æ£€æŸ¥-im-pc-å®¢æˆ·ç«¯)

---

### æƒ…å†µ B: Topics ç¼ºå°‘ isPrivate å­—æ®µ âŒ

```
âš ï¸ å…³é”®é—®é¢˜: æ²¡æœ‰æ‰¾åˆ°ç§ä¿¡ä¸»é¢˜ (isPrivate=true)

åŸå› åˆ†æ:
  1. DataStore ä¸­æ²¡æœ‰ conversations æ•°æ®
  2. Master ä»£ç æœªæ­£ç¡®è®¾ç½® isPrivate å­—æ®µ
  3. Worker æœªçˆ¬å–ç§ä¿¡æ•°æ®
```

**ä¿®å¤æ­¥éª¤**:

1. æ£€æŸ¥ DataStore æ˜¯å¦æœ‰ conversations:
   ```bash
   # æŸ¥çœ‹ Master æ—¥å¿—
   # åº”è¯¥çœ‹åˆ°: [DEBUG] dataObj.conversations exists: true, size: 38
   ```

2. å¦‚æœæœ‰ conversations ä½†æ²¡æœ‰ isPrivateï¼Œä¿®å¤ä»£ç :

   ç¼–è¾‘ `packages/master/src/communication/im-websocket-server.js`

   æ‰¾åˆ°ç¬¬ 447 è¡Œé™„è¿‘:
   ```javascript
   const topic = {
     id: conversation.conversationId,
     channelId: channelId,
     title: conversation.userName || 'æœªçŸ¥ç”¨æˆ·',
     description: `ç§ä¿¡ä¼šè¯`,
     isPrivate: true  // âš ï¸ ç¡®è®¤æ­¤è¡Œå­˜åœ¨
   };
   ```

3. é‡å¯ Master

---

### æƒ…å†µ C: Messages ç¼ºå°‘ messageCategory å­—æ®µ âŒ

```
âš ï¸ å…³é”®é—®é¢˜: ç§ä¿¡ä¸»é¢˜çš„æ¶ˆæ¯æ²¡æœ‰ messageCategory="private"

åŸå› åˆ†æ:
  Master ä»£ç æœªæ­£ç¡®è®¾ç½® messageCategory å­—æ®µ
```

**ä¿®å¤æ­¥éª¤**:

ç¼–è¾‘ `packages/master/src/communication/im-websocket-server.js`

æ‰¾åˆ°ç¬¬ 575 è¡Œé™„è¿‘çš„ç§ä¿¡æ¶ˆæ¯å¤„ç†ä»£ç :
```javascript
if (dataObj.messages) {
  const messagesList = dataObj.messages instanceof Map ?
    Array.from(dataObj.messages.values()) : dataObj.messages;
  const msgs = messagesList.filter(m => m.conversationId === topicId);

  for (const msg of msgs) {
    const isOutgoing = msg.direction === 'outgoing';
    messages.push({
      id: msg.messageId,
      channelId: accountId,
      topicId: topicId,
      fromName: isOutgoing ? 'å®¢æœ' : (msg.senderName || 'æœªçŸ¥ç”¨æˆ·'),
      fromId: isOutgoing ? 'monitor_client' : (msg.senderId || ''),
      content: msg.content || '',
      type: msg.messageType || 'text',
      messageCategory: 'private',  // âš ï¸ ç¡®è®¤æ­¤è¡Œå­˜åœ¨
      // ...
    });
  }
}
```

é‡å¯ Master å¹¶é‡æ–°è¿è¡Œè¯Šæ–­è„šæœ¬ã€‚

---

## 3ï¸âƒ£ æ£€æŸ¥ IM PC å®¢æˆ·ç«¯

**å‰æ**: è¯Šæ–­è„šæœ¬æ˜¾ç¤º Master æ•°æ®ç»“æ„æ­£ç¡® âœ…

### å¯åŠ¨å®¢æˆ·ç«¯

```bash
cd E:\HISCRM-IM-main\packages\crm-pc-im
npm run dev
```

æµè§ˆå™¨æ‰“å¼€: http://localhost:5173

---

### æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°

æŒ‰ `F12` æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåˆ‡æ¢åˆ° `Console` æ ‡ç­¾

#### åº”è¯¥çœ‹åˆ°çš„æ—¥å¿—:

```javascript
[WebSocket] å·²è¿æ¥åˆ°æœåŠ¡å™¨
[WebSocket] æ”¶åˆ° monitor:registered äº‹ä»¶
[WebSocket] æ”¶åˆ° monitor:channels äº‹ä»¶
[WebSocket] æ”¶åˆ° monitor:topics äº‹ä»¶
```

#### å¦‚æœæ²¡æœ‰çœ‹åˆ°è¿™äº›æ—¥å¿—:

**é—®é¢˜**: WebSocket è¿æ¥æˆ–äº‹ä»¶ç›‘å¬æœ‰é—®é¢˜

**æ’æŸ¥**:

åœ¨æ§åˆ¶å°è¾“å…¥:
```javascript
// æ£€æŸ¥ WebSocket è¿æ¥çŠ¶æ€
console.log('Socket connected:', socket?.connected);
console.log('Socket id:', socket?.id);
```

---

### æ£€æŸ¥æ¥æ”¶åˆ°çš„æ•°æ®

åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ:

```javascript
// æ–¹æ³• 1: æ‹¦æˆª WebSocket äº‹ä»¶
const originalEmit = socket.emit.bind(socket);
socket.emit = function(event, data) {
  console.log(`[å‘é€] ${event}:`, data);
  return originalEmit(event, data);
};

const originalOn = socket.on.bind(socket);
socket.on = function(event, callback) {
  console.log(`[ç›‘å¬] ${event}`);
  return originalOn(event, (data) => {
    console.log(`[æ¥æ”¶] ${event}:`, data);
    callback(data);
  });
};

// æ–¹æ³• 2: æ‰‹åŠ¨è¯·æ±‚æ•°æ®å¹¶æŸ¥çœ‹
socket.emit('monitor:request_topics', {
  channelId: 'acc-98296c87-2e42-447a-9d8b-8be008ddb6e4'  // æ›¿æ¢ä¸ºå®é™…çš„ channelId
});

// ç­‰å¾… 1 ç§’åæŸ¥çœ‹äº‹ä»¶
```

#### æœŸæœ›çœ‹åˆ°çš„æ•°æ®ç»“æ„:

**Topics**:
```javascript
{
  channelId: "acc-...",
  topics: [
    {
      id: "MS4wLjABAAAA...",
      title: "ç”¨æˆ·å",
      isPrivate: true,  // âš ï¸ å…³é”®å­—æ®µ
      messageCount: 2
    }
  ]
}
```

**Messages**:
```javascript
{
  topicId: "MS4wLjABAAAA...",
  messages: [
    {
      id: "7435734662509774634",
      content: "æ¶ˆæ¯å†…å®¹",
      messageCategory: "private",  // âš ï¸ å…³é”®å­—æ®µ
      fromName: "ç”¨æˆ·å"
    }
  ]
}
```

---

### æ£€æŸ¥å®¢æˆ·ç«¯è¿‡æ»¤é€»è¾‘

å¦‚æœæ•°æ®æ¥æ”¶æ­£ç¡®ä½†ä»ä¸æ˜¾ç¤ºï¼Œé—®é¢˜åœ¨è¿‡æ»¤é€»è¾‘ã€‚

åœ¨æ§åˆ¶å°æ‰§è¡Œ:
```javascript
// æ£€æŸ¥å½“å‰çŠ¶æ€
console.log('selectedChannelId:', selectedChannelId);
console.log('currentTopics:', currentTopics);
console.log('messages:', messages);

// æ£€æŸ¥ç§ä¿¡è¿‡æ»¤
currentTopics?.forEach(topic => {
  const topicMessages = messages[topic.id] || [];
  const privateMessages = topicMessages.filter(m => m.messageCategory === 'private');

  console.log(`Topic: ${topic.title}`);
  console.log(`  isPrivate: ${topic.isPrivate}`);
  console.log(`  æ€»æ¶ˆæ¯æ•°: ${topicMessages.length}`);
  console.log(`  ç§ä¿¡æ¶ˆæ¯æ•°: ${privateMessages.length}`);
  console.log(`  ç¬¦åˆæ¡ä»¶: ${privateMessages.length > 0 || topic.isPrivate}`);
});
```

---

## å¸¸è§é—®é¢˜æ’æŸ¥

### Q1: Master æ—¥å¿—æ˜¾ç¤ºæœ‰ conversationsï¼Œä½†è¯Šæ–­è„šæœ¬è¯´æ²¡æœ‰

**åŸå› **: DataStore çš„ conversations æ˜¯ Map å¯¹è±¡ï¼Œéœ€è¦æ­£ç¡®è½¬æ¢

**æ£€æŸ¥**:
```javascript
// im-websocket-server.js ç¬¬ 425 è¡Œé™„è¿‘
if (conversationsSize > 0) {
  const conversationsList = dataObj.conversations instanceof Map ?
    Array.from(dataObj.conversations.values()) :  // âœ… æ­£ç¡®è½¬æ¢
    dataObj.conversations;
}
```

---

### Q2: è¯Šæ–­è„šæœ¬æ˜¾ç¤ºæ­£ç¡®ï¼Œä½†å®¢æˆ·ç«¯ä»ä¸æ˜¾ç¤º

**å¯èƒ½åŸå› **:

1. **æ¶ˆæ¯ä¸ä¸»é¢˜ ID ä¸åŒ¹é…**
   ```javascript
   // æ£€æŸ¥
   console.log('Topic IDs:', currentTopics.map(t => t.id));
   console.log('Message keys:', Object.keys(messages));
   // åº”è¯¥æœ‰äº¤é›†
   ```

2. **Redux store æœªæ›´æ–°**
   ```javascript
   // æ£€æŸ¥ Redux state
   window.__REDUX_DEVTOOLS_EXTENSION__?.store?.getState();
   ```

3. **ç»„ä»¶æœªé‡æ–°æ¸²æŸ“**
   - æ£€æŸ¥ React DevTools
   - æŸ¥çœ‹ MonitorPage ç»„ä»¶çš„ props å’Œ state

---

### Q3: å®¢æˆ·ç«¯æ˜¾ç¤ºç©ºç™½æˆ–åŠ è½½ä¸­

**æ’æŸ¥æ­¥éª¤**:

1. æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†é¢‘é“:
   ```javascript
   console.log('selectedChannelId:', selectedChannelId);
   // åº”è¯¥ä¸æ˜¯ null
   ```

2. æ£€æŸ¥è·¯ç”±:
   ```javascript
   console.log('å½“å‰è·¯ç”±:', window.location.pathname);
   // åº”è¯¥åœ¨ /monitor æˆ– /messages
   ```

3. æ£€æŸ¥ CSS æ ·å¼:
   - æ¶ˆæ¯å¯èƒ½è¢«éšè— (display: none)
   - æ¶ˆæ¯åœ¨è§†å£å¤– (overflow)

---

## æ€»ç»“

### éªŒè¯æµç¨‹

```
1. Master æ•°æ® (DataStore)
   â†“
2. WebSocket ä¼ è¾“ (Topics + Messages)
   â†“
3. å®¢æˆ·ç«¯æ¥æ”¶ (Socket.IO events)
   â†“
4. Redux å­˜å‚¨ (State management)
   â†“
5. ç»„ä»¶æ¸²æŸ“ (React components)
   â†“
6. UI æ˜¾ç¤º
```

### å·²éªŒè¯çš„ç¯èŠ‚ âœ…

- âœ… æ•°æ®åº“ç»“æ„æ­£ç¡® (conversation_id, sender_id)
- âœ… Master ä»£ç é€»è¾‘æ­£ç¡® (isPrivate, messageCategory)

### å¾…éªŒè¯çš„ç¯èŠ‚ â³

- â³ WebSocket å®é™…å‘é€çš„æ•°æ®
- â³ å®¢æˆ·ç«¯ WebSocket äº‹ä»¶æ¥æ”¶
- â³ Redux store æ•°æ®æ›´æ–°
- â³ ç»„ä»¶è¿‡æ»¤é€»è¾‘æ‰§è¡Œ
- â³ UI æ¸²æŸ“

---

## ä¸‹ä¸€æ­¥

**ç°åœ¨è¿è¡Œ**: `node tests/debug-im-client-display.js`

æ ¹æ®è¾“å‡ºç»“æœï¼Œæˆ‘ä»¬å°†ç¡®å®šé—®é¢˜åœ¨å“ªä¸ªç¯èŠ‚ï¼Œç„¶åé’ˆå¯¹æ€§ä¿®å¤ã€‚

å¦‚æœè¯Šæ–­è„šæœ¬æ˜¾ç¤º Master æ•°æ®æ­£ç¡®ï¼Œæˆ‘ä¼šå¸®ä½ åˆ›å»ºå®¢æˆ·ç«¯è°ƒè¯•è„šæœ¬ï¼Œæ·±å…¥æ£€æŸ¥æµè§ˆå™¨ç«¯çš„é—®é¢˜ã€‚
