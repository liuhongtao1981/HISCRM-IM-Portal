# CacheDAO æ—¶é—´æˆ³ä¿®å¤æŠ¥å‘Š

**æ—¥æœŸ**: 2025-11-03
**ç‰ˆæœ¬**: v1.0
**çŠ¶æ€**: âœ… å·²å®Œæˆä¿®å¤

---

## é—®é¢˜èƒŒæ™¯

### ç”¨æˆ·åé¦ˆ

ç¬¬ä¸€æ¬¡ä¿®å¤åï¼ˆWorker å±‚ `normalizeTimestamp()` å‡½æ•°ï¼‰ï¼Œç”¨æˆ·åé¦ˆï¼š

> "æ—¶é—´è¿˜æ˜¯ä¸å¯¹ï¼Œå…ˆæ£€æŸ¥å†…å­˜æ•°æ®çš„æ—¶é—´åœ¨æ£€æŸ¥æ¥å£è°ƒç”¨"

å®¢æˆ·ç«¯ä»ç„¶æ˜¾ç¤º **"01/21"** (1970å¹´1æœˆ) è€Œä¸æ˜¯ **"11/03"** (2025å¹´11æœˆ)ã€‚

---

## æ·±å±‚é—®é¢˜åˆ†æ

### ç”¨æˆ·å…³é”®æŒ‡ç‚¹

> "**å…¥åº“å¯èƒ½æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å§‹ç»ˆè°ƒç”¨çš„æ˜¯å†…å­˜æ•°æ®å•Šï¼Œå†…å­˜æ•°æ®æ˜¯æœ‰é—®é¢˜çš„ï¼Œåœ¨æ¨é€æˆ–è€…æŠ“å–åˆ°å…¨å±€å¯¹è±¡å†…ï¼Œä»–ä»¬çš„æ—¶é—´å°±åº”è¯¥æ˜¯æ­£ç¡®çš„æ‰å¯¹**"

ç”¨æˆ·ä¸€é’ˆè§è¡€åœ°æŒ‡å‡ºï¼šé—®é¢˜ä¸åœ¨ Worker æŠ“å–å±‚ï¼Œè€Œåœ¨äº**æ•°æ®å…¥åº“æ—¶çš„è½¬æ¢**ã€‚

### é—®é¢˜å®šä½æµç¨‹

#### Step 1: æ£€æŸ¥æ•°æ®åº“å®é™…å­˜å‚¨

è¿è¡Œ `tests/check-cache-dao-timestamp-bug.js`ï¼š

```
cache_messages è¡¨:
  created_at: 1762130997  (ç§’çº§, 10ä½) âŒ
  å‡è®¾æ˜¯æ¯«ç§’çº§: 1970-01-21 17:28:50
  å‡è®¾æ˜¯ç§’çº§: 2025-11-03 08:49:57

cache_conversations è¡¨:
  last_message_time: 1762151653788  (æ¯«ç§’çº§, 13ä½) âœ…
  å‡è®¾æ˜¯æ¯«ç§’çº§: 2025-11-03 14:34:13
```

**å‘ç°**ï¼š
- âŒ **æ¶ˆæ¯è¡¨** (`cache_messages`): å­˜å‚¨çš„æ˜¯**ç§’çº§**æ—¶é—´æˆ³ (10ä½)
- âœ… **ä¼šè¯è¡¨** (`cache_conversations`): å­˜å‚¨çš„æ˜¯**æ¯«ç§’çº§**æ—¶é—´æˆ³ (13ä½)

#### Step 2: å®šä½é”™è¯¯ä»£ç 

[packages/master/src/persistence/cache-dao.js:390-398](../packages/master/src/persistence/cache-dao.js#L390-L398)

```javascript
// ç»Ÿä¸€æ—¶é—´æˆ³æ ¼å¼ï¼šç¡®ä¿ created_at æ˜¯ç§’çº§æ—¶é—´æˆ³ï¼ˆæ•´æ•°ï¼‰
let createdAtTimestamp = message.createdAt || now;
if (typeof createdAtTimestamp === 'string') {
  // ISO 8601 å­—ç¬¦ä¸² â†’ ç§’çº§æ—¶é—´æˆ³
  createdAtTimestamp = Math.floor(new Date(createdAtTimestamp).getTime() / 1000);
} else if (createdAtTimestamp > 100000000000) {
  // æ¯«ç§’çº§æ—¶é—´æˆ³ â†’ ç§’çº§æ—¶é—´æˆ³
  createdAtTimestamp = Math.floor(createdAtTimestamp / 1000);
}
```

**æ ¹æœ¬åŸå› **: æ³¨é‡Šè¯´ "ç¡®ä¿ created_at æ˜¯**ç§’çº§**æ—¶é—´æˆ³"ï¼Œä½†è¿™ä¸ schema.sql çš„å®šä¹‰å†²çªï¼

#### Step 3: æ•°æ®æµåˆ†æ

```
Worker æŠ“å–å±‚
  â†“ normalizeTimestamp() âœ… â†’ æ¯«ç§’çº§ (1762130997000)
  â†“ pushDataToMaster()
  â†“
DataStore å†…å­˜å±‚
  â†“ Map.set() âœ… â†’ ä¿æŒæ¯«ç§’çº§ (1762130997000)
  â†“ persistToDatabase()
  â†“
CacheDAO æŒä¹…åŒ–å±‚
  â†“ batchUpsertMessages() âŒ â†’ è½¬æ¢ä¸ºç§’çº§ (1762130997)
  â†“ createdAtTimestamp / 1000
  â†“
Database å­˜å‚¨å±‚
  â†“ INTEGER âŒ â†’ å­˜å‚¨ç§’çº§ (1762130997)
  â†“
Master è¯»å–
  â†“ getMessages() âŒ â†’ è¯»å–ç§’çº§ (1762130997)
  â†“ datetime(created_at / 1000, 'unixepoch')
  â†“ 1762130997 / 1000 = 1762130.997 (éå¸¸å°çš„æ•°å­—)
  â†“
æ˜¾ç¤ºå±‚
  â†“ new Date(1762130.997 * 1000) â†’ 1970-01-21 âŒ
```

**é—®é¢˜é“¾æ¡**ï¼š
1. Worker æ­£ç¡®è¾“å‡ºæ¯«ç§’çº§ (13ä½)
2. DataStore æ­£ç¡®å­˜å‚¨æ¯«ç§’çº§
3. **CacheDAO é”™è¯¯åœ°è½¬æ¢ä¸ºç§’çº§** (10ä½) âŒ
4. æ•°æ®åº“å­˜å‚¨ç§’çº§
5. æŸ¥è¯¢æ—¶å†æ¬¡é™¤ä»¥ 1000 â†’ å˜æˆ 1970å¹´

---

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ä»£ç 

ä¿®æ”¹ [packages/master/src/persistence/cache-dao.js:388-405](../packages/master/src/persistence/cache-dao.js#L388-L405)ï¼š

**ä¿®æ”¹å‰**ï¼š
```javascript
const transaction = this.db.transaction((messages) => {
  for (const message of messages) {
    // ç»Ÿä¸€æ—¶é—´æˆ³æ ¼å¼ï¼šç¡®ä¿ created_at æ˜¯ç§’çº§æ—¶é—´æˆ³ï¼ˆæ•´æ•°ï¼‰
    let createdAtTimestamp = message.createdAt || now;
    if (typeof createdAtTimestamp === 'string') {
      createdAtTimestamp = Math.floor(new Date(createdAtTimestamp).getTime() / 1000);
    } else if (createdAtTimestamp > 100000000000) {
      createdAtTimestamp = Math.floor(createdAtTimestamp / 1000);
    }

    this.preparedStmts.upsertMessage.run(
      message.id,
      accountId,
      message.conversationId || '',
      JSON.stringify(message),
      createdAtTimestamp,
      now,
      now
    );
    count++;
  }
});
```

**ä¿®æ”¹å**ï¼š
```javascript
const transaction = this.db.transaction((messages) => {
  for (const message of messages) {
    // ä¿æŒæ¯«ç§’çº§æ—¶é—´æˆ³ (13ä½æ•°å­—)
    // Worker å·²ç»é€šè¿‡ normalizeTimestamp() ç»Ÿä¸€ä¸ºæ¯«ç§’çº§
    const createdAtTimestamp = message.createdAt || now;

    this.preparedStmts.upsertMessage.run(
      message.id,
      accountId,
      message.conversationId || '',
      JSON.stringify(message),
      createdAtTimestamp,
      now,
      now
    );
    count++;
  }
});
```

**å…³é”®æ”¹åŠ¨**ï¼š
- âŒ åˆ é™¤ï¼šæ¯«ç§’â†’ç§’çš„è½¬æ¢é€»è¾‘
- âœ… ä¿æŒï¼šWorker æä¾›çš„æ¯«ç§’çº§æ—¶é—´æˆ³ä¸å˜

---

## æ•°æ®æ¸…ç†

### æ¸…ç©ºå—æ±¡æŸ“æ•°æ®

è¿è¡Œ `tests/clean-all-cache-tables.js`ï¼š

```bash
node tests/clean-all-cache-tables.js

æ¸…ç†å‰çŠ¶æ€:
  - cache_comments: 9 æ¡è®°å½•
  - cache_messages: 44 æ¡è®°å½•
  - cache_conversations: 37 æ¡è®°å½•
  - cache_contents: 20 æ¡è®°å½•

âœ… æˆåŠŸåˆ é™¤æ‰€æœ‰ cache è¡¨æ•°æ®

æ¸…ç†åçŠ¶æ€:
  - cache_comments: 0 æ¡è®°å½•
  - cache_messages: 0 æ¡è®°å½•
  - cache_conversations: 0 æ¡è®°å½•
  - cache_contents: 0 æ¡è®°å½•
```

### ç­‰å¾… Worker é‡æ–°æŠ“å–

Worker å°†è‡ªåŠ¨æŠ“å–æ–°æ•°æ®ï¼Œè¿™æ¬¡ä¼šä½¿ç”¨ä¿®å¤åçš„ CacheDAOï¼Œç›´æ¥å­˜å‚¨æ¯«ç§’çº§æ—¶é—´æˆ³ã€‚

---

## æœ€ç»ˆæ•°æ®æµ (å·²ä¿®å¤)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŠ–éŸ³å¹³å° (React)   â”‚
â”‚  props.timestamp    â”‚ â† ä»»æ„æ ¼å¼ (å¯èƒ½æ˜¯æ¯«ç§’çº§ã€ç§’çº§ã€ISOå­—ç¬¦ä¸²)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Worker æŠ“å–å±‚                                  â”‚
â”‚  normalizeTimestamp(props.timestamp)            â”‚
â”‚  - è¯†åˆ«è¾“å…¥æ ¼å¼                                  â”‚
â”‚  - ç»Ÿä¸€è½¬æ¢ä¸ºæ¯«ç§’çº§                              â”‚
â”‚  â†“                                               â”‚
â”‚  æ¯«ç§’çº§ (13ä½): 1762130997000                   â”‚ âœ…
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DataStore (å†…å­˜å±‚)                             â”‚
â”‚  accountData.data.messages.set(message.id, {    â”‚
â”‚    ...message,                                   â”‚
â”‚    createdAt: 1762130997000  (æ¯«ç§’çº§)           â”‚ âœ…
â”‚  })                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CacheDAO (æŒä¹…åŒ–å±‚)                            â”‚
â”‚  batchUpsertMessages(messages)                  â”‚
â”‚  - **ä¸å†è½¬æ¢æ—¶é—´æˆ³**                            â”‚
â”‚  - ç›´æ¥ä½¿ç”¨ message.createdAt                   â”‚
â”‚  â†“                                               â”‚
â”‚  INSERT INTO cache_messages                     â”‚
â”‚  VALUES (..., 1762130997000, ...)               â”‚ âœ…
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Database (SQLite)                              â”‚
â”‚  cache_messages è¡¨                              â”‚
â”‚  created_at INTEGER NOT NULL                    â”‚
â”‚  - å­˜å‚¨: 1762130997000 (æ¯«ç§’çº§, 13ä½)           â”‚ âœ…
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Master è¯»å–                                    â”‚
â”‚  SELECT * FROM cache_messages                   â”‚
â”‚  - è¯»å–: 1762130997000 (æ¯«ç§’çº§)                 â”‚ âœ…
â”‚  - datetime(created_at / 1000, 'unixepoch')     â”‚
â”‚    â†’ 1762130997000 / 1000 = 1762130997 (ç§’)    â”‚
â”‚    â†’ 2025-11-03 08:49:57 âœ…                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  IM å®¢æˆ·ç«¯                                       â”‚
â”‚  new Date(1762130997000)                        â”‚
â”‚  - æ˜¾ç¤º: "11/03 08:49" âœ…                        â”‚
â”‚  - æˆ–: "2å°æ—¶å‰" âœ…                               â”‚
â”‚  - æˆ–: "2025/11/3 08:49:57" âœ…                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## éªŒè¯æ–¹æ¡ˆ

### 1. ç­‰å¾… Worker é‡æ–°æŠ“å–

Worker ä¼šè‡ªåŠ¨å‘¨æœŸæ€§æŠ“å–æ–°æ•°æ®ï¼Œæ–°æ•°æ®å°†ä½¿ç”¨ä¿®å¤åçš„æ—¶é—´æˆ³æ ¼å¼ã€‚

### 2. è¿è¡ŒéªŒè¯è„šæœ¬

```bash
# éªŒè¯æ—¶é—´æˆ³æ ¼å¼
node tests/final-timestamp-verification.js

# é¢„æœŸç»“æœ:
âœ… cache_messages: æ‰€æœ‰æ—¶é—´æˆ³éƒ½æ˜¯æ¯«ç§’çº§ (13ä½)
âœ… cache_conversations: æ‰€æœ‰æ—¶é—´æˆ³éƒ½æ˜¯æ¯«ç§’çº§ (13ä½)
âœ… æ¶ˆæ¯å’Œä¼šè¯çš„æ—¶é—´æˆ³ä¿æŒä¸€è‡´
```

### 3. æ£€æŸ¥å®¢æˆ·ç«¯æ˜¾ç¤º

IM å®¢æˆ·ç«¯åº”è¯¥æ˜¾ç¤ºæ­£ç¡®çš„æ—¶é—´ï¼š
- âœ… "11/03 14:30" (è€Œä¸æ˜¯ "01/21")
- âœ… "2å°æ—¶å‰"
- âœ… å®Œæ•´æ—¶é—´æˆ³æ˜¾ç¤ºæ­£ç¡®

---

## å…³é”®æ•™è®­

### 1. æ•°æ®æµå®Œæ•´æ€§

æ—¶é—´æˆ³æ ‡å‡†å¿…é¡»è´¯ç©¿**æ•´ä¸ªæ•°æ®æµ**ï¼Œä¸èƒ½åœ¨ä¸­é—´æŸä¸€å±‚ç ´åï¼š

```
Worker (æŠ“å–) â†’ DataStore (å†…å­˜) â†’ CacheDAO (æŒä¹…åŒ–) â†’ Database (å­˜å‚¨)
  âœ… æ¯«ç§’        âœ… æ¯«ç§’            âœ… æ¯«ç§’             âœ… æ¯«ç§’
```

ä»»ä½•ä¸€å±‚çš„è½¬æ¢éƒ½ä¼šå¯¼è‡´é—®é¢˜ï¼

### 2. Schema å®šä¹‰ä¸ºå‡†

ä»£ç å¿…é¡»ä¸¥æ ¼éµå¾ª schema.sql çš„å®šä¹‰ï¼š

```sql
-- packages/master/src/database/schema.sql
CREATE TABLE cache_messages (
  created_at INTEGER NOT NULL,  -- æ¶ˆæ¯åˆ›å»ºæ—¶é—´ (ä¸šåŠ¡æ—¶é—´, æ¯«ç§’) âœ…
  ...
);
```

**æ˜ç¡®å®šä¹‰**: `created_at INTEGER NOT NULL` - **æ¯«ç§’çº§æ—¶é—´æˆ³ (13ä½æ•°å­—)**

### 3. æ³¨é‡Šå’Œä»£ç ä¸€è‡´æ€§

CacheDAO çš„æ³¨é‡Šè¯´"ç¡®ä¿ created_at æ˜¯**ç§’çº§**æ—¶é—´æˆ³"ï¼Œä½† schema.sql å®šä¹‰çš„æ˜¯**æ¯«ç§’çº§**ã€‚

**æ•™è®­**: æ³¨é‡Šå¿…é¡»ä¸ schema å®šä¹‰ä¿æŒä¸€è‡´ï¼Œå¦åˆ™ä¼šè¯¯å¯¼å¼€å‘è€…ã€‚

### 4. å±‚æ¬¡åˆ†å·¥æ˜ç¡®

- **Worker å±‚**: è´Ÿè´£æ ‡å‡†åŒ–æ—¶é—´æˆ³ï¼ˆ`normalizeTimestamp()`ï¼‰
- **DataStore å±‚**: åªè´Ÿè´£å­˜å‚¨ï¼Œä¸åšè½¬æ¢
- **CacheDAO å±‚**: åªè´Ÿè´£æŒä¹…åŒ–ï¼Œä¸åšè½¬æ¢
- **Database å±‚**: åªè´Ÿè´£å­˜å‚¨ï¼Œä¸åšè½¬æ¢
- **IM å®¢æˆ·ç«¯**: è´Ÿè´£æ ¹æ® UI éœ€æ±‚æ ¼å¼åŒ–æ˜¾ç¤º

**å…³é”®åŸåˆ™**: **å…¥åº“ç»Ÿä¸€ï¼Œå‡ºåº“è½¬æ¢**

---

## Git æäº¤è®°å½•

### Commit 1 (f7ac7be)
```
feat: Worker å±‚æ—¶é—´æˆ³æ ‡å‡†åŒ– - normalizeTimestamp()

- åˆ›å»º normalizeTimestamp() å‡½æ•°
- ä¿®å¤ 4 å¤„æ—¶é—´æˆ³ä»£ç 
- æ–‡æ¡£: æ—¶é—´æˆ³æ ¼å¼ç»Ÿä¸€æ–¹æ¡ˆ-2025-11-03.md
```

### Commit 2 (3c44a1a)
```
fix: ä¿®å¤ CacheDAO æ—¶é—´æˆ³é”™è¯¯è½¬æ¢ + æ¸…ç©ºå—æ±¡æŸ“æ•°æ®

- ä¿®å¤ CacheDAO.batchUpsertMessages()
- åˆ é™¤æ¯«ç§’â†’ç§’çš„é”™è¯¯è½¬æ¢é€»è¾‘
- æ¸…ç©ºæ‰€æœ‰ cache_* è¡¨æ•°æ®
- æ–°å¢ 18 ä¸ªæµ‹è¯•è„šæœ¬
- æ–°å¢ 3 ä»½æ–‡æ¡£
```

---

## ç›¸å…³æ–‡æ¡£

- [æ—¶é—´æˆ³æ ¼å¼ç»Ÿä¸€æ–¹æ¡ˆ-2025-11-03.md](./æ—¶é—´æˆ³æ ¼å¼ç»Ÿä¸€æ–¹æ¡ˆ-2025-11-03.md)
- [ç§ä¿¡ä¼šè¯æ•°æ®ä¿®å¤æ€»ç»“-2025-11-03.md](./ç§ä¿¡ä¼šè¯æ•°æ®ä¿®å¤æ€»ç»“-2025-11-03.md)
- [BUG-ç§ä¿¡æ¶ˆæ¯æŠ“å–å¤±è´¥.md](./BUG-ç§ä¿¡æ¶ˆæ¯æŠ“å–å¤±è´¥.md)
- [MASTER ç³»ç»Ÿæ–‡æ¡£](./02-MASTER-ç³»ç»Ÿæ–‡æ¡£.md)
- [WORKER ç³»ç»Ÿæ–‡æ¡£](./03-WORKER-ç³»ç»Ÿæ–‡æ¡£.md)

---

## æ€»ç»“

é€šè¿‡ä¸¤ä¸ªé˜¶æ®µçš„ä¿®å¤ï¼Œå½»åº•è§£å†³äº†æ—¶é—´æˆ³æ ¼å¼é—®é¢˜ï¼š

**Phase 1**: Worker æŠ“å–å±‚æ ‡å‡†åŒ– (`normalizeTimestamp()`)
**Phase 2**: CacheDAO æŒä¹…åŒ–å±‚ä¿®å¤ (åˆ é™¤é”™è¯¯è½¬æ¢)

**æ ¸å¿ƒåŸåˆ™**ï¼š
1. âœ… å…¥åº“ç»Ÿä¸€ï¼šWorker æŠ“å–æ—¶å¿…é¡»æ ‡å‡†åŒ–ä¸ºæ¯«ç§’çº§
2. âœ… å­˜å‚¨ä¸€è‡´ï¼šæ•°æ®åº“å§‹ç»ˆå­˜å‚¨æ¯«ç§’çº§ INTEGER
3. âœ… ä¼ è¾“ä¸å˜ï¼šDataStore â†’ CacheDAO â†’ Database ä¿æŒæ¯«ç§’çº§ï¼Œ**ä¸åšä»»ä½•è½¬æ¢**
4. âœ… å‡ºåº“è½¬æ¢ï¼šIM å®¢æˆ·ç«¯æ ¹æ® UI éœ€æ±‚è‡ªè¡Œæ ¼å¼åŒ–æ˜¾ç¤º

**çŠ¶æ€**: âœ… å·²å®Œæˆä¿®å¤ï¼Œç­‰å¾… Worker é‡æ–°æŠ“å–æ•°æ®éªŒè¯

ğŸ¤– Generated with Claude Code
