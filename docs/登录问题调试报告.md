# ç™»å½•é—®é¢˜è°ƒè¯•æŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-24
**é—®é¢˜**: Worker æ”¶åˆ°ç™»å½•è¯·æ±‚åæ‰“å¼€æµè§ˆå™¨ä½†ä¸€ç›´åœç•™åœ¨é¦–é¡µï¼Œæ²¡æœ‰æ˜¾ç¤ºäºŒç»´ç 

---

## ğŸ“‹ é—®é¢˜æè¿°

### ç—‡çŠ¶
1. Admin Web ç‚¹å‡»"ç™»å½•"æŒ‰é’®
2. Worker æ‰“å¼€äº†æµè§ˆå™¨
3. **æµè§ˆå™¨ä¸€ç›´åœç•™åœ¨é¦–é¡µï¼Œæ²¡æœ‰ä»»ä½•ååº”**
4. Admin Web æ˜¾ç¤º"æ­£åœ¨åŠ è½½..."å¯¹è¯æ¡†ï¼Œä¸€ç›´ç­‰å¾…

### é¢„æœŸè¡Œä¸º
1. Worker æ¥æ”¶åˆ°ç™»å½•è¯·æ±‚
2. æ‰“å¼€æµè§ˆå™¨å¹¶å¯¼èˆªåˆ°æŠ–éŸ³åˆ›ä½œè€…ä¸­å¿ƒ
3. æ£€æµ‹ç™»å½•æ–¹å¼ï¼ˆäºŒç»´ç  vs å·²ç™»å½•ï¼‰
4. å¦‚æœæœªç™»å½•ï¼Œæˆªå–äºŒç»´ç å¹¶å‘é€ç»™ Master
5. Admin Web æ˜¾ç¤ºäºŒç»´ç ä¾›ç”¨æˆ·æ‰«æ

---

## ğŸ” é—®é¢˜åˆ†æ

### 1. Master æ—¥å¿—

```log
2025-10-24 10:41:57.530 [admin-namespace] Login request sent to worker worker1 for platform douyin
2025-10-24 10:42:12.927 [admin-namespace] Login request sent to worker worker1 for platform douyin
```

**ç»“è®º**: Master æ­£ç¡®å‘é€äº†ç™»å½•è¯·æ±‚ï¼ˆ`master:login:start` äº‹ä»¶ï¼‰

### 2. Worker æ—¥å¿—

**é—®é¢˜**: æ²¡æœ‰çœ‹åˆ° Worker çš„ä»»ä½•ç™»å½•ç›¸å…³æ—¥å¿—ï¼

**æ­£å¸¸åº”è¯¥æœ‰çš„æ—¥å¿—**:
```log
Received login request for account xxx, platform douyin, session xxx
[Login] Starting for account xxx
[QRCode Login] Starting for account xxx
Navigating to Douyin Creator Center...
```

**ç»“è®º**: Worker å¯èƒ½æ²¡æœ‰æ”¶åˆ°ç™»å½•è¯·æ±‚ï¼Œæˆ–è€…æ”¶åˆ°äº†ä½†å¤„ç†å‡½æ•°æŠ¥é”™äº†

### 3. ä»£ç æµç¨‹è¿½è¸ª

#### Master â†’ Worker é€šä¿¡

**Master ç«¯** (`src/socket/admin-namespace.js:290`):
```javascript
workerSocket.emit('master:login:start', {
  account_id,
  session_id,
  platform: account.platform,
  proxy: proxyConfig,
});
```

**Worker ç«¯** (`src/index.js:179`):
```javascript
socketClient.socket.on('master:login:start', (data) => {
  handleLoginRequest(data);
});
```

**äº‹ä»¶ååŒ¹é…**: âœ… æ­£ç¡®ï¼ˆéƒ½æ˜¯ `master:login:start`ï¼‰

#### Worker ç™»å½•å¤„ç†

**handleLoginRequest** (`src/index.js:280-310`):
```javascript
async function handleLoginRequest(data) {
  const { account_id, session_id, platform, proxy } = data;

  logger.info(`Received login request for account ${account_id}...`);

  const platformInstance = platformManager.getPlatform(platform);
  await platformInstance.startLogin({
    accountId: account_id,
    sessionId: session_id,
    proxy,
  });
}
```

**é—®é¢˜æ‰€åœ¨**:
1. å‡½æ•°å¯èƒ½æŠ›å‡ºäº†å¼‚å¸¸ä½†æ²¡æœ‰è¢«æ•è·
2. `platformInstance.startLogin()` å¯èƒ½å¡ä½äº†
3. æ²¡æœ‰æ—¥å¿—è¾“å‡ºè¯´æ˜ä»£ç å¯èƒ½æ²¡æœ‰æ‰§è¡Œåˆ°

---

## ğŸ› å¯èƒ½çš„åŸå› 

### åŸå› 1: Worker è¿›ç¨‹æ²¡æœ‰æ­£ç¡®æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨

**éªŒè¯æ–¹æ³•**: æ£€æŸ¥ Worker è¿›ç¨‹æ˜¯å¦å®Œå…¨å¯åŠ¨

**è¯æ®**:
- Worker è¿›ç¨‹ PID 2732 è¿˜åœ¨è¿è¡Œ âœ…
- Worker å·²ç»è¿æ¥åˆ° Master å¹¶æ³¨å†Œ âœ…
- Worker å‘é€äº†å¿ƒè·³ âœ…

**ç»“è®º**: Worker è¿›ç¨‹æ­£å¸¸è¿è¡Œ

### åŸå› 2: Worker çš„ Socket.IO è¿æ¥æœ‰é—®é¢˜

**Master æ—¥å¿—**:
```
2025-10-24 10:41:51.543 [socket-server] Worker connected: 5IIJBvHP-3wckD03AAAD
2025-10-24 10:41:51.591 [worker-registration] Worker worker1 assigned 1 accounts
```

**ç»“è®º**: Socket.IO è¿æ¥æ­£å¸¸

### åŸå› 3: `handleLoginRequest` å‡½æ•°æ‰§è¡Œå¤±è´¥

**æœ€å¯èƒ½çš„åŸå› **:
1. `platformManager.getPlatform(platform)` è¿”å› null
2. `startLogin` æ–¹æ³•å†…éƒ¨æŠ›å‡ºå¼‚å¸¸
3. å¼‚å¸¸è¢«é™é»˜æ•è·ï¼Œæ²¡æœ‰æ—¥å¿—è¾“å‡º

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: å¢åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

**ä¿®æ”¹æ–‡ä»¶**: `packages/worker/src/index.js`

**é—®é¢˜ä»£ç ** (ç¬¬280-310è¡Œ):
```javascript
async function handleLoginRequest(data) {
  const { account_id, session_id, platform, proxy } = data;

  try {
    logger.info(`Received login request for account ${account_id}, platform ${platform}, session ${session_id}`);

    const platformInstance = platformManager.getPlatform(platform);
    if (!platformInstance) {
      throw new Error(`Platform ${platform} not supported or not loaded`);
    }

    await platformInstance.startLogin({
      accountId: account_id,
      sessionId: session_id,
      proxy,
    });

    logger.info(`Login process started for account ${account_id} on platform ${platform}`);
  } catch (error) {
    logger.error(`Failed to handle login request for account ${account_id}:`, error);
    workerBridge.sendLoginStatus(data.account_id, data.session_id, 'failed', error.message);
  }
}
```

**ä¿®æ”¹å»ºè®®**:
```javascript
async function handleLoginRequest(data) {
  logger.info(`[handleLoginRequest] Received data:`, JSON.stringify(data));

  const { account_id, session_id, platform, proxy } = data;

  try {
    logger.info(`[handleLoginRequest] account_id=${account_id}, platform=${platform}, session_id=${session_id}`);

    // éªŒè¯ platformManager æ˜¯å¦å­˜åœ¨
    if (!platformManager) {
      throw new Error('platformManager is not initialized');
    }

    logger.info(`[handleLoginRequest] Getting platform instance for: ${platform}`);
    const platformInstance = platformManager.getPlatform(platform);

    if (!platformInstance) {
      logger.error(`[handleLoginRequest] Platform ${platform} not found`);
      logger.error(`[handleLoginRequest] Available platforms:`, platformManager.platforms);
      throw new Error(`Platform ${platform} not supported or not loaded`);
    }

    logger.info(`[handleLoginRequest] Platform instance found, calling startLogin...`);
    await platformInstance.startLogin({
      accountId: account_id,
      sessionId: session_id,
      proxy,
    });

    logger.info(`[handleLoginRequest] Login process started for account ${account_id}`);
  } catch (error) {
    logger.error(`[handleLoginRequest] FATAL ERROR for account ${account_id}:`, error);
    logger.error(`[handleLoginRequest] Error stack:`, error.stack);

    // ç¡®ä¿å‘é€å¤±è´¥çŠ¶æ€
    try {
      workerBridge.sendLoginStatus(account_id, session_id, 'failed', error.message);
    } catch (sendError) {
      logger.error(`[handleLoginRequest] Failed to send error status:`, sendError);
    }
  }
}
```

### æ–¹æ¡ˆ2: æ£€æŸ¥ `startLogin` æ–¹æ³•

**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/platform.js`

**é—®é¢˜**: `startLogin` æ–¹æ³•å¯èƒ½åœ¨æŸä¸ªæ­¥éª¤å¡ä½

**éœ€è¦æ£€æŸ¥çš„æ­¥éª¤**:
1. `getAccountPage()` - è·å–æµè§ˆå™¨é¡µé¢
2. `page.goto()` - å¯¼èˆªåˆ°åˆ›ä½œè€…ä¸­å¿ƒ
3. `detectLoginMethod()` - æ£€æµ‹ç™»å½•æ–¹å¼
4. `handleQRCodeLogin()` - å¤„ç†äºŒç»´ç ç™»å½•

**ä¿®æ”¹å»ºè®®**: åœ¨æ¯ä¸ªæ­¥éª¤æ·»åŠ è¯¦ç»†æ—¥å¿—

### æ–¹æ¡ˆ3: æ·»åŠ è¶…æ—¶ä¿æŠ¤

**é—®é¢˜**: å¦‚æœæŸä¸ªæ­¥éª¤å¡ä½ï¼Œæ•´ä¸ªç™»å½•æµç¨‹ä¼šä¸€ç›´ç­‰å¾…

**ä¿®æ”¹å»ºè®®**:
```javascript
// åœ¨ startLogin æ–¹æ³•ä¸­æ·»åŠ æ€»è¶…æ—¶
async startLogin(options) {
  const { accountId, sessionId, proxy } = options;

  // è®¾ç½®æ€»è¶…æ—¶æ—¶é—´ä¸º 60 ç§’
  const timeoutPromise = new Promise((_, reject) => {
    setTimeout(() => reject(new Error('Login timeout after 60 seconds')), 60000);
  });

  const loginPromise = this.login(accountId, sessionId, options);

  try {
    await Promise.race([loginPromise, timeoutPromise]);
  } catch (error) {
    logger.error(`[startLogin] Login failed or timeout:`, error);
    throw error;
  }
}
```

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³è¡ŒåŠ¨

1. âœ… **å·²å®Œæˆ**: ä¿®å¤ç™»å½•æˆåŠŸåè·³è½¬åˆ°åˆ›ä½œä¸­å¿ƒçš„é—®é¢˜
   - æ–‡ä»¶: `packages/worker/src/platforms/base/platform-base.js`
   - ä¿®æ”¹: åœ¨ `waitForLogin` çš„ç¬¬181-195è¡Œæ·»åŠ äº†å¯¼èˆªé€»è¾‘

2. â³ **è¿›è¡Œä¸­**: é‡å¯ Master å’Œ Worker åº”ç”¨ä¿®å¤

3. â³ **å¾…å¤„ç†**: æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
   - ä¿®æ”¹ `handleLoginRequest` å‡½æ•°
   - æ·»åŠ æ¯ä¸ªæ­¥éª¤çš„æ—¥å¿—è¾“å‡º

4. â³ **å¾…å¤„ç†**: æµ‹è¯•ç™»å½•æµç¨‹
   - ç‚¹å‡»ç™»å½•æŒ‰é’®
   - è§‚å¯Ÿ Worker æ—¥å¿—
   - ç¡®è®¤äºŒç»´ç æ˜¯å¦æ­£ç¡®æ˜¾ç¤º

### åç»­ä¼˜åŒ–

1. æ·»åŠ ç™»å½•æµç¨‹çš„è¶…æ—¶ä¿æŠ¤
2. æ”¹è¿›é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º
3. æ·»åŠ ç™»å½•çŠ¶æ€çš„å®æ—¶åé¦ˆ

---

## ğŸ“ æµ‹è¯•æ¸…å•

- [ ] Worker æ”¶åˆ° `master:login:start` äº‹ä»¶
- [ ] Worker è¾“å‡º "Received login request..." æ—¥å¿—
- [ ] Worker æˆåŠŸè·å– platform å®ä¾‹
- [ ] Worker è°ƒç”¨ `startLogin` æ–¹æ³•
- [ ] Worker è¾“å‡º "Navigating to Douyin Creator Center..." æ—¥å¿—
- [ ] æµè§ˆå™¨å¯¼èˆªåˆ° `https://creator.douyin.com/`
- [ ] Worker æ£€æµ‹åˆ°äºŒç»´ç 
- [ ] Worker å‘é€äºŒç»´ç åˆ° Master
- [ ] Admin Web æ˜¾ç¤ºäºŒç»´ç å¯¹è¯æ¡†

---

**æŠ¥å‘Šäºº**: Claude
**çŠ¶æ€**: ğŸ”§ é—®é¢˜å®šä½ä¸­ï¼Œç­‰å¾…é‡å¯æµ‹è¯•
