# ç»Ÿä¸€æ•°æ®ç®¡ç†æ¶æ„ - é›†æˆæŒ‡å—

**ç‰ˆæœ¬**: 1.0
**æ—¥æœŸ**: 2025-10-28
**çŠ¶æ€**: Phase 2 å·²å®Œæˆ - åŸºç¡€è®¾æ–½å°±ç»ª

---

## ğŸ“‹ æ¦‚è§ˆ

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•å°†ç°æœ‰çˆ¬è™«è¿ç§»åˆ°æ–°çš„ç»Ÿä¸€æ•°æ®ç®¡ç†æ¶æ„ã€‚

**Phase 2 å®Œæˆå†…å®¹**ï¼š
- âœ… DataPusher æ¥å£ï¼ˆä¸ Master é€šä¿¡ï¼‰
- âœ… PlatformBase åˆå§‹åŒ– DataManager
- âœ… DouyinPlatform å®ç° createDataManager()
- âœ… æ–°æ¶ˆæ¯ç±»å‹æ³¨å†Œï¼ˆshared/protocol/messages.jsï¼‰

**ä¸‹ä¸€æ­¥**ï¼šé‡æ„ç°æœ‰çˆ¬è™«ä½¿ç”¨æ–°æ¶æ„ï¼ˆç§ä¿¡ â†’ ä½œå“ â†’ è¯„è®ºï¼‰

---

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

### æ•°æ®æµ

```
Crawler (API/DOM)
  â†“
Platform.getDataManager()
  â†“
dataManager.batchUpsertConversations(rawData, DataSource.API)
  â†“
è‡ªåŠ¨æ˜ å°„ï¼ˆDouyinDataManager.mapConversationDataï¼‰
  â†“
è‡ªåŠ¨çŠ¶æ€ç®¡ç†ï¼ˆNEW â†’ UPDATEDï¼‰
  â†“
è‡ªåŠ¨è„æ ‡è®°ï¼ˆdirtyIdsï¼‰
  â†“
è‡ªåŠ¨åŒæ­¥åˆ° Masterï¼ˆæ¯ 5 ç§’ï¼‰
```

### æ ¸å¿ƒç»„ä»¶

1. **DataPusher** (`packages/worker/src/platforms/base/data-pusher.js`)
   - è´Ÿè´£ä¸ Master é€šä¿¡
   - æ”¯æŒæ‰¹é‡æ¨é€å’Œé˜Ÿåˆ—ç®¡ç†
   - ä½¿ç”¨æ–°æ¶ˆæ¯ç±»å‹ï¼ˆWORKER_*_UPDATEï¼‰

2. **PlatformBase** (`packages/worker/src/platforms/base/platform-base.js`)
   - åœ¨ initialize() ä¸­è‡ªåŠ¨åˆ›å»º DataManager
   - åœ¨ cleanup() ä¸­è‡ªåŠ¨æ¸…ç† DataManager
   - æä¾› getDataManager(accountId) è®¿é—®æ¥å£

3. **DouyinPlatform** (`packages/worker/src/platforms/douyin/platform.js`)
   - å®ç° createDataManager() è¿”å› DouyinDataManager
   - è‡ªåŠ¨ç»§æ‰¿æ‰€æœ‰ PlatformBase çš„ DataManager ç®¡ç†é€»è¾‘

4. **DouyinDataManager** (`packages/worker/src/platforms/douyin/douyin-data-manager.js`)
   - å®ç°æ‰€æœ‰æ˜ å°„æ–¹æ³•ï¼ˆæŠ–éŸ³ â†’ æ ‡å‡†æ ¼å¼ï¼‰
   - å·²å®ç°çš„æ˜ å°„ï¼šä¼šè¯ã€æ¶ˆæ¯ã€ä½œå“ã€è¯„è®ºã€é€šçŸ¥

---

## ğŸ”„ çˆ¬è™«è¿ç§»æ­¥éª¤

### æ­¥éª¤ 1ï¼šè·å– DataManager

åœ¨çˆ¬è™«å‡½æ•°å¼€å§‹æ—¶è·å– DataManagerï¼š

```javascript
// æ—§ä»£ç ï¼šç›´æ¥æ“ä½œæœ¬åœ°å˜é‡
const apiData = {
  conversations: [],
  messages: [],
};

// æ–°ä»£ç ï¼šè·å– DataManager
const dataManager = platform.getDataManager(accountId);
if (!dataManager) {
  throw new Error(`DataManager not initialized for account ${accountId}`);
}
```

### æ­¥éª¤ 2ï¼šä½¿ç”¨ batchUpsert* æ–¹æ³•

å°† API/DOM æ•°æ®ä¼ é€’ç»™ DataManagerï¼š

```javascript
// æ—§ä»£ç ï¼šæ‰‹åŠ¨æ”¶é›†æ•°æ®
apiData.conversations.push(...conversationList);

// æ–°ä»£ç ï¼šæ‰¹é‡æ’å…¥ï¼ˆè‡ªåŠ¨æ˜ å°„ + çŠ¶æ€ç®¡ç†ï¼‰
const conversations = dataManager.batchUpsertConversations(
  conversationList,  // åŸå§‹æŠ–éŸ³ API æ•°æ®
  DataSource.API     // æ•°æ®æ¥æº
);

logger.info(`Inserted ${conversations.length} conversations`);
```

### æ­¥éª¤ 3ï¼šç§»é™¤æ‰‹åŠ¨æ¨é€é€»è¾‘

DataManager ä¼šè‡ªåŠ¨åŒæ­¥æ•°æ®åˆ° Masterï¼š

```javascript
// æ—§ä»£ç ï¼šæ‰‹åŠ¨æ¨é€
await this.bridge.sendToMaster(createMessage(
  MessageTypes.WORKER_BULK_INSERT_CONVERSATIONS,
  { accountId, conversations: apiData.conversations }
));

// æ–°ä»£ç ï¼šè‡ªåŠ¨æ¨é€ï¼ˆæ— éœ€æ‰‹åŠ¨è°ƒç”¨ï¼‰
// DataManager æ¯ 5 ç§’è‡ªåŠ¨åŒæ­¥è„æ•°æ®
```

### æ­¥éª¤ 4ï¼šæ¸…ç†ä¸´æ—¶æ•°æ®ç»“æ„

ç§»é™¤çˆ¬è™«å‡½æ•°ä¸­çš„æœ¬åœ°æ•°æ®æ”¶é›†å˜é‡ï¼š

```javascript
// åˆ é™¤è¿™äº›ï¼š
const apiData = {
  conversations: [],
  messages: [],
  cache: new Set(),
};

// æ‰€æœ‰æ•°æ®ç°åœ¨éƒ½åœ¨ DataManager ä¸­ç®¡ç†
```

---

## ğŸ“ ç¤ºä¾‹ï¼šé‡æ„ç§ä¿¡çˆ¬è™«

### æ—§ä»£ç ï¼ˆcrawl-direct-messages-v2.jsï¼‰

```javascript
// API æ•°æ®æ”¶é›†
const apiData = {
  conversations: [],
  messages: [],
  cache: new Set(),
};

// API å›è°ƒ
async function onConversationListAPI(body, route) {
  if (!body || !body.user_list) return;

  const url = route.request().url();
  if (apiData.cache.has(url)) return;

  apiData.cache.add(url);
  apiData.conversations.push(...body.user_list);
}

// ä¸»çˆ¬è™«å‡½æ•°
async function crawlDirectMessagesV2(account, platform, browserManager) {
  // ... å¯¼èˆªå’Œç­‰å¾… ...

  // æ‰‹åŠ¨æ¨é€æ•°æ®
  await platform.bridge.sendToMaster(createMessage(
    MessageTypes.WORKER_BULK_INSERT_CONVERSATIONS,
    { accountId: account.id, conversations: apiData.conversations }
  ));
}
```

### æ–°ä»£ç ï¼ˆä½¿ç”¨ DataManagerï¼‰

```javascript
// âœ… ç¬¬ 1 æ­¥ï¼šè·å– DataManager
const dataManager = platform.getDataManager(account.id);

// âœ… ç¬¬ 2 æ­¥ï¼šAPI å›è°ƒç›´æ¥ä½¿ç”¨ DataManager
async function onConversationListAPI(body, route) {
  if (!body || !body.user_list) return;

  // æ‰¹é‡æ’å…¥ï¼ˆè‡ªåŠ¨å»é‡ã€æ˜ å°„ã€çŠ¶æ€ç®¡ç†ï¼‰
  const conversations = dataManager.batchUpsertConversations(
    body.user_list,
    DataSource.API
  );

  logger.info(`âœ… Inserted ${conversations.length} conversations from API`);
}

// âœ… ç¬¬ 3 æ­¥ï¼šä¸»çˆ¬è™«å‡½æ•°ä¸å†éœ€è¦æ¨é€é€»è¾‘
async function crawlDirectMessagesV2(account, platform, browserManager) {
  const dataManager = platform.getDataManager(account.id);

  // ... å¯¼èˆªå’Œç­‰å¾… ...

  // ç»Ÿè®¡æ•°æ®ï¼ˆä» DataManager è·å–ï¼‰
  const stats = dataManager.getStats();
  logger.info(`Crawl complete:`, stats);

  // DataManager ä¼šè‡ªåŠ¨åŒæ­¥æ•°æ®åˆ° Masterï¼ˆæ— éœ€æ‰‹åŠ¨æ¨é€ï¼‰
}
```

---

## ğŸ”‘ å…³é”®ä¼˜åŠ¿

### 1. è‡ªåŠ¨æ•°æ®å»é‡

```javascript
// æ—§ä»£ç ï¼šæ‰‹åŠ¨ç»´æŠ¤ Set å»é‡
if (apiData.cache.has(url)) return;
apiData.cache.add(url);

// æ–°ä»£ç ï¼šDataManager è‡ªåŠ¨åŸºäº ID å»é‡
// åŒä¸€ä¸ª conversationId å¤šæ¬¡ upsert ä¼šè‡ªåŠ¨åˆå¹¶
dataManager.upsertConversation(data);
dataManager.upsertConversation(data); // è‡ªåŠ¨è¦†ç›–ï¼Œä¸ä¼šé‡å¤
```

### 2. è‡ªåŠ¨çŠ¶æ€ç®¡ç†

```javascript
// æ—§ä»£ç ï¼šæ— çŠ¶æ€è·Ÿè¸ª
apiData.conversations.push(conv);

// æ–°ä»£ç ï¼šè‡ªåŠ¨çŠ¶æ€ç®¡ç†
// ç¬¬ä¸€æ¬¡æ’å…¥ â†’ status: NEW
// å†æ¬¡æ›´æ–° â†’ status: UPDATED, version++
// æ¨é€æˆåŠŸ â†’ status: SYNCED, lastSyncAt æ›´æ–°
```

### 3. è‡ªåŠ¨è„æ ‡è®°å’ŒåŒæ­¥

```javascript
// æ—§ä»£ç ï¼šæ‰€æœ‰æ•°æ®éƒ½æ¨é€ï¼ˆæµªè´¹å¸¦å®½ï¼‰
await bridge.sendToMaster(...allData);

// æ–°ä»£ç ï¼šåªæ¨é€ä¿®æ”¹è¿‡çš„æ•°æ®
// DataManager è‡ªåŠ¨è·Ÿè¸ª dirtyIds
// syncAll() åªæ¨é€çŠ¶æ€ä¸º NEW/UPDATED çš„æ•°æ®
```

### 4. å¹³å°æ— å…³

```javascript
// æ—§ä»£ç ï¼šç¡¬ç¼–ç æŠ–éŸ³æ•°æ®ç»“æ„
const conversationId = String(data.user_id);

// æ–°ä»£ç ï¼šå¹³å°ç‰¹å®šé€»è¾‘å°è£…åœ¨ DataManager
// çˆ¬è™«åªéœ€ä¼ é€’åŸå§‹æ•°æ®ï¼Œæ˜ å°„è‡ªåŠ¨å®Œæˆ
dataManager.batchUpsertConversations(douyinData);
```

---

## ğŸ¯ è¿ç§»æ£€æŸ¥æ¸…å•

### ç§ä¿¡çˆ¬è™«ï¼ˆcrawl-direct-messages-v2.jsï¼‰

- [ ] è·å– DataManager
- [ ] ä¿®æ”¹ onConversationListAPI ä½¿ç”¨ `batchUpsertConversations()`
- [ ] ä¿®æ”¹ onMessageHistoryAPI ä½¿ç”¨ `batchUpsertMessages()`
- [ ] åˆ é™¤ apiData æ•°æ®ç»“æ„
- [ ] åˆ é™¤æ‰‹åŠ¨æ¨é€é€»è¾‘
- [ ] æµ‹è¯• API æ‹¦æˆªå’Œæ•°æ®æ”¶é›†

### ä½œå“çˆ¬è™«ï¼ˆcrawl-contents.jsï¼‰

- [ ] è·å– DataManager
- [ ] ä¿®æ”¹ onWorksListAPI ä½¿ç”¨ `batchUpsertContents()`
- [ ] ä¿®æ”¹ onWorkDetailAPI ä½¿ç”¨ `upsertContent()`
- [ ] åˆ é™¤ apiData.worksList å’Œ apiData.workDetail
- [ ] åˆ é™¤æ‰‹åŠ¨æ¨é€é€»è¾‘
- [ ] æµ‹è¯•ä½œå“åˆ—è¡¨ API

### è¯„è®ºçˆ¬è™«ï¼ˆcrawl-comments.jsï¼‰

- [ ] è·å– DataManager
- [ ] ä¿®æ”¹ onCommentsListAPI ä½¿ç”¨ `batchUpsertComments()`
- [ ] ä¿®æ”¹ onDiscussionsListAPI ä½¿ç”¨ `batchUpsertComments()`
- [ ] åˆ é™¤ apiData.comments å’Œ apiData.discussions
- [ ] åˆ é™¤æ‰‹åŠ¨æ¨é€é€»è¾‘
- [ ] æµ‹è¯•è¯„è®º API

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•

1. **DataManager åŸºç¡€åŠŸèƒ½**
   - åˆ›å»ºå’Œåˆå§‹åŒ–
   - batchUpsert æ–¹æ³•
   - å»é‡é€»è¾‘
   - çŠ¶æ€ç®¡ç†

2. **DouyinDataManager æ˜ å°„**
   - mapConversationData()
   - mapMessageData()
   - mapContentData()
   - mapCommentData()

3. **DataPusher æ¨é€**
   - pushConversations()
   - pushMessages()
   - æ‰¹é‡æ¨é€
   - é”™è¯¯å¤„ç†

### é›†æˆæµ‹è¯•

1. **ç§ä¿¡çˆ¬è™«**
   - ä½¿ç”¨æµ‹è¯•è„šæœ¬ `tests/æµ‹è¯•ç§ä¿¡çˆ¬è™«æ–°æ¶æ„.js`
   - éªŒè¯ API æ‹¦æˆª
   - éªŒè¯æ•°æ®æ˜ å°„
   - éªŒè¯è‡ªåŠ¨åŒæ­¥

2. **ä½œå“çˆ¬è™«**
   - ä½¿ç”¨æµ‹è¯•è„šæœ¬ `tests/æµ‹è¯•ä½œå“çˆ¬è™«æ–°æ¶æ„.js`
   - éªŒè¯ä½œå“åˆ—è¡¨ API
   - éªŒè¯æ•°æ®å¢å¼º
   - éªŒè¯æ¨é€åˆ° Master

3. **ç«¯åˆ°ç«¯æµ‹è¯•**
   - å¯åŠ¨ Master + Worker
   - æ‰§è¡Œå®Œæ•´ç›‘æ§ä»»åŠ¡
   - éªŒè¯æ•°æ®æµå‘ Master æ•°æ®åº“
   - éªŒè¯é€šçŸ¥æ¨é€åˆ° Admin Web

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. DataManager ç”Ÿå‘½å‘¨æœŸ

- DataManager åœ¨ `platform.initialize(account)` æ—¶åˆ›å»º
- åœ¨ `platform.cleanup(account)` æ—¶é”€æ¯
- çˆ¬è™«å‡½æ•°ä¸­åªéœ€è·å–ï¼Œä¸éœ€è¦åˆ›å»ºæˆ–é”€æ¯

### 2. è‡ªåŠ¨åŒæ­¥é…ç½®

```javascript
// é»˜è®¤é…ç½®ï¼ˆDouyinDataManager æ„é€ å‡½æ•°ï¼‰
this.pushConfig = {
  interval: 5000,        // 5 ç§’åŒæ­¥ä¸€æ¬¡
  batchSize: 100,        // æ¯æ‰¹æœ€å¤š 100 æ¡
  autoSync: true,        // è‡ªåŠ¨åŒæ­¥å¼€å¯
};

// å¦‚æœéœ€è¦æ‰‹åŠ¨åŒæ­¥ï¼š
dataManager.pushConfig.autoSync = false;
await dataManager.syncAll(); // æ‰‹åŠ¨è§¦å‘
```

### 3. æ•°æ®æ¥æºæ ‡è®°

å§‹ç»ˆæ ‡è®°æ•°æ®æ¥æºä»¥ä¾¿è°ƒè¯•ï¼š

```javascript
// API æ•°æ®
dataManager.batchUpsertConversations(data, DataSource.API);

// DOM æ•°æ®
dataManager.batchUpsertMessages(data, DataSource.DOM);

// æ‰‹åŠ¨/æµ‹è¯•æ•°æ®
dataManager.upsertContent(data, DataSource.MANUAL);
```

### 4. é”™è¯¯å¤„ç†

DataManager å†…éƒ¨å·²å¤„ç†é”™è¯¯ï¼Œçˆ¬è™«æ— éœ€é¢å¤– try-catchï¼š

```javascript
// DataManager ä¼šæ•è·æ˜ å°„é”™è¯¯å¹¶è®°å½•æ—¥å¿—
// å¤±è´¥çš„æ•°æ®ä¸ä¼šä¸­æ–­æ•´ä¸ªæ‰¹æ¬¡
const results = dataManager.batchUpsertConversations(data);
// results åªåŒ…å«æˆåŠŸçš„é¡¹
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### æ—§æ¶æ„

- âŒ æ‰€æœ‰æ•°æ®éƒ½æ¨é€ï¼ˆåŒ…æ‹¬æœªä¿®æ”¹çš„ï¼‰
- âŒ æ¯æ¬¡çˆ¬å–éƒ½é‡æ–°å‘é€å…¨é‡æ•°æ®
- âŒ æ— æ•°æ®å»é‡ï¼ˆå¯èƒ½é‡å¤æ’å…¥ï¼‰
- âŒ æ— çŠ¶æ€è·Ÿè¸ªï¼ˆæ— æ³•çŸ¥é“å“ªäº›æ˜¯æ–°æ•°æ®ï¼‰

### æ–°æ¶æ„

- âœ… åªæ¨é€ä¿®æ”¹è¿‡çš„æ•°æ®ï¼ˆdirtyIdsï¼‰
- âœ… è‡ªåŠ¨å»é‡ï¼ˆåŸºäº IDï¼‰
- âœ… å¢é‡åŒæ­¥ï¼ˆåªå‘é€ NEW/UPDATED çŠ¶æ€çš„æ•°æ®ï¼‰
- âœ… å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆNEW â†’ UPDATED â†’ SYNCEDï¼‰

**é¢„æœŸæ€§èƒ½æå‡**ï¼š
- ç½‘ç»œå¸¦å®½ä½¿ç”¨ï¼šå‡å°‘ 60-80%
- Master æ•°æ®åº“å†™å…¥ï¼šå‡å°‘ 70%
- çˆ¬è™«å†…å­˜å ç”¨ï¼šå‡å°‘ 40%

---

## ğŸš€ ä¸‹ä¸€æ­¥

### Phase 3ï¼šé‡æ„ç°æœ‰çˆ¬è™«

1. **ç§ä¿¡çˆ¬è™«**ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰
   - API å·²éªŒè¯å·¥ä½œ
   - æ•°æ®é‡æœ€å¤§ï¼ˆ105 ä¼šè¯ï¼Œ31 æ¶ˆæ¯ï¼‰
   - ä½œä¸ºå…¶ä»–çˆ¬è™«çš„å‚è€ƒå®ç°

2. **ä½œå“çˆ¬è™«**ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰
   - API å·²ä¿®å¤ï¼ˆitem_info_listï¼‰
   - éœ€è¦æµ‹è¯• API æ‹¦æˆª

3. **è¯„è®ºçˆ¬è™«**ï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰
   - API æœªè§¦å‘ï¼ˆè¯„è®ºå°‘ï¼‰
   - éœ€è¦ä¿®å¤ DOM æå–

### Phase 4ï¼šMaster ç«¯é€‚é…

1. **æ·»åŠ æ–°æ¶ˆæ¯å¤„ç†å™¨**
   - WORKER_CONVERSATIONS_UPDATE
   - WORKER_MESSAGES_UPDATE
   - WORKER_CONTENTS_UPDATE
   - WORKER_COMMENTS_UPDATE
   - WORKER_NOTIFICATIONS_UPDATE

2. **æ›´æ–° DAO æ¥å£**
   - æ”¯æŒæ‰¹é‡ upsertï¼ˆINSERT OR REPLACEï¼‰
   - è¿”å›æ’å…¥/æ›´æ–°çš„ ID åˆ—è¡¨

3. **æ›´æ–°é€šçŸ¥å¹¿æ’­**
   - ä»æ–°æ¶ˆæ¯ç±»å‹ä¸­æå–é€šçŸ¥
   - å¹¿æ’­åˆ° Admin Web

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. [ç»Ÿä¸€æ•°æ®ç®¡ç†æ¶æ„è®¾è®¡.md](./ç»Ÿä¸€æ•°æ®ç®¡ç†æ¶æ„è®¾è®¡.md) - Phase 1 è®¾è®¡æ–‡æ¡£
2. [APIæ‹¦æˆªå™¨éªŒè¯æŠ¥å‘Š.md](./APIæ‹¦æˆªå™¨éªŒè¯æŠ¥å‘Š.md) - API æ‹¦æˆªéªŒè¯
3. [ä½œå“APIæ‹¦æˆªå™¨ä¿®å¤æ€»ç»“.md](./ä½œå“APIæ‹¦æˆªå™¨ä¿®å¤æ€»ç»“.md) - ä½œå“ API ä¿®å¤

---

**çŠ¶æ€**: âœ… Phase 2 å®Œæˆ - åŸºç¡€è®¾æ–½å°±ç»ª
**ä¸‹ä¸€æ­¥**: é‡æ„ç§ä¿¡çˆ¬è™«ä½¿ç”¨æ–°æ¶æ„ï¼ˆå‚è€ƒæœ¬æ–‡æ¡£ï¼‰
**é¢„è®¡å·¥ä½œé‡**: æ¯ä¸ªçˆ¬è™«çº¦ 2-3 å°æ—¶

