# IM 客户端测试清单 - 增量推送验证

**测试日期**: 2025-11-05
**测试目标**: 验证增量会话推送 + 按需加载消息架构
**架构版本**: v2.0

---

## 一、测试环境

### 1.1 服务端环境

- **Master 服务器**: 运行在 `http://localhost:3000`
- **IM WebSocket 服务器**: `ws://localhost:8080`
- **配置**: `.env` 文件 `IM_UNREAD_POLL_INTERVAL=5000`

### 1.2 客户端环境

- **CRM PC IM**: Electron + Vite 开发模式
- **Vite 开发服务器**: `http://localhost:5174`
- **Electron 入口**: `packages/crm-pc-im/electron/main.ts`

### 1.3 测试账户

- **测试账户**: `douyin-test` (acc-98296c87-2e42-447a-9d8b-8be008ddb6e4)
- **Worker ID**: `worker-1`
- **监控平台**: 抖音

---

## 二、启动服务

### 2.1 启动步骤

```bash
# 终端 1: 启动 Master 服务器
cd packages/master
npm start

# 终端 2: 启动 Worker 进程
cd packages/worker
npm start

# 终端 3: 启动 CRM PC IM（Vite + Electron）
cd packages/crm-pc-im
npm run dev        # Vite 开发服务器
npm run electron   # Electron 应用（另一个终端）
```

### 2.2 验证服务状态

- [ ] Master 服务器日志显示 "Master 服务器启动成功"
- [ ] Worker 连接成功，日志显示 "Worker 注册成功"
- [ ] Vite 开发服务器运行在 `http://localhost:5174`
- [ ] Electron 应用成功打开并显示窗口

---

## 三、核心功能测试

### 3.1 会话列表推送测试

#### 测试目标
验证服务端推送所有会话元数据（包括空会话）

#### 测试步骤
1. 打开 CRM PC IM 应用
2. 点击 "监控" 菜单
3. 观察会话列表

#### 预期结果
- [ ] 会话列表加载时间 < 2 秒
- [ ] 显示所有会话（包括有消息和无消息的）
- [ ] 每个会话显示：
  - [ ] 会话标题（用户名）
  - [ ] 未读消息数量（红色徽章）
  - [ ] 最后消息时间
  - [ ] 消息数量（可选显示）

#### 验证数据
在浏览器开发者工具控制台查看：
```javascript
// 应该看到类似日志：
[监听] 收到频道列表: { channels: [...] }
[监听] 收到作品列表: { topics: [...] }
```

**关键字段验证**:
```javascript
topics[0] = {
  id: 'conv-uuid-1234',
  channelId: 'acc-uuid-5678',
  title: '用户A',
  messageCount: 5,      // ⭐ 关键字段
  unreadCount: 2,       // ⭐ 关键字段
  lastMessageTime: 1699256400000
}
```

---

### 3.2 会话排序测试

#### 测试目标
验证未读消息优先排序

#### 测试步骤
1. 观察会话列表顺序
2. 记录前 3 个会话的未读数量

#### 预期结果
- [ ] 未读数量多的会话排在前面
- [ ] 未读数量相同时，最后消息时间新的在前
- [ ] 排序逻辑：`unreadCount ↓` → `lastMessageTime ↓`

#### 验证数据
```
会话 1: 未读 5 条，最后消息 16:30
会话 2: 未读 2 条，最后消息 16:35
会话 3: 未读 0 条，最后消息 16:40

预期顺序: 会话 1 → 会话 2 → 会话 3
```

---

### 3.3 按需加载消息测试

#### 测试目标
验证点击会话后客户端请求消息

#### 测试步骤
1. 点击第一个会话
2. 观察消息详情区域
3. 打开浏览器开发者工具网络面板（WebSocket）

#### 预期结果
- [ ] 点击会话后立即显示 "加载中..."（可选）
- [ ] 控制台显示：`[请求消息] topicId: conv-uuid-1234`
- [ ] WebSocket 发送：`{ event: 'monitor:request_messages', data: { topicId: 'conv-uuid-1234' } }`
- [ ] WebSocket 接收：`{ event: 'monitor:messages', data: { topicId: 'conv-uuid-1234', messages: [...] } }`
- [ ] 消息列表加载时间 < 1 秒
- [ ] 消息按时间顺序显示（旧 → 新）

#### 验证数据
控制台日志：
```javascript
[请求消息] topicId: conv-uuid-1234
[监听] 收到消息列表: {
  topicId: 'conv-uuid-1234',
  messages: [
    { id: 'msg-1', content: '你好', timestamp: 1699256395000 },
    { id: 'msg-2', content: '你好！', timestamp: 1699256400000 }
  ]
}
```

---

### 3.4 空会话处理测试

#### 测试目标
验证空会话（messageCount = 0）的显示

#### 测试步骤
1. 查找 `messageCount = 0` 的会话
2. 点击该会话
3. 观察消息详情区域

#### 预期结果
- [ ] 空会话仍然显示在列表中
- [ ] 会话描述显示 "私信会话 (暂无消息)"
- [ ] 点击后显示 "暂无消息" 提示
- [ ] 控制台显示：`[监听] 收到消息列表: { topicId: 'xxx', messages: [] }`

#### 可选优化
客户端可以选择：
- **选项 1**: 隐藏空会话（过滤 `messageCount = 0`）
- **选项 2**: 显示空会话但灰色标记
- **选项 3**: 用户设置中提供开关

---

### 3.5 自动选择首个会话测试

#### 测试目标
验证进入监控页面时自动选择第一个会话

#### 测试步骤
1. 打开 CRM PC IM
2. 点击 "监控" 菜单
3. 观察是否自动加载第一个会话的消息

#### 预期结果
- [ ] 会话列表加载后，第一个会话自动高亮
- [ ] 自动发送 `monitor:request_messages` 请求
- [ ] 消息详情区域显示第一个会话的消息
- [ ] 控制台显示：`[自动选择] 选中会话: conv-uuid-1234`

---

### 3.6 新消息实时推送测试

#### 测试目标
验证收到新消息时会话列表更新

#### 测试步骤
1. 保持 CRM PC IM 打开
2. 在抖音网页端发送一条新私信
3. 等待 5-30 秒（监控间隔）
4. 观察 IM 客户端变化

#### 预期结果
- [ ] 会话列表刷新
- [ ] 收到新消息的会话移到顶部（未读数 +1）
- [ ] 未读徽章更新
- [ ] 如果当前正在查看该会话，消息详情区域自动刷新
- [ ] Electron 窗口弹出（如果最小化）

#### 验证数据
```javascript
// WebSocket 接收到新消息推送
[监听] 收到新消息: {
  channelId: 'acc-uuid-5678',
  topicId: 'conv-uuid-1234',
  content: '新消息内容',
  timestamp: 1699256500000
}

// 会话列表更新
[监听] 收到作品列表: {
  topics: [
    { id: 'conv-uuid-1234', unreadCount: 3, ... },  // 未读数 +1
    ...
  ]
}
```

---

## 四、性能测试

### 4.1 会话列表加载性能

| 测试场景 | 会话数量 | 预期加载时间 | 实际加载时间 | 状态 |
|---------|---------|-------------|-------------|------|
| 小规模  | 10 个会话 | < 200ms | - | ⬜ |
| 中规模  | 50 个会话 | < 500ms | - | ⬜ |
| 大规模  | 100 个会话 | < 1000ms | - | ⬜ |

### 4.2 消息详情加载性能

| 测试场景 | 消息数量 | 预期加载时间 | 实际加载时间 | 状态 |
|---------|---------|-------------|-------------|------|
| 小规模  | 10 条消息 | < 100ms | - | ⬜ |
| 中规模  | 50 条消息 | < 300ms | - | ⬜ |
| 大规模  | 200 条消息 | < 1000ms | - | ⬜ |

### 4.3 网络流量测试

测试方法：打开浏览器开发者工具 → 网络面板 → WebSocket

| 测试场景 | 传输数据量 | 预期大小 | 实际大小 | 状态 |
|---------|-----------|---------|---------|------|
| 会话列表推送（50个会话） | 元数据 | < 10KB | - | ⬜ |
| 消息详情请求（50条消息） | 消息列表 | < 20KB | - | ⬜ |
| 总流量（查看 5 个会话） | 初始加载 | < 50KB | - | ⬜ |

### 4.4 内存占用测试

测试方法：Chrome DevTools → Performance Monitor

| 测试场景 | 预期内存 | 实际内存 | 状态 |
|---------|---------|---------|------|
| 初始加载（50个会话） | < 50MB | - | ⬜ |
| 查看 5 个会话（每个 50 条消息） | < 100MB | - | ⬜ |
| 长时间运行（1小时） | < 200MB | - | ⬜ |

---

## 五、边界情况测试

### 5.1 无会话列表

#### 测试步骤
1. 使用一个从未接收过私信的新账户
2. 打开监控页面

#### 预期结果
- [ ] 显示 "暂无会话" 提示
- [ ] 不发送 `monitor:request_messages` 请求
- [ ] 控制台显示：`[监听] 收到作品列表: { topics: [] }`

---

### 5.2 网络断开重连

#### 测试步骤
1. 打开监控页面
2. 断开网络（禁用 Wi-Fi）
3. 等待 5 秒
4. 重新连接网络

#### 预期结果
- [ ] 断开时显示 "连接已断开" 提示
- [ ] 自动重连成功
- [ ] 会话列表自动刷新
- [ ] 控制台显示：`[WebSocket] 重连成功`

---

### 5.3 大量消息会话

#### 测试步骤
1. 查找消息数量 > 100 的会话
2. 点击该会话

#### 预期结果
- [ ] 消息加载时间 < 2 秒
- [ ] 所有消息正常显示
- [ ] 滚动条自动滚动到底部（最新消息）

**已知限制**: 当前一次性加载所有消息，未来需要实现分页加载

---

### 5.4 快速切换会话

#### 测试步骤
1. 快速点击 5 个不同会话（间隔 < 1 秒）
2. 观察消息详情区域

#### 预期结果
- [ ] 每次点击都正确切换会话
- [ ] 消息详情显示的是最后点击的会话
- [ ] 没有出现消息错乱（会话 A 显示会话 B 的消息）
- [ ] 控制台没有错误日志

---

## 六、调试技巧

### 6.1 浏览器开发者工具

```javascript
// 1. 查看 Redux State
console.log('[Redux State]', window.__REDUX_DEVTOOLS_EXTENSION__?.());

// 2. 查看 WebSocket 连接状态
console.log('[WebSocket]', websocketService.isConnected());

// 3. 查看当前会话列表
console.log('[Topics]', store.getState().monitor.topics);

// 4. 查看当前消息列表
console.log('[Messages]', store.getState().monitor.messages);
```

### 6.2 服务端日志

**Master 服务器日志** (`logs/master.log`):
```bash
tail -f logs/master.log | grep "\[IM\]"
```

**关键日志**:
- `[IM] 客户端连接: xxx` - 客户端连接成功
- `[IM] 推送会话列表: 5 个会话` - 推送会话元数据
- `[IM] 客户端请求会话消息: conv-uuid-1234` - 收到消息请求
- `[IM] 推送会话消息: conv-uuid-1234, 消息数: 20` - 响应消息列表

### 6.3 网络抓包

使用 Chrome DevTools → Network → WS:
1. 找到 WebSocket 连接
2. 查看 Messages 标签
3. 过滤 `monitor:request_messages` 和 `monitor:messages`

---

## 七、常见问题排查

### 7.1 会话列表为空

**可能原因**:
1. Master 服务器未启动
2. Worker 未连接
3. 账户未登录或未监控
4. WebSocket 连接失败

**排查步骤**:
```bash
# 1. 检查 Master 服务器
curl http://localhost:3000/api/accounts

# 2. 检查 Worker 连接
curl http://localhost:3000/api/workers

# 3. 检查 WebSocket 连接
# 浏览器控制台查看：
console.log('[WebSocket]', websocketService.isConnected());
```

---

### 7.2 点击会话没有加载消息

**可能原因**:
1. `monitor:request_messages` 事件未触发
2. 服务端未响应
3. 会话 ID 不匹配

**排查步骤**:
```javascript
// 1. 检查点击事件
console.log('[点击会话]', topicId);

// 2. 检查请求发送
websocketService.on('monitor:request_messages', (data) => {
  console.log('[请求发送]', data);
});

// 3. 检查响应接收
websocketService.on('monitor:messages', (data) => {
  console.log('[响应接收]', data);
});

// 4. 检查数据库
// Master 服务器端：
const messages = await directMessagesDAO.findByConversationId(topicId);
console.log('[数据库查询]', messages.length, '条消息');
```

---

### 7.3 消息顺序错乱

**可能原因**:
1. 时间戳未正确处理
2. 客户端排序逻辑错误

**排查步骤**:
```javascript
// 检查消息时间戳
messages.forEach(msg => {
  console.log(msg.id, new Date(msg.timestamp).toLocaleString());
});

// 验证排序逻辑
const sorted = [...messages].sort((a, b) => a.timestamp - b.timestamp);
console.log('[排序后]', sorted);
```

---

## 八、测试报告模板

### 8.1 测试结果摘要

| 测试类别 | 测试项数 | 通过数 | 失败数 | 通过率 |
|---------|---------|-------|-------|-------|
| 核心功能 | 6 | - | - | - |
| 性能测试 | 4 | - | - | - |
| 边界测试 | 4 | - | - | - |
| **总计** | **14** | **-** | **-** | **-** |

### 8.2 关键指标

| 指标 | 目标值 | 实际值 | 状态 |
|-----|-------|-------|------|
| 会话列表加载时间 | < 500ms | - | ⬜ |
| 消息详情加载时间 | < 1000ms | - | ⬜ |
| 初始网络流量 | < 50KB | - | ⬜ |
| 客户端内存占用 | < 100MB | - | ⬜ |

### 8.3 发现的问题

| 编号 | 问题描述 | 严重程度 | 状态 |
|-----|---------|---------|------|
| - | - | - | - |

### 8.4 改进建议

1. **分页加载**: 当消息数量 > 100 时实现分页加载
2. **本地缓存**: 使用 IndexedDB 缓存已加载的消息
3. **增量更新**: 只推送新增/修改的消息，而不是整个会话
4. **空会话过滤**: 在设置中添加 "显示/隐藏空会话" 开关

---

## 九、测试签名

**测试人员**: _________________
**测试日期**: 2025-11-05
**测试版本**: v2.0
**审核人员**: _________________
**审核日期**: _________________

---

**文档版本**: v1.0
**创建日期**: 2025-11-05
**最后更新**: 2025-11-05
**维护者**: Claude (AI Assistant)
