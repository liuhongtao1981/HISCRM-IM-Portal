# 作品数据零问题 - 根本原因确认报告

**日期**: 2025-10-29
**调查人员**: Claude
**问题**: DataManager 快照显示作品数据为 0，但日志显示 API 已被触发并返回 20 个作品

---

## 问题现象

### 1. 数据快照结果
```
🎬 视频/作品 (Contents)
  ├─ 总数: 0 条
  ├─ 新增: 0 条
```

### 2. API 拦截日志
```json
{"message":"🎯 [API] 作品列表 API 被触发！URL: https://creator.douyin.com/aweme/v1/creator/item/list?cursor=&aid=2906...","timestamp":"2025-10-29 15:42:34.502"}
{"message":"📦 [API] 作品列表包含 20 个作品","timestamp":"2025-10-29 15:42:34.502"}
{"message":"🔍 第一个作品字段: anchor_user_id, comment_count, cover_image_url, create_time, creator_item_setting, duration, item_id, item_id_plain, item_link, media_type","timestamp":"2025-10-29 15:42:34.502"}
```

### 3. 矛盾点
- ✅ API 拦截器正常工作
- ✅ 作品列表 API 被成功触发
- ✅ 返回了 20 个作品数据
- ❌ **但 DataManager 中作品数量为 0**

---

## 根本原因

### 问题定位

通过代码审查发现，监控任务 (`monitor-task.js`) 中**没有调用作品爬虫**：

```javascript
// packages/worker/src/handlers/monitor-task.js:250-278

const [commentResult, dmResult] = await Promise.all([
  // 1. 爬取评论
  (async () => {
    logger.info(`Spider2 (Comments) started for account ${this.account.id}`);
    const result = await this.platformInstance.crawlComments(this.account);
    return result;
  })(),

  // 2. 爬取私信
  (async () => {
    logger.info(`Spider1 (DM) started for account ${this.account.id}`);
    const result = await this.platformInstance.crawlDirectMessages(this.account);
    return result;
  })(),
]);

// ❌ 缺少：作品爬虫调用
```

### 为什么 API 会被触发？

作品列表 API 在以下情况下被触发：

1. **评论爬虫**访问评论管理页面 (`/creator-micro/interactive/comment`)
2. 页面加载时**自动调用**作品列表 API 来填充"选择作品"下拉框
3. API 拦截器成功捕获了这个请求

```javascript
// packages/worker/src/platforms/douyin/crawl-comments.js:145-170
// 评论爬虫导航到评论管理页面
await navigateToCommentManage(page);

// 页面自动触发作品 API（用于下拉框）
// → API 拦截器捕获：/aweme/v1/creator/item/list
// → 回调函数 onWorksListAPI 被执行
```

### 为什么数据没有存储？

虽然 `onWorksListAPI` 回调函数被执行了，但它需要 `globalContext.dataManager` 才能存储数据：

```javascript
// packages/worker/src/platforms/douyin/crawl-contents.js:163-173

async function onWorksListAPI(body, route) {
  // ✅ API 被触发，日志记录成功
  logger.info(`🎯 [API] 作品列表 API 被触发！URL: ${url}`);
  logger.info(`📦 [API] 作品列表包含 ${body.item_info_list.length} 个作品`);

  // ❌ 但 globalContext.dataManager 为 null
  if (globalContext.dataManager && body.item_info_list.length > 0) {
    const contents = globalContext.dataManager.batchUpsertContents(
      body.item_info_list,
      DataSource.API
    );
    logger.info(`✅ [API] 作品列表 -> DataManager: ${contents.length} 个作品`);
  }

  // ❌ globalContext.dataManager 是 null，所以这段代码不执行
}
```

### globalContext 的设置机制

`globalContext.dataManager` 只有在**爬虫函数被调用时**才会被设置：

```javascript
// packages/worker/src/platforms/douyin/crawl-contents.js:39-54

async function crawlContents(page, account, options = {}, dataManager = null) {
  // ✅ 只有当 crawlContents 被调用时，才会设置 globalContext
  if (dataManager) {
    globalContext.dataManager = dataManager;
    globalContext.accountId = account.id;
    logger.info(`✅ [DataManager] 已启用统一数据管理架构`);
  }

  // ... 爬虫逻辑
}
```

但是 **`monitor-task.js` 从未调用 `crawlContents`**，所以：
- `globalContext.dataManager` 始终为 `null`
- API 拦截器虽然捕获了数据，但无法存储

---

## 对比：评论数据为何成功？

评论数据能正常入库，因为：

1. ✅ `monitor-task.js` **显式调用** `crawlComments()`
2. ✅ `crawlComments()` 获取 DataManager 并设置到 `globalContext`
3. ✅ 评论 API 拦截器回调函数能访问 `globalContext.dataManager`
4. ✅ 数据被成功存储

```javascript
// packages/worker/src/platforms/douyin/platform.js:674-705

async crawlComments(account, options = {}) {
  // 1. 获取页面（自动注册 API 拦截器）
  const { page } = await this.getPageWithAPI(account.id, {
    tag: TabTag.SPIDER_COMMENT,
  });

  // 2. 获取 DataManager ✅
  const dataManager = await this.getDataManager(account.id);

  // 3. 调用爬虫函数，传递 DataManager ✅
  const crawlResult = await crawlCommentsV2(page, account, options, dataManager);

  // 4. crawlCommentsV2 内部设置 globalContext.dataManager ✅
  // 5. API 拦截器回调能访问 globalContext.dataManager ✅
}
```

---

## 解决方案

### 选项 1: 添加作品爬虫到监控任务（推荐）

修改 `monitor-task.js`，添加作品爬虫到并行任务中：

```javascript
const [commentResult, dmResult, contentsResult] = await Promise.all([
  // 1. 评论爬虫
  this.platformInstance.crawlComments(this.account),

  // 2. 私信爬虫
  this.platformInstance.crawlDirectMessages(this.account),

  // 3. 作品爬虫 ✅ 新增
  this.platformInstance.crawlContents(this.account),
]);
```

**优点**：
- 完整实现，作品数据独立获取
- 不依赖其他爬虫的副作用
- 数据质量高（完整的作品列表）

**缺点**：
- 增加一个并行任务（性能影响较小）
- 需要实现 `platform.crawlContents()` 方法

### 选项 2: 在评论爬虫中设置 globalContext（快速修复）

在 `crawlComments` 开始时就设置 `globalContext.dataManager`：

```javascript
// packages/worker/src/platforms/douyin/platform.js:674

async crawlComments(account, options = {}) {
  const dataManager = await this.getDataManager(account.id);

  // ✅ 提前设置 globalContext（在爬虫函数调用之前）
  if (dataManager) {
    const { globalContext } = require('./crawl-contents');
    globalContext.dataManager = dataManager;
    globalContext.accountId = account.id;
  }

  const { page } = await this.getPageWithAPI(account.id, {
    tag: TabTag.SPIDER_COMMENT,
  });

  const crawlResult = await crawlCommentsV2(page, account, options, dataManager);
  // ...
}
```

**优点**：
- 快速修复，最小改动
- 利用现有的 API 拦截（页面加载时自动触发）

**缺点**：
- 依赖评论爬虫的副作用（耦合性高）
- 只能获取前 20 个作品（API 默认分页）
- 不够清晰，难以维护

### 选项 3: 跨爬虫共享 DataManager

在平台级别维护一个全局的 DataManager 映射：

```javascript
// packages/worker/src/platforms/base/platform-base.js

class PlatformBase {
  constructor() {
    this.dataManagers = new Map(); // accountId -> DataManager
  }

  async getOrCreateDataManager(accountId) {
    if (!this.dataManagers.has(accountId)) {
      const dm = await this.getDataManager(accountId);
      this.dataManagers.set(accountId, dm);
    }
    return this.dataManagers.get(accountId);
  }
}
```

然后在 API 拦截器中直接使用：

```javascript
async function onWorksListAPI(body, route) {
  const dataManager = platformInstance.dataManagers.get(currentAccountId);
  if (dataManager) {
    dataManager.batchUpsertContents(body.item_info_list, DataSource.API);
  }
}
```

**优点**：
- 解耦，任何爬虫触发的 API 都能存储数据
- 灵活性高

**缺点**：
- 架构改动较大
- 需要管理 DataManager 的生命周期

---

## 推荐方案

**选项 1：添加作品爬虫到监控任务**

理由：
1. **架构清晰**：每个数据类型有独立的爬虫
2. **数据完整**：能获取完整的作品列表（分页、滚动加载）
3. **易于维护**：符合现有的架构模式
4. **性能可控**：并行执行，性能影响最小

实施步骤：
1. 在 `platform.js` 中实现 `crawlContents(account)` 方法（参考 `crawlComments`）
2. 在 `monitor-task.js` 中添加作品爬虫到 `Promise.all`
3. 更新统计信息和日志
4. 测试验证

---

## 结论

**作品数据为零的根本原因**：
- 监控任务没有调用作品爬虫
- API 虽然被拦截，但 `globalContext.dataManager` 为 `null`
- 数据无法存储到 DataManager

**关键发现**：
- 评论爬虫**意外触发**了作品 API（页面加载副作用）
- 这暴露了架构设计的问题：API 拦截器依赖 `globalContext`
- 需要显式调用作品爬虫才能正确存储数据

**下一步行动**：
1. 实现 `platform.crawlContents()` 方法
2. 修改 `monitor-task.js` 添加作品爬虫调用
3. 测试验证数据能正常入库
4. 更新文档说明监控任务的完整流程
