# ä½œå“æ•°æ®é›¶é—®é¢˜ - æ ¹æœ¬åŸå› ç¡®è®¤æŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-29
**è°ƒæŸ¥äººå‘˜**: Claude
**é—®é¢˜**: DataManager å¿«ç…§æ˜¾ç¤ºä½œå“æ•°æ®ä¸º 0ï¼Œä½†æ—¥å¿—æ˜¾ç¤º API å·²è¢«è§¦å‘å¹¶è¿”å› 20 ä¸ªä½œå“

---

## é—®é¢˜ç°è±¡

### 1. æ•°æ®å¿«ç…§ç»“æœ
```
ğŸ¬ è§†é¢‘/ä½œå“ (Contents)
  â”œâ”€ æ€»æ•°: 0 æ¡
  â”œâ”€ æ–°å¢: 0 æ¡
```

### 2. API æ‹¦æˆªæ—¥å¿—
```json
{"message":"ğŸ¯ [API] ä½œå“åˆ—è¡¨ API è¢«è§¦å‘ï¼URL: https://creator.douyin.com/aweme/v1/creator/item/list?cursor=&aid=2906...","timestamp":"2025-10-29 15:42:34.502"}
{"message":"ğŸ“¦ [API] ä½œå“åˆ—è¡¨åŒ…å« 20 ä¸ªä½œå“","timestamp":"2025-10-29 15:42:34.502"}
{"message":"ğŸ” ç¬¬ä¸€ä¸ªä½œå“å­—æ®µ: anchor_user_id, comment_count, cover_image_url, create_time, creator_item_setting, duration, item_id, item_id_plain, item_link, media_type","timestamp":"2025-10-29 15:42:34.502"}
```

### 3. çŸ›ç›¾ç‚¹
- âœ… API æ‹¦æˆªå™¨æ­£å¸¸å·¥ä½œ
- âœ… ä½œå“åˆ—è¡¨ API è¢«æˆåŠŸè§¦å‘
- âœ… è¿”å›äº† 20 ä¸ªä½œå“æ•°æ®
- âŒ **ä½† DataManager ä¸­ä½œå“æ•°é‡ä¸º 0**

---

## æ ¹æœ¬åŸå› 

### é—®é¢˜å®šä½

é€šè¿‡ä»£ç å®¡æŸ¥å‘ç°ï¼Œç›‘æ§ä»»åŠ¡ (`monitor-task.js`) ä¸­**æ²¡æœ‰è°ƒç”¨ä½œå“çˆ¬è™«**ï¼š

```javascript
// packages/worker/src/handlers/monitor-task.js:250-278

const [commentResult, dmResult] = await Promise.all([
  // 1. çˆ¬å–è¯„è®º
  (async () => {
    logger.info(`Spider2 (Comments) started for account ${this.account.id}`);
    const result = await this.platformInstance.crawlComments(this.account);
    return result;
  })(),

  // 2. çˆ¬å–ç§ä¿¡
  (async () => {
    logger.info(`Spider1 (DM) started for account ${this.account.id}`);
    const result = await this.platformInstance.crawlDirectMessages(this.account);
    return result;
  })(),
]);

// âŒ ç¼ºå°‘ï¼šä½œå“çˆ¬è™«è°ƒç”¨
```

### ä¸ºä»€ä¹ˆ API ä¼šè¢«è§¦å‘ï¼Ÿ

ä½œå“åˆ—è¡¨ API åœ¨ä»¥ä¸‹æƒ…å†µä¸‹è¢«è§¦å‘ï¼š

1. **è¯„è®ºçˆ¬è™«**è®¿é—®è¯„è®ºç®¡ç†é¡µé¢ (`/creator-micro/interactive/comment`)
2. é¡µé¢åŠ è½½æ—¶**è‡ªåŠ¨è°ƒç”¨**ä½œå“åˆ—è¡¨ API æ¥å¡«å……"é€‰æ‹©ä½œå“"ä¸‹æ‹‰æ¡†
3. API æ‹¦æˆªå™¨æˆåŠŸæ•è·äº†è¿™ä¸ªè¯·æ±‚

```javascript
// packages/worker/src/platforms/douyin/crawl-comments.js:145-170
// è¯„è®ºçˆ¬è™«å¯¼èˆªåˆ°è¯„è®ºç®¡ç†é¡µé¢
await navigateToCommentManage(page);

// é¡µé¢è‡ªåŠ¨è§¦å‘ä½œå“ APIï¼ˆç”¨äºä¸‹æ‹‰æ¡†ï¼‰
// â†’ API æ‹¦æˆªå™¨æ•è·ï¼š/aweme/v1/creator/item/list
// â†’ å›è°ƒå‡½æ•° onWorksListAPI è¢«æ‰§è¡Œ
```

### ä¸ºä»€ä¹ˆæ•°æ®æ²¡æœ‰å­˜å‚¨ï¼Ÿ

è™½ç„¶ `onWorksListAPI` å›è°ƒå‡½æ•°è¢«æ‰§è¡Œäº†ï¼Œä½†å®ƒéœ€è¦ `globalContext.dataManager` æ‰èƒ½å­˜å‚¨æ•°æ®ï¼š

```javascript
// packages/worker/src/platforms/douyin/crawl-contents.js:163-173

async function onWorksListAPI(body, route) {
  // âœ… API è¢«è§¦å‘ï¼Œæ—¥å¿—è®°å½•æˆåŠŸ
  logger.info(`ğŸ¯ [API] ä½œå“åˆ—è¡¨ API è¢«è§¦å‘ï¼URL: ${url}`);
  logger.info(`ğŸ“¦ [API] ä½œå“åˆ—è¡¨åŒ…å« ${body.item_info_list.length} ä¸ªä½œå“`);

  // âŒ ä½† globalContext.dataManager ä¸º null
  if (globalContext.dataManager && body.item_info_list.length > 0) {
    const contents = globalContext.dataManager.batchUpsertContents(
      body.item_info_list,
      DataSource.API
    );
    logger.info(`âœ… [API] ä½œå“åˆ—è¡¨ -> DataManager: ${contents.length} ä¸ªä½œå“`);
  }

  // âŒ globalContext.dataManager æ˜¯ nullï¼Œæ‰€ä»¥è¿™æ®µä»£ç ä¸æ‰§è¡Œ
}
```

### globalContext çš„è®¾ç½®æœºåˆ¶

`globalContext.dataManager` åªæœ‰åœ¨**çˆ¬è™«å‡½æ•°è¢«è°ƒç”¨æ—¶**æ‰ä¼šè¢«è®¾ç½®ï¼š

```javascript
// packages/worker/src/platforms/douyin/crawl-contents.js:39-54

async function crawlContents(page, account, options = {}, dataManager = null) {
  // âœ… åªæœ‰å½“ crawlContents è¢«è°ƒç”¨æ—¶ï¼Œæ‰ä¼šè®¾ç½® globalContext
  if (dataManager) {
    globalContext.dataManager = dataManager;
    globalContext.accountId = account.id;
    logger.info(`âœ… [DataManager] å·²å¯ç”¨ç»Ÿä¸€æ•°æ®ç®¡ç†æ¶æ„`);
  }

  // ... çˆ¬è™«é€»è¾‘
}
```

ä½†æ˜¯ **`monitor-task.js` ä»æœªè°ƒç”¨ `crawlContents`**ï¼Œæ‰€ä»¥ï¼š
- `globalContext.dataManager` å§‹ç»ˆä¸º `null`
- API æ‹¦æˆªå™¨è™½ç„¶æ•è·äº†æ•°æ®ï¼Œä½†æ— æ³•å­˜å‚¨

---

## å¯¹æ¯”ï¼šè¯„è®ºæ•°æ®ä¸ºä½•æˆåŠŸï¼Ÿ

è¯„è®ºæ•°æ®èƒ½æ­£å¸¸å…¥åº“ï¼Œå› ä¸ºï¼š

1. âœ… `monitor-task.js` **æ˜¾å¼è°ƒç”¨** `crawlComments()`
2. âœ… `crawlComments()` è·å– DataManager å¹¶è®¾ç½®åˆ° `globalContext`
3. âœ… è¯„è®º API æ‹¦æˆªå™¨å›è°ƒå‡½æ•°èƒ½è®¿é—® `globalContext.dataManager`
4. âœ… æ•°æ®è¢«æˆåŠŸå­˜å‚¨

```javascript
// packages/worker/src/platforms/douyin/platform.js:674-705

async crawlComments(account, options = {}) {
  // 1. è·å–é¡µé¢ï¼ˆè‡ªåŠ¨æ³¨å†Œ API æ‹¦æˆªå™¨ï¼‰
  const { page } = await this.getPageWithAPI(account.id, {
    tag: TabTag.SPIDER_COMMENT,
  });

  // 2. è·å– DataManager âœ…
  const dataManager = await this.getDataManager(account.id);

  // 3. è°ƒç”¨çˆ¬è™«å‡½æ•°ï¼Œä¼ é€’ DataManager âœ…
  const crawlResult = await crawlCommentsV2(page, account, options, dataManager);

  // 4. crawlCommentsV2 å†…éƒ¨è®¾ç½® globalContext.dataManager âœ…
  // 5. API æ‹¦æˆªå™¨å›è°ƒèƒ½è®¿é—® globalContext.dataManager âœ…
}
```

---

## è§£å†³æ–¹æ¡ˆ

### é€‰é¡¹ 1: æ·»åŠ ä½œå“çˆ¬è™«åˆ°ç›‘æ§ä»»åŠ¡ï¼ˆæ¨èï¼‰

ä¿®æ”¹ `monitor-task.js`ï¼Œæ·»åŠ ä½œå“çˆ¬è™«åˆ°å¹¶è¡Œä»»åŠ¡ä¸­ï¼š

```javascript
const [commentResult, dmResult, contentsResult] = await Promise.all([
  // 1. è¯„è®ºçˆ¬è™«
  this.platformInstance.crawlComments(this.account),

  // 2. ç§ä¿¡çˆ¬è™«
  this.platformInstance.crawlDirectMessages(this.account),

  // 3. ä½œå“çˆ¬è™« âœ… æ–°å¢
  this.platformInstance.crawlContents(this.account),
]);
```

**ä¼˜ç‚¹**ï¼š
- å®Œæ•´å®ç°ï¼Œä½œå“æ•°æ®ç‹¬ç«‹è·å–
- ä¸ä¾èµ–å…¶ä»–çˆ¬è™«çš„å‰¯ä½œç”¨
- æ•°æ®è´¨é‡é«˜ï¼ˆå®Œæ•´çš„ä½œå“åˆ—è¡¨ï¼‰

**ç¼ºç‚¹**ï¼š
- å¢åŠ ä¸€ä¸ªå¹¶è¡Œä»»åŠ¡ï¼ˆæ€§èƒ½å½±å“è¾ƒå°ï¼‰
- éœ€è¦å®ç° `platform.crawlContents()` æ–¹æ³•

### é€‰é¡¹ 2: åœ¨è¯„è®ºçˆ¬è™«ä¸­è®¾ç½® globalContextï¼ˆå¿«é€Ÿä¿®å¤ï¼‰

åœ¨ `crawlComments` å¼€å§‹æ—¶å°±è®¾ç½® `globalContext.dataManager`ï¼š

```javascript
// packages/worker/src/platforms/douyin/platform.js:674

async crawlComments(account, options = {}) {
  const dataManager = await this.getDataManager(account.id);

  // âœ… æå‰è®¾ç½® globalContextï¼ˆåœ¨çˆ¬è™«å‡½æ•°è°ƒç”¨ä¹‹å‰ï¼‰
  if (dataManager) {
    const { globalContext } = require('./crawl-contents');
    globalContext.dataManager = dataManager;
    globalContext.accountId = account.id;
  }

  const { page } = await this.getPageWithAPI(account.id, {
    tag: TabTag.SPIDER_COMMENT,
  });

  const crawlResult = await crawlCommentsV2(page, account, options, dataManager);
  // ...
}
```

**ä¼˜ç‚¹**ï¼š
- å¿«é€Ÿä¿®å¤ï¼Œæœ€å°æ”¹åŠ¨
- åˆ©ç”¨ç°æœ‰çš„ API æ‹¦æˆªï¼ˆé¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è§¦å‘ï¼‰

**ç¼ºç‚¹**ï¼š
- ä¾èµ–è¯„è®ºçˆ¬è™«çš„å‰¯ä½œç”¨ï¼ˆè€¦åˆæ€§é«˜ï¼‰
- åªèƒ½è·å–å‰ 20 ä¸ªä½œå“ï¼ˆAPI é»˜è®¤åˆ†é¡µï¼‰
- ä¸å¤Ÿæ¸…æ™°ï¼Œéš¾ä»¥ç»´æŠ¤

### é€‰é¡¹ 3: è·¨çˆ¬è™«å…±äº« DataManager

åœ¨å¹³å°çº§åˆ«ç»´æŠ¤ä¸€ä¸ªå…¨å±€çš„ DataManager æ˜ å°„ï¼š

```javascript
// packages/worker/src/platforms/base/platform-base.js

class PlatformBase {
  constructor() {
    this.dataManagers = new Map(); // accountId -> DataManager
  }

  async getOrCreateDataManager(accountId) {
    if (!this.dataManagers.has(accountId)) {
      const dm = await this.getDataManager(accountId);
      this.dataManagers.set(accountId, dm);
    }
    return this.dataManagers.get(accountId);
  }
}
```

ç„¶ååœ¨ API æ‹¦æˆªå™¨ä¸­ç›´æ¥ä½¿ç”¨ï¼š

```javascript
async function onWorksListAPI(body, route) {
  const dataManager = platformInstance.dataManagers.get(currentAccountId);
  if (dataManager) {
    dataManager.batchUpsertContents(body.item_info_list, DataSource.API);
  }
}
```

**ä¼˜ç‚¹**ï¼š
- è§£è€¦ï¼Œä»»ä½•çˆ¬è™«è§¦å‘çš„ API éƒ½èƒ½å­˜å‚¨æ•°æ®
- çµæ´»æ€§é«˜

**ç¼ºç‚¹**ï¼š
- æ¶æ„æ”¹åŠ¨è¾ƒå¤§
- éœ€è¦ç®¡ç† DataManager çš„ç”Ÿå‘½å‘¨æœŸ

---

## æ¨èæ–¹æ¡ˆ

**é€‰é¡¹ 1ï¼šæ·»åŠ ä½œå“çˆ¬è™«åˆ°ç›‘æ§ä»»åŠ¡**

ç†ç”±ï¼š
1. **æ¶æ„æ¸…æ™°**ï¼šæ¯ä¸ªæ•°æ®ç±»å‹æœ‰ç‹¬ç«‹çš„çˆ¬è™«
2. **æ•°æ®å®Œæ•´**ï¼šèƒ½è·å–å®Œæ•´çš„ä½œå“åˆ—è¡¨ï¼ˆåˆ†é¡µã€æ»šåŠ¨åŠ è½½ï¼‰
3. **æ˜“äºç»´æŠ¤**ï¼šç¬¦åˆç°æœ‰çš„æ¶æ„æ¨¡å¼
4. **æ€§èƒ½å¯æ§**ï¼šå¹¶è¡Œæ‰§è¡Œï¼Œæ€§èƒ½å½±å“æœ€å°

å®æ–½æ­¥éª¤ï¼š
1. åœ¨ `platform.js` ä¸­å®ç° `crawlContents(account)` æ–¹æ³•ï¼ˆå‚è€ƒ `crawlComments`ï¼‰
2. åœ¨ `monitor-task.js` ä¸­æ·»åŠ ä½œå“çˆ¬è™«åˆ° `Promise.all`
3. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯å’Œæ—¥å¿—
4. æµ‹è¯•éªŒè¯

---

## ç»“è®º

**ä½œå“æ•°æ®ä¸ºé›¶çš„æ ¹æœ¬åŸå› **ï¼š
- ç›‘æ§ä»»åŠ¡æ²¡æœ‰è°ƒç”¨ä½œå“çˆ¬è™«
- API è™½ç„¶è¢«æ‹¦æˆªï¼Œä½† `globalContext.dataManager` ä¸º `null`
- æ•°æ®æ— æ³•å­˜å‚¨åˆ° DataManager

**å…³é”®å‘ç°**ï¼š
- è¯„è®ºçˆ¬è™«**æ„å¤–è§¦å‘**äº†ä½œå“ APIï¼ˆé¡µé¢åŠ è½½å‰¯ä½œç”¨ï¼‰
- è¿™æš´éœ²äº†æ¶æ„è®¾è®¡çš„é—®é¢˜ï¼šAPI æ‹¦æˆªå™¨ä¾èµ– `globalContext`
- éœ€è¦æ˜¾å¼è°ƒç”¨ä½œå“çˆ¬è™«æ‰èƒ½æ­£ç¡®å­˜å‚¨æ•°æ®

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼š
1. å®ç° `platform.crawlContents()` æ–¹æ³•
2. ä¿®æ”¹ `monitor-task.js` æ·»åŠ ä½œå“çˆ¬è™«è°ƒç”¨
3. æµ‹è¯•éªŒè¯æ•°æ®èƒ½æ­£å¸¸å…¥åº“
4. æ›´æ–°æ–‡æ¡£è¯´æ˜ç›‘æ§ä»»åŠ¡çš„å®Œæ•´æµç¨‹
