# Douyin 平台代码清理详细清单

## 目标

清理 `packages/worker/src/platforms/douyin/` 目录中的无用代码，保持代码纯净。

## 已清理

### 1. crawl-direct-messages-v2.js

✅ **删除的函数**（行163-374，共212行）：
- `setupAPIInterceptors()` - 旧的 API 拦截器设置函数
- `isValidResponse()` - API 响应验证
- `getMessageCount()` - 获取消息数量
- `generateRequestSignature()` - 生成请求签名
- `hashObject()` - 对象哈希
- `extractKeyFields()` - 提取关键字段

**原因**：这些函数已被新的 API 拦截器架构替代（统一在 platform.js 注册）

## 待清理

### 2. platform.js

以下方法已废弃（没有被调用），需要删除：

#### 方法 1: getVideoListFromCommentPage
- **行号**: 1068-1141 (约74行)
- **功能**: 从评论管理页面获取作品列表
- **废弃原因**: 已被 crawl-comments.js 中的新实现替代
- **调用次数**: 0

#### 方法 2: extractComments
- **行号**: 1227-1289 (约63行)
- **功能**: 从评论管理页面提取评论（DOM 回退方案）
- **废弃原因**: 已被 crawl-comments.js 中的 API 拦截方案替代
- **调用次数**: 0

#### 方法 3: extractDirectMessages
- **行号**: 1290-1404 (约115行)
- **功能**: 从 React 虚拟列表提取私信
- **废弃原因**: 已被 crawl-direct-messages-v2.js 中的新实现替代
- **调用次数**: 0

#### 方法 4: scrollPageToLoadMore
- **行号**: 1405-1437 (约33行)
- **功能**: 滚动页面加载更多内容
- **废弃原因**: 通用滚动逻辑已在各 crawl 文件中实现
- **调用次数**: 0

#### 方法 5: scrollMessageListToLoadMore
- **行号**: 1438-1610 (约173行)
- **功能**: 滚动消息列表加载更多（带 API 拦截）
- **废弃原因**: 已被 crawl-direct-messages-v2.js 中的虚拟列表滚动替代
- **调用次数**: 0

**总计**: 约 458 行废弃代码

### 保留的临时拦截器

以下方法包含临时 API 拦截器，但仍在使用，**不应删除**：

- `setupDMAPIInterceptors()` (行2121-2207) - 用于 `replyToDirectMessage` 的临时拦截
- `replyToComment()` (行2219-2954) - 回复评论功能
- `replyToDirectMessage()` (行2955-3340) - 回复私信功能

**原因**: 这些是特定功能的**临时性拦截器**，在任务执行时注册，任务结束后清理。与全局拦截器不冲突。

## 清理策略

### 阶段 1: 安全删除（已完成）
- ✅ crawl-direct-messages-v2.js: setupAPIInterceptors 及相关辅助函数（212行）

### 阶段 2: 批量删除废弃方法（进行中）
- ⏳ platform.js: 删除5个废弃方法（458行）

### 阶段 3: 验证（待执行）
- 启动 Worker 验证无错误
- 运行爬取任务验证功能正常

## 预期效果

- **代码减少**: ~670 行
- **文件数量**: 无变化（4个文件）
- **可维护性**: ⬆️⬆️⬆️ 显著提升
- **功能影响**: 无（删除的都是未使用的代码）

## 风险评估

**风险等级**: 🟢 低风险

**原因**:
1. 所有待删除的方法都**没有被调用**（通过 grep 验证）
2. 功能已被新实现替代
3. 可以通过 Git 回滚

**缓解措施**:
1. 删除前备份（Git commit）
2. 删除后立即测试
3. 如有问题可快速回滚

---

**创建日期**: 2025-10-28
**状态**: 进行中
