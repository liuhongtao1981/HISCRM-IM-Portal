# 作品和评论表字段验证完整报告

## 会话概览

**验证时间**：2025-10-27
**验证范围**：
1. ✅ 评论表（comments）- 作品标题字段
2. ✅ 作品表（works）- 完整字段映射

---

## 第一部分：评论表作品标题问题

### 问题现象
评论数据入库后，`post_title` 字段显示为"未知作品"，而不是实际的视频标题。

### 根本原因
1. **评论数不匹配**：
   - DOM 显示评论数：7 条
   - API 返回评论数：4 条
   - 原因：DOM 包含二级回复，API `total_count` 仅计顶级评论

2. **旧匹配逻辑失效**：
   ```javascript
   // 旧代码：通过评论数匹配
   const video = videosToClick.find(v => v.commentCountText == totalCount.toString());
   // 结果：7 != 4，匹配失败 → "未知作品"
   ```

3. **API 响应无标题**：
   - API 响应仅包含评论数据
   - 没有 `aweme_info` 或视频标题字段
   - 必须依赖 DOM 提取的标题

### 解决方案

**核心思路**：建立视频索引与 item_id 的映射关系

**关键发现**：
- API 请求在打开模态框时就发生（而非点击视频后）
- `videosToClick` 数组按 DOM 顺序排列
- `apiResponses.comments` 数组按 API 请求顺序排列
- **假设**：DOM 顺序 = API 响应顺序

**映射策略**（crawl-comments.js:305-311）：
```javascript
// 按索引顺序一一对应
if (apiResponses.comments.length > i && apiResponses.comments[i].item_id) {
  const itemId = apiResponses.comments[i].item_id;
  videoIndexToItemId[video.index] = itemId;
  logger.info(`📝 Mapped: video[${video.index}] "${video.title}" -> item_id: ${itemId}`);
}
```

**三层回退匹配**（crawl-comments.js:558-596）：
1. **方法 1**（索引映射）：最可靠 ✅
2. **方法 2**（评论数匹配）：备用，不可靠 ⚠️
3. **方法 3**（默认值）：兜底，显示"未知作品" ❌

### 修改的文件

| 文件 | 修改内容 | 行数 |
|------|---------|------|
| crawl-comments.js | 添加索引映射逻辑 | 268-311 |
| crawl-comments.js | 保留三层回退匹配逻辑 | 558-596 |
| crawl-comments.js | 添加完整对象结构调试日志 | 73-172 |
| crawl-comments.js | 添加视频列表调试日志 | 248-254 |

### 新增文档

- [09-DOUYIN-作品标题未知问题分析.md](./09-DOUYIN-作品标题未知问题分析.md)
- [10-DOUYIN-作品标题未知问题修复总结.md](./10-DOUYIN-作品标题未知问题修复总结.md)
- [作品标题未知问题修复验证报告.md](./作品标题未知问题修复验证报告.md)

### 新增调试脚本

- [tests/debug-video-title.js](../tests/debug-video-title.js)
- [tests/debug-api-structure.js](../tests/debug-api-structure.js)

### Git 提交

```
c57996e docs: 添加作品标题问题分析文档和调试脚本
8dbb54b fix: 修复作品标题显示"未知作品"问题 - 实现索引映射
14c5519 docs: 添加作品标题修复验证报告
```

### 验证预期

**成功日志**：
```
📝 Mapped: video[0] "第一次排位五杀，感谢中国好队友" -> item_id: @j/du7rRFQE76...
✅ Method 1 (Index Mapping): Found video[0] -> "第一次排位五杀，感谢中国好队友"
Video "第一次排位五杀，感谢中国好队友": 4/4 comments
```

**数据库验证**：
```sql
SELECT post_title, COUNT(*) FROM comments
WHERE platform = 'douyin' AND created_at > datetime('now', '-1 hour')
GROUP BY post_title;
```

**预期**：看到实际标题，不再是"未知作品" ✅

---

## 第二部分：作品表字段映射验证

### 验证目标
检查 `works` 表的数据库字段与 `crawl-works.js` 代码的字段映射是否一致。

### 验证结果：✅ 完全匹配

| 数据库字段 | 代码字段 | 数据类型 | 匹配状态 |
|-----------|---------|---------|----------|
| `id` | `id` | TEXT | ✅ |
| `account_id` | `account_id` | TEXT | ✅ |
| `platform` | `platform` | TEXT | ✅ |
| `platform_work_id` | `platform_work_id` | TEXT | ✅ |
| `platform_user_id` | `platform_user_id` | TEXT | ✅ |
| `work_type` | `work_type` | TEXT | ✅ |
| `title` | `title` | TEXT | ✅ |
| `description` | `description` | TEXT | ✅ |
| `cover` | `cover` | TEXT | ✅ |
| `url` | `url` | TEXT | ✅ |
| `publish_time` | `publish_time` | INTEGER | ✅ |
| `total_comment_count` | `total_comment_count` | INTEGER | ✅ |
| `new_comment_count` | `new_comment_count` | INTEGER | ✅ |
| `like_count` | `like_count` | INTEGER | ✅ |
| `share_count` | `share_count` | INTEGER | ✅ |
| `view_count` | `view_count` | INTEGER | ✅ |
| `last_crawl_time` | `last_crawl_time` | INTEGER | ✅ |
| `crawl_status` | `crawl_status` | TEXT | ✅ |
| `crawl_error` | `crawl_error` | TEXT | ✅ |
| `is_new` | `is_new` | BOOLEAN | ✅ |
| `push_count` | `push_count` | INTEGER | ✅ |
| `created_at` | `created_at` | INTEGER | ✅ |
| `updated_at` | `updated_at` | INTEGER | ✅ |

**总计**：23/23 字段，100% 匹配 ✅

### 发现的潜在问题

#### ⚠️ publish_time 时间戳格式

**问题**：
- API 可能返回毫秒级时间戳（13 位）
- 数据库期望秒级时间戳（10 位）
- 未转换会导致时间显示错误（如 2054 年）

**修复方案**（crawl-works.js:486-494）：
```javascript
// 处理 publish_time：确保转换为秒级时间戳
let publishTime = work.publish_time || null;
if (publishTime) {
  // 如果是 13 位毫秒级时间戳，转换为 10 位秒级
  if (String(publishTime).length === 13) {
    publishTime = Math.floor(publishTime / 1000);
    logger.debug(`Converted publish_time from milliseconds to seconds: ${work.publish_time} -> ${publishTime}`);
  }
}
```

### 约束验证

#### 1. 唯一约束 ✅
```sql
UNIQUE(account_id, platform, platform_work_id)
```

**代码实现**：
- `account_id`：从 `account.id` 获取
- `platform`：固定为 `'douyin'`
- `platform_work_id`：从 Fiber/API 提取的 `aweme_id`

**结论**：✅ 可防止重复入库

#### 2. 外键约束 ✅
```sql
FOREIGN KEY (account_id) REFERENCES accounts(id) ON DELETE CASCADE
```

**代码实现**：使用 `account.id`（传入参数）

**结论**：✅ 账户删除时，作品自动删除

#### 3. CHECK 约束 ✅
```sql
CHECK(work_type IN ('video', 'article', 'image', 'audio', 'text'))
```

**代码实现**：
- `detectWorkType()` 返回 `'video'`, `'image'`, `'article'`
- 默认值为 `'video'`

**结论**：✅ 满足约束（抖音无 audio/text 类型是正常的）

### 修改的文件

| 文件 | 修改内容 |
|------|---------|
| crawl-works.js | 添加 publish_time 时间戳转换逻辑（486-494行） |

### 新增文档

- [11-DOUYIN-作品表字段映射验证报告.md](./11-DOUYIN-作品表字段映射验证报告.md)

### Git 提交

```
142a083 fix: 修复作品发布时间时间戳格式 + 完成 works 表字段映射验证
8d3d828 chore: 删除错误的作品表字段对比分析文档
```

### 验证预期

**数据库查询**：
```sql
SELECT
  platform_work_id,
  title,
  work_type,
  view_count,
  total_comment_count,
  datetime(publish_time, 'unixepoch') as publish_time_formatted,
  datetime(created_at, 'unixepoch') as created_at_formatted
FROM works
WHERE platform = 'douyin'
  AND created_at > strftime('%s', 'now', '-1 hour')
ORDER BY created_at DESC
LIMIT 10;
```

**预期结果**：
- ✅ `platform_work_id` 有值（aweme_id）
- ✅ `title` 有值（作品标题）
- ✅ `work_type` 为 'video' 或 'image'
- ✅ `view_count` > 0（如果有播放量）
- ✅ `publish_time_formatted` 显示正确日期（不是 2054 年）

---

## 完整提交记录

```bash
git log --oneline -5
```

```
8d3d828 chore: 删除错误的作品表字段对比分析文档（基于已弃用的 douyin_videos 表）
142a083 fix: 修复作品发布时间时间戳格式 + 完成 works 表字段映射验证
14c5519 docs: 添加作品标题修复验证报告
c57996e docs: 添加作品标题问题分析文档和调试脚本
8dbb54b fix: 修复作品标题显示"未知作品"问题 - 实现索引映射
```

---

## 总结

### ✅ 已完成的工作

1. **评论表作品标题修复**
   - 实现视频索引与 item_id 映射
   - 三层回退匹配策略
   - 完整的调试日志和分析文档

2. **作品表字段验证**
   - 23/23 字段完全匹配 ✅
   - 修复 publish_time 时间戳格式问题
   - 验证所有数据库约束

3. **文档和测试**
   - 5 个分析和验证文档
   - 2 个调试脚本
   - 完整的验证步骤和预期结果

### 🎯 修复效果

| 问题 | 修复前 | 修复后 |
|------|--------|--------|
| 评论作品标题 | "未知作品" | 实际标题 ✅ |
| 作品发布时间 | 可能错误（2054年） | 正确日期 ✅ |
| 字段映射 | 未验证 | 100% 匹配 ✅ |

### ⚠️ 风险和限制

1. **评论标题映射**
   - 假设：DOM 顺序 = API 响应顺序
   - 单视频场景：100% 可靠 ✅
   - 多视频场景：需验证假设是否成立

2. **时间戳转换**
   - 仅处理 13 位毫秒级时间戳
   - 如果 API 返回其他格式，需扩展逻辑

### 📋 下一步建议

1. **立即验证**
   - 运行 Worker 爬虫
   - 检查日志和数据库
   - 确认修复生效

2. **多视频测试**
   - 在多视频场景下测试
   - 验证 DOM 顺序假设
   - 如需要，考虑从 DOM 提取 aweme_id

3. **持续监控**
   - 观察日志中的时间戳转换
   - 检查是否有新的字段映射问题

---

**报告时间**：2025-10-27
**报告人员**：Claude
**验证状态**：✅ 代码已修复，待实际运行验证
