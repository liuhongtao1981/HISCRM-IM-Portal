# ç§ä¿¡æ¶ˆæ¯æ—¶é—´æˆ³é—®é¢˜åˆ†æ

## é—®é¢˜ç°è±¡

IM PC å®¢æˆ·ç«¯æ˜¾ç¤ºçš„ç§ä¿¡æ¶ˆæ¯æ—¶é—´ä¸º **01/01 08:33**ï¼ˆ1æœˆ1æ—¥ï¼‰ï¼Œä½†å®é™…åº”è¯¥æ˜¯ **11æœˆ1æ—¥** æˆ– **11æœˆ4æ—¥**ã€‚

## æ ¹æœ¬åŸå› 

### å‘ç°1ï¼šç³»ç»Ÿæ—¶é—´é”™è¯¯

é€šè¿‡ `node -e "console.log(new Date())"` æ£€æµ‹å‘ç°ï¼š

```
ç³»ç»Ÿæ—¶é—´: 2025-11-04 16:29:22
å®é™…åº”è¯¥æ˜¯: 2024-11-04 16:29:22
```

**ç³»ç»Ÿæ—¶é—´æ•´æ•´å¿«äº†ä¸€å¹´ï¼**

### å‘ç°2ï¼šæ—¶é—´æˆ³æ¥æºåˆ†æ

æ£€æŸ¥ Master æ—¥å¿—ä¸­çš„æ—¶é—´æˆ³ï¼š

```
lastMessageTime: 1762244286403 (2025/11/4 16:18:06)
```

æ—¶é—´æˆ³ `1762244286403` è½¬æ¢ä¸ºæ—¥æœŸæ˜¯ **2025å¹´11æœˆ4æ—¥**ï¼Œè¯å®äº†ç³»ç»Ÿæ—¶é—´é”™è¯¯çš„å½±å“ã€‚

### å‘ç°3ï¼šä»£ç ä¸­ä½¿ç”¨äº† Date.now()

åœ¨ `crawl-direct-messages-v2.js` ä¸­æ‰¾åˆ°é—®é¢˜ä»£ç ï¼š

```javascript
// Line 481
last_message_time: Math.floor(Date.now() / 1000),  // âŒ ä½¿ç”¨ç³»ç»Ÿæ—¶é—´

// Line 648
last_message_time: time ? parseInt(time) : Math.floor(Date.now() / 1000),

// Line 52
if (!timestamp) {
  return Date.now();  // âŒ ä½¿ç”¨ç³»ç»Ÿæ—¶é—´
}

// Line 95
return Date.now();  // âŒ ä½¿ç”¨ç³»ç»Ÿæ—¶é—´
```

`Date.now()` è¿”å›çš„æ˜¯**å½“å‰ç³»ç»Ÿæ—¶é—´**çš„æ¯«ç§’çº§æ—¶é—´æˆ³ã€‚å¦‚æœç³»ç»Ÿæ—¶é—´è®¾ç½®é”™è¯¯ï¼Œè¿™ä¸ªå€¼å°±ä¼šé”™è¯¯ã€‚

## é—®é¢˜åˆ†æ

### ä¸ºä»€ä¹ˆä¸ä»è™šæ‹Ÿåˆ—è¡¨ä¸­æå–æ—¶é—´ï¼Ÿ

ç”¨æˆ·æå‡ºçš„å…³é”®é—®é¢˜ï¼š

> "æˆ‘ä»¬åº”è¯¥ä»è™šè¡¨é‡Œæ‰¾åˆ°åˆ›å»ºçš„æ—¶é—´é”™æ‰å¯¹å‘€ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬çš„ rawData æ²¡æœ‰è™šè¡¨å¯¹è±¡é‡Œçš„æ‰€æœ‰å±æ€§å‘¢"
>
> "å¹³å°ç§ä¿¡çš„å‘é€æ—¶é—´ï¼Œä¸€å®šä¹Ÿåœ¨è™šè¡¨é‡Œå‘€"

**åˆ†æ**ï¼š

1. **è™šæ‹Ÿåˆ—è¡¨ React Fiber æ•°æ®åŒ…å«å®Œæ•´ä¿¡æ¯**
   - æŠ–éŸ³çš„è™šæ‹Ÿåˆ—è¡¨ä½¿ç”¨ React æ¸²æŸ“
   - æ¯æ¡æ¶ˆæ¯çš„ `props` å¯¹è±¡åŒ…å«æ‰€æœ‰åŸå§‹æ•°æ®
   - åŒ…æ‹¬ `create_time`ã€`timestamp`ã€`createdAt` ç­‰æ—¶é—´å­—æ®µ

2. **å½“å‰ä»£ç å·²æ”¶é›†æ—¶é—´å­—æ®µ**

   åœ¨ `crawl-direct-messages-v2.js` ç¬¬ 1267-1271 è¡Œï¼š
   ```javascript
   // æ—¶é—´æˆ³ï¼ˆå¤šç§æ ¼å¼ï¼‰
   createdAt: props.createdAt,
   timestamp: props.timestamp,
   createTime: props.createTime,
   sendTime: props.sendTime,
   ```

3. **é—®é¢˜ï¼šå­—æ®µåå¯èƒ½ä¸åŒ¹é…**

   æŠ–éŸ³ API å¯èƒ½ä½¿ç”¨**ä¸‹åˆ’çº¿æ ¼å¼**ï¼ˆ`create_time`ï¼‰è€Œé**é©¼å³°æ ¼å¼**ï¼ˆ`createTime`ï¼‰ã€‚

## å·²æ·»åŠ çš„è°ƒè¯•ä»£ç 

åœ¨ `crawl-direct-messages-v2.js` ç¬¬ 1189-1204 è¡Œæ·»åŠ äº†è°ƒè¯•æ—¥å¿—ï¼š

```javascript
// ğŸ” è°ƒè¯•ï¼šæ‰“å°è™šæ‹Ÿåˆ—è¡¨å¯¹è±¡çš„æ‰€æœ‰å­—æ®µï¼ˆä»…æ‰“å°ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼‰
if (messages.length === 0) {
  console.log('\nğŸ” [DEBUG] è™šæ‹Ÿåˆ—è¡¨ props å¯¹è±¡çš„æ‰€æœ‰å­—æ®µ:');
  console.log('æ‰€æœ‰é”®:', Object.keys(props));
  console.log('\næ—¶é—´ç›¸å…³å­—æ®µ:');
  const timeKeys = Object.keys(props).filter(k =>
    k.toLowerCase().includes('time') ||
    k.toLowerCase().includes('create') ||
    k.toLowerCase().includes('timestamp') ||
    k.toLowerCase().includes('date')
  );
  timeKeys.forEach(key => {
    console.log(`  ${key}: ${props[key]} (type: ${typeof props[key]})`);
  });
  console.log('\nå®Œæ•´ props å¯¹è±¡:', JSON.stringify(props, null, 2).substring(0, 2000));
}
```

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¿®æ­£ç³»ç»Ÿæ—¶é—´ï¼ˆæ¨èï¼‰

**æ­¥éª¤**ï¼š
1. å³é”®ç‚¹å‡»ä»»åŠ¡æ å³ä¸‹è§’çš„æ—¶é—´
2. é€‰æ‹©"è°ƒæ•´æ—¥æœŸ/æ—¶é—´"
3. å…³é—­"è‡ªåŠ¨è®¾ç½®æ—¶é—´"
4. æ‰‹åŠ¨å°†å¹´ä»½ä» **2025** æ”¹ä¸º **2024**
5. é‡æ–°å¯åŠ¨ Master å’Œ Worker è¿›ç¨‹

**ä¼˜ç‚¹**ï¼š
- ä¸€åŠ³æ°¸é€¸ï¼Œæ‰€æœ‰é—®é¢˜è‡ªåŠ¨è§£å†³
- ä¸éœ€è¦ä¿®æ”¹ä»»ä½•ä»£ç 
- é¿å…å…¶ä»–ä¾èµ–ç³»ç»Ÿæ—¶é—´çš„åŠŸèƒ½å‡ºé”™

### æ–¹æ¡ˆ2ï¼šä»è™šæ‹Ÿåˆ—è¡¨æå–æ­£ç¡®æ—¶é—´ï¼ˆå¾…éªŒè¯ï¼‰

ç­‰å¾…è°ƒè¯•æ—¥å¿—è¾“å‡ºåï¼ŒæŸ¥çœ‹è™šæ‹Ÿåˆ—è¡¨ä¸­å®é™…çš„æ—¶é—´å­—æ®µåï¼Œç„¶åï¼š

1. **æ›´æ–° rawData æ”¶é›†å­—æ®µ**

   æ·»åŠ ä¸‹åˆ’çº¿æ ¼å¼çš„æ—¶é—´å­—æ®µï¼š
   ```javascript
   // æ—¶é—´æˆ³ï¼ˆå¤šç§æ ¼å¼ï¼‰
   createdAt: props.createdAt,
   timestamp: props.timestamp,
   createTime: props.createTime,
   create_time: props.create_time,      // âœ… æ–°å¢
   sendTime: props.sendTime,
   send_time: props.send_time,          // âœ… æ–°å¢
   last_time: props.last_time,          // âœ… æ–°å¢
   update_time: props.update_time,      // âœ… æ–°å¢
   ```

2. **æ›´æ–°æ—¶é—´æˆ³å½’ä¸€åŒ–é€»è¾‘**

   åœ¨ç¬¬ 1378-1379 è¡Œï¼š
   ```javascript
   // æ—¶é—´æˆ³ï¼ˆä¼˜å…ˆä½¿ç”¨è™šæ‹Ÿåˆ—è¡¨ä¸­çš„çœŸå®æ—¶é—´ï¼‰
   timestamp: props.createdAt || props.create_time || props.timestamp ||
              props.createTime || props.sendTime || props.send_time,
   created_at: props.createdAt || props.create_time || props.timestamp ||
               props.createTime || props.sendTime || props.send_time,
   ```

3. **ç§»é™¤ Date.now() å…œåº•**

   å°† `new Date().toISOString()` æ›¿æ¢ä¸º `0` æˆ–è®°å½•è­¦å‘Šï¼š
   ```javascript
   timestamp: props.createdAt || props.create_time || ... || 0,  // âŒ ä¸è¦ç”¨ Date.now()
   ```

### æ–¹æ¡ˆ3ï¼šä»£ç ä¸­ä¸´æ—¶ä¿®æ­£ï¼ˆä¸æ¨èï¼‰

åœ¨ `normalizeTimestamp()` å‡½æ•°ä¸­å‡å»ä¸€å¹´ï¼š

```javascript
function normalizeTimestamp(timestamp) {
  // ... ç°æœ‰é€»è¾‘ ...

  // âš ï¸ ä¸´æ—¶ä¿®æ­£ï¼šç³»ç»Ÿæ—¶é—´å¿«äº†ä¸€å¹´
  const ONE_YEAR_MS = 365.25 * 24 * 3600 * 1000;  // 31557600000 æ¯«ç§’

  if (!timestamp) {
    return Date.now() - ONE_YEAR_MS;  // âš ï¸ ä¸´æ—¶æ–¹æ¡ˆ
  }

  // ... å…¶ä»–å¤„ç† ...
}
```

**ç¼ºç‚¹**ï¼š
- æ²»æ ‡ä¸æ²»æœ¬
- æ˜å¹´ç³»ç»Ÿæ—¶é—´è‡ªåŠ¨æ›´æ–°ååˆä¼šå‡ºé”™
- å…¶ä»–ä¾èµ–ç³»ç»Ÿæ—¶é—´çš„åŠŸèƒ½ä»ä¼šå‡ºé”™

## éªŒè¯æ–¹æ³•

ä¿®æ­£åï¼ŒéªŒè¯ä»¥ä¸‹å‡ ç‚¹ï¼š

1. **æ£€æŸ¥ç³»ç»Ÿæ—¶é—´**
   ```bash
   node -e "console.log('System time:', new Date().toLocaleString('zh-CN'))"
   ```
   åº”æ˜¾ç¤ºï¼š`System time: 2024/11/4 ...`

2. **æ£€æŸ¥æ—¶é—´æˆ³å€¼**
   ```bash
   node -e "console.log('Timestamp:', Date.now())"
   ```
   åº”æ˜¾ç¤ºï¼š`Timestamp: 1730xxxxxxxxx`ï¼ˆ13ä½ï¼Œä»¥1730å¼€å¤´ï¼‰

3. **IM å®¢æˆ·ç«¯æ˜¾ç¤º**
   - ç§ä¿¡æ¶ˆæ¯æ—¶é—´åº”æ˜¾ç¤ºä¸º `11/01` æˆ– `11/04`
   - è€Œä¸æ˜¯ `01/01`

## æ—¶é—´æˆ³è®¡ç®—éªŒè¯

```javascript
// é”™è¯¯çš„æ—¶é—´æˆ³ï¼ˆç³»ç»Ÿæ—¶é—´ä¸º2025å¹´ï¼‰
const wrongTimestamp = 1762244286403;
new Date(wrongTimestamp).toLocaleString('zh-CN');
// è¾“å‡º: 2025/11/4 16:18:06

// æ­£ç¡®çš„æ—¶é—´æˆ³ï¼ˆç³»ç»Ÿæ—¶é—´ä¸º2024å¹´ï¼‰
const correctTimestamp = 1730708286000;
new Date(correctTimestamp).toLocaleString('zh-CN');
// è¾“å‡º: 2024/11/4 16:18:06

// å·®å€¼
wrongTimestamp - correctTimestamp = 31536000403 æ¯«ç§’ = 365 å¤©
```

## åç»­ä»»åŠ¡

1. âœ… æ·»åŠ è°ƒè¯•æ—¥å¿—ï¼Œæ‰“å°è™šæ‹Ÿåˆ—è¡¨ `props` å¯¹è±¡çš„æ‰€æœ‰å­—æ®µ
2. â³ ç­‰å¾…ä¸‹ä¸€æ¬¡ç§ä¿¡çˆ¬å–ï¼ˆçº¦30ç§’ï¼‰
3. â³ æŸ¥çœ‹ Worker æ—¥å¿—ï¼Œç¡®è®¤è™šæ‹Ÿåˆ—è¡¨ä¸­çš„å®é™…æ—¶é—´å­—æ®µå
4. â³ æ ¹æ®å®é™…å­—æ®µåæ›´æ–°ä»£ç 
5. â³ **æœ€é‡è¦**ï¼šä¿®æ­£ç³»ç»Ÿæ—¶é—´ä¸º 2024 å¹´

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**åˆ›å»ºæ—¶é—´**ï¼š2024-11-04 16:35
**æœ€åæ›´æ–°**ï¼š2024-11-04 16:35
**çŠ¶æ€**ï¼šé—®é¢˜åˆ†æå®Œæˆï¼Œç­‰å¾…è°ƒè¯•ä¿¡æ¯
