# API 对比总结：原版 IM vs Master

**对比日期**: 2025-10-23

**统计**: 原版 IM 24 个接口 vs Master 50+ 接口

---

## 一、快速对比

### 接口覆盖率

```
原版 IM 核心功能     Master 实现度
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
账户管理 (6)      ✅ 100% (6/6)
会话查询 (4)      ⚠️  25%  (1/4)
消息查询 (6)      ⚠️  33%  (2/6)
消息操作 (5)      ⚠️  20%  (1/5)
用户管理 (3)      ❌  0%   (0/3)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
总计    (24)     42% (10/24)
```

### Master 额外功能

```
Master 独有接口 (40+ 个)
━━━━━━━━━━━━━━━━━━━━━━━━━━
Worker 管理       11 个
Worker 配置       7 个
代理管理          6 个
平台管理          3 个
统计分析          2 个
调试接口          5 个
━━━━━━━━━━━━━━━━━━━━━━━━━━
小计              34 个
```

**结论**: Master = 原版 IM 功能的超集 + 分布式系统管理功能

---

## 二、详细对标

### 🟢 完全实现 (6 个)

| # | 原版 IM API | Master API | 状态 |
|---|-------------|-----------|------|
| 1 | 获取账户列表 | GET /api/v1/accounts | ✅ |
| 2 | 获取单个账户 | GET /api/v1/accounts/:id | ✅ |
| 3 | 创建账户 | POST /api/v1/accounts | ✅ |
| 4 | 更新账户 | PATCH /api/v1/accounts/:id | ✅ |
| 5 | 删除账户 | DELETE /api/v1/accounts/:id | ✅ |
| 6 | 获取账户状态 | GET /api/v1/accounts/status/all | ✅ |

**说明**: 账户管理完全相同，无需调整。

---

### 🟡 部分实现 (4 个)

#### 会话列表
| 方面 | 原版 IM | Master | 调整 |
|-----|--------|--------|------|
| **API** | POST /v1/message/get_by_user_init | GET /api/v1/conversations | ⚠️ |
| **分页** | cursor/count | offset/limit | 需改进 |
| **未读数** | ✅ unread_count | ❌ 无 | 需新增 |
| **has_more** | ✅ 有 | ❌ 无 | 需新增 |
| **排序** | ✅ sort_by | ❌ 无 | 需新增 |
| **搜索** | ✅ 支持 | ❌ 无 | 需新增 |

**工作**: 修改现有接口，支持 cursor、unread_count、has_more、sort_by、search

---

#### 消息历史
| 方面 | 原版 IM | Master | 调整 |
|-----|--------|--------|------|
| **API** | POST /v1/im/message/history | GET /api/v1/direct-messages | ⚠️ |
| **分页** | cursor/direction | offset/limit | 需改进 |
| **方向** | ✅ backward/forward | ❌ 无 | 需新增 |
| **has_more** | ✅ 有 | ❌ 无 | 需新增 |
| **时间范围** | ✅ start_time/end_time | ❌ 无 | 需新增 |

**工作**: 改进分页机制，支持 direction、has_more、时间筛选

---

#### 标记已读
| 方面 | 原版 IM | Master | 调整 |
|-----|--------|--------|------|
| **API** | POST /messages/{id}/read | POST /api/v1/messages/:id/read | ✅ 兼容 |
| **批量** | ✅ message_ids[] | ❌ 单条 | 需新增 |
| **对话级** | ✅ conversation_id | ❌ 无 | 需新增 |

**工作**: 支持批量 IDs、对话级标记

---

#### 发送消息
| 方面 | 原版 IM | Master | 调整 |
|-----|--------|--------|------|
| **API** | POST /v1/im/send_message | Socket.IO monitor:reply | ⚠️ 协议差异 |
| **HTTP** | ✅ 有 | ❌ 无 | 需新增 HTTP 端点 |
| **内容** | text | text | ✅ 一致 |
| **媒体** | image/file/video | 有限支持 | ✅ 兼容 |
| **回复** | ✅ reply_to_message_id | 有限支持 | ✅ 兼容 |

**工作**: 创建 HTTP API (POST /api/v1/messages/send)，与现有 Socket.IO 协调

---

### 🔴 完全缺失 (14 个)

#### 会话操作 (3 个)

| 原版 IM API | Master | 工作量 |
|------------|--------|--------|
| 获取会话详情 | ❌ 无 | 8h |
| 搜索会话 | ❌ 无 | 6h |
| 会话置顶/静音 | ❌ 无 | 4h |

---

#### 消息查询 (4 个)

| 原版 IM API | Master | 工作量 |
|------------|--------|--------|
| 按类型查询 | ❌ 无 | 4h |
| 全文搜索 | ❌ 无 | 8h |
| 消息统计 | ❌ 无 | 3h |
| （缺失功能统计） | - | - |

---

#### 消息操作 (3 个)

| 原版 IM API | Master | 工作量 |
|------------|--------|--------|
| 编辑消息 | ❌ 无 | 6h |
| 删除消息 | ❌ 无 | 4h |
| （缺失功能统计） | - | - |

---

#### 用户管理 (3 个)

| 原版 IM API | Master | 工作量 |
|------------|--------|--------|
| 获取用户信息 | ❌ 无 | 6h |
| 搜索用户 | ❌ 无 | 3h |
| 用户黑名单 | ❌ 无 | 4h |

---

#### 其他 (1 个)

| 原版 IM API | Master | 工作量 |
|------------|--------|--------|
| 会话静音 | ❌ 无 | 2h |

---

## 三、关键差异

### 1. 协议差异

| 项目 | 原版 IM | Master | 影响 |
|-----|--------|--------|------|
| **API 风格** | 混合 (REST + RPC) | REST + Socket.IO | 需适配 |
| **HTTP 方法** | POST/GET/PATCH/DELETE | GET/POST/PATCH/DELETE | ✅ 兼容 |
| **响应格式** | status_code 0/非0 | success/error | ✅ 兼容 |
| **数据包装** | data { } | 直接返回 | ✅ 兼容 |
| **分页方式** | cursor/count | offset/limit | ⚠️ 需转换 |

---

### 2. 时间单位差异

| 项目 | 原版 IM | Master |
|-----|--------|--------|
| **时间戳** | 毫秒 (13 位) | 秒 (10 位) |
| **示例** | 1697980000000 | 1697980000 |
| **转换** | Master 时间 × 1000 | IM 时间 ÷ 1000 |

**需要在客户端转换**

---

### 3. 数据模型差异

| 概念 | 原版 IM | Master | 映射 |
|-----|--------|--------|------|
| **用户** | user (有user_id、user_name等) | account (账户) | account = 我们的账户 |
| **对话** | conversation (一对一私信) | conversations + comments | 分开存储 |
| **消息** | message (私信/评论) | direct_messages + comments | 分开存储 |
| **会话** | conversation_id = user_id 或 MD5 | id (评论ID或对话ID) | 需转换 |
| **消息ID** | platform_message_id | id | 命名一致 |

---

### 4. 消息类型一致性

| 消息类型 | 原版 IM | Master | 一致性 |
|---------|--------|--------|--------|
| 文本 | text | text | ✅ |
| 图片 | image | image | ✅ |
| 文件 | file | file | ✅ |
| 视频 | video | video | ✅ |
| 系统消息 | (隐含) | SYSTEM | ✅ |
| 通知 | (隐含) | NOTIFICATION | ✅ |

---

## 四、实现优先级

### 🔴 P1 必须 (50 小时)

**目标**: 100% 兼容原版 IM 核心功能

```
会话相关 (14 小时)
├─ 会话列表改进 (6h)       ← 开始这里
├─ 会话详情 (8h)

消息查询相关 (14 小时)
├─ 消息历史改进 (6h)
├─ 搜索消息 (8h)

消息操作相关 (10 小时)
├─ 标记已读改进 (4h)
├─ 发送消息 HTTP API (6h)

用户管理相关 (12 小时)
├─ 用户信息 (6h)
├─ 用户搜索 (3h)
├─ 用户黑名单 (4h)

总计: 50 小时
```

---

### 🟡 P2 重要 (21 小时)

```
高级会话功能 (10 小时)
├─ 会话搜索 (6h)
├─ 会话置顶/静音 (4h)

消息管理 (11 小时)
├─ 编辑消息 (6h)
├─ 删除消息 (4h)
├─ 消息统计 (3h)

总计: 21 小时
```

---

### 🟢 P3 可选 (7 小时)

```
会话静音 (2h)
按类型查询消息 (4h)
消息统计 (3h)

总计: 7 小时
```

---

## 五、实施建议

### 第一步：修改现有接口 (16 小时)
1. 会话列表 → 支持 cursor、unread_count、has_more、sort_by
2. 消息历史 → 支持 direction、has_more、时间筛选
3. 标记已读 → 支持批量、对话级

### 第二步：新增核心接口 (20 小时)
4. 会话详情 (含消息)
5. 发送消息 HTTP API
6. 搜索消息 (全文搜索)
7. 用户信息、搜索、黑名单

### 第三步：新增高级功能 (14 小时)
8. 会话搜索、置顶、静音
9. 消息编辑、删除

---

## 六、对比文件导航

📄 **三个关键文档**：

1. **[原版IM-API清单.md](./原版IM-API清单.md)**
   - 原版 IM 24 个接口完整定义
   - 包含请求/响应示例
   - 适合理解原版功能

2. **[Master-API现有清单.md](./Master-API现有清单.md)**
   - Master 50+ 个接口完整清单
   - 包含所有已实现功能
   - 适合了解 Master 现状

3. **[13-Master缺失接口精准对比.md](./13-Master缺失接口精准对比.md)**
   - 逐一对比缺失功能
   - 详细的实现指南
   - 工作量估计和代码框架

---

## 七、关键要点

### ✅ 不需要修改
- 账户管理 API (100% 兼容)
- 请求/响应格式 (基本兼容)
- 消息类型定义 (一致)

### ⚠️ 需要改进
- 会话查询接口 (分页、排序、搜索)
- 消息历史查询 (分页机制、方向)
- 标记已读功能 (支持批量)

### ❌ 需要新增
- 会话详情、搜索、置顶、静音
- 消息搜索、编辑、删除
- 用户信息、搜索、黑名单管理

### 🔄 需要转换
- 时间单位 (秒 ↔ 毫秒)
- 分页方式 (cursor ↔ offset/limit)
- 会话ID 格式 (可能的变化)

---

## 八、总结

| 指标 | 数值 |
|------|------|
| 原版 IM 接口总数 | 24 个 |
| Master 已实现 | 10 个 (42%) |
| 需要实现/改进 | 14 个 |
| **P1 工作量** | 50 小时 |
| **P2 工作量** | 21 小时 |
| **P3 工作量** | 7 小时 |
| **总工作量** | 78 小时 |

---

**下一步**: 开始实现 P1 接口，建议从会话列表改进开始。

