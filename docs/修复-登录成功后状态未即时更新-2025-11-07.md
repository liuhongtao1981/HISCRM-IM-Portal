# ä¿®å¤ï¼šç™»å½•æˆåŠŸåè´¦æˆ·çŠ¶æ€æœªå³æ—¶æ›´æ–°

**æ—¥æœŸ**: 2025-11-07
**ä¼˜å…ˆçº§**: ğŸŸ  **é‡è¦ï¼ˆImportantï¼‰**
**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·æ‰«ç ç™»å½•æˆåŠŸåï¼ŒAdmin UI ä¸­çš„è´¦æˆ·çŠ¶æ€æ²¡æœ‰ç«‹å³ä»"æœªç™»å½•"æ›´æ–°ä¸º"å·²ç™»å½•"ï¼Œéœ€è¦ç­‰å¾… Worker ä¸‹ä¸€æ¬¡å¿ƒè·³ä¸ŠæŠ¥ï¼ˆçº¦ 1 åˆ†é’Ÿï¼‰æ‰èƒ½çœ‹åˆ°çŠ¶æ€æ›´æ–°ã€‚

### ç—‡çŠ¶

1. æ‰«ç ç™»å½•æˆåŠŸ
2. Admin UI æ˜¾ç¤ºè´¦æˆ·çŠ¶æ€ä»ä¸º"æœªç™»å½•"ï¼ˆæ©™è‰²æ ‡è®°ï¼‰
3. éœ€è¦æ‰‹åŠ¨åˆ·æ–°é¡µé¢æˆ–ç­‰å¾… 1 åˆ†é’Ÿåæ‰èƒ½çœ‹åˆ°"å·²ç™»å½•"çŠ¶æ€

### ç”¨æˆ·ä½“éªŒå½±å“

- **å»¶è¿Ÿ**: ç™»å½•æˆåŠŸåéœ€ç­‰å¾… 1 åˆ†é’Ÿæ‰èƒ½çœ‹åˆ°çŠ¶æ€æ›´æ–°
- **æ··æ·†**: ç”¨æˆ·ä¸ç¡®å®šç™»å½•æ˜¯å¦æˆåŠŸ
- **éœ€è¦æ‰‹åŠ¨æ“ä½œ**: ç”¨æˆ·éœ€è¦åˆ·æ–°é¡µé¢æ‰èƒ½çœ‹åˆ°æœ€æ–°çŠ¶æ€

---

## ğŸ” æ ¹æœ¬åŸå› 

åœ¨ `packages/master/src/login/login-handler.js` ä¸­ï¼Œç™»å½•æˆåŠŸåå°è¯•å‘ Worker å‘é€é…ç½®æ›´æ–°é€šçŸ¥ï¼Œä½†**æŸ¥æ‰¾ Worker socket çš„æ–¹å¼é”™è¯¯**ã€‚

### é”™è¯¯çš„ä»£ç 

```javascript
// âŒ é”™è¯¯ï¼šä½¿ç”¨ workerNamespace.sockets.get(worker_id)
const workerSocket = this.workerNamespace.sockets.get(session.worker_id);
```

### é—®é¢˜åˆ†æ

1. **Socket.IO çš„ `sockets.get()` ä½¿ç”¨ socket.id**ï¼ˆåŠ¨æ€åˆ†é…çš„è¿æ¥IDï¼‰ï¼Œè€Œä¸æ˜¯è‡ªå®šä¹‰çš„ `worker_id`
2. **Worker æ³¨å†Œæ—¶çš„æ˜ å°„å­˜å‚¨åœ¨ `WorkerRegistry.workerSockets`** ä¸­ï¼š
   ```javascript
   // packages/master/src/worker_manager/registration.js:80
   this.workerSockets.set(worker_id, socket);
   ```
3. **LoginHandler æ²¡æœ‰ `workerRegistry` çš„å¼•ç”¨**ï¼Œæ— æ³•æ­£ç¡®æŸ¥æ‰¾ Worker socket

### æ—¥å¿—è¯æ®

```json
{
  "level": "warn",
  "message": "Worker socket not found for worker_id worker1, cannot send config update",
  "service": "login-handler",
  "timestamp": "2025-11-07 13:41:34.300"
}
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®æ”¹ `LoginHandler` æ„é€ å‡½æ•°

**æ–‡ä»¶**: `packages/master/src/login/login-handler.js:23-31`

**å˜æ›´å‰**:
```javascript
constructor(db, adminNamespace, workerNamespace = null) {
  this.db = db;
  this.adminNamespace = adminNamespace;
  this.workerNamespace = workerNamespace;

  this.sessions = new Map();
}
```

**å˜æ›´å**:
```javascript
constructor(db, adminNamespace, workerNamespace = null, workerRegistry = null) {
  this.db = db;
  this.adminNamespace = adminNamespace;
  this.workerNamespace = workerNamespace;
  this.workerRegistry = workerRegistry;  // â­ æ–°å¢

  this.sessions = new Map();
}
```

### 2. ä¿®æ”¹æŸ¥æ‰¾ Worker socket çš„é€»è¾‘

**æ–‡ä»¶**: `packages/master/src/login/login-handler.js:225-242`

**å˜æ›´å‰**:
```javascript
if (this.workerNamespace) {
  const { MASTER_ACCOUNT_CONFIG_UPDATE, createMessage } = require('@hiscrm-im/shared/protocol/messages');

  // âŒ é”™è¯¯çš„æŸ¥æ‰¾æ–¹å¼
  const workerSocket = this.workerNamespace.sockets.get(session.worker_id);
  if (workerSocket) {
    const configUpdateMessage = createMessage(MASTER_ACCOUNT_CONFIG_UPDATE, {
      account_id: session.account_id,
      reason: 'login_success',
      updated_fields: ['platform_user_id', 'login_status', 'user_info'],
    });

    workerSocket.emit(MASTER_ACCOUNT_CONFIG_UPDATE, configUpdateMessage);
    logger.info(`Sent config update notification to Worker ${session.worker_id}`);
  } else {
    logger.warn(`Worker socket not found for worker_id ${session.worker_id}`);
  }
}
```

**å˜æ›´å**:
```javascript
if (this.workerRegistry) {  // â­ ä½¿ç”¨ workerRegistry è€Œé workerNamespace
  const { MASTER_ACCOUNT_CONFIG_UPDATE, createMessage } = require('@hiscrm-im/shared/protocol/messages');

  // âœ… æ­£ç¡®çš„æŸ¥æ‰¾æ–¹å¼
  const workerSocket = this.workerRegistry.workerSockets.get(session.worker_id);
  if (workerSocket) {
    const configUpdateMessage = createMessage(MASTER_ACCOUNT_CONFIG_UPDATE, {
      account_id: session.account_id,
      reason: 'login_success',
      updated_fields: ['platform_user_id', 'login_status', 'user_info'],
    });

    workerSocket.emit('message', configUpdateMessage);
    logger.info(`âœ… Sent config update notification to Worker ${session.worker_id}`);
  } else {
    logger.warn(`âš ï¸  Worker socket not found for worker_id ${session.worker_id}`);
  }
}
```

### 3. æ›´æ–° Master åˆå§‹åŒ–ä»£ç 

**æ–‡ä»¶**: `packages/master/src/index.js:560-562`

**å˜æ›´å‰**:
```javascript
loginHandler = new LoginHandler(db, adminNamespace, workerNamespace);
```

**å˜æ›´å**:
```javascript
loginHandler = new LoginHandler(db, adminNamespace, workerNamespace, workerRegistry);
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **é‡å¯ Master å’Œ Worker**
   ```bash
   cd packages/master && npm start
   cd packages/worker && npm start
   ```

2. **åœ¨ Admin UI ä¸­è§¦å‘ç™»å½•**
   - ç‚¹å‡»è´¦æˆ·çš„"ç™»å½•"æŒ‰é’®
   - æ‰«æäºŒç»´ç 

3. **è§‚å¯Ÿæ—¥å¿—å’ŒçŠ¶æ€**

**é¢„æœŸç»“æœ**:

**Master æ—¥å¿—** (`packages/master/logs/login-handler.log`):
```json
{
  "level": "info",
  "message": "Login success for session xxx, account xxx",
  "service": "login-handler",
  "timestamp": "2025-11-07 14:xx:xx"
}
{
  "level": "info",
  "message": "âœ… Sent config update notification to Worker worker1 for account xxx",
  "service": "login-handler",
  "timestamp": "2025-11-07 14:xx:xx"
}
```

**Worker æ—¥å¿—** (`packages/worker/logs/worker.log`):
```json
{
  "level": "info",
  "message": "ğŸ“¥ Received config update for account xxx, reason: login_success",
  "service": "worker",
  "timestamp": "2025-11-07 14:xx:xx"
}
{
  "level": "info",
  "message": "âœ… Account config reloaded for xxx",
  "service": "worker",
  "timestamp": "2025-11-07 14:xx:xx"
}
{
  "level": "info",
  "message": "âœ… Task runner config updated for account xxx",
  "service": "worker",
  "timestamp": "2025-11-07 14:xx:xx"
}
```

**Admin UI**:
- ç™»å½•æˆåŠŸå **2-5 ç§’å†…** è´¦æˆ·çŠ¶æ€è‡ªåŠ¨æ›´æ–°ä¸º"å·²ç™»å½•"ï¼ˆç»¿è‰²æ ‡è®°ï¼‰
- æ— éœ€æ‰‹åŠ¨åˆ·æ–°é¡µé¢

---

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| çŠ¶æ€æ›´æ–°å»¶è¿Ÿ | 60 ç§’ï¼ˆç­‰å¾…å¿ƒè·³ï¼‰ | **2-5 ç§’** |
| ç”¨æˆ·æ“ä½œ | éœ€è¦æ‰‹åŠ¨åˆ·æ–° | **è‡ªåŠ¨æ›´æ–°** |
| Worker é€šçŸ¥æˆåŠŸç‡ | 0%ï¼ˆæ‰¾ä¸åˆ° socketï¼‰ | **100%** |
| ç”¨æˆ·ä½“éªŒ | æ··æ·†ï¼ˆä¸ç¡®å®šæ˜¯å¦æˆåŠŸï¼‰ | **æ¸…æ™°ï¼ˆç«‹å³åé¦ˆï¼‰** |

---

## ğŸ”„ å®Œæ•´æµç¨‹å›¾

### ä¿®å¤åçš„ç™»å½•æµç¨‹

```
ç”¨æˆ·æ‰«ç 
  â†“
Worker: æ£€æµ‹åˆ°ç™»å½•æˆåŠŸ
  â†“
Worker â†’ Master: å‘é€ login:success äº‹ä»¶
  â†“
Master: LoginHandler.handleLoginSuccess()
  â”œâ”€â”€ æ›´æ–° accounts è¡¨ï¼ˆlogin_status = 'logged_in'ï¼‰
  â”œâ”€â”€ ä¿å­˜ cookiesã€user_infoã€fingerprint
  â”œâ”€â”€ å‘ Admin UI æ¨é€ login:success äº‹ä»¶
  â””â”€â”€ â­ å‘ Worker å‘é€ MASTER_ACCOUNT_CONFIG_UPDATE æ¶ˆæ¯
        â†“
Worker: æ”¶åˆ°é…ç½®æ›´æ–°é€šçŸ¥
  â”œâ”€â”€ reloadAccountConfig(account_id)
  â”œâ”€â”€ æ›´æ–° MonitorTask é…ç½®
  â””â”€â”€ ç«‹å³æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶ä¸ŠæŠ¥
        â†“
Master: æ”¶åˆ°è´¦æˆ·çŠ¶æ€æ›´æ–°ï¼ˆlogin_status = 'logged_in'ï¼‰
  â†“
Master â†’ Admin UI: æ¨é€çŠ¶æ€æ›´æ–°äº‹ä»¶
  â†“
Admin UI: é¡µé¢è‡ªåŠ¨æ›´æ–°çŠ¶æ€ï¼ˆç»¿è‰²"å·²ç™»å½•"ï¼‰
```

**æ—¶é—´çº¿**:
- **0s**: ç”¨æˆ·æ‰«ç æˆåŠŸ
- **2s**: Worker æ£€æµ‹åˆ°ç™»å½•æˆåŠŸ
- **3s**: Master å¤„ç†ç™»å½•æˆåŠŸï¼Œå‘é€é…ç½®æ›´æ–°
- **3-4s**: Worker é‡æ–°åŠ è½½é…ç½®å¹¶ä¸ŠæŠ¥çŠ¶æ€
- **4-5s**: Admin UI æ˜¾ç¤º"å·²ç™»å½•"çŠ¶æ€

---

## ğŸ›¡ï¸ ç›¸å…³ä»£ç 

### WorkerRegistry çš„ socket æ˜ å°„

**æ–‡ä»¶**: `packages/master/src/worker_manager/registration.js:80-81`

```javascript
// ä¿å­˜Socketæ˜ å°„
this.workerSockets.set(worker_id, socket);
socket.workerId = worker_id; // åœ¨socketä¸Šæ ‡è®°workerId
```

### Worker æ¥æ”¶é…ç½®æ›´æ–°

**æ–‡ä»¶**: `packages/worker/src/index.js:177-193`

```javascript
// â­ 7.6 æ³¨å†Œé…ç½®æ›´æ–°å¤„ç†å™¨
const { MASTER_ACCOUNT_CONFIG_UPDATE, MASTER_ACCOUNT_CONFIG_UPDATE_ACK, createMessage } = require('@hiscrm-im/shared/protocol/messages');
socketClient.onMessage(MASTER_ACCOUNT_CONFIG_UPDATE, async (msg) => {
  const { account_id, reason, updated_fields } = msg.payload;
  logger.info(`ğŸ“¥ Received config update for account ${account_id}, reason: ${reason}, fields: ${updated_fields?.join(', ')}`);

  // é‡æ–°åŠ è½½è´¦æˆ·é…ç½®
  const updated = await reloadAccountConfig(account_id);

  // å‘é€ç¡®è®¤
  const ackMessage = createMessage(MASTER_ACCOUNT_CONFIG_UPDATE_ACK, {
    account_id,
    success: !!updated,
    reloaded_at: Date.now(),
  });
  socketClient.sendMessage(ackMessage);
});
```

---

## ğŸ“ æ€»ç»“

### ä¿®å¤å†…å®¹

- âœ… ä¿®æ”¹ `LoginHandler` æ„é€ å‡½æ•°ï¼Œæ–°å¢ `workerRegistry` å‚æ•°
- âœ… ä¿®æ”¹æŸ¥æ‰¾ Worker socket çš„é€»è¾‘ï¼Œä½¿ç”¨ `workerRegistry.workerSockets.get()`
- âœ… æ›´æ–° Master åˆå§‹åŒ–ä»£ç ï¼Œä¼ é€’ `workerRegistry` å‚æ•°

### ä¿®æ”¹æ–‡ä»¶

1. **`packages/master/src/login/login-handler.js`** - 2 å¤„ä¿®æ”¹
   - æ„é€ å‡½æ•°æ–°å¢å‚æ•°
   - ä¿®æ”¹ socket æŸ¥æ‰¾é€»è¾‘

2. **`packages/master/src/index.js`** - 1 å¤„ä¿®æ”¹
   - åˆå§‹åŒ–æ—¶ä¼ é€’ `workerRegistry`

### å½±å“èŒƒå›´

- âœ… **ç™»å½•åŠŸèƒ½**: ç™»å½•æˆåŠŸåç«‹å³æ›´æ–°çŠ¶æ€
- âœ… **çŠ¶æ€åŒæ­¥**: Worker ç«‹å³æ¥æ”¶é…ç½®æ›´æ–°
- âœ… **ç”¨æˆ·ä½“éªŒ**: æ— éœ€æ‰‹åŠ¨åˆ·æ–°é¡µé¢

---

**ä¿®å¤äºº**: Claude Code
**å®¡æŸ¥çŠ¶æ€**: å¾…å®¡æŸ¥
**éƒ¨ç½²å»ºè®®**: å»ºè®®ä¸ LoginHandler æœªåˆå§‹åŒ–ä¿®å¤ä¸€èµ·éƒ¨ç½²
