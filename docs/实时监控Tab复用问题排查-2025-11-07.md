# 实时监控 Tab 复用问题排查

**日期**: 2025-11-07 14:04
**问题**: 用户报告"没有新的 tab 打开"，实时监控未正确注入
**状态**: 🔍 排查中

---

## 🐛 问题描述

用户启动 Worker 后发现：
1. 浏览器中有 2 个 Tab：一个默认页，一个创作者中心（登录检测用）
2. **没有看到实时监控专用的 Tab 打开**
3. **实时监控日志自 13:55 后未更新**（文件修改时间：13:55）

---

## 🔍 问题分析

### 1. Worker 启动历史

| 启动时间 | 浏览器初始化 | 实时监控启动 | 状态 |
|---------|------------|------------|------|
| 13:19:52 | ✅ | ✅ | 成功 |
| 13:37:42 | ✅ | ✅ | 成功 |
| 13:55:58 | ✅ | ✅ | 成功 |
| 14:01:38 | ❌ (0/1) | ❌ | **失败** |
| 14:03:26 | ✅ (1/1) | **❌** | **部分失败** |

### 2. 最新 Worker (14:03:26) 问题

**Worker 主日志** (14:03:26):
```
✓ Browsers initialized: 1/1 succeeded
✓ Platform initialization completed
✓ Task runner started
✓ Added 1 monitoring tasks
✓ Worker Ready
```

**Monitor-Task 日志**:
- **没有 14:03 的记录**（日志文件最后修改时间：13:55）
- **缺失**：
  - "使用默认爬虫间隔: 5-10分钟"
  - "🚀 启动实时监控 (账户: xxx)..."
  - "✅ 实时监控已启动"

**Douyin-Platform 日志** (14:03:26):
```
启动实时监控 (账户: acc-98296c87-2e42-447a-9d8b-8be008ddb6e4)
查找或创建实时监控页面 (账户: acc-98296c87-2e42-447a-9d8b-8be008ddb6e4)
创建新的实时监控 Tab (账户: acc-98296c87-2e42-447a-9d8b-8be008ddb6e4)
✅ 新 Tab 创建成功 (tabId: tab-1)
导航到抖音创作者中心...
✅ 页面导航完成
✅ 实时监控启动成功 (账户: acc-98296c87-2e42-447a-9d8b-8be008ddb6e4)
```

**Douyin-Realtime-Monitor 日志**:
- **没有 14:03 的记录**
- 最后记录：13:55:59.331

---

## 💡 关键发现

1. **Douyin-Platform 日志显示实时监控成功启动**（14:03:29.782）
2. **但 Douyin-Realtime-Monitor 日志没有更新**
   - 说明 `DouyinRealtimeMonitor.start()` **未被调用**
   - 或日志文件写入失败

3. **Monitor-Task 日志也没有 14:03 记录**
   - 说明 `MonitorTask.start()` 中的日志**未写入文件**
   - 可能是日志文件被其他进程锁定

4. **Tab 创建成功** (tabId: tab-1)
   - 但用户报告"没有看到新 Tab"
   - 可能 Tab 被后台进程使用，未在前台显示

---

##修改记录

### 修改1: 智能复用现有 Tab

**文件**: `packages/worker/src/platforms/douyin/platform.js:2959-3005`

**修改前**:
```javascript
// 直接创建新 Tab (tag: REALTIME_MONITOR)
const { tabId, page: newPage } = await this.browserManager.tabManager.getPageForTask(
  account.id,
  {
    tag: TabTag.REALTIME_MONITOR,
    persistent: true,
    shareable: false,
    forceNew: false
  }
);
```

**修改后**:
```javascript
// 🔍 优先复用已存在的创作者中心 Tab（如 LOGIN_CHECK）
const accountTabs = this.browserManager.tabManager.tabs.get(account.id);
if (accountTabs) {
  for (const [tabId, tabInfo] of accountTabs.entries()) {
    try {
      const url = tabInfo.page.url();
      // 复用任何已在创作者中心的 Tab
      if (url.includes('creator.douyin.com') && !tabInfo.page.isClosed()) {
        logger.info(`♻️  复用现有 Tab ${tabId} (tag: ${tabInfo.tag}) 用于实时监控`);
        realtimePage = tabInfo.page;
        realtimeTabId = tabId;

        // 更新 Tab 标记为 REALTIME_MONITOR
        tabInfo.tag = TabTag.REALTIME_MONITOR;
        tabInfo.persistent = true;
        break;
      }
    } catch (error) {
      logger.warn(`检查 Tab ${tabId} 失败: ${error.message}`);
    }
  }
}

// 如果没找到可复用的，创建新 Tab
if (!realtimePage) {
  // ... 创建新 Tab 的逻辑
}
```

**预期效果**:
- ✅ 复用登录检测的创作者中心 Tab
- ✅ 避免创建重复的 Tab
- ✅ 用户看到的 Tab 数量不变

---

## 🧪 验证步骤

### 1. 检查浏览器窗口数量

```bash
# Windows: 查看 Chrome 进程数
tasklist | findstr "chrome.exe" | wc -l

# 预期结果: ~10 个进程（1个主进程 + 子进程）
```

### 2. 检查 Tab 注册状态

```javascript
// 在 Worker 中执行
console.log(browserManager.tabManager.tabs);

// 预期输出:
Map {
  'acc-xxx' => Map {
    'tab-1' => {
      tabId: 'tab-1',
      tag: 'REALTIME_MONITOR',  // 或 'login_check'
      persistent: true,
      page: Page {},
      ...
    }
  }
}
```

### 3. 检查实时监控钩子是否注入

在浏览器开发者工具中执行：
```javascript
// 检查钩子函数
typeof window.__checkRealtimeHooks
// 预期: "function"

// 检查钩子状态
window.__checkRealtimeHooks()
// 预期: true
```

---

## 🔄 待解决问题

1. **为什么 Douyin-Realtime-Monitor 日志没有 14:03 记录？**
   - 可能原因：
     - `DouyinRealtimeMonitor.start()` 未被调用
     - 日志文件被其他进程锁定
     - Logger 实例未正确初始化

2. **为什么 Monitor-Task 日志没有 14:03 记录？**
   - 可能原因：
     - 日志文件被替换或清空
     - Logger 配置在 Worker 重启时丢失
     - 日志写入被延迟（缓冲区未刷新）

3. **用户为什么没看到新 Tab？**
   - 可能原因：
     - Tab 在后台创建（headless 模式？）
     - Tab 被其他 Tab 覆盖
     - 浏览器窗口最小化

---

## 📝 下一步行动

1. ✅ **已完成**: 修改 `startRealtimeMonitor` 复用现有 Tab
2. ⏳ **待测试**: 重启 Worker 验证 Tab 复用逻辑
3. ⏳ **待排查**: 日志文件未更新的根本原因
4. ⏳ **待确认**: 浏览器窗口是否正确显示

---

**调查人**: Claude Code
**优先级**: 🟡 中等（功能可用，但用户体验不佳）
**影响范围**: 实时监控功能（Tab 管理）
