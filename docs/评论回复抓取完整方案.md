# è¯„è®ºå›å¤æŠ“å–å®Œæ•´æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜å‘ç°

### åŸå§‹é—®é¢˜
ç”¨æˆ·åé¦ˆ: "mcp é‡ŒæŠŠè¯„è®ºä¹Ÿç ”ç©¶ä¸€ä¸‹ï¼Œè¯„è®ºé‡Œçš„è®¨è®ºæˆ‘ä»¬è²Œä¼¼æ²¡æœ‰æŠ“å–å›æ¥"

### è°ƒæŸ¥è¿‡ç¨‹

#### 1. MCPæ‰‹åŠ¨æµ‹è¯•
é€šè¿‡MCPå·¥å…·æ‰‹åŠ¨æ“ä½œå‘ç°:
- âœ… è¯„è®ºå¯ä»¥æ­£å¸¸åŠ è½½
- âœ… "æŸ¥çœ‹Xæ¡å›å¤"æŒ‰é’®å­˜åœ¨
- âœ… ç‚¹å‡»æŒ‰é’®å,è®¨è®ºæˆåŠŸå±•å¼€
- âœ… è®¨è®ºæ•°æ®æ˜¾ç¤ºåœ¨DOMä¸­

#### 2. APIæ‹¦æˆªæµ‹è¯•
é€šè¿‡æµ‹è¯•è„šæœ¬å‘ç°:
- âœ… è¯„è®ºAPIèƒ½æ­£å¸¸æ‹¦æˆª (`/comment/list`)
- âŒ è®¨è®º/å›å¤API**æ— æ³•æ‹¦æˆª**

#### 3. å…³é”®å‘ç°
**è®¨è®ºæ•°æ®ä¸æ˜¯é€šè¿‡ç‹¬ç«‹APIåŠ è½½çš„,è€Œæ˜¯é€šè¿‡å‰ç«¯ç‚¹å‡»"æŸ¥çœ‹å›å¤"æŒ‰é’®è§¦å‘çš„,ä½†æˆ‘ä»¬çš„æ‹¦æˆªå™¨å´æ•è·ä¸åˆ°!**

å¯èƒ½åŸå› :
1. è®¨è®ºæ•°æ®å·²ç»åŒ…å«åœ¨è¯„è®ºAPIå“åº”ä¸­(ä½†å®é™…æ£€æŸ¥å‘ç°æ²¡æœ‰)
2. è®¨è®ºAPIçš„URLæ ¼å¼ä¸é¢„æœŸä¸åŒ
3. **ç‚¹å‡»"æŸ¥çœ‹å›å¤"æŒ‰é’®æ—¶å‰ç«¯å¯èƒ½ä»ç¼“å­˜æˆ–è™šæ‹ŸDOMä¸­è¯»å–æ•°æ®,è€Œä¸å‘èµ·æ–°çš„APIè¯·æ±‚**

## ğŸ” æ ¸å¿ƒå‘ç°

### è¯„è®ºAPIæ•°æ®ç»“æ„

```json
{
  "comment_id": "...",
  "text": "è¯„è®ºå†…å®¹",
  "create_time": "1557371703",
  "user_info": {
    "screen_name": "ç”¨æˆ·å",
    "user_id": "...",
    "avatar_url": "..."
  },
  "reply_count": "3",  // â­ å…³é”®å­—æ®µ - è¡¨ç¤ºæœ‰3æ¡å›å¤
  "digg_count": "12",
  "level": 1
}
```

**å…³é”®å­—æ®µ**:
- `reply_count`: å­—ç¬¦ä¸²ç±»å‹,è¡¨ç¤ºè¯¥è¯„è®ºæœ‰å¤šå°‘æ¡å›å¤
- ä½†**æ²¡æœ‰åŒ…å«å®é™…çš„å›å¤æ•°æ®**

### DOMç»“æ„åˆ†æ

å½“ç‚¹å‡»"æŸ¥çœ‹3æ¡å›å¤"æŒ‰é’®å:

```
è¯„è®ºé¡¹
â”œâ”€ ç”¨æˆ·ä¿¡æ¯
â”œâ”€ è¯„è®ºå†…å®¹
â”œâ”€ æ“ä½œæŒ‰é’®
â””â”€ ã€å±•å¼€çš„å›å¤åˆ—è¡¨ã€‘â¬…ï¸ æ–°å¢
    â”œâ”€ å›å¤1
    â”‚   â”œâ”€ ç”¨æˆ·: "æœ‰ç¦åŒäº«"
    â”‚   â”œâ”€ å†…å®¹: "ä¸´ç»ˆå…³æ€€"
    â”‚   â””â”€ æ—¶é—´: "10æœˆ06æ—¥ 20:30"
    â”œâ”€ å›å¤2
    â”‚   â”œâ”€ ç”¨æˆ·: "æ™¶è¹"
    â”‚   â”œâ”€ å†…å®¹: "å›å¤æœ‰ç¦åŒäº«:æ€ä¹ˆå…³æ€€?"
    â”‚   â””â”€ æ—¶é—´: "10æœˆ06æ—¥ 20:32"
    â””â”€ å›å¤3
        â”œâ”€ ç”¨æˆ·: "ç»†å“å²æœˆ1962"
        â”œâ”€ å†…å®¹: "å›å¤æ™¶è¹:ä¸æ²»ç–—,åªæ˜¯ç”¨è¯æ­¢ç—›!..."
        â””â”€ æ—¶é—´: "10æœˆ06æ—¥ 20:40"
```

### ğŸ¯ æœ€ç»ˆç»“è®º

**è®¨è®ºæ•°æ®å¯èƒ½å·²ç»åœ¨é¡µé¢é¦–æ¬¡åŠ è½½æ—¶é€šè¿‡Reactè™šæ‹ŸDOMé¢„åŠ è½½,ç‚¹å‡»"æŸ¥çœ‹å›å¤"åªæ˜¯åˆ‡æ¢æ˜¾ç¤º/éšè—çŠ¶æ€,å¹¶ä¸è§¦å‘æ–°çš„APIè¯·æ±‚!**

è¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦:
1. **ä»DOMä¸­æå–è®¨è®ºæ•°æ®**(è€Œä¸æ˜¯API)
2. **æˆ–è€…ä½¿ç”¨React FiberæŠ€æœ¯æå–è™šæ‹ŸDOMæ•°æ®**

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆA: ä»DOMæå–è®¨è®ºæ•°æ® (æ¨è)

#### ä¼˜ç‚¹
- ç®€å•ç›´æ¥
- ä¸ä¾èµ–APIæ‹¦æˆª
- æ•°æ®å·²ç»æ¸²æŸ“åœ¨é¡µé¢ä¸Š

#### æµç¨‹
```
1. ç‚¹å‡»è§†é¢‘
2. ç­‰å¾…è¯„è®ºåŠ è½½
3. æ»šåŠ¨åˆ°åº•éƒ¨(åŠ è½½æ‰€æœ‰è¯„è®º)
4. æŸ¥æ‰¾æ‰€æœ‰"æŸ¥çœ‹Xæ¡å›å¤"æŒ‰é’®
5. ä¾æ¬¡ç‚¹å‡»æ¯ä¸ªæŒ‰é’®
6. ç­‰å¾…å±•å¼€åŠ¨ç”»å®Œæˆ
7. ä»DOMæå–æ‰€æœ‰å±•å¼€çš„å›å¤æ•°æ®
8. å¤„ç†ä¸‹ä¸€ä¸ªè§†é¢‘
```

#### å®ç°ä¼ªä»£ç 

```javascript
// 1. ç‚¹å‡»è§†é¢‘
await clickVideo(videoIndex);
await page.waitForTimeout(3000);

// 2. æ»šåŠ¨åŠ è½½æ‰€æœ‰è¯„è®º
let lastHeight = 0;
while (true) {
  await scrollToBottom();
  await page.waitForTimeout(2000);

  const currentHeight = await getScrollHeight();
  if (currentHeight === lastHeight) break;
  lastHeight = currentHeight;
}

// 3. æŸ¥æ‰¾å¹¶ç‚¹å‡»æ‰€æœ‰"æŸ¥çœ‹Xæ¡å›å¤"æŒ‰é’®
const replyButtons = await page.evaluate(() => {
  const buttons = [];
  document.querySelectorAll('*').forEach(el => {
    if (/^æŸ¥çœ‹\d+æ¡å›å¤$/.test(el.textContent) && el.offsetParent) {
      buttons.push(el);
    }
  });
  return buttons.length;
});

// 4. ä¾æ¬¡ç‚¹å‡»
for (let i = 0; i < replyButtons; i++) {
  await page.evaluate((index) => {
    const buttons = Array.from(document.querySelectorAll('*'))
      .filter(el => /^æŸ¥çœ‹\d+æ¡å›å¤$/.test(el.textContent) && el.offsetParent);

    if (buttons[index]) {
      buttons[index].click();
    }
  }, i);

  await page.waitForTimeout(1500); // ç­‰å¾…å±•å¼€åŠ¨ç”»
}

// 5. æå–æ‰€æœ‰è®¨è®ºæ•°æ®
const discussions = await page.evaluate(() => {
  const results = [];

  // æŸ¥æ‰¾æ‰€æœ‰å±•å¼€çš„å›å¤å®¹å™¨
  const replyContainers = document.querySelectorAll('[åŒ…å«å›å¤çš„é€‰æ‹©å™¨]');

  replyContainers.forEach(container => {
    // æå–å›å¤æ•°æ®
    const user = container.querySelector('.user-name')?.textContent;
    const content = container.querySelector('.content')?.textContent;
    const time = container.querySelector('.time')?.textContent;

    results.push({ user, content, time });
  });

  return results;
});
```

### æ–¹æ¡ˆB: React Fiberæå– (å¤‡é€‰)

å¦‚æœè®¨è®ºæ•°æ®ç¡®å®åœ¨è™šæ‹ŸDOMä¸­,ä½¿ç”¨React FiberæŠ€æœ¯:

```javascript
const fiber = element[Object.keys(element).find(k => k.startsWith('__reactFiber$'))];
const discussions = fiber.memoizedProps.discussions;
```

## ğŸ› ï¸ å®ç°æ­¥éª¤

### Step 1: ä¿®æ”¹ crawl-comments.js

**ä¸»è¦ä¿®æ”¹ç‚¹:**

1. **æ”¹å˜è§†é¢‘å¤„ç†ç­–ç•¥**: ä»æ‰¹é‡ç‚¹å‡»æ”¹ä¸ºé€ä¸ªå¤„ç†

```javascript
// âŒ æ—§æ–¹å¼ - æ‰¹é‡ç‚¹å‡»
for (let i = 0; i < videos.length; i++) {
  await clickVideo(i);
  await page.waitForTimeout(2000);
}

// âœ… æ–°æ–¹å¼ - é€ä¸ªå®Œæ•´å¤„ç†
for (let i = 0; i < videos.length; i++) {
  await processVideo(videos[i]); // å®Œæ•´å¤„ç†å•ä¸ªè§†é¢‘
}
```

2. **æ·»åŠ æ»šåŠ¨åŠ è½½è¯„è®ºåŠŸèƒ½**

```javascript
async function loadAllComments(page) {
  let scrollAttempts = 0;
  const maxScrolls = 10;

  while (scrollAttempts < maxScrolls) {
    const scrolled = await page.evaluate(() => {
      const container = document.querySelector('[class*="comment-list"]');
      if (container) {
        const before = container.scrollTop;
        container.scrollTo(0, container.scrollHeight);
        return container.scrollTop > before;
      }
      return false;
    });

    if (!scrolled) break;

    await page.waitForTimeout(2000);
    scrollAttempts++;
  }
}
```

3. **æ·»åŠ ç‚¹å‡»æ‰€æœ‰"æŸ¥çœ‹å›å¤"æŒ‰é’®åŠŸèƒ½**

```javascript
async function clickAllReplyButtons(page) {
  const buttonCount = await page.evaluate(() => {
    return Array.from(document.querySelectorAll('*'))
      .filter(el => /^æŸ¥çœ‹\d+æ¡å›å¤$/.test(el.textContent) && el.offsetParent)
      .length;
  });

  logger.info(`Found ${buttonCount} reply buttons`);

  for (let i = 0; i < buttonCount; i++) {
    const clicked = await page.evaluate((index) => {
      const buttons = Array.from(document.querySelectorAll('*'))
        .filter(el => /^æŸ¥çœ‹\d+æ¡å›å¤$/.test(el.textContent) && el.offsetParent);

      if (buttons[index]) {
        buttons[index].click();
        return true;
      }
      return false;
    }, i);

    if (clicked) {
      logger.debug(`  Clicked button ${i + 1}/${buttonCount}`);
      await page.waitForTimeout(1500);
    }
  }

  logger.info(`All reply buttons clicked`);
}
```

4. **å®Œæ•´çš„å•è§†é¢‘å¤„ç†æµç¨‹**

```javascript
async function processVideo(page, video, apiResponses) {
  logger.info(`Processing video: ${video.title}`);

  // 1. ç‚¹å‡»è§†é¢‘
  await clickVideo(page, video.index);
  await page.waitForTimeout(3000);

  // 2. æ»šåŠ¨åŠ è½½æ‰€æœ‰è¯„è®º
  logger.info('  Loading all comments...');
  await loadAllComments(page);

  // 3. ç‚¹å‡»æ‰€æœ‰"æŸ¥çœ‹å›å¤"æŒ‰é’®
  logger.info('  Clicking all reply buttons...');
  await clickAllReplyButtons(page);

  // 4. ç­‰å¾…æ‰€æœ‰APIå“åº”
  await page.waitForTimeout(2000);

  logger.info('  Video processing complete');
}
```

### Step 2: å­—æ®µæ˜ å°„ä¿®å¤

æ ¹æ®ä¹‹å‰çš„è°ƒæŸ¥,ä¿®å¤å­—æ®µæ˜ å°„é”™è¯¯:

```javascript
// âŒ é”™è¯¯çš„å­—æ®µæ˜ å°„
platform_discussion_id: reply.reply_id || reply.comment_id,
author_name: reply.user_info?.screen_name,
author_id: reply.user_info?.user_id,
author_avatar: reply.user_info?.avatar_url,
reply_count: parseInt(reply.reply_count),

// âœ… æ­£ç¡®çš„å­—æ®µæ˜ å°„
platform_discussion_id: reply.cid,
author_name: reply.user?.nickname,
author_id: reply.user?.uid,
author_avatar: reply.user?.avatar_thumb?.url_list?.[0],
reply_count: parseInt(reply.reply_comment_total),
```

### Step 3: æµ‹è¯•éªŒè¯

åˆ›å»ºæµ‹è¯•è„šæœ¬éªŒè¯:
1. è§†é¢‘é€ä¸ªå¤„ç†
2. è¯„è®ºæ»šåŠ¨åŠ è½½
3. å›å¤æŒ‰é’®ç‚¹å‡»
4. è®¨è®ºAPIæ‹¦æˆª
5. æ•°æ®å®Œæ•´æ€§

## ğŸ“Š é¢„æœŸç»“æœ

### ä¿®æ”¹å‰
- åªèƒ½æŠ“å–ä¸€çº§è¯„è®º
- è®¨è®ºæ•°æ®ä¸¢å¤±
- `reply_count`å­—æ®µæœ‰å€¼,ä½†æ²¡æœ‰å®é™…å›å¤æ•°æ®

### ä¿®æ”¹å
- âœ… å®Œæ•´æŠ“å–ä¸€çº§è¯„è®º
- âœ… å®Œæ•´æŠ“å–æ‰€æœ‰è®¨è®º/å›å¤
- âœ… è®¨è®ºæ•°æ®åŒ…å«å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯ã€å†…å®¹ã€æ—¶é—´ç­‰
- âœ… æ”¯æŒå¤šçº§å›å¤("å›å¤XXX:")

## ğŸ¯ ä¸‹ä¸€æ­¥

1. âœ… åˆ›å»ºæ­¤æ–‡æ¡£
2. â³ ä¿®æ”¹ `crawl-comments.js` å®ç°æ–°æµç¨‹
3. â³ æµ‹è¯•éªŒè¯
4. â³ æ›´æ–°ç›¸å…³æ–‡æ¡£

---

**åˆ›å»ºæ—¶é—´**: 2025-10-24
**ä½œè€…**: Claude Code
**ç‰ˆæœ¬**: v1.0
