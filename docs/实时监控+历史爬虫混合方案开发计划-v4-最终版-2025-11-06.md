# å®æ—¶ç›‘æ§ + å†å²çˆ¬è™«æ··åˆæ–¹æ¡ˆ - å¼€å‘è®¡åˆ’ v4.0 æœ€ç»ˆç‰ˆ

**åˆ›å»ºæ—¥æœŸ**: 2025-11-06
**æ–¹æ¡ˆç‰ˆæœ¬**: v4.0 (åŸºäºç°æœ‰ MonitorTask è°ƒæ•´)
**é¢„è®¡å·¥æœŸ**: 1.5-2ä¸ªå·¥ä½œæ—¥

---

## ğŸ“‹ ç°çŠ¶åˆ†æ

### å·²æœ‰æ¶æ„

âœ… **MonitorTask** (`packages/worker/src/handlers/monitor-task.js`):
- å®šæ—¶è°ƒåº¦: 15-30ç§’éšæœºé—´éš”
- å¹¶è¡Œçˆ¬å–: è¯„è®º + ç§ä¿¡
- ç™»å½•æ£€æŸ¥: æ¯æ¬¡æ‰§è¡Œå‰éªŒè¯
- æ•°æ®å»é‡: CacheHandler
- ç»Ÿè®¡ä¸ŠæŠ¥: AccountStatusReporter

âŒ **ç¼ºå¤±åŠŸèƒ½**:
- âŒ æ²¡æœ‰å®æ—¶ç›‘æ§(é›¶å»¶è¿Ÿé’©å­)
- âŒ é—´éš”å¤ªçŸ­(15-30ç§’ â†’ éœ€è¦æ”¹ä¸º 5-10åˆ†é’Ÿ)

---

## ğŸ¯ è°ƒæ•´æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯

**ä¸æ”¹åŠ¨ MonitorTask**,åªæ–°å¢å®æ—¶ç›‘æ§å±‚:

```
å¯åŠ¨ç›‘æ§
  â†“
  â”œâ”€â”€ 1. å®æ—¶ç›‘æ§å±‚ (æ–°å¢)
  â”‚   â”œâ”€â”€ æ³¨å…¥é’©å­è„šæœ¬
  â”‚   â”œâ”€â”€ ç›‘å¬ msgListToPush (ç§ä¿¡)
  â”‚   â”œâ”€â”€ ç›‘å¬ noticePushList (è¯„è®º)
  â”‚   â””â”€â”€ å®æ—¶æ¨é€æ•°æ® (0mså»¶è¿Ÿ)
  â”‚
  â””â”€â”€ 2. å®šæ—¶çˆ¬è™«å±‚ (å·²æœ‰ MonitorTask)
      â”œâ”€â”€ ä¿®æ”¹é—´éš”é…ç½®: 15-30ç§’ â†’ 5-10åˆ†é’Ÿ
      â”œâ”€â”€ è°ƒç”¨ crawlComments()
      â”œâ”€â”€ è°ƒç”¨ crawlDirectMessages()
      â””â”€â”€ æ•°æ®å»é‡å’Œä¸ŠæŠ¥
```

---

## ğŸ”§ å¼€å‘ä»»åŠ¡

### ä»»åŠ¡ 1: ä¿®æ”¹ MonitorTask é—´éš”é…ç½® (0.5å°æ—¶)

**æ–‡ä»¶**: `packages/worker/src/handlers/monitor-task.js`

**ä¿®æ”¹å†…å®¹**:

```javascript
// ä¿®æ”¹ç¬¬ 45-47 è¡Œ
constructor(account, socketClient, platformManager, accountStatusReporter = null, browserManager = null) {
  // ... ç°æœ‰ä»£ç  ...

  // ä¿®æ”¹: å°†é—´éš”ä» 15-30ç§’ æ”¹ä¸º 5-10åˆ†é’Ÿ(å¯é…ç½®)
  // ä»è´¦æˆ·é…ç½®è¯»å–,é»˜è®¤ 5-10 åˆ†é’Ÿ
  const config = this.parseMonitorConfig(account);
  this.minInterval = config.minInterval || 5 * 60;  // é»˜è®¤ 5 åˆ†é’Ÿ
  this.maxInterval = config.maxInterval || 10 * 60; // é»˜è®¤ 10 åˆ†é’Ÿ
}

/**
 * è§£æç›‘æ§é…ç½®
 */
parseMonitorConfig(account) {
  const defaultConfig = {
    minInterval: 5 * 60,   // 5åˆ†é’Ÿ(ç§’)
    maxInterval: 10 * 60   // 10åˆ†é’Ÿ(ç§’)
  };

  if (account.monitoring_config) {
    try {
      const custom = JSON.parse(account.monitoring_config);
      return {
        minInterval: (custom.crawlIntervalMin || defaultConfig.minInterval / 60) * 60,
        maxInterval: (custom.crawlIntervalMax || defaultConfig.maxInterval / 60) * 60
      };
    } catch (error) {
      logger.warn(`è§£æç›‘æ§é…ç½®å¤±è´¥: ${account.id}`, error);
    }
  }

  return defaultConfig;
}
```

**é¢„è®¡æ—¶é—´**: 0.5å°æ—¶

---

### ä»»åŠ¡ 2: å®æ—¶ç›‘æ§æ ¸å¿ƒ (1å¤©)

#### 2.1 é’©å­è„šæœ¬ (æµè§ˆå™¨ç«¯)
**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/hooks/install-realtime-hooks.js`

**å®Œæ•´ä»£ç **:
```javascript
/**
 * æµè§ˆå™¨ç«¯å®æ—¶é’©å­æ³¨å…¥è„šæœ¬
 * é›¶å»¶è¿Ÿç›‘æ§æ–¹æ¡ˆ - åŠ«æŒ msgListToPush å’Œ noticePushList
 */
(function() {
  'use strict';

  // æå– React Store
  function extractStore(storeName) {
    const root = document.querySelector('#root') || document.querySelector('[data-reactroot]');
    if (!root) return null;

    const fiberKey = Object.keys(root).find(key =>
      key.startsWith('__reactFiber$') || key.startsWith('__reactInternalInstance$')
    );
    if (!fiberKey) return null;

    let fiber = root[fiberKey];
    while (fiber) {
      const state = fiber.memoizedState || fiber.stateNode?.state;
      if (state?.[storeName]) return state[storeName];

      const props = fiber.memoizedProps;
      if (props?.[storeName]) return props[storeName];

      fiber = fiber.return;
    }
    return null;
  }

  // åŠ«æŒæ•°ç»„æ–¹æ³•
  function hijackArray(arr, onAdd, name) {
    const originalPush = arr.push;
    arr.push = function(...items) {
      console.log(`ğŸ¯ [Hook] ${name}.push() - ${items.length} é¡¹`);
      items.forEach(item => {
        try { onAdd(item); }
        catch (e) { console.error('[Hook] å›è°ƒé”™è¯¯:', e); }
      });
      return originalPush.apply(this, items);
    };
  }

  // å¤„ç†ç§ä¿¡
  function handleMessage(msg) {
    console.log('âš¡ [å®æ—¶] æ–°ç§ä¿¡:', msg.serverId);
    if (typeof window.__sendRealtimeData === 'function') {
      window.__sendRealtimeData({ type: 'message', data: msg });
    }
  }

  // å¤„ç†è¯„è®º
  function handleComment(notice) {
    if (notice.type !== 31) return;
    console.log('âš¡ [å®æ—¶] æ–°è¯„è®º:', notice.nid_str);
    if (typeof window.__sendRealtimeData === 'function') {
      window.__sendRealtimeData({ type: 'comment', data: notice });
    }
  }

  // å®‰è£…é’©å­
  function install() {
    const imStore = extractStore('imStore');
    const noticeStore = extractStore('noticeStore');

    let count = 0;
    if (imStore?.msgListToPush) {
      hijackArray(imStore.msgListToPush, handleMessage, 'msgListToPush');
      console.log('âœ… ç§ä¿¡é’©å­å·²å®‰è£…');
      count++;
    }
    if (noticeStore?.noticePushList) {
      hijackArray(noticeStore.noticePushList, handleComment, 'noticePushList');
      console.log('âœ… è¯„è®ºé’©å­å·²å®‰è£…');
      count++;
    }

    return { success: count > 0, count };
  }

  // æ‰§è¡Œ
  const result = install();
  if (!result.success) {
    setTimeout(install, 3000);
  }

  window.__checkRealtimeHooks = () => ({ installed: true, timestamp: Date.now() });
})();
```

**é¢„è®¡æ—¶é—´**: 2å°æ—¶

---

#### 2.2 å®æ—¶ç›‘æ§ç®¡ç†å™¨
**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/realtime-monitor.js`

**å®Œæ•´ä»£ç **:
```javascript
/**
 * æŠ–éŸ³å®æ—¶ç›‘æ§ç®¡ç†å™¨
 * ä¸ MonitorTask ååŒå·¥ä½œ
 */
const path = require('path');
const { createLogger } = require('@hiscrm-im/shared/utils/logger');

class DouyinRealtimeMonitor {
  constructor(accountId, page, platform) {
    this.accountId = accountId;
    this.page = page;
    this.platform = platform;
    this.logger = createLogger(`realtime:${accountId}`);
    this.processedIds = new Set();
    this.isActive = false;
  }

  /**
   * å¯åŠ¨å®æ—¶ç›‘æ§
   */
  async start() {
    this.logger.info('å¯åŠ¨å®æ—¶ç›‘æ§');

    try {
      await this.installHooks();
      await this.exposeHandlers();
      this.setupNavigationListener();

      this.isActive = true;
      this.logger.info('âœ… å®æ—¶ç›‘æ§å·²å¯åŠ¨');
    } catch (error) {
      this.logger.error('å®æ—¶ç›‘æ§å¯åŠ¨å¤±è´¥:', error);
      throw error;
    }
  }

  /**
   * æ³¨å…¥é’©å­è„šæœ¬
   */
  async installHooks() {
    const scriptPath = path.join(__dirname, 'hooks', 'install-realtime-hooks.js');
    await this.page.addScriptTag({ path: scriptPath });
    await this.page.waitForTimeout(1000);

    const status = await this.page.evaluate(() => {
      return typeof window.__checkRealtimeHooks === 'function'
        ? window.__checkRealtimeHooks()
        : { installed: false };
    });

    this.logger.info('é’©å­çŠ¶æ€:', status);
  }

  /**
   * æš´éœ²å‡½æ•°ç»™é¡µé¢
   */
  async exposeHandlers() {
    await this.page.exposeFunction('__sendRealtimeData', async (data) => {
      await this.handleRealtimeData(data);
    });
  }

  /**
   * å¤„ç†å®æ—¶æ•°æ®
   */
  async handleRealtimeData(data) {
    const { type, data: rawData } = data;

    try {
      const id = type === 'message' ? rawData.serverId : rawData.nid_str;

      // å»é‡
      if (this.processedIds.has(id)) return;
      this.processedIds.add(id);

      // æ ¼å¼åŒ–
      let formatted;
      if (type === 'message') {
        formatted = this.formatMessage(rawData);
      } else if (type === 'comment') {
        formatted = this.formatComment(rawData);
      }

      if (!formatted) return;

      // æ¨é€åˆ° DataManager
      const dataManager = this.platform.dataManagers.get(this.accountId);
      if (dataManager) {
        if (type === 'message') {
          await dataManager.pushMessage(formatted, 'realtime');
        } else if (type === 'comment') {
          await dataManager.pushComment(formatted, 'realtime');
        }
        this.logger.info(`âœ… [å®æ—¶] ${type} å·²æ¨é€:`, id);
      }

    } catch (error) {
      this.logger.error('å¤„ç†å®æ—¶æ•°æ®å¤±è´¥:', error);
    }
  }

  /**
   * æ ¼å¼åŒ–ç§ä¿¡
   */
  formatMessage(raw) {
    try {
      const content = JSON.parse(raw.content);
      return {
        message_id: raw.serverId,
        platform_message_id: raw.serverId,
        conversation_id: raw.conversationId,
        platform_sender_id: raw.sender,
        sender_id: raw.secSender,
        type: 'text',
        content: content.text,
        text: content.text,
        direction: 'incoming',
        created_at: new Date(raw.createdAt).getTime(),
        source: 'realtime',
        rawData: raw
      };
    } catch (error) {
      this.logger.error('æ ¼å¼åŒ–ç§ä¿¡å¤±è´¥:', error);
      return null;
    }
  }

  /**
   * æ ¼å¼åŒ–è¯„è®º
   */
  formatComment(raw) {
    try {
      const comment = raw.comment?.comment;
      if (!comment) return null;

      return {
        cid: comment.cid,
        comment_id: comment.cid,
        aweme_id: raw.comment?.aweme?.aweme_id,
        user: comment.user,
        user_id: comment.user?.uid,
        text: comment.text,
        content: comment.text,
        digg_count: comment.digg_count || 0,
        create_time: raw.create_time,
        created_at: raw.create_time * 1000,
        source: 'realtime',
        rawData: raw
      };
    } catch (error) {
      this.logger.error('æ ¼å¼åŒ–è¯„è®ºå¤±è´¥:', error);
      return null;
    }
  }

  /**
   * ç›‘å¬é¡µé¢å¯¼èˆª
   */
  setupNavigationListener() {
    this.page.on('framenavigated', async () => {
      this.logger.info('é¡µé¢å¯¼èˆª,é‡æ–°æ³¨å…¥é’©å­');
      setTimeout(() => this.installHooks(), 2000);
    });
  }

  /**
   * åœæ­¢ç›‘æ§
   */
  async stop() {
    this.isActive = false;
    this.logger.info('å®æ—¶ç›‘æ§å·²åœæ­¢');
  }
}

module.exports = { DouyinRealtimeMonitor };
```

**é¢„è®¡æ—¶é—´**: 4å°æ—¶

---

### ä»»åŠ¡ 3: é›†æˆåˆ° platform.js (0.5å¤©)

**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/platform.js`

**åœ¨æ–‡ä»¶å¤´éƒ¨æ·»åŠ **:
```javascript
const { DouyinRealtimeMonitor } = require('./realtime-monitor');
```

**åœ¨ constructor ä¸­æ·»åŠ **:
```javascript
constructor(config, workerBridge, browserManager) {
  super(config, workerBridge, browserManager);
  this.loginHandler = new DouyinLoginHandler(browserManager, workerBridge.socket);

  // æ–°å¢: å­˜å‚¨å®æ—¶ç›‘æ§å®ä¾‹
  this.realtimeMonitors = new Map(); // accountId -> RealtimeMonitor
}
```

**æ–°å¢æ–¹æ³•**:
```javascript
/**
 * å¯åŠ¨å®æ—¶ç›‘æ§
 * ä¸ MonitorTask ååŒå·¥ä½œ
 * @param {string} accountId - è´¦æˆ·ID
 */
async startRealtimeMonitor(accountId) {
  logger.info(`å¯åŠ¨å®æ—¶ç›‘æ§: ${accountId}`);

  try {
    // è·å–é¡µé¢ (ä½¿ç”¨é€šç”¨é¡µé¢,ä¸å½±å“ MonitorTask çš„ä¸“ç”¨é¡µé¢)
    const { page } = await this.getPageWithAPI(accountId, {
      tag: TabTag.SPIDER_GENERAL,
      persistent: true,
      shareable: false,
      forceNew: false
    });

    // åˆ›å»ºå¹¶å¯åŠ¨å®æ—¶ç›‘æ§
    const monitor = new DouyinRealtimeMonitor(accountId, page, this);
    await monitor.start();

    this.realtimeMonitors.set(accountId, monitor);
    logger.info(`âœ… å®æ—¶ç›‘æ§å·²å¯åŠ¨: ${accountId}`);

  } catch (error) {
    logger.error(`å®æ—¶ç›‘æ§å¯åŠ¨å¤±è´¥: ${accountId}`, error);
    throw error;
  }
}

/**
 * åœæ­¢å®æ—¶ç›‘æ§
 * @param {string} accountId - è´¦æˆ·ID
 */
async stopRealtimeMonitor(accountId) {
  const monitor = this.realtimeMonitors.get(accountId);
  if (monitor) {
    await monitor.stop();
    this.realtimeMonitors.delete(accountId);
    logger.info(`å®æ—¶ç›‘æ§å·²åœæ­¢: ${accountId}`);
  }
}

/**
 * è·å–å®æ—¶ç›‘æ§çŠ¶æ€
 * @param {string} accountId - è´¦æˆ·ID
 * @returns {Object} çŠ¶æ€å¯¹è±¡
 */
getRealtimeMonitorStatus(accountId) {
  const monitor = this.realtimeMonitors.get(accountId);
  return {
    enabled: !!monitor,
    active: monitor?.isActive || false
  };
}
```

**é¢„è®¡æ—¶é—´**: 3å°æ—¶

---

## ğŸ“Š ä½¿ç”¨æ–¹å¼

### 1. ä¿®æ”¹è´¦æˆ·é…ç½®

åœ¨ `accounts` è¡¨çš„ `monitoring_config` å­—æ®µä¸­:

```json
{
  "enableRealtimeMonitor": true,
  "crawlIntervalMin": 5,
  "crawlIntervalMax": 10
}
```

### 2. å¯åŠ¨ç›‘æ§

åœ¨ Worker åˆå§‹åŒ–æ—¶:

```javascript
// 1. å¯åŠ¨ MonitorTask (å·²æœ‰,è‡ªåŠ¨å¯åŠ¨)
const monitorTask = new MonitorTask(account, socket, platformManager, statusReporter, browserManager);
await monitorTask.start();

// 2. å¯åŠ¨å®æ—¶ç›‘æ§ (æ–°å¢)
const config = JSON.parse(account.monitoring_config || '{}');
if (config.enableRealtimeMonitor !== false) {
  await douyinPlatform.startRealtimeMonitor(account.id);
}
```

### 3. æ•°æ®æµ

```
å®æ—¶ç›‘æ§æµ (0mså»¶è¿Ÿ):
WebSocketæ¨é€ â†’ msgListToPush.push()
             â†’ é’©å­è§¦å‘
             â†’ DouyinRealtimeMonitor.handleRealtimeData()
             â†’ DataManager.pushMessage()
             â†’ Master Server

å®šæ—¶çˆ¬è™«æµ (5-10åˆ†é’Ÿ):
setTimeout â†’ MonitorTask.execute()
          â†’ crawlComments() + crawlDirectMessages()
          â†’ DataManager (è‡ªåŠ¨å»é‡)
          â†’ Master Server
```

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

| åœºæ™¯ | æ“ä½œ | é¢„æœŸç»“æœ |
|-----|------|---------|
| å®æ—¶ç§ä¿¡ | å‘é€ç§ä¿¡ | ç«‹å³æ•è·,source=realtime |
| å®æ—¶è¯„è®º | å‘é€è¯„è®º | ç«‹å³æ•è·,source=realtime |
| å®šæ—¶çˆ¬è™« | ç­‰å¾…5-10åˆ†é’Ÿ | è‡ªåŠ¨æ‰§è¡Œ,source=crawl |
| æ•°æ®å»é‡ | åŒä¸€æ¶ˆæ¯ | ä¸é‡å¤å­˜å‚¨ |
| é¡µé¢åˆ·æ–° | åˆ·æ–°é¡µé¢ | é’©å­è‡ªåŠ¨é‡æ–°æ³¨å…¥ |
| MonitorTask | æ£€æŸ¥é—´éš” | 5-10åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ |

---

## ğŸ“… å¼€å‘æ—¶é—´çº¿

| ä»»åŠ¡ | å·¥ä½œé‡ |
|-----|--------|
| ä»»åŠ¡1: ä¿®æ”¹ MonitorTask é—´éš” | 0.5å°æ—¶ |
| ä»»åŠ¡2: å®æ—¶ç›‘æ§æ ¸å¿ƒ | 6å°æ—¶ |
| ä»»åŠ¡3: é›†æˆåˆ° platform.js | 3å°æ—¶ |
| æµ‹è¯•å’Œè°ƒè¯• | 3å°æ—¶ |

**æ€»è®¡**: 1.5-2ä¸ªå·¥ä½œæ—¥

---

## âœ… ä¼˜åŠ¿

1. **æœ€å°æ”¹åŠ¨**: åªä¿®æ”¹ MonitorTask çš„é—´éš”é…ç½®
2. **ç‹¬ç«‹æ¨¡å—**: å®æ—¶ç›‘æ§ä½œä¸ºç‹¬ç«‹æ¨¡å—,ä¸å½±å“ç°æœ‰é€»è¾‘
3. **å®Œç¾å…¼å®¹**: ä¸ç°æœ‰ MonitorTask ååŒå·¥ä½œ
4. **çµæ´»é…ç½®**: å¯å•ç‹¬å¯ç”¨/ç¦ç”¨å®æ—¶ç›‘æ§
5. **æ•°æ®å»é‡**: CacheHandler è‡ªåŠ¨å»é‡,æ— éœ€æ‹…å¿ƒé‡å¤

---

## ğŸ“ é…ç½®è¯´æ˜

### è´¦æˆ·é…ç½® (monitoring_config å­—æ®µ)

```json
{
  "enableRealtimeMonitor": true,  // æ˜¯å¦å¯ç”¨å®æ—¶ç›‘æ§
  "crawlIntervalMin": 5,          // æœ€å°çˆ¬è™«é—´éš”(åˆ†é’Ÿ)
  "crawlIntervalMax": 10          // æœ€å¤§çˆ¬è™«é—´éš”(åˆ†é’Ÿ)
}
```

### é»˜è®¤é…ç½®

å¦‚æœæ²¡æœ‰é…ç½®,é»˜è®¤å€¼:
- `enableRealtimeMonitor`: `true` (å¯ç”¨)
- `crawlIntervalMin`: `5` åˆ†é’Ÿ
- `crawlIntervalMax`: `10` åˆ†é’Ÿ

---

**æ–‡æ¡£çŠ¶æ€**: âœ… æœ€ç»ˆç‰ˆ
**å¼€å‘çŠ¶æ€**: â³ å¾…å¼€å§‹
**ä¼˜å…ˆçº§**: ğŸ”¥ é«˜

