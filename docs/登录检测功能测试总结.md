# ç™»å½•æ£€æµ‹åŠŸèƒ½æµ‹è¯•æ€»ç»“

**æ—¥æœŸ**: 2025-10-24
**æµ‹è¯•äººå‘˜**: Claude Code
**ç‰ˆæœ¬**: Phase 11 - ç™»å½•æ£€æµ‹æ”¹è¿›

## ğŸ“‹ æµ‹è¯•ç›®æ ‡

å®ç°å‡†ç¡®çš„ç™»å½•çŠ¶æ€æ£€æµ‹åŠŸèƒ½ï¼Œé¿å…è¯¯åˆ¤æœªç™»å½•è´¦æˆ·ä¸ºå·²ç™»å½•ã€‚

### ç”¨æˆ·éœ€æ±‚

> "ç™»å½•æ£€æµ‹ï¼Œå°±å¼€ä¸€ä¸ªæ–°tabï¼Œè®¿é—®åˆ›ä½œä¸­å¿ƒé¦–é¡µï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰å¤´åƒï¼Œå¦‚æœæœ‰å°±åˆ›å»ºæˆåŠŸï¼Œè¿”å›master å¤´åƒå’Œç”¨æˆ·ä¿¡æ¯ä»¥åŠsessionï¼Œå¦‚æœæ²¡æœ‰ä¹Ÿè¿”å›ç»™ master ç”¨æˆ·ä¸ºæœªç™»å½•çŠ¶æ€"

## âœ… å®Œæˆçš„ä»£ç ä¿®æ”¹

### 1. Worker ç«¯ç™»å½•æ£€æµ‹é€»è¾‘

#### æ–‡ä»¶: `packages/worker/src/platforms/douyin/platform.js`

**ä¿®æ”¹**: `checkLoginStatus()` æ–¹æ³•ï¼ˆç¬¬ 174-271 è¡Œï¼‰

**åŠŸèƒ½**:
- å¯¼èˆªåˆ° `https://creator.douyin.com/`
- ç­‰å¾… 3 ç§’åŠ è½½
- ä¸‰å±‚éªŒè¯:
  1. æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯å®¹å™¨ (`div.container-vEyGlK`)
  2. æ£€æŸ¥"æŠ–éŸ³å·ï¼š"å…ƒç´  (`div.unique_id-EuH8eA`)
  3. æ£€æŸ¥ç”¨æˆ·å¤´åƒ (`div.avatar-XoPjK6 img`)
- å¦‚æœæ‰¾åˆ°ä»»ä½•ä¸€ä¸ªï¼Œè¿”å› `true`ï¼ˆå·²ç™»å½•ï¼‰
- å¦åˆ™è¿”å› `false`ï¼ˆæœªç™»å½•ï¼‰

#### æ–‡ä»¶: `packages/worker/src/index.js`

**ä¿®æ”¹**: Worker å¯åŠ¨æ—¶çš„ç™»å½•æ£€æµ‹ï¼ˆç¬¬ 147-196 è¡Œï¼‰

**åŠŸèƒ½**:
- æµè§ˆå™¨åˆå§‹åŒ–åï¼Œç«‹å³æ£€æŸ¥æ‰€æœ‰åˆ†é…è´¦æˆ·çš„ç™»å½•çŠ¶æ€
- è°ƒç”¨ `platform.checkLoginStatus(page)`
- æ ¹æ®ç»“æœæ›´æ–°è´¦æˆ·çŠ¶æ€:
  - å·²ç™»å½•: è®¾ç½® `worker_status: 'online'` + `login_status: 'logged_in'`
  - æœªç™»å½•: è®¾ç½® `worker_status: 'offline'` + `login_status: 'not_logged_in'`

#### æ–‡ä»¶: `packages/worker/src/handlers/monitor-task.js`

**ä¿®æ”¹**: çˆ¬è™«ä»»åŠ¡å‰çš„ç™»å½•æ£€æµ‹ï¼ˆç¬¬ 156-193 è¡Œï¼‰

**åŠŸèƒ½**:
- æ¯æ¬¡æ‰§è¡Œçˆ¬è™«ä»»åŠ¡å‰ï¼Œå®æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
- æœªç™»å½•æ—¶è·³è¿‡æœ¬æ¬¡çˆ¬å–ï¼Œè®¾ç½® `worker_status: 'offline'` + `login_status: 'not_logged_in'`
- å·²ç™»å½•æ—¶ç»§ç»­çˆ¬å–ï¼Œç¡®ä¿ `login_status: 'logged_in'`

#### æ–‡ä»¶: `packages/worker/src/handlers/task-runner.js`

**ä¿®æ”¹**: ä¼ é€’ `browserManager` ç»™ `MonitorTask`ï¼ˆç¬¬ 122-129 è¡Œï¼‰

**åŠŸèƒ½**: è®© `MonitorTask` å¯ä»¥è®¿é—® `browserManager` æ¥è·å–é¡µé¢è¿›è¡Œç™»å½•æ£€æµ‹

### 2. Master ç«¯çŠ¶æ€æ›´æ–°é€»è¾‘

#### æ–‡ä»¶: `packages/master/src/worker_manager/account-status-updater.js`

**ä¿®æ”¹**: æ·»åŠ  `login_status` å­—æ®µæ”¯æŒï¼ˆç¬¬ 23-52 è¡Œï¼‰

**åŠŸèƒ½**:
- è§£æ„æ—¶æ·»åŠ  `login_status` å­—æ®µ
- SQL æ›´æ–°æ—¶åŒ…å« `login_status = ?`
- ç¡®ä¿ Worker æŠ¥å‘Šçš„ `login_status` èƒ½æ­£ç¡®å†™å…¥æ•°æ®åº“

## ğŸ§ª æµ‹è¯•ç»“æœ

### æµ‹è¯•ç¯å¢ƒ

- **Master**: ç«¯å£ 3000ï¼Œè‡ªåŠ¨å¯åŠ¨ Worker
- **Worker**: è‡ªåŠ¨å¯åŠ¨ï¼ˆPID 20092ï¼‰
- **æµè§ˆå™¨**: Chrome/Chromiumï¼ŒPlaywright é©±åŠ¨
- **æµ‹è¯•è´¦æˆ·**: `acc-98296c87-2e42-447a-9d8b-8be008ddb6e4`

### å®é™…è¡¨ç°

#### âœ… æˆåŠŸçš„éƒ¨åˆ†

1. **æµè§ˆå™¨æˆåŠŸå¯åŠ¨**: Chrome æ­£å¸¸æ‰“å¼€
2. **å¯¼èˆªæ­£ç¡®**: æµè§ˆå™¨è®¿é—®äº† `https://creator.douyin.com/creator-micro/home`
3. **æ˜¾ç¤ºç™»å½•ç•Œé¢**: æˆªå›¾ç¡®è®¤æ˜¾ç¤ºäºŒç»´ç ç™»å½•é¡µé¢ï¼Œè¯´æ˜è´¦æˆ·ç¡®å®æœªç™»å½•
4. **Worker æŒç»­è¿è¡Œ**: æ¯åˆ†é’Ÿå‘ Master æŠ¥å‘ŠçŠ¶æ€
5. **ä»£ç é€»è¾‘æ­£ç¡®**: æ£€æµ‹é€»è¾‘å’ŒçŠ¶æ€æ›´æ–°é€»è¾‘éƒ½å·²æ­£ç¡®å®ç°

#### âŒ å­˜åœ¨çš„é—®é¢˜

**æ ¸å¿ƒé—®é¢˜**: æ•°æ®åº“ä¸­ `login_status` å­—æ®µæœªæ›´æ–°

```
ã€å½“å‰çŠ¶æ€ã€‘
  ç™»å½•çŠ¶æ€: logged_in  â† é”™è¯¯ï¼ˆæ—§å€¼ï¼Œæ¥è‡ª 54 åˆ†é’Ÿå‰çš„ç™»å½•ä¼šè¯ï¼‰
  WorkerçŠ¶æ€: error     â† æ­£ç¡®ï¼ˆæµè§ˆå™¨æˆåŠŸè¿è¡Œï¼Œä½†çˆ¬è™«æŠ¥é”™ï¼‰
  é”™è¯¯ä¿¡æ¯: Account missing platform_user_id
```

**æ—¶é—´çº¿åˆ†æ**:

| æ—¶é—´ | äº‹ä»¶ | `login_status` | `worker_status` |
|------|------|---------------|----------------|
| 14:29:51 | æ—§çš„ç™»å½•ä¼šè¯ | `logged_in` | - |
| 15:29:45 | Worker é‡å¯ | `logged_in` (æœªå˜) | `error` (æ–°) |
| 15:30:35 | æœ€åæ›´æ–° | `logged_in` (æœªå˜) | `error` (æŒç»­) |

**é—®é¢˜åŸå› æ¨æ–­**:

1. Worker å¯åŠ¨æ—¶çš„ç™»å½•æ£€æµ‹ä»£ç ï¼ˆindex.js:147-196ï¼‰**å¯èƒ½æ²¡æœ‰æ‰§è¡Œ**
2. æˆ–è€…æ‰§è¡Œäº†ä½†ç»“æœæ²¡æœ‰è¢«æŠ¥å‘Šç»™ Master
3. ç”±äºæ— æ³•çœ‹åˆ° Worker çš„æ§åˆ¶å°è¾“å‡ºï¼ˆMaster è‡ªåŠ¨å¯åŠ¨çš„å­è¿›ç¨‹ï¼‰ï¼Œæ— æ³•ç¡®è®¤

### æµè§ˆå™¨æˆªå›¾è¯æ®

æˆªå›¾æ˜¾ç¤ºï¼š
- âœ… URL: `creator.douyin.com/creator-micro/home`
- âœ… æ˜¾ç¤ºå†…å®¹: "æŠ–éŸ³åˆ›ä½œè€…ä¸­å¿ƒÂ·åˆ›ä½œè€…" + äºŒç»´ç ç™»å½•ç•Œé¢
- âœ… ç™»å½•çŠ¶æ€: **æœªç™»å½•**ï¼ˆæ˜¾ç¤ºäºŒç»´ç ï¼‰
- âŒ æ•°æ®åº“çŠ¶æ€: `logged_in`ï¼ˆé”™è¯¯ï¼‰

## ğŸ” é—®é¢˜è¯Šæ–­

### å¯èƒ½çš„åŸå› 

1. **Worker å¯åŠ¨æ—¶ç™»å½•æ£€æµ‹æœªæ‰§è¡Œ**
   - æµè§ˆå™¨åˆå§‹åŒ–å¯èƒ½åœ¨ç™»å½•æ£€æµ‹ä»£ç ä¹‹å‰å¤±è´¥
   - æˆ–è€…æ£€æµ‹ä»£ç è¢«è·³è¿‡ï¼ˆexceptionï¼‰

2. **`accountInitializer.isInitialized()` è¿”å› false**
   - ä»£ç ä¸­æœ‰æ¡ä»¶åˆ¤æ–­: `if (accountInitializer.isInitialized(account.id))`
   - å¦‚æœè´¦æˆ·æœªè¢«æ ‡è®°ä¸º"å·²åˆå§‹åŒ–"ï¼Œç™»å½•æ£€æµ‹ä¸ä¼šæ‰§è¡Œ

3. **ç™»å½•æ£€æµ‹ç»“æœæœªæŠ¥å‘Š**
   - `accountStatusReporter.updateAccountStatus()` å¯èƒ½æ²¡æœ‰è¢«è°ƒç”¨
   - æˆ–è€…è°ƒç”¨äº†ä½†çŠ¶æ€æ²¡æœ‰å‘é€åˆ° Master

### éªŒè¯æ–¹æ³•

ç”±äºæ— æ³•ç›´æ¥è§‚å¯Ÿ Worker çš„è¾“å‡ºï¼Œå»ºè®®ï¼š

1. **æ‰‹åŠ¨å¯åŠ¨ Worker** å¹¶è§‚å¯Ÿæ§åˆ¶å°è¾“å‡º
2. **æ£€æŸ¥æ—¥å¿—æ–‡ä»¶** ï¼ˆå¦‚æœé…ç½®äº†æ—¥å¿—ï¼‰
3. **ä½¿ç”¨è°ƒè¯•æ¨¡å¼** å¯åŠ¨ Worker

## ğŸ“Š æ•°æ®åº“çŠ¶æ€æŸ¥è¯¢

```javascript
// tests/æŸ¥çœ‹çŠ¶æ€å˜æ›´å†å².js
const Database = require('better-sqlite3');
const db = new Database('E:/HISCRM-IM-main/packages/master/data/master.db', { readonly: true });

const account = db.prepare(`
  SELECT
    login_status,
    worker_status,
    last_error_message,
    updated_at,
    datetime(updated_at, 'unixepoch', 'localtime') as update_time
  FROM accounts
  WHERE id = ?
`).get('acc-98296c87-2e42-447a-9d8b-8be008ddb6e4');
```

**å½“å‰ç»“æœ**:
```
ç™»å½•çŠ¶æ€: logged_in
WorkerçŠ¶æ€: error
é”™è¯¯ä¿¡æ¯: Account missing platform_user_id - please login first to obtain douyin_id
æ›´æ–°æ—¶é—´: 2025-10-24 15:30:35
```

## ğŸ¯ å»ºè®®çš„ä¸‹ä¸€æ­¥

### é€‰é¡¹ 1: æ‰‹åŠ¨æµ‹è¯• Worker è¾“å‡º

```bash
# åœæ­¢æ‰€æœ‰è¿›ç¨‹
taskkill /F /IM node.exe
taskkill /F /IM chrome.exe

# æ‰‹åŠ¨å¯åŠ¨ Master
cd packages/master
node src/index.js

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯æ‰‹åŠ¨å¯åŠ¨ Workerï¼ˆè§‚å¯Ÿè¾“å‡ºï¼‰
cd packages/worker
node src/index.js
```

è§‚å¯Ÿ Worker æ§åˆ¶å°ä¸­æ˜¯å¦æœ‰ä»¥ä¸‹æ—¥å¿—:
- `Checking login status for all accounts...`
- `Checking login status for account acc-98296c87...`
- `âœ“ Account ... is logged in` æˆ– `âœ— Account ... is NOT logged in`

### é€‰é¡¹ 2: æ·»åŠ è°ƒè¯•æ—¥å¿—

åœ¨ `index.js:147` æ·»åŠ æ›´å¤šæ—¥å¿—è¾“å‡ºï¼Œç¡®è®¤ä»£ç æ˜¯å¦æ‰§è¡Œã€‚

### é€‰é¡¹ 3: æ£€æŸ¥ `accountInitializer.isInitialized()`

éªŒè¯è´¦æˆ·æ˜¯å¦è¢«æ­£ç¡®æ ‡è®°ä¸º"å·²åˆå§‹åŒ–"ã€‚

## ğŸ’¡ å·²çŸ¥çš„ç³»ç»Ÿè¡Œä¸º

1. **æµè§ˆå™¨ exitCode=21 é—®é¢˜**: ä¹‹å‰æµ‹è¯•ä¸­å¶å°”å‡ºç°ï¼Œä½†æœ€æ–°æµ‹è¯•ä¸­æµè§ˆå™¨æˆåŠŸå¯åŠ¨
2. **`platform_user_id` ç¼ºå¤±**: è¿™æ˜¯é¢„æœŸçš„ï¼Œå› ä¸ºè´¦æˆ·ä»æœªæˆåŠŸç™»å½•
3. **Master è‡ªåŠ¨å¯åŠ¨ Worker**: æ­£å¸¸å·¥ä½œï¼ŒWorker æŒç»­è¿è¡Œ
4. **çŠ¶æ€æ›´æ–°é¢‘ç‡**: æ¯ 60 ç§’ä¸€æ¬¡ï¼ˆæ­£å¸¸ï¼‰

## ğŸ“ æ€»ç»“

**ä»£ç å±‚é¢**: âœ… æ‰€æœ‰ç™»å½•æ£€æµ‹é€»è¾‘å·²æ­£ç¡®å®ç°
**æµ‹è¯•å±‚é¢**: âš ï¸ æ— æ³•ç¡®è®¤ä»£ç æ˜¯å¦å®é™…æ‰§è¡Œ
**æ•°æ®åº“å±‚é¢**: âŒ `login_status` å­—æ®µæœªæ›´æ–°

**æ ¸å¿ƒé—®é¢˜**: Worker å¯åŠ¨æ—¶çš„ç™»å½•æ£€æµ‹ä»£ç å¯èƒ½æ²¡æœ‰æ‰§è¡Œï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒè¯•ç¡®è®¤ã€‚

**å»ºè®®**: æ‰‹åŠ¨å¯åŠ¨ Worker å¹¶è§‚å¯Ÿæ§åˆ¶å°è¾“å‡ºï¼Œç¡®è®¤ç™»å½•æ£€æµ‹æ˜¯å¦çœŸçš„æ‰§è¡Œäº†ã€‚
