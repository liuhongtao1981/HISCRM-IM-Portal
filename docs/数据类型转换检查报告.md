# æ•°æ®ç±»å‹è½¬æ¢æ£€æŸ¥æŠ¥å‘Š

## ğŸ“‹ æ£€æŸ¥æ¦‚è¿°

**æ£€æŸ¥æ—¥æœŸï¼š** 2025-10-31
**æ£€æŸ¥äººå‘˜ï¼š** Claude Code
**æ£€æŸ¥ç›®çš„ï¼š** éªŒè¯ Worker â†’ Master â†’ PC IM æ•°æ®ç±»å‹è½¬æ¢æ˜¯å¦æ­£ç¡®

## âš ï¸ å‘ç°ä¸¥é‡é—®é¢˜ï¼

**æ ¸å¿ƒé—®é¢˜ï¼šWorker æ¨é€çš„æ•°æ®æ ¼å¼ï¼ˆcamelCaseï¼‰ä¸ IMWebSocketServer æœŸæœ›çš„æ ¼å¼ï¼ˆsnake_caseï¼‰ä¸åŒ¹é…ï¼**

## ğŸ” è¯¦ç»†åˆ†æ

### 1. Worker ç«¯æ•°æ®æ ¼å¼ï¼ˆcamelCaseï¼‰

**æ–‡ä»¶ï¼š** `packages/worker/src/platforms/base/account-data-manager.js`

Worker ä½¿ç”¨ Data Models ç±»ï¼Œæ‰€æœ‰å­—æ®µéƒ½æ˜¯ **camelCase**ï¼š

```javascript
// Conversation æ¨¡å‹
{
  id,
  conversationId,        // â† camelCase
  userId,
  userName,
  userAvatar,
  unreadCount,
  lastMessageContent,
  lastMessageTime,
  createdAt,
  updatedAt
}

// Message æ¨¡å‹
{
  id,
  messageId,             // â† camelCase
  conversationId,        // â† camelCase
  senderId,
  senderName,
  content,
  createdAt
}

// Content æ¨¡å‹
{
  id,
  contentId,             // â† camelCase
  type,
  title,
  description,
  viewCount,
  likeCount,
  commentCount,
  publishTime
}

// Comment æ¨¡å‹
{
  id,
  commentId,             // â† camelCase
  contentId,             // â† camelCase
  userId,
  userName,
  content,
  likeCount,
  replyCount,
  createdAt
}
```

### 2. DataStore å­˜å‚¨æ ¼å¼

**æ–‡ä»¶ï¼š** `packages/master/src/data/data-store.js`

DataStore ç›´æ¥å­˜å‚¨ Worker æ¨é€çš„æ•°æ®ï¼ˆä¿æŒ camelCaseï¼‰ï¼š

```javascript
// updateAccountData() æ–¹æ³•
if (data.comments && Array.isArray(data.comments)) {
  accountData.data.comments.clear();
  data.comments.forEach((comment) => {
    accountData.data.comments.set(comment.id, comment);  // â† ç›´æ¥å­˜å‚¨ï¼Œä¿æŒåŸæœ‰å­—æ®µ
  });
}

// åŒæ ·å¤„ç† contents, conversations, messages
```

**ç»“æœï¼š** DataStore ä¸­çš„æ•°æ®ä¹Ÿæ˜¯ **camelCase** æ ¼å¼ã€‚

### 3. IMWebSocketServer æœŸæœ›æ ¼å¼ï¼ˆsnake_caseï¼‰

**æ–‡ä»¶ï¼š** `packages/master/src/communication/im-websocket-server.js`

**âŒ é—®é¢˜ä»£ç ï¼ˆç¬¬ 288 è¡Œï¼‰ï¼š**

```javascript
// ä»ä½œå“åˆ›å»ºä¸»é¢˜
const contentComments = commentsList.filter(c => c.work_id === content.work_id);
//                                              ^^^^^^^^^       ^^^^^^^^^
//                                              æœŸæœ› snake_caseï¼Œä½†å®é™…æ˜¯ camelCase!

const topic = {
  id: content.work_id,              // âŒ æœŸæœ› work_idï¼Œå®é™…æ˜¯ contentId
  title: content.title,
  publishTime: content.publish_time // âŒ æœŸæœ› publish_timeï¼Œå®é™…æ˜¯ publishTime
};
```

**âŒ é—®é¢˜ä»£ç ï¼ˆç¬¬ 318 è¡Œï¼‰ï¼š**

```javascript
// ä»ä¼šè¯åˆ›å»ºä¸»é¢˜
const conversationMessages = messagesList.filter(m => m.conversation_id === conversation.conversation_id);
//                                                      ^^^^^^^^^^^^^^^^      ^^^^^^^^^^^^^^^^
//                                                      æœŸæœ› snake_caseï¼Œä½†å®é™…æ˜¯ camelCase!

const topic = {
  id: conversation.conversation_id,           // âŒ æœŸæœ› conversation_idï¼Œå®é™…æ˜¯ conversationId
  title: conversation.participant?.user_name, // âŒ æœŸæœ› user_nameï¼Œå®é™…æ˜¯ userName
  createdTime: conversation.create_time,      // âŒ æœŸæœ› create_timeï¼Œå®é™…æ˜¯ createdAt
  lastMessageTime: conversation.update_time   // âŒ æœŸæœ› update_timeï¼Œå®é™…æ˜¯ updatedAt
};
```

## ğŸ“Š å­—æ®µåç§°å¯¹ç…§è¡¨

### Conversation (ä¼šè¯)

| IMWebSocketServer æœŸæœ› | Worker å®é™…æ¨é€ | çŠ¶æ€ |
|----------------------|---------------|------|
| `conversation_id` | `conversationId` | âŒ ä¸åŒ¹é… |
| `user_id` | `userId` | âŒ ä¸åŒ¹é… |
| `user_name` | `userName` | âŒ ä¸åŒ¹é… |
| `user_avatar` | `userAvatar` | âŒ ä¸åŒ¹é… |
| `unread_count` | `unreadCount` | âŒ ä¸åŒ¹é… |
| `create_time` | `createdAt` | âŒ ä¸åŒ¹é… |
| `update_time` | `updatedAt` | âŒ ä¸åŒ¹é… |

### Message (ç§ä¿¡)

| IMWebSocketServer æœŸæœ› | Worker å®é™…æ¨é€ | çŠ¶æ€ |
|----------------------|---------------|------|
| `msg_id` | `messageId` | âŒ ä¸åŒ¹é… |
| `conversation_id` | `conversationId` | âŒ ä¸åŒ¹é… |
| `sender.user_id` | `senderId` | âŒ ä¸åŒ¹é… |
| `sender.user_name` | `senderName` | âŒ ä¸åŒ¹é… |
| `create_time` | `createdAt` | âŒ ä¸åŒ¹é… |

### Content (ä½œå“)

| IMWebSocketServer æœŸæœ› | Worker å®é™…æ¨é€ | çŠ¶æ€ |
|----------------------|---------------|------|
| `work_id` | `contentId` | âŒ ä¸åŒ¹é… |
| `publish_time` | `publishTime` | âŒ ä¸åŒ¹é… |
| `last_crawl_time` | âŒ æ²¡æœ‰æ­¤å­—æ®µ | âŒ ç¼ºå¤± |
| `view_count` | `viewCount` | âŒ ä¸åŒ¹é… |
| `like_count` | `likeCount` | âŒ ä¸åŒ¹é… |
| `comment_count` | `commentCount` | âŒ ä¸åŒ¹é… |

### Comment (è¯„è®º)

| IMWebSocketServer æœŸæœ› | Worker å®é™…æ¨é€ | çŠ¶æ€ |
|----------------------|---------------|------|
| `platform_comment_id` | `commentId` | âŒ ä¸åŒ¹é… |
| `work_id` | `contentId` | âŒ ä¸åŒ¹é… |
| `author_id` | `userId` | âŒ ä¸åŒ¹é… |
| `author_name` | `userName` | âŒ ä¸åŒ¹é… |
| `create_time` | `createdAt` | âŒ ä¸åŒ¹é… |
| `is_new` | âŒ æ²¡æœ‰æ­¤å­—æ®µ | âŒ ç¼ºå¤± |
| `parent_comment_id` | `parentCommentId` | âŒ ä¸åŒ¹é… |

## ğŸ¯ å½±å“åˆ†æ

### ä¸¥é‡æ€§ï¼šğŸ”´ é«˜

### å½±å“èŒƒå›´ï¼š

1. **getTopicsFromDataStore()** - âŒ æ— æ³•æ­£ç¡®è¿‡æ»¤ä½œå“å’Œä¼šè¯
   ```javascript
   // ç¬¬ 288 è¡Œ
   const contentComments = commentsList.filter(c => c.work_id === content.work_id);
   // âŒ æ°¸è¿œè¿”å› []ï¼Œå› ä¸º work_id ä¸å­˜åœ¨ï¼Œå®é™…åº”è¯¥æ˜¯ contentId
   ```

2. **getMessagesFromDataStore()** - âŒ æ— æ³•æ­£ç¡®è¿‡æ»¤æ¶ˆæ¯
   ```javascript
   // ç¬¬ 361 è¡Œ
   const comments = commentsList.filter(c => c.work_id === topicId);
   // âŒ æ°¸è¿œè¿”å› []ï¼Œå› ä¸º work_id ä¸å­˜åœ¨

   // ç¬¬ 382 è¡Œ
   const msgs = messagesList.filter(m => m.conversation_id === topicId);
   // âŒ æ°¸è¿œè¿”å› []ï¼Œå› ä¸º conversation_id ä¸å­˜åœ¨ï¼Œå®é™…æ˜¯ conversationId
   ```

3. **PC IM æ˜¾ç¤º** - âŒ æ‰€æœ‰æ•°æ®éƒ½æ˜¾ç¤ºä¸ºç©º
   - ä¸»é¢˜åˆ—è¡¨ï¼šç©ºï¼ˆæ— æ³•å…³è”è¯„è®ºæ•°ï¼‰
   - æ¶ˆæ¯åˆ—è¡¨ï¼šç©ºï¼ˆæ— æ³•è¿‡æ»¤æ¶ˆæ¯ï¼‰

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šä¿®æ”¹ IMWebSocketServer ä½¿ç”¨ camelCaseï¼ˆæ¨èï¼‰âœ…

**ä¼˜åŠ¿ï¼š**
- Worker ç«¯æ— éœ€ä¿®æ”¹
- Data Models ä¿æŒæ ‡å‡† JavaScript å‘½åè§„èŒƒ
- ä¿®æ”¹é‡æœ€å°

**ä¿®æ”¹æ–‡ä»¶ï¼š** `packages/master/src/communication/im-websocket-server.js`

**ä¿®æ”¹å†…å®¹ï¼š**

```javascript
// ç¬¬ 286-300 è¡Œï¼šä¿®æ”¹ getTopicsFromDataStore()
for (const content of contentsList) {
  // ä¿®æ”¹å‰ï¼š
  const contentComments = commentsList.filter(c => c.work_id === content.work_id);
  const topic = {
    id: content.work_id,
    title: content.title || 'æ— æ ‡é¢˜ä½œå“',
    createdTime: content.publish_time || Date.now(),
    lastMessageTime: content.last_crawl_time || Date.now(),
  };

  // ä¿®æ”¹åï¼š
  const contentComments = commentsList.filter(c => c.contentId === content.contentId);
  const topic = {
    id: content.contentId,           // â† camelCase
    title: content.title || 'æ— æ ‡é¢˜ä½œå“',
    createdTime: content.publishTime || Date.now(),  // â† camelCase
    lastMessageTime: content.updatedAt || content.createdAt || Date.now(),  // â† camelCase
  };
}

// ç¬¬ 316-332 è¡Œï¼šä¿®æ”¹ä¼šè¯å¤„ç†
for (const conversation of conversationsList) {
  // ä¿®æ”¹å‰ï¼š
  const conversationMessages = messagesList.filter(m => m.conversation_id === conversation.conversation_id);
  const topic = {
    id: conversation.conversation_id,
    title: conversation.participant?.user_name || 'æœªçŸ¥ç”¨æˆ·',
    createdTime: conversation.create_time || Date.now(),
    lastMessageTime: conversation.update_time || Date.now(),
    unreadCount: conversation.unread_count || 0,
  };

  // ä¿®æ”¹åï¼š
  const conversationMessages = messagesList.filter(m => m.conversationId === conversation.conversationId);
  const topic = {
    id: conversation.conversationId,        // â† camelCase
    title: conversation.userName || 'æœªçŸ¥ç”¨æˆ·',  // â† camelCase (ç›´æ¥è®¿é—®ï¼Œä¸éœ€è¦ participant)
    createdTime: conversation.createdAt || Date.now(),    // â† camelCase
    lastMessageTime: conversation.updatedAt || Date.now(), // â† camelCase
    unreadCount: conversation.unreadCount || 0,  // â† camelCase
  };
}

// ç¬¬ 361-377 è¡Œï¼šä¿®æ”¹è¯„è®ºæ¶ˆæ¯è¿‡æ»¤
const comments = commentsList.filter(c => c.contentId === topicId);  // â† camelCase
for (const comment of comments) {
  messages.push({
    id: comment.commentId,              // â† camelCase
    fromName: comment.userName,         // â† camelCase
    fromId: comment.userId,             // â† camelCase
    timestamp: comment.createdAt,       // â† camelCase
  });
}

// ç¬¬ 382-397 è¡Œï¼šä¿®æ”¹ç§ä¿¡è¿‡æ»¤
const msgs = messagesList.filter(m => m.conversationId === topicId);  // â† camelCase
for (const msg of msgs) {
  messages.push({
    id: msg.messageId,                  // â† camelCase
    fromName: msg.senderName,           // â† camelCase
    fromId: msg.senderId,               // â† camelCase
    timestamp: msg.createdAt,           // â† camelCase
  });
}
```

### æ–¹æ¡ˆ 2ï¼šä¿®æ”¹ Worker ç«¯ä½¿ç”¨ snake_caseï¼ˆä¸æ¨èï¼‰âŒ

**åŠ£åŠ¿ï¼š**
- ä¿®æ”¹é‡å¤§ï¼ˆéœ€è¦æ”¹ Data Modelsï¼‰
- è¿å JavaScript å‘½åè§„èŒƒ
- å½±å“èŒƒå›´å¹¿

### æ–¹æ¡ˆ 3ï¼šåœ¨ DataStore è½¬æ¢æ ¼å¼ï¼ˆä¸­é—´æ–¹æ¡ˆï¼‰âš–ï¸

**ä¿®æ”¹æ–‡ä»¶ï¼š** `packages/master/src/data/data-store.js`

åœ¨ `updateAccountData()` ä¸­æ·»åŠ æ ¼å¼è½¬æ¢ï¼š

```javascript
// è½¬æ¢ camelCase åˆ° snake_case
function convertToSnakeCase(data) {
  return data.map(item => ({
    ...item,
    work_id: item.contentId,
    publish_time: item.publishTime,
    conversation_id: item.conversationId,
    user_name: item.userName,
    // ... æ›´å¤šè½¬æ¢
  }));
}

// å­˜å‚¨æ—¶è½¬æ¢
if (data.comments) {
  const convertedComments = convertToSnakeCase(data.comments);
  accountData.data.comments.clear();
  convertedComments.forEach(comment => {
    accountData.data.comments.set(comment.id, comment);
  });
}
```

**åŠ£åŠ¿ï¼š**
- å¢åŠ è½¬æ¢å¼€é”€
- ç»´æŠ¤ä¸¤å¥—å‘½åè§„èŒƒ

## ğŸ“ æ¨èè¡ŒåŠ¨è®¡åˆ’

### ç«‹å³æ‰§è¡Œï¼šä¿®æ”¹ IMWebSocketServer âœ…

1. ä¿®æ”¹ `getTopicsFromDataStore()` ä½¿ç”¨ camelCase
2. ä¿®æ”¹ `getMessagesFromDataStore()` ä½¿ç”¨ camelCase
3. ä¿®æ”¹ `calculateUnreadCount()` ä½¿ç”¨ camelCase
4. ä¿®æ”¹ `findLastMessage()` ä½¿ç”¨ camelCase

### éªŒè¯æ­¥éª¤ï¼š

1. å¯åŠ¨ Master
2. å¯åŠ¨ Worker
3. æ£€æŸ¥ Worker æ¨é€æ—¥å¿—ï¼š`âœ… Data synced to Master`
4. æ£€æŸ¥ Master æ¥æ”¶æ—¥å¿—ï¼š`âœ… Data sync completed`
5. è¿æ¥ PC IM å®¢æˆ·ç«¯
6. éªŒè¯æ˜¾ç¤ºï¼š
   - âœ… é¢‘é“åˆ—è¡¨ï¼ˆè´¦æˆ·ï¼‰
   - âœ… ä¸»é¢˜åˆ—è¡¨ï¼ˆä½œå“/ä¼šè¯ï¼‰
   - âœ… æ¶ˆæ¯åˆ—è¡¨ï¼ˆè¯„è®º/ç§ä¿¡ï¼‰

## ğŸ¯ é¢„æœŸæ•ˆæœ

ä¿®æ”¹åï¼š

```
Worker æ¨é€ï¼ˆcamelCaseï¼‰
  â†“
DataStore å­˜å‚¨ï¼ˆcamelCaseï¼‰
  â†“
IMWebSocketServer è¯»å–ï¼ˆcamelCaseï¼‰âœ… å­—æ®µååŒ¹é…
  â†“
PC IM æ˜¾ç¤ºï¼ˆæ­£å¸¸ï¼‰âœ… æ•°æ®æ­£ç¡®
```

---

**æ£€æŸ¥äººå‘˜ï¼š** Claude Code
**æ£€æŸ¥æ—¥æœŸï¼š** 2025-10-31
**æ£€æŸ¥ç»“è®ºï¼š** âŒ å‘ç°ä¸¥é‡å­—æ®µåä¸åŒ¹é…é—®é¢˜
**å»ºè®®ï¼š** ç«‹å³ä¿®æ”¹ IMWebSocketServer ä½¿ç”¨ camelCase å­—æ®µå
