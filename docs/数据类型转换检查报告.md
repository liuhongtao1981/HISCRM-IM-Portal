# 数据类型转换检查报告

## 📋 检查概述

**检查日期：** 2025-10-31
**检查人员：** Claude Code
**检查目的：** 验证 Worker → Master → PC IM 数据类型转换是否正确

## ⚠️ 发现严重问题！

**核心问题：Worker 推送的数据格式（camelCase）与 IMWebSocketServer 期望的格式（snake_case）不匹配！**

## 🔍 详细分析

### 1. Worker 端数据格式（camelCase）

**文件：** `packages/worker/src/platforms/base/account-data-manager.js`

Worker 使用 Data Models 类，所有字段都是 **camelCase**：

```javascript
// Conversation 模型
{
  id,
  conversationId,        // ← camelCase
  userId,
  userName,
  userAvatar,
  unreadCount,
  lastMessageContent,
  lastMessageTime,
  createdAt,
  updatedAt
}

// Message 模型
{
  id,
  messageId,             // ← camelCase
  conversationId,        // ← camelCase
  senderId,
  senderName,
  content,
  createdAt
}

// Content 模型
{
  id,
  contentId,             // ← camelCase
  type,
  title,
  description,
  viewCount,
  likeCount,
  commentCount,
  publishTime
}

// Comment 模型
{
  id,
  commentId,             // ← camelCase
  contentId,             // ← camelCase
  userId,
  userName,
  content,
  likeCount,
  replyCount,
  createdAt
}
```

### 2. DataStore 存储格式

**文件：** `packages/master/src/data/data-store.js`

DataStore 直接存储 Worker 推送的数据（保持 camelCase）：

```javascript
// updateAccountData() 方法
if (data.comments && Array.isArray(data.comments)) {
  accountData.data.comments.clear();
  data.comments.forEach((comment) => {
    accountData.data.comments.set(comment.id, comment);  // ← 直接存储，保持原有字段
  });
}

// 同样处理 contents, conversations, messages
```

**结果：** DataStore 中的数据也是 **camelCase** 格式。

### 3. IMWebSocketServer 期望格式（snake_case）

**文件：** `packages/master/src/communication/im-websocket-server.js`

**❌ 问题代码（第 288 行）：**

```javascript
// 从作品创建主题
const contentComments = commentsList.filter(c => c.work_id === content.work_id);
//                                              ^^^^^^^^^       ^^^^^^^^^
//                                              期望 snake_case，但实际是 camelCase!

const topic = {
  id: content.work_id,              // ❌ 期望 work_id，实际是 contentId
  title: content.title,
  publishTime: content.publish_time // ❌ 期望 publish_time，实际是 publishTime
};
```

**❌ 问题代码（第 318 行）：**

```javascript
// 从会话创建主题
const conversationMessages = messagesList.filter(m => m.conversation_id === conversation.conversation_id);
//                                                      ^^^^^^^^^^^^^^^^      ^^^^^^^^^^^^^^^^
//                                                      期望 snake_case，但实际是 camelCase!

const topic = {
  id: conversation.conversation_id,           // ❌ 期望 conversation_id，实际是 conversationId
  title: conversation.participant?.user_name, // ❌ 期望 user_name，实际是 userName
  createdTime: conversation.create_time,      // ❌ 期望 create_time，实际是 createdAt
  lastMessageTime: conversation.update_time   // ❌ 期望 update_time，实际是 updatedAt
};
```

## 📊 字段名称对照表

### Conversation (会话)

| IMWebSocketServer 期望 | Worker 实际推送 | 状态 |
|----------------------|---------------|------|
| `conversation_id` | `conversationId` | ❌ 不匹配 |
| `user_id` | `userId` | ❌ 不匹配 |
| `user_name` | `userName` | ❌ 不匹配 |
| `user_avatar` | `userAvatar` | ❌ 不匹配 |
| `unread_count` | `unreadCount` | ❌ 不匹配 |
| `create_time` | `createdAt` | ❌ 不匹配 |
| `update_time` | `updatedAt` | ❌ 不匹配 |

### Message (私信)

| IMWebSocketServer 期望 | Worker 实际推送 | 状态 |
|----------------------|---------------|------|
| `msg_id` | `messageId` | ❌ 不匹配 |
| `conversation_id` | `conversationId` | ❌ 不匹配 |
| `sender.user_id` | `senderId` | ❌ 不匹配 |
| `sender.user_name` | `senderName` | ❌ 不匹配 |
| `create_time` | `createdAt` | ❌ 不匹配 |

### Content (作品)

| IMWebSocketServer 期望 | Worker 实际推送 | 状态 |
|----------------------|---------------|------|
| `work_id` | `contentId` | ❌ 不匹配 |
| `publish_time` | `publishTime` | ❌ 不匹配 |
| `last_crawl_time` | ❌ 没有此字段 | ❌ 缺失 |
| `view_count` | `viewCount` | ❌ 不匹配 |
| `like_count` | `likeCount` | ❌ 不匹配 |
| `comment_count` | `commentCount` | ❌ 不匹配 |

### Comment (评论)

| IMWebSocketServer 期望 | Worker 实际推送 | 状态 |
|----------------------|---------------|------|
| `platform_comment_id` | `commentId` | ❌ 不匹配 |
| `work_id` | `contentId` | ❌ 不匹配 |
| `author_id` | `userId` | ❌ 不匹配 |
| `author_name` | `userName` | ❌ 不匹配 |
| `create_time` | `createdAt` | ❌ 不匹配 |
| `is_new` | ❌ 没有此字段 | ❌ 缺失 |
| `parent_comment_id` | `parentCommentId` | ❌ 不匹配 |

## 🎯 影响分析

### 严重性：🔴 高

### 影响范围：

1. **getTopicsFromDataStore()** - ❌ 无法正确过滤作品和会话
   ```javascript
   // 第 288 行
   const contentComments = commentsList.filter(c => c.work_id === content.work_id);
   // ❌ 永远返回 []，因为 work_id 不存在，实际应该是 contentId
   ```

2. **getMessagesFromDataStore()** - ❌ 无法正确过滤消息
   ```javascript
   // 第 361 行
   const comments = commentsList.filter(c => c.work_id === topicId);
   // ❌ 永远返回 []，因为 work_id 不存在

   // 第 382 行
   const msgs = messagesList.filter(m => m.conversation_id === topicId);
   // ❌ 永远返回 []，因为 conversation_id 不存在，实际是 conversationId
   ```

3. **PC IM 显示** - ❌ 所有数据都显示为空
   - 主题列表：空（无法关联评论数）
   - 消息列表：空（无法过滤消息）

## 🔧 解决方案

### 方案 1：修改 IMWebSocketServer 使用 camelCase（推荐）✅

**优势：**
- Worker 端无需修改
- Data Models 保持标准 JavaScript 命名规范
- 修改量最小

**修改文件：** `packages/master/src/communication/im-websocket-server.js`

**修改内容：**

```javascript
// 第 286-300 行：修改 getTopicsFromDataStore()
for (const content of contentsList) {
  // 修改前：
  const contentComments = commentsList.filter(c => c.work_id === content.work_id);
  const topic = {
    id: content.work_id,
    title: content.title || '无标题作品',
    createdTime: content.publish_time || Date.now(),
    lastMessageTime: content.last_crawl_time || Date.now(),
  };

  // 修改后：
  const contentComments = commentsList.filter(c => c.contentId === content.contentId);
  const topic = {
    id: content.contentId,           // ← camelCase
    title: content.title || '无标题作品',
    createdTime: content.publishTime || Date.now(),  // ← camelCase
    lastMessageTime: content.updatedAt || content.createdAt || Date.now(),  // ← camelCase
  };
}

// 第 316-332 行：修改会话处理
for (const conversation of conversationsList) {
  // 修改前：
  const conversationMessages = messagesList.filter(m => m.conversation_id === conversation.conversation_id);
  const topic = {
    id: conversation.conversation_id,
    title: conversation.participant?.user_name || '未知用户',
    createdTime: conversation.create_time || Date.now(),
    lastMessageTime: conversation.update_time || Date.now(),
    unreadCount: conversation.unread_count || 0,
  };

  // 修改后：
  const conversationMessages = messagesList.filter(m => m.conversationId === conversation.conversationId);
  const topic = {
    id: conversation.conversationId,        // ← camelCase
    title: conversation.userName || '未知用户',  // ← camelCase (直接访问，不需要 participant)
    createdTime: conversation.createdAt || Date.now(),    // ← camelCase
    lastMessageTime: conversation.updatedAt || Date.now(), // ← camelCase
    unreadCount: conversation.unreadCount || 0,  // ← camelCase
  };
}

// 第 361-377 行：修改评论消息过滤
const comments = commentsList.filter(c => c.contentId === topicId);  // ← camelCase
for (const comment of comments) {
  messages.push({
    id: comment.commentId,              // ← camelCase
    fromName: comment.userName,         // ← camelCase
    fromId: comment.userId,             // ← camelCase
    timestamp: comment.createdAt,       // ← camelCase
  });
}

// 第 382-397 行：修改私信过滤
const msgs = messagesList.filter(m => m.conversationId === topicId);  // ← camelCase
for (const msg of msgs) {
  messages.push({
    id: msg.messageId,                  // ← camelCase
    fromName: msg.senderName,           // ← camelCase
    fromId: msg.senderId,               // ← camelCase
    timestamp: msg.createdAt,           // ← camelCase
  });
}
```

### 方案 2：修改 Worker 端使用 snake_case（不推荐）❌

**劣势：**
- 修改量大（需要改 Data Models）
- 违反 JavaScript 命名规范
- 影响范围广

### 方案 3：在 DataStore 转换格式（中间方案）⚖️

**修改文件：** `packages/master/src/data/data-store.js`

在 `updateAccountData()` 中添加格式转换：

```javascript
// 转换 camelCase 到 snake_case
function convertToSnakeCase(data) {
  return data.map(item => ({
    ...item,
    work_id: item.contentId,
    publish_time: item.publishTime,
    conversation_id: item.conversationId,
    user_name: item.userName,
    // ... 更多转换
  }));
}

// 存储时转换
if (data.comments) {
  const convertedComments = convertToSnakeCase(data.comments);
  accountData.data.comments.clear();
  convertedComments.forEach(comment => {
    accountData.data.comments.set(comment.id, comment);
  });
}
```

**劣势：**
- 增加转换开销
- 维护两套命名规范

## 📝 推荐行动计划

### 立即执行：修改 IMWebSocketServer ✅

1. 修改 `getTopicsFromDataStore()` 使用 camelCase
2. 修改 `getMessagesFromDataStore()` 使用 camelCase
3. 修改 `calculateUnreadCount()` 使用 camelCase
4. 修改 `findLastMessage()` 使用 camelCase

### 验证步骤：

1. 启动 Master
2. 启动 Worker
3. 检查 Worker 推送日志：`✅ Data synced to Master`
4. 检查 Master 接收日志：`✅ Data sync completed`
5. 连接 PC IM 客户端
6. 验证显示：
   - ✅ 频道列表（账户）
   - ✅ 主题列表（作品/会话）
   - ✅ 消息列表（评论/私信）

## 🎯 预期效果

修改后：

```
Worker 推送（camelCase）
  ↓
DataStore 存储（camelCase）
  ↓
IMWebSocketServer 读取（camelCase）✅ 字段名匹配
  ↓
PC IM 显示（正常）✅ 数据正确
```

---

**检查人员：** Claude Code
**检查日期：** 2025-10-31
**检查结论：** ❌ 发现严重字段名不匹配问题
**建议：** 立即修改 IMWebSocketServer 使用 camelCase 字段名
