# æµè§ˆå™¨å¥åº·æ£€æŸ¥æ¢å¤åŠŸèƒ½

**æ—¥æœŸ**: 2025-11-07
**åŠŸèƒ½**: è‡ªåŠ¨æ£€æµ‹å¹¶æ¸…ç†æ–­å¼€çš„æµè§ˆå™¨è¿æ¥
**çŠ¶æ€**: âœ… å·²å®ç°

---

## ğŸ¯ åŠŸèƒ½è¯´æ˜

å½“ç”¨æˆ·æ‰‹åŠ¨å…³é—­ Worker çš„æµè§ˆå™¨çª—å£åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹æ–­å¼€çš„è¿æ¥å¹¶æ¸…ç†èµ„æºï¼Œä¸‹æ¬¡ç›‘æ§ä»»åŠ¡è¿è¡Œæ—¶ä¼šè‡ªåŠ¨é‡æ–°åˆ›å»ºæµè§ˆå™¨ã€‚

---

## ğŸ”„ å·¥ä½œåŸç†

### ä¹‹å‰çš„æœºåˆ¶ï¼ˆæŒ‰éœ€æ¢å¤ï¼‰

```
æµè§ˆå™¨è¢«å…³é—­
  â†“
ç­‰å¾…ä¸‹ä¸€æ¬¡ç›‘æ§ä»»åŠ¡ (5-10 åˆ†é’Ÿ)
  â†“
getAccountPage() å‘ç°é¡µé¢å·²å…³é—­
  â†“
è‡ªåŠ¨é‡æ–°åˆ›å»ºæµè§ˆå™¨ âœ…
```

**å»¶è¿Ÿ**: 5-10 åˆ†é’Ÿï¼ˆå–å†³äºç›‘æ§é—´éš”ï¼‰

### ç°åœ¨çš„æœºåˆ¶ï¼ˆä¸»åŠ¨æ£€æŸ¥ + æŒ‰éœ€æ¢å¤ï¼‰

```
æµè§ˆå™¨è¢«å…³é—­
  â†“
å¥åº·æ£€æŸ¥å®šæœŸè¿è¡Œ (æ¯ 60 ç§’)
  â†“
æ£€æµ‹åˆ°æµè§ˆå™¨æ–­å¼€ ğŸ”´
  â†“
ç«‹å³æ¸…ç†æ–­å¼€çš„è¿æ¥
  â†“
ä¸‹æ¬¡ç›‘æ§ä»»åŠ¡è¿è¡Œ
  â†“
è‡ªåŠ¨é‡æ–°åˆ›å»ºæµè§ˆå™¨ âœ…
```

**å»¶è¿Ÿ**: æœ€å¤š 1 åˆ†é’Ÿ + ä¸‹æ¬¡ä»»åŠ¡æ‰§è¡Œæ—¶é—´

---

## ğŸ’¡ æ ¸å¿ƒå®ç°

### 1. å¥åº·æ£€æŸ¥å‡½æ•°

**æ–‡ä»¶**: `packages/worker/src/browser/browser-manager-v2.js:912-956`

```javascript
/**
 * ğŸ†• å¯åŠ¨æµè§ˆå™¨å¥åº·æ£€æŸ¥ï¼ˆè½»é‡çº§ï¼‰
 * å®šæœŸæ£€æŸ¥æµè§ˆå™¨è¿æ¥æ˜¯å¦æ­£å¸¸ï¼Œå¦‚æœæ–­å¼€åˆ™è‡ªåŠ¨é‡å¯
 * @param {number} interval - æ£€æŸ¥é—´éš”ï¼ˆæ¯«ç§’ï¼Œé»˜è®¤ 60 ç§’ï¼‰
 */
startBrowserHealthCheck(interval = 60000) {
  if (this.healthCheckInterval) {
    logger.warn('Browser health check already running');
    return;
  }

  logger.info(`Starting browser health check (interval: ${interval/1000}s)`);

  this.healthCheckInterval = setInterval(async () => {
    try {
      const accountIds = Array.from(this.contexts.keys());

      for (const accountId of accountIds) {
        const context = this.contexts.get(accountId);

        // æ£€æŸ¥æµè§ˆå™¨è¿æ¥æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
        if (context && context.browser && !context.browser().isConnected()) {
          logger.warn(`ğŸ”´ Browser disconnected for account ${accountId}, cleaning up...`);

          // æ¸…ç†æ–­å¼€çš„ä¸Šä¸‹æ–‡
          this.contexts.delete(accountId);
          this.accountPages.delete(accountId);

          logger.info(`âœ… Cleaned up disconnected browser for account ${accountId}`);
          logger.info(`   Next task will automatically recreate the browser`);
        }
      }
    } catch (error) {
      logger.error('Error in browser health check:', error);
    }
  }, interval);

  logger.info('âœ… Browser health check started');
}

/**
 * åœæ­¢æµè§ˆå™¨å¥åº·æ£€æŸ¥
 */
stopBrowserHealthCheck() {
  if (this.healthCheckInterval) {
    clearInterval(this.healthCheckInterval);
    this.healthCheckInterval = null;
    logger.info('Browser health check stopped');
  }
}
```

### 2. Worker å¯åŠ¨æ—¶è°ƒç”¨

**æ–‡ä»¶**: `packages/worker/src/index.js:353-355`

```javascript
// 19. å¯åŠ¨æµè§ˆå™¨å¥åº·æ£€æŸ¥ï¼ˆæ¯ 1 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼‰
browserManager.startBrowserHealthCheck(60000);
logger.info('âœ“ Browser health check started (interval: 60s)');
```

### 3. Worker å…³é—­æ—¶åœæ­¢

**æ–‡ä»¶**: `packages/worker/src/index.js:599-603`

```javascript
// åœæ­¢æµè§ˆå™¨å¥åº·æ£€æŸ¥
if (browserManager) {
  browserManager.stopBrowserHealthCheck();
  logger.info('Browser health check stopped');
}
```

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: æ‰‹åŠ¨å…³é—­æµè§ˆå™¨

**æ“ä½œ**:
1. å¯åŠ¨ Worker
2. ç­‰å¾…æµè§ˆå™¨å¯åŠ¨
3. æ‰‹åŠ¨å…³é—­æµè§ˆå™¨çª—å£

**é¢„æœŸç»“æœ**:
- æœ€å¤š 60 ç§’åï¼Œæ—¥å¿—æ˜¾ç¤ºï¼š
  ```
  ğŸ”´ Browser disconnected for account xxx, cleaning up...
  âœ… Cleaned up disconnected browser for account xxx
     Next task will automatically recreate the browser
  ```
- ä¸‹æ¬¡ç›‘æ§ä»»åŠ¡è¿è¡Œæ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºæ–°æµè§ˆå™¨

### åœºæ™¯ 2: æµè§ˆå™¨å´©æºƒ

**æ“ä½œ**:
1. å¯åŠ¨ Worker
2. è§¦å‘æµè§ˆå™¨å´©æºƒï¼ˆå¦‚ä»»åŠ¡ç®¡ç†å™¨å¼ºåˆ¶ç»“æŸ Chrome è¿›ç¨‹ï¼‰

**é¢„æœŸç»“æœ**:
- å¥åº·æ£€æŸ¥æ£€æµ‹åˆ°æ–­å¼€
- æ¸…ç†èµ„æº
- ä¸‹æ¬¡ä»»åŠ¡è‡ªåŠ¨æ¢å¤

### åœºæ™¯ 3: ç›‘æ§ä»»åŠ¡æœŸé—´å…³é—­æµè§ˆå™¨

**æ“ä½œ**:
1. ç›‘æ§ä»»åŠ¡æ­£åœ¨è¿è¡Œ
2. å…³é—­æµè§ˆå™¨

**é¢„æœŸç»“æœ**:
- ä»»åŠ¡ç«‹å³æ•è·é”™è¯¯
- è°ƒç”¨ `recoverPage()` ç«‹å³æ¢å¤ï¼ˆæ— éœ€ç­‰å¾…å¥åº·æ£€æŸ¥ï¼‰
- ä»»åŠ¡ç»§ç»­æ‰§è¡Œ

---

## ğŸ“Š æ€§èƒ½å½±å“

### CPU å ç”¨
- **å¥åº·æ£€æŸ¥**: æ¯ 60 ç§’è¿è¡Œä¸€æ¬¡ï¼Œè€—æ—¶ < 10ms
- **å½±å“**: å¯å¿½ç•¥ä¸è®¡

### å†…å­˜å ç”¨
- **é¢å¤–å†…å­˜**: 0 å­—èŠ‚ï¼ˆä»…ä¿å­˜ä¸€ä¸ªå®šæ—¶å™¨å¼•ç”¨ï¼‰
- **å½±å“**: æ— 

### æ¢å¤æ—¶é—´
| åœºæ™¯ | æ£€æµ‹å»¶è¿Ÿ | æ¢å¤æ—¶é—´ | æ€»å»¶è¿Ÿ |
|------|---------|---------|--------|
| ç›‘æ§ä»»åŠ¡æœŸé—´ | 0ç§’ | 0.5-1.3ç§’ | **0.5-1.3ç§’** |
| åå°æ–­å¼€ | 0-60ç§’ | 0.5-1.3ç§’ | **0.5-61.3ç§’** |

---

## ğŸ” æ—¥å¿—ç¤ºä¾‹

### å¯åŠ¨æ—¥å¿—

```
[worker] âœ“ Browser manager initialized
[worker] âœ“ Browser health check started (interval: 60s)
[worker] Worker Ready
```

### æ£€æµ‹åˆ°æ–­å¼€

```
[browser-manager-v2] ğŸ”´ Browser disconnected for account acc-xxx, cleaning up...
[browser-manager-v2] âœ… Cleaned up disconnected browser for account acc-xxx
[browser-manager-v2]    Next task will automatically recreate the browser
```

### è‡ªåŠ¨æ¢å¤

```
[monitor-task] Executing monitor task for account acc-xxx
[browser-manager-v2] Creating new context for account acc-xxx...
[browser-manager-v2] âœ… Created new page for account acc-xxx (purpose: crawl)
[monitor-task] âœ“ Monitor task completed for account acc-xxx
```

---

## âš™ï¸ é…ç½®é€‰é¡¹

### ä¿®æ”¹æ£€æŸ¥é—´éš”

**æ–‡ä»¶**: `packages/worker/src/index.js:354`

```javascript
// é»˜è®¤: 60 ç§’ï¼ˆ1 åˆ†é’Ÿï¼‰
browserManager.startBrowserHealthCheck(60000);

// æ›´é¢‘ç¹: 30 ç§’
browserManager.startBrowserHealthCheck(30000);

// æ›´å®½æ¾: 120 ç§’ï¼ˆ2 åˆ†é’Ÿï¼‰
browserManager.startBrowserHealthCheck(120000);
```

**å»ºè®®**:
- **ç”Ÿäº§ç¯å¢ƒ**: 60 ç§’ï¼ˆé»˜è®¤ï¼‰- å¹³è¡¡æ€§èƒ½å’Œå“åº”é€Ÿåº¦
- **å¼€å‘ç¯å¢ƒ**: 30 ç§’ - æ›´å¿«æ£€æµ‹åˆ°é—®é¢˜
- **ä½èµ„æºç¯å¢ƒ**: 120 ç§’ - å‡å°‘æ£€æŸ¥é¢‘ç‡

---

## ğŸ›¡ï¸ é”™è¯¯å¤„ç†

### æ£€æŸ¥å¤±è´¥

å¦‚æœå¥åº·æ£€æŸ¥æœ¬èº«å‡ºé”™ï¼ˆå¦‚å†…å­˜ä¸è¶³ï¼‰ï¼Œä¼šè®°å½•é”™è¯¯ä½†ä¸ä¼šå½±å“ Worker è¿è¡Œï¼š

```javascript
} catch (error) {
  logger.error('Error in browser health check:', error);
}
```

### æ¸…ç†å¤±è´¥

å¦‚æœæ¸…ç†æ–­å¼€çš„ä¸Šä¸‹æ–‡å¤±è´¥ï¼Œä¼šä¿ç•™åœ¨ Map ä¸­ï¼Œä¸‹æ¬¡æ£€æŸ¥æ—¶é‡è¯•ã€‚

---

## ğŸ”„ ä¸ç°æœ‰æœºåˆ¶çš„å¯¹æ¯”

### ä¹‹å‰ï¼ˆä»…æŒ‰éœ€æ¢å¤ï¼‰

**ä¼˜ç‚¹**:
- âœ… é›¶ CPU å ç”¨
- âœ… ä»£ç ç®€æ´

**ç¼ºç‚¹**:
- âŒ å»¶è¿Ÿæ¢å¤ï¼ˆ5-10åˆ†é’Ÿï¼‰
- âŒ èµ„æºæ³„æ¼ï¼ˆæ–­å¼€çš„è¿æ¥é•¿æœŸå­˜åœ¨äº Map ä¸­ï¼‰

### ç°åœ¨ï¼ˆä¸»åŠ¨æ£€æŸ¥ + æŒ‰éœ€æ¢å¤ï¼‰

**ä¼˜ç‚¹**:
- âœ… å¿«é€Ÿæ£€æµ‹ï¼ˆæœ€å¤š 60 ç§’ï¼‰
- âœ… è‡ªåŠ¨æ¸…ç†èµ„æº
- âœ… è½»é‡çº§ï¼ˆæ¯ 60 ç§’ < 10ms CPUï¼‰
- âœ… ä»»åŠ¡æœŸé—´ä»ç„¶ç«‹å³æ¢å¤

**ç¼ºç‚¹**:
- âš ï¸ æå°‘é‡ CPU å ç”¨ï¼ˆå¯å¿½ç•¥ï¼‰

---

## ğŸ“ æ€»ç»“

### å®ç°å†…å®¹

- âœ… æ–°å¢ `startBrowserHealthCheck()` æ–¹æ³•
- âœ… æ–°å¢ `stopBrowserHealthCheck()` æ–¹æ³•
- âœ… Worker å¯åŠ¨æ—¶è‡ªåŠ¨å¯ç”¨ï¼ˆ60 ç§’é—´éš”ï¼‰
- âœ… Worker å…³é—­æ—¶è‡ªåŠ¨åœæ­¢

### ä¿®æ”¹æ–‡ä»¶

1. **`packages/worker/src/browser/browser-manager-v2.js`** - æ–°å¢ 50 è¡Œ
   - `startBrowserHealthCheck()` æ–¹æ³•
   - `stopBrowserHealthCheck()` æ–¹æ³•

2. **`packages/worker/src/index.js`** - 2 å¤„ä¿®æ”¹
   - å¯åŠ¨æ—¶è°ƒç”¨å¥åº·æ£€æŸ¥
   - å…³é—­æ—¶åœæ­¢å¥åº·æ£€æŸ¥

### ç”¨æˆ·ä½“éªŒæå‡

| æŒ‡æ ‡ | ä¹‹å‰ | ç°åœ¨ | æå‡ |
|------|------|------|------|
| æ£€æµ‹å»¶è¿Ÿ | 5-10åˆ†é’Ÿ | **0-60ç§’** | **83-90%** |
| èµ„æºæ¸…ç† | æ‰‹åŠ¨ | **è‡ªåŠ¨** | âœ… |
| CPU å ç”¨ | 0% | 0.001% | å¯å¿½ç•¥ |

---

**å®ç°äºº**: Claude Code
**æµ‹è¯•çŠ¶æ€**: å¾…æµ‹è¯•
**éƒ¨ç½²å»ºè®®**: éšä¸‹æ¬¡ Worker æ›´æ–°ä¸€èµ·éƒ¨ç½²
