# ç™»å½•çŠ¶æ€é—®é¢˜å®Œæ•´è§£å†³æ–¹æ¡ˆ

## é—®é¢˜æ€»ç»“

### ç”¨æˆ·åé¦ˆ
> "ç™»å½•ä¸ç™»å½•ï¼Œå¹¶ä¸æ˜¯åº“é‡Œå­˜çš„ï¼Œè€Œæ˜¯worker è¦è¿›è¡Œç™»å½•æ£€æµ‹å‘€"
> "OKï¼Œç™»å½•æˆåŠŸåï¼Œèœ˜è››ä»»åŠ¡ï¼Œè²Œä¼¼æ²¡æœ‰æ‰§è¡Œï¼Œçœ‹ä¸‹æ—¥å¿—"

### é—®é¢˜ç°è±¡

ç”¨æˆ·ç™»å½•æˆåŠŸåï¼Œçˆ¬è™«ä»»åŠ¡æ²¡æœ‰æ‰§è¡Œï¼ŒWorker æ—¥å¿—æŒç»­æ˜¾ç¤ºé”™è¯¯ï¼š
```
Account missing platform_user_id - please login first to obtain douyin_id
```

### è¯Šæ–­ç»“æœ

è¿è¡Œ `tests/è¯Šæ–­ç™»å½•æ£€æµ‹é—®é¢˜.js` å‘ç°æ ¸å¿ƒçŸ›ç›¾ï¼š

| é¡¹ç›® | æ•°æ®åº“çŠ¶æ€ | å®é™…æƒ…å†µ | ç»“è®º |
|------|----------|---------|------|
| platform_user_id | âœ… 1864722759 | ç™»å½•æ—¶æ­£ç¡®è·å–å¹¶ä¿å­˜ | æ­£å¸¸ |
| login_status | âŒ not_logged_in | è¢« Worker è¯¯è¦†ç›– | **å¼‚å¸¸** |
| Storage Cookies | âœ… 56 ä¸ªæœ‰æ•ˆ | å…³é”® cookies éƒ½å­˜åœ¨ | æ­£å¸¸ |
| Cookies æœ‰æ•ˆæœŸ | âœ… 2025/10/31 | æœªè¿‡æœŸ | æ­£å¸¸ |
| Worker æ£€æµ‹ | âŒ æœªç™»å½• | ä½¿ç”¨æ—§é…ç½®æ£€æµ‹ | **å¼‚å¸¸** |

## æ ¹æœ¬åŸå› 

### é—®é¢˜é“¾æ¡

```
1. Master ç™»å½•æˆåŠŸ (18:39:07)
   â”œâ”€ æ›´æ–°æ•°æ®åº“: login_status = 'logged_in' âœ…
   â””â”€ æ›´æ–°æ•°æ®åº“: platform_user_id = '1864722759' âœ…

2. Worker é…ç½®æœªåŒæ­¥ âŒ
   â”œâ”€ Worker å†…å­˜ä¸­ä»æ˜¯æ—§é…ç½®ï¼ˆæ—  platform_user_idï¼‰
   â””â”€ åŸå› ï¼šæ²¡æœ‰é…ç½®çƒ­æ›´æ–°æœºåˆ¶

3. Worker å®šæœŸæ£€æµ‹ (18:39:08 å¼€å§‹ï¼Œæ¯åˆ†é’Ÿä¸€æ¬¡)
   â”œâ”€ ä½¿ç”¨æ—§é…ç½®è¿›è¡Œæ£€æµ‹
   â”œâ”€ åˆ¤æ–­ï¼šæ—  platform_user_id = æœªç™»å½•
   â””â”€ æ‰§è¡Œé”™è¯¯æ“ä½œï¼šæ›´æ–°æ•°æ®åº“ login_status = 'not_logged_in' âŒ

4. æ•°æ®åº“çŠ¶æ€è¢«è¦†ç›–
   â”œâ”€ login_status: 'logged_in' â†’ 'not_logged_in'
   â””â”€ ä½† platform_user_id ä»ç„¶å­˜åœ¨ï¼ˆçŸ›ç›¾çŠ¶æ€ï¼‰

5. Worker é‡å¯ (18:59:31)
   â”œâ”€ ä»æ•°æ®åº“åŠ è½½é…ç½®
   â”œâ”€ è¯»å–åˆ°: login_status = 'not_logged_in'
   â””â”€ ç»§ç»­æŠ¥é”™ï¼š"missing platform_user_id"

6. æ¶æ€§å¾ªç¯ â™»ï¸
   â””â”€ Worker æŒç»­æ£€æµ‹ä¸ºæœªç™»å½• â†’ çˆ¬è™«ä»»åŠ¡ä¸æ‰§è¡Œ
```

### ä»£ç å±‚é¢åˆ†æ

#### é—®é¢˜ä»£ç  1ï¼šWorker ç›²ç›®è¦†ç›–ç™»å½•çŠ¶æ€

**ä½ç½®**ï¼š`packages/worker/src/handlers/monitor-task.js:162-180`

```javascript
// æ£€æŸ¥ platform_user_id
if (!this.account.platform_user_id) {
  logger.warn(`Account ${this.account.id} missing platform_user_id - please login first`);

  // âŒ é—®é¢˜ï¼šç›´æ¥æŠŠæ•°æ®åº“çš„ login_status æ”¹ä¸º not_logged_in
  // æ²¡æœ‰è€ƒè™‘å¯èƒ½æ˜¯é…ç½®æœªåŒæ­¥çš„æƒ…å†µ
  this.accountStatusReporter.recordError(this.account.id, 'Account missing platform_user_id...');
  this.accountStatusReporter.updateAccountStatus(this.account.id, {
    worker_status: 'offline',
    login_status: 'not_logged_in'  // âš ï¸ è¦†ç›–äº† Master åˆšè®¾ç½®çš„ logged_in
  });

  return;
}

// æ£€æŸ¥ç™»å½•çŠ¶æ€
const loginStatus = await platform.checkLoginStatus(page);
if (!loginStatus || !loginStatus.isLoggedIn) {
  logger.warn(`Account ${this.account.id} is NOT logged in`);

  // âŒ åŒæ ·çš„é—®é¢˜
  this.accountStatusReporter.updateAccountStatus(this.account.id, {
    worker_status: 'offline',
    login_status: 'not_logged_in'
  });

  return;
}
```

#### é—®é¢˜ä»£ç  2ï¼šç¼ºå°‘é…ç½®çƒ­æ›´æ–°æœºåˆ¶

**ç°è±¡**ï¼šMaster æ›´æ–°æ•°æ®åº“åï¼ŒWorker å†…å­˜ä¸­çš„é…ç½®ä¸ä¼šè‡ªåŠ¨åˆ·æ–°

**å½±å“**ï¼š
- Worker ä½¿ç”¨è¿‡æ—¶çš„é…ç½®è¿›è¡Œå†³ç­–
- å¯¼è‡´è¯¯åˆ¤å’Œé”™è¯¯æ“ä½œ

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šé…ç½®çƒ­æ›´æ–°æœºåˆ¶ âœ…ï¼ˆå·²å®ç°ï¼‰

**è¯¦è§**ï¼š[çˆ¬è™«ä»»åŠ¡é…ç½®çƒ­æ›´æ–°æœºåˆ¶å®ç°æŠ¥å‘Š.md](./çˆ¬è™«ä»»åŠ¡é…ç½®çƒ­æ›´æ–°æœºåˆ¶å®ç°æŠ¥å‘Š.md)

#### æ ¸å¿ƒæœºåˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é…ç½®çƒ­æ›´æ–°æµç¨‹                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. ç”¨æˆ·æ‰«ç ç™»å½•æˆåŠŸ
   â†“
2. Worker å‘é€ login:success ç»™ Master
   payload: { cookies, userInfo, fingerprint }
   â†“
3. Master æ›´æ–°æ•°æ®åº“
   UPDATE accounts SET
     login_status = 'logged_in',
     platform_user_id = '1864722759',
     last_login_time = 1730375947,
     cookies_valid_until = 1730980747
   â†“
4. â­ Master å‘é€é…ç½®æ›´æ–°é€šçŸ¥
   Event: MASTER_ACCOUNT_CONFIG_UPDATE
   Payload: {
     account_id: "acc-xxx",
     reason: "login_success",
     updated_fields: ["platform_user_id", "login_status", "user_info"]
   }
   â†“
5. â­ Worker æ¥æ”¶é€šçŸ¥ï¼Œé‡æ–°åŠ è½½é…ç½®
   - è°ƒç”¨ workerRegistration.register() è·å–æœ€æ–°é…ç½®
   - æ›´æ–° accountsCache.set(accountId, updatedAccount)
   - é€šçŸ¥ taskRunner.updateAccountConfig()
   â†“
6. â­ Worker ä¸‹æ¬¡æ£€æµ‹ä½¿ç”¨æ–°é…ç½®
   - this.account.platform_user_id = '1864722759' âœ…
   - æ£€æµ‹é€šè¿‡ï¼Œçˆ¬è™«ä»»åŠ¡æ­£å¸¸æ‰§è¡Œ âœ…
```

#### å®ç°æ–‡ä»¶

1. **åè®®å±‚** (`packages/shared/protocol/messages.js`)
   - æ–°å¢ï¼š`MASTER_ACCOUNT_CONFIG_UPDATE`
   - æ–°å¢ï¼š`MASTER_ACCOUNT_CONFIG_UPDATE_ACK`

2. **Master ç«¯** (`packages/master/src/login/login-handler.js`)
   - ä¿®æ”¹ï¼šæ„é€ å‡½æ•°æ¥æ”¶ `workerNamespace`
   - æ–°å¢ï¼š`handleLoginSuccess()` ä¸­å‘é€é…ç½®æ›´æ–°é€šçŸ¥

3. **Worker ç«¯**
   - `socket-client.js`: ç›‘å¬é…ç½®æ›´æ–°æ¶ˆæ¯
   - `index.js`: å®ç° `reloadAccountConfig()` å‡½æ•°
   - `task-runner.js`: å®ç° `updateAccountConfig()` æ–¹æ³•

#### æµ‹è¯•æ–¹æ³•

```bash
# 1. å¯åŠ¨ Master å’Œ Worker
cd packages/master && npm start
cd packages/worker && npm start

# 2. æ‰§è¡Œç™»å½•æ“ä½œï¼ˆAdmin UI æ‰«ç ç™»å½•ï¼‰

# 3. è§‚å¯Ÿæ—¥å¿—
# Master åº”æ˜¾ç¤ºï¼š
[login-handler] Sent config update notification to Worker worker-1

# Worker åº”æ˜¾ç¤ºï¼š
[socket-client] ğŸ“¥ Received account config update notification from Master
[worker] ğŸ”„ Reloading configuration for account acc-xxx...
[worker] âœ… Account config reloaded for acc-xxx
[task-runner] âœ… Updated account config in MonitorTask for acc-xxx

# 4. éªŒè¯çˆ¬è™«ä»»åŠ¡æ‰§è¡Œ
node tests/æµ‹è¯•çˆ¬è™«ä»»åŠ¡æ‰§è¡Œ.js
```

### æ–¹æ¡ˆ 2ï¼šä¿®å¤ Worker æ£€æµ‹é€»è¾‘ ğŸ”§ï¼ˆå¾…å®ç°ï¼‰

#### æ”¹è¿›æ€è·¯

Worker ä¸åº”è¯¥åœ¨æ£€æµ‹åˆ°æœ¬åœ°é…ç½®ç¼ºå¤±æ—¶ï¼Œç›²ç›®åœ°æŠŠæ•°æ®åº“æ”¹ä¸º `not_logged_in`ã€‚

åº”è¯¥ï¼š
1. æ£€æµ‹åˆ°æœ¬åœ°é…ç½®ç¼ºå°‘ platform_user_id
2. **å…ˆæŸ¥è¯¢æ•°æ®åº“**ï¼Œçœ‹æ•°æ®åº“æ˜¯å¦æœ‰
3. å¦‚æœæ•°æ®åº“æœ‰ â†’ é…ç½®æœªåŒæ­¥ â†’ é‡æ–°åŠ è½½é…ç½®
4. å¦‚æœæ•°æ®åº“ä¹Ÿæ²¡æœ‰ â†’ ç¡®å®æœªç™»å½• â†’ æ›´æ–°ä¸º not_logged_in

#### æ”¹è¿›ä»£ç 

**æ–‡ä»¶**ï¼š`packages/worker/src/handlers/monitor-task.js`

```javascript
// â­ æ”¹è¿›ç‰ˆï¼šæ™ºèƒ½æ£€æµ‹ + é…ç½®é‡è½½
async checkAndReloadConfigIfNeeded() {
  // æ£€æŸ¥æœ¬åœ°é…ç½®æ˜¯å¦ç¼ºå°‘ platform_user_id
  if (!this.account.platform_user_id) {
    logger.warn(`[MonitorTask] Local config missing platform_user_id for ${this.account.id}`);

    try {
      // â­ å…ˆå°è¯•é‡æ–°åŠ è½½é…ç½®
      const updatedAccount = await this.reloadAccountConfig(this.account.id);

      if (updatedAccount && updatedAccount.platform_user_id) {
        // æˆåŠŸé‡æ–°åŠ è½½ï¼Œä½¿ç”¨æ–°é…ç½®
        logger.info(`âœ… Config reloaded with platform_user_id: ${updatedAccount.platform_user_id}`);
        this.account = updatedAccount;
        return true; // é…ç½®å·²æ›´æ–°ï¼Œå¯ä»¥ç»§ç»­
      } else {
        // æ•°æ®åº“ä¹Ÿæ²¡æœ‰ï¼Œç¡®å®æœªç™»å½•
        logger.warn(`âŒ Database also missing platform_user_id - truly not logged in`);
        this.accountStatusReporter.updateAccountStatus(this.account.id, {
          worker_status: 'offline',
          login_status: 'not_logged_in'
        });
        return false; // æœªç™»å½•ï¼Œä¸èƒ½ç»§ç»­
      }
    } catch (error) {
      logger.error(`Failed to reload config:`, error);
      return false;
    }
  }

  return true; // é…ç½®å®Œæ•´ï¼Œå¯ä»¥ç»§ç»­
}

async run() {
  try {
    // â­ è¿è¡Œå‰å…ˆæ£€æŸ¥å¹¶é‡è½½é…ç½®
    const configOk = await this.checkAndReloadConfigIfNeeded();
    if (!configOk) {
      logger.info(`Pausing monitoring for ${this.account.id} - config incomplete`);
      return;
    }

    // ç»§ç»­æ‰§è¡ŒåŸæœ‰çš„ç›‘æ§é€»è¾‘
    // ...
  } catch (error) {
    logger.error(`MonitorTask run error:`, error);
  }
}
```

### æ–¹æ¡ˆ 3ï¼šMaster ç«¯é˜²å¾¡ ğŸ›¡ï¸ï¼ˆå¾…å®ç°ï¼‰

#### æ”¹è¿›æ€è·¯

Master ä¸åº”è¯¥å…è®¸ Worker éšæ„è¦†ç›–å…³é”®å­—æ®µï¼Œç‰¹åˆ«æ˜¯å½“æ•°æ®åº“çŠ¶æ€æ˜ç¡®æ—¶ã€‚

#### æ”¹è¿›ä»£ç 

**æ–‡ä»¶**ï¼š`packages/master/src/worker_manager/account-status-updater.js`

```javascript
/**
 * â­ æ™ºèƒ½æ›´æ–°è´¦æˆ·çŠ¶æ€ï¼ˆé˜²å¾¡æ€§éªŒè¯ï¼‰
 */
updateAccountStatus(accountId, updates) {
  try {
    // â­ é˜²å¾¡æ€§æ£€æŸ¥ï¼šå¦‚æœ Worker æƒ³æ”¹ä¸º not_logged_inï¼Œå…ˆéªŒè¯æ•°æ®åº“
    if (updates.login_status === 'not_logged_in') {
      const account = this.db.prepare(`
        SELECT platform_user_id, login_status, cookies_valid_until
        FROM accounts
        WHERE id = ?
      `).get(accountId);

      if (account) {
        const now = Math.floor(Date.now() / 1000);

        // æƒ…å†µ1ï¼šæ•°æ®åº“æœ‰ platform_user_id ä¸”çŠ¶æ€ä¸º logged_in
        if (account.platform_user_id && account.login_status === 'logged_in') {
          logger.warn(`ğŸ›¡ï¸ Rejected Worker's attempt to set login_status=not_logged_in for ${accountId}`);
          logger.warn(`   Reason: Database shows logged_in with platform_user_id=${account.platform_user_id}`);

          // ç§»é™¤è¿™ä¸ªé”™è¯¯çš„æ›´æ–°
          delete updates.login_status;

          // â­ åè€Œé€šçŸ¥ Worker é‡æ–°åŠ è½½é…ç½®
          this.notifyWorkerToReloadConfig(accountId, 'config_mismatch');
        }

        // æƒ…å†µ2ï¼šCookies ä»åœ¨æœ‰æ•ˆæœŸå†…
        else if (account.cookies_valid_until && account.cookies_valid_until > now) {
          logger.warn(`ğŸ›¡ï¸ Rejected Worker's attempt to set login_status=not_logged_in for ${accountId}`);
          logger.warn(`   Reason: Cookies still valid until ${new Date(account.cookies_valid_until * 1000).toLocaleString('zh-CN')}`);

          delete updates.login_status;
          this.notifyWorkerToReloadConfig(accountId, 'cookies_still_valid');
        }
      }
    }

    // æ„å»º UPDATE SQL
    const fields = [];
    const values = [];

    for (const [key, value] of Object.entries(updates)) {
      fields.push(`${key} = ?`);
      values.push(value);
    }

    if (fields.length === 0) {
      logger.debug(`No fields to update for account ${accountId}`);
      return;
    }

    const sql = `UPDATE accounts SET ${fields.join(', ')} WHERE id = ?`;
    values.push(accountId);

    const stmt = this.db.prepare(sql);
    const result = stmt.run(...values);

    logger.info(`âœ… Updated account status for ${accountId}: ${JSON.stringify(updates)}`);

  } catch (error) {
    logger.error(`Failed to update account status for ${accountId}:`, error);
  }
}

/**
 * â­ é€šçŸ¥ Worker é‡æ–°åŠ è½½é…ç½®
 */
notifyWorkerToReloadConfig(accountId, reason) {
  try {
    const { MASTER_ACCOUNT_CONFIG_UPDATE, createMessage } = require('@hiscrm-im/shared/protocol/messages');

    // æŸ¥æ‰¾è´¦æˆ·åˆ†é…çš„ Worker
    const account = this.db.prepare('SELECT assigned_worker_id FROM accounts WHERE id = ?').get(accountId);
    if (!account || !account.assigned_worker_id) {
      logger.warn(`Cannot notify Worker for ${accountId} - no assigned Worker`);
      return;
    }

    // æ‰¾åˆ° Worker çš„ socket è¿æ¥
    const workerSocket = this.workerNamespace.sockets.get(account.assigned_worker_id);
    if (workerSocket) {
      const message = createMessage(MASTER_ACCOUNT_CONFIG_UPDATE, {
        account_id: accountId,
        reason: reason,
        updated_fields: ['platform_user_id', 'login_status', 'cookies_valid_until'],
      });

      workerSocket.emit(MASTER_ACCOUNT_CONFIG_UPDATE, message);
      logger.info(`ğŸ“¤ Sent config reload notification to Worker ${account.assigned_worker_id} for account ${accountId}`);
    }

  } catch (error) {
    logger.error(`Failed to notify Worker for ${accountId}:`, error);
  }
}
```

## ä¸´æ—¶ä¿®å¤ï¼ˆå·²æ‰§è¡Œï¼‰âœ…

### ä¿®å¤æ•°æ®åº“çŠ¶æ€

è¿è¡Œè„šæœ¬ï¼š`tests/ä¿®å¤ç™»å½•çŠ¶æ€.js`

```bash
$ node tests/ä¿®å¤ç™»å½•çŠ¶æ€.js

================================================================================
ä¿®å¤ç™»å½•çŠ¶æ€
================================================================================

ğŸ“Š 1. æ£€æŸ¥éœ€è¦ä¿®å¤çš„è´¦æˆ·:
--------------------------------------------------------------------------------
æ‰¾åˆ° 1 ä¸ªéœ€è¦ä¿®å¤çš„è´¦æˆ·:

[1] è´¦æˆ· ID: acc-98296c87-2e42-447a-9d8b-8be008ddb6e4
    å¹³å°ç”¨æˆ·ID: 1864722759 âœ…
    å½“å‰ç™»å½•çŠ¶æ€: not_logged_in âŒ

ğŸ”§ 2. å¼€å§‹ä¿®å¤:
--------------------------------------------------------------------------------
âœ… [1/1] ä¿®å¤æˆåŠŸ: douyin-test

ä¿®å¤å®Œæˆï¼
```

### SQL æ‰§è¡Œ

```sql
UPDATE accounts
SET login_status = 'logged_in'
WHERE id = 'acc-98296c87-2e42-447a-9d8b-8be008ddb6e4'
  AND platform_user_id IS NOT NULL;
```

## ä¸‹ä¸€æ­¥æ“ä½œ

### 1. é‡å¯ Worker âš ï¸

æ•°æ®åº“å·²ä¿®å¤ï¼Œä½† Worker å†…å­˜ä¸­çš„é…ç½®ä»æ˜¯æ—§çš„ï¼Œéœ€è¦é‡å¯ï¼š

```bash
# ç»ˆæ­¢å½“å‰ Worker è¿›ç¨‹
# ç„¶åé‡æ–°å¯åŠ¨
cd packages/worker && npm start
```

### 2. è§‚å¯Ÿ Worker è¡Œä¸º

Worker é‡å¯ååº”è¯¥ï¼š
- âœ… åŠ è½½ `login_status: logged_in` çš„é…ç½®
- âœ… æ£€æµ‹é€šè¿‡ï¼ˆæœ‰ platform_user_idï¼‰
- âœ… çˆ¬è™«ä»»åŠ¡æ­£å¸¸æ‰§è¡Œ

### 3. éªŒè¯çˆ¬è™«ä»»åŠ¡æ‰§è¡Œ

```bash
# ç­‰å¾… 1-2 åˆ†é’Ÿåè¿è¡Œ
node tests/æµ‹è¯•çˆ¬è™«ä»»åŠ¡æ‰§è¡Œ.js
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… è´¦æˆ·çŠ¶æ€æ˜¾ç¤º `logged_in`
- âœ… ç›‘æ§ä»»åŠ¡å­˜åœ¨ä¸”çŠ¶æ€ä¸º `active`
- âœ… æ•°æ®åº“ä¸­å¼€å§‹å‡ºç°æ–°çš„è¯„è®º/ç§ä¿¡æ•°æ®

### 4. æµ‹è¯•é…ç½®çƒ­æ›´æ–°æœºåˆ¶

1. **æ¨¡æ‹Ÿé…ç½®è¢«è¦†ç›–**ï¼š
   ```sql
   UPDATE accounts
   SET login_status = 'not_logged_in'
   WHERE id = 'acc-98296c87-2e42-447a-9d8b-8be008ddb6e4';
   ```

2. **å†æ¬¡ç™»å½•**ï¼šåœ¨ Admin UI ç‚¹å‡»ç™»å½•ï¼Œæ‰«ç ç¡®è®¤

3. **è§‚å¯Ÿæ—¥å¿—**ï¼š

   **Master æ—¥å¿—åº”æ˜¾ç¤º**ï¼š
   ```
   [login-handler] Login success for session xxx
   [login-handler] Updated platform_user_id to: 1864722759
   [login-handler] Sent config update notification to Worker worker-1
   ```

   **Worker æ—¥å¿—åº”æ˜¾ç¤º**ï¼š
   ```
   [socket-client] ğŸ“¥ Received account config update notification from Master
   [worker] ğŸ”„ Reloading configuration for account acc-xxx...
   [worker] âœ… Account config reloaded for acc-xxx
   [task-runner] âœ… Updated account config in MonitorTask for acc-xxx
   ```

4. **éªŒè¯è‡ªåŠ¨æ¢å¤**ï¼š
   - Worker ä¸å†æŠ¥é”™
   - çˆ¬è™«ä»»åŠ¡è‡ªåŠ¨æ¢å¤æ‰§è¡Œ
   - æ— éœ€æ‰‹åŠ¨é‡å¯ Worker

## æ€»ç»“

### é—®é¢˜æœ¬è´¨

**é…ç½®ä¸ä¸€è‡´å¯¼è‡´çš„æ•°æ®æ··ä¹±**ï¼š

1. Master åœ¨æ•°æ®åº“ä¸­æ›´æ–°äº†è´¦æˆ·é…ç½®
2. Worker å†…å­˜ä¸­çš„é…ç½®æ²¡æœ‰åŒæ­¥æ›´æ–°
3. Worker ä½¿ç”¨æ—§é…ç½®è¿›è¡Œå†³ç­–ï¼Œå¾—å‡ºé”™è¯¯ç»“è®º
4. Worker æŠŠé”™è¯¯ç»“è®ºå†™å›æ•°æ®åº“ï¼Œè¦†ç›–äº† Master çš„æ­£ç¡®æ›´æ–°
5. å½¢æˆæ¶æ€§å¾ªç¯

### è§£å†³æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜å…ˆçº§ | çŠ¶æ€ | æ•ˆæœ |
|------|--------|------|------|
| é…ç½®çƒ­æ›´æ–°æœºåˆ¶ | â­â­â­ | âœ… å·²å®ç° | æ ¹æœ¬è§£å†³é—®é¢˜ï¼Œå®ç°å®æ—¶é…ç½®åŒæ­¥ |
| Worker æ£€æµ‹é€»è¾‘æ”¹è¿› | â­â­ | ğŸ”§ å¾…å®ç° | æå‡å¥å£®æ€§ï¼Œæ™ºèƒ½å¤„ç†é…ç½®ç¼ºå¤± |
| Master é˜²å¾¡æ€§éªŒè¯ | â­ | ğŸ›¡ï¸ å¾…å®ç° | ä¿æŠ¤æ•°æ®åº“ï¼Œæ‹’ç»ä¸åˆç†æ›´æ–° |
| æ•°æ®åº“çŠ¶æ€ä¿®å¤ | ğŸš‘ | âœ… å·²æ‰§è¡Œ | ä¸´æ—¶ä¿®å¤å½“å‰é—®é¢˜ |

### é•¿æœŸæ”¹è¿›å»ºè®®

1. **é…ç½®ç®¡ç†**
   - å®ç°é…ç½®ç‰ˆæœ¬å·æœºåˆ¶
   - Worker å®šæœŸæ£€æŸ¥é…ç½®ç‰ˆæœ¬ï¼Œè‡ªåŠ¨åŒæ­¥

2. **çŠ¶æ€ç›‘æ§**
   - ç›‘æ§ `platform_user_id` å­˜åœ¨ä½† `login_status = not_logged_in` çš„å¼‚å¸¸çŠ¶æ€
   - è‡ªåŠ¨å‘å‡ºå‘Šè­¦å¹¶å°è¯•ä¿®å¤

3. **æ—¥å¿—å¢å¼º**
   - è®°å½•æ‰€æœ‰ login_status å˜æ›´ï¼ŒåŒ…æ‹¬å˜æ›´æ¥æº
   - ä¾¿äºè¿½è¸ªé—®é¢˜å’Œå®¡è®¡

4. **æµ‹è¯•è¦†ç›–**
   - æ·»åŠ é›†æˆæµ‹è¯•ï¼šç™»å½• â†’ é…ç½®åŒæ­¥ â†’ çˆ¬è™«æ‰§è¡Œ
   - æ¨¡æ‹Ÿ Worker é‡å¯åœºæ™¯ï¼ŒéªŒè¯é…ç½®æŒä¹…åŒ–

---

**æ–‡æ¡£æ—¶é—´**ï¼š2025-10-24 19:15
**æ–‡æ¡£ä½œè€…**ï¼šClaude Code
**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0
