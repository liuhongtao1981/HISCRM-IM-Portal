# 登录检测选择器优化 - 最终版

## 优化时间
2025-10-24 14:30

## 问题背景

之前的登录检测逻辑使用了过于宽泛的选择器，导致误将页面上的其他头像元素当成用户登录头像，造成误报。

### 误报场景
```javascript
// ❌ 旧的选择器（太宽泛）
const avatarSelectors = [
  '#header-avatar > div',
  '#header-avatar',
  'header [class*="avatar"]',    // ← 会匹配页面任何包含 avatar 的元素
  '.header [class*="avatar"]',
];
```

**问题**：选择器 `header [class*="avatar"]` 会匹配到页面内容中的装饰性头像，而不仅仅是用户登录头像。

## 解决方案

使用 **Playwright MCP Chrome DevTools** 精确定位页面元素，获取准确的 CSS 选择器。

### 使用 Chrome DevTools 定位元素

1. **打开抖音创作者中心**：
   ```javascript
   await page.goto('https://creator.douyin.com/creator-micro/home');
   ```

2. **用户提供准确的选择器**：
   ```
   #garfish_app_for_douyin_creator_pc_home_9y9g9kep > div > div:nth-child(2) > div > div.content-z4oZvZ > div.container-vEyGlK
   ```

3. **通过 page.evaluate 提取用户信息**：
   ```javascript
   const result = await page.evaluate(() => {
     const selector = 'div.container-vEyGlK';
     const container = document.querySelector(selector);

     const textContent = container.textContent;
     const douyinIdMatch = textContent.match(/抖音号：(\d+)/);
     const avatarImg = container.querySelector('img');

     return {
       hasDouyinId: !!douyinIdMatch,
       douyinId: douyinIdMatch ? douyinIdMatch[1] : null,
       hasAvatar: !!avatarImg,
       avatarSrc: avatarImg ? avatarImg.src : null
     };
   });
   ```

### 提取到的用户信息

```json
{
  "found": true,
  "textContent": "宁静致远抖音号：95759617533☎️①⑧⑥🤔④⑤⓪③😊②⑤⓪⑤\n尊重生命，好好告别关注 110粉丝 416获赞 2219",
  "hasDouyinId": true,
  "douyinId": "95759617533",
  "nickname": "宁静致远",
  "hasAvatar": true,
  "avatarSrc": "https://p11.douyinpic.com/aweme/100x100/aweme-avatar/tos-cn-i-0813c000-ce_oobd56AuIECv2UAEPfoARDlEyQgCeWAfwA1FG9.jpeg?from=2956013662"
}
```

### 精确的 DOM 结构

```html
<div class="container-vEyGlK">
  <div class="avatar-XoPjK6">
    <img class="img-PeynF_" src="https://p11.douyinpic.com/...">
  </div>
  <div class="content-fFY6HC">
    <div class="header-_F2uzl">
      <div class="left-zEzdJX">
        <div class="name-_lSSDc">宁静致远</div>
        <div class="accountIdentityTags-QWXxCC"></div>
      </div>
      <div class="unique_id-EuH8eA">抖音号：95759617533</div>
      <div class="signature-HLGxt7">☎️①⑧⑥🤔④⑤⓪③😊②⑤⓪⑤ 尊重生命，好好告别</div>
    </div>
    <!-- 关注、粉丝、获赞数据 -->
  </div>
</div>
```

## 优化后的选择器

### 1. 用户信息容器
```javascript
const userContainerSelectors = [
  'div.container-vEyGlK',        // ✓ 精确 class（Chrome DevTools 确认）
  'div[class*="container-"]',    // 模糊匹配（防止 class 名变化）
];
```

### 2. 抖音号元素
```javascript
const douyinIdSelectors = [
  'div.unique_id-EuH8eA',        // ✓ 精确 class（Chrome DevTools 确认）
  'div[class*="unique_id-"]',    // 模糊匹配
];
```

### 3. 用户头像
```javascript
const avatarSelectors = [
  'div.avatar-XoPjK6 img',       // ✓ 精确路径（Chrome DevTools 确认）
  'img.img-PeynF_',              // ✓ 精确 class（Chrome DevTools 确认）
  'div[class*="avatar-"] img[src*="douyinpic.com"]',  // CDN 验证
];
```

### 4. 用户昵称
```javascript
const nicknameSelectors = [
  'div.name-_lSSDc',             // ✓ 精确 class（Chrome DevTools 确认）
  '[class*="name-"]',            // 模糊匹配
];
```

## 新的 checkLoginStatus 方法

### 检测策略（三层验证）

```javascript
async checkLoginStatus(page) {
  // 等待页面加载
  await page.waitForTimeout(2000);

  // 方法1: 检查用户信息容器（最可靠）
  const container = await page.$('div.container-vEyGlK');
  if (container && await container.isVisible()) {
    const text = await container.textContent();
    if (text && text.includes('抖音号：')) {
      return true; // ✓ 已登录
    }
  }

  // 方法2: 检查抖音号元素
  const douyinIdElement = await page.$('div.unique_id-EuH8eA');
  if (douyinIdElement && await douyinIdElement.isVisible()) {
    const text = await douyinIdElement.textContent();
    if (text && text.includes('抖音号：')) {
      return true; // ✓ 已登录
    }
  }

  // 方法3: 检查用户头像（特定位置）
  const avatar = await page.$('div.avatar-XoPjK6 img');
  if (avatar && await avatar.isVisible()) {
    const src = await avatar.getAttribute('src');
    if (src && src.includes('douyinpic.com')) {
      return true; // ✓ 已登录
    }
  }

  return false; // ✗ 未登录
}
```

### 优势

1. **✓ 精确定位**：使用 Chrome DevTools 确认的准确选择器
2. **✓ 三层验证**：容器 + 抖音号 + 头像，逐层验证
3. **✓ 防止误报**：只检查特定位置的用户信息容器
4. **✓ 防止 class 变化**：同时提供精确和模糊匹配选择器

## 与测试结果对比

### 测试数据（2025-10-24 14:29）
```json
{
  "status": "success",
  "user_info": {
    "avatar": "https://p3.douyinpic.com/aweme/720x720/aweme-avatar/tos-cn-avt-0015_21b4383e542b8991bcd33d33eeda7d8d.jpeg?from=2956013662",
    "nickname": "抖音创作者中心·创作者",
    "douyin_id": null
  }
}
```

**问题**：
- ❌ 昵称错误："抖音创作者中心·创作者"（页面标题）而不是 "宁静致远"
- ❌ 抖音号缺失：应该是 "95759617533"
- ❌ 头像不匹配：不同的 CDN 地址

### Chrome DevTools 实际数据
```json
{
  "nickname": "宁静致远",           // ✓ 正确
  "douyinId": "95759617533",       // ✓ 正确
  "avatarSrc": "https://p11.douyinpic.com/aweme/100x100/..." // ✓ 正确
}
```

## 结论

**原因分析**：
1. 旧的选择器太宽泛，匹配到页面其他元素
2. 没有精确定位用户信息容器的位置
3. 依赖 URL 和页面文本判断，容易误判

**解决方案**：
1. ✅ 使用 Chrome DevTools 精确定位元素
2. ✅ 使用特定 class 名称（container-vEyGlK, unique_id-EuH8eA, avatar-XoPjK6）
3. ✅ 三层验证机制（容器 + 抖音号 + 头像）
4. ✅ 验证文本内容（"抖音号："）和 CDN 域名（"douyinpic.com"）

## 下一步

1. 重启 Worker 进程加载新代码
2. 运行登录测试验证
3. 确认不再出现误报
4. 测试未登录状态的登录流程

## 相关文件

- `packages/worker/src/platforms/douyin/platform.js:174-263` - checkLoginStatus 方法
- `packages/worker/src/platforms/douyin/platform.js:573-668` - extractUserInfo 方法
- `docs/登录功能简化版测试报告.md` - 之前的测试报告
- `docs/登录检测逻辑-最终简化版.md` - 简化方案设计文档

## 参考

- Chrome DevTools 检查元素：`Ctrl+Shift+C`（Windows）或 `Cmd+Shift+C`（Mac）
- Playwright MCP 工具：`mcp__playwright__browser_navigate`、`mcp__playwright__browser_evaluate`
- CSS 选择器参考：https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Selectors
