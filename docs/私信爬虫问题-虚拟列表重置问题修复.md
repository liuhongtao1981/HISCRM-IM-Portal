# 私信爬虫问题 - 虚拟列表重置问题修复

## 时间: 2025-11-05 11:10

## 问题发现

在实施"滚动到底部方案"后,发现了新问题:

### 执行结果(11:03:43 这轮爬取)

- ✅ **成功**: 前 16 个会话(索引 0-15)成功打开并提取消息
- ❌ **失败**: 从索引 16 开始,所有会话点击超时("element is not visible")

### 日志分析

**滚动日志**:
```log
11:03:45 - [scrollConversationListToLoadAll] ✅ 滚动完成，共加载 32 个会话
11:03:49 - [scrollConversationListToLoadAll] ⚠️ 保持在底部位置，不滚动回顶部
```
- ✅ 32 个会话加载成功
- ✅ 没有滚动回顶部
- ❌ `foundEndMarker=false` (未检测到"没有更多了",但数量稳定)

**点击日志**:
```log
11:06:19 - [openConversationByIndex] Error: locator('[role="list-item"]').nth(16)
11:06:19 - element is not visible
11:06:29 - [openConversationByIndex] Error: locator('[role="list-item"]').nth(17)
11:06:29 - element is not visible
```
- 索引 0-15: 成功 ✅
- 索引 16+: 失败 ❌ (element is not visible)

## 根本原因

### 虚拟列表的行为

1. **初始滚动**: 滚动到底部加载所有会话 → 32 个会话都在 DOM 中
2. **点击第 1 个会话**: 打开消息详情
3. **返回列表**: 点击返回按钮
4. ⚠️ **问题**:虚拟列表**自动重置到顶部显示位置**!

**虚拟列表重置后**:
- 只渲染顶部 ~16 个会话(索引 0-15)
- 索引 16+ 的会话不在可见区域,虽然在 DOM 中,但被标记为"not visible"

### 为什么前 16 个成功?

因为这 16 个会话在虚拟列表重置后**仍然可见**。

### 为什么后面的失败?

虚拟列表重置后,后面的会话虽然在 DOM 中,但不在**可见区域**,Playwright 的 `click()` 需要元素**可见**。

## 解决方案

### 关键修复: 每次点击前滚动到目标位置

**文件**: `packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js`
**位置**: Line 760-790

**核心思路**:
- 在点击会话前,先滚动会话列表到目标索引的位置
- 让虚拟列表渲染目标会话,使其可见
- 然后再点击

**代码实现**:

```javascript
// 第 1.5 步: ⚠️ 关键修复 - 滚动会话列表,让目标会话可见
// 问题: 返回列表后虚拟列表会重置到顶部,索引 >= 16 的会话不可见
// 解决: 在点击前,滚动列表到目标位置
logger.debug(`[openConversationByIndex] Step 1.5: Scrolling conversation list to show index ${conversationIndex}`);

const estimatedItemHeight = 80; // 每个会话项约 80px
const targetScrollTop = conversationIndex * estimatedItemHeight;

const scrollResult = await page.evaluate((scrollTop) => {
  const listContainer =
    document.querySelector('[role="list"]') ||
    document.querySelector('.conversation-list') ||
    document.querySelector('[class*="conversationList"]') ||
    document.querySelector('[class*="ChatList"]') ||
    document.querySelector('[class*="list"]');

  if (listContainer) {
    listContainer.scrollTop = scrollTop;
    return { success: true, scrollTop: listContainer.scrollTop };
  }
  return { success: false };
}, targetScrollTop);

if (scrollResult.success) {
  logger.debug(`[DEBUG openConversationByIndex] Scrolled list to position ${scrollResult.scrollTop}`);
} else {
  logger.warn(`[DEBUG openConversationByIndex] Failed to scroll list`);
}

// 等待虚拟列表渲染目标会话
await page.waitForTimeout(800);
```

**关键参数**:
- `estimatedItemHeight = 80` - 每个会话项的估计高度
- `targetScrollTop = index * 80` - 计算目标滚动位置
- `waitForTimeout(800)` - 等待虚拟列表渲染

## 完整流程

### 修复前的流程(失败)

1. 初始滚动到底部 → 32 个会话在 DOM 中
2. 点击会话 0 → 成功
3. 返回列表 → **虚拟列表重置到顶部**(只显示 0-15)
4. 点击会话 1 → 成功(在可见区域)
5. ...
6. 点击会话 15 → 成功(在可见区域)
7. 点击会话 16 → ❌ 失败(不在可见区域)

### 修复后的流程(预期成功)

1. 初始滚动到底部 → 32 个会话在 DOM 中
2. 点击会话 0 → 成功
3. 返回列表 → 虚拟列表重置到顶部
4. **滚动到会话 1 的位置** → 等待 800ms
5. 点击会话 1 → 成功
6. ...
7. 返回列表 → 虚拟列表重置到顶部
8. **滚动到会话 16 的位置** → 等待 800ms
9. 点击会话 16 → ✅ 成功(已滚动到可见区域)

## 预期效果

修复后,预期:

1. ✅ **所有 32 个会话都能成功打开**
2. ✅ **每次点击前都会滚动到正确位置**
3. ✅ **消息提取数量 > 0**

### 成功日志标志

```log
[openConversationByIndex] Step 1.5: Scrolling conversation list to show index 16
[DEBUG openConversationByIndex] Scrolled list to position 1280
[DEBUG openConversationByIndex] Clicking element...
[openConversationByIndex] ✅ Successfully opened conversation at index 16: XXX
[crawlCompleteMessageHistory] Step 0: Waiting for RIGHT-SIDE message panel to load...
```

### 最终结果预期

```log
[crawlDirectMessages] Phase 8 completed: X messages, 32 conversations (X > 0)
```

## 对比总结

| 方案 | 初始滚动 | 点击前操作 | 结果 |
|------|---------|-----------|------|
| 方案 1 | 无 | `scrollIntoViewIfNeeded()` | ❌ 超时 |
| 方案 2 | 到底部 + **回顶部** | 无 | ❌ 索引失效 |
| 方案 3 | 到底部 + **不回顶部** | 无 | ❌ 虚拟列表重置 |
| **最终方案** | 到底部 + **不回顶部** | **每次滚动到目标位置** | ✅ 预期成功 |

## 核心洞察

**虚拟列表的完整行为**:
1. 滚动到底部 → 所有元素加载到 DOM
2. **但每次返回列表,虚拟列表会重置显示位置到顶部**
3. 重置后,只有顶部 ~16 个元素可见
4. 需要在每次点击前,滚动到目标元素的位置

**用户建议的完整实现**:
- ✅ 滚动到底部加载所有会话
- ✅ 不滚动回顶部保持所有会话在 DOM
- ✅ **每次点击前滚动到目标位置**(这是关键补充!)

## 下一步

等待当前轮次爬虫执行完成(11:03 开始的那轮),查看是否仍然 0 消息。

然后 Worker 会自动重启或等待下一轮爬取(约 4-5 分钟后),验证新修复效果。

## 相关文件

- `packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js` (Line 760-790)
- `docs/私信爬虫问题-滚动到底部方案.md` (初始方案)
