# 登录检测逻辑 - 最终简化版

生成时间：2025-10-24 14:30

## 核心设计理念

**统一使用新 tab 检测登录状态**
- 简单
- 可靠
- 不干扰用户操作

## 完整流程

```
Admin Web 触发登录检测
         ↓
    startLogin()
         ↓
   创建新 tab (checkPage)
         ↓
  导航到创作中心首页
  (creator-micro/home)
         ↓
  等待页面加载 (3秒)
         ↓
   检测登录状态
   (checkLoginStatus)
         ↓
    检查用户头像
         ↓
  ┌──────┴──────┐
  │             │
找到头像      未找到头像
(已登录)       (未登录)
  │             │
  │             │
提取用户信息    │
  │             │
关闭 tab      关闭 tab
  │             │
  ↓             ↓
返回 Master:   返回 Master:
- status: success  - status: not_logged_in
- user_info        - session_id
- session_id
```

## 代码实现

### 1. startLogin() 方法

**文件**：`packages/worker/src/platforms/douyin/platform.js`
**行号**：50-140

**核心逻辑**：
```javascript
async startLogin(options) {
  const { accountId, sessionId, proxy } = options;

  // 1. 确保浏览器上下文有效
  const context = await this.ensureAccountContext(accountId, proxy);

  // 2. 创建新 tab 用于检测
  const checkPage = await context.newPage();

  try {
    // 3. 导航到创作中心首页
    await checkPage.goto('https://creator.douyin.com/creator-micro/home', {
      waitUntil: 'networkidle',
      timeout: 30000
    });

    // 4. 等待页面加载
    await checkPage.waitForTimeout(3000);

    // 5. 截图（用于调试）
    await this.takeScreenshot(accountId, `login_check_${Date.now()}.png`);

    // 6. 检测登录状态
    const isLoggedIn = await this.checkLoginStatus(checkPage);

    if (isLoggedIn) {
      // 已登录
      const userInfo = await this.extractUserInfo(checkPage);
      await checkPage.close();

      await this.sendLoginStatus(sessionId, 'success', {
        account_id: accountId,
        user_info: userInfo,
        session_id: sessionId,
        message: '账户已登录',
      });

      return { status: 'success', userInfo };
    } else {
      // 未登录
      await checkPage.close();

      await this.sendLoginStatus(sessionId, 'not_logged_in', {
        account_id: accountId,
        session_id: sessionId,
        message: '账户未登录',
      });

      return { status: 'not_logged_in' };
    }
  } finally {
    // 确保 tab 被关闭
    try { await checkPage.close(); } catch (e) {}
  }
}
```

### 2. checkLoginStatus() 方法

**文件**：`packages/worker/src/platforms/douyin/platform.js`
**行号**：142-182

**核心逻辑**：
```javascript
async checkLoginStatus(page) {
  logger.info('Checking for user avatar...');

  // 用户头像选择器（只检测顶部导航栏）
  const avatarSelectors = [
    '#header-avatar > div',        // 顶部导航栏
    '#header-avatar',
    'header [class*="avatar"]',    // 在 header 标签内
    '.header [class*="avatar"]',   // 在 header 类内
  ];

  for (const selector of avatarSelectors) {
    const avatar = await page.$(selector);
    if (avatar && await avatar.isVisible()) {
      logger.info(`✓ Found user avatar with selector: ${selector}`);
      return true; // 已登录
    }
  }

  logger.info('✗ No user avatar found - not logged in');
  return false; // 未登录
}
```

## 返回给 Master 的数据

### 场景1：已登录

```javascript
{
  status: 'success',
  account_id: 'acc-xxx',
  user_info: {
    nickname: '抖音创作者',
    douyin_id: '123456789',
    followers: 1000,
    has_avatar: true
  },
  session_id: 'session-xxx',
  message: '账户已登录',
  timestamp: 1761285387663
}
```

### 场景2：未登录

```javascript
{
  status: 'not_logged_in',
  account_id: 'acc-xxx',
  session_id: 'session-xxx',
  message: '账户未登录',
  timestamp: 1761285387663
}
```

## 关键特性

### ✅ 优点

1. **逻辑简单**
   - 统一流程，无需判断场景
   - 代码量少，易于维护

2. **可靠性高**
   - 只检查顶部导航栏头像
   - 不依赖 URL 判断（避免误判）

3. **不干扰用户**
   - 使用新 tab 检测
   - 检测完立即关闭
   - 不影响原页面

4. **易于调试**
   - 每次检测都截图
   - 清晰的日志输出

### ⚠️ 注意事项

1. **Tab 管理**
   - 必须在 finally 中关闭 tab
   - 避免 tab 泄漏

2. **等待时间**
   - 创作中心首页需要 3 秒加载
   - 确保头像元素已渲染

3. **错误处理**
   - 检测失败时关闭 tab
   - 默认认为未登录

## 与 Master 的交互

### Master 如何使用

```javascript
// Admin Web 触发登录检测
socket.emit('master:login:start', {
  account_id: 'acc-xxx',
  worker_id: 'worker1',
  session_id: 'session-xxx'
});

// 监听登录状态更新
socket.on('login:status:update', (data) => {
  if (data.status === 'success') {
    console.log('已登录:', data.user_info);
    // 显示用户信息
  } else if (data.status === 'not_logged_in') {
    console.log('未登录，需要扫码');
    // 显示登录界面（二维码）
  }
});
```

## 未来扩展

如果需要显示二维码登录，可以扩展为：

```javascript
if (isLoggedIn) {
  // 已登录逻辑...
} else {
  // 未登录：在原页面显示登录界面
  const mainPage = await this.getAccountPage(accountId);
  await mainPage.goto('https://creator.douyin.com/');

  // 检测登录方式（二维码/SMS）
  const loginMethod = await this.detectLoginMethod(mainPage);

  if (loginMethod.type === 'qrcode') {
    // 显示二维码
    await this.handleQRCodeLogin(...);
  }
}
```

## 测试场景

### 场景1：首次检测（未登录）
```
1. Admin Web 点击"登录检测"
2. Worker 创建新 tab
3. 导航到创作中心首页
4. 未找到头像
5. 关闭 tab
6. 返回 'not_logged_in'
7. Admin Web 收到未登录状态
```

**预期结果**：
- ✅ 返回 `status: 'not_logged_in'`
- ✅ Tab 已关闭
- ✅ 不影响其他页面

### 场景2：检测已登录账户
```
1. 用户已完成登录
2. Admin Web 点击"登录检测"
3. Worker 创建新 tab
4. 导航到创作中心首页
5. 找到头像
6. 提取用户信息
7. 关闭 tab
8. 返回 'success' + user_info
```

**预期结果**：
- ✅ 返回 `status: 'success'`
- ✅ 包含完整用户信息
- ✅ Tab 已关闭

### 场景3：网络延迟
```
1. 创建新 tab
2. 导航到创作中心（加载慢）
3. 等待 3 秒
4. 页面加载完成
5. 检测头像
```

**预期结果**：
- ✅ 3 秒足够页面加载
- ✅ 正确检测登录状态

## 日志示例

### 已登录的日志
```
[douyin-platform] Starting Douyin login for account acc-xxx, session session-xxx
[douyin-platform] Creating new tab to check login status...
[douyin-platform] Navigating to Douyin Creator Center home page...
[douyin-platform] Checking login status...
[douyin-platform] Checking for user avatar...
[douyin-platform] ✓ Found user avatar with selector: #header-avatar > div
[douyin-platform] ✓ Account acc-xxx is already logged in
[douyin-platform] Extracted user info: {"nickname":"抖音创作者","douyin_id":"123456789",...}
```

### 未登录的日志
```
[douyin-platform] Starting Douyin login for account acc-xxx, session session-xxx
[douyin-platform] Creating new tab to check login status...
[douyin-platform] Navigating to Douyin Creator Center home page...
[douyin-platform] Checking login status...
[douyin-platform] Checking for user avatar...
[douyin-platform] ✗ No user avatar found - not logged in
[douyin-platform] ✗ Account acc-xxx is NOT logged in
```

## 总结

这个简化版本的登录检测逻辑：

1. **统一流程** - 始终创建新 tab 检测
2. **只检查头像** - 最可靠的登录状态判断
3. **返回明确结果** - 已登录/未登录
4. **资源管理良好** - 确保 tab 被关闭
5. **易于维护** - 代码简单清晰

相比之前复杂的多场景判断，这个版本更加简洁可靠。
