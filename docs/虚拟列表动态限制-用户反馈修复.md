# è™šæ‹Ÿåˆ—è¡¨åŠ¨æ€é™åˆ¶ - ç”¨æˆ·åé¦ˆä¿®å¤

## æ—¶é—´: 2025-11-05 15:00

## ç”¨æˆ·åé¦ˆ

> "è¿™ä¸ª18ä¸è¦æ˜¯å›ºå®šæ•°ç›®ï¼Œä»–è‚¯å®šæ˜¯æ ¹æ®ç¬¬ä¸€æ¬¡æ‰“å¼€è™šè¡¨å†…çš„ä¸ªæ•°ï¼Œè·Ÿæˆ‘è¦ç‚¹å‡»çš„ä¸ªæ•°æ¯”è¾ƒæ¥åˆ¤æ–­æ˜¯å¦å¯ä»¥ç‚¹å‡»äº†ï¼Œé€»è¾‘ä½ åˆšæ‰éƒ½å·²ç»æ¨æµ‹äº†ï¼Œå› ä¸ºä¸åŒåˆ†è¾¨ç‡ä¸€é¡µçš„å…ƒç´ ä¸æ˜¯å›ºå®šçš„"

---

## é—®é¢˜åˆ†æ

### åŸæœ‰é€»è¾‘ï¼ˆé”™è¯¯ï¼‰

**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js`

**Line 1095-1100 (ä¿®å¤å‰)**:
```javascript
// âš ï¸ ä¸´æ—¶ç¦ç”¨æ»šåŠ¨é€»è¾‘ - åªå¤„ç†å‰18ä¸ªå¯è§ä¼šè¯
// åŸå› ï¼šæ»šåŠ¨ä¼šå¯¼è‡´å¡ä½ï¼Œå…ˆç¡®ä¿åŸºæœ¬åŠŸèƒ½æ­£å¸¸
if (conversationIndex >= 18) {
  logger.warn(`[openConversationByIndex] Index ${conversationIndex} >= 18, skipping (virtual list limit)`);
  return false;
}
```

**é—®é¢˜**:
- âŒ å›ºå®šæ•°å­— **18** æ˜¯ç¡¬ç¼–ç 
- âŒ ä¸åŒåˆ†è¾¨ç‡ä¸‹ï¼Œè™šæ‹Ÿåˆ—è¡¨å¯è§å…ƒç´ æ•°é‡ä¸åŒï¼š
  - 1920x1080: çº¦ 18-19 ä¸ª
  - 1366x768: çº¦ 17 ä¸ª
  - 2560x1440: çº¦ 32 ä¸ª
- âŒ å›ºå®šé™åˆ¶ä¼šå¯¼è‡´æŸäº›åˆ†è¾¨ç‡ä¸‹æ— æ³•å¤„ç†æ‰€æœ‰å¯è§ä¼šè¯

### æ ¹æœ¬åŸå› 

**æŠ–éŸ³è™šæ‹Ÿåˆ—è¡¨ç‰¹æ€§**:
1. åªæ¸²æŸ“**å¯è§åŒºåŸŸ**çš„ä¼šè¯å…ƒç´ ï¼ˆDOM ä¼˜åŒ–ï¼‰
2. å¯è§åŒºåŸŸå¤§å° = `çª—å£é«˜åº¦ / å•ä¸ªä¼šè¯é«˜åº¦`
3. ä¸åŒåˆ†è¾¨ç‡ â†’ ä¸åŒçš„å¯è§å…ƒç´ æ•°é‡

**å·²æœ‰çš„æ­£ç¡®é€»è¾‘**:

**Line 580-585**:
```javascript
// âš ï¸ å…³é”®ä¿®å¤: è·å–DOMä¸­å®é™…å­˜åœ¨çš„ä¼šè¯æ•°é‡
// é—®é¢˜: APIå¯èƒ½è¿”å›220ä¸ªä¼šè¯,ä½†è™šæ‹Ÿåˆ—è¡¨åªæ¸²æŸ“32ä¸ª
// è§£å†³: åªå¤„ç†DOMä¸­å®é™…å­˜åœ¨çš„ä¼šè¯
const domConversationsCount = await page.evaluate(() => {
  return document.querySelectorAll('[role="list-item"]').length;
});

const conversationsToProcess = Math.min(conversations.length, domConversationsCount);
logger.info(`[Phase 8] APIè¿”å› ${conversations.length} ä¸ªä¼šè¯, DOMä¸­æœ‰ ${domConversationsCount} ä¸ª, å°†å¤„ç†å‰ ${conversationsToProcess} ä¸ª`);
```

âœ… è¿™é‡Œå·²ç»åŠ¨æ€è·å–äº† `domConversationsCount`ï¼ˆè™šæ‹Ÿåˆ—è¡¨å®é™…æ¸²æŸ“çš„å…ƒç´ æ•°é‡ï¼‰

**ç¼ºå¤±çš„ç¯èŠ‚**:
- âŒ `domConversationsCount` æ²¡æœ‰ä¼ é€’ç»™ `openConversationByIndex()` å‡½æ•°
- âŒ `openConversationByIndex()` ä½¿ç”¨å›ºå®šçš„ 18 è¿›è¡Œåˆ¤æ–­

---

## ä¿®å¤æ–¹æ¡ˆ

### ç›®æ ‡

å°† `domConversationsCount`ï¼ˆè™šæ‹Ÿåˆ—è¡¨å®é™…å¯è§å…ƒç´ æ•°é‡ï¼‰ä¼ é€’ç»™ç‚¹å‡»å‡½æ•°ï¼ŒåŠ¨æ€åˆ¤æ–­æ˜¯å¦éœ€è¦æ»šåŠ¨ã€‚

### å®ç°æ­¥éª¤

#### æ­¥éª¤1: ä¿®æ”¹å‡½æ•°ç­¾å

**Line 1067-1074**: æ·»åŠ  `totalVisibleConversations` å‚æ•°

**ä¿®å¤å‰**:
```javascript
async function openConversationByIndex(page, conversation, conversationIndex) {
  logger.debug(`[openConversationByIndex] Opening conversation: ${conversation.platform_user_name} (index: ${conversationIndex})`);
```

**ä¿®å¤å**:
```javascript
/**
 * @param {Page} page - Playwright é¡µé¢å¯¹è±¡
 * @param {Object} conversation - ä¼šè¯å¯¹è±¡
 * @param {number} conversationIndex - ä¼šè¯ç´¢å¼•
 * @param {number} totalVisibleConversations - DOMä¸­å®é™…å¯è§çš„ä¼šè¯æ€»æ•°ï¼ˆè™šæ‹Ÿåˆ—è¡¨é™åˆ¶ï¼‰
 */
async function openConversationByIndex(page, conversation, conversationIndex, totalVisibleConversations) {
  logger.debug(`[openConversationByIndex] Opening conversation: ${conversation.platform_user_name} (index: ${conversationIndex}, visible: ${totalVisibleConversations})`);
```

#### æ­¥éª¤2: åŠ¨æ€åˆ¤æ–­é€»è¾‘

**Line 1101-1108**: ä½¿ç”¨åŠ¨æ€æ•°é‡æ›¿æ¢å›ºå®šæ•°å­—

**ä¿®å¤å‰**:
```javascript
if (conversationIndex >= 18) {
  logger.warn(`[openConversationByIndex] Index ${conversationIndex} >= 18, skipping (virtual list limit)`);
  return false;
}
```

**ä¿®å¤å**:
```javascript
// âœ… åŠ¨æ€åˆ¤æ–­ï¼šæ ¹æ®è™šæ‹Ÿåˆ—è¡¨å®é™…å¯è§å…ƒç´ æ•°é‡æ¥å†³å®šæ˜¯å¦éœ€è¦æ»šåŠ¨
// åŸå› ï¼šä¸åŒåˆ†è¾¨ç‡ä¸‹ï¼Œè™šæ‹Ÿåˆ—è¡¨çš„å¯è§å…ƒç´ æ•°é‡ä¸åŒï¼ˆä»17åˆ°32éƒ½æœ‰å¯èƒ½ï¼‰
// ç”¨æˆ·åé¦ˆï¼šæ»šåŠ¨ä¼šå¯¼è‡´å¡ä½ï¼Œæš‚æ—¶åªå¤„ç†å¯è§çš„ä¼šè¯
if (conversationIndex >= totalVisibleConversations) {
  logger.warn(`[openConversationByIndex] Index ${conversationIndex} >= ${totalVisibleConversations} (virtual list limit), skipping`);
  logger.warn(`[openConversationByIndex] æç¤º: å½“å‰è™šæ‹Ÿåˆ—è¡¨åªæ¸²æŸ“äº†å‰ ${totalVisibleConversations} ä¸ªä¼šè¯ï¼Œè¶…å‡ºéƒ¨åˆ†éœ€è¦æ»šåŠ¨åŠ è½½ï¼ˆæš‚æœªå®ç°ï¼‰`);
  return false;
}
```

#### æ­¥éª¤3: è°ƒç”¨æ—¶ä¼ å‚

**Line 594**: ä¼ å…¥ `domConversationsCount`

**ä¿®å¤å‰**:
```javascript
const opened = await openConversationByIndex(page, conversation, i);
```

**ä¿®å¤å**:
```javascript
// âœ… ä¼ å…¥è™šæ‹Ÿåˆ—è¡¨å¯è§å…ƒç´ æ•°é‡ï¼ŒåŠ¨æ€åˆ¤æ–­æ˜¯å¦éœ€è¦æ»šåŠ¨
const opened = await openConversationByIndex(page, conversation, i, domConversationsCount);
```

---

## ä¿®å¤æ•ˆæœ

### åœºæ™¯1: å°åˆ†è¾¨ç‡ (1366x768)

**è™šæ‹Ÿåˆ—è¡¨å¯è§å…ƒç´ **: 17 ä¸ª

**ä¿®å¤å‰**:
```log
[Phase 8] APIè¿”å› 220 ä¸ªä¼šè¯, DOMä¸­æœ‰ 17 ä¸ª, å°†å¤„ç†å‰ 17 ä¸ª
[openConversationByIndex] Processing visible conversation at index 0  âœ…
[openConversationByIndex] Processing visible conversation at index 1  âœ…
...
[openConversationByIndex] Processing visible conversation at index 16 âœ…
[openConversationByIndex] Processing visible conversation at index 17 âŒ (å› ä¸º 17 < 18ï¼Œå®é™…ä¼šæ‰§è¡Œ)
```

é—®é¢˜ï¼šç¬¬ 17 ä¸ªä¼šè¯ï¼ˆç´¢å¼• 17ï¼‰å®é™…ä¸Šä¸å­˜åœ¨ï¼ˆDOM åªæœ‰ 0-16ï¼‰ï¼Œä½†å› ä¸º 17 < 18 æ‰€ä»¥ä¼šå°è¯•ç‚¹å‡»ï¼Œå¯¼è‡´å¤±è´¥ã€‚

**ä¿®å¤å**:
```log
[Phase 8] APIè¿”å› 220 ä¸ªä¼šè¯, DOMä¸­æœ‰ 17 ä¸ª, å°†å¤„ç†å‰ 17 ä¸ª
[openConversationByIndex] Opening conversation: ä¼šè¯0 (index: 0, visible: 17)  âœ…
[openConversationByIndex] Opening conversation: ä¼šè¯1 (index: 1, visible: 17)  âœ…
...
[openConversationByIndex] Opening conversation: ä¼šè¯16 (index: 16, visible: 17) âœ…
å¾ªç¯åœ¨ i=17 æ—¶ä¸ä¼šæ‰§è¡Œï¼ˆå› ä¸º conversationsToProcess = 17ï¼‰
```

### åœºæ™¯2: ä¸­ç­‰åˆ†è¾¨ç‡ (1920x1080)

**è™šæ‹Ÿåˆ—è¡¨å¯è§å…ƒç´ **: 18-19 ä¸ª

**ä¿®å¤å‰**:
```log
[Phase 8] DOMä¸­æœ‰ 19 ä¸ª
[openConversationByIndex] Index 18 >= 18, skipping âŒ
```

é—®é¢˜ï¼šç¬¬ 18 ä¸ªä¼šè¯ï¼ˆç´¢å¼• 18ï¼‰å®é™…å­˜åœ¨ï¼Œä½†è¢«é”™è¯¯åœ°è·³è¿‡ã€‚

**ä¿®å¤å**:
```log
[Phase 8] DOMä¸­æœ‰ 19 ä¸ª
[openConversationByIndex] Opening conversation: ä¼šè¯18 (index: 18, visible: 19) âœ…
```

### åœºæ™¯3: å¤§åˆ†è¾¨ç‡ (2560x1440)

**è™šæ‹Ÿåˆ—è¡¨å¯è§å…ƒç´ **: 32 ä¸ª

**ä¿®å¤å‰**:
```log
[Phase 8] DOMä¸­æœ‰ 32 ä¸ª, å°†å¤„ç†å‰ 32 ä¸ª
[openConversationByIndex] Processing visible conversation at index 17 âœ…
[openConversationByIndex] Index 18 >= 18, skipping âŒ
[openConversationByIndex] Index 19 >= 18, skipping âŒ
...
[openConversationByIndex] Index 31 >= 18, skipping âŒ
```

é—®é¢˜ï¼šç´¢å¼• 18-31 çš„ä¼šè¯ï¼ˆå…± 14 ä¸ªï¼‰å…¨éƒ¨è¢«è·³è¿‡ï¼Œå®é™…åªå¤„ç†äº† 18 ä¸ªä¼šè¯ã€‚

**ä¿®å¤å**:
```log
[Phase 8] DOMä¸­æœ‰ 32 ä¸ª, å°†å¤„ç†å‰ 32 ä¸ª
[openConversationByIndex] Opening conversation: ä¼šè¯0 (index: 0, visible: 32)  âœ…
[openConversationByIndex] Opening conversation: ä¼šè¯1 (index: 1, visible: 32)  âœ…
...
[openConversationByIndex] Opening conversation: ä¼šè¯31 (index: 31, visible: 32) âœ…
```

âœ… æ‰€æœ‰ 32 ä¸ªå¯è§ä¼šè¯éƒ½æ­£ç¡®å¤„ç†ï¼

---

## ä»£ç æ”¹åŠ¨æ€»ç»“

### æ”¹åŠ¨æ–‡ä»¶

`packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js`

### æ”¹åŠ¨è¯¦æƒ…

| è¡Œå· | æ”¹åŠ¨ç±»å‹ | è¯´æ˜ |
|------|---------|------|
| 1067-1074 | ä¿®æ”¹å‡½æ•°ç­¾å | æ·»åŠ  `totalVisibleConversations` å‚æ•° |
| 1101-1108 | ä¿®æ”¹åˆ¤æ–­é€»è¾‘ | ç”¨åŠ¨æ€å€¼æ›¿æ¢å›ºå®šæ•°å­— 18 |
| 594 | ä¿®æ”¹å‡½æ•°è°ƒç”¨ | ä¼ å…¥ `domConversationsCount` |

**æ€»è®¡**: 3 å¤„æ”¹åŠ¨ï¼Œçº¦ 15 è¡Œä»£ç 

---

## éªŒè¯æ­¥éª¤

### æ­¥éª¤1: æ£€æŸ¥æ—¥å¿—è¾“å‡º

ç­‰å¾…ä¸‹æ¬¡çˆ¬è™«æ‰§è¡Œï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š

```bash
tail -f packages/worker/logs/crawl-direct-messages-v2.log
```

### æ­¥éª¤2: éªŒè¯åŠ¨æ€é™åˆ¶

**é¢„æœŸæ—¥å¿—**:
```log
[Phase 8] APIè¿”å› 220 ä¸ªä¼šè¯, DOMä¸­æœ‰ 19 ä¸ª, å°†å¤„ç†å‰ 19 ä¸ª
[openConversationByIndex] Opening conversation: ğŸŒˆå˜‰Â¹Â² (index: 0, visible: 19)
[openConversationByIndex] Opening conversation: é’±è¢‹å­ (index: 1, visible: 19)
...
[openConversationByIndex] Opening conversation: æè‰³ (index: 18, visible: 19)
```

**å…³é”®éªŒè¯ç‚¹**:
- âœ… `visible: 19` æ˜¾ç¤ºåŠ¨æ€è·å–çš„å¯è§å…ƒç´ æ•°é‡
- âœ… èƒ½å¤Ÿå¤„ç†ç´¢å¼• 18 çš„ä¼šè¯ï¼ˆå¦‚æœ DOM æœ‰ 19 ä¸ªï¼‰
- âœ… ä¸ä¼šå°è¯•å¤„ç†ç´¢å¼• 19 åŠä»¥ä¸Šï¼ˆå› ä¸ºè¶…å‡º DOM èŒƒå›´ï¼‰

### æ­¥éª¤3: ä¸åŒåˆ†è¾¨ç‡éªŒè¯

å¦‚æœæœ‰æ¡ä»¶ï¼Œå¯ä»¥æµ‹è¯•ä¸åŒåˆ†è¾¨ç‡ï¼š

```bash
# ä¿®æ”¹æµè§ˆå™¨çª—å£å¤§å°
export PLAYWRIGHT_VIEWPORT_WIDTH=1366
export PLAYWRIGHT_VIEWPORT_HEIGHT=768
npm start
```

é¢„æœŸï¼š
- 1366x768: å¤„ç†çº¦ 17 ä¸ªä¼šè¯ âœ…
- 1920x1080: å¤„ç†çº¦ 18-19 ä¸ªä¼šè¯ âœ…
- 2560x1440: å¤„ç†çº¦ 32 ä¸ªä¼šè¯ âœ…

---

## å½±å“èŒƒå›´

### âœ… æ­£é¢å½±å“

1. **æ”¯æŒæ‰€æœ‰åˆ†è¾¨ç‡**
   - è‡ªåŠ¨é€‚é…å°å±å¹•ï¼ˆ17 ä¸ªï¼‰
   - è‡ªåŠ¨é€‚é…å¤§å±å¹•ï¼ˆ32 ä¸ªï¼‰

2. **é¿å…æ— æ•ˆç‚¹å‡»**
   - ä¸å†å°è¯•ç‚¹å‡»ä¸å­˜åœ¨çš„å…ƒç´ 
   - å‡å°‘é”™è¯¯æ—¥å¿—

3. **æ›´å¥½çš„è°ƒè¯•ä¿¡æ¯**
   - æ—¥å¿—æ˜¾ç¤º `visible: N`ï¼Œæ¸…æ¥šçŸ¥é“è™šæ‹Ÿåˆ—è¡¨é™åˆ¶

### âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä»ç„¶ä¸æ”¯æŒæ»šåŠ¨**
   - å¦‚æœ API è¿”å› 220 ä¸ªä¼šè¯ï¼Œä½† DOM åªæœ‰ 19 ä¸ª
   - ä»ç„¶åªä¼šå¤„ç†å‰ 19 ä¸ª
   - æœªæ¥éœ€è¦å®ç°æ»šåŠ¨åŠ è½½é€»è¾‘

2. **ä¾èµ– DOM æŸ¥è¯¢å‡†ç¡®æ€§**
   - å¦‚æœ `document.querySelectorAll('[role="list-item"]')` æŸ¥è¯¢ä¸å‡†ç¡®
   - å¯èƒ½å¯¼è‡´é™åˆ¶å€¼é”™è¯¯

---

## æœªæ¥æ”¹è¿›æ–¹å‘

### æ”¹è¿›1: å®ç°æ»šåŠ¨åŠ è½½

**ç›®æ ‡**: èƒ½å¤Ÿå¤„ç†è¶…å‡ºè™šæ‹Ÿåˆ—è¡¨å¯è§èŒƒå›´çš„ä¼šè¯

**æ–¹æ¡ˆ**:
```javascript
if (conversationIndex >= totalVisibleConversations) {
  // æ»šåŠ¨ä¼šè¯åˆ—è¡¨ï¼Œè®©ç›®æ ‡ä¼šè¯è¿›å…¥å¯è§åŒºåŸŸ
  await scrollConversationListToIndex(page, conversationIndex);

  // é‡æ–°è·å–ä¼šè¯å…ƒç´ 
  const listItems = await page.locator('[role="list-item"]').all();

  // ç»§ç»­ç‚¹å‡»
  await listItems[conversationIndex].click();
}
```

### æ”¹è¿›2: ç¼“å­˜è™šæ‹Ÿåˆ—è¡¨å‚æ•°

**ç›®æ ‡**: é¿å…æ¯æ¬¡éƒ½é‡æ–°è®¡ç®—

**æ–¹æ¡ˆ**:
```javascript
let cachedVisibleCount = null;

if (!cachedVisibleCount) {
  cachedVisibleCount = await page.evaluate(() => {
    return document.querySelectorAll('[role="list-item"]').length;
  });
}
```

### æ”¹è¿›3: è‡ªé€‚åº”å»¶è¿Ÿ

**ç›®æ ‡**: å¤§åˆ†è¾¨ç‡ï¼ˆæ›´å¤šä¼šè¯ï¼‰éœ€è¦æ›´å¤šå¤„ç†æ—¶é—´

**æ–¹æ¡ˆ**:
```javascript
const delayPerConversation = Math.max(500, totalVisibleConversations * 30);
await page.waitForTimeout(delayPerConversation);
```

---

## ç›¸å…³æ–‡æ¡£

- [ç§ä¿¡æ¶ˆæ¯ä¸º0-è°ƒè¯•æ—¥å¿—å®ç°.md](./ç§ä¿¡æ¶ˆæ¯ä¸º0-è°ƒè¯•æ—¥å¿—å®ç°.md) - åŒæ—¶å®Œæˆçš„è°ƒè¯•åŠŸèƒ½
- [ç§ä¿¡æ¶ˆæ¯ä¸º0é—®é¢˜-å®Œæ•´çœŸç›¸.md](./ç§ä¿¡æ¶ˆæ¯ä¸º0é—®é¢˜-å®Œæ•´çœŸç›¸.md) - è™šæ‹Ÿåˆ—è¡¨åŸç†åˆ†æ

---

**æŠ¥å‘Šæ—¶é—´**: 2025-11-05 15:00
**ç‰ˆæœ¬**: v1.0 - åŠ¨æ€é™åˆ¶ä¿®å¤å®Œæˆ
**çŠ¶æ€**: âœ… å·²å®Œæˆï¼Œç­‰å¾…ä¸‹æ¬¡çˆ¬è™«æ‰§è¡ŒéªŒè¯
**é¢„è®¡ç”Ÿæ•ˆæ—¶é—´**: ä¸‹ä¸€ä¸ªçˆ¬è™«å‘¨æœŸï¼ˆçº¦ 60 ç§’åï¼‰
**ç”¨æˆ·åé¦ˆ**: âœ… å®Œå…¨é‡‡çº³ï¼Œä¸åŒåˆ†è¾¨ç‡è‡ªé€‚åº”
