# ç§ä¿¡ç”¨æˆ·ä¿¡æ¯æå–æ–¹æ¡ˆ

**æµ‹è¯•æ—¥æœŸ**: 2025-10-25
**çŠ¶æ€**: âœ… å·²éªŒè¯å¯è¡Œ

---

## ğŸ¯ æ ¸å¿ƒç»“è®º

### âœ… React Fiber ä¸­å¯ä»¥æå–çš„ç”¨æˆ·ä¿¡æ¯

| å­—æ®µ | ç±»å‹ | å¯ç”¨æ€§ | è¯´æ˜ |
|------|------|--------|------|
| **sender** | string | âœ… 100% | å‘é€è€…ç”¨æˆ·ID |
| **avatar** | string | âš ï¸ ä»…å¯¹æ–¹æ¶ˆæ¯ | å¤´åƒURLï¼ˆ100x100ï¼‰ |
| **nickname** | string | âš ï¸ ä»…å¯¹æ–¹æ¶ˆæ¯ | ç”¨æˆ·æ˜µç§° |
| **isFromMe** | boolean | âœ… 100% | æ¶ˆæ¯æ–¹å‘ |

---

## ğŸ“‹ æ•°æ®ç¤ºä¾‹

### ç¤ºä¾‹ 1: è‡ªå·±å‘é€çš„æ¶ˆæ¯

```javascript
{
  "serverId": "7550509169683400713",
  "conversationId": "0:1:2270953921061816:2851498123342840",
  "isFromMe": true,

  // âœ… æœ‰ sender
  "sender": "2270953921061816",

  // âŒ æ—  avatar å’Œ nickname
  "avatar": undefined,
  "nickname": undefined
}
```

### ç¤ºä¾‹ 2: å¯¹æ–¹å‘é€çš„æ¶ˆæ¯

```javascript
{
  "serverId": "7550509225496708667",
  "conversationId": "0:1:2270953921061816:2851498123342840",
  "isFromMe": false,

  // âœ… æœ‰ sender
  "sender": "2851498123342840",

  // âœ… æœ‰ avatar å’Œ nickname
  "avatar": "https://p11.douyinpic.com/aweme/100x100/aweme-avatar/...",
  "nickname": "å¤•é˜³æ­£å¥½"
}
```

---

## ğŸ” conversationId ç»“æ„åˆ†æ

### æ ¼å¼

```
conversationId = "0:1:2270953921061816:2851498123342840"
                  â”‚ â”‚ â”‚                â””â”€ ä¼šè¯ID
                  â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å½“å‰è´¦æˆ·çš„ç”¨æˆ·ID
                  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç±»å‹æ ‡è¯†
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å‰ç¼€
```

### å…³é”®å‘ç°

1. **conversationId çš„ç¬¬ä¸‰éƒ¨åˆ†æ˜¯å½“å‰è´¦æˆ·çš„ç”¨æˆ·ID**
2. **sender å­—æ®µæ˜¯å®é™…å‘é€è€…çš„ç”¨æˆ·ID**
3. **å½“ isFromMe = true æ—¶ï¼Œsender ç­‰äº conversationId çš„ç¬¬ä¸‰éƒ¨åˆ†**
4. **å½“ isFromMe = false æ—¶ï¼Œsender æ˜¯å¯¹æ–¹çš„ç”¨æˆ·IDï¼ˆä¸åœ¨ conversationId ä¸­ï¼‰**

---

## ğŸ’¡ å®ç°æ–¹æ¡ˆ

### æ–¹æ¡ˆï¼šå»ºç«‹ç”¨æˆ·ä¿¡æ¯ç¼“å­˜

```javascript
async function extractMessagesWithUserInfo(page, account) {
  // 1. æå–æ¶ˆæ¯
  const rawMessages = await page.evaluate(() => {
    const allElements = document.querySelectorAll('[class*="message"], [class*="item"]');
    const messages = [];

    allElements.forEach((element) => {
      const fiberKey = Object.keys(element).find(key =>
        key.startsWith('__reactFiber')
      );

      if (!fiberKey) return;

      let current = element[fiberKey];
      let depth = 0;

      while (current && depth < 20) {
        if (current.memoizedProps) {
          const props = current.memoizedProps;

          if (props.conversationId && props.serverId) {
            messages.push({
              serverId: props.serverId,
              conversationId: props.conversationId,
              sender: props.sender,              // âœ… å‘é€è€…ID
              avatar: props.avatar,              // âš ï¸ ä»…å¯¹æ–¹æ¶ˆæ¯
              nickname: props.nickname,          // âš ï¸ ä»…å¯¹æ–¹æ¶ˆæ¯
              isFromMe: props.isFromMe,
              content: props.content,
              type: props.type,
              createdAt: props.createdAt
            });
            break;
          }
        }

        current = current.return;
        depth++;
      }
    });

    return messages;
  });

  // 2. å»ºç«‹ç”¨æˆ·ä¿¡æ¯æ˜ å°„è¡¨
  const userInfoMap = new Map();

  rawMessages.forEach(message => {
    // å¦‚æœæ˜¯å¯¹æ–¹æ¶ˆæ¯ä¸”æœ‰å¤´åƒå’Œæ˜µç§°ï¼Œä¿å­˜åˆ°æ˜ å°„è¡¨
    if (!message.isFromMe && message.avatar && message.nickname) {
      userInfoMap.set(message.sender, {
        avatar: message.avatar,
        nickname: message.nickname
      });
    }
  });

  // 3. ä¸ºæ‰€æœ‰æ¶ˆæ¯å¡«å……ç”¨æˆ·ä¿¡æ¯
  const messagesWithUserInfo = rawMessages.map(message => {
    const userInfo = userInfoMap.get(message.sender) || {};

    return {
      platform_message_id: message.serverId,
      conversation_id: parseConversationId(message.conversationId).realConvId,
      platform_sender_id: message.sender,           // âœ… æ–°å¢
      sender_avatar: userInfo.avatar || null,       // âœ… æ–°å¢
      sender_nickname: userInfo.nickname || null,   // âœ… æ–°å¢
      content: message.content?.text,
      direction: message.isFromMe ? 'outbound' : 'inbound',
      message_type: message.type,
      created_at: new Date(message.createdAt).getTime() / 1000
    };
  });

  return messagesWithUserInfo;
}

// è¾…åŠ©å‡½æ•°ï¼šè§£æ conversationId
function parseConversationId(conversationId) {
  const parts = conversationId.split(':');
  return {
    prefix: parts[0],
    type: parts[1],
    accountUserId: parts[2],      // å½“å‰è´¦æˆ·çš„ç”¨æˆ·ID
    realConvId: parts[3]          // çœŸå®ä¼šè¯ID
  };
}
```

---

## ğŸ“Š æ•°æ®å®Œæ•´æ€§

### æµ‹è¯•ç»“æœï¼ˆ19æ¡æ¶ˆæ¯ï¼‰

| æŒ‡æ ‡ | ç»“æœ | è¯´æ˜ |
|------|------|------|
| æœ‰ sender | âœ… 19/19 (100%) | æ‰€æœ‰æ¶ˆæ¯éƒ½æœ‰å‘é€è€…ID |
| æœ‰ avatar | âš ï¸ 8/19 (42%) | ä»…å¯¹æ–¹æ¶ˆæ¯æœ‰å¤´åƒ |
| æœ‰ nickname | âš ï¸ 8/19 (42%) | ä»…å¯¹æ–¹æ¶ˆæ¯æœ‰æ˜µç§° |

### ä¸ºä»€ä¹ˆåªæœ‰ 42%ï¼Ÿ

- **è‡ªå·±å‘é€çš„æ¶ˆæ¯**ï¼ˆisFromMe = trueï¼‰ï¼š11æ¡ï¼Œæ—  avatar å’Œ nickname
- **å¯¹æ–¹å‘é€çš„æ¶ˆæ¯**ï¼ˆisFromMe = falseï¼‰ï¼š8æ¡ï¼Œæœ‰ avatar å’Œ nickname

è¿™æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸º React ä¸éœ€è¦ä¸ºè‡ªå·±çš„æ¶ˆæ¯é‡å¤æ˜¾ç¤ºè‡ªå·±çš„å¤´åƒå’Œæ˜µç§°ã€‚

---

## ğŸ› ï¸ æ•°æ®åº“å­—æ®µ

### å»ºè®®åœ¨ direct_messages è¡¨ä¸­æ·»åŠ ï¼š

```sql
-- æ–°å¢å­—æ®µ
platform_sender_id   TEXT,     -- å‘é€è€…ç”¨æˆ·ID
sender_avatar        TEXT,     -- å‘é€è€…å¤´åƒURL
sender_nickname      TEXT      -- å‘é€è€…æ˜µç§°
```

### å®Œæ•´å­—æ®µåˆ—è¡¨

```sql
CREATE TABLE direct_messages (
  id                   TEXT PRIMARY KEY,
  account_id           TEXT NOT NULL,
  platform             TEXT NOT NULL,
  conversation_id      TEXT NOT NULL,
  platform_message_id  TEXT,
  platform_sender_id   TEXT,          -- âœ… æ–°å¢
  sender_avatar        TEXT,          -- âœ… æ–°å¢
  sender_nickname      TEXT,          -- âœ… æ–°å¢
  content              TEXT,
  direction            TEXT,
  message_type         TEXT,
  created_at           INTEGER,
  is_read              INTEGER DEFAULT 0,
  status               TEXT DEFAULT 'sent',
  -- ... å…¶ä»–å­—æ®µ
);
```

---

## âœ… ä¼˜åŠ¿

1. **sender å­—æ®µ 100% å¯ç”¨** - æ‰€æœ‰æ¶ˆæ¯éƒ½æœ‰å‘é€è€…ID
2. **å¯¹æ–¹çš„å¤´åƒå’Œæ˜µç§°å¯é ** - ä»å¯¹æ–¹æ¶ˆæ¯ä¸­æå–
3. **å®ç°ç®€å•** - ç›´æ¥ä» React Fiber è¯»å–
4. **æ€§èƒ½å¥½** - æ— éœ€é¢å¤–çš„ç½‘ç»œè¯·æ±‚

---

## âš ï¸ é™åˆ¶

1. **è‡ªå·±çš„æ¶ˆæ¯æ— å¤´åƒå’Œæ˜µç§°** - éœ€è¦ä»å…¶ä»–åœ°æ–¹è·å–ï¼ˆè´¦æˆ·ä¿¡æ¯ï¼‰
2. **ä¾èµ– React Fiber** - å¦‚æœæŠ–éŸ³æ›´æ”¹å‰ç«¯å®ç°å¯èƒ½å¤±æ•ˆ

---

## ğŸ”„ ä¸ä¼šè¯åˆ—è¡¨æ•°æ®çš„å…³ç³»

ä¼šè¯åˆ—è¡¨ä¸­ä¹ŸåŒ…å«ç”¨æˆ·ä¿¡æ¯ï¼Œå¯ä»¥ä½œä¸ºè¡¥å……æ•°æ®æºï¼š

```javascript
// ä¼šè¯åˆ—è¡¨æå–ï¼ˆç‚¹å‡»ä¼šè¯å‰ï¼‰
const conversationList = await page.evaluate(() => {
  // ä»ä¼šè¯åˆ—è¡¨å…ƒç´ æå–
  return {
    userId: "...",
    avatar: "...",
    nickname: "..."
  };
});

// å­˜å‚¨åˆ°æ˜ å°„è¡¨
userInfoMap.set(conversationList.userId, {
  avatar: conversationList.avatar,
  nickname: conversationList.nickname
});
```

---

## ğŸ¯ æ¨èå®ç°æ­¥éª¤

1. âœ… **ä¿®æ”¹ crawl-direct-messages-v2.js**
   - æå– `sender`ã€`avatar`ã€`nickname` å­—æ®µ
   - å»ºç«‹ç”¨æˆ·ä¿¡æ¯æ˜ å°„è¡¨
   - ä¸ºæ‰€æœ‰æ¶ˆæ¯å¡«å……ç”¨æˆ·ä¿¡æ¯

2. â¸ï¸ **æ›´æ–°æ•°æ®åº“ schema**
   - æ·»åŠ æ–°å­—æ®µåˆ° `direct_messages` è¡¨
   - æ›´æ–° DAO æ–‡ä»¶

3. â¸ï¸ **æµ‹è¯•éªŒè¯**
   - è¿è¡Œå®Œæ•´çš„ç§ä¿¡æŠ“å–æµ‹è¯•
   - éªŒè¯æ•°æ®å®Œæ•´æ€§

4. â¸ï¸ **å¯é€‰ä¼˜åŒ–**
   - ä»ä¼šè¯åˆ—è¡¨é¢„åŠ è½½ç”¨æˆ·ä¿¡æ¯
   - æ·»åŠ è‡ªå·±è´¦æˆ·çš„å¤´åƒå’Œæ˜µç§°

---

**æ€»ç»“**: âœ… å¯ä»¥æå–å‘é€è€…ç”¨æˆ·ID (sender)ï¼Œå¯¹æ–¹æ¶ˆæ¯è¿˜åŒ…å«å¤´åƒå’Œæ˜µç§°ï¼Œå®ç°ç®€å•å¯é ï¼

**ä¸‹ä¸€æ­¥**: ä¿®æ”¹ `crawl-direct-messages-v2.js` æ·»åŠ ç”¨æˆ·ä¿¡æ¯æå–é€»è¾‘
