# æµè§ˆå™¨å¤šæ ‡ç­¾é¡µç®¡ç†è¯´æ˜

## ç”¨æˆ·æé—®

> "ç›®å‰ä»»åŠ¡å·²ç»æ‰§è¡Œäº†ï¼Œä½†æ˜¯ç¬¬äºŒä¸ª tab æ˜¯å¹²å˜›çš„"

## å¤šæ ‡ç­¾é¡µè®¾è®¡

Worker ä¸ºæ¯ä¸ªè´¦æˆ·ä½¿ç”¨**ä¸€ä¸ªæµè§ˆå™¨ Context**ï¼Œä½†åœ¨è¿™ä¸ª Context ä¸­ä¼šåˆ›å»º**å¤šä¸ªæ ‡ç­¾é¡µï¼ˆTabï¼‰**ï¼Œç”¨äºä¸åŒçš„çˆ¬å–ä»»åŠ¡ã€‚

### æ ‡ç­¾é¡µåˆ†ç±»

| æ ‡ç­¾é¡µ | åç§° | ç”¨é€” | ç”Ÿå‘½å‘¨æœŸ | åˆ›å»ºæ—¶æœº |
|--------|------|------|----------|----------|
| **Tab 1** | spider1 | ç§ä¿¡çˆ¬å– | é•¿æœŸè¿è¡Œï¼Œä¸å…³é—­ | Context å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»º |
| **Tab 2** | spider2 | è¯„è®ºçˆ¬å– | é•¿æœŸè¿è¡Œï¼Œä¸å…³é—­ | é¦–æ¬¡éœ€è¦æ—¶åˆ›å»º |
| **Tab 3+** | temporary | ä¸´æ—¶ä»»åŠ¡ï¼ˆç™»å½•ã€å›å¤ç­‰ï¼‰ | ä»»åŠ¡å®Œæˆåå…³é—­ | æŒ‰éœ€åˆ›å»º |

### ä»£ç å®ç°

**æ–‡ä»¶**ï¼š`packages/worker/src/browser/browser-manager-v2.js`

```javascript
// ğŸ†• é¡µé¢æ± ç®¡ç† - åˆ†ç±»ç®¡ç†ä¸åŒç”¨é€”çš„é¡µé¢
// spider1: ç§ä¿¡çˆ¬å–èœ˜è››ï¼ˆTab 1ï¼‰- é•¿æœŸè¿è¡Œï¼Œä¸å…³é—­
// spider2: è¯„è®ºçˆ¬å–èœ˜è››ï¼ˆTab 2ï¼‰- é•¿æœŸè¿è¡Œï¼Œä¸å…³é—­
// temporary: ä¸´æ—¶é¡µé¢ï¼ˆTab 3+ï¼‰- å®Œæˆåå…³é—­
this.spiderPages = new Map();    // { accountId -> { spider1: page, spider2: page } }
this.temporaryPages = new Map(); // { accountId -> [page1, page2, ...] }
```

## ä¸ºä»€ä¹ˆéœ€è¦å¤šä¸ªæ ‡ç­¾é¡µï¼Ÿ

### åŸå›  1ï¼šä»»åŠ¡éš”ç¦»

ä¸åŒçš„çˆ¬å–ä»»åŠ¡åœ¨ä¸åŒçš„é¡µé¢ä¸Šæ‰§è¡Œï¼Œé¿å…ç›¸äº’å¹²æ‰°ï¼š

```
Tab 1 (spider1) - ç§ä¿¡çˆ¬å–
â”œâ”€ è®¿é—® creator.douyin.com/im
â”œâ”€ ç›‘å¬æ¶ˆæ¯åˆ—è¡¨
â”œâ”€ æå–ç§ä¿¡æ•°æ®
â””â”€ æŒç»­è¿è¡Œï¼ˆæ¯ 30 ç§’åˆ·æ–°ï¼‰

Tab 2 (spider2) - è¯„è®ºçˆ¬å–
â”œâ”€ è®¿é—® creator.douyin.com/creator-micro/home
â”œâ”€ éå†ä½œå“åˆ—è¡¨
â”œâ”€ ç‚¹å‡»è¿›å…¥æ¯ä¸ªä½œå“
â”œâ”€ æå–è¯„è®ºæ•°æ®
â””â”€ æŒç»­è¿è¡Œï¼ˆæ¯ 30 ç§’åˆ·æ–°ï¼‰
```

å¦‚æœä½¿ç”¨åŒä¸€ä¸ª Tabï¼š
- ç§ä¿¡çˆ¬å–éœ€è¦åœ¨ IM é¡µé¢
- è¯„è®ºçˆ¬å–éœ€è¦åœ¨ä½œå“é¡µé¢
- é¢‘ç¹åˆ‡æ¢é¡µé¢ä¼šå¯¼è‡´æ•ˆç‡ä½ä¸‹ï¼Œä¸”å®¹æ˜“å‡ºé”™

### åŸå›  2ï¼šæ€§èƒ½ä¼˜åŒ–

- **å¹¶è¡Œæ‰§è¡Œ**ï¼šTab 1 çˆ¬ç§ä¿¡çš„åŒæ—¶ï¼ŒTab 2 å¯ä»¥çˆ¬è¯„è®º
- **å‡å°‘é¡µé¢åˆ‡æ¢**ï¼šæ¯ä¸ª Tab ä¸“æ³¨äºä¸€ä¸ªé¡µé¢ï¼Œä¸éœ€è¦é¢‘ç¹å¯¼èˆª
- **çŠ¶æ€ä¿æŒ**ï¼šæ¯ä¸ª Tab ç»´æŠ¤è‡ªå·±çš„é¡µé¢çŠ¶æ€ï¼Œä¸ä¼šè¢«å…¶ä»–ä»»åŠ¡å½±å“

### åŸå›  3ï¼šç®€åŒ–ä»£ç é€»è¾‘

```javascript
// ç§ä¿¡çˆ¬å–
const spider1Page = await browserManager.getSpiderPage(accountId, 'spider1');
await crawlDirectMessages(spider1Page);  // ä¸“æ³¨äºç§ä¿¡é¡µé¢

// è¯„è®ºçˆ¬å–
const spider2Page = await browserManager.getSpiderPage(accountId, 'spider2');
await crawlComments(spider2Page);  // ä¸“æ³¨äºè¯„è®ºé¡µé¢
```

ä¸éœ€è¦åœ¨åŒä¸€ä¸ªé¡µé¢ä¸Šåˆ‡æ¢ä¸åŒçš„ URL å’ŒçŠ¶æ€ã€‚

## æ ‡ç­¾é¡µç”Ÿå‘½å‘¨æœŸ

### Tab 1 (spider1) - é»˜è®¤æ ‡ç­¾é¡µ

```
æµè§ˆå™¨å¯åŠ¨
   â†“
launchPersistentContext() åˆ›å»º Context
   â†“
Context è‡ªåŠ¨åˆ›å»ºç¬¬ä¸€ä¸ªé¡µé¢ï¼ˆTab 1ï¼‰
   â†“
è®¾ç½®ä¸º spider1 é¡µé¢
   â†“
ç”¨äºç™»å½•æ£€æµ‹å’Œç§ä¿¡çˆ¬å–
   â†“
æµè§ˆå™¨å…³é—­å‰ä¸€ç›´å­˜åœ¨
```

**ä»£ç **ï¼š
```javascript
const pages = context.pages();
if (pages.length > 0) {
  const defaultPage = pages[0];
  logger.info(`ğŸ“Œ Tab 1 (é»˜è®¤) ç”¨äºç™»å½•å’Œå¹³å°é¦–é¡µå¯¼èˆª - è´¦æˆ· ${accountId}`);
  // å°†é»˜è®¤é¡µé¢è®¾ä¸º spider1
  this.spiderPages.set(accountId, {});
  this.spiderPages.get(accountId).spider1 = defaultPage;
}
```

### Tab 2 (spider2) - æŒ‰éœ€åˆ›å»º

```
é¦–æ¬¡éœ€è¦è¯„è®ºçˆ¬å–
   â†“
è°ƒç”¨ getSpiderPage(accountId, 'spider2')
   â†“
æ£€æŸ¥ spider2 æ˜¯å¦å­˜åœ¨
   â”œâ”€ å­˜åœ¨ â†’ å¤ç”¨
   â””â”€ ä¸å­˜åœ¨ â†’ åˆ›å»ºæ–° Tab
   â†“
context.newPage() åˆ›å»º Tab 2
   â†“
è®¾ç½®ä¸º spider2 é¡µé¢
   â†“
ç”¨äºè¯„è®ºçˆ¬å–
   â†“
æµè§ˆå™¨å…³é—­å‰ä¸€ç›´å­˜åœ¨
```

**ä»£ç **ï¼š
```javascript
// spider2 æŒ‰éœ€åˆ›å»º
if (spiderType === 'spider2') {
  if (!spiders.spider2 || spiders.spider2.isClosed()) {
    const context = this.contexts.get(accountId);
    spiders.spider2 = await context.newPage();
    logger.info(`ğŸ•·ï¸ Created spider2 (Tab 2) for account ${accountId}`);
  }
  return spiders.spider2;
}
```

### Tab 3+ (temporary) - ä¸´æ—¶ä»»åŠ¡

```
éœ€è¦æ‰§è¡Œä¸´æ—¶ä»»åŠ¡ï¼ˆç™»å½•ã€å›å¤ç­‰ï¼‰
   â†“
è°ƒç”¨ createTemporaryPage(accountId)
   â†“
context.newPage() åˆ›å»ºä¸´æ—¶ Tab
   â†“
æ‰§è¡Œä»»åŠ¡ï¼ˆä¾‹å¦‚ï¼šå›å¤è¯„è®ºï¼‰
   â†“
ä»»åŠ¡å®Œæˆ
   â†“
page.close() å…³é—­ä¸´æ—¶ Tab
```

**ä»£ç **ï¼š
```javascript
async createTemporaryPage(accountId) {
  const context = this.contexts.get(accountId);
  const page = await context.newPage();
  logger.info(`âœ¨ Created temporary page for account ${accountId}`);

  // è®°å½•ä¸´æ—¶é¡µé¢
  if (!this.temporaryPages.has(accountId)) {
    this.temporaryPages.set(accountId, []);
  }
  this.temporaryPages.get(accountId).push(page);

  return page;
}
```

## ä½¿ç”¨ç¤ºä¾‹

### ç§ä¿¡çˆ¬å–ï¼ˆTab 1ï¼‰

```javascript
// packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js

const spider1Page = await this.browserManager.getSpiderPage(this.account.id, 'spider1');

// å¯¼èˆªåˆ° IM é¡µé¢
await spider1Page.goto('https://creator.douyin.com/im', {
  waitUntil: 'domcontentloaded',
  timeout: 30000
});

// æå–ç§ä¿¡æ•°æ®
const messages = await extractMessages(spider1Page);
```

### è¯„è®ºçˆ¬å–ï¼ˆTab 2ï¼‰

```javascript
// packages/worker/src/platforms/douyin/crawl-comments.js

const spider2Page = await this.browserManager.getSpiderPage(this.account.id, 'spider2');

// å¯¼èˆªåˆ°ä½œå“åˆ—è¡¨é¡µé¢
await spider2Page.goto('https://creator.douyin.com/creator-micro/home', {
  waitUntil: 'domcontentloaded',
  timeout: 30000
});

// æå–è¯„è®ºæ•°æ®
const comments = await extractComments(spider2Page);
```

### ä¸´æ—¶ä»»åŠ¡ï¼ˆTab 3+ï¼‰

```javascript
// packages/worker/src/platforms/douyin/send-reply-comment.js

// åˆ›å»ºä¸´æ—¶é¡µé¢ç”¨äºå›å¤
const tempPage = await this.browserManager.createTemporaryPage(this.account.id);

try {
  // å›å¤è¯„è®º
  await tempPage.goto(commentUrl);
  await tempPage.fill('textarea', replyText);
  await tempPage.click('button[type="submit"]');

} finally {
  // ä»»åŠ¡å®Œæˆåå…³é—­ä¸´æ—¶é¡µé¢
  await tempPage.close();
  logger.info('Temporary page closed');
}
```

## ä¼˜åŠ¿æ€»ç»“

### 1. æ€§èƒ½æå‡
- âœ… å¹¶è¡Œæ‰§è¡Œå¤šä¸ªçˆ¬å–ä»»åŠ¡
- âœ… å‡å°‘é¡µé¢å¯¼èˆªå’Œç­‰å¾…æ—¶é—´
- âœ… æ¯ä¸ª Tab ä¸“æ³¨äºä¸€ä¸ªä»»åŠ¡ï¼Œæ•ˆç‡æ›´é«˜

### 2. ä»£ç ç®€åŒ–
- âœ… æ¯ä¸ªçˆ¬è™«åªå…³æ³¨è‡ªå·±çš„é¡µé¢
- âœ… ä¸éœ€è¦å¤æ‚çš„é¡µé¢çŠ¶æ€ç®¡ç†
- âœ… ä¸éœ€è¦é¢‘ç¹çš„é¡µé¢åˆ‡æ¢é€»è¾‘

### 3. ç¨³å®šæ€§æå‡
- âœ… ä»»åŠ¡éš”ç¦»ï¼Œäº’ä¸å½±å“
- âœ… ä¸€ä¸ª Tab å‡ºé”™ä¸ä¼šå½±å“å…¶ä»– Tab
- âœ… ä¸´æ—¶ä»»åŠ¡ç‹¬ç«‹ï¼Œä¸ä¼šæ±¡æŸ“ä¸»çˆ¬è™«é¡µé¢

### 4. èµ„æºç®¡ç†
- âœ… é•¿æœŸè¿è¡Œçš„çˆ¬è™«é¡µé¢ä¸å…³é—­ï¼ˆé¿å…é‡å¤åˆå§‹åŒ–ï¼‰
- âœ… ä¸´æ—¶ä»»åŠ¡å®Œæˆåç«‹å³é‡Šæ”¾èµ„æº
- âœ… æµè§ˆå™¨å†…å­˜å ç”¨å¯æ§

## å½“å‰çŠ¶æ€

ç”¨æˆ·æåˆ°"ç›®å‰ä»»åŠ¡å·²ç»æ‰§è¡Œäº†"ï¼Œè¯´æ˜ï¼š

1. âœ… Tab 1 (spider1) - å·²åˆ›å»ºï¼Œç”¨äºç§ä¿¡çˆ¬å–
2. âœ… Tab 2 (spider2) - å·²åˆ›å»ºï¼Œç”¨äºè¯„è®ºçˆ¬å–
3. âœ… ä¸¤ä¸ªçˆ¬è™«ä»»åŠ¡æ­£åœ¨å¹¶è¡Œæ‰§è¡Œ

**è¿™æ˜¯æ­£å¸¸çš„è®¾è®¡è¡Œä¸º**ï¼Œä¸æ˜¯é—®é¢˜æˆ–é”™è¯¯ã€‚

## æŸ¥çœ‹æ ‡ç­¾é¡µçŠ¶æ€

å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æŸ¥çœ‹æµè§ˆå™¨ä¸­çš„æ ‡ç­¾é¡µï¼š

1. **æµè§ˆå™¨ç•Œé¢**
   - Worker å¯åŠ¨çš„æµè§ˆå™¨çª—å£
   - é¡¶éƒ¨å¯ä»¥çœ‹åˆ°å¤šä¸ªæ ‡ç­¾é¡µ
   - Tab 1ï¼šç§ä¿¡é¡µé¢ï¼ˆcreator.douyin.com/imï¼‰
   - Tab 2ï¼šä½œå“åˆ—è¡¨é¡µé¢ï¼ˆcreator.douyin.com/creator-micro/homeï¼‰

2. **Worker æ—¥å¿—**
   ```
   ğŸ•·ï¸ Using spider1 (Tab 1) for account acc-xxx
   ğŸ•·ï¸ Created spider2 (Tab 2) for account acc-xxx
   ```

3. **è°ƒè¯•å·¥å…·**
   - æ‰“å¼€æµè§ˆå™¨çš„å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
   - åˆ‡æ¢ä¸åŒçš„æ ‡ç­¾é¡µæŸ¥çœ‹å®ƒä»¬çš„çŠ¶æ€

## æœªæ¥æ‰©å±•

å¦‚æœéœ€è¦æ›´å¤šç±»å‹çš„çˆ¬è™«ä»»åŠ¡ï¼Œå¯ä»¥ç»§ç»­æ‰©å±•ï¼š

```javascript
// spider3: ç²‰ä¸æ•°æ®çˆ¬å–
// spider4: ä½œå“åˆ†æçˆ¬å–
// ...
this.spiderPages = new Map(); // { accountId -> { spider1, spider2, spider3, ... } }
```

åªéœ€è¦åœ¨ `getSpiderPage()` æ–¹æ³•ä¸­æ·»åŠ æ–°çš„ `spiderType` åˆ¤æ–­å³å¯ã€‚

---

**æ–‡æ¡£æ—¶é—´**ï¼š2025-10-24 19:25
**æ–‡æ¡£ä½œè€…**ï¼šClaude Code
**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0
