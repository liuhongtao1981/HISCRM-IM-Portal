# 浏览器多标签页管理说明

## 用户提问

> "目前任务已经执行了，但是第二个 tab 是干嘛的"

## 多标签页设计

Worker 为每个账户使用**一个浏览器 Context**，但在这个 Context 中会创建**多个标签页（Tab）**，用于不同的爬取任务。

### 标签页分类

| 标签页 | 名称 | 用途 | 生命周期 | 创建时机 |
|--------|------|------|----------|----------|
| **Tab 1** | spider1 | 私信爬取 | 长期运行，不关闭 | Context 启动时自动创建 |
| **Tab 2** | spider2 | 评论爬取 | 长期运行，不关闭 | 首次需要时创建 |
| **Tab 3+** | temporary | 临时任务（登录、回复等） | 任务完成后关闭 | 按需创建 |

### 代码实现

**文件**：`packages/worker/src/browser/browser-manager-v2.js`

```javascript
// 🆕 页面池管理 - 分类管理不同用途的页面
// spider1: 私信爬取蜘蛛（Tab 1）- 长期运行，不关闭
// spider2: 评论爬取蜘蛛（Tab 2）- 长期运行，不关闭
// temporary: 临时页面（Tab 3+）- 完成后关闭
this.spiderPages = new Map();    // { accountId -> { spider1: page, spider2: page } }
this.temporaryPages = new Map(); // { accountId -> [page1, page2, ...] }
```

## 为什么需要多个标签页？

### 原因 1：任务隔离

不同的爬取任务在不同的页面上执行，避免相互干扰：

```
Tab 1 (spider1) - 私信爬取
├─ 访问 creator.douyin.com/im
├─ 监听消息列表
├─ 提取私信数据
└─ 持续运行（每 30 秒刷新）

Tab 2 (spider2) - 评论爬取
├─ 访问 creator.douyin.com/creator-micro/home
├─ 遍历作品列表
├─ 点击进入每个作品
├─ 提取评论数据
└─ 持续运行（每 30 秒刷新）
```

如果使用同一个 Tab：
- 私信爬取需要在 IM 页面
- 评论爬取需要在作品页面
- 频繁切换页面会导致效率低下，且容易出错

### 原因 2：性能优化

- **并行执行**：Tab 1 爬私信的同时，Tab 2 可以爬评论
- **减少页面切换**：每个 Tab 专注于一个页面，不需要频繁导航
- **状态保持**：每个 Tab 维护自己的页面状态，不会被其他任务影响

### 原因 3：简化代码逻辑

```javascript
// 私信爬取
const spider1Page = await browserManager.getSpiderPage(accountId, 'spider1');
await crawlDirectMessages(spider1Page);  // 专注于私信页面

// 评论爬取
const spider2Page = await browserManager.getSpiderPage(accountId, 'spider2');
await crawlComments(spider2Page);  // 专注于评论页面
```

不需要在同一个页面上切换不同的 URL 和状态。

## 标签页生命周期

### Tab 1 (spider1) - 默认标签页

```
浏览器启动
   ↓
launchPersistentContext() 创建 Context
   ↓
Context 自动创建第一个页面（Tab 1）
   ↓
设置为 spider1 页面
   ↓
用于登录检测和私信爬取
   ↓
浏览器关闭前一直存在
```

**代码**：
```javascript
const pages = context.pages();
if (pages.length > 0) {
  const defaultPage = pages[0];
  logger.info(`📌 Tab 1 (默认) 用于登录和平台首页导航 - 账户 ${accountId}`);
  // 将默认页面设为 spider1
  this.spiderPages.set(accountId, {});
  this.spiderPages.get(accountId).spider1 = defaultPage;
}
```

### Tab 2 (spider2) - 按需创建

```
首次需要评论爬取
   ↓
调用 getSpiderPage(accountId, 'spider2')
   ↓
检查 spider2 是否存在
   ├─ 存在 → 复用
   └─ 不存在 → 创建新 Tab
   ↓
context.newPage() 创建 Tab 2
   ↓
设置为 spider2 页面
   ↓
用于评论爬取
   ↓
浏览器关闭前一直存在
```

**代码**：
```javascript
// spider2 按需创建
if (spiderType === 'spider2') {
  if (!spiders.spider2 || spiders.spider2.isClosed()) {
    const context = this.contexts.get(accountId);
    spiders.spider2 = await context.newPage();
    logger.info(`🕷️ Created spider2 (Tab 2) for account ${accountId}`);
  }
  return spiders.spider2;
}
```

### Tab 3+ (temporary) - 临时任务

```
需要执行临时任务（登录、回复等）
   ↓
调用 createTemporaryPage(accountId)
   ↓
context.newPage() 创建临时 Tab
   ↓
执行任务（例如：回复评论）
   ↓
任务完成
   ↓
page.close() 关闭临时 Tab
```

**代码**：
```javascript
async createTemporaryPage(accountId) {
  const context = this.contexts.get(accountId);
  const page = await context.newPage();
  logger.info(`✨ Created temporary page for account ${accountId}`);

  // 记录临时页面
  if (!this.temporaryPages.has(accountId)) {
    this.temporaryPages.set(accountId, []);
  }
  this.temporaryPages.get(accountId).push(page);

  return page;
}
```

## 使用示例

### 私信爬取（Tab 1）

```javascript
// packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js

const spider1Page = await this.browserManager.getSpiderPage(this.account.id, 'spider1');

// 导航到 IM 页面
await spider1Page.goto('https://creator.douyin.com/im', {
  waitUntil: 'domcontentloaded',
  timeout: 30000
});

// 提取私信数据
const messages = await extractMessages(spider1Page);
```

### 评论爬取（Tab 2）

```javascript
// packages/worker/src/platforms/douyin/crawl-comments.js

const spider2Page = await this.browserManager.getSpiderPage(this.account.id, 'spider2');

// 导航到作品列表页面
await spider2Page.goto('https://creator.douyin.com/creator-micro/home', {
  waitUntil: 'domcontentloaded',
  timeout: 30000
});

// 提取评论数据
const comments = await extractComments(spider2Page);
```

### 临时任务（Tab 3+）

```javascript
// packages/worker/src/platforms/douyin/send-reply-comment.js

// 创建临时页面用于回复
const tempPage = await this.browserManager.createTemporaryPage(this.account.id);

try {
  // 回复评论
  await tempPage.goto(commentUrl);
  await tempPage.fill('textarea', replyText);
  await tempPage.click('button[type="submit"]');

} finally {
  // 任务完成后关闭临时页面
  await tempPage.close();
  logger.info('Temporary page closed');
}
```

## 优势总结

### 1. 性能提升
- ✅ 并行执行多个爬取任务
- ✅ 减少页面导航和等待时间
- ✅ 每个 Tab 专注于一个任务，效率更高

### 2. 代码简化
- ✅ 每个爬虫只关注自己的页面
- ✅ 不需要复杂的页面状态管理
- ✅ 不需要频繁的页面切换逻辑

### 3. 稳定性提升
- ✅ 任务隔离，互不影响
- ✅ 一个 Tab 出错不会影响其他 Tab
- ✅ 临时任务独立，不会污染主爬虫页面

### 4. 资源管理
- ✅ 长期运行的爬虫页面不关闭（避免重复初始化）
- ✅ 临时任务完成后立即释放资源
- ✅ 浏览器内存占用可控

## 当前状态

用户提到"目前任务已经执行了"，说明：

1. ✅ Tab 1 (spider1) - 已创建，用于私信爬取
2. ✅ Tab 2 (spider2) - 已创建，用于评论爬取
3. ✅ 两个爬虫任务正在并行执行

**这是正常的设计行为**，不是问题或错误。

## 查看标签页状态

可以通过以下方式查看浏览器中的标签页：

1. **浏览器界面**
   - Worker 启动的浏览器窗口
   - 顶部可以看到多个标签页
   - Tab 1：私信页面（creator.douyin.com/im）
   - Tab 2：作品列表页面（creator.douyin.com/creator-micro/home）

2. **Worker 日志**
   ```
   🕷️ Using spider1 (Tab 1) for account acc-xxx
   🕷️ Created spider2 (Tab 2) for account acc-xxx
   ```

3. **调试工具**
   - 打开浏览器的开发者工具（F12）
   - 切换不同的标签页查看它们的状态

## 未来扩展

如果需要更多类型的爬虫任务，可以继续扩展：

```javascript
// spider3: 粉丝数据爬取
// spider4: 作品分析爬取
// ...
this.spiderPages = new Map(); // { accountId -> { spider1, spider2, spider3, ... } }
```

只需要在 `getSpiderPage()` 方法中添加新的 `spiderType` 判断即可。

---

**文档时间**：2025-10-24 19:25
**文档作者**：Claude Code
**文档版本**：1.0
