# ç§ä¿¡æŠ“å– 0 æ¶ˆæ¯é—®é¢˜ - Git å›é€€ä¿®å¤æŠ¥å‘Š

**æ—¥æœŸ**: 2025-11-05 16:30
**çŠ¶æ€**: âœ… å·²å›é€€åˆ°å¯å·¥ä½œç‰ˆæœ¬ï¼Œç­‰å¾…æµ‹è¯•éªŒè¯

---

## ä¸€ã€é—®é¢˜è¯Šæ–­

### 1.1 ç”¨æˆ·åé¦ˆ

> "è€Œä¸”ï¼Œæˆ‘ä»¬git é‡Œæœ€åä¸€ä¸ªç‰ˆæœ¬çš„æ˜¯å¯ä»¥æ­£å¸¸æŠ“å–æ¶ˆæ¯çš„ï¼Œæˆ‘ä»¬æ˜¨å¤©ä¿®æ”¹äº†ä¸€äº›å…¶ä»–é—®é¢˜ï¼Œä»–å°±ä¸è¡Œäº†"

**å…³é”®ä¿¡æ¯**:
- Git æœ€åä¸€ä¸ªæäº¤ç‰ˆæœ¬ (`6d9ff28`) **å¯ä»¥æ­£å¸¸å·¥ä½œ**
- æ˜¨å¤©çš„ä¿®æ”¹å¯¼è‡´æ¶ˆæ¯æŠ“å–è¿”å› 0 æ¡
- é—®é¢˜æ˜¯**ä»£ç é€€åŒ– (regression)**ï¼Œä¸æ˜¯è®¾è®¡ç¼ºé™·

### 1.2 Git å·®å¼‚åˆ†æ

æ£€æŸ¥å½“å‰å·¥ä½œç›®å½•çš„æœªæäº¤ä¿®æ”¹ï¼š

```bash
$ git diff --stat packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js

packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js   | 1167 ++++++++++++++------
 1 file changed, 835 insertions(+), 332 deletions(-)
```

**å‘ç°**:
- âš ï¸ **1167 è¡Œçš„å·¨å¤§ä¿®æ”¹è¿˜æœªæäº¤**
- è¿™äº›ä¿®æ”¹æ˜¯æˆ‘åœ¨ä¹‹å‰çš„è°ƒè¯•è¿‡ç¨‹ä¸­æ·»åŠ çš„
- åŒ…æ‹¬ï¼šå¤§é‡è°ƒè¯•æ—¥å¿—ã€DOMæå–å‡½æ•°ã€è™šæ‹Ÿåˆ—è¡¨æ»šåŠ¨å‡½æ•°ã€äºŒè¿›åˆ¶Protobufå¤„ç†ç­‰

### 1.3 ä¿®æ”¹å†…å®¹æ¦‚è§ˆ

ä» `git diff` ä¸­å‘ç°çš„ä¸»è¦ä¿®æ”¹ï¼š

1. **æ–°å¢å‡½æ•°**ï¼ˆ200+ è¡Œï¼‰:
   - `scrollVirtualListToIndex()` - è™šæ‹Ÿåˆ—è¡¨æ»šåŠ¨
   - `extractMessagesFromDOM()` - DOMæ¶ˆæ¯æå–ï¼ˆæ»šåŠ¨æ¨¡å¼ï¼‰
   - `extractVisibleConversations()` - å¯è§ä¼šè¯æå–

2. **API æ‹¦æˆªå™¨ä¿®æ”¹**:
   - `onMessageInitAPI()` å¢åŠ äº†äºŒè¿›åˆ¶Protobufæ£€æµ‹é€»è¾‘
   - æ·»åŠ  `__isBinary` æ ‡å¿—å¤„ç†

3. **å¯¼èˆªé€»è¾‘ä¿®æ”¹**:
   - `page.goto()` çš„ `waitUntil` ä» `networkidle` æ”¹ä¸º `domcontentloaded`
   - è¶…æ—¶ä» 30 ç§’å‡å°‘åˆ° 15 ç§’

4. **å¤§é‡è°ƒè¯•æ—¥å¿—**:
   - `console.log('ğŸ” ç¬¬ä¸€ä¸ª props:', ...)`
   - `console.log('âœ… æ»¡è¶³æ·»åŠ æ¡ä»¶:', ...)`
   - `console.warn('âŒ ä¸æ»¡è¶³æ·»åŠ æ¡ä»¶:', ...)`

**æ½œåœ¨é—®é¢˜**:
- æ–°å¢ä»£ç å¯èƒ½ä¿®æ”¹äº†æ ¸å¿ƒé€»è¾‘çš„æ‰§è¡Œæµç¨‹
- æŸä¸ªæ¡ä»¶åˆ¤æ–­å¯èƒ½è¢«é”™è¯¯ä¿®æ”¹
- å¼‚æ­¥ç­‰å¾…é€»è¾‘å¯èƒ½è¢«ç ´å

---

## äºŒã€ä¿®å¤æªæ–½

### 2.1 å¤‡ä»½å½“å‰ä¿®æ”¹

```bash
git diff packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js > crawl-dm-v2-debug-changes.patch
```

**å¤‡ä»½æ–‡ä»¶ä½ç½®**: `e:/HISCRM-IM-main/crawl-dm-v2-debug-changes.patch`

### 2.2 å›é€€åˆ°å¯å·¥ä½œç‰ˆæœ¬

```bash
git checkout -- packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js
```

**å›é€€åˆ°çš„ç‰ˆæœ¬**: `6d9ff28` (æœ€åä¸€æ¬¡æäº¤)

**å›é€€å†…å®¹**:
- ç§»é™¤äº†æ‰€æœ‰æœªæäº¤çš„è°ƒè¯•ä»£ç ï¼ˆ1167 è¡Œä¿®æ”¹ï¼‰
- æ¢å¤åˆ°æ—¶é—´æˆ³ä¿®å¤åçš„ç¨³å®šç‰ˆæœ¬
- ä¿ç•™äº†æ—¶åŒºä¿®æ­£é€»è¾‘ï¼ˆè¿™ä¸ªæ˜¯å·²æäº¤çš„ä¿®å¤ï¼‰

### 2.3 æ–‡ä»¶çŠ¶æ€éªŒè¯

```bash
$ git status packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js
On branch main
Your branch is up to date with 'origin/main'.

nothing to commit, working tree clean
```

âœ… ç¡®è®¤æ–‡ä»¶å·²æˆåŠŸå›é€€åˆ° Git ç‰ˆæœ¬

---

## ä¸‰ã€ä¸‹ä¸€æ­¥æµ‹è¯•è®¡åˆ’

### 3.1 ç«‹å³æµ‹è¯•

è¯·**é‡å¯ Worker** å¹¶è¿è¡Œä¸€æ¬¡å®Œæ•´çš„ç§ä¿¡æŠ“å–ï¼š

```bash
cd packages/worker
npm start
```

### 3.2 é¢„æœŸç»“æœ

å¦‚æœå›é€€æˆåŠŸä¿®å¤é—®é¢˜ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
âœ… ç§ä¿¡æŠ“å–å®Œæˆ
   - ä¼šè¯æ•°: N ä¸ª
   - æ¶ˆæ¯æ•°: M æ¡ (M > 0)
   - æ¨é€ç»™ Master: M æ¡
```

### 3.3 å¦‚æœä»ç„¶å¤±è´¥

å¦‚æœå›é€€å**ä»ç„¶è¿”å› 0 æ¡æ¶ˆæ¯**ï¼Œè¯´æ˜ï¼š
1. é—®é¢˜ä¸æ˜¯æœªæäº¤çš„ä»£ç å¯¼è‡´çš„
2. å¯èƒ½æ˜¯å·²æäº¤çš„æ—¶é—´æˆ³ä¿®æ”¹ (`6d9ff28`) å¼•å…¥çš„é—®é¢˜
3. éœ€è¦ç»§ç»­å›é€€åˆ° `f7ac7be` ä¹‹å‰çš„ç‰ˆæœ¬

---

## å››ã€é—®é¢˜æ ¹å› åˆ†æï¼ˆå¾…æµ‹è¯•åè¿›è¡Œï¼‰

### 4.1 åˆ†ææ–¹æ³•

æµ‹è¯•å®Œæˆåï¼Œå¯¹æ¯”ä»¥ä¸‹ä¸¤ä¸ªç‰ˆæœ¬æ‰¾å‡ºå¼•å…¥é—®é¢˜çš„å…·ä½“ä»£ç ï¼š

**å¯å·¥ä½œç‰ˆæœ¬**:
```bash
git show 6d9ff28:packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js
```

**æœ‰é—®é¢˜çš„ç‰ˆæœ¬**:
```bash
# æŸ¥çœ‹å¤‡ä»½çš„ patch æ–‡ä»¶
cat crawl-dm-v2-debug-changes.patch
```

### 4.2 é‡ç‚¹æ£€æŸ¥åŒºåŸŸ

åŸºäºä¹‹å‰çš„åˆ†æï¼Œé—®é¢˜æœ€å¯èƒ½åœ¨ï¼š

1. **API æ‹¦æˆªå™¨** (`onMessageInitAPI` å‡½æ•°):
   ```javascript
   // å¯èƒ½çš„é—®é¢˜ï¼šäºŒè¿›åˆ¶æ£€æµ‹å¯¼è‡´æ­£å¸¸JSONä¹Ÿè¢«è·³è¿‡
   if (body.__isBinary) {
     // ...
     return; // â† æå‰è¿”å›ï¼Œæ¶ˆæ¯æœªä¿å­˜
   }
   ```

2. **é¡µé¢å¯¼èˆªé€»è¾‘**:
   ```javascript
   // å¯èƒ½çš„é—®é¢˜ï¼šwaitUntil æ”¹å˜å¯¼è‡´é¡µé¢æœªå®Œå…¨åŠ è½½
   await page.goto(..., {
     waitUntil: 'domcontentloaded',  // åŸæ¥æ˜¯ 'networkidle'
     timeout: 15000  // åŸæ¥æ˜¯ 30000
   });
   ```

3. **æ¶ˆæ¯æå–æ¡ä»¶**:
   ```javascript
   // å¯èƒ½çš„é—®é¢˜ï¼šæ¡ä»¶æ£€æŸ¥è¢«é”™è¯¯ä¿®æ”¹
   if (textContent || props.serverId) {  // è¿™ä¸ªæ¡ä»¶æ˜¯å¦è¢«æ”¹è¿‡ï¼Ÿ
     messages.push(message);
   }
   ```

---

## äº”ã€ä¸´æ—¶ç»“è®º

### 5.1 é—®é¢˜å®šä½

âœ… **ç¡®è®¤æ˜¯ä»£ç é€€åŒ–é—®é¢˜**
- Git æäº¤ç‰ˆæœ¬å¯ä»¥æ­£å¸¸å·¥ä½œ
- æœªæäº¤çš„å¤§é‡è°ƒè¯•ä»£ç å¯¼è‡´é—®é¢˜
- å·²å›é€€åˆ°å¯å·¥ä½œç‰ˆæœ¬

### 5.2 ä¸‹ä¸€æ­¥

1. âœ… **ç«‹å³**: é‡å¯ Worker æµ‹è¯•æ˜¯å¦æ¢å¤æ­£å¸¸
2. ğŸ“Š **æµ‹è¯•å**: åˆ†æ patch æ–‡ä»¶æ‰¾å‡ºå…·ä½“çš„ç ´åæ€§ä¿®æ”¹
3. ğŸ” **ä¿®å¤å**: é‡æ–°æ·»åŠ å¿…è¦çš„è°ƒè¯•æ—¥å¿—ï¼ˆä½†ä¸å¼•å…¥ bugï¼‰

---

## å…­ã€ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `crawl-direct-messages-v2.js` | å·²å›é€€åˆ° `6d9ff28` ç‰ˆæœ¬ |
| `crawl-dm-v2-debug-changes.patch` | å¤‡ä»½çš„æœªæäº¤ä¿®æ”¹ï¼ˆ1167 è¡Œï¼‰ |
| `ç§ä¿¡æŠ“å–è¿”å›0æ¶ˆæ¯é—®é¢˜-å®Œæ•´è¯Šæ–­æŠ¥å‘Š.md` | ä¹‹å‰çš„è¯Šæ–­æŠ¥å‘Š |
| `ç§ä¿¡æŠ“å–0æ¶ˆæ¯é—®é¢˜-æ—¥å¿—ä¼˜åŒ–å’Œè°ƒè¯•æ–¹æ¡ˆ.md` | æ—¥å¿—ä¼˜åŒ–æ–¹æ¡ˆ |
| `ç§ä¿¡æŠ“å–çœŸæ­£é—®é¢˜-ä¼šè¯ç‚¹å‡»å¤±è´¥.md` | ä¼šè¯ç‚¹å‡»å¤±è´¥åˆ†æ |

---

## ä¸ƒã€å…³é”®å‘½ä»¤å‚è€ƒ

```bash
# æŸ¥çœ‹Gitç‰ˆæœ¬çš„ä»£ç 
git show 6d9ff28:packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js

# æŸ¥çœ‹å¤‡ä»½çš„ä¿®æ”¹
cat crawl-dm-v2-debug-changes.patch

# å¦‚æœéœ€è¦æ¢å¤å¤‡ä»½çš„ä¿®æ”¹
git apply crawl-dm-v2-debug-changes.patch

# å¦‚æœéœ€è¦ç»§ç»­å›é€€åˆ°æ›´æ—©ç‰ˆæœ¬
git checkout f7ac7be -- packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js
```

---

**ç”Ÿæˆæ—¶é—´**: 2025-11-05 16:30
**ä¿®å¤çŠ¶æ€**: âœ… ä»£ç å·²å›é€€ï¼Œç­‰å¾…æµ‹è¯•éªŒè¯
**é¢„æœŸ**: æ¶ˆæ¯æŠ“å–åŠŸèƒ½åº”æ¢å¤æ­£å¸¸
