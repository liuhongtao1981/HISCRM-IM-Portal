# 浏览器内存优化指南

## 问题描述

默认情况下，每个账户的浏览器进程占用约 **600MB-1GB** 内存，这会导致：
- Worker 服务器内存不足
- 无法支持大量账户
- 系统性能下降

本指南提供内存优化方案，可将内存占用降低到 **150-350MB/账户**。

---

## 快速开始

### 1. 修改 Worker 配置

编辑 `packages/worker/.env` 文件：

```bash
# 选择内存优化预设（推荐 BALANCED）
BROWSER_MEMORY_PRESET=BALANCED
```

### 2. 重启 Worker

```bash
npm run start:worker
```

---

## 优化预设说明

系统提供 3 种内存优化预设，可根据需求选择：

| 预设 | 内存占用 | 稳定性 | 推荐场景 |
|------|---------|--------|---------|
| **MAXIMUM_SAVINGS** | 150-250MB | ⚠️ 较差 | 内存极度紧张，可容忍偶尔崩溃 |
| **BALANCED** ✅ | 200-350MB | ✅ 良好 | **推荐使用**，平衡内存和稳定性 |
| **MINIMAL** | 300-500MB | ✅✅ 最佳 | 追求稳定性，内存相对充足 |

### MAXIMUM_SAVINGS（最大节省）

**内存占用：** 150-250MB/账户
**稳定性：** ⚠️ 较差，可能崩溃

**优化措施：**
- ✅ 禁用 GPU 加速
- ✅ 禁用图片加载
- ✅ 单进程模式（内存节省最多，但稳定性差）
- ✅ 最小缓存（20MB 磁盘 + 10MB 内存）
- ✅ 禁用所有后台服务

**适用场景：**
- 服务器内存极度紧张（如 ≤4GB）
- 需要运行大量账户（>20 个）
- 可以容忍偶尔的浏览器崩溃

**配置方式：**
```bash
# .env
BROWSER_MEMORY_PRESET=MAXIMUM_SAVINGS
```

---

### BALANCED（平衡模式）✅ **推荐**

**内存占用：** 200-350MB/账户
**稳定性：** ✅ 良好

**优化措施：**
- ✅ 禁用 GPU 加速
- ✅ 保留图片加载（确保网站正常运行）
- ✅ 多进程模式（提高稳定性）
- ✅ 中等缓存（50MB 磁盘 + 20MB 内存）
- ✅ 禁用不必要的后台服务

**适用场景：**
- **大多数生产环境** ⭐
- 需要在内存占用和稳定性之间取得平衡
- 服务器内存 ≥8GB

**配置方式：**
```bash
# .env
BROWSER_MEMORY_PRESET=BALANCED
```

---

### MINIMAL（最小优化）

**内存占用：** 300-500MB/账户
**稳定性：** ✅✅ 最佳

**优化措施：**
- ⚠️ 保留 GPU 加速
- ✅ 保留图片加载
- ✅ 多进程模式
- ✅ 较大缓存（100MB 磁盘 + 50MB 内存）
- ✅ 仅禁用明显不需要的功能

**适用场景：**
- 追求最大稳定性
- 服务器内存充足（≥16GB）
- 账户数量较少（≤5 个）
- 调试和开发环境

**配置方式：**
```bash
# .env
BROWSER_MEMORY_PRESET=MINIMAL
```

---

## 优化原理

### 1. GPU 加速优化（节省 100-200MB）

禁用 GPU 可以显著减少内存占用：
```javascript
'--disable-gpu',
'--disable-gpu-compositing',
'--disable-gpu-rasterization',
```

**注意：** 禁用 GPU 可能影响复杂动画和 3D 渲染，但对普通网页影响不大。

### 2. 扩展和后台服务（节省 50-100MB）

禁用浏览器扩展和各种后台服务：
```javascript
'--disable-extensions',
'--disable-background-networking',
'--disable-sync',
```

### 3. 进程模型优化（节省 100-200MB）

**单进程模式** (`--single-process`)：
- ✅ 内存节省最多
- ⚠️ 稳定性较差，一个 tab 崩溃会导致整个浏览器崩溃

**多进程模式**（默认）：
- ✅ 稳定性好
- ⚠️ 内存占用较高

### 4. 缓存优化（节省 20-50MB）

限制磁盘和内存缓存大小：
```javascript
'--disk-cache-size=52428800',  // 50MB
'--media-cache-size=20971520', // 20MB
```

### 5. 音频/视频优化（节省 50-100MB）

如果不需要音频输出，可以禁用：
```javascript
'--disable-audio-output',
```

---

## 进阶优化

### 自定义优化参数

如果预设无法满足需求，可以直接修改 `packages/worker/src/config/browser-memory-optimization.js`：

```javascript
// 示例：创建自定义预设
const PRESETS = {
  // ... 现有预设

  // 自定义预设
  CUSTOM: {
    enableGPU: false,
    enableImages: true,
    diskCacheSize: 30,      // 自定义磁盘缓存大小（MB）
    memoryCacheSize: 15,    // 自定义内存缓存大小（MB）
    singleProcess: false,   // 使用多进程
  },
};
```

然后在 `.env` 中使用：
```bash
BROWSER_MEMORY_PRESET=CUSTOM
```

### 禁用图片加载（仅爬虫场景）

如果爬虫不需要图片，可以禁用图片加载以节省内存：

```javascript
// browser-memory-optimization.js
const PRESETS = {
  BALANCED: {
    // ...
    enableImages: false,  // 禁用图片
  },
};
```

**注意：** 很多网站依赖图片加载触发逻辑，禁用图片可能导致爬虫失败。

---

## 监控内存占用

### 1. 使用 PM2 监控

```bash
pm2 monit
```

### 2. 查看进程内存

```bash
# Linux/Mac
ps aux | grep chrome

# Windows
tasklist | findstr chrome
```

### 3. 记录内存使用日志

Worker 启动时会记录内存优化配置：
```
[browser-manager-v2] Using memory preset: BALANCED (estimated: 200-350MB)
```

---

## 常见问题

### Q1: 使用 MAXIMUM_SAVINGS 后浏览器频繁崩溃？

**解决方案：** 切换到 `BALANCED` 预设：
```bash
# .env
BROWSER_MEMORY_PRESET=BALANCED
```

单进程模式 (`--single-process`) 稳定性较差，`BALANCED` 使用多进程模式，稳定性更好。

---

### Q2: 优化后某些网站无法正常访问？

**可能原因：**
1. 网站依赖 GPU 渲染
2. 网站依赖图片加载触发逻辑
3. 网站依赖 Service Workers

**解决方案：** 切换到 `MINIMAL` 预设，或针对特定账户禁用优化。

---

### Q3: 如何针对不同账户使用不同的优化预设？

**当前版本：** 暂不支持按账户配置，所有账户使用相同的预设。

**计划支持：** 未来版本将支持账户级别的优化配置。

---

### Q4: 内存占用仍然很高怎么办？

**排查步骤：**

1. **检查 Worker 日志：** 确认优化配置已生效
   ```
   [browser-manager-v2] Using memory preset: BALANCED
   ```

2. **检查浏览器进程数：** 确保没有僵尸进程
   ```bash
   # Linux/Mac
   ps aux | grep chrome | wc -l

   # Windows
   tasklist | findstr chrome
   ```

3. **尝试更激进的优化：** 切换到 `MAXIMUM_SAVINGS`
   ```bash
   BROWSER_MEMORY_PRESET=MAXIMUM_SAVINGS
   ```

4. **减少账户数量：** 每个 Worker 建议 ≤10 个账户

5. **增加服务器内存：** 建议至少 8GB RAM

---

## 性能对比

| 场景 | 默认配置 | BALANCED | MAXIMUM_SAVINGS |
|------|---------|----------|-----------------|
| 单账户内存 | 600-1000MB | 200-350MB | 150-250MB |
| 10 账户总内存 | 6-10GB | 2-3.5GB | 1.5-2.5GB |
| 稳定性 | ✅✅ | ✅ | ⚠️ |
| 启动速度 | 中等 | 快 | 最快 |
| 推荐场景 | 开发调试 | **生产环境** ⭐ | 内存紧张 |

---

## 总结

1. **推荐使用 `BALANCED` 预设** - 在内存占用和稳定性之间取得最佳平衡
2. **内存极度紧张时使用 `MAXIMUM_SAVINGS`** - 但要注意稳定性问题
3. **追求稳定性时使用 `MINIMAL`** - 适合内存充足的环境
4. **定期监控内存占用** - 使用 PM2 或系统工具
5. **控制账户数量** - 每个 Worker 建议 ≤10 个账户

---

## 相关文档

- [多Browser架构详解](../docs/03-WORKER-系统文档.md)
- [Worker 配置说明](../packages/worker/README.md)
- [浏览器反检测机制](../docs/06-WORKER-爬虫调试指南.md)
