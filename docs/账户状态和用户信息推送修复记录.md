# 账户状态和用户信息推送修复记录

**日期**：2025-11-25
**问题**：登录状态和用户信息（头像、昵称）无法实时推送给 IM 客户端

## 问题分析

### 1. 事件名不匹配
- **现象**：IM 客户端收不到状态更新，必须手动 reload 才能看到
- **原因**：Master 推送 `channel:status_update` 事件，但 Electron 主进程监听 `master:account-status-updated`

### 2. Worker 未传递用户信息
- **现象**：数据库中 `platform_username`、`avatar`、`platform_user_id` 字段为 null
- **原因**：Worker 登录成功时获取了 userInfo，但未传递给 Master

### 3. Master 未保存用户信息
- **现象**：头像和昵称显示不正确
- **原因**：Master 登录成功处理器只更新了 `platform_user_id`，未更新昵称和头像字段

## 修复内容

### 修复 1：Electron 事件名匹配

**文件**：`packages/crm-pc-im/electron/main.ts`
**位置**：第 228 行

```typescript
// 修改前
socketClient.on('master:account-status-updated', (data) => {
  console.log('[Main] 收到账户状态更新:', data)
  if (mainWindow) {
    mainWindow.webContents.send('account-status-updated', data)
  }
})

// 修改后
socketClient.on('channel:status_update', (data) => {
  console.log('[Main] 收到账户状态更新:', data)
  // 转发给渲染进程（提取 channel 数据）
  if (mainWindow && data && data.channel) {
    mainWindow.webContents.send('account-status-updated', data.channel)
  }
})
```

**说明**：
- 修改监听的事件名为 `channel:status_update` 以匹配 Master 推送的事件
- 提取 `data.channel` 数据后转发给渲染进程

### 修复 2：Worker 传递用户信息

**文件**：`packages/worker/src/platforms/douyin/login-handler.js`

#### 2.1 修改登录状态轮询（第 619 行）

```javascript
// 修改前
if (loginStatus.isLoggedIn) {
  clearInterval(pollInterval);
  await this.handleLoginSuccess(accountId, sessionId);
  return;
}

// 修改后
if (loginStatus.isLoggedIn) {
  clearInterval(pollInterval);
  // 传递用户信息给 handleLoginSuccess
  await this.handleLoginSuccess(accountId, sessionId, loginStatus.userInfo);
  return;
}
```

#### 2.2 修改 handleLoginSuccess 方法签名（第 804 行）

```javascript
// 修改前
async handleLoginSuccess(accountId, sessionId) {

// 修改后
async handleLoginSuccess(accountId, sessionId, userInfo) {
```

#### 2.3 修改 notifyLoginSuccess 方法（第 861 行）

```javascript
// 修改前
notifyLoginSuccess(accountId, sessionId, cookies, cookiesValidUntil) {
  try {
    this.socketClient.emit('worker:login:success', {
      account_id: accountId,
      session_id: sessionId,
      cookies_valid_until: cookiesValidUntil,
      timestamp: Date.now(),
    });
  }
}

// 修改后
notifyLoginSuccess(accountId, sessionId, cookies, cookiesValidUntil, userInfo) {
  try {
    const payload = {
      account_id: accountId,
      session_id: sessionId,
      cookies_valid_until: cookiesValidUntil,
      timestamp: Date.now(),
    };

    // 如果有用户信息，包含在通知中
    if (userInfo) {
      payload.user_info = {
        platform_username: userInfo.nickname,
        avatar: userInfo.avatar,
        platform_user_id: userInfo.uid || userInfo.douyin_id,
        total_followers: userInfo.followers || 0,
        total_following: userInfo.following || 0,
      };
      logger.info(`Login success with user info: ${userInfo.nickname} (${userInfo.douyin_id})`);
    }

    this.socketClient.emit('worker:login:success', payload);
  }
}
```

**说明**：
- 在登录成功通知中包含完整的用户信息
- 将 Worker 获取的用户信息字段映射到 Master 数据库字段格式

### 修复 3：Master 保存用户信息

**文件**：`packages/master/src/login/login-handler.js`
**位置**：第 176-205 行

```javascript
// 修改前
if (userInfo && (userInfo.douyin_id || userInfo.uid)) {
  const currentAccount = this.db.prepare('SELECT platform_user_id FROM accounts WHERE id = ?').get(session.account_id);

  if (!currentAccount || !currentAccount.platform_user_id) {
    updateSql += ', platform_user_id = ?';
    const platformUserId = userInfo.douyin_id || userInfo.uid;
    params.push(platformUserId);
  }
}

// 修改后
if (userInfo) {
  const currentAccount = this.db.prepare('SELECT platform_user_id, platform_username, avatar FROM accounts WHERE id = ?').get(session.account_id);

  // 更新 platform_user_id（抖音号/uid），仅在为空时更新
  if (userInfo.douyin_id || userInfo.uid) {
    if (!currentAccount || !currentAccount.platform_user_id) {
      updateSql += ', platform_user_id = ?';
      const platformUserId = userInfo.douyin_id || userInfo.uid;
      params.push(platformUserId);
      logger.info(`Updated platform_user_id to: ${platformUserId}`);
    }
  }

  // 更新 platform_username（昵称）
  if (userInfo.nickname) {
    updateSql += ', platform_username = ?';
    params.push(userInfo.nickname);
    logger.info(`Updated platform_username to: ${userInfo.nickname}`);
  }

  // 更新 avatar（头像）
  if (userInfo.avatar) {
    updateSql += ', avatar = ?';
    params.push(userInfo.avatar);
    logger.info(`Updated avatar to: ${userInfo.avatar}`);
  }
}
```

**说明**：
- 添加了 `platform_username`（昵称）字段的更新
- 添加了 `avatar`（头像）字段的更新
- 保留了 `platform_user_id` 的更新逻辑（仅在为空时更新）

## 测试验证

### 测试步骤

1. **重启 Master 服务**：
   ```bash
   cd packages/master && npm start
   ```

2. **重启 Worker 服务**：
   ```bash
   cd packages/worker && npm start
   ```

3. **重启 Electron 客户端**：
   ```bash
   cd packages/crm-pc-im && npm run electron:dev
   ```

4. **手动登录测试**：
   - 在 IM 客户端中触发手动登录
   - 使用手机扫码登录
   - 观察登录成功后：
     - IM 客户端应自动显示登录状态（无需手动 reload）
     - 应显示用户头像和昵称
     - Master 日志应包含：`Updated platform_username to: xxx`、`Updated avatar to: xxx`

5. **查询数据库验证**：
   ```bash
   cd packages/master
   node check-account.js
   ```

   应显示：
   - `platform_username`: 用户昵称（非 null）
   - `avatar`: 头像 URL（非 null）
   - `platform_user_id`: 抖音号/UID（非 null）

### 预期结果

- ✅ 登录成功后，IM 客户端实时显示登录状态
- ✅ 头像正确显示
- ✅ 昵称正确显示
- ✅ 数据库字段正确更新

## 关联文件

### Worker 端
- `packages/worker/src/platforms/douyin/login-handler.js`：登录处理器
- `packages/worker/src/platforms/douyin/platform.js`：抖音平台实现（包含 `extractUserInfo` 方法）

### Master 端
- `packages/master/src/login/login-handler.js`：登录成功处理
- `packages/master/src/worker_manager/account-status-updater.js`：账户状态更新器（包含状态推送逻辑）
- `packages/master/src/index.js`：Master 初始化（注入 IM WebSocket Server）

### Electron 端
- `packages/crm-pc-im/electron/main.ts`：主进程（WebSocket 事件监听）
- `packages/crm-pc-im/electron/preload.ts`：预加载脚本
- `packages/crm-pc-im/src/pages/MonitorPage.tsx`：监控页面（接收状态更新）

## 注意事项

1. **Electron 需要重新编译**：修改 `main.ts` 后需要重新构建 Electron 主进程
2. **数据库字段映射**：
   - Worker `userInfo.nickname` → Master `platform_username`
   - Worker `userInfo.avatar` → Master `avatar`
   - Worker `userInfo.uid/douyin_id` → Master `platform_user_id`
3. **实时推送依赖**：需要 IM 客户端连接到 Master 的 WebSocket 服务器

## 后续优化建议

1. **统一事件命名规范**：建立 Master-Worker-Client 之间的事件命名约定
2. **用户信息更新策略**：考虑定期更新用户信息（粉丝数变化等）
3. **错误处理**：添加用户信息提取失败的容错处理

## 相关文档

- [Electron连接修复记录.md](./Electron连接修复记录.md)
- [手动登录功能实现文档.md](./手动登录功能实现文档.md)
