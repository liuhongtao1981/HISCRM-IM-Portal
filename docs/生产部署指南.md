# HisCRM-IM ç”Ÿäº§éƒ¨ç½²æŒ‡å—

æœ¬æ–‡æ¡£æä¾› HisCRM-IM ç³»ç»Ÿçš„å®Œæ•´ç”Ÿäº§éƒ¨ç½²æŒ‡å—ï¼ŒåŒ…æ‹¬æœåŠ¡å™¨çŽ¯å¢ƒå‡†å¤‡ã€ç»„ä»¶éƒ¨ç½²ã€é…ç½®ç®¡ç†å’Œè¿ç»´ç›‘æŽ§ã€‚

## ðŸ“‹ ç›®å½•

- [ç³»ç»Ÿæž¶æž„](#ç³»ç»Ÿæž¶æž„)
- [æœåŠ¡å™¨è¦æ±‚](#æœåŠ¡å™¨è¦æ±‚)
- [éƒ¨ç½²æµç¨‹](#éƒ¨ç½²æµç¨‹)
- [é…ç½®ç®¡ç†](#é…ç½®ç®¡ç†)
- [å®‰å…¨åŠ å›º](#å®‰å…¨åŠ å›º)
- [ç›‘æŽ§å’Œç»´æŠ¤](#ç›‘æŽ§å’Œç»´æŠ¤)
- [æ•…éšœæŽ’æŸ¥](#æ•…éšœæŽ’æŸ¥)
- [æ›´æ–°å’Œå›žæ»š](#æ›´æ–°å’Œå›žæ»š)

## ðŸ—ï¸ ç³»ç»Ÿæž¶æž„

### éƒ¨ç½²æž¶æž„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Internet                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Nginx (80/443) â”‚
              â”‚  - SSL ç»ˆæ­¢      â”‚
              â”‚  - åå‘ä»£ç†      â”‚
              â”‚  - è´Ÿè½½å‡è¡¡      â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Admin Web    â”‚ â”‚ Master   â”‚ â”‚  CRM PC IM   â”‚
â”‚  (Static)     â”‚ â”‚ (PM2)    â”‚ â”‚  (Electron)  â”‚
â”‚               â”‚ â”‚ Port:3000â”‚ â”‚  å®¢æˆ·ç«¯      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚             â”‚
                        â”‚ Socket.IO   â”‚
                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                        â”‚   SQLite    â”‚
                        â”‚  master.db  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç»„ä»¶è¯´æ˜Ž

| ç»„ä»¶ | æŠ€æœ¯æ ˆ | ç«¯å£ | éƒ¨ç½²ä½ç½® |
|------|--------|------|----------|
| **Master æœåŠ¡å™¨** | Node.js + Express + Socket.IO | 3000 | Linux æœåŠ¡å™¨ |
| **Admin Web** | React 18 + Ant Design | 80/443 | Nginx é™æ€æ‰˜ç®¡ |
| **CRM PC IM** | Electron + React | - | Windows å®¢æˆ·ç«¯ |
| **æ•°æ®åº“** | SQLite | - | Master æœ¬åœ° |

## ðŸ’» æœåŠ¡å™¨è¦æ±‚

### æœ€ä½Žé…ç½®

**Master æœåŠ¡å™¨ï¼ˆå•æœºéƒ¨ç½²ï¼‰**
- CPU: 2æ ¸
- å†…å­˜: 4GB
- å­˜å‚¨: 50GB SSD
- æ“ä½œç³»ç»Ÿ: Ubuntu 20.04/22.04 LTS
- ç½‘ç»œ: 10Mbps å¸¦å®½

**æŽ¨èé…ç½®ï¼ˆç”Ÿäº§çŽ¯å¢ƒï¼‰**
- CPU: 4æ ¸
- å†…å­˜: 8GB
- å­˜å‚¨: 100GB SSD
- æ“ä½œç³»ç»Ÿ: Ubuntu 22.04 LTS
- ç½‘ç»œ: 50Mbps å¸¦å®½

### è½¯ä»¶ä¾èµ–

- **Node.js**: >= 18.0.0
- **npm**: >= 9.0.0
- **PM2**: æœ€æ–°ç‰ˆæœ¬
- **Nginx**: >= 1.18.0
- **SQLite**: >= 3.35.0

### ç«¯å£è§„åˆ’

| ç«¯å£ | ç”¨é€” | å¼€æ”¾èŒƒå›´ |
|------|------|----------|
| 22 | SSH | ç®¡ç†å‘˜ IP |
| 80 | HTTP | å…¬ç½‘ |
| 443 | HTTPS | å…¬ç½‘ |
| 3000 | Master API/WebSocket | å…¬ç½‘ï¼ˆæˆ–é™åˆ¶ IPï¼‰ |

## ðŸš€ éƒ¨ç½²æµç¨‹

### æ–¹æ¡ˆä¸€ï¼šä¸€é”®è‡ªåŠ¨éƒ¨ç½²ï¼ˆæŽ¨èï¼‰

é€‚ç”¨äºŽå…¨æ–°æœåŠ¡å™¨ï¼Œè‡ªåŠ¨å®Œæˆæ‰€æœ‰å®‰è£…å’Œé…ç½®ã€‚

#### æ­¥éª¤ 1ï¼šå‡†å¤‡æœåŠ¡å™¨

```bash
# 1. é€šè¿‡ SSH ç™»å½•æœåŠ¡å™¨
ssh user@your-server-ip

# 2. æ›´æ–°ç³»ç»Ÿ
sudo apt-get update && sudo apt-get upgrade -y

# 3. åˆ›å»ºåº”ç”¨ç›®å½•
sudo mkdir -p /var/www/hiscrm-im
sudo chown -R $USER:$USER /var/www/hiscrm-im
```

#### æ­¥éª¤ 2ï¼šä¸Šä¼ ä»£ç 

```bash
# æ–¹æ³• 1: ä½¿ç”¨ Gitï¼ˆæŽ¨èï¼‰
cd /var/www/hiscrm-im
git clone https://github.com/your-org/hiscrm-im.git .

# æ–¹æ³• 2: ä½¿ç”¨ rsync
# åœ¨æœ¬åœ°æ‰§è¡Œï¼š
rsync -avz --exclude 'node_modules' --exclude '.git' \
      /local/path/hiscrm-im/ user@server:/var/www/hiscrm-im/

# æ–¹æ³• 3: ä½¿ç”¨ scp
# åœ¨æœ¬åœ°æ‰§è¡Œï¼š
tar czf hiscrm-im.tar.gz hiscrm-im/
scp hiscrm-im.tar.gz user@server:/var/www/
ssh user@server "cd /var/www && tar xzf hiscrm-im.tar.gz"
```

#### æ­¥éª¤ 3ï¼šå®‰è£…çŽ¯å¢ƒ

```bash
cd /var/www/hiscrm-im

# ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
chmod +x scripts/*.sh

# è¿è¡ŒçŽ¯å¢ƒå®‰è£…è„šæœ¬
bash scripts/install-environment.sh
```

æ­¤è„šæœ¬å°†è‡ªåŠ¨å®‰è£…ï¼š
- Node.js 18.x LTS
- npm å’Œ PM2
- Nginx
- SQLite3
- Playwright ä¾èµ–

#### æ­¥éª¤ 4ï¼šé…ç½®çŽ¯å¢ƒå˜é‡

**Master é…ç½®ï¼š**

```bash
# ä»Žæ¨¡æ¿åˆ›å»ºé…ç½®æ–‡ä»¶
cp scripts/config/master.env.production packages/master/.env

# ç¼–è¾‘é…ç½®æ–‡ä»¶
nano packages/master/.env
```

**å¿…é¡»ä¿®æ”¹çš„é…ç½®é¡¹ï¼š**

```env
# 1. ç”Ÿæˆå¹¶è®¾ç½®åŠ å¯†å¯†é’¥ï¼ˆ32å­—ç¬¦ï¼‰
ENCRYPTION_KEY=$(node -e "console.log(require('crypto').randomBytes(32).toString('hex'))")

# 2. è®¾ç½® CORS å…è®¸çš„æº
CORS_ORIGIN=https://admin.yourdomain.com

# 3. è®¾ç½®ç«¯å£ï¼ˆå¯é€‰ï¼Œé»˜è®¤ 3000ï¼‰
PORT=3000

# 4. è®¾ç½®æ—¥å¿—çº§åˆ«
LOG_LEVEL=info

# 5. å¯ç”¨æ€§èƒ½ç›‘æŽ§
MONITORING_ENABLED=true
```

**Admin Web é…ç½®ï¼š**

```bash
# ä»Žæ¨¡æ¿åˆ›å»ºé…ç½®æ–‡ä»¶
cp scripts/config/admin-web.env.production packages/admin-web/.env

# ç¼–è¾‘é…ç½®æ–‡ä»¶
nano packages/admin-web/.env
```

ä¿®æ”¹ Master æœåŠ¡å™¨åœ°å€ï¼š

```env
# ä½¿ç”¨å®žé™…çš„æœåŠ¡å™¨åœ°å€
REACT_APP_MASTER_URL=http://your-server-ip:3000
# æˆ–ä½¿ç”¨åŸŸå
REACT_APP_MASTER_URL=https://api.yourdomain.com
```

#### æ­¥éª¤ 5ï¼šä¸€é”®éƒ¨ç½²

```bash
# è¿è¡Œä¸€é”®éƒ¨ç½²è„šæœ¬
bash scripts/deploy-all.sh
```

è„šæœ¬å°†è‡ªåŠ¨å®Œæˆï¼š
1. å®‰è£…æ‰€æœ‰ npm ä¾èµ–
2. é…ç½®çŽ¯å¢ƒå˜é‡
3. éƒ¨ç½² Master æœåŠ¡å™¨ï¼ˆä½¿ç”¨ PM2ï¼‰
4. æž„å»ºå¹¶éƒ¨ç½² Admin Webï¼ˆä½¿ç”¨ Nginxï¼‰
5. é…ç½® Nginx åå‘ä»£ç†
6. å¯åŠ¨æ‰€æœ‰æœåŠ¡

#### æ­¥éª¤ 6ï¼šéªŒè¯éƒ¨ç½²

```bash
# 1. æ£€æŸ¥ Master æœåŠ¡çŠ¶æ€
pm2 status hiscrm-master

# 2. æµ‹è¯• Master API
curl http://localhost:3000/api/v1/health

# 3. æ£€æŸ¥ Nginx çŠ¶æ€
sudo systemctl status nginx

# 4. è®¿é—® Admin Web
# æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼šhttp://your-server-ip
```

### æ–¹æ¡ˆäºŒï¼šæ‰‹åŠ¨åˆ†æ­¥éƒ¨ç½²

é€‚ç”¨äºŽéœ€è¦è‡ªå®šä¹‰é…ç½®çš„åœºæ™¯ã€‚

#### 1. å•ç‹¬éƒ¨ç½² Master

```bash
cd /var/www/hiscrm-im

# é…ç½® .env
cp scripts/config/master.env.production packages/master/.env
nano packages/master/.env

# è¿è¡Œéƒ¨ç½²è„šæœ¬
bash scripts/deploy-master.sh
```

#### 2. å•ç‹¬éƒ¨ç½² Admin Web

```bash
# é…ç½® .env
cp scripts/config/admin-web.env.production packages/admin-web/.env
nano packages/admin-web/.env

# å¯é€‰ï¼šè®¾ç½®è‡ªå®šä¹‰åŸŸåå’Œç«¯å£
export ADMIN_DOMAIN="admin.yourdomain.com"
export NGINX_PORT=80

# è¿è¡Œéƒ¨ç½²è„šæœ¬
bash scripts/deploy-admin-web.sh
```

## ðŸ“¦ CRM PC IM å®¢æˆ·ç«¯æ‰“åŒ…

CRM PC IM æ˜¯ Windows æ¡Œé¢åº”ç”¨ï¼Œéœ€è¦åœ¨ Windows å¼€å‘æœºä¸Šæ‰“åŒ…ã€‚

### æ‰“åŒ…æ­¥éª¤

#### 1. é…ç½®ç”Ÿäº§çŽ¯å¢ƒåœ°å€

ç¼–è¾‘ `packages/crm-pc-im/config.json`ï¼š

```json
{
  "websocket": {
    "url": "http://your-production-server:3000"
  }
}
```

æˆ–ä½¿ç”¨æ¨¡æ¿ï¼š

```powershell
# å¤åˆ¶æ¨¡æ¿
copy scripts\config\crm-pc-im.config.production.json packages\crm-pc-im\config.json

# ç„¶åŽç¼–è¾‘æ–‡ä»¶ä¿®æ”¹ url
```

#### 2. è¿è¡Œæ‰“åŒ…è„šæœ¬

```powershell
# æ–¹æ³• 1: åŒå‡»è¿è¡Œ
scripts\build-pc-im.bat

# æ–¹æ³• 2: å‘½ä»¤è¡Œè¿è¡Œ
cd E:\HISCRM-IM-main
scripts\build-pc-im.bat
```

#### 3. åˆ†å‘å®¢æˆ·ç«¯

æ‰“åŒ…å®ŒæˆåŽï¼Œå¯æ‰§è¡Œæ–‡ä»¶ä½äºŽï¼š

```
packages/crm-pc-im/release/CRM-PC-IM.exe
```

å°†æ­¤æ–‡ä»¶åˆ†å‘ç»™ç”¨æˆ·ï¼Œç”¨æˆ·åŒå‡»å³å¯è¿è¡Œï¼ˆæ— éœ€å®‰è£…ï¼‰ã€‚

### å®¢æˆ·ç«¯éƒ¨ç½²æ³¨æ„äº‹é¡¹

1. **é˜²ç«å¢™è®¾ç½®**ï¼šç¡®ä¿æœåŠ¡å™¨ç«¯å£ 3000 å¯¹å®¢æˆ·ç«¯å¼€æ”¾
2. **HTTPS æ”¯æŒ**ï¼šå¦‚æžœä½¿ç”¨ HTTPSï¼Œéœ€è¦é…ç½®æœ‰æ•ˆçš„ SSL è¯ä¹¦
3. **é…ç½®æ›´æ–°**ï¼šå¦‚æžœæœåŠ¡å™¨åœ°å€å˜æ›´ï¼Œéœ€è¦é‡æ–°æ‰“åŒ…å®¢æˆ·ç«¯
4. **è‡ªåŠ¨æ›´æ–°**ï¼šç›®å‰ä¸æ”¯æŒè‡ªåŠ¨æ›´æ–°ï¼Œéœ€è¦æ‰‹åŠ¨åˆ†å‘æ–°ç‰ˆæœ¬

## âš™ï¸ é…ç½®ç®¡ç†

### Master æœåŠ¡å™¨é…ç½®è¯¦è§£

é…ç½®æ–‡ä»¶ï¼š`packages/master/.env`

#### æ ¸å¿ƒé…ç½®

```env
# æœåŠ¡ç«¯å£
PORT=3000

# ç›‘å¬åœ°å€ï¼ˆ0.0.0.0 è¡¨ç¤ºæ‰€æœ‰ç½‘å¡ï¼‰
HOST=0.0.0.0

# è¿è¡ŒçŽ¯å¢ƒ
NODE_ENV=production
```

#### æ•°æ®åº“é…ç½®

```env
# SQLite æ•°æ®åº“è·¯å¾„
DB_PATH=./data/master.db

# åŠ å¯†å¯†é’¥ï¼ˆç”¨äºŽè´¦æˆ·å‡­è¯åŠ å¯†ï¼‰
# å¿…é¡»æ˜¯ 32 å­—ç¬¦çš„éšæœºå­—ç¬¦ä¸²
ENCRYPTION_KEY=your-32-character-encryption-key-here
```

ç”ŸæˆåŠ å¯†å¯†é’¥ï¼š

```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

#### Worker ç®¡ç†é…ç½®

```env
# Worker å¿ƒè·³è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
WORKER_HEARTBEAT_TIMEOUT=30000

# æ¯ä¸ª Worker æœ€å¤šæ‰¿è½½è´¦å·æ•°
MAX_ACCOUNTS_PER_WORKER=10
```

#### çˆ¬è™«é…ç½®

```env
# ç›‘æŽ§é—´éš”ï¼ˆéšæœºèŒƒå›´ï¼Œé˜²æ­¢è¢«æ£€æµ‹ï¼‰
MONITOR_INTERVAL_MIN=15000
MONITOR_INTERVAL_MAX=30000

# æµè§ˆå™¨ headless æ¨¡å¼
BROWSER_HEADLESS=true

# æœ€å¤§æµè§ˆå™¨è¿›ç¨‹æ•°
MAX_BROWSERS_PER_WORKER=10
```

#### æ—¥å¿—é…ç½®

```env
# æ—¥å¿—çº§åˆ«ï¼šerror, warn, info, debug
LOG_LEVEL=info

# æ—¥å¿—ç›®å½•
LOG_DIR=./logs

# æœ€å¤§æ—¥å¿—æ–‡ä»¶æ•°
LOG_MAX_FILES=30

# å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§å¤§å°
LOG_MAX_SIZE=20m
```

#### Socket.IO é…ç½®

```env
# Ping è¶…æ—¶
SOCKET_PING_TIMEOUT=20000

# Ping é—´éš”
SOCKET_PING_INTERVAL=10000

# CORS å…è®¸çš„æº
# ç”Ÿäº§çŽ¯å¢ƒåº”è®¾ç½®å…·ä½“åŸŸå
CORS_ORIGIN=https://admin.example.com,https://crm.example.com
```

### Nginx é…ç½®è¯¦è§£

é…ç½®æ–‡ä»¶ï¼š`/etc/nginx/sites-available/hiscrm-admin-web`

#### åŸºæœ¬é…ç½®

```nginx
server {
    listen 80;
    server_name admin.yourdomain.com;

    root /var/www/html/hiscrm-admin;
    index index.html;

    # Gzip åŽ‹ç¼©
    gzip on;
    gzip_types text/plain text/css application/json application/javascript;

    # é™æ€èµ„æºç¼“å­˜
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # API ä»£ç†
    location /api/ {
        proxy_pass http://localhost:3000/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # WebSocket ä»£ç†
    location /socket.io/ {
        proxy_pass http://localhost:3000/socket.io/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # React Router æ”¯æŒ
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

#### HTTPS é…ç½®ï¼ˆä½¿ç”¨ Let's Encryptï¼‰

```bash
# å®‰è£… Certbot
sudo apt-get install -y certbot python3-certbot-nginx

# èŽ·å–è¯ä¹¦
sudo certbot --nginx -d admin.yourdomain.com

# è‡ªåŠ¨ç»­æœŸæµ‹è¯•
sudo certbot renew --dry-run
```

Certbot ä¼šè‡ªåŠ¨ä¿®æ”¹ Nginx é…ç½®ï¼Œæ·»åŠ  HTTPS æ”¯æŒã€‚

## ðŸ”’ å®‰å…¨åŠ å›º

### 1. é˜²ç«å¢™é…ç½®

ä½¿ç”¨ UFWï¼ˆUbuntuï¼‰ï¼š

```bash
# å¯ç”¨é˜²ç«å¢™
sudo ufw enable

# å…è®¸ SSH
sudo ufw allow 22/tcp

# å…è®¸ HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# å…è®¸ Master ç«¯å£ï¼ˆå¯é€‰é™åˆ¶ IPï¼‰
sudo ufw allow 3000/tcp
# æˆ–é™åˆ¶ç‰¹å®š IP
sudo ufw allow from 192.168.1.0/24 to any port 3000

# æŸ¥çœ‹çŠ¶æ€
sudo ufw status
```

### 2. SSH å®‰å…¨

ç¼–è¾‘ `/etc/ssh/sshd_config`ï¼š

```bash
# ç¦ç”¨ root ç™»å½•
PermitRootLogin no

# ç¦ç”¨å¯†ç ç™»å½•ï¼ˆæŽ¨èä½¿ç”¨å¯†é’¥ï¼‰
PasswordAuthentication no

# æ›´æ”¹é»˜è®¤ç«¯å£
Port 2222

# é‡å¯ SSH
sudo systemctl restart sshd
```

### 3. åº”ç”¨å®‰å…¨

#### å¼ºåŠ å¯†å¯†é’¥

```bash
# ç”Ÿæˆ 32 å­—ç¬¦éšæœºå¯†é’¥
ENCRYPTION_KEY=$(node -e "console.log(require('crypto').randomBytes(32).toString('hex'))")
echo "ENCRYPTION_KEY=$ENCRYPTION_KEY"
```

#### CORS é…ç½®

ç”Ÿäº§çŽ¯å¢ƒå¿…é¡»è®¾ç½®å…·ä½“åŸŸåï¼š

```env
# ä¸è¦ä½¿ç”¨ *
CORS_ORIGIN=https://admin.yourdomain.com,https://crm.yourdomain.com
```

#### æ—¥å¿—è„±æ•

ç¡®ä¿æ—¥å¿—ä¸åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ã€token ç­‰ï¼‰ã€‚

### 4. æ•°æ®åº“å®‰å…¨

```bash
# è®¾ç½®æ•°æ®åº“æ–‡ä»¶æƒé™
chmod 600 /var/www/hiscrm-im/packages/master/data/master.db

# å®šæœŸå¤‡ä»½
# æ·»åŠ åˆ° crontab
0 2 * * * cp /var/www/hiscrm-im/packages/master/data/master.db \
          /backup/master.db.$(date +\%Y\%m\%d)

# ä¿ç•™æœ€è¿‘ 30 å¤©çš„å¤‡ä»½
find /backup -name "master.db.*" -mtime +30 -delete
```

### 5. ç³»ç»Ÿæ›´æ–°

```bash
# å¯ç”¨è‡ªåŠ¨å®‰å…¨æ›´æ–°
sudo apt-get install unattended-upgrades
sudo dpkg-reconfigure -plow unattended-upgrades

# æ‰‹åŠ¨æ›´æ–°
sudo apt-get update
sudo apt-get upgrade -y
```

## ðŸ“Š ç›‘æŽ§å’Œç»´æŠ¤

### 1. PM2 ç›‘æŽ§

```bash
# å®žæ—¶ç›‘æŽ§
pm2 monit

# æŸ¥çœ‹æ—¥å¿—
pm2 logs hiscrm-master

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
pm2 show hiscrm-master

# æŸ¥çœ‹èµ„æºä½¿ç”¨
pm2 status
```

### 2. ç³»ç»Ÿç›‘æŽ§

```bash
# å®‰è£… htop
sudo apt-get install htop

# æŸ¥çœ‹ç³»ç»Ÿèµ„æº
htop

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h

# æŸ¥çœ‹ç½‘ç»œè¿žæŽ¥
sudo netstat -tulpn
```

### 3. æ—¥å¿—ç®¡ç†

```bash
# æŸ¥çœ‹ Master æ—¥å¿—
tail -f /var/www/hiscrm-im/packages/master/logs/combined.log

# æŸ¥çœ‹ PM2 æ—¥å¿—
pm2 logs hiscrm-master --lines 100

# æŸ¥çœ‹ Nginx æ—¥å¿—
sudo tail -f /var/log/nginx/error.log
sudo tail -f /var/log/nginx/access.log

# æ—¥å¿—è½®è½¬é…ç½®
# ç¼–è¾‘ /etc/logrotate.d/hiscrm-im
/var/www/hiscrm-im/packages/master/logs/*.log {
    daily
    rotate 30
    compress
    missingok
    notifempty
}
```

### 4. æ•°æ®åº“ç»´æŠ¤

```bash
# æ£€æŸ¥æ•°æ®åº“å¤§å°
ls -lh /var/www/hiscrm-im/packages/master/data/master.db

# ä¼˜åŒ–æ•°æ®åº“
sqlite3 /var/www/hiscrm-im/packages/master/data/master.db "VACUUM;"

# å®Œæ•´æ€§æ£€æŸ¥
sqlite3 /var/www/hiscrm-im/packages/master/data/master.db "PRAGMA integrity_check;"

# å¤‡ä»½æ•°æ®åº“
cp /var/www/hiscrm-im/packages/master/data/master.db \
   /backup/master.db.$(date +%Y%m%d-%H%M%S)
```

### 5. æ€§èƒ½ä¼˜åŒ–

#### PM2 Cluster æ¨¡å¼

```bash
# å¯åŠ¨å¤šä¸ªå®žä¾‹
pm2 scale hiscrm-master 4

# æˆ–åœ¨éƒ¨ç½²æ—¶è®¾ç½®
export PM2_INSTANCES=4
bash scripts/deploy-master.sh
```

#### Nginx ä¼˜åŒ–

ç¼–è¾‘ `/etc/nginx/nginx.conf`ï¼š

```nginx
worker_processes auto;
worker_connections 1024;

# å¯ç”¨ Gzip
gzip on;
gzip_comp_level 5;
gzip_types text/plain text/css application/json;

# å¯ç”¨ç¼“å­˜
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m;
```

## ðŸ› æ•…éšœæŽ’æŸ¥

### Master æ— æ³•å¯åŠ¨

**ç—‡çŠ¶**ï¼šPM2 æ˜¾ç¤º Master è¿›ç¨‹çŠ¶æ€ä¸º `errored`

**æŽ’æŸ¥æ­¥éª¤**ï¼š

1. æŸ¥çœ‹ PM2 æ—¥å¿—ï¼š
   ```bash
   pm2 logs hiscrm-master --lines 100 --err
   ```

2. æ£€æŸ¥ç«¯å£å ç”¨ï¼š
   ```bash
   sudo netstat -tulpn | grep 3000
   ```

3. æ£€æŸ¥é…ç½®æ–‡ä»¶ï¼š
   ```bash
   cat packages/master/.env
   # ç¡®è®¤ ENCRYPTION_KEY ç­‰å¿…è¦é…ç½®å­˜åœ¨
   ```

4. æ‰‹åŠ¨å¯åŠ¨æµ‹è¯•ï¼š
   ```bash
   cd packages/master
   node src/index.js
   ```

5. æ£€æŸ¥æ•°æ®åº“æƒé™ï¼š
   ```bash
   ls -l packages/master/data/master.db
   ```

### Admin Web æ— æ³•è®¿é—®

**ç—‡çŠ¶**ï¼šæµè§ˆå™¨æ— æ³•è®¿é—® Admin Web

**æŽ’æŸ¥æ­¥éª¤**ï¼š

1. æ£€æŸ¥ Nginx çŠ¶æ€ï¼š
   ```bash
   sudo systemctl status nginx
   ```

2. æµ‹è¯• Nginx é…ç½®ï¼š
   ```bash
   sudo nginx -t
   ```

3. æŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—ï¼š
   ```bash
   sudo tail -f /var/log/nginx/error.log
   ```

4. æ£€æŸ¥é™æ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼š
   ```bash
   ls -la /var/www/html/hiscrm-admin
   ```

5. æµ‹è¯•ç«¯å£æ˜¯å¦å¼€æ”¾ï¼š
   ```bash
   sudo netstat -tulpn | grep :80
   ```

### WebSocket è¿žæŽ¥å¤±è´¥

**ç—‡çŠ¶**ï¼šæµè§ˆå™¨æŽ§åˆ¶å°æ˜¾ç¤º WebSocket è¿žæŽ¥é”™è¯¯

**æŽ’æŸ¥æ­¥éª¤**ï¼š

1. æ£€æŸ¥ Master æ˜¯å¦è¿è¡Œï¼š
   ```bash
   pm2 status hiscrm-master
   ```

2. æµ‹è¯• WebSocket ç«¯å£ï¼š
   ```bash
   curl http://localhost:3000/socket.io/
   ```

3. æ£€æŸ¥é˜²ç«å¢™ï¼š
   ```bash
   sudo ufw status
   # ç¡®è®¤ç«¯å£ 3000 å·²å¼€æ”¾
   ```

4. æ£€æŸ¥ CORS é…ç½®ï¼š
   ```bash
   grep CORS_ORIGIN packages/master/.env
   ```

5. æŸ¥çœ‹æµè§ˆå™¨æŽ§åˆ¶å°é”™è¯¯ä¿¡æ¯

### æ•°æ®åº“é”å®šé”™è¯¯

**ç—‡çŠ¶**ï¼šæ—¥å¿—æ˜¾ç¤º `database is locked`

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ªè¿›ç¨‹è®¿é—®æ•°æ®åº“ï¼š
   ```bash
   lsof packages/master/data/master.db
   ```

2. ç¡®è®¤ WAL æ¨¡å¼å·²å¯ç”¨ï¼ˆåº”è¯¥å·²é»˜è®¤å¯ç”¨ï¼‰

3. é‡å¯ Master æœåŠ¡ï¼š
   ```bash
   pm2 restart hiscrm-master
   ```

### å†…å­˜å ç”¨è¿‡é«˜

**ç—‡çŠ¶**ï¼šç³»ç»Ÿå†…å­˜ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. æŸ¥çœ‹è¿›ç¨‹å†…å­˜ä½¿ç”¨ï¼š
   ```bash
   pm2 status
   ```

2. é…ç½®å†…å­˜é™åˆ¶ï¼š
   ```bash
   pm2 restart hiscrm-master --max-memory-restart 500M
   ```

3. è°ƒæ•´ Worker é…ç½®ï¼š
   ```env
   MAX_ACCOUNTS_PER_WORKER=5  # å‡å°‘æ¯ä¸ª Worker çš„è´¦æˆ·æ•°
   MAX_BROWSERS_PER_WORKER=5  # å‡å°‘æµè§ˆå™¨è¿›ç¨‹æ•°
   ```

## ðŸ”„ æ›´æ–°å’Œå›žæ»š

### æ›´æ–°æµç¨‹

#### 1. å¤‡ä»½

```bash
# å¤‡ä»½æ•°æ®åº“
cp /var/www/hiscrm-im/packages/master/data/master.db \
   /backup/master.db.$(date +%Y%m%d-%H%M%S)

# å¤‡ä»½é…ç½®æ–‡ä»¶
cp /var/www/hiscrm-im/packages/master/.env \
   /backup/master.env.$(date +%Y%m%d-%H%M%S)

# å¤‡ä»½ä»£ç 
cd /var/www
tar czf hiscrm-im-backup-$(date +%Y%m%d-%H%M%S).tar.gz hiscrm-im/
```

#### 2. æ‹‰å–æ–°ä»£ç 

```bash
cd /var/www/hiscrm-im

# Git æ–¹å¼
git pull origin main

# æˆ–æ‰‹åŠ¨ä¸Šä¼ æ–°ä»£ç 
```

#### 3. å®‰è£…ä¾èµ–

```bash
# å®‰è£…æ–°ä¾èµ–
npm install
cd packages/master && npm install
cd ../admin-web && npm install
cd ../shared && npm install
```

#### 4. é‡æ–°éƒ¨ç½²

```bash
# é‡æ–°éƒ¨ç½² Master
pm2 restart hiscrm-master

# é‡æ–°æž„å»º Admin Web
cd packages/admin-web
npm run build
sudo rm -rf /var/www/html/hiscrm-admin/*
sudo cp -r build/* /var/www/html/hiscrm-admin/
```

#### 5. éªŒè¯æ›´æ–°

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs hiscrm-master --lines 50

# æµ‹è¯• API
curl http://localhost:3000/api/v1/health

# è®¿é—® Admin Web
```

### å›žæ»šæµç¨‹

å¦‚æžœæ›´æ–°å‡ºçŽ°é—®é¢˜ï¼ŒæŒ‰ä»¥ä¸‹æ­¥éª¤å›žæ»šï¼š

```bash
# 1. åœæ­¢æœåŠ¡
pm2 stop hiscrm-master

# 2. æ¢å¤ä»£ç 
cd /var/www
tar xzf hiscrm-im-backup-YYYYMMDD-HHMMSS.tar.gz

# 3. æ¢å¤æ•°æ®åº“ï¼ˆå¦‚æžœéœ€è¦ï¼‰
cp /backup/master.db.YYYYMMDD-HHMMSS \
   /var/www/hiscrm-im/packages/master/data/master.db

# 4. æ¢å¤é…ç½®ï¼ˆå¦‚æžœéœ€è¦ï¼‰
cp /backup/master.env.YYYYMMDD-HHMMSS \
   /var/www/hiscrm-im/packages/master/.env

# 5. é‡å¯æœåŠ¡
pm2 restart hiscrm-master

# 6. éªŒè¯
pm2 logs hiscrm-master
```

### é›¶åœæœºæ›´æ–°ï¼ˆä½¿ç”¨ PM2 Clusterï¼‰

å¦‚æžœä½¿ç”¨ PM2 Cluster æ¨¡å¼ï¼Œå¯ä»¥å®žçŽ°é›¶åœæœºæ›´æ–°ï¼š

```bash
# 1. æ‹‰å–æ–°ä»£ç 
cd /var/www/hiscrm-im
git pull

# 2. å®‰è£…ä¾èµ–
npm install

# 3. å¹³æ»‘é‡å¯ï¼ˆé›¶åœæœºï¼‰
pm2 reload hiscrm-master
```

## ðŸ“ˆ æ‰©å±•éƒ¨ç½²

### å¤š Worker éƒ¨ç½²

åœ¨ä¸åŒæœåŠ¡å™¨ä¸Šéƒ¨ç½²å¤šä¸ª Worker å®žä¾‹ï¼š

```bash
# åœ¨ Worker æœåŠ¡å™¨ä¸Š
cd /var/www/hiscrm-im/packages/worker

# é…ç½® .env
cat > .env <<EOF
WORKER_ID=worker-2
WORKER_PORT=4001
MASTER_HOST=master-server-ip
MASTER_PORT=3000
EOF

# ä½¿ç”¨ PM2 å¯åŠ¨
pm2 start src/index.js \
    --name hiscrm-worker-2 \
    --env NODE_ENV=production
```

### è´Ÿè½½å‡è¡¡

å¦‚æžœéœ€è¦éƒ¨ç½²å¤šä¸ª Master å®žä¾‹ï¼Œä½¿ç”¨ Nginx è´Ÿè½½å‡è¡¡ï¼š

```nginx
upstream master_backend {
    server 127.0.0.1:3000;
    server 127.0.0.1:3001;
    server 127.0.0.1:3002;
}

server {
    listen 80;

    location /api/ {
        proxy_pass http://master_backend/api/;
    }

    location /socket.io/ {
        proxy_pass http://master_backend/socket.io/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # ä¼šè¯ä¿æŒï¼ˆWebSocket éœ€è¦ï¼‰
        ip_hash;
    }
}
```

## ðŸ“ž æŠ€æœ¯æ”¯æŒ

### æ–‡æ¡£èµ„æº

- **ç³»ç»Ÿæ–‡æ¡£**ï¼š`docs/` ç›®å½•
- **Master æ–‡æ¡£**ï¼š`docs/02-MASTER-ç³»ç»Ÿæ–‡æ¡£.md`
- **Worker æ–‡æ¡£**ï¼š`docs/03-WORKER-ç³»ç»Ÿæ–‡æ¡£.md`
- **è„šæœ¬è¯´æ˜Ž**ï¼š`scripts/README.md`

### æ—¥å¿—ä½ç½®

- **Master æ—¥å¿—**ï¼š`/var/www/hiscrm-im/packages/master/logs/`
- **PM2 æ—¥å¿—**ï¼š`~/.pm2/logs/`
- **Nginx æ—¥å¿—**ï¼š`/var/log/nginx/`
- **ç³»ç»Ÿæ—¥å¿—**ï¼š`/var/log/syslog`

### å¸¸è§é—®é¢˜

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æŒ‰ä»¥ä¸‹é¡ºåºæŽ’æŸ¥ï¼š

1. æŸ¥çœ‹ç›¸å…³æœåŠ¡çš„æ—¥å¿—
2. æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®
3. ç¡®è®¤ç«¯å£å’Œé˜²ç«å¢™è®¾ç½®
4. æµ‹è¯•ç½‘ç»œè¿žæŽ¥
5. æŸ¥é˜…æ•…éšœæŽ’æŸ¥ç« èŠ‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åŽæ›´æ–°**: 2025-01-20
**é€‚ç”¨ç‰ˆæœ¬**: HisCRM-IM v1.0+
