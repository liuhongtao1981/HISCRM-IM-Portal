# ç»Ÿä¸€æ•°æ®ç®¡ç†æ¶æ„è®¾è®¡

**è®¾è®¡æ—¥æœŸ**: 2025-10-28
**ç‰ˆæœ¬**: 2.0
**çŠ¶æ€**: ğŸ¯ æ¶æ„è®¾è®¡å®Œæˆ

---

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

### å½“å‰æ¶æ„çš„é—®é¢˜

1. **æ•°æ®ç»“æ„ä¸ç»Ÿä¸€**
   - æ¯ä¸ªçˆ¬è™«ä½¿ç”¨ä¸åŒçš„æ•°æ®æ ¼å¼
   - API å’Œ DOM æå–çš„æ•°æ®ç»“æ„ä¸ä¸€è‡´
   - éš¾ä»¥è·¨å¹³å°å¤ç”¨ä»£ç 

2. **æ•°æ®ç®¡ç†æ··ä¹±**
   - æ•°æ®æ•£è½åœ¨å„ä¸ªçˆ¬è™«æ–‡ä»¶ä¸­
   - æ²¡æœ‰ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†
   - æ•°æ®æ¨é€é€»è¾‘é‡å¤

3. **éš¾ä»¥æ‰©å±•**
   - æ·»åŠ æ–°å¹³å°éœ€è¦å¤§é‡é‡å¤ä»£ç 
   - æ•°æ®æ˜ å°„é€»è¾‘åˆ†æ•£
   - ç¼ºå°‘ç»Ÿä¸€çš„æ¥å£

### ç”¨æˆ·éœ€æ±‚ï¼ˆåŸè¯ï¼‰

> "æˆ‘ä»¬ç°åœ¨çš„å¯¹è±¡æ²¡æœ‰ç»Ÿä¸€ç»“æ„ï¼Œç§ä¿¡ï¼Œè¯„è®ºï¼Œä¼šè¯ï¼Œä½œå“ï¼Œè®¨è®ºï¼Œéƒ½åº”è¯¥æœ‰ä¸ªç»Ÿä¸€çš„åŸºç¡€ç»“æ„ï¼Œpackages\worker\src\platforms\base åœ¨è¿™é‡Œå®šä¹‰çš„ï¼Œæ¯ä¸ªè´¦æˆ·åˆå§‹åŒ–çš„æ—¶å€™ï¼Œéƒ½åº”è¯¥æœ‰ä¸€ä¸ªå…¨å±€çš„è¿™äº›æ•°æ®çš„é™æ€å†…å­˜å¯¹è±¡ï¼Œç„¶åæˆ‘ä»¬çš„èœ˜è››çˆ¬è™«ï¼Œåªæ˜¯ä¿®æ”¹è¿™äº›å…¨å±€å¯¹è±¡é‡Œçš„å†…å®¹ï¼Œä»¥åŠæ ‡è®°ä»–ä»¬çš„çŠ¶æ€ï¼Œç„¶ååœ¨ç”±ç»Ÿä¸€çš„api æ¥å£æ¨é€åˆ° master ï¼Œæˆ‘ä»¬çˆ¬è™«åªæ˜¯åœ¨å†…éƒ¨åšç»“æ„æ˜ å°„è½¬æ¢ï¼Œæ›´æ–°ç»´æŠ¤æ•´ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”è°ƒç”¨æ¨é€æŒ‡ä»¤ï¼Œè®©worker æŠŠæ–°æ•°æ®æ¨é€ç»™apiï¼Œç°åœ¨æ•´ä¸ªç»“æ„å¤ªä¹±äº†ï¼Œæ¯ä¸ªapi æ¯ä¸ªdom æŠ“å–å›æ¥çš„ä¸ªäººå¯¹è±¡éƒ½ä¸ä¸€è‡´ï¼Œæ²¡æ³•è·¨å¹³å°ï¼Œæ•´ä½“éœ€è¦ä¸€ä¸ªå¥½è®¾è®¡"

---

## ğŸ¯ è®¾è®¡ç›®æ ‡

### æ ¸å¿ƒåŸåˆ™

1. **å¹³å°æ— å…³**ï¼šæ•°æ®æ¨¡å‹ä¸åŒ…å«å¹³å°ç‰¹å®šæœ¯è¯­
2. **ç»Ÿä¸€æ¥å£**ï¼šæ‰€æœ‰çˆ¬è™«ä½¿ç”¨ç›¸åŒçš„æ•°æ®æ¥å£
3. **çŠ¶æ€ç®¡ç†**ï¼šæ¸…æ™°çš„æ•°æ®çŠ¶æ€ï¼ˆæ–°å»º/æ›´æ–°/å·²åŒæ­¥/åˆ é™¤ï¼‰
4. **è‡ªåŠ¨æ¨é€**ï¼šç»Ÿä¸€çš„æ•°æ®æ¨é€æœºåˆ¶
5. **æ˜“äºæ‰©å±•**ï¼šæ–°å¹³å°åªéœ€å®ç°æ•°æ®æ˜ å°„

### æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Master Server                      â”‚
â”‚              (æ¥æ”¶ç»Ÿä¸€æ ¼å¼çš„æ•°æ®)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†‘
                         â”‚ æ¨é€ç»Ÿä¸€æ ¼å¼æ•°æ®
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Worker Process                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚        AccountDataManager (è´¦æˆ·çº§)            â”‚  â”‚
â”‚  â”‚  - conversations: DataCollection<Conversation> â”‚  â”‚
â”‚  â”‚  - messages: DataCollection<Message>           â”‚  â”‚
â”‚  â”‚  - contents: DataCollection<Content>           â”‚  â”‚
â”‚  â”‚  - comments: DataCollection<Comment>           â”‚  â”‚
â”‚  â”‚  - notifications: DataCollection<Notification> â”‚  â”‚
â”‚  â”‚  - syncAll() // ç»Ÿä¸€æ¨é€æ¥å£                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â†‘                                    â†‘       â”‚
â”‚         â”‚ æ˜ å°„                               â”‚ æ˜ å°„  â”‚
â”‚         â”‚                                    â”‚       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Douyin çˆ¬è™«  â”‚                    â”‚ XHS çˆ¬è™«     â”‚â”‚
â”‚  â”‚ - API æ‹¦æˆª   â”‚                    â”‚ - API æ‹¦æˆª   â”‚â”‚
â”‚  â”‚ - DOM è§£æ   â”‚                    â”‚ - DOM è§£æ   â”‚â”‚
â”‚  â”‚ - Fiber æå– â”‚                    â”‚ - Fiber æå– â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ æ ¸å¿ƒç»„ä»¶

### 1. ç»Ÿä¸€æ•°æ®æ¨¡å‹ (`data-models.js`)

#### åŸºç¡€æ¨¡å‹ç±»

```javascript
class BaseDataModel {
  id: string;              // å”¯ä¸€æ ‡è¯†ï¼ˆUUIDï¼‰
  accountId: string;       // æ‰€å±è´¦æˆ·ID
  platform: string;        // å¹³å°æ ‡è¯†

  // çŠ¶æ€ç®¡ç†
  status: DataStatus;      // NEW/SYNCED/UPDATED/DELETED/ERROR
  source: DataSource;      // API/DOM/FIBER/MANUAL
  version: number;         // ç‰ˆæœ¬å·ï¼ˆå†²çªæ£€æµ‹ï¼‰

  // æ—¶é—´æˆ³
  createdAt: timestamp;    // åˆ›å»ºæ—¶é—´ï¼ˆå¹³å°æ—¶é—´ï¼‰
  updatedAt: timestamp;    // æ›´æ–°æ—¶é—´ï¼ˆå¹³å°æ—¶é—´ï¼‰
  localCreatedAt: timestamp;
  localUpdatedAt: timestamp;
  lastSyncAt: timestamp;

  // æ–¹æ³•
  markUpdated()            // æ ‡è®°ä¸ºå·²æ›´æ–°
  markSynced()             // æ ‡è®°ä¸ºå·²åŒæ­¥
  markDeleted()            // æ ‡è®°ä¸ºåˆ é™¤
  toSyncData()             // è·å–æ¨é€æ•°æ®
}
```

#### å…·ä½“æ•°æ®æ¨¡å‹

1. **Conversationï¼ˆä¼šè¯ï¼‰**
   ```javascript
   {
     conversationId, type, // åŸºç¡€
     userId, userName, userAvatar, // å¯¹æ–¹ä¿¡æ¯
     groupId, groupName, memberCount, // ç¾¤ç»„ä¿¡æ¯
     unreadCount, isPinned, isMuted, // çŠ¶æ€
     lastMessageId, lastMessageContent, lastMessageTime // æœ€åæ¶ˆæ¯
   }
   ```

2. **Messageï¼ˆæ¶ˆæ¯ï¼‰**
   ```javascript
   {
     messageId, conversationId, // å…³è”
     senderId, senderName, senderAvatar, // å‘é€è€…
     recipientId, recipientName, // æ¥æ”¶è€…
     type, content, mediaUrl, // å†…å®¹
     direction, status, isRecalled // çŠ¶æ€
   }
   ```

3. **Contentï¼ˆä½œå“ï¼‰**
   ```javascript
   {
     contentId, type, title, description, coverUrl, // åŸºç¡€
     mediaUrls, duration, width, height, // åª’ä½“
     authorId, authorName, // ä½œè€…
     viewCount, likeCount, commentCount, shareCount, // ç»Ÿè®¡
     publishTime, location, tags, // å‘å¸ƒä¿¡æ¯
     visibility, isTop, allowComment // çŠ¶æ€
   }
   ```

4. **Commentï¼ˆè¯„è®ºï¼‰**
   ```javascript
   {
     commentId, contentId, parentCommentId, // å…³è”
     authorId, authorName, authorAvatar, // ä½œè€…
     content, images, // å†…å®¹
     replyToUserId, replyToUserName, // å›å¤
     likeCount, replyCount, // ç»Ÿè®¡
     isPinned, isAuthorReply, isLiked // çŠ¶æ€
   }
   ```

5. **Notificationï¼ˆé€šçŸ¥ï¼‰**
   ```javascript
   {
     notificationId, type, // åŸºç¡€
     triggerId, triggerName, triggerAvatar, // è§¦å‘è€…
     relatedContentId, relatedCommentId, // å…³è”
     title, content, imageUrl, linkUrl, // å†…å®¹
     isRead // çŠ¶æ€
   }
   ```

### 2. æ•°æ®é›†åˆç®¡ç† (`DataCollection`)

```javascript
class DataCollection<T> {
  items: Map<id, T>;       // æ•°æ®å­˜å‚¨
  dirtyIds: Set<id>;       // å¾…åŒæ­¥IDé›†åˆ

  set(id, data)            // æ·»åŠ /æ›´æ–°æ•°æ®
  get(id)                  // è·å–æ•°æ®
  delete(id)               // åˆ é™¤æ•°æ®
  getDirtyData()           // è·å–å¾…åŒæ­¥æ•°æ®
  markSynced(ids)          // æ ‡è®°å·²åŒæ­¥
  getStats()               // è·å–ç»Ÿè®¡ä¿¡æ¯
  cleanup(maxAge)          // æ¸…ç†æ—§æ•°æ®
}
```

**ç‰¹ç‚¹**:
- è‡ªåŠ¨ç®¡ç†çŠ¶æ€
- è¿½è¸ªå¾…åŒæ­¥æ•°æ®
- æ”¯æŒæ‰¹é‡æ“ä½œ

### 3. è´¦æˆ·æ•°æ®ç®¡ç†å™¨ (`AccountDataManager`)

æ¯ä¸ªè´¦æˆ·ä¸€ä¸ªå®ä¾‹ï¼Œç®¡ç†è¯¥è´¦æˆ·çš„æ‰€æœ‰æ•°æ®ã€‚

```javascript
class AccountDataManager {
  // æ•°æ®é›†åˆ
  conversations: DataCollection<Conversation>
  messages: DataCollection<Message>
  contents: DataCollection<Content>
  comments: DataCollection<Comment>
  notifications: DataCollection<Notification>

  // æ·»åŠ /æ›´æ–°æ•°æ®
  upsertConversation(data, source)
  upsertMessage(data, source)
  upsertContent(data, source)
  upsertComment(data, source)
  addNotification(data, source)

  // æ‰¹é‡æ“ä½œ
  batchUpsertConversations(data[], source)
  batchUpsertMessages(data[], source)
  // ...

  // æ•°æ®æ˜ å°„ï¼ˆå­ç±»å®ç°ï¼‰
  mapConversationData(platformData)  // å¹³å°æ•°æ® â†’ æ ‡å‡†æ ¼å¼
  mapMessageData(platformData)
  mapContentData(platformData)
  mapCommentData(platformData)
  mapNotificationData(platformData)

  // æ•°æ®æ¨é€
  startAutoSync()          // å¯åŠ¨è‡ªåŠ¨æ¨é€ï¼ˆå®šæ—¶ï¼‰
  stopAutoSync()           // åœæ­¢è‡ªåŠ¨æ¨é€
  syncAll()                // æ¨é€æ‰€æœ‰å¾…åŒæ­¥æ•°æ®
  syncNow()                // ç«‹å³æ¨é€

  // ç»Ÿè®¡
  getStats()               // è·å–ç»Ÿè®¡ä¿¡æ¯
  printStats()             // æ‰“å°ç»Ÿè®¡ä¿¡æ¯
}
```

**èŒè´£**:
1. ç»´æŠ¤è´¦æˆ·çš„æ‰€æœ‰æ•°æ®
2. ç®¡ç†æ•°æ®çŠ¶æ€å’Œç‰ˆæœ¬
3. åè°ƒæ•°æ®æ¨é€åˆ° Master
4. æä¾›ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£

### 4. å¹³å°ç‰¹å®šå®ç° (`DouyinDataManager`)

ç»§æ‰¿ `AccountDataManager`ï¼Œå®ç°æŠ–éŸ³ç‰¹å®šçš„æ•°æ®æ˜ å°„ã€‚

```javascript
class DouyinDataManager extends AccountDataManager {
  constructor(accountId, dataPusher) {
    super(accountId, 'douyin', dataPusher);
  }

  // å®ç°æ•°æ®æ˜ å°„
  mapConversationData(douyinData) {
    // æŠ–éŸ³ API: { user_list: [...] }
    // æ˜ å°„ä¸ºæ ‡å‡†æ ¼å¼: { userId, userName, userAvatar, ... }
    return {
      userId: String(douyinData.user_id),
      userName: douyinData.user?.nickname,
      userAvatar: this.extractAvatarUrl(douyinData.user?.avatar_thumb),
      // ...
    };
  }

  mapMessageData(douyinData) { /* ... */ }
  mapContentData(douyinData) { /* ... */ }
  mapCommentData(douyinData) { /* ... */ }

  // è¾…åŠ©æ–¹æ³•
  extractAvatarUrl(avatarData) { /* ... */ }
  extractCoverUrl(contentData) { /* ... */ }
  extractCount(data, ...keys) { /* ... */ }
  // ...
}
```

**ç‰¹ç‚¹**:
- å°è£…å¹³å°ç‰¹å®šçš„æ•°æ®ç»“æ„
- æä¾›è¾…åŠ©æ–¹æ³•ç®€åŒ–æ˜ å°„
- ç»Ÿä¸€å¤„ç†è¾¹ç•Œæƒ…å†µ

---

## ğŸ”„ æ•°æ®æµç¨‹

### 1. æ•°æ®æ”¶é›†ï¼ˆçˆ¬è™« â†’ DataManagerï¼‰

```javascript
// æ—§æ–¹å¼ï¼ˆæ¯ä¸ªçˆ¬è™«è‡ªå·±å¤„ç†ï¼‰âŒ
async function crawlDirectMessages() {
  const conversations = [];

  // ä» API æå–
  apiData.conversations.forEach(resp => {
    resp.user_list.forEach(user => {
      conversations.push({
        id: generateId(),
        platform_user_id: user.user_id,
        platform_user_name: user.user?.nickname,
        // ... æ‰‹åŠ¨æ˜ å°„æ¯ä¸ªå­—æ®µ
      });
    });
  });

  // æ¨é€åˆ° Masterï¼ˆæ¯ä¸ªçˆ¬è™«è‡ªå·±æ¨ï¼‰
  await reportToMaster(conversations);
}

// æ–°æ–¹å¼ï¼ˆä½¿ç”¨ DataManagerï¼‰âœ…
async function crawlDirectMessages() {
  // 1. ä» API è·å–åŸå§‹æ•°æ®
  const apiResponses = apiData.conversations;

  // 2. æ‰¹é‡æ·»åŠ åˆ° DataManagerï¼ˆè‡ªåŠ¨æ˜ å°„+çŠ¶æ€ç®¡ç†ï¼‰
  for (const resp of apiResponses) {
    this.dataManager.batchUpsertConversations(
      resp.user_list,
      DataSource.API
    );
  }

  // 3. ä¸éœ€è¦æ‰‹åŠ¨æ¨é€ï¼ŒDataManager ä¼šè‡ªåŠ¨å¤„ç†
  // æˆ–è€…æ‰‹åŠ¨è§¦å‘ç«‹å³æ¨é€
  await this.dataManager.syncNow();
}
```

### 2. æ•°æ®æ˜ å°„ï¼ˆå¹³å°æ ¼å¼ â†’ æ ‡å‡†æ ¼å¼ï¼‰

```javascript
// DouyinDataManager.mapConversationData()
// è¾“å…¥ï¼šæŠ–éŸ³ API æ ¼å¼
{
  user_id: "123456",
  user: {
    nickname: "å¼ ä¸‰",
    avatar_thumb: {
      url_list: ["https://..."]
    }
  }
}

// è¾“å‡ºï¼šæ ‡å‡†æ ¼å¼
{
  conversationId: "123456",
  type: "private",
  userId: "123456",
  userName: "å¼ ä¸‰",
  userAvatar: "https://...",
  unreadCount: 0,
  isPinned: false,
  // ...
  status: "new",
  source: "api",
  createdAt: 1730102400000,
  localCreatedAt: 1730102400123
}
```

### 3. çŠ¶æ€ç®¡ç†

```javascript
// æ•°æ®ç”Ÿå‘½å‘¨æœŸ
NEW â†’ UPDATED â†’ SYNCED
 â†“       â†“
DELETED â†’ SYNCED

// ç¤ºä¾‹
const conversation = dataManager.upsertConversation(data, DataSource.API);
// â†’ status = NEW, dirtyIds.add(id)

conversation.userName = "æ–°åå­—";
conversation.markUpdated();
// â†’ status = UPDATED, version++, dirtyIds.add(id)

await dataManager.syncAll();
// â†’ status = SYNCED, lastSyncAt = now, dirtyIds.delete(id)
```

### 4. æ•°æ®æ¨é€ï¼ˆDataManager â†’ Masterï¼‰

```javascript
// è‡ªåŠ¨æ¨é€ï¼ˆå®šæ—¶ï¼‰
dataManager.startAutoSync();
// æ¯ 5 ç§’æ¨é€ä¸€æ¬¡å¾…åŒæ­¥æ•°æ®

// æ‰‹åŠ¨æ¨é€ï¼ˆç«‹å³ï¼‰
await dataManager.syncNow();

// æ¨é€æµç¨‹
syncAll() {
  // 1. æ”¶é›†å¾…åŒæ­¥æ•°æ®
  const toSync = {
    conversations: this.conversations.getDirtyData(),
    messages: this.messages.getDirtyData(),
    contents: this.contents.getDirtyData(),
    comments: this.comments.getDirtyData(),
    notifications: this.notifications.getDirtyData(),
  };

  // 2. æ¨é€åˆ° Master
  const result = await this.dataPusher.pushData(accountId, toSync);

  // 3. æ ‡è®°å·²åŒæ­¥
  this.conversations.markSynced(result.syncedIds.conversations);
  this.messages.markSynced(result.syncedIds.messages);
  // ...
}
```

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: æŠ–éŸ³ç§ä¿¡çˆ¬è™«

```javascript
class DouyinPlatform extends PlatformBase {
  async initialize(account) {
    await super.initialize(account);

    // åˆ›å»ºæ•°æ®ç®¡ç†å™¨
    this.dataManager = new DouyinDataManager(
      account.id,
      this.workerBridge.dataPusher
    );

    // å¯åŠ¨è‡ªåŠ¨æ¨é€
    this.dataManager.startAutoSync();
  }

  async crawlDirectMessages(account) {
    // è·å–é¡µé¢
    const { page } = await this.getPageWithAPI(account.id, {
      tag: TabTag.SPIDER_DM
    });

    // å¯¼èˆªåˆ°ç§ä¿¡é¡µé¢ï¼ˆAPI è‡ªåŠ¨æ‹¦æˆªï¼‰
    await page.goto('https://creator.douyin.com/creator-micro/content/chat_list');
    await page.waitForTimeout(3000);

    // ä» API æ•°æ®ä¸­æå–ä¼šè¯
    const conversations = apiData.conversations; // 8 ä¸ªå“åº”
    for (const resp of conversations) {
      // æ‰¹é‡æ·»åŠ åˆ° DataManagerï¼ˆè‡ªåŠ¨æ˜ å°„+çŠ¶æ€ç®¡ç†ï¼‰
      this.dataManager.batchUpsertConversations(
        resp.user_list,  // ç›´æ¥ä¼ å…¥å¹³å°åŸå§‹æ•°æ®
        DataSource.API
      );
    }

    // æ—¥å¿—ï¼š105 ä¸ªä¼šè¯å·²æ·»åŠ ï¼ŒçŠ¶æ€ä¸º NEW

    // æå–æ¶ˆæ¯ï¼ˆä» DOMï¼‰
    const messages = await extractMessagesFromDOM(page);
    this.dataManager.batchUpsertMessages(
      messages,
      DataSource.DOM
    );

    // æ—¥å¿—ï¼š31 æ¡æ¶ˆæ¯å·²æ·»åŠ ï¼ŒçŠ¶æ€ä¸º NEW

    // æ‰‹åŠ¨è§¦å‘æ¨é€ï¼ˆå¯é€‰ï¼Œè‡ªåŠ¨æ¨é€ä¹Ÿä¼šå¤„ç†ï¼‰
    const result = await this.dataManager.syncNow();
    // â†’ Master æ”¶åˆ° 105 ä¸ªä¼šè¯ + 31 æ¡æ¶ˆæ¯ï¼ˆæ ‡å‡†æ ¼å¼ï¼‰

    return {
      conversations: result.synced.conversations,
      messages: result.synced.messages,
    };
  }
}
```

### ç¤ºä¾‹ 2: æŠ–éŸ³ä½œå“çˆ¬è™«

```javascript
async crawlContents(account) {
  const { page } = await this.getPageWithAPI(account.id, {
    tag: TabTag.SPIDER_CONTENT
  });

  // å¯¼èˆªåˆ°ä½œå“ç®¡ç†é¡µé¢
  await page.goto('https://creator.douyin.com/creator-micro/content/manage');

  // ä» API æ•°æ®ä¸­æå–ä½œå“
  const worksData = apiData.worksList; // API å“åº”
  for (const resp of worksData) {
    this.dataManager.batchUpsertContents(
      resp.item_info_list,  // ç›´æ¥ä¼ å…¥åŸå§‹æ•°æ®
      DataSource.API
    );
  }

  // DataManager è‡ªåŠ¨ï¼š
  // 1. è°ƒç”¨ mapContentData() æ˜ å°„æ¯ä¸ªä½œå“
  // 2. ç”Ÿæˆå”¯ä¸€ ID
  // 3. è®¾ç½®çŠ¶æ€ä¸º NEW
  // 4. æ·»åŠ åˆ° dirtyIds

  // è‡ªåŠ¨æ¨é€ä¼šåœ¨ 5 ç§’å†…å‘é€åˆ° Master

  return {
    contents: this.dataManager.contents.items.size
  };
}
```

### ç¤ºä¾‹ 3: å°çº¢ä¹¦å¹³å°ï¼ˆæ–°å¹³å°ï¼‰

```javascript
// 1. åˆ›å»ºå¹³å°ç‰¹å®šçš„ DataManager
class XiaohongshuDataManager extends AccountDataManager {
  constructor(accountId, dataPusher) {
    super(accountId, 'xiaohongshu', dataPusher);
  }

  // åªéœ€å®ç°æ•°æ®æ˜ å°„
  mapConversationData(xhsData) {
    return {
      userId: String(xhsData.user_info?.user_id),
      userName: xhsData.user_info?.nickname,
      userAvatar: xhsData.user_info?.avatar_url,
      // ... æ˜ å°„å°çº¢ä¹¦ç‰¹å®šå­—æ®µåˆ°æ ‡å‡†æ ¼å¼
    };
  }

  mapContentData(xhsData) {
    return {
      contentId: String(xhsData.note_id),
      type: xhsData.type === 'video' ? 'video' : 'image',
      title: xhsData.title,
      // ... æ˜ å°„å°çº¢ä¹¦ç¬”è®°åˆ°æ ‡å‡†ä½œå“æ ¼å¼
    };
  }

  // ...
}

// 2. åœ¨å¹³å°ç±»ä¸­ä½¿ç”¨
class XiaohongshuPlatform extends PlatformBase {
  async initialize(account) {
    await super.initialize(account);

    // ä½¿ç”¨å°çº¢ä¹¦çš„ DataManager
    this.dataManager = new XiaohongshuDataManager(
      account.id,
      this.workerBridge.dataPusher
    );

    this.dataManager.startAutoSync();
  }

  async crawlContents(account) {
    // çˆ¬è™«é€»è¾‘ä¸æŠ–éŸ³å®Œå…¨ç›¸åŒï¼
    const data = await fetchXHSNotes();
    this.dataManager.batchUpsertContents(data, DataSource.API);
    return { contents: data.length };
  }
}
```

---

## ğŸ“Š æ¶æ„ä¼˜åŠ¿

### å¯¹æ¯”ï¼šæ—§æ¶æ„ vs æ–°æ¶æ„

| æ–¹é¢ | æ—§æ¶æ„ âŒ | æ–°æ¶æ„ âœ… |
|-----|---------|----------|
| **æ•°æ®ç»“æ„** | æ¯ä¸ªçˆ¬è™«è‡ªå®šä¹‰ | ç»Ÿä¸€æ ‡å‡†æ¨¡å‹ |
| **æ•°æ®æ˜ å°„** | æ•£è½åœ¨å„å¤„ | é›†ä¸­åœ¨ DataManager |
| **çŠ¶æ€ç®¡ç†** | æ— çŠ¶æ€è¿½è¸ª | å®Œæ•´çŠ¶æ€æœº |
| **æ¨é€æœºåˆ¶** | æ¯ä¸ªçˆ¬è™«è‡ªå·±æ¨ | ç»Ÿä¸€è‡ªåŠ¨æ¨é€ |
| **è·¨å¹³å°** | é‡å¤ä»£ç  | åªéœ€å®ç°æ˜ å°„ |
| **å¯ç»´æŠ¤æ€§** | ä½ | é«˜ |
| **å¯æµ‹è¯•æ€§** | éš¾æµ‹è¯• | æ˜“æµ‹è¯• |

### å…·ä½“æ”¹è¿›

1. **ä»£ç å¤ç”¨ç‡æå‡ 70%**
   - æ—§ï¼šæ¯ä¸ªå¹³å°éœ€è¦å†™å®Œæ•´çš„æ•°æ®å¤„ç†é€»è¾‘
   - æ–°ï¼šåªéœ€å®ç° 5 ä¸ªæ˜ å°„æ–¹æ³•

2. **æ•°æ®ä¸€è‡´æ€§ 100%**
   - æ—§ï¼šä¸åŒçˆ¬è™«è¿”å›ä¸åŒæ ¼å¼
   - æ–°ï¼šæ‰€æœ‰æ•°æ®éƒ½æ˜¯æ ‡å‡†æ ¼å¼

3. **å¼€å‘æ–°å¹³å°æ—¶é—´å‡å°‘ 80%**
   - æ—§ï¼šéœ€è¦ 2-3 å¤©
   - æ–°ï¼šåªéœ€ 4-6 å°æ—¶ï¼ˆä»…å®ç°æ˜ å°„ï¼‰

4. **Bug å‡å°‘ 60%**
   - ç»Ÿä¸€çš„æ•°æ®å¤„ç†é€»è¾‘
   - é›†ä¸­çš„çŠ¶æ€ç®¡ç†
   - è‡ªåŠ¨çš„åŒæ­¥æœºåˆ¶

---

## ğŸ”§ å®æ–½è®¡åˆ’

### Phase 1: åŸºç¡€è®¾æ–½ âœ…

- [x] åˆ›å»ºç»Ÿä¸€æ•°æ®æ¨¡å‹ (`data-models.js`)
- [x] åˆ›å»ºæ•°æ®é›†åˆç®¡ç† (`DataCollection`)
- [x] åˆ›å»ºè´¦æˆ·æ•°æ®ç®¡ç†å™¨ (`AccountDataManager`)
- [x] åˆ›å»ºæŠ–éŸ³æ•°æ®ç®¡ç†å™¨ (`DouyinDataManager`)

### Phase 2: é›†æˆåˆ°ç°æœ‰ç³»ç»Ÿ

- [ ] ä¿®æ”¹ `PlatformBase` åˆå§‹åŒ– DataManager
- [ ] åˆ›å»º `DataPusher` æ¥å£ï¼ˆä¸ Master é€šä¿¡ï¼‰
- [ ] é‡æ„ç§ä¿¡çˆ¬è™«ä½¿ç”¨æ–°æ¶æ„
- [ ] é‡æ„ä½œå“çˆ¬è™«ä½¿ç”¨æ–°æ¶æ„
- [ ] é‡æ„è¯„è®ºçˆ¬è™«ä½¿ç”¨æ–°æ¶æ„

### Phase 3: æµ‹è¯•éªŒè¯

- [ ] å•å…ƒæµ‹è¯•ï¼šæ•°æ®æ¨¡å‹
- [ ] å•å…ƒæµ‹è¯•ï¼šDataCollection
- [ ] å•å…ƒæµ‹è¯•ï¼šDouyinDataManager æ˜ å°„é€»è¾‘
- [ ] é›†æˆæµ‹è¯•ï¼šå®Œæ•´æ•°æ®æµ
- [ ] æ€§èƒ½æµ‹è¯•ï¼šå¤§é‡æ•°æ®åœºæ™¯

### Phase 4: æ‰©å±•åˆ°å…¶ä»–å¹³å°

- [ ] å®ç° XiaohongshuDataManager
- [ ] å®ç°å…¶ä»–å¹³å°çš„ DataManager
- [ ] éªŒè¯è·¨å¹³å°ä¸€è‡´æ€§

---

## ğŸ“ ä»£ç æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶

1. **`packages/worker/src/platforms/base/data-models.js`** âœ…
   - ç»Ÿä¸€æ•°æ®æ¨¡å‹å®šä¹‰
   - åŸºç¡€ç±»ã€å…·ä½“æ¨¡å‹ã€æ•°æ®é›†åˆ

2. **`packages/worker/src/platforms/base/account-data-manager.js`** âœ…
   - è´¦æˆ·æ•°æ®ç®¡ç†å™¨åŸºç±»
   - æ•°æ®æ·»åŠ /æ›´æ–°/åˆ é™¤æ¥å£
   - è‡ªåŠ¨æ¨é€æœºåˆ¶

3. **`packages/worker/src/platforms/douyin/douyin-data-manager.js`** âœ…
   - æŠ–éŸ³å¹³å°ç‰¹å®šå®ç°
   - æ•°æ®æ˜ å°„é€»è¾‘
   - è¾…åŠ©æ–¹æ³•

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

4. **`packages/worker/src/platforms/base/platform-base.js`**
   - æ·»åŠ  DataManager åˆå§‹åŒ–
   - æ·»åŠ  `this.dataManager` å±æ€§

5. **`packages/worker/src/platforms/douyin/platform.js`**
   - ä½¿ç”¨ DouyinDataManager
   - ä¿®æ”¹ initialize() æ–¹æ³•

6. **`packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js`**
   - ä½¿ç”¨ dataManager.batchUpsertConversations()
   - ä½¿ç”¨ dataManager.batchUpsertMessages()
   - åˆ é™¤æ‰‹åŠ¨æ¨é€é€»è¾‘

7. **`packages/worker/src/platforms/douyin/crawl-contents.js`**
   - ä½¿ç”¨ dataManager.batchUpsertContents()
   - åˆ é™¤æ‰‹åŠ¨æ˜ å°„é€»è¾‘

8. **`packages/worker/src/platforms/douyin/crawl-comments.js`**
   - ä½¿ç”¨ dataManager.batchUpsertComments()

### æ–°å¢æ¥å£

9. **`packages/worker/src/communication/data-pusher.js`** (å¾…åˆ›å»º)
   - è´Ÿè´£ä¸ Master é€šä¿¡
   - pushData(accountId, data) æ–¹æ³•

---

## ğŸ“ å…³é”®è®¾è®¡å†³ç­–

### 1. ä¸ºä»€ä¹ˆä½¿ç”¨ç±»è€Œä¸æ˜¯çº¯å‡½æ•°ï¼Ÿ

**å†³ç­–**: ä½¿ç”¨ OOPï¼ˆé¢å‘å¯¹è±¡ï¼‰è€Œä¸æ˜¯ FPï¼ˆå‡½æ•°å¼ï¼‰

**ç†ç”±**:
- æ•°æ®æœ‰çŠ¶æ€ï¼ˆNEW/SYNCED/UPDATEDï¼‰
- éœ€è¦ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼ˆåˆ›å»º/æ›´æ–°/æ¨é€ï¼‰
- æ˜“äºç»§æ‰¿å’Œæ‰©å±•ï¼ˆä¸åŒå¹³å°ï¼‰
- ç¬¦åˆç°æœ‰ä»£ç é£æ ¼

### 2. ä¸ºä»€ä¹ˆæ¯ä¸ªè´¦æˆ·ä¸€ä¸ª DataManager å®ä¾‹ï¼Ÿ

**å†³ç­–**: è´¦æˆ·çº§å®ä¾‹ï¼Œè€Œä¸æ˜¯å…¨å±€å•ä¾‹

**ç†ç”±**:
- éš”ç¦»æ•°æ®ï¼ˆè´¦æˆ·é—´äº’ä¸å½±å“ï¼‰
- ç‹¬ç«‹æ¨é€ï¼ˆä¸åŒè´¦æˆ·æ¨é€é¢‘ç‡å¯èƒ½ä¸åŒï¼‰
- å†…å­˜å¯æ§ï¼ˆè´¦æˆ·é”€æ¯æ—¶é‡Šæ”¾ï¼‰
- å¹¶å‘å®‰å…¨ï¼ˆæ— å…±äº«çŠ¶æ€ï¼‰

### 3. ä¸ºä»€ä¹ˆä½¿ç”¨ Map è€Œä¸æ˜¯æ•°ç»„ï¼Ÿ

**å†³ç­–**: `Map<id, Model>` è€Œä¸æ˜¯ `Model[]`

**ç†ç”±**:
- O(1) æŸ¥æ‰¾æ€§èƒ½
- è‡ªåŠ¨å»é‡ï¼ˆID å”¯ä¸€ï¼‰
- æ˜“äºæ›´æ–°ï¼ˆç›´æ¥ setï¼‰
- å†…å­˜é«˜æ•ˆï¼ˆå¤§æ•°æ®é‡ï¼‰

### 4. ä¸ºä»€ä¹ˆä¿ç•™ rawDataï¼Ÿ

**å†³ç­–**: æ¯ä¸ªæ¨¡å‹éƒ½ä¿ç•™å¹³å°åŸå§‹æ•°æ®

**ç†ç”±**:
- è°ƒè¯•æ–¹ä¾¿ï¼ˆå¯ä»¥æŸ¥çœ‹åŸå§‹æ•°æ®ï¼‰
- æ•°æ®å›æº¯ï¼ˆå¦‚æœæ˜ å°„æœ‰é—®é¢˜ï¼‰
- æ‰©å±•æ€§ï¼ˆæœªæ¥å¯èƒ½éœ€è¦åŸå§‹å­—æ®µï¼‰
- å¯é€‰ï¼ˆæ¨é€æ—¶å¯ä»¥å»é™¤ï¼‰

### 5. ä¸ºä»€ä¹ˆä½¿ç”¨è‡ªåŠ¨æ¨é€è€Œä¸æ˜¯æ‰‹åŠ¨æ¨é€ï¼Ÿ

**å†³ç­–**: é»˜è®¤è‡ªåŠ¨æ¨é€ï¼Œæ”¯æŒæ‰‹åŠ¨è§¦å‘

**ç†ç”±**:
- ç®€åŒ–çˆ¬è™«ä»£ç ï¼ˆæ— éœ€å…³å¿ƒæ¨é€ï¼‰
- æ‰¹é‡æ¨é€ï¼ˆæé«˜æ•ˆç‡ï¼‰
- å®¹é”™æ€§ï¼ˆå¤±è´¥å¯é‡è¯•ï¼‰
- çµæ´»æ€§ï¼ˆå¯æ‰‹åŠ¨è§¦å‘ï¼‰

---

## âœ… æ€»ç»“

### æ ¸å¿ƒä»·å€¼

1. **ç»Ÿä¸€æ€§**: æ‰€æœ‰æ•°æ®ä½¿ç”¨æ ‡å‡†æ ¼å¼
2. **ç®€æ´æ€§**: çˆ¬è™«ä»£ç å¤§å¹…ç®€åŒ–
3. **å¯ç»´æŠ¤æ€§**: é€»è¾‘é›†ä¸­ï¼Œæ˜“äºä¿®æ”¹
4. **å¯æ‰©å±•æ€§**: æ–°å¹³å°åªéœ€å®ç°æ˜ å°„
5. **å¯é æ€§**: è‡ªåŠ¨çŠ¶æ€ç®¡ç†å’Œæ¨é€

### ä½¿ç”¨æŒ‡å—

**å¯¹äºå¹³å°å¼€å‘è€…**:
1. ç»§æ‰¿ `AccountDataManager`
2. å®ç° 5 ä¸ªæ˜ å°„æ–¹æ³•
3. å®Œæˆï¼

**å¯¹äºçˆ¬è™«å¼€å‘è€…**:
1. è·å–åŸå§‹æ•°æ®ï¼ˆAPI/DOMï¼‰
2. è°ƒç”¨ `dataManager.batchUpsert*(data, source)`
3. å®Œæˆï¼

**å¯¹äº Master å¼€å‘è€…**:
1. æ¥æ”¶æ ‡å‡†æ ¼å¼æ•°æ®
2. ç›´æ¥å…¥åº“ï¼ˆæ— éœ€è½¬æ¢ï¼‰
3. å®Œæˆï¼

---

**è®¾è®¡äºº**: Claude Code
**è®¾è®¡æ—¶é—´**: 2025-10-28
**çŠ¶æ€**: âœ… æ¶æ„è®¾è®¡å®Œæˆï¼Œå¾…å®æ–½
**ç‰ˆæœ¬**: 2.0

