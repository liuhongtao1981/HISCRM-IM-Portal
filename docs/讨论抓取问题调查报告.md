# 讨论 (Discussions) 抓取问题调查报告

**日期**: 2025-10-24
**状态**: 🔍 调查中
**优先级**: 高

---

## 问题描述

讨论 (二级/三级评论回复) 数据未被抓取,数据库中 `discussions` 表为空。

- **预期**: 至少 1 条讨论
- **实际**: 0 条讨论
- **影响**: 无法抓取评论的回复数据

---

## 代码分析

### API 拦截器配置

```javascript
// packages/worker/src/platforms/douyin/crawl-comments.js:54-55
const commentApiPattern = /comment.*list/i;       // 一级评论 API
const discussionApiPattern = /comment.*reply/i;   // 二级/三级回复 API
```

**拦截逻辑**:
```javascript
// Line 85-98
if (includeDiscussions && discussionApiPattern.test(url) && json.reply_list && Array.isArray(json.reply_list)) {
  const commentId = extractCommentId(url);
  const cursor = extractCursor(url);

  apiResponses.discussions.push({
    timestamp: Date.now(),
    url: url,
    comment_id: commentId,
    cursor: cursor,
    data: json,
  });

  logger.debug(`✅ Intercepted discussion API: comment_id=${commentId}, replies=${json.reply_list.length}, has_more=${json.has_more}`);
}
```

### 数据解析逻辑

```javascript
// Line 435-483
if (includeDiscussions && apiResponses.discussions.length > 0) {
  logger.info(`Processing ${apiResponses.discussions.length} discussion API responses`);

  // 解析讨论数据...

  logger.info(`Total: ${allDiscussions.length} discussions for ${Object.keys(discussionsByCommentId).length} comments`);
} else {
  logger.info('Discussions crawl disabled or no discussions found');
}
```

---

## 问题诊断

### 情况 1: API 未被触发 ❓ (最可能)

**假设**: 评论管理页面不会自动加载评论的回复

**原因**:
- 抖音评论管理页面可能只显示一级评论
- 评论的回复需要用户**手动点击"查看回复"**按钮才会触发 API
- 当前爬虫只点击视频,不点击评论的"查看回复"按钮

**验证方法**:
1. 手动访问抖音创作者中心的评论管理页面
2. 找到有回复的评论
3. 观察是否有"查看回复" / "X 条回复"按钮
4. 点击按钮,观察 Network 面板是否有新的 API 请求

**解决方案** (如果验证通过):
```javascript
// 在 crawl-comments.js 中添加点击回复按钮的逻辑
async function expandCommentReplies(page) {
  // 查找所有"查看回复"按钮
  const replyButtons = await page.$$('button:has-text("查看回复"), button:has-text("条回复")');

  logger.info(`Found ${replyButtons.length} reply buttons`);

  // 点击每个按钮以展开回复
  for (const button of replyButtons) {
    try {
      await button.click();
      await page.waitForTimeout(500); // 等待 API 响应
    } catch (error) {
      logger.warn('Failed to click reply button:', error.message);
    }
  }
}

// 在点击视频后调用
for (let i = 0; i < Math.min(videosToClick.length, maxVideos || videosToClick.length); i++) {
  // ... 点击视频代码 ...

  // ✨ 新增: 展开评论回复
  await expandCommentReplies(page);

  // ... 继续处理 ...
}
```

### 情况 2: API URL 模式不匹配 ❓

**假设**: 抖音的讨论 API URL 不包含 "reply"

**验证方法**:
1. 添加日志记录所有 JSON 响应的 URL
2. 查看是否有其他模式的 API 包含 `reply_list` 字段

**临时诊断代码**:
```javascript
page.on('response', async (response) => {
  const url = response.url();
  const contentType = response.headers()['content-type'] || '';

  if (!contentType.includes('application/json')) {
    return;
  }

  try {
    const json = await response.json();

    // 🔍 诊断: 记录所有包含 reply_list 的 API
    if (json.reply_list && Array.isArray(json.reply_list)) {
      logger.info(`🔍 Found API with reply_list: ${url}`);
      logger.info(`   reply_list length: ${json.reply_list.length}`);
    }
  } catch (error) {
    // 忽略
  }
});
```

### 情况 3: 评论确实没有回复 ❓ (不太可能)

**假设**: 所有4条评论都没有回复

**验证方法**:
1. 手动登录抖音创作者中心
2. 查看这 4 条评论是否有回复
3. 如果都没有回复,则是正常现象

---

## 建议的调查步骤

### 步骤 1: 添加详细日志 ✅

在 `crawl-comments.js` 中添加以下日志:

```javascript
// 在API拦截器中
page.on('response', async (response) => {
  const url = response.url();
  const contentType = response.headers()['content-type'] || '';

  if (!contentType.includes('application/json')) {
    return;
  }

  try {
    const json = await response.json();

    // ✨ 新增: 诊断日志
    if (url.includes('comment')) {
      logger.info(`🔍 Comment-related API detected: ${url}`);
      logger.info(`   Has comment_info_list: ${!!json.comment_info_list}`);
      logger.info(`   Has reply_list: ${!!json.reply_list}`);
    }

    // 拦截一级评论 API
    if (commentApiPattern.test(url) && json.comment_info_list && Array.isArray(json.comment_info_list)) {
      // ... 现有代码 ...
      logger.info(`✅ Intercepted COMMENT API: ${apiResponses.comments.length} total responses`);
    }

    // 拦截二级/三级回复 API（讨论）
    if (includeDiscussions && discussionApiPattern.test(url) && json.reply_list && Array.isArray(json.reply_list)) {
      // ... 现有代码 ...
      logger.info(`✅ Intercepted DISCUSSION API: ${apiResponses.discussions.length} total responses`);
    }
  } catch (error) {
    // JSON解析失败,忽略
  }
});

// 在数据解析前
logger.info(`📊 API Responses Summary:`);
logger.info(`   Comments: ${apiResponses.comments.length} responses`);
logger.info(`   Discussions: ${apiResponses.discussions.length} responses`);
```

### 步骤 2: 手动验证抖音页面 ✅

1. 访问抖音创作者中心 → 互动管理 → 评论管理
2. 选择一个有评论的视频
3. 查看评论是否有回复
4. 如果有回复,观察:
   - 回复是否自动显示?
   - 是否需要点击"查看回复"按钮?
   - 点击后 Network 面板有什么 API 请求?

### 步骤 3: 修改爬虫逻辑 (如果需要)

根据步骤 2 的发现,可能需要:

1. **如果需要点击展开回复**:
   - 添加查找并点击"查看回复"按钮的逻辑
   - 等待 API 响应

2. **如果 API 模式不匹配**:
   - 更新 `discussionApiPattern` 正则表达式
   - 添加更多匹配模式

3. **如果评论确实没有回复**:
   - 确认这是正常情况
   - 更新文档说明

---

## 预期结果

### 如果修复成功

- `apiResponses.discussions` 数组有数据
- 日志显示: `Processing X discussion API responses`
- 日志显示: `Total: X discussions for Y comments`
- 数据库 `discussions` 表有记录
- Master 日志显示: `Worker bulk inserting X discussions`

### 如果确认无法修复

- 评论确实没有回复 (正常情况)
- 或者抖音页面结构变化,需要重新设计爬虫逻辑

---

## 推荐行动

### 立即行动

1. ✅ **添加详细日志** (步骤 1)
2. ✅ **手动验证抖音页面** (步骤 2)
3. ⏳ 根据发现修改爬虫逻辑 (步骤 3)

### 后续任务

- 更新测试报告
- 更新文档 `06-WORKER-爬虫调试指南.md`
- 添加单元测试

---

**报告生成时间**: 2025-10-24 10:17:00
**调查人员**: Claude Code Assistant
