# ä½œå“è¡¨å­—æ®µå¯¹æ¯”åˆ†ææŠ¥å‘Š

## æ•°æ®åº“è¡¨ç»“æ„ vs ä»£ç å­—æ®µæ˜ å°„

### douyin_videos è¡¨ç»“æ„
```sql
CREATE TABLE "douyin_videos" (
  id TEXT PRIMARY KEY,
  platform_videos_id TEXT NOT NULL,   -- å¹³å°è§†é¢‘ID (aweme_id)
  account_id TEXT NOT NULL,
  platform_user_id TEXT,

  -- ä½œå“ä¿¡æ¯
  title TEXT,
  cover TEXT,
  publish_time TEXT,

  -- ç»Ÿè®¡ä¿¡æ¯
  total_comment_count INTEGER DEFAULT 0,
  new_comment_count INTEGER DEFAULT 0,
  like_count INTEGER DEFAULT 0,
  share_count INTEGER DEFAULT 0,
  play_count INTEGER DEFAULT 0,

  -- çˆ¬å–çŠ¶æ€
  last_crawl_time INTEGER,
  crawl_status TEXT DEFAULT 'pending',
  crawl_error TEXT,

  -- çŠ¶æ€æ ‡è®°
  is_new BOOLEAN DEFAULT 1,
  push_count INTEGER DEFAULT 0,

  -- æ—¶é—´æˆ³
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);
```

### crawl-works.js æ ‡å‡†åŒ–æ•°æ®ï¼ˆç¬¬485-516è¡Œï¼‰

```javascript
function standardizeWorkData(work, account) {
  return {
    id: uuidv4(),
    account_id: account.id,
    platform: 'douyin',                          // âŒ æ•°æ®åº“æ²¡æœ‰ platform å­—æ®µï¼
    platform_work_id: work.platform_work_id,     // âŒ å­—æ®µåä¸åŒ¹é…ï¼šåº”ä¸º platform_videos_id
    platform_user_id: account.platform_user_id,

    work_type: work.work_type || 'video',        // âŒ æ•°æ®åº“æ²¡æœ‰ work_type å­—æ®µï¼
    title: work.title || '',
    description: work.description || '',         // âŒ æ•°æ®åº“æ²¡æœ‰ description å­—æ®µï¼
    cover: work.cover || '',
    url: work.url || '',                         // âŒ æ•°æ®åº“æ²¡æœ‰ url å­—æ®µï¼
    publish_time: work.publish_time || null,

    total_comment_count: work.total_comment_count || 0,
    new_comment_count: 0,
    like_count: work.like_count || 0,
    share_count: work.share_count || 0,
    view_count: work.view_count || 0,            // âŒ å­—æ®µåä¸åŒ¹é…ï¼šåº”ä¸º play_count

    last_crawl_time: Math.floor(Date.now() / 1000),
    crawl_status: 'success',
    crawl_error: null,

    is_new: true,
    push_count: 0,

    created_at: Math.floor(Date.now() / 1000),
    updated_at: Math.floor(Date.now() / 1000),
  };
}
```

## ğŸš¨ å‘ç°çš„é—®é¢˜

### 1. å­—æ®µåä¸åŒ¹é…

| ä»£ç ä¸­çš„å­—æ®µ | æ•°æ®åº“å­—æ®µ | çŠ¶æ€ |
|-------------|-----------|------|
| `platform_work_id` | `platform_videos_id` | âŒ **ä¸åŒ¹é…** |
| `view_count` | `play_count` | âŒ **ä¸åŒ¹é…** |

### 2. ä»£ç å¤šä½™å­—æ®µï¼ˆæ•°æ®åº“æ²¡æœ‰ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| `platform` | TEXT | æ•°æ®åº“æ²¡æœ‰æ­¤å­—æ®µ |
| `work_type` | TEXT | æ•°æ®åº“æ²¡æœ‰æ­¤å­—æ®µ |
| `description` | TEXT | æ•°æ®åº“æ²¡æœ‰æ­¤å­—æ®µ |
| `url` | TEXT | æ•°æ®åº“æ²¡æœ‰æ­¤å­—æ®µ |

### 3. æ•°æ®åº“ç¼ºå°‘å­—æ®µï¼ˆä»£ç ä¸­æœ‰ï¼‰

æ•°æ®åº“ Schema ç¼ºå°‘è¿™äº›å­—æ®µå¯èƒ½å¯¼è‡´ï¼š
- å…¥åº“æ—¶è¿™äº›å­—æ®µè¢«å¿½ç•¥
- æˆ–è€…å¯¼è‡´ SQL é”™è¯¯

## å½±å“åˆ†æ

### ä¸¥é‡ç¨‹åº¦ï¼šğŸ”´ é«˜

**é—®é¢˜ 1ï¼š`platform_work_id` vs `platform_videos_id`**
- **å½±å“**ï¼šæ•°æ®æ— æ³•å…¥åº“ï¼Œæˆ–è€…å…¥åº“åå­—æ®µä¸º NULL
- **ç—‡çŠ¶**ï¼šæŸ¥è¯¢ä½œå“æ—¶æ— æ³•é€šè¿‡ `platform_videos_id` æŸ¥æ‰¾
- **è¡¨ç°**ï¼šå¯èƒ½æŠ¥é”™"column platform_work_id does not exist"

**é—®é¢˜ 2ï¼š`view_count` vs `play_count`**
- **å½±å“**ï¼šæ’­æ”¾æ•°æ®ä¸¢å¤±
- **ç—‡çŠ¶**ï¼šæ•°æ®åº“ä¸­ `play_count` å­—æ®µå§‹ç»ˆä¸º 0

**é—®é¢˜ 3ï¼šå¤šä½™å­—æ®µ `platform`, `work_type`, `description`, `url`**
- **å½±å“**ï¼šå–å†³äº DAO å±‚çš„å®ç°
  - å¦‚æœ DAO ä½¿ç”¨ `INSERT INTO table VALUES (...)` â†’ å­—æ®µæ•°é‡ä¸åŒ¹é… â†’ **æŠ¥é”™**
  - å¦‚æœ DAO ä½¿ç”¨ `INSERT INTO table (col1, col2) VALUES (?, ?)` â†’ å¿½ç•¥å¤šä½™å­—æ®µ â†’ **æ•°æ®ä¸¢å¤±**

## éªŒè¯æ–¹æ³•

### 1. æ£€æŸ¥ DAO å±‚ä»£ç 

æŸ¥çœ‹ `packages/master/src/database/douyin-videos-dao.js`ï¼ˆæˆ–ç±»ä¼¼æ–‡ä»¶ï¼‰ï¼š

```javascript
// æ£€æŸ¥ INSERT è¯­å¥çš„å­—æ®µåˆ—è¡¨
insert(work) {
  return this.db.run(`
    INSERT INTO douyin_videos (
      id, account_id, platform_videos_id, platform_user_id,
      title, cover, publish_time,
      total_comment_count, new_comment_count, like_count, share_count, play_count,
      ...
    ) VALUES (?, ?, ?, ?, ...)
  `, [work.id, work.account_id, work.platform_videos_id, ...]);
}
```

### 2. æ£€æŸ¥æ•°æ®åº“å®é™…å†…å®¹

```sql
-- æŸ¥è¯¢æœ€è¿‘æŠ“å–çš„ä½œå“
SELECT
  platform_videos_id,
  title,
  play_count,
  total_comment_count,
  created_at
FROM douyin_videos
WHERE created_at > datetime('now', '-1 hour')
ORDER BY created_at DESC
LIMIT 10;
```

**é¢„æœŸé—®é¢˜**ï¼š
- `platform_videos_id` ä¸º NULL æˆ–ç©ºå­—ç¬¦ä¸²
- `play_count` å§‹ç»ˆä¸º 0

### 3. æŸ¥çœ‹ Worker æ—¥å¿—

```bash
grep -i "error" packages/worker/logs/crawl-works.log
grep -i "insert" packages/worker/logs/platform.log
```

å¯èƒ½çš„é”™è¯¯ä¿¡æ¯ï¼š
```
Error: no such column: platform_work_id
Error: column count mismatch
```

## ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šä¿®æ”¹ä»£ç ï¼ˆæ¨èï¼‰âœ…

ä¿®æ”¹ [crawl-works.js:485-516](../packages/worker/src/platforms/douyin/crawl-works.js#L485-L516)ï¼š

```javascript
function standardizeWorkData(work, account) {
  return {
    id: uuidv4(),
    account_id: account.id,
    platform_videos_id: work.platform_work_id,  // âœ… ä¿®æ­£å­—æ®µå
    platform_user_id: account.platform_user_id,

    // ä½œå“ä¿¡æ¯
    title: work.title || '',
    cover: work.cover || '',
    publish_time: work.publish_time || null,

    // ç»Ÿè®¡ä¿¡æ¯
    total_comment_count: work.total_comment_count || 0,
    new_comment_count: 0,
    like_count: work.like_count || 0,
    share_count: work.share_count || 0,
    play_count: work.view_count || 0,           // âœ… ä¿®æ­£å­—æ®µå

    // çˆ¬å–çŠ¶æ€
    last_crawl_time: Math.floor(Date.now() / 1000),
    crawl_status: 'success',
    crawl_error: null,

    // çŠ¶æ€æ ‡è®°
    is_new: true,
    push_count: 0,

    // æ—¶é—´æˆ³
    created_at: Math.floor(Date.now() / 1000),
    updated_at: Math.floor(Date.now() / 1000),
  };
}
```

**åˆ é™¤çš„å­—æ®µ**ï¼š
- âŒ `platform` - æ•°æ®åº“æ²¡æœ‰
- âŒ `work_type` - æ•°æ®åº“æ²¡æœ‰
- âŒ `description` - æ•°æ®åº“æ²¡æœ‰
- âŒ `url` - æ•°æ®åº“æ²¡æœ‰

### æ–¹æ¡ˆ 2ï¼šä¿®æ”¹æ•°æ®åº“ Schemaï¼ˆä¸æ¨èï¼‰

ç»™ `douyin_videos` è¡¨æ·»åŠ å­—æ®µï¼š

```sql
ALTER TABLE douyin_videos ADD COLUMN platform TEXT;
ALTER TABLE douyin_videos ADD COLUMN work_type TEXT;
ALTER TABLE douyin_videos ADD COLUMN description TEXT;
ALTER TABLE douyin_videos ADD COLUMN url TEXT;
ALTER TABLE douyin_videos RENAME COLUMN platform_videos_id TO platform_work_id;
ALTER TABLE douyin_videos RENAME COLUMN play_count TO view_count;
```

**ä¸æ¨èåŸå› **ï¼š
- æ”¹åŠ¨æ•°æ®åº“ Schema å½±å“èŒƒå›´å¤§
- å¯èƒ½éœ€è¦æ›´æ–°æ‰€æœ‰æŸ¥è¯¢ä»£ç 
- æ•°æ®è¿ç§»å¤æ‚

## ä¸‹ä¸€æ­¥æ“ä½œ

1. âœ… **ç«‹å³æ£€æŸ¥ DAO å±‚ä»£ç **
   - æŸ¥çœ‹ `packages/master/src/database/` ä¸‹çš„ DAO æ–‡ä»¶
   - ç¡®è®¤ INSERT è¯­å¥ä½¿ç”¨çš„å­—æ®µ

2. âœ… **ä¿®å¤ crawl-works.js çš„å­—æ®µæ˜ å°„**
   - åˆ é™¤å¤šä½™å­—æ®µ
   - ä¿®æ­£å­—æ®µå

3. âœ… **æµ‹è¯•éªŒè¯**
   - è¿è¡Œä½œå“çˆ¬è™«
   - æ£€æŸ¥æ•°æ®åº“æ˜¯å¦æ­£ç¡®å…¥åº“
   - éªŒè¯ `platform_videos_id` å’Œ `play_count` æ˜¯å¦æœ‰å€¼

4. âœ… **æ›´æ–°æ–‡æ¡£**
   - è®°å½•ä¿®å¤è¿‡ç¨‹
   - æ›´æ–°å­—æ®µæ˜ å°„æ–‡æ¡£

---

**åˆ†ææ—¶é—´**ï¼š2025-10-27
**åˆ†æäººå‘˜**ï¼šClaude
**ä¸¥é‡ç¨‹åº¦**ï¼šğŸ”´ é«˜ï¼ˆå¯èƒ½å¯¼è‡´æ•°æ®å…¥åº“å¤±è´¥æˆ–æ•°æ®ä¸¢å¤±ï¼‰
