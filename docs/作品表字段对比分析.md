# 作品表字段对比分析报告

## 数据库表结构 vs 代码字段映射

### douyin_videos 表结构
```sql
CREATE TABLE "douyin_videos" (
  id TEXT PRIMARY KEY,
  platform_videos_id TEXT NOT NULL,   -- 平台视频ID (aweme_id)
  account_id TEXT NOT NULL,
  platform_user_id TEXT,

  -- 作品信息
  title TEXT,
  cover TEXT,
  publish_time TEXT,

  -- 统计信息
  total_comment_count INTEGER DEFAULT 0,
  new_comment_count INTEGER DEFAULT 0,
  like_count INTEGER DEFAULT 0,
  share_count INTEGER DEFAULT 0,
  play_count INTEGER DEFAULT 0,

  -- 爬取状态
  last_crawl_time INTEGER,
  crawl_status TEXT DEFAULT 'pending',
  crawl_error TEXT,

  -- 状态标记
  is_new BOOLEAN DEFAULT 1,
  push_count INTEGER DEFAULT 0,

  -- 时间戳
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);
```

### crawl-works.js 标准化数据（第485-516行）

```javascript
function standardizeWorkData(work, account) {
  return {
    id: uuidv4(),
    account_id: account.id,
    platform: 'douyin',                          // ❌ 数据库没有 platform 字段！
    platform_work_id: work.platform_work_id,     // ❌ 字段名不匹配：应为 platform_videos_id
    platform_user_id: account.platform_user_id,

    work_type: work.work_type || 'video',        // ❌ 数据库没有 work_type 字段！
    title: work.title || '',
    description: work.description || '',         // ❌ 数据库没有 description 字段！
    cover: work.cover || '',
    url: work.url || '',                         // ❌ 数据库没有 url 字段！
    publish_time: work.publish_time || null,

    total_comment_count: work.total_comment_count || 0,
    new_comment_count: 0,
    like_count: work.like_count || 0,
    share_count: work.share_count || 0,
    view_count: work.view_count || 0,            // ❌ 字段名不匹配：应为 play_count

    last_crawl_time: Math.floor(Date.now() / 1000),
    crawl_status: 'success',
    crawl_error: null,

    is_new: true,
    push_count: 0,

    created_at: Math.floor(Date.now() / 1000),
    updated_at: Math.floor(Date.now() / 1000),
  };
}
```

## 🚨 发现的问题

### 1. 字段名不匹配

| 代码中的字段 | 数据库字段 | 状态 |
|-------------|-----------|------|
| `platform_work_id` | `platform_videos_id` | ❌ **不匹配** |
| `view_count` | `play_count` | ❌ **不匹配** |

### 2. 代码多余字段（数据库没有）

| 字段 | 类型 | 说明 |
|-----|------|------|
| `platform` | TEXT | 数据库没有此字段 |
| `work_type` | TEXT | 数据库没有此字段 |
| `description` | TEXT | 数据库没有此字段 |
| `url` | TEXT | 数据库没有此字段 |

### 3. 数据库缺少字段（代码中有）

数据库 Schema 缺少这些字段可能导致：
- 入库时这些字段被忽略
- 或者导致 SQL 错误

## 影响分析

### 严重程度：🔴 高

**问题 1：`platform_work_id` vs `platform_videos_id`**
- **影响**：数据无法入库，或者入库后字段为 NULL
- **症状**：查询作品时无法通过 `platform_videos_id` 查找
- **表现**：可能报错"column platform_work_id does not exist"

**问题 2：`view_count` vs `play_count`**
- **影响**：播放数据丢失
- **症状**：数据库中 `play_count` 字段始终为 0

**问题 3：多余字段 `platform`, `work_type`, `description`, `url`**
- **影响**：取决于 DAO 层的实现
  - 如果 DAO 使用 `INSERT INTO table VALUES (...)` → 字段数量不匹配 → **报错**
  - 如果 DAO 使用 `INSERT INTO table (col1, col2) VALUES (?, ?)` → 忽略多余字段 → **数据丢失**

## 验证方法

### 1. 检查 DAO 层代码

查看 `packages/master/src/database/douyin-videos-dao.js`（或类似文件）：

```javascript
// 检查 INSERT 语句的字段列表
insert(work) {
  return this.db.run(`
    INSERT INTO douyin_videos (
      id, account_id, platform_videos_id, platform_user_id,
      title, cover, publish_time,
      total_comment_count, new_comment_count, like_count, share_count, play_count,
      ...
    ) VALUES (?, ?, ?, ?, ...)
  `, [work.id, work.account_id, work.platform_videos_id, ...]);
}
```

### 2. 检查数据库实际内容

```sql
-- 查询最近抓取的作品
SELECT
  platform_videos_id,
  title,
  play_count,
  total_comment_count,
  created_at
FROM douyin_videos
WHERE created_at > datetime('now', '-1 hour')
ORDER BY created_at DESC
LIMIT 10;
```

**预期问题**：
- `platform_videos_id` 为 NULL 或空字符串
- `play_count` 始终为 0

### 3. 查看 Worker 日志

```bash
grep -i "error" packages/worker/logs/crawl-works.log
grep -i "insert" packages/worker/logs/platform.log
```

可能的错误信息：
```
Error: no such column: platform_work_id
Error: column count mismatch
```

## 修复方案

### 方案 1：修改代码（推荐）✅

修改 [crawl-works.js:485-516](../packages/worker/src/platforms/douyin/crawl-works.js#L485-L516)：

```javascript
function standardizeWorkData(work, account) {
  return {
    id: uuidv4(),
    account_id: account.id,
    platform_videos_id: work.platform_work_id,  // ✅ 修正字段名
    platform_user_id: account.platform_user_id,

    // 作品信息
    title: work.title || '',
    cover: work.cover || '',
    publish_time: work.publish_time || null,

    // 统计信息
    total_comment_count: work.total_comment_count || 0,
    new_comment_count: 0,
    like_count: work.like_count || 0,
    share_count: work.share_count || 0,
    play_count: work.view_count || 0,           // ✅ 修正字段名

    // 爬取状态
    last_crawl_time: Math.floor(Date.now() / 1000),
    crawl_status: 'success',
    crawl_error: null,

    // 状态标记
    is_new: true,
    push_count: 0,

    // 时间戳
    created_at: Math.floor(Date.now() / 1000),
    updated_at: Math.floor(Date.now() / 1000),
  };
}
```

**删除的字段**：
- ❌ `platform` - 数据库没有
- ❌ `work_type` - 数据库没有
- ❌ `description` - 数据库没有
- ❌ `url` - 数据库没有

### 方案 2：修改数据库 Schema（不推荐）

给 `douyin_videos` 表添加字段：

```sql
ALTER TABLE douyin_videos ADD COLUMN platform TEXT;
ALTER TABLE douyin_videos ADD COLUMN work_type TEXT;
ALTER TABLE douyin_videos ADD COLUMN description TEXT;
ALTER TABLE douyin_videos ADD COLUMN url TEXT;
ALTER TABLE douyin_videos RENAME COLUMN platform_videos_id TO platform_work_id;
ALTER TABLE douyin_videos RENAME COLUMN play_count TO view_count;
```

**不推荐原因**：
- 改动数据库 Schema 影响范围大
- 可能需要更新所有查询代码
- 数据迁移复杂

## 下一步操作

1. ✅ **立即检查 DAO 层代码**
   - 查看 `packages/master/src/database/` 下的 DAO 文件
   - 确认 INSERT 语句使用的字段

2. ✅ **修复 crawl-works.js 的字段映射**
   - 删除多余字段
   - 修正字段名

3. ✅ **测试验证**
   - 运行作品爬虫
   - 检查数据库是否正确入库
   - 验证 `platform_videos_id` 和 `play_count` 是否有值

4. ✅ **更新文档**
   - 记录修复过程
   - 更新字段映射文档

---

**分析时间**：2025-10-27
**分析人员**：Claude
**严重程度**：🔴 高（可能导致数据入库失败或数据丢失）
