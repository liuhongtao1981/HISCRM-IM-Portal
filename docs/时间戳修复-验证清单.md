# æ—¶é—´æˆ³ä¿®å¤ - éªŒè¯æ¸…å•

## ä¿®å¤å®Œæˆæ—¶é—´: 2025-11-05 10:00

## å·²å®Œæˆçš„ä¿®å¤

### 1. ç§ä¿¡æ—¶é—´æˆ³ä¿®å¤

**é—®é¢˜**: Worker å‘é€ ISO å­—ç¬¦ä¸²ï¼ŒMaster è§£æä¸º 1970å¹´

**ä¿®å¤æ–‡ä»¶**:
- âœ… `packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js` (Line 1405-1406)
  - ä½¿ç”¨ `normalizeTimestamp()` ç»Ÿä¸€è½¬æ¢ä¸ºæ¯«ç§’æ—¶é—´æˆ³

- âœ… `packages/master/src/communication/im-websocket-server.js` (3å¤„)
  - Line 304-309: `getTopicsFromDataStore()` ä¸­æ·»åŠ  ISO 8601 æ£€æµ‹
  - Line 504-510: `handleAdminSync()` ä¸­æ·»åŠ  ISO 8601 æ£€æµ‹
  - Line 667-672: `findLastMessage()` ä¸­æ·»åŠ  ISO 8601 æ£€æµ‹

### 2. ä½œå“å‘å¸ƒæ—¶é—´ä¿®å¤

**é—®é¢˜**: API è¿”å›ä¸­æ–‡å­—ç¬¦ä¸² `"å‘å¸ƒäº2025å¹´10æœˆ27æ—¥ 10:42"`ï¼Œæœªè§£æ

**ä¿®å¤æ–‡ä»¶**:
- âœ… `packages/worker/src/platforms/douyin/crawl-contents.js` (Line 531-547)
  - è§£æä¸­æ–‡æ—¥æœŸå­—ç¬¦ä¸²ä¸ºç§’çº§æ—¶é—´æˆ³

- âœ… `packages/worker/src/platforms/douyin/douyin-data-manager.js`
  - Line 218, 229: ä½¿ç”¨ `parsePublishTime()` æ–¹æ³•
  - Line 466-505: æ–°å¢ `parsePublishTime()` æ–¹æ³•å®ç°

## é‡å¯æœåŠ¡

### æ­¥éª¤1: åœæ­¢ç°æœ‰æœåŠ¡

å¦‚æœæœ‰æ­£åœ¨è¿è¡Œçš„ Master å’Œ Workerï¼Œå…ˆåœæ­¢å®ƒä»¬ï¼ˆCtrl+Cï¼‰ã€‚

### æ­¥éª¤2: é‡å¯ Master

```bash
cd packages/master
npm start
```

**é¢„æœŸè¾“å‡º**:
```
âœ… Master server started on port 3000
âœ… Socket.IO server listening
âœ… Database initialized
```

### æ­¥éª¤3: é‡å¯ Worker

```bash
cd packages/worker
npm start
```

**é¢„æœŸè¾“å‡º**:
```
âœ… Worker started: worker-1
âœ… Connected to Master
âœ… Browser initialized
âœ… Registered platforms: douyin
```

## éªŒè¯æ­¥éª¤

### éªŒè¯1: ç­‰å¾…æ•°æ®æŠ“å–

ç­‰å¾… Worker æ‰§è¡Œæ–°ä¸€è½®æŠ“å–ï¼ˆè¯„è®º + ç§ä¿¡ + ä½œå“ï¼‰ï¼Œå¤§çº¦éœ€è¦ 2-5 åˆ†é’Ÿã€‚

**æŸ¥çœ‹ Worker æ—¥å¿—**:
```bash
tail -f packages/worker/logs/douyin-platform.log
```

**é¢„æœŸæ—¥å¿—**:
```
[INFO] ğŸ¯ Starting crawl cycle for account: acc-xxx
[INFO] ğŸ“ Crawling comments...
[INFO] âœ… Comments crawled: 10
[INFO] ğŸ’¬ Crawling direct messages...
[INFO] âœ… Direct messages crawled: 20
[INFO] ğŸ“º Crawling contents...
[INFO] âœ… Contents crawled: 5
```

### éªŒè¯2: æ£€æŸ¥ç§ä¿¡æ—¶é—´æˆ³æ ¼å¼

```bash
cd packages/master && node -e "
const db = require('better-sqlite3')('./data/master.db');
const msgs = db.prepare('SELECT data FROM cache_messages ORDER BY persist_at DESC LIMIT 5').all();

console.log('=== ç§ä¿¡æ—¶é—´æˆ³éªŒè¯ ===\n');
msgs.forEach((row, i) => {
  const data = JSON.parse(row.data);
  console.log(\`æ¶ˆæ¯\${i+1}:\`);
  console.log(\`  createdAt: \${data.createdAt}\`);
  console.log(\`  ç±»å‹: \${typeof data.createdAt}\`);

  if (typeof data.createdAt === 'number') {
    const date = new Date(data.createdAt);
    console.log(\`  âœ… è½¬æ¢: \${date.toLocaleString('zh-CN')}\`);

    // æ£€æŸ¥å¹´ä»½
    if (date.getFullYear() === 2025 || date.getFullYear() === 2024) {
      console.log(\`  âœ… å¹´ä»½æ­£ç¡®: \${date.getFullYear()}\`);
    } else {
      console.log(\`  âŒ å¹´ä»½é”™è¯¯: \${date.getFullYear()} (é¢„æœŸ2024æˆ–2025)\`);
    }
  } else {
    console.log(\`  âŒ ç±»å‹é”™è¯¯: åº”è¯¥æ˜¯ numberï¼Œå®é™…æ˜¯ \${typeof data.createdAt}\`);
  }
  console.log();
});

db.close();
"
```

**é¢„æœŸè¾“å‡º**:
```
=== ç§ä¿¡æ—¶é—´æˆ³éªŒè¯ ===

æ¶ˆæ¯1:
  createdAt: 1762304707004
  ç±»å‹: number
  âœ… è½¬æ¢: 2025/11/4 15:58:27
  âœ… å¹´ä»½æ­£ç¡®: 2025

æ¶ˆæ¯2:
  createdAt: 1762304030221
  ç±»å‹: number
  âœ… è½¬æ¢: 2025/11/4 00:50:30
  âœ… å¹´ä»½æ­£ç¡®: 2025
```

**é”™è¯¯è¾“å‡º** (ä¿®å¤å‰):
```
æ¶ˆæ¯1:
  createdAt: 2025-11-04T15:58:27.004Z
  ç±»å‹: string
  âŒ ç±»å‹é”™è¯¯: åº”è¯¥æ˜¯ numberï¼Œå®é™…æ˜¯ string
```

### éªŒè¯3: æ£€æŸ¥ä½œå“å‘å¸ƒæ—¶é—´æ ¼å¼

```bash
cd packages/master && node -e "
const db = require('better-sqlite3')('./data/master.db');
const contents = db.prepare('SELECT data FROM cache_contents ORDER BY id DESC LIMIT 5').all();

console.log('=== ä½œå“å‘å¸ƒæ—¶é—´éªŒè¯ ===\n');
contents.forEach((row, i) => {
  const data = JSON.parse(row.data);
  console.log(\`ä½œå“\${i+1}: \${data.title?.substring(0, 30)}\`);
  console.log(\`  publishTime: \${data.publishTime}\`);
  console.log(\`  ç±»å‹: \${typeof data.publishTime}\`);

  if (typeof data.publishTime === 'number') {
    // publishTime æ˜¯ç§’çº§æ—¶é—´æˆ³
    const date = new Date(data.publishTime * 1000);
    console.log(\`  âœ… è½¬æ¢: \${date.toLocaleString('zh-CN')}\`);

    if (date.getFullYear() === 2025 || date.getFullYear() === 2024) {
      console.log(\`  âœ… å¹´ä»½æ­£ç¡®: \${date.getFullYear()}\`);
    } else {
      console.log(\`  âŒ å¹´ä»½é”™è¯¯: \${date.getFullYear()}\`);
    }
  } else {
    console.log(\`  âŒ ç±»å‹é”™è¯¯: åº”è¯¥æ˜¯ numberï¼Œå®é™…æ˜¯ \${typeof data.publishTime}\`);
  }
  console.log();
});

db.close();
"
```

**é¢„æœŸè¾“å‡º**:
```
=== ä½œå“å‘å¸ƒæ—¶é—´éªŒè¯ ===

ä½œå“1: å“ˆå°”æ»¨ä¸´ç»ˆå…³æ€€ å®ˆæŠ¤ç”Ÿå‘½æœ€åçš„æœ€ä¸¥ä¸å®‰å®
  publishTime: 1730012520
  ç±»å‹: number
  âœ… è½¬æ¢: 2025/10/27 10:42:00
  âœ… å¹´ä»½æ­£ç¡®: 2025

ä½œå“2: ç”Ÿå‘½ç»ˆç« æ¸©æš–é™ªä¼´ å“ˆå°”æ»¨å¾·è€ä¸´ç»ˆå…³æ€€åŒ»é™¢
  publishTime: 1730708160
  ç±»å‹: number
  âœ… è½¬æ¢: 2025/11/4 14:16:00
  âœ… å¹´ä»½æ­£ç¡®: 2025
```

**é”™è¯¯è¾“å‡º** (ä¿®å¤å‰):
```
ä½œå“1: å“ˆå°”æ»¨ä¸´ç»ˆå…³æ€€...
  publishTime: å‘å¸ƒäº2025å¹´10æœˆ27æ—¥ 10:42
  ç±»å‹: string
  âŒ ç±»å‹é”™è¯¯: åº”è¯¥æ˜¯ numberï¼Œå®é™…æ˜¯ string
```

### éªŒè¯4: æ£€æŸ¥ IM å®¢æˆ·ç«¯æ˜¾ç¤º

æ‰“å¼€ IM å®¢æˆ·ç«¯ï¼ˆ`http://localhost:3001` æˆ– Electron åº”ç”¨ï¼‰ï¼Œæ£€æŸ¥ï¼š

#### 4.1 è´¦å·åˆ—è¡¨æ—¶é—´

**ä¿®å¤å‰** âŒ:
```
è´¦å·1: 01/01 08:33
è´¦å·2: 01/01 08:33  (æ‰€æœ‰æ—¶é—´éƒ½ç›¸åŒï¼Œéƒ½æ˜¯1970å¹´)
è´¦å·3: 01/01 08:33
```

**ä¿®å¤å** âœ…:
```
è´¦å·1: 11/04 15:58
è´¦å·2: 11/04 00:50  (æ¯ä¸ªè´¦å·æ—¶é—´éƒ½ä¸åŒ)
è´¦å·3: 11/03 05:30
```

#### 4.2 ç§ä¿¡ä¼šè¯åˆ—è¡¨æ—¶é—´

ç‚¹å‡»è´¦å·è¿›å…¥ä¼šè¯åˆ—è¡¨ï¼š

**ä¿®å¤å‰** âŒ:
```
ä¼šè¯1: 01/01 08:33
ä¼šè¯2: 01/01 08:33  (æ‰€æœ‰ä¼šè¯æ—¶é—´éƒ½ç›¸åŒ)
```

**ä¿®å¤å** âœ…:
```
ä¼šè¯1: 11/04 15:58
ä¼šè¯2: 11/04 00:50  (æ¯ä¸ªä¼šè¯æ—¶é—´éƒ½ä¸åŒ)
ä¼šè¯3: 11/03 05:30
```

#### 4.3 ä½œå“åˆ—è¡¨æ—¶é—´

åˆ‡æ¢åˆ°ä½œå“åˆ—è¡¨ï¼ˆå¦‚æœæœ‰ï¼‰ï¼š

**ä¿®å¤å‰** âŒ:
```
ä½œå“1: å‘å¸ƒäº2025å¹´10æœˆ27æ—¥ 10:42  (æ˜¾ç¤ºä¸­æ–‡å­—ç¬¦ä¸²)
```

**ä¿®å¤å** âœ…:
```
ä½œå“1: 10/27 10:42  (æ ¼å¼åŒ–åçš„æ—¶é—´)
```

### éªŒè¯5: æµè§ˆå™¨æ§åˆ¶å°æ£€æŸ¥

æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰ï¼ŒæŸ¥çœ‹ WebSocket æ¥æ”¶çš„æ•°æ®ï¼š

```javascript
// åœ¨ Console ä¸­è¾“å…¥
localStorage.setItem('debug', 'true');
// åˆ·æ–°é¡µé¢ï¼Œç„¶åæŸ¥çœ‹ Network â†’ WS â†’ Messages
```

**é¢„æœŸæ•°æ®**:
```json
{
  "type": "channels",
  "channels": [
    {
      "id": "acc-xxx",
      "lastMessageTime": 1762304707004,  // âœ… æ•°å­—
      "name": "æŠ–éŸ³è´¦å·"
    }
  ]
}

{
  "type": "topics",
  "topics": [
    {
      "id": "topic-xxx",
      "lastMessageTime": 1762304707004,  // âœ… æ•°å­—
      "createdTime": 1730708160000       // âœ… æ•°å­—
    }
  ]
}
```

**é”™è¯¯æ•°æ®** (ä¿®å¤å‰):
```json
{
  "lastMessageTime": "2025-11-04T15:58:27.004Z"  // âŒ å­—ç¬¦ä¸²
}
```

## å¸¸è§é—®é¢˜

### Q1: æ—¶é—´è¿˜æ˜¯æ˜¾ç¤ºä¸º "01/01 08:33"

**å¯èƒ½åŸå› **:
1. Master æˆ– Worker æœªé‡å¯
2. ä½¿ç”¨çš„æ˜¯æ—§æ•°æ®ï¼ˆDataStore ç¼“å­˜ï¼‰

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. å®Œå…¨åœæ­¢ Master å’Œ Worker
# 2. é‡å¯ Master (æ¸…ç©º DataStore ç¼“å­˜)
cd packages/master && npm start

# 3. é‡å¯ Worker
cd packages/worker && npm start

# 4. ç­‰å¾…æ–°ä¸€è½®æ•°æ®æŠ“å–
```

### Q2: ä½œå“æ—¶é—´è¿˜æ˜¯ä¸­æ–‡å­—ç¬¦ä¸²

**å¯èƒ½åŸå› **:
- ä½¿ç”¨çš„æ˜¯æ—§æ•°æ®

**è§£å†³æ–¹æ¡ˆ**:
```bash
# ç­‰å¾… Worker æ‰§è¡Œæ–°ä¸€è½®ä½œå“æŠ“å–
# æˆ–æ‰‹åŠ¨æ¸…ç©ºæ—§æ•°æ®:
cd packages/master && node -e "
const db = require('better-sqlite3')('./data/master.db');
db.prepare('DELETE FROM cache_contents').run();
console.log('å·²æ¸…ç©ºä½œå“æ•°æ®ï¼Œç­‰å¾…é‡æ–°æŠ“å–');
db.close();
"
```

### Q3: éƒ¨åˆ†æ—¶é—´æ­£ç¡®ï¼Œéƒ¨åˆ†é”™è¯¯

**å¯èƒ½åŸå› **:
- æ–°æ—§æ•°æ®æ··åˆ

**è§£å†³æ–¹æ¡ˆ**:
- ç­‰å¾…æ‰€æœ‰è´¦å·éƒ½é‡æ–°æŠ“å–ä¸€è½®æ•°æ®
- æ£€æŸ¥å“ªäº›æ˜¯æ–°æ•°æ®ï¼ˆ`persist_at` å­—æ®µåœ¨é‡å¯åçš„æ—¶é—´ï¼‰

## éªŒè¯é€šè¿‡æ ‡å‡†

æ‰€æœ‰ä»¥ä¸‹æ¡ä»¶éƒ½æ»¡è¶³æ‰ç®—éªŒè¯é€šè¿‡ï¼š

- [ ] Master æœåŠ¡æ­£å¸¸å¯åŠ¨
- [ ] Worker æœåŠ¡æ­£å¸¸å¯åŠ¨å¹¶è¿æ¥åˆ° Master
- [ ] Worker å®Œæˆä¸€è½®å®Œæ•´æŠ“å–ï¼ˆè¯„è®º+ç§ä¿¡+ä½œå“ï¼‰
- [ ] `cache_messages.createdAt` ä¸ºæ•°å­—ç±»å‹
- [ ] `cache_contents.publishTime` ä¸ºæ•°å­—ç±»å‹
- [ ] IM å®¢æˆ·ç«¯è´¦å·åˆ—è¡¨æ—¶é—´å„ä¸ç›¸åŒ
- [ ] IM å®¢æˆ·ç«¯ä¼šè¯åˆ—è¡¨æ—¶é—´å„ä¸ç›¸åŒ
- [ ] æ‰€æœ‰æ—¶é—´æ˜¾ç¤ºä¸º 2024æˆ–2025 å¹´ï¼ˆé1970å¹´ï¼‰
- [ ] æµè§ˆå™¨æ§åˆ¶å° WebSocket æ•°æ®ä¸­æ‰€æœ‰æ—¶é—´æˆ³ä¸ºæ•°å­—

## å›æ»šæ–¹æ¡ˆ

å¦‚æœä¿®å¤åå‡ºç°é—®é¢˜ï¼Œå¯ä»¥å›æ»šä»£ç ï¼š

```bash
# æŸ¥çœ‹æœ€è¿‘çš„æäº¤
git log --oneline -5

# å›æ»šåˆ°ä¿®å¤å‰çš„ç‰ˆæœ¬
git reset --hard <commit-hash>

# é‡å¯æœåŠ¡
cd packages/master && npm start
cd packages/worker && npm start
```

## ä¿®å¤æ–‡ä»¶å¤‡ä»½

ä¿®å¤æ¶‰åŠçš„æ‰€æœ‰æ–‡ä»¶å·²ç»ä¿å­˜åœ¨ Git ä¸­ã€‚å¦‚éœ€æŸ¥çœ‹ä¿®æ”¹å†…å®¹ï¼š

```bash
git diff HEAD~1 packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js
git diff HEAD~1 packages/master/src/communication/im-websocket-server.js
git diff HEAD~1 packages/worker/src/platforms/douyin/crawl-contents.js
git diff HEAD~1 packages/worker/src/platforms/douyin/douyin-data-manager.js
```

## ç›¸å…³æ–‡æ¡£

- [æ—¶é—´æˆ³æ ¼å¼é—®é¢˜-å…¨é¢ä¿®å¤æ€»ç»“](./æ—¶é—´æˆ³æ ¼å¼é—®é¢˜-å…¨é¢ä¿®å¤æ€»ç»“.md) - å®Œæ•´ä¿®å¤æ–¹æ¡ˆ
- [æ—¶é—´æˆ³æ ¼å¼ç»Ÿä¸€é—®é¢˜-å®Œæ•´ä¿®å¤æ–¹æ¡ˆ](./æ—¶é—´æˆ³æ ¼å¼ç»Ÿä¸€é—®é¢˜-å®Œæ•´ä¿®å¤æ–¹æ¡ˆ.md) - ç§ä¿¡æ—¶é—´æˆ³ä¿®å¤
- [æ—¶é—´æˆ³æ˜¾ç¤ºé—®é¢˜-æœ€ç»ˆä¿®å¤æŠ¥å‘Š](./æ—¶é—´æˆ³æ˜¾ç¤ºé—®é¢˜-æœ€ç»ˆä¿®å¤æŠ¥å‘Š.md) - Master ç«¯ä¿®å¤è¯¦æƒ…
