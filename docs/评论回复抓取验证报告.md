# 评论回复抓取验证报告

**日期**: 2025-10-24
**测试目的**: 验证讨论（评论回复）抓取功能是否正常工作
**测试账号**: acc-40dab768-fee1-4718-b64b-eb3a7c23beac (抖音)

---

## 📊 测试数据统计

### 数据库当前状态

```
总评论数: 4
有回复的评论: 0
回复总数（从 reply_count 字段）: 0
实际讨论记录数: 0
```

### 详细评论信息

| 作者 | 评论内容 | reply_count | 时间 |
|------|---------|-------------|------|
| MR_zhou92 | 我和拍视频你只能选一个... | 0 | 2019/5/9 11:15 |
| 辽宁招才人力信息官 | [憨笑][来看我]@唐大美... | 0 | 2022/11/24 17:35 |
| 沧渊 | 我还想说呢，咱俩评论的嗨嗨的... | 0 | 2023/12/19 08:51 |
| 夕阳 | [赞][赞][赞][赞][鼓掌] | 0 | 2023/12/22 07:22 |

---

## ✅ 验证结果

### 结论

**所有评论的 `reply_count` 确实都是 0**，说明：

1. ✅ 这些评论确实没有回复（讨论）
2. ✅ 爬虫代码逻辑正确
3. ✅ discussions 表为空是正常的
4. ✅ 评论管理页面不显示"查看回复"按钮也是正常的

### 关键发现

1. **页面行为**：
   - 评论管理页面上的评论都没有"查看回复"或"X条回复"按钮
   - 只有点赞、回复、删除、举报按钮
   - 符合 `reply_count = 0` 的数据

2. **API 字段映射**：
   - 当前代码使用: `c.reply_count` (第394行)
   - 抖音 API 可能字段: `reply_comment_total` 或 `reply_count`
   - **需要验证**: 实际的 API 响应字段名

3. **测试限制**：
   - 当前测试账号只有1个视频作品
   - 该视频的4条评论都没有回复
   - 无法测试真实的讨论抓取场景

---

## 🔍 字段映射验证（待确认）

### crawl-comments.js 中的字段映射

```javascript
// 第385-396行: 解析评论数据
comments.push({
  platform_comment_id: c.comment_id,
  content: c.text,
  author_name: c.user_info?.screen_name,
  author_id: c.user_info?.user_id,
  author_avatar: c.user_info?.avatar_url,
  create_time: createTimeSeconds,
  like_count: parseInt(c.digg_count) || 0,
  reply_count: parseInt(c.reply_count) || 0,  // ⭐ 使用 c.reply_count
  detected_at: Math.floor(Date.now() / 1000),
});
```

### 抖音 API 实际字段（未验证）

根据经验和文档，抖音评论 API 可能的字段名：

| 功能 | 可能的字段名 | 当前使用 |
|------|-------------|---------|
| 一级回复总数 | `reply_comment_total` | `reply_count` |
| 二级回复总数 | `reply_to_reply_total` | - |
| 点赞数 | `digg_count` | ✅ `digg_count` |
| 评论ID | `cid` 或 `comment_id` | `comment_id` |
| 评论内容 | `text` | ✅ `text` |

**⚠️ 风险**: 如果 API 字段名是 `reply_comment_total`，那么当前代码的 `c.reply_count` 会一直返回 0，即使评论有回复也不会被识别。

---

## 🎯 需要验证的问题

### 1. API 字段名验证

**问题**: 抖音评论 API 返回的回复数字段名是什么？

**验证方法**:
1. 找一个有回复的评论（reply_count > 0）
2. 查看 API 响应数据
3. 确认实际的字段名

**可能的结果**:
- 如果是 `reply_count`：当前代码正确 ✅
- 如果是 `reply_comment_total`：需要修改代码 ❌

### 2. 讨论 API 触发机制

**问题**: 如何触发讨论（二级/三级回复）API？

**已知信息**:
- API 模式: `/comment.*reply/`
- 代码已正确设置拦截器（第124-139行）

**可能的触发方式**:
1. 页面自动加载回复（如果 reply_count > 0）
2. 需要点击"查看回复"按钮
3. 需要滚动到评论底部
4. 需要其他交互行为

**当前状态**: 无法验证（测试数据中没有有回复的评论）

---

## 📋 建议的测试场景

### 理想的测试数据

为了完整验证讨论抓取功能，需要：

1. **视频作品**: 至少1个有评论的视频
2. **一级评论**: 至少2-3条评论
3. **二级回复**: 至少1-2条评论有回复
4. **三级回复**: 至少1条二级回复有三级回复

### 测试步骤

1. **准备测试数据**:
   - 找一个有评论回复的视频
   - 或在当前视频下手动回复一条评论

2. **运行爬虫**:
   ```bash
   # 清空数据库
   node tests/清空测试数据.js

   # 运行爬虫
   # Master 和 Worker 会自动触发爬取
   ```

3. **验证结果**:
   ```bash
   # 查看数据
   node tests/检查评论回复数.js
   ```

4. **检查 Worker 日志**:
   - 查看是否拦截到 `/comment.*reply/` API
   - 查看 apiResponses.discussions 数组是否有数据

---

## 🛠️ 可能需要的代码修复

### 修复1: 字段名称（如果验证后需要）

**文件**: `packages/worker/src/platforms/douyin/crawl-comments.js`

**第394行** (如果 API 字段是 `reply_comment_total`):
```javascript
// 修改前
reply_count: parseInt(c.reply_count) || 0,

// 修改后
reply_count: parseInt(c.reply_comment_total || c.reply_count) || 0,
```

### 修复2: 添加讨论API触发逻辑（如果需要）

**可能需要的逻辑** (在第180-184行之后):
```javascript
// 点击完所有视频后，尝试展开评论回复
logger.info('Checking for comments with replies...');

// 查找有回复的评论
await page.evaluate(() => {
  // 查找包含"X条回复"或"查看回复"的按钮
  const replyButtons = document.querySelectorAll('button, div[class*="reply"], span[class*="reply"]');
  for (const btn of replyButtons) {
    const text = btn.innerText || '';
    if (text.includes('条回复') || text.includes('查看回复')) {
      btn.click();
      // 等待API触发
      await new Promise(resolve => setTimeout(resolve, 500));
    }
  }
});
```

---

## 📝 总结

### 当前状态

1. ✅ 评论爬取功能正常
2. ✅ 评论数据正确存储到 comments 表
3. ✅ reply_count 字段正常（当前测试数据都是0）
4. ⏳ 讨论抓取功能未能验证（缺少测试数据）
5. ⚠️ API 字段名需要验证（reply_count vs reply_comment_total）

### 下一步行动

**选项A: 手动创建测试数据**
1. 在当前视频下回复一条评论
2. 重新运行爬虫
3. 验证讨论是否能被抓取

**选项B: 查找其他测试账号**
1. 使用有回复评论的其他抖音账号
2. 运行完整的爬虫测试
3. 验证 API 字段名和讨论抓取逻辑

**选项C: 查看历史日志**
1. 检查之前的 Worker 日志
2. 查找包含 `reply_comment_total` 的 API 响应
3. 确认实际的字段名

---

**报告生成时间**: 2025-10-24
**测试状态**: ⏸️ 部分完成（缺少有回复的评论进行完整测试）
