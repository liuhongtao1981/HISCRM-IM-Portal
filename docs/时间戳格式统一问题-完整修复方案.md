# 时间戳格式统一问题 - 完整修复方案

## 时间: 2025-11-05 09:40

## 问题描述

**用户反馈**:
1. "每个消息的时间都是一样的"
2. "所有客户端时间显示都是一样的"
3. "我们服务端为啥会发给IM 2024-01-01 这样的日期，应该统一是毫秒时间戳才对"

**根本原因**: 系统中混用了两种时间格式（ISO 8601 字符串 和 毫秒时间戳），导致数据流中多处格式转换错误。

## 问题根源

### 1. Worker 端问题 - 发送 ISO 字符串

**文件**: `packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js`

**问题代码** (Line 1405-1406):
```javascript
// ❌ 错误: 可能发送 ISO 字符串
timestamp: props.createdAt || props.timestamp || props.createTime || new Date().toISOString(),
created_at: props.createdAt || props.timestamp || props.createTime || new Date().toISOString(),
```

**问题分析**:
- `props.createdAt` 等字段可能本身就是 ISO 字符串
- fallback 使用 `new Date().toISOString()` 生成 ISO 字符串
- 发送给 Master 的数据格式不统一

### 2. Master 端问题 - 错误解析 ISO 字符串

**文件**: `packages/master/src/communication/im-websocket-server.js`

**问题代码** (3处 `normalizeTimestamp()` 函数):
```javascript
// ❌ 错误: 对 ISO 字符串使用 parseInt()
if (typeof timestamp === 'string') {
  const numericTimestamp = parseInt(timestamp);  // ← BUG!
  if (!isNaN(numericTimestamp)) {
    timestamp = numericTimestamp;
  }
}
```

**Bug 触发过程**:
```javascript
timestamp = "2025-11-04T15:58:27.004Z"
parseInt("2025-11-04T15:58:27.004Z") = 2025  // ← 只提取到年份!
2025 < 10000000000 → 判断为秒级时间戳
2025 * 1000 = 2025000
new Date(2025000) = "1970-01-01 08:33:45"  // ← 错误!
```

## 完整修复方案

### 修复 1: Worker 端统一发送毫秒时间戳

**文件**: `packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js`

**修改位置**: Line 1405-1406

**修改内容**:
```javascript
// ✅ 修复: 统一转换为毫秒时间戳
timestamp: normalizeTimestamp(props.createdAt || props.timestamp || props.createTime),
created_at: normalizeTimestamp(props.createdAt || props.timestamp || props.createTime),
```

**normalizeTimestamp() 函数说明** (Line 49-96):
- 已存在的工具函数，专门用于时间戳标准化
- 支持输入: 毫秒时间戳、秒时间戳、ISO 字符串、Date 对象
- 输出: 统一的毫秒时间戳（13位数字）
- 包含时区修正逻辑（UTC+8 → UTC）

```javascript
function normalizeTimestamp(timestamp) {
  // 处理 null/undefined
  if (!timestamp) return Date.now();

  // 处理 Date 对象
  if (timestamp instanceof Date) {
    return timestamp.getTime();
  }

  // 处理数字
  if (typeof timestamp === 'number') {
    let timestampInMs;
    if (timestamp < 10000000000) {
      timestampInMs = timestamp * 1000;  // 秒 → 毫秒
    } else {
      timestampInMs = Math.floor(timestamp);
    }
    // 时区修正: UTC+8 → UTC
    const TIMEZONE_OFFSET_MS = 8 * 3600 * 1000;
    return timestampInMs - TIMEZONE_OFFSET_MS;
  }

  // 处理字符串
  if (typeof timestamp === 'string') {
    const num = Number(timestamp);
    if (!isNaN(num)) {
      return normalizeTimestamp(num);
    }
    // 解析 ISO 8601 字符串
    const date = new Date(timestamp);
    if (!isNaN(date.getTime())) {
      return date.getTime();
    }
  }

  // 无法解析，返回当前时间
  return Date.now();
}
```

### 修复 2: Master 端正确解析 ISO 字符串

**文件**: `packages/master/src/communication/im-websocket-server.js`

**修改位置**: 3处 `normalizeTimestamp()` 函数
- Line 304-309: `getTopicsFromDataStore()` 内部定义
- Line 504-510: `handleAdminSync()` 内部定义
- Line 667-672: `findLastMessage()` 内部定义

**修改内容**: 在每个函数中添加 ISO 8601 格式检测

```javascript
const normalizeTimestamp = (timestamp) => {
  if (!timestamp) return Date.now();

  if (typeof timestamp === 'string') {
    // ✅ 优先检测 ISO 8601 格式
    if (timestamp.includes('T') || timestamp.includes('-')) {
      const isoDate = new Date(timestamp);
      if (!isNaN(isoDate.getTime())) {
        return isoDate.getTime();  // 返回毫秒时间戳
      }
    }

    // 处理中文格式
    const match = timestamp.match(/(\d{4})年(\d{1,2})月(\d{1,2})日\s+(\d{1,2}):(\d{2})/);
    if (match) {
      // ... 解析中文格式
    }

    // 最后才使用 parseInt()
    const numericTimestamp = parseInt(timestamp);
    if (!isNaN(numericTimestamp)) {
      timestamp = numericTimestamp;
    }
  }

  // 秒/毫秒判断
  if (timestamp < 10000000000) {
    return timestamp * 1000;
  }
  return timestamp;
};
```

## 修复效果

### 修复前的数据流

```
Worker (虚拟列表提取)
  ↓
  props.createdAt = "2025-11-04T15:58:27.004Z" (ISO 字符串)
  ↓
  直接使用 → timestamp = "2025-11-04T15:58:27.004Z"
  ↓
DataStore (Master 内存)
  ↓
  存储 ISO 字符串
  ↓
IM WebSocket Server
  ↓
  normalizeTimestamp("2025-11-04T15:58:27.004Z")
  ↓
  parseInt("2025-11-04T...") = 2025
  ↓
  2025 * 1000 = 2025000
  ↓
IM Client
  ↓
  显示: 01/01 08:33 (1970年1月1日) ❌
```

### 修复后的数据流

```
Worker (虚拟列表提取)
  ↓
  props.createdAt = "2025-11-04T15:58:27.004Z" (ISO 字符串)
  ↓
  normalizeTimestamp() → 1762304707004 (毫秒时间戳) ✅
  ↓
DataStore (Master 内存)
  ↓
  存储毫秒时间戳 (数字)
  ↓
IM WebSocket Server
  ↓
  收到数字，直接通过
  ↓
IM Client
  ↓
  显示: 11/04 15:58 (2025年11月4日) ✅
```

## 时间格式标准

### 系统统一标准

**内部传输和存储**: 毫秒时间戳（13位数字）
```javascript
1762304707004
```

**优点**:
- 不受时区影响
- 计算方便（排序、比较、时间差）
- 传输效率高（数字比字符串小）
- 类型安全（不会被错误解析）

**使用场景**:
- DataStore 内存存储
- WebSocket 数据传输
- 数据库部分字段（`lastMessageTime`、`updatedAt` 等）

### 辅助格式

**ISO 8601 字符串**: 仅用于日志和调试
```javascript
"2025-11-04T15:58:27.004Z"
```

**优点**:
- 人类可读
- 国际标准
- 包含时区信息

**使用场景**:
- 日志输出
- 调试信息
- 数据库部分字段（`createdAt` 等，仅供查询）

## 验证步骤

### 1. 重启 Worker 和 Master

```bash
# 重启 Master
cd packages/master
npm start

# 重启 Worker (如果在运行)
cd packages/worker
npm start
```

### 2. 等待数据抓取

等待 Worker 执行新一轮私信抓取，或手动触发抓取任务。

### 3. 检查 Worker 发送的数据

查看 Worker 日志，确认发送给 Master 的数据格式：

```bash
grep "timestamp" packages/worker/logs/douyin-platform.log | tail -10
```

**预期输出** (timestamp 应该是数字，不是字符串):
```
timestamp: 1762304707004  ✅
```

**错误输出** (如果还是字符串):
```
timestamp: "2025-11-04T15:58:27.004Z"  ❌
```

### 4. 检查 Master DataStore

在 Master 启动后，通过 HTTP API 查询数据：

```bash
curl http://localhost:3000/api/debug/datastore | jq '.messages[0]'
```

**预期输出**:
```json
{
  "messageId": "...",
  "createdAt": 1762304707004,  // ✅ 数字
  "timestamp": 1762304707004   // ✅ 数字
}
```

### 5. 检查 IM 客户端显示

打开 IM 客户端，查看账号列表和会话列表的时间显示：

**预期结果**:
```
账号1: 11/04 15:58  ✅
账号2: 11/04 00:50  ✅
账号3: 11/03 05:30  ✅
```

**错误结果**:
```
账号1: 01/01 08:33  ❌ (1970年)
账号2: 01/01 08:33  ❌ (全部相同)
```

### 6. 检查浏览器控制台

打开浏览器控制台（F12），查看 WebSocket 接收到的数据：

```javascript
// channels 数据
{
  id: "acc-...",
  lastMessageTime: 1762304707004  // ✅ 应该是数字
}

// topics 数据
{
  id: "topic-...",
  lastMessageTime: 1762304707004  // ✅ 应该是数字
}
```

## 潜在问题

### 问题 1: 旧数据仍然是 ISO 字符串

**现象**: 已经存在于 DataStore 中的数据仍然是 ISO 字符串格式

**原因**: DataStore 是内存缓存，不会自动更新旧数据

**解决方案**:
1. 重启 Master（清空 DataStore）
2. 等待 Worker 重新同步数据
3. 新数据将使用毫秒时间戳格式

### 问题 2: 数据库中的 ISO 字符串

**现象**: `cache_messages.createdAt` 等字段仍然是 ISO 字符串

**原因**: 数据库 schema 设计，某些字段使用 TEXT 存储 ISO 字符串

**说明**:
- 这是**预期行为**，不是 bug
- 数据库的 `createdAt` 字段用于查询和展示，保持 ISO 格式便于阅读
- 数据库的 `updatedAt` 字段使用毫秒时间戳，用于排序和计算

**结论**: 不需要修改数据库 schema

## 技术总结

### parseInt() 的陷阱

`parseInt()` 会从左到右解析字符串，遇到非数字字符时停止：

```javascript
parseInt("2025-11-04T15:58:27.004Z")  // 2025  ← 危险!
parseInt("2025")                       // 2025  ✅
parseInt("abc123")                     // NaN   ✅
```

**推荐做法**:
1. 先检测格式（ISO、中文等）
2. 使用对应的解析方法（`new Date()`、正则等）
3. `parseInt()` 只用于确认是纯数字字符串的情况

### 时间戳格式转换最佳实践

**统一标准**:
- **内部**: 毫秒时间戳（数字）
- **外部**: 根据需求选择格式

**转换函数**:
```javascript
// 通用转换函数
function normalizeTimestamp(input) {
  if (!input) return Date.now();

  // 处理 Date 对象
  if (input instanceof Date) {
    return input.getTime();
  }

  // 处理数字
  if (typeof input === 'number') {
    return input < 10000000000 ? input * 1000 : input;
  }

  // 处理字符串
  if (typeof input === 'string') {
    // 尝试解析为日期
    const date = new Date(input);
    if (!isNaN(date.getTime())) {
      return date.getTime();
    }
    // 尝试解析为数字
    const num = Number(input);
    if (!isNaN(num)) {
      return normalizeTimestamp(num);
    }
  }

  return Date.now();
}
```

### 数据流设计原则

1. **单一责任**: 每一层只负责一种格式转换
2. **边界标准化**: 在系统边界（Worker → Master, Master → Client）统一格式
3. **类型安全**: 使用 TypeScript 定义明确类型
4. **向后兼容**: 兼容多种输入格式，但输出统一标准

```typescript
// 推荐做法
interface Message {
  id: string;
  content: string;
  createdAt: number;  // 毫秒时间戳
  timestamp: number;  // 毫秒时间戳
}

// 而不是
interface Message {
  createdAt: string | number;  // ❌ 混用格式
}
```

## 相关文档

- [时间戳显示问题-最终修复报告](./时间戳显示问题-最终修复报告.md) - Master 端修复
- [私信时间戳显示问题-完整修复报告](./私信时间戳显示问题-完整修复报告.md) - 第一次修复
- [会话时间戳问题-根本原因和修复方案](./会话时间戳问题-根本原因和修复方案.md) - 问题分析

## 修复记录

- **问题发现**: 2025-11-05 09:10
- **Master 端修复**: 2025-11-05 09:35 - 修复 3 个 `normalizeTimestamp()` 函数
- **Worker 端修复**: 2025-11-05 09:40 - 统一发送毫秒时间戳
- **修复文件**:
  - `packages/master/src/communication/im-websocket-server.js`
  - `packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js`
- **修复行数**:
  - Master: Line 304-309, Line 504-510, Line 667-672
  - Worker: Line 1405-1406
- **测试状态**: ⏳ 待 Master + Worker 重启后验证

## 验证清单

- [ ] Worker 服务已重启
- [ ] Master 服务已重启
- [ ] 等待新一轮数据抓取
- [ ] Worker 日志中 timestamp 为数字
- [ ] Master DataStore 中 timestamp 为数字
- [ ] IM 客户端时间显示各不相同
- [ ] IM 客户端时间不是 "01/01 08:33"
- [ ] 浏览器控制台 lastMessageTime 为数字
