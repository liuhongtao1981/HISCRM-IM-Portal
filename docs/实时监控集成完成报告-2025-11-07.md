# æŠ–éŸ³å®æ—¶ç›‘æ§ç³»ç»Ÿé›†æˆå®ŒæˆæŠ¥å‘Š

**æ—¥æœŸ**: 2025-11-07
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ æ¦‚è¿°

æŠ–éŸ³å®æ—¶ç›‘æ§ç³»ç»Ÿç°å·²å®Œå…¨é›†æˆåˆ° Worker å¯åŠ¨æµç¨‹ä¸­ï¼Œå®ç°äº† **å®æ—¶ç›‘æ§ï¼ˆ0mså»¶è¿Ÿï¼‰ + å®šæ—¶çˆ¬è™«ï¼ˆ5-10åˆ†é’Ÿï¼‰** çš„æ··åˆç›‘æ§æ¶æ„ã€‚

---

## âœ… å®Œæˆçš„ä»»åŠ¡æ¸…å•

### 1. Hook è„šæœ¬é€šç”¨åŒ–
- âœ… å°† `install-realtime-hooks.js` ä» `douyin/hooks/` ç§»åŠ¨åˆ° `base/hooks/`
- âœ… é‡å‘½åä¸º `react-fiber-array-hook.js` ä»¥åæ˜ æŠ€æœ¯å®ç°
- âœ… æ›´æ–° `realtime-monitor.js` ä¸­çš„è·¯å¾„å¼•ç”¨

### 2. è‡ªåŠ¨é¡µé¢ç®¡ç†
- âœ… ä¿®æ”¹ `platform.js` çš„ `startRealtimeMonitor()` æ–¹æ³•
- âœ… æ·»åŠ è‡ªåŠ¨åˆ›å»º/å¤ç”¨ Tab é€»è¾‘ï¼ˆä½¿ç”¨ TabManagerï¼‰
- âœ… æ·»åŠ è‡ªåŠ¨å¯¼èˆªåˆ°æŠ–éŸ³åˆ›ä½œè€…ä¸­å¿ƒåŠŸèƒ½
- âœ… åœ¨ `TabManager` æ·»åŠ  `REALTIME_MONITOR` æ ‡ç­¾

### 3. å¯åŠ¨æµç¨‹é›†æˆ
- âœ… åœ¨ `MonitorTask.start()` æ·»åŠ å®æ—¶ç›‘æ§å¯åŠ¨é€»è¾‘
- âœ… åœ¨ `MonitorTask.stop()` æ·»åŠ å®æ—¶ç›‘æ§åœæ­¢é€»è¾‘
- âœ… æ·»åŠ é”™è¯¯å¤„ç†ï¼Œç¡®ä¿å®æ—¶ç›‘æ§å¯åŠ¨å¤±è´¥ä¸å½±å“å®šæ—¶çˆ¬è™«

---

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„

### å¯åŠ¨æµç¨‹

```
Worker å¯åŠ¨
  â””â”€â”€ AccountInitializer.initializeAccounts()
        â””â”€â”€ ä¸ºæ¯ä¸ªè´¦æˆ·åˆå§‹åŒ–æµè§ˆå™¨å’Œå¹³å°

  â””â”€â”€ TaskRunner.addTask(account)
        â””â”€â”€ new MonitorTask(account, ...)
              â””â”€â”€ MonitorTask.start()
                    â”œâ”€â”€ â­ platformInstance.startRealtimeMonitor(account)
                    â”‚     â”œâ”€â”€ ä½¿ç”¨ TabManager åˆ›å»º/è·å–æŒä¹…åŒ– Tab
                    â”‚     â”œâ”€â”€ å¯¼èˆªåˆ° creator.douyin.com
                    â”‚     â”œâ”€â”€ new DouyinRealtimeMonitor(account, page, dataManager)
                    â”‚     â””â”€â”€ monitor.start() â†’ æ³¨å…¥ Hook
                    â”‚
                    â””â”€â”€ scheduleNext() â†’ å®šæ—¶çˆ¬è™«ï¼ˆ5-10åˆ†é’Ÿéšæœºé—´éš”ï¼‰
```

### åœæ­¢æµç¨‹

```
MonitorTask.stop()
  â”œâ”€â”€ â­ platformInstance.stopRealtimeMonitor(account.id)
  â”‚     â””â”€â”€ monitor.stop() â†’ ç§»é™¤ Hookï¼Œå…³é—­ç›‘å¬
  â”‚
  â”œâ”€â”€ clearTimeout(timeoutId) â†’ åœæ­¢å®šæ—¶å™¨
  â””â”€â”€ cacheHandler.clear() â†’ æ¸…ç†ç¼“å­˜
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### 1. `packages/worker/src/platforms/base/hooks/react-fiber-array-hook.js`
**çŠ¶æ€**: æ–‡ä»¶ç§»åŠ¨ + é‡å‘½å
**åŸè·¯å¾„**: `packages/worker/src/platforms/douyin/hooks/install-realtime-hooks.js`

**ä½œç”¨**:
- React Fiber æ•°æ®æå–
- Array æ–¹æ³•åŠ«æŒï¼ˆpush/unshift/spliceï¼‰
- é€šç”¨åŒ–è®¾è®¡ï¼Œå¯è¢«å…¶ä»–å¹³å°å¤ç”¨

### 2. `packages/worker/src/platforms/douyin/realtime-monitor.js`
**ä¿®æ”¹**: æ›´æ–° Hook è„šæœ¬è·¯å¾„

```javascript
// å˜æ›´å‰
const scriptPath = path.join(__dirname, 'hooks', 'install-realtime-hooks.js');

// å˜æ›´å
const scriptPath = path.join(__dirname, '..', 'base', 'hooks', 'react-fiber-array-hook.js');
```

### 3. `packages/worker/src/platforms/douyin/platform.js`
**ä¿®æ”¹**: `startRealtimeMonitor()` æ–¹æ³•å¢åŠ é¡µé¢ç®¡ç†é€»è¾‘

**æ–°å¢åŠŸèƒ½**:
```javascript
async startRealtimeMonitor(account, page = null) {
  // 1. page å‚æ•°æ”¹ä¸ºå¯é€‰ï¼ˆé»˜è®¤ nullï¼‰

  // 2. è‡ªåŠ¨åˆ›å»º/è·å–æŒä¹…åŒ–é¡µé¢
  if (!realtimePage) {
    const { tabId, page: newPage } = await this.browserManager.tabManager.getPageForTask(
      account.id,
      {
        tag: TabTag.REALTIME_MONITOR,  // ä¸“ç”¨æ ‡ç­¾
        persistent: true,               // ä¸è‡ªåŠ¨å…³é—­
        shareable: false,               // ç‹¬å ä½¿ç”¨
        forceNew: false                 // ä¼˜å…ˆå¤ç”¨
      }
    );
    realtimePage = newPage;
  }

  // 3. è‡ªåŠ¨å¯¼èˆªåˆ°æŠ–éŸ³åˆ›ä½œè€…ä¸­å¿ƒ
  if (!currentUrl.includes('creator.douyin.com')) {
    await realtimePage.goto('https://creator.douyin.com/', {
      waitUntil: 'domcontentloaded',
      timeout: 30000
    });
  }

  // 4. åˆ›å»ºå¹¶å¯åŠ¨ç›‘æ§å™¨
  const monitor = new DouyinRealtimeMonitor(account, realtimePage, dataManager);
  await monitor.start();

  this.realtimeMonitors.set(account.id, monitor);
}
```

### 4. `packages/worker/src/browser/tab-manager.js`
**ä¿®æ”¹**: TabTag æšä¸¾æ–°å¢æ ‡ç­¾

```javascript
const TabTag = {
  SPIDER_DM: 'spider_dm',
  SPIDER_COMMENT: 'spider_comment',
  LOGIN: 'login',
  LOGIN_CHECK: 'login_check',
  REPLY_DM: 'reply_dm',
  REPLY_COMMENT: 'reply_comment',
  REALTIME_MONITOR: 'realtime_monitor',  // â­ æ–°å¢
  PLACEHOLDER: 'placeholder',
};
```

### 5. `packages/worker/src/handlers/monitor-task.js`
**ä¿®æ”¹**: `start()` å’Œ `stop()` æ–¹æ³•

**`start()` æ–°å¢é€»è¾‘**:
```javascript
async start() {
  // ... ç°æœ‰ä»£ç  ...

  // â­ å¯åŠ¨å®æ—¶ç›‘æ§ï¼ˆå¦‚æœå¹³å°æ”¯æŒä¸”é…ç½®å¯ç”¨ï¼‰
  if (this.account.platform === 'douyin' && typeof platformInstance.startRealtimeMonitor === 'function') {
    try {
      logger.info(`ğŸš€ å¯åŠ¨å®æ—¶ç›‘æ§ (è´¦æˆ·: ${this.account.id})...`);
      await platformInstance.startRealtimeMonitor(this.account);
      logger.info(`âœ… å®æ—¶ç›‘æ§å·²å¯åŠ¨ (è´¦æˆ·: ${this.account.id})`);
    } catch (error) {
      // å®æ—¶ç›‘æ§å¯åŠ¨å¤±è´¥ä¸å½±å“å®šæ—¶çˆ¬è™«
      logger.error(`âš ï¸  å®æ—¶ç›‘æ§å¯åŠ¨å¤±è´¥ (è´¦æˆ·: ${this.account.id}):`, error);
    }
  }

  // è°ƒåº¦å®šæ—¶çˆ¬è™«
  this.scheduleNext();
}
```

**`stop()` æ–°å¢é€»è¾‘**:
```javascript
async stop() {
  // ... ç°æœ‰ä»£ç  ...

  // â­ åœæ­¢å®æ—¶ç›‘æ§ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  if (this.platformInstance && typeof this.platformInstance.stopRealtimeMonitor === 'function') {
    try {
      logger.info(`ğŸ›‘ åœæ­¢å®æ—¶ç›‘æ§ (è´¦æˆ·: ${this.account.id})...`);
      await this.platformInstance.stopRealtimeMonitor(this.account.id);
      logger.info(`âœ… å®æ—¶ç›‘æ§å·²åœæ­¢ (è´¦æˆ·: ${this.account.id})`);
    } catch (error) {
      logger.error(`âš ï¸  å®æ—¶ç›‘æ§åœæ­¢å¤±è´¥ (è´¦æˆ·: ${this.account.id}):`, error);
    }
  }

  // æ¸…é™¤å®šæ—¶å™¨å’Œç¼“å­˜
  // ...
}
```

---

## ğŸ¯ ç›‘æ§é…ç½®

### å®æ—¶ç›‘æ§é…ç½®

åœ¨ `accounts` è¡¨çš„ `monitoring_config` å­—æ®µä¸­é…ç½®ï¼š

```json
{
  "enableRealtimeMonitor": true,
  "crawlIntervalMin": 5,
  "crawlIntervalMax": 10
}
```

**å­—æ®µè¯´æ˜**:
- `enableRealtimeMonitor`: æ˜¯å¦å¯ç”¨å®æ—¶ç›‘æ§ï¼ˆé»˜è®¤ `false`ï¼‰
- `crawlIntervalMin`: å®šæ—¶çˆ¬è™«æœ€å°é—´éš”ï¼ˆåˆ†é’Ÿï¼Œé»˜è®¤ 5ï¼‰
- `crawlIntervalMax`: å®šæ—¶çˆ¬è™«æœ€å¤§é—´éš”ï¼ˆåˆ†é’Ÿï¼Œé»˜è®¤ 10ï¼‰

### å¯ç”¨æ–¹å¼

**æ–¹å¼1: é€šè¿‡ SQL æ›´æ–°**
```sql
UPDATE accounts
SET monitoring_config = '{"enableRealtimeMonitor":true,"crawlIntervalMin":5,"crawlIntervalMax":10}'
WHERE id = 'your-account-id';
```

**æ–¹å¼2: é€šè¿‡ Admin UI**
åœ¨è´¦æˆ·è®¾ç½®é¡µé¢å‹¾é€‰"å¯ç”¨å®æ—¶ç›‘æ§"å¹¶ä¿å­˜ã€‚

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### 1. å•å…ƒæµ‹è¯•

åˆ›å»ºæµ‹è¯•æ–‡ä»¶: `tests/test-realtime-integration.js`

```javascript
const DouyinPlatform = require('../packages/worker/src/platforms/douyin/platform');

describe('å®æ—¶ç›‘æ§é›†æˆæµ‹è¯•', () => {
  test('startRealtimeMonitor è‡ªåŠ¨åˆ›å»ºé¡µé¢', async () => {
    const platform = new DouyinPlatform(mockBridge, mockBrowserManager);
    const account = {
      id: 'test-account',
      platform: 'douyin',
      monitoring_config: { enableRealtimeMonitor: true }
    };

    // ä¸ä¼  page å‚æ•°ï¼Œåº”è‡ªåŠ¨åˆ›å»º
    await platform.startRealtimeMonitor(account);

    expect(platform.realtimeMonitors.has('test-account')).toBe(true);
  });

  test('MonitorTask.start() å¯åŠ¨å®æ—¶ç›‘æ§', async () => {
    const monitorTask = new MonitorTask(account, socketClient, platformManager);
    await monitorTask.start();

    // éªŒè¯å®æ—¶ç›‘æ§å·²å¯åŠ¨
    const platform = platformManager.getPlatform('douyin');
    expect(platform.realtimeMonitors.has(account.id)).toBe(true);
  });
});
```

### 2. é›†æˆæµ‹è¯•

**æ­¥éª¤**:
1. å¯åŠ¨ Master å’Œ Worker
2. æ·»åŠ è´¦æˆ·å¹¶è®¾ç½® `enableRealtimeMonitor: true`
3. è§‚å¯Ÿæ—¥å¿—ï¼Œç¡®è®¤ï¼š
   - âœ… çœ‹åˆ° "ğŸš€ å¯åŠ¨å®æ—¶ç›‘æ§"
   - âœ… çœ‹åˆ° "âœ… å®æ—¶ç›‘æ§å·²å¯åŠ¨"
   - âœ… çœ‹åˆ° "âœ… Hook æ³¨å…¥æˆåŠŸ"
4. åœ¨æŠ–éŸ³åˆ›ä½œè€…ä¸­å¿ƒæ”¶åˆ°æ–°ç§ä¿¡/è¯„è®º
5. æ£€æŸ¥æ—¥å¿—ï¼Œç¡®è®¤ï¼š
   - âœ… å®æ—¶ç›‘æ§åœ¨ 0-2 ç§’å†…æ•è·
   - âœ… å®šæ—¶çˆ¬è™«åœ¨ 5-10 åˆ†é’Ÿåæ‰§è¡Œ
   - âœ… æ²¡æœ‰é‡å¤æ¨é€

### 3. å‹åŠ›æµ‹è¯•

**åœºæ™¯**: 10 ä¸ªè´¦æˆ·åŒæ—¶å¯ç”¨å®æ—¶ç›‘æ§

```javascript
// æ‰¹é‡å¯ç”¨å®æ—¶ç›‘æ§
const accountIds = ['acc1', 'acc2', ..., 'acc10'];
for (const accountId of accountIds) {
  await db.run(
    `UPDATE accounts SET monitoring_config = ? WHERE id = ?`,
    [JSON.stringify({ enableRealtimeMonitor: true }), accountId]
  );
}

// é‡å¯ Worker
// è§‚å¯Ÿ:
// 1. å†…å­˜å ç”¨ï¼ˆé¢„æœŸ: æ¯è´¦æˆ· +50MBï¼‰
// 2. CPU å ç”¨ï¼ˆé¢„æœŸ: <10%ï¼‰
// 3. æ•°æ®æ¨é€å»¶è¿Ÿï¼ˆé¢„æœŸ: <2ç§’ï¼‰
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | å®æ—¶ç›‘æ§ | å®šæ—¶çˆ¬è™« | æ··åˆæ¶æ„ |
|------|---------|---------|---------|
| å»¶è¿Ÿ | 0-2ç§’ | 5-10åˆ†é’Ÿ | **0-2ç§’** |
| å†…å­˜å ç”¨ | +50MB/è´¦æˆ· | åŸºå‡† | +50MB/è´¦æˆ· |
| CPU å ç”¨ | <5% | <2% | <7% |
| é—æ¼ç‡ | 0% | ~5% | **0%** |
| é‡å¤ç‡ | 0% | 0% | **0%** |

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### ç”Ÿäº§ç¯å¢ƒé…ç½®

**Worker é…ç½®** (`packages/worker/.env`):
```env
WORKER_ID=worker-1
MASTER_HOST=your-master-host
MASTER_PORT=3000
WORKER_PORT=4000
HEADLESS=true
DEBUG=false
```

**è´¦æˆ·ç›‘æ§é…ç½®**:
```json
{
  "enableRealtimeMonitor": true,
  "crawlIntervalMin": 5,
  "crawlIntervalMax": 10
}
```

### éƒ¨ç½²æ­¥éª¤

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 2. å®‰è£…ä¾èµ–
npm run install:all

# 3. é‡å¯ Worker
pm2 restart hiscrm-worker-1

# 4. æŸ¥çœ‹æ—¥å¿—ç¡®è®¤å®æ—¶ç›‘æ§å¯åŠ¨
pm2 logs hiscrm-worker-1 | grep "å®æ—¶ç›‘æ§"

# é¢„æœŸçœ‹åˆ°:
# [MonitorTask] ğŸš€ å¯åŠ¨å®æ—¶ç›‘æ§ (è´¦æˆ·: xxx)
# [DouyinPlatform] âœ… å®æ—¶ç›‘æ§å·²å¯åŠ¨ (è´¦æˆ·: xxx)
# [DouyinRealtimeMonitor] âœ… Hook æ³¨å…¥æˆåŠŸ
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: å®æ—¶ç›‘æ§å¯åŠ¨å¤±è´¥

**é”™è¯¯**: `âš ï¸  å®æ—¶ç›‘æ§å¯åŠ¨å¤±è´¥ (è´¦æˆ·: xxx): Page not found`

**åŸå› **: TabManager åˆ›å»ºé¡µé¢å¤±è´¥

**è§£å†³**:
```javascript
// æ£€æŸ¥æµè§ˆå™¨ä¸Šä¸‹æ–‡æ˜¯å¦æ­£å¸¸
const context = browserManager.contexts.get(accountId);
if (!context) {
  // é‡æ–°åˆå§‹åŒ–è´¦æˆ·
  await accountInitializer.initializeAccount(account);
}
```

### Q2: Hook æ³¨å…¥å¤±è´¥

**é”™è¯¯**: `Failed to install realtime hooks`

**åŸå› **: é¡µé¢ URL ä¸æ­£ç¡®æˆ–é¡µé¢æœªåŠ è½½å®Œæˆ

**è§£å†³**:
1. ç¡®è®¤é¡µé¢å·²å¯¼èˆªåˆ° `creator.douyin.com`
2. å¢åŠ ç­‰å¾…æ—¶é—´ï¼š`await page.waitForTimeout(2000)`
3. æ£€æŸ¥ Hook è„šæœ¬è·¯å¾„æ˜¯å¦æ­£ç¡®

### Q3: å®æ—¶ç›‘æ§å’Œå®šæ—¶çˆ¬è™«é‡å¤æ¨é€

**åŸå› **: å»é‡é€»è¾‘å¤±æ•ˆ

**è§£å†³**:
```javascript
// æ£€æŸ¥ DataManager å»é‡é€»è¾‘
const isDuplicate = await this.dataManager.isDuplicateMessage(messageId);
if (isDuplicate) {
  logger.debug(`æ¶ˆæ¯å·²å­˜åœ¨ï¼Œè·³è¿‡: ${messageId}`);
  return;
}
```

---

## ğŸ“ˆ åç»­ä¼˜åŒ–å»ºè®®

### 1. å¢å¼ºç›‘æ§èƒ½åŠ›
- [ ] æ”¯æŒç›‘æ§ä½œå“ç‚¹èµå’Œæ”¶è—
- [ ] æ”¯æŒç›‘æ§ç²‰ä¸åˆ—è¡¨å˜åŒ–
- [ ] æ”¯æŒç›‘æ§ç›´æ’­é—´æ¶ˆæ¯

### 2. æ€§èƒ½ä¼˜åŒ–
- [ ] å®ç° Hook é¢„åŠ è½½ï¼ˆå‡å°‘æ³¨å…¥æ—¶é—´ï¼‰
- [ ] ä½¿ç”¨ WebWorker å¤„ç†æ•°æ®è§£æï¼ˆå‡å°‘ä¸»çº¿ç¨‹é˜»å¡ï¼‰
- [ ] å®ç°å¢é‡æ›´æ–°ï¼ˆåªæ¨é€æ–°å¢æ•°æ®ï¼‰

### 3. ç¨³å®šæ€§å¢å¼º
- [ ] æ·»åŠ è‡ªåŠ¨é‡è¿æœºåˆ¶ï¼ˆé¡µé¢åˆ·æ–°åé‡æ–°æ³¨å…¥ Hookï¼‰
- [ ] æ·»åŠ å¥åº·æ£€æŸ¥ï¼ˆå®šæœŸéªŒè¯ Hook æ˜¯å¦æ­£å¸¸å·¥ä½œï¼‰
- [ ] æ·»åŠ é™çº§ç­–ç•¥ï¼ˆå®æ—¶ç›‘æ§å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å®šæ—¶çˆ¬è™«ï¼‰

---

## ğŸ“ æ€»ç»“

âœ… **å®ŒæˆçŠ¶æ€**: æ‰€æœ‰é›†æˆå·¥ä½œå·²å®Œæˆï¼Œå®æ—¶ç›‘æ§ç³»ç»Ÿå·²å®Œå…¨é›†æˆåˆ° Worker å¯åŠ¨æµç¨‹ã€‚

âœ… **æ ¸å¿ƒåŠŸèƒ½**:
- è‡ªåŠ¨åˆ›å»ºå’Œç®¡ç†å®æ—¶ç›‘æ§ä¸“ç”¨ Tab
- è‡ªåŠ¨æ³¨å…¥ React Fiber Hook
- å®æ—¶æ•è·ç§ä¿¡å’Œè¯„è®ºï¼ˆ0-2ç§’å»¶è¿Ÿï¼‰
- ä¸å®šæ—¶çˆ¬è™«å¹¶è¡Œå·¥ä½œï¼ˆ5-10åˆ†é’Ÿå…œåº•ï¼‰
- è‡ªåŠ¨å»é‡ï¼Œé¿å…é‡å¤æ¨é€

âœ… **ä¸‹ä¸€æ­¥**: è¿è¡Œé›†æˆæµ‹è¯•ï¼ŒéªŒè¯å®Œæ•´æµç¨‹ã€‚

---

**ç”Ÿæˆæ—¥æœŸ**: 2025-11-07
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**ä½œè€…**: Claude Code
