# ç§ä¿¡æ¶ˆæ¯ä¸º0 - è°ƒè¯•æ—¥å¿—å®ç°

## æ—¶é—´: 2025-11-05 15:00

## é—®é¢˜èƒŒæ™¯

ç”¨æˆ·è§‚å¯Ÿå‘ç°ï¼š
> "å…¶å®å‰é¢æˆåŠŸæ‰“å¼€çš„17ä¸ªä¼šè¯é‡Œï¼Œæœ‰ä¿¡æ¯å†…å®¹æˆ‘æ€€ç–‘ä½ æ²¡æœ‰å»æ‰è™šè¡¨é‡Œçš„æ•°æ®"

çˆ¬è™«æå–åˆ°çš„æ‰€æœ‰æ¶ˆæ¯éƒ½æ˜¯ **type 7ï¼ˆç³»ç»Ÿæ¶ˆæ¯ï¼‰**ï¼Œä½†æˆªå›¾æ˜¾ç¤ºæœ‰çœŸå®çš„æ–‡æœ¬æ¶ˆæ¯ã€‚

---

## å®ç°çš„è°ƒè¯•æ–¹æ¡ˆ

### ç›®æ ‡

è¾“å‡ºæ¯ä¸ªæå–åˆ°çš„æ¶ˆæ¯å…ƒç´ çš„å®Œæ•´ props ä¿¡æ¯ï¼Œä»¥ä¾¿è¯Šæ–­ï¼š
1. æ˜¯å¦æå–åˆ°äº†æ­£ç¡®çš„ DOM å…ƒç´ 
2. content å¯¹è±¡é‡Œåˆ°åº•æœ‰ä»€ä¹ˆå­—æ®µ
3. ä¸ºä»€ä¹ˆæ‰€æœ‰æ¶ˆæ¯éƒ½æ˜¯ type 7

### å®ç°æ­¥éª¤

#### æ­¥éª¤1: åœ¨ `page.evaluate()` å†…æ”¶é›†è°ƒè¯•ä¿¡æ¯

**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js`

**Line 1559-1563**: æ·»åŠ  `allPropsDebug` æ•°ç»„
```javascript
const { messages, debugInfo, allPropsDebug } = await page.evaluate(() => {
  const messages = [];
  let debugInfo = null;
  let hasDebugPrinted = false;
  const allPropsDebug = []; // ğŸ” æ”¶é›†æ‰€æœ‰æ¶ˆæ¯çš„propsè°ƒè¯•ä¿¡æ¯
```

**Line 1668-1675**: æ”¶é›†æ¯ä¸ªæ¶ˆæ¯çš„ props ä¿¡æ¯
```javascript
// ğŸ” [DEBUG] æ”¶é›†å®Œæ•´çš„contentå¯¹è±¡ä¿¡æ¯ï¼Œè¿”å›åˆ°Node.js
if (props.type !== undefined) {
  allPropsDebug.push({
    type: props.type,
    serverId: props.serverId,
    isFromMe: props.isFromMe,
    hasContentText: !!msgContent.text,
    contentKeys: Object.keys(msgContent),
    contentPreview: JSON.stringify(msgContent).substring(0, 300)
  });
}
```

**åŸå› **: `console.log` åœ¨ `page.evaluate()` å†…éƒ¨ä¸ä¼šè¾“å‡ºåˆ° Node.jsï¼Œå¿…é¡»è¿”å›æ•°æ®ã€‚

#### æ­¥éª¤2: ä» `page.evaluate()` è¿”å›è°ƒè¯•ä¿¡æ¯

**Line 1869-1875**: ä¿®æ”¹è¿”å›è¯­å¥
```javascript
console.debug(`Successfully extracted ${deduped.length} messages from React Fiber virtual list`);

// ğŸ” è¿”å›è°ƒè¯•ä¿¡æ¯åˆ° Node.js
return {
  messages: deduped,
  debugInfo: debugInfo,
  allPropsDebug: allPropsDebug  // âœ… è¿”å›æ‰€æœ‰æ¶ˆæ¯çš„ props è°ƒè¯•ä¿¡æ¯
};
```

#### æ­¥éª¤3: åœ¨ Node.js ä¸­è¾“å‡ºè°ƒè¯•ä¿¡æ¯

**Line 1418-1432**: æ¥æ”¶å¹¶è¾“å‡º
```javascript
// ç¬¬ 3 æ­¥: æå–å½“å‰æ‰€æœ‰æ¶ˆæ¯
const extractResult = await extractMessagesFromVirtualList(page);
const currentMessages = extractResult.messages;
const currentCount = currentMessages.length;
const currentContentHash = hashMessages(currentMessages);

// ğŸ” è¾“å‡ºè°ƒè¯•ä¿¡æ¯ï¼ˆä»…ç¬¬ä¸€æ¬¡æå–æ—¶ï¼‰
if (attempts === 0 && extractResult.allPropsDebug && extractResult.allPropsDebug.length > 0) {
  logger.info(`ğŸ” [DEBUG] æå–åˆ° ${extractResult.allPropsDebug.length} ä¸ªæ¶ˆæ¯å…ƒç´ çš„ props ä¿¡æ¯:`);
  extractResult.allPropsDebug.forEach((props, index) => {
    logger.info(`ğŸ” [${index + 1}] type=${props.type}, serverId=${props.serverId}, hasContentText=${props.hasContentText}, contentKeys=[${props.contentKeys?.join(', ')}]`);
    if (props.contentPreview) {
      logger.info(`    contentPreview: ${props.contentPreview}`);
    }
  });
}
```

---

## é¢„æœŸè¾“å‡ºç¤ºä¾‹

**åœºæ™¯**: æ‰“å¼€"æè‰³"ä¼šè¯ï¼Œè™šæ‹Ÿåˆ—è¡¨ä¸­æœ‰ 8 ä¸ªæ¶ˆæ¯å…ƒç´ 

```log
[14:45:01.234] [crawlCompleteMessageHistory] Step 0: Waiting for RIGHT-SIDE message panel to load...
[14:45:02.456] [crawlCompleteMessageHistory] âœ… æ‰¾åˆ°å³ä¾§æ¶ˆæ¯å®¹å™¨ .box-content-jSgLQF
[14:45:03.789] ğŸ” [DEBUG] æå–åˆ° 8 ä¸ªæ¶ˆæ¯å…ƒç´ çš„ props ä¿¡æ¯:
[14:45:03.790] ğŸ” [1] type=7, serverId=7568666231667689009, hasContentText=false, contentKeys=[aweType, __typename]
[14:45:03.790]     contentPreview: {"aweType":"unknown","__typename":"DirectMessageContent"}
[14:45:03.791] ğŸ” [2] type=7, serverId=7568666231667689009, hasContentText=false, contentKeys=[aweType, __typename]
[14:45:03.791]     contentPreview: {"aweType":"unknown","__typename":"DirectMessageContent"}
[14:45:03.792] ğŸ” [3] type=7, serverId=7568666231667689009, hasContentText=false, contentKeys=[aweType, __typename]
[14:45:03.792]     contentPreview: {"aweType":"unknown","__typename":"DirectMessageContent"}
...
```

**å…³é”®è¯Šæ–­ç‚¹**:
- âœ… `type=7` ç¡®è®¤æ‰€æœ‰æ¶ˆæ¯éƒ½æ˜¯ç³»ç»Ÿæ¶ˆæ¯ç±»å‹
- âœ… `hasContentText=false` ç¡®è®¤æ²¡æœ‰ text å­—æ®µ
- âœ… `contentKeys=[...]` æ˜¾ç¤º content å¯¹è±¡é‡Œå®é™…æœ‰å“ªäº›å­—æ®µ
- âœ… `contentPreview` æ˜¾ç¤º content çš„å®é™…å†…å®¹ï¼ˆå‰300å­—ç¬¦ï¼‰

---

## ä¸‹ä¸€æ­¥è¯Šæ–­æ–¹å‘

æ ¹æ®è¾“å‡ºç»“æœï¼Œå¯èƒ½çš„è¯Šæ–­æ–¹å‘ï¼š

### æƒ…å†µA: content å¯¹è±¡é‡Œç¡®å®æ²¡æœ‰ text å­—æ®µ

**å¯èƒ½åŸå› **:
- è™šæ‹Ÿåˆ—è¡¨æ¸²æŸ“çš„æ˜¯å ä½ç¬¦ï¼ŒçœŸå®æ¶ˆæ¯éœ€è¦æ»šåŠ¨åŠ è½½
- React Fiber æå–è·¯å¾„é”™è¯¯ï¼Œæå–åˆ°äº†å®¹å™¨è€Œä¸æ˜¯æ¶ˆæ¯æœ¬èº«

**è§£å†³æ–¹æ¡ˆ**:
- å®ç°æ¶ˆæ¯åˆ—è¡¨æ»šåŠ¨åŠ è½½ï¼ˆå‘ä¸Šæ»šåŠ¨åˆ°é¡¶éƒ¨ï¼‰
- æˆ–è°ƒæ•´ React Fiber æœç´¢è·¯å¾„

### æƒ…å†µB: content å¯¹è±¡é‡Œæœ‰éšè—å­—æ®µ

**å¯èƒ½å‘ç°**:
```javascript
contentKeys=[aweType, imageUrl, videoUrl, audioUrl]
```

**è§£å†³æ–¹æ¡ˆ**:
- æ”¯æŒå›¾ç‰‡æ¶ˆæ¯ï¼ˆtype 1ï¼‰
- æ”¯æŒè§†é¢‘æ¶ˆæ¯ï¼ˆtype 2ï¼‰
- æ”¯æŒè¯­éŸ³æ¶ˆæ¯ï¼ˆtype 3ï¼‰

### æƒ…å†µC: æå–çš„ä¸æ˜¯çœŸæ­£çš„æ¶ˆæ¯å…ƒç´ 

**å¯èƒ½å‘ç°**:
```javascript
contentKeys=[placeholder, loading, skeleton]
```

**è§£å†³æ–¹æ¡ˆ**:
- ä¿®æ”¹ DOM é€‰æ‹©å™¨ `.box-content-jSgLQF`
- æœç´¢æ›´æ·±çš„å­å…ƒç´ 
- ä½¿ç”¨ä¸åŒçš„ className

---

## ä»£ç æ”¹åŠ¨æ€»ç»“

### æ”¹åŠ¨æ–‡ä»¶

`packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js`

### æ”¹åŠ¨è¡Œæ•°

- Line 1559-1563: æ·»åŠ  `allPropsDebug` æ•°ç»„å£°æ˜
- Line 1668-1675: æ”¶é›† props è°ƒè¯•ä¿¡æ¯
- Line 1869-1875: è¿”å› `allPropsDebug`
- Line 1418-1432: è¾“å‡ºè°ƒè¯•ä¿¡æ¯åˆ°æ—¥å¿—

**æ€»è®¡**: 4 å¤„æ”¹åŠ¨ï¼Œçº¦ 20 è¡Œæ–°å¢ä»£ç 

---

## éªŒè¯æ­¥éª¤

### æ­¥éª¤1: ç­‰å¾…ä¸‹æ¬¡çˆ¬è™«æ‰§è¡Œ

Worker ä¼šåœ¨ä¸‹ä¸€ä¸ªçˆ¬è™«å‘¨æœŸæ‰§è¡Œæ–°ä»£ç ï¼ˆçº¦ 60 ç§’åï¼‰ã€‚

### æ­¥éª¤2: æŸ¥çœ‹æ—¥å¿—

```bash
tail -f packages/worker/logs/crawl-direct-messages-v2.log
```

### æ­¥éª¤3: æœç´¢è°ƒè¯•è¾“å‡º

```bash
grep "ğŸ” \[DEBUG\]" packages/worker/logs/crawl-direct-messages-v2.log
```

### æ­¥éª¤4: åˆ†æ contentKeys

æ ¹æ® `contentKeys` çš„è¾“å‡ºï¼Œåˆ¤æ–­ï¼š
- å¦‚æœåªæœ‰ `[aweType, __typename]` â†’ å ä½ç¬¦é—®é¢˜
- å¦‚æœæœ‰ `[text, ...]` â†’ æå–é€»è¾‘é—®é¢˜
- å¦‚æœæœ‰ `[imageUrl, videoUrl]` â†’ æ¶ˆæ¯ç±»å‹æ”¯æŒé—®é¢˜

---

## å½±å“èŒƒå›´

### âœ… æ— å‰¯ä½œç”¨

- åªæ·»åŠ è°ƒè¯•è¾“å‡ºï¼Œä¸ä¿®æ”¹æå–é€»è¾‘
- åªåœ¨ç¬¬ä¸€æ¬¡æå–æ—¶è¾“å‡ºï¼ˆ`attempts === 0`ï¼‰
- ä¸å½±å“ç°æœ‰åŠŸèƒ½

### ğŸ“Š æ€§èƒ½å½±å“

- æ¯ä¸ªä¼šè¯å¢åŠ çº¦ 50-200 å­—èŠ‚çš„è°ƒè¯•è¾“å‡º
- `JSON.stringify` å’Œ `substring(0, 300)` å¼€é”€æå°
- å¯¹çˆ¬è™«æ€§èƒ½æ— æ˜æ˜¾å½±å“

---

## ç›¸å…³æ–‡æ¡£

- [ç§ä¿¡æ¶ˆæ¯ä¸º0-æœ€ç»ˆå‘ç°.md](./ç§ä¿¡æ¶ˆæ¯ä¸º0-æœ€ç»ˆå‘ç°.md) - ç”¨æˆ·è§‚å¯Ÿå’Œé—®é¢˜åˆ†æ
- [ç§ä¿¡æ¶ˆæ¯ä¸º0é—®é¢˜-å®Œæ•´çœŸç›¸.md](./ç§ä¿¡æ¶ˆæ¯ä¸º0é—®é¢˜-å®Œæ•´çœŸç›¸.md) - è™šæ‹Ÿåˆ—è¡¨æå–åŸç†
- [å®šæœŸåŒæ­¥æœºåˆ¶åˆ†æ-æ¶ˆæ¯ä¸º0çš„æ ¹æœ¬åŸå› .md](./å®šæœŸåŒæ­¥æœºåˆ¶åˆ†æ-æ¶ˆæ¯ä¸º0çš„æ ¹æœ¬åŸå› .md) - åŒæ­¥æœºåˆ¶éªŒè¯

---

**æŠ¥å‘Šæ—¶é—´**: 2025-11-05 15:00
**ç‰ˆæœ¬**: v1.0 - è°ƒè¯•æ—¥å¿—å®ç°å®Œæˆ
**çŠ¶æ€**: âœ… å·²å®Œæˆï¼Œç­‰å¾…ä¸‹æ¬¡çˆ¬è™«æ‰§è¡ŒéªŒè¯
**é¢„è®¡ç”Ÿæ•ˆæ—¶é—´**: ä¸‹ä¸€ä¸ªçˆ¬è™«å‘¨æœŸï¼ˆçº¦ 60 ç§’åï¼‰
