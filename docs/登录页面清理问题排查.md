# 登录页面清理问题排查

## 问题描述

登录成功后，登录 Tab 没有关闭，导致浏览器中有两个"抖音创作者中心"标签页。

## 预期行为

登录成功后，应该只保留一个标签页（PLACEHOLDER Tab，用于后续的登录检测和监控），登录时创建的临时页面应该被关闭。

## 原因分析

### 系统中的两个页面

1. **PLACEHOLDER Tab**（账户初始化时创建）
   - 位置：`packages/worker/src/handlers/account-initializer.js`
   - 创建时机：账户初始化时
   - 用途：登录检测和日常监控
   - URL：创作中心首页
   - 生命周期：持久化，不应关闭

2. **Login Page**（登录时创建）
   - 位置：`packages/worker/src/platforms/douyin/login-handler.js`
   - 创建时机：开始登录流程时
   - 用途：显示二维码和登录表单
   - URL：抖音首页 → 创作中心（登录检测时导航）
   - 生命周期：临时，登录成功后应关闭

### 页面创建流程

#### 1. 账户初始化
```javascript
// packages/worker/src/handlers/account-initializer.js
async loadPlatformHomepage(context, account) {
  const defaultPage = await this.browserManager.getSpiderPage(account.id, 'spider1');
  await defaultPage.goto(creatorCenterUrl, { ... });

  // 注册为 PLACEHOLDER Tab
  await this.browserManager.tabManager.registerExistingPage(
    account.id,
    defaultPage,
    TabTag.PLACEHOLDER,
    true  // persistent
  );
}
```

#### 2. 登录流程
```javascript
// packages/worker/src/platforms/douyin/login-handler.js
async startLogin(accountId, sessionId, proxyConfig) {
  // 创建登录页面
  page = await this.browserManager.newPage(accountId, {});
  session.page = page;

  // 导航到抖音首页
  await page.goto(this.DOUYIN_HOME, { ... });

  // 提取二维码
  await this.extractQRCode(page, accountId, sessionId);

  // 轮询登录状态
  this.startLoginStatusPolling(accountId, sessionId);
}
```

#### 3. 登录状态检测
```javascript
async checkLoginStatus(page) {
  // 如果不在创作中心，导航过去
  if (!currentUrl.includes('creator.douyin.com')) {
    await page.goto('https://creator.douyin.com/', { ... });
  }

  // 检查用户信息元素
  return await this._checkUserInfoElements(page);
}
```

#### 4. 登录成功清理
```javascript
async handleLoginSuccess(accountId, sessionId) {
  // 保存登录状态
  await this.browserManager.saveStorageState(accountId);

  // 通知 Master
  this.notifyLoginSuccess(accountId, sessionId, cookies, cookiesValidUntil);

  // ✅ 关闭登录页面
  await this.cleanupSession(accountId, false);
}
```

## 修复方案

### 修改内容

#### 1. 增强日志（已完成）

在 `handleLoginSuccess` 方法中添加了详细的日志：

```javascript
// 记录清理前的页面数量
const context = session.page.context();
const pages = context.pages();
logger.info(`Before cleanup: ${pages.length} pages open in context`);
pages.forEach((p, index) => {
  logger.info(`  Page ${index + 1}: ${p.url()} (closed: ${p.isClosed()})`);
});

await this.cleanupSession(accountId, false);

// 记录清理后的页面数量
const pages = context.pages();
logger.info(`After cleanup: ${pages.length} pages open in context`);
```

#### 2. 增强 cleanupSession（已完成）

添加了 try-catch 和详细的日志：

```javascript
async cleanupSession(accountId, closeContext = true) {
  // ✅ 关闭登录页面（确保正确关闭）
  if (session.page && !session.page.isClosed()) {
    try {
      logger.info(`Closing login page for account ${accountId}`);
      await session.page.close();
      logger.info(`✓ Login page closed for account ${accountId}`);
    } catch (closeError) {
      logger.warn(`Failed to close login page: ${closeError.message}`);
    }
  }
}
```

## 日志输出示例

### 正常情况（登录页面成功关闭）

```
[douyin-login] ✅ Login successful for account acc_123, session sess_456
[douyin-login] Cleaning up login session for account acc_123...
[douyin-login] Before cleanup: 2 pages open in context
[douyin-login]   Page 1: https://creator.douyin.com/creator-micro/home (closed: false)
[douyin-login]   Page 2: https://creator.douyin.com/creator-micro/home (closed: false)
[douyin-login] Closing login page for account acc_123
[douyin-login] ✓ Login page closed for account acc_123
[douyin-login] Session cleaned up for account acc_123
[douyin-login] After cleanup: 1 pages open in context
[douyin-login]   Page 1: https://creator.douyin.com/creator-micro/home (closed: false)
[douyin-login] ✓ Login session cleaned up for account acc_123
```

### 异常情况（登录页面关闭失败）

```
[douyin-login] ✅ Login successful for account acc_123, session sess_456
[douyin-login] Cleaning up login session for account acc_123...
[douyin-login] Before cleanup: 2 pages open in context
[douyin-login]   Page 1: https://creator.douyin.com/creator-micro/home (closed: false)
[douyin-login]   Page 2: https://creator.douyin.com/creator-micro/home (closed: false)
[douyin-login] Closing login page for account acc_123
[douyin-login] Failed to close login page: Page has been closed
[douyin-login] Session cleaned up for account acc_123
[douyin-login] After cleanup: 2 pages open in context
[douyin-login]   Page 1: https://creator.douyin.com/creator-micro/home (closed: false)
[douyin-login]   Page 2: https://creator.douyin.com/creator-micro/home (closed: false)
```

## 测试步骤

### 1. 启动 Worker
```bash
cd packages/worker
npm start
```

### 2. 触发登录
通过 Admin Web 或 Master API 发起账号登录请求。

### 3. 扫码登录
使用手机扫描二维码完成登录。

### 4. 查看日志
观察 Worker 日志中的输出：

```bash
# 查找登录成功的日志
grep "Login successful" packages/worker/logs/*.log

# 查看页面清理的详细日志
grep -A 10 "Before cleanup" packages/worker/logs/*.log
```

### 5. 验证结果
在浏览器中检查：
- 应该只有 1 个标签页（创作中心）
- 登录页面应该已关闭

## 可能的问题和解决方案

### 问题 1：page.close() 失败

**症状**：日志显示"Failed to close login page"

**原因**：
- 页面已经被关闭
- 浏览器上下文已断开

**解决方案**：
代码已经添加了 try-catch，会记录错误但不影响流程。

### 问题 2：页面没有被关闭

**症状**：
- 清理前：2 个页面
- 清理后：2 个页面（没有减少）

**可能原因**：
1. session.page 不是预期的那个页面
2. 有其他代码在创建额外的页面

**调试方法**：
检查日志中的页面 URL，确认哪个是登录页面。

### 问题 3：session.page 是 null

**症状**：日志显示跳过了页面关闭步骤

**原因**：session 对象中没有 page 属性

**解决方案**：
检查登录流程，确认 session.page 被正确赋值。

## 进一步的优化（待实现）

如果日志显示页面没有被正确关闭，可以考虑以下增强方案：

### 方案 A：强制关闭所有非 PLACEHOLDER 页面

```javascript
async cleanupSession(accountId, closeContext = true) {
  // ... 现有代码 ...

  // ✅ 额外保险：关闭所有非 PLACEHOLDER 的页面
  try {
    const context = await this.browserManager.getContext(accountId);
    if (context) {
      const pages = context.pages();

      for (const page of pages) {
        // 检查这个页面是否是 PLACEHOLDER Tab
        const isPlaceholder = await this.browserManager.tabManager.isPlaceholderTab(accountId, page);

        if (!isPlaceholder && !page.isClosed()) {
          logger.info(`Closing extra page: ${page.url()}`);
          await page.close();
        }
      }
    }
  } catch (error) {
    logger.warn('Error closing extra pages:', error);
  }
}
```

### 方案 B：使用 TabManager 注册登录页面

在创建登录页面时，通过 TabManager 注册并标记为 `TabTag.LOGIN`，这样可以更容易地跟踪和关闭：

```javascript
async startLogin(accountId, sessionId, proxyConfig) {
  page = await this.browserManager.newPage(accountId, {});

  // ✅ 注册为 LOGIN Tab
  const { tabId } = await this.browserManager.tabManager.registerExistingPage(
    accountId,
    page,
    TabTag.LOGIN,
    false  // 非持久化
  );

  session.page = page;
  session.tabId = tabId;
}

async cleanupSession(accountId, closeContext = true) {
  // ✅ 通过 TabManager 关闭
  if (session.tabId) {
    await this.browserManager.tabManager.closeTab(accountId, session.tabId);
  }
}
```

## 相关文件

- `packages/worker/src/platforms/douyin/login-handler.js` - 登录处理器
- `packages/worker/src/handlers/account-initializer.js` - 账户初始化
- `packages/worker/src/browser/tab-manager.js` - Tab 管理器
- `packages/worker/src/handlers/login-detection-task.js` - 登录检测任务

## 下一步

1. 运行测试并收集日志
2. 根据日志分析是否成功关闭登录页面
3. 如果问题仍然存在，考虑实施方案 A 或 B
