# 数据库重建指南

**日期**: 2025-10-27
**目的**: 清理数据库迁移历史，使用最终 schema 作为初始版本

---

## 📋 背景

在开发过程中，数据库经历了多次迁移（`works` → `contents`、字段重命名等）。为了简化未来的维护：

1. ✅ 删除所有迁移脚本
2. ✅ 使用最终 schema (v1.0) 作为初始版本
3. ✅ 从备份中恢复核心配置数据

---

## 🔧 准备工作

### 1. 关闭所有数据库连接

在执行重建前，必须关闭所有占用数据库的进程：

```bash
# 停止 Master 服务器
Ctrl+C (如果正在运行)

# 停止 Worker 进程
Ctrl+C (如果正在运行)

# 停止所有测试脚本
Ctrl+C (如果正在运行)

# 检查并关闭所有 Node 进程
tasklist | grep node
# 如有必要，关闭特定进程
taskkill /F /PID <进程ID>
```

### 2. 确认备份存在

重建脚本会从以下备份文件恢复配置：

```
packages/master/data/master.db.config_backup_20251027
```

该备份包含：
- ✅ 1 个账户配置 (accounts)
- ✅ 1 个 Worker 配置 (workers)
- ✅ 1 个代理配置 (proxies)

---

## 🚀 执行重建

### 方式 1: 使用一键重建脚本（推荐）

```bash
# 在项目根目录执行
node scripts/rebuild-database.js
```

该脚本会自动：
1. 删除旧数据库文件 (`master.db`, `master.db-shm`, `master.db-wal`)
2. 使用 `init.js` 创建新数据库（基于 `schema.sql`）
3. 从备份迁移配置数据 (accounts, workers, proxies)
4. 验证数据库结构和数据

**输出示例**:
```
======================================
🔧 数据库重建工具
======================================

✅ 找到备份数据库: .../master.db.config_backup_20251027

📝 Step 1: 删除旧数据库文件...
   ✅ 删除: master.db
   ✅ 删除: master.db-shm
   ✅ 删除: master.db-wal
   删除了 3 个文件

📝 Step 2: 创建新数据库...
   ✅ 新数据库创建成功

📝 Step 3: 迁移配置数据...

备份数据统计:
  accounts: 1 条
  workers: 1 条
  proxies: 1 条

📝 迁移 accounts 表...
   ✅ 迁移了 1 个账户

📝 迁移 workers 表...
   ✅ 迁移了 1 个 Worker

📝 迁移 proxies 表...
   ✅ 迁移了 1 个代理配置

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 迁移完成！共迁移 3 条配置数据
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📝 Step 4: 验证新数据库...

✅ 数据库表列表 (共 16 个):
   - accounts
   - client_sessions
   - comments
   - contents
   - conversations
   - direct_messages
   - discussions
   - login_sessions
   - notification_rules
   - notifications
   - proxies
   - replies
   - worker_configs
   - worker_logs
   - worker_runtime
   - workers

✅ 数据统计:
   accounts: 1 条
   workers: 1 条
   proxies: 1 条
   comments: 0 条
   contents: 0 条
   direct_messages: 0 条

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 数据库重建完成！
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📌 说明:
   - 新数据库使用最终 schema (v1.0)
   - 已迁移核心配置数据 (accounts, workers, proxies)
   - 业务数据表已清空 (comments, contents, direct_messages 等)
   - 现在可以启动 Master 和 Worker 开始爬取数据
```

### 方式 2: 手动步骤

如果一键脚本失败，可以手动执行：

#### 步骤 1: 删除旧数据库

```bash
cd packages/master/data
rm master.db master.db-shm master.db-wal
```

#### 步骤 2: 创建新数据库

```bash
cd packages/master
node -e "const { initDatabase } = require('./src/database/init'); initDatabase('./data/master.db').close();"
```

#### 步骤 3: 迁移配置数据

```bash
cd ../../scripts
node migrate-config-from-backup.js
```

---

## ✅ 验证结果

### 1. 检查表结构

```bash
cd packages/master
node -e "
const db = require('better-sqlite3')('data/master.db');
const tables = db.prepare(\"SELECT name FROM sqlite_master WHERE type='table' ORDER BY name\").all();
console.log('数据库表列表:');
tables.forEach(t => console.log('  -', t.name));
db.close();
"
```

**预期输出** (16 个表):
```
- accounts
- client_sessions
- comments
- contents          ← 新表名（原 works）
- conversations
- direct_messages
- discussions
- login_sessions
- notification_rules
- notifications
- proxies
- replies
- worker_configs
- worker_logs
- worker_runtime
- workers
```

### 2. 检查配置数据

```bash
node tests/check-data-count.js
```

**预期输出**:
```
📊 数据库表数据统计:

  contents: 0 条       ← 业务数据已清空
  comments: 0 条
  discussions: 0 条
  direct_messages: 0 条
  conversations: 0 条
  accounts: 1 条       ← 配置数据已恢复
```

### 3. 检查 accounts 字段

```bash
cd packages/master
node -e "
const db = require('better-sqlite3')('data/master.db');
const acc = db.prepare('SELECT id, platform, account_name, total_contents, recent_contents_count FROM accounts LIMIT 1').get();
console.log('账户配置:');
console.log('  ID:', acc.id);
console.log('  平台:', acc.platform);
console.log('  账户名:', acc.account_name);
console.log('  total_contents:', acc.total_contents);
console.log('  recent_contents_count:', acc.recent_contents_count);
db.close();
"
```

---

## 🎯 重建后的工作流程

### 1. 启动 Master 服务器

```bash
cd packages/master
npm start
```

### 2. 启动 Worker 进程

```bash
cd packages/worker
npm start
```

### 3. 开始爬取数据

Worker 会自动开始监控和爬取数据，数据将填充到：
- `contents` - 作品数据
- `comments` - 评论数据
- `discussions` - 讨论数据
- `direct_messages` - 私信数据
- `conversations` - 会话数据

---

## 📊 数据库架构说明

### 最终 Schema (v1.0)

**核心配置表** (已恢复数据):
- `accounts` - 社交媒体账户配置
  - 新字段: `total_contents`, `recent_contents_count`
- `workers` - Worker 进程配置
- `proxies` - 代理配置

**业务数据表** (已清空):
- `contents` - 作品数据 (原 `works`)
  - 新字段: `platform_content_id`, `content_type`, `stats_*`
- `comments` - 评论数据
- `discussions` - 讨论数据
  - 外键: `content_id` (原 `work_id`)
- `direct_messages` - 私信数据
- `conversations` - 会话数据

**系统表**:
- `worker_configs` - Worker 配置
- `worker_runtime` - Worker 运行时状态
- `worker_logs` - Worker 日志
- `login_sessions` - 登录会话
- `replies` - 回复任务
- `notifications` - 通知队列
- `notification_rules` - 通知规则
- `client_sessions` - 客户端会话

### 关键变更

| 原字段/表名 | 新字段/表名 | 说明 |
|------------|------------|------|
| `works` | `contents` | 表名更通用 |
| `platform_work_id` | `platform_content_id` | 字段语义化 |
| `work_type` | `content_type` | 内容类型 |
| `total_comment_count` | `stats_comment_count` | 添加 stats_ 前缀 |
| `like_count` | `stats_like_count` | 统计字段规范化 |
| `accounts.total_works` | `accounts.total_contents` | 账户统计字段 |
| `discussions.work_id` | `discussions.content_id` | 外键更新 |

---

## 🔍 故障排除

### 问题 1: 数据库文件被占用

**错误信息**:
```
rm: cannot remove 'master.db': Device or resource busy
```

**解决方案**:
1. 关闭所有 Node 进程
2. 检查是否有测试脚本或开发工具占用
3. 重启终端
4. 如有必要，重启计算机

### 问题 2: 备份文件不存在

**错误信息**:
```
❌ 备份数据库不存在: .../master.db.config_backup_20251027
```

**解决方案**:
1. 检查 `packages/master/data/` 目录
2. 使用其他备份文件（修改脚本中的路径）
3. 如无备份，重建后手动配置账户

### 问题 3: 字段不匹配

**错误信息**:
```
no such column: total_works
```

**解决方案**:
- 确保代码已更新到最新版本
- 检查是否有残留的旧代码引用
- 运行 `git status` 确认所有变更已提交

---

## 📁 相关文件

### 脚本文件
- `scripts/rebuild-database.js` - 一键重建脚本（推荐）
- `scripts/migrate-config-from-backup.js` - 配置数据迁移脚本
- `packages/master/src/database/init.js` - 数据库初始化

### Schema 文件
- `packages/master/src/database/schema.sql` - 最终 schema (v1.0)

### 备份文件
- `packages/master/data/master.db.config_backup_20251027` - 配置备份

### 测试脚本
- `tests/check-data-count.js` - 数据统计检查

---

## 📝 后续维护

### Schema 修改流程

未来如需修改数据库 schema：

1. **直接修改** `schema.sql` 文件
2. **更新** 对应的 DAO 文件
3. **运行验证** `schema-validator.js`
4. **删除旧库重建**（开发环境）或**编写迁移脚本**（生产环境）

### 无需迁移脚本的原因

- ✅ 开发阶段，数据可随时清空重建
- ✅ schema.sql 代表当前最终状态
- ✅ 简化维护，避免迁移历史复杂化
- ⚠️ 生产环境部署时需要考虑数据迁移策略

---

**最后更新**: 2025-10-27
**Schema 版本**: v1.0
**状态**: ✅ 重建流程已验证
