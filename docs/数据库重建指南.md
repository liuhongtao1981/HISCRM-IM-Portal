# æ•°æ®åº“é‡å»ºæŒ‡å—

**æ—¥æœŸ**: 2025-10-27
**ç›®çš„**: æ¸…ç†æ•°æ®åº“è¿ç§»å†å²ï¼Œä½¿ç”¨æœ€ç»ˆ schema ä½œä¸ºåˆå§‹ç‰ˆæœ¬

---

## ğŸ“‹ èƒŒæ™¯

åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæ•°æ®åº“ç»å†äº†å¤šæ¬¡è¿ç§»ï¼ˆ`works` â†’ `contents`ã€å­—æ®µé‡å‘½åç­‰ï¼‰ã€‚ä¸ºäº†ç®€åŒ–æœªæ¥çš„ç»´æŠ¤ï¼š

1. âœ… åˆ é™¤æ‰€æœ‰è¿ç§»è„šæœ¬
2. âœ… ä½¿ç”¨æœ€ç»ˆ schema (v1.0) ä½œä¸ºåˆå§‹ç‰ˆæœ¬
3. âœ… ä»å¤‡ä»½ä¸­æ¢å¤æ ¸å¿ƒé…ç½®æ•°æ®

---

## ğŸ”§ å‡†å¤‡å·¥ä½œ

### 1. å…³é—­æ‰€æœ‰æ•°æ®åº“è¿æ¥

åœ¨æ‰§è¡Œé‡å»ºå‰ï¼Œå¿…é¡»å…³é—­æ‰€æœ‰å ç”¨æ•°æ®åº“çš„è¿›ç¨‹ï¼š

```bash
# åœæ­¢ Master æœåŠ¡å™¨
Ctrl+C (å¦‚æœæ­£åœ¨è¿è¡Œ)

# åœæ­¢ Worker è¿›ç¨‹
Ctrl+C (å¦‚æœæ­£åœ¨è¿è¡Œ)

# åœæ­¢æ‰€æœ‰æµ‹è¯•è„šæœ¬
Ctrl+C (å¦‚æœæ­£åœ¨è¿è¡Œ)

# æ£€æŸ¥å¹¶å…³é—­æ‰€æœ‰ Node è¿›ç¨‹
tasklist | grep node
# å¦‚æœ‰å¿…è¦ï¼Œå…³é—­ç‰¹å®šè¿›ç¨‹
taskkill /F /PID <è¿›ç¨‹ID>
```

### 2. ç¡®è®¤å¤‡ä»½å­˜åœ¨

é‡å»ºè„šæœ¬ä¼šä»ä»¥ä¸‹å¤‡ä»½æ–‡ä»¶æ¢å¤é…ç½®ï¼š

```
packages/master/data/master.db.config_backup_20251027
```

è¯¥å¤‡ä»½åŒ…å«ï¼š
- âœ… 1 ä¸ªè´¦æˆ·é…ç½® (accounts)
- âœ… 1 ä¸ª Worker é…ç½® (workers)
- âœ… 1 ä¸ªä»£ç†é…ç½® (proxies)

---

## ğŸš€ æ‰§è¡Œé‡å»º

### æ–¹å¼ 1: ä½¿ç”¨ä¸€é”®é‡å»ºè„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
node scripts/rebuild-database.js
```

è¯¥è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
1. åˆ é™¤æ—§æ•°æ®åº“æ–‡ä»¶ (`master.db`, `master.db-shm`, `master.db-wal`)
2. ä½¿ç”¨ `init.js` åˆ›å»ºæ–°æ•°æ®åº“ï¼ˆåŸºäº `schema.sql`ï¼‰
3. ä»å¤‡ä»½è¿ç§»é…ç½®æ•°æ® (accounts, workers, proxies)
4. éªŒè¯æ•°æ®åº“ç»“æ„å’Œæ•°æ®

**è¾“å‡ºç¤ºä¾‹**:
```
======================================
ğŸ”§ æ•°æ®åº“é‡å»ºå·¥å…·
======================================

âœ… æ‰¾åˆ°å¤‡ä»½æ•°æ®åº“: .../master.db.config_backup_20251027

ğŸ“ Step 1: åˆ é™¤æ—§æ•°æ®åº“æ–‡ä»¶...
   âœ… åˆ é™¤: master.db
   âœ… åˆ é™¤: master.db-shm
   âœ… åˆ é™¤: master.db-wal
   åˆ é™¤äº† 3 ä¸ªæ–‡ä»¶

ğŸ“ Step 2: åˆ›å»ºæ–°æ•°æ®åº“...
   âœ… æ–°æ•°æ®åº“åˆ›å»ºæˆåŠŸ

ğŸ“ Step 3: è¿ç§»é…ç½®æ•°æ®...

å¤‡ä»½æ•°æ®ç»Ÿè®¡:
  accounts: 1 æ¡
  workers: 1 æ¡
  proxies: 1 æ¡

ğŸ“ è¿ç§» accounts è¡¨...
   âœ… è¿ç§»äº† 1 ä¸ªè´¦æˆ·

ğŸ“ è¿ç§» workers è¡¨...
   âœ… è¿ç§»äº† 1 ä¸ª Worker

ğŸ“ è¿ç§» proxies è¡¨...
   âœ… è¿ç§»äº† 1 ä¸ªä»£ç†é…ç½®

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… è¿ç§»å®Œæˆï¼å…±è¿ç§» 3 æ¡é…ç½®æ•°æ®
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ Step 4: éªŒè¯æ–°æ•°æ®åº“...

âœ… æ•°æ®åº“è¡¨åˆ—è¡¨ (å…± 16 ä¸ª):
   - accounts
   - client_sessions
   - comments
   - contents
   - conversations
   - direct_messages
   - discussions
   - login_sessions
   - notification_rules
   - notifications
   - proxies
   - replies
   - worker_configs
   - worker_logs
   - worker_runtime
   - workers

âœ… æ•°æ®ç»Ÿè®¡:
   accounts: 1 æ¡
   workers: 1 æ¡
   proxies: 1 æ¡
   comments: 0 æ¡
   contents: 0 æ¡
   direct_messages: 0 æ¡

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… æ•°æ®åº“é‡å»ºå®Œæˆï¼
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Œ è¯´æ˜:
   - æ–°æ•°æ®åº“ä½¿ç”¨æœ€ç»ˆ schema (v1.0)
   - å·²è¿ç§»æ ¸å¿ƒé…ç½®æ•°æ® (accounts, workers, proxies)
   - ä¸šåŠ¡æ•°æ®è¡¨å·²æ¸…ç©º (comments, contents, direct_messages ç­‰)
   - ç°åœ¨å¯ä»¥å¯åŠ¨ Master å’Œ Worker å¼€å§‹çˆ¬å–æ•°æ®
```

### æ–¹å¼ 2: æ‰‹åŠ¨æ­¥éª¤

å¦‚æœä¸€é”®è„šæœ¬å¤±è´¥ï¼Œå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œï¼š

#### æ­¥éª¤ 1: åˆ é™¤æ—§æ•°æ®åº“

```bash
cd packages/master/data
rm master.db master.db-shm master.db-wal
```

#### æ­¥éª¤ 2: åˆ›å»ºæ–°æ•°æ®åº“

```bash
cd packages/master
node -e "const { initDatabase } = require('./src/database/init'); initDatabase('./data/master.db').close();"
```

#### æ­¥éª¤ 3: è¿ç§»é…ç½®æ•°æ®

```bash
cd ../../scripts
node migrate-config-from-backup.js
```

---

## âœ… éªŒè¯ç»“æœ

### 1. æ£€æŸ¥è¡¨ç»“æ„

```bash
cd packages/master
node -e "
const db = require('better-sqlite3')('data/master.db');
const tables = db.prepare(\"SELECT name FROM sqlite_master WHERE type='table' ORDER BY name\").all();
console.log('æ•°æ®åº“è¡¨åˆ—è¡¨:');
tables.forEach(t => console.log('  -', t.name));
db.close();
"
```

**é¢„æœŸè¾“å‡º** (16 ä¸ªè¡¨):
```
- accounts
- client_sessions
- comments
- contents          â† æ–°è¡¨åï¼ˆåŸ worksï¼‰
- conversations
- direct_messages
- discussions
- login_sessions
- notification_rules
- notifications
- proxies
- replies
- worker_configs
- worker_logs
- worker_runtime
- workers
```

### 2. æ£€æŸ¥é…ç½®æ•°æ®

```bash
node tests/check-data-count.js
```

**é¢„æœŸè¾“å‡º**:
```
ğŸ“Š æ•°æ®åº“è¡¨æ•°æ®ç»Ÿè®¡:

  contents: 0 æ¡       â† ä¸šåŠ¡æ•°æ®å·²æ¸…ç©º
  comments: 0 æ¡
  discussions: 0 æ¡
  direct_messages: 0 æ¡
  conversations: 0 æ¡
  accounts: 1 æ¡       â† é…ç½®æ•°æ®å·²æ¢å¤
```

### 3. æ£€æŸ¥ accounts å­—æ®µ

```bash
cd packages/master
node -e "
const db = require('better-sqlite3')('data/master.db');
const acc = db.prepare('SELECT id, platform, account_name, total_contents, recent_contents_count FROM accounts LIMIT 1').get();
console.log('è´¦æˆ·é…ç½®:');
console.log('  ID:', acc.id);
console.log('  å¹³å°:', acc.platform);
console.log('  è´¦æˆ·å:', acc.account_name);
console.log('  total_contents:', acc.total_contents);
console.log('  recent_contents_count:', acc.recent_contents_count);
db.close();
"
```

---

## ğŸ¯ é‡å»ºåçš„å·¥ä½œæµç¨‹

### 1. å¯åŠ¨ Master æœåŠ¡å™¨

```bash
cd packages/master
npm start
```

### 2. å¯åŠ¨ Worker è¿›ç¨‹

```bash
cd packages/worker
npm start
```

### 3. å¼€å§‹çˆ¬å–æ•°æ®

Worker ä¼šè‡ªåŠ¨å¼€å§‹ç›‘æ§å’Œçˆ¬å–æ•°æ®ï¼Œæ•°æ®å°†å¡«å……åˆ°ï¼š
- `contents` - ä½œå“æ•°æ®
- `comments` - è¯„è®ºæ•°æ®
- `discussions` - è®¨è®ºæ•°æ®
- `direct_messages` - ç§ä¿¡æ•°æ®
- `conversations` - ä¼šè¯æ•°æ®

---

## ğŸ“Š æ•°æ®åº“æ¶æ„è¯´æ˜

### æœ€ç»ˆ Schema (v1.0)

**æ ¸å¿ƒé…ç½®è¡¨** (å·²æ¢å¤æ•°æ®):
- `accounts` - ç¤¾äº¤åª’ä½“è´¦æˆ·é…ç½®
  - æ–°å­—æ®µ: `total_contents`, `recent_contents_count`
- `workers` - Worker è¿›ç¨‹é…ç½®
- `proxies` - ä»£ç†é…ç½®

**ä¸šåŠ¡æ•°æ®è¡¨** (å·²æ¸…ç©º):
- `contents` - ä½œå“æ•°æ® (åŸ `works`)
  - æ–°å­—æ®µ: `platform_content_id`, `content_type`, `stats_*`
- `comments` - è¯„è®ºæ•°æ®
- `discussions` - è®¨è®ºæ•°æ®
  - å¤–é”®: `content_id` (åŸ `work_id`)
- `direct_messages` - ç§ä¿¡æ•°æ®
- `conversations` - ä¼šè¯æ•°æ®

**ç³»ç»Ÿè¡¨**:
- `worker_configs` - Worker é…ç½®
- `worker_runtime` - Worker è¿è¡Œæ—¶çŠ¶æ€
- `worker_logs` - Worker æ—¥å¿—
- `login_sessions` - ç™»å½•ä¼šè¯
- `replies` - å›å¤ä»»åŠ¡
- `notifications` - é€šçŸ¥é˜Ÿåˆ—
- `notification_rules` - é€šçŸ¥è§„åˆ™
- `client_sessions` - å®¢æˆ·ç«¯ä¼šè¯

### å…³é”®å˜æ›´

| åŸå­—æ®µ/è¡¨å | æ–°å­—æ®µ/è¡¨å | è¯´æ˜ |
|------------|------------|------|
| `works` | `contents` | è¡¨åæ›´é€šç”¨ |
| `platform_work_id` | `platform_content_id` | å­—æ®µè¯­ä¹‰åŒ– |
| `work_type` | `content_type` | å†…å®¹ç±»å‹ |
| `total_comment_count` | `stats_comment_count` | æ·»åŠ  stats_ å‰ç¼€ |
| `like_count` | `stats_like_count` | ç»Ÿè®¡å­—æ®µè§„èŒƒåŒ– |
| `accounts.total_works` | `accounts.total_contents` | è´¦æˆ·ç»Ÿè®¡å­—æ®µ |
| `discussions.work_id` | `discussions.content_id` | å¤–é”®æ›´æ–° |

---

## ğŸ” æ•…éšœæ’é™¤

### é—®é¢˜ 1: æ•°æ®åº“æ–‡ä»¶è¢«å ç”¨

**é”™è¯¯ä¿¡æ¯**:
```
rm: cannot remove 'master.db': Device or resource busy
```

**è§£å†³æ–¹æ¡ˆ**:
1. å…³é—­æ‰€æœ‰ Node è¿›ç¨‹
2. æ£€æŸ¥æ˜¯å¦æœ‰æµ‹è¯•è„šæœ¬æˆ–å¼€å‘å·¥å…·å ç”¨
3. é‡å¯ç»ˆç«¯
4. å¦‚æœ‰å¿…è¦ï¼Œé‡å¯è®¡ç®—æœº

### é—®é¢˜ 2: å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨

**é”™è¯¯ä¿¡æ¯**:
```
âŒ å¤‡ä»½æ•°æ®åº“ä¸å­˜åœ¨: .../master.db.config_backup_20251027
```

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ `packages/master/data/` ç›®å½•
2. ä½¿ç”¨å…¶ä»–å¤‡ä»½æ–‡ä»¶ï¼ˆä¿®æ”¹è„šæœ¬ä¸­çš„è·¯å¾„ï¼‰
3. å¦‚æ— å¤‡ä»½ï¼Œé‡å»ºåæ‰‹åŠ¨é…ç½®è´¦æˆ·

### é—®é¢˜ 3: å­—æ®µä¸åŒ¹é…

**é”™è¯¯ä¿¡æ¯**:
```
no such column: total_works
```

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®ä¿ä»£ç å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
- æ£€æŸ¥æ˜¯å¦æœ‰æ®‹ç•™çš„æ—§ä»£ç å¼•ç”¨
- è¿è¡Œ `git status` ç¡®è®¤æ‰€æœ‰å˜æ›´å·²æäº¤

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

### è„šæœ¬æ–‡ä»¶
- `scripts/rebuild-database.js` - ä¸€é”®é‡å»ºè„šæœ¬ï¼ˆæ¨èï¼‰
- `scripts/migrate-config-from-backup.js` - é…ç½®æ•°æ®è¿ç§»è„šæœ¬
- `packages/master/src/database/init.js` - æ•°æ®åº“åˆå§‹åŒ–

### Schema æ–‡ä»¶
- `packages/master/src/database/schema.sql` - æœ€ç»ˆ schema (v1.0)

### å¤‡ä»½æ–‡ä»¶
- `packages/master/data/master.db.config_backup_20251027` - é…ç½®å¤‡ä»½

### æµ‹è¯•è„šæœ¬
- `tests/check-data-count.js` - æ•°æ®ç»Ÿè®¡æ£€æŸ¥

---

## ğŸ“ åç»­ç»´æŠ¤

### Schema ä¿®æ”¹æµç¨‹

æœªæ¥å¦‚éœ€ä¿®æ”¹æ•°æ®åº“ schemaï¼š

1. **ç›´æ¥ä¿®æ”¹** `schema.sql` æ–‡ä»¶
2. **æ›´æ–°** å¯¹åº”çš„ DAO æ–‡ä»¶
3. **è¿è¡ŒéªŒè¯** `schema-validator.js`
4. **åˆ é™¤æ—§åº“é‡å»º**ï¼ˆå¼€å‘ç¯å¢ƒï¼‰æˆ–**ç¼–å†™è¿ç§»è„šæœ¬**ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

### æ— éœ€è¿ç§»è„šæœ¬çš„åŸå› 

- âœ… å¼€å‘é˜¶æ®µï¼Œæ•°æ®å¯éšæ—¶æ¸…ç©ºé‡å»º
- âœ… schema.sql ä»£è¡¨å½“å‰æœ€ç»ˆçŠ¶æ€
- âœ… ç®€åŒ–ç»´æŠ¤ï¼Œé¿å…è¿ç§»å†å²å¤æ‚åŒ–
- âš ï¸ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ—¶éœ€è¦è€ƒè™‘æ•°æ®è¿ç§»ç­–ç•¥

---

**æœ€åæ›´æ–°**: 2025-10-27
**Schema ç‰ˆæœ¬**: v1.0
**çŠ¶æ€**: âœ… é‡å»ºæµç¨‹å·²éªŒè¯
