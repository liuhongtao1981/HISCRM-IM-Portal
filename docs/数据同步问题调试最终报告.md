# Worker æ•°æ®åŒæ­¥é—®é¢˜è°ƒè¯•æœ€ç»ˆæŠ¥å‘Š

**è°ƒè¯•æ—¶é—´**: 2025-10-30 15:40 - 15:48
**é—®é¢˜çŠ¶æ€**: âœ… **å·²æ‰¾åˆ°æ ¹æœ¬åŸå› ** - MessageTypes å¯¼å‡ºé—®é¢˜
**è§£å†³æ–¹æ¡ˆ**: âœ… **å·²ä¿®å¤** - æ·»åŠ  MessageTypes å¯¼å‡º
**æµ‹è¯•ç»“æœ**: âš ï¸ **éƒ¨åˆ†é€šè¿‡** - å•å…ƒæµ‹è¯•é€šè¿‡ï¼Œå®é™… Worker éœ€è¦é‡æ–°åŠ è½½æ¨¡å—

---

## é—®é¢˜ç—‡çŠ¶

Worker çš„æ•°æ®åŒæ­¥å®šæ—¶å™¨æ²¡æœ‰æˆåŠŸæ¨é€æ•°æ®åˆ° Master DataStoreï¼š
- Worker å¯åŠ¨æ­£å¸¸
- DouyinDataManager åˆ›å»ºæˆåŠŸ
- å®šæ—¶å™¨å¯åŠ¨æˆåŠŸ
- Master DataStore å§‹ç»ˆä¸ºç©ºï¼ˆ0 ä¸ªè´¦æˆ·ï¼Œ0 æ¡æ•°æ®ï¼‰
- Master æ²¡æœ‰æ”¶åˆ°ä»»ä½• `WORKER_DATA_SYNC` æ¶ˆæ¯

---

## è°ƒè¯•è¿‡ç¨‹

### æ­¥éª¤ 1: æ·»åŠ è¯¦ç»†æ—¥å¿—

åœ¨å…³é”®ä½ç½®æ·»åŠ  `console.log` è°ƒè¯•è¾“å‡ºï¼š

**ä¿®æ”¹æ–‡ä»¶**:
1. `packages/worker/src/platforms/base/account-data-manager.js`
   - æ„é€ å‡½æ•°ï¼šéªŒè¯ dataPusher æ˜¯å¦ä¼ é€’
   - startDataSnapshot()ï¼šéªŒè¯å®šæ—¶å™¨æ˜¯å¦å¯åŠ¨
   - syncToMaster()ï¼šè¿½è¸ªæ¯æ¬¡åŒæ­¥è°ƒç”¨

2. `packages/worker/src/platforms/douyin/douyin-data-manager.js`
   - æ„é€ å‡½æ•°ï¼šéªŒè¯ dataPusher å‚æ•°

### æ­¥éª¤ 2: åˆ›å»ºå•å…ƒæµ‹è¯•

åˆ›å»ºæµ‹è¯•è„šæœ¬ `tests/æµ‹è¯•DataManageråŒæ­¥.js`ï¼š
- ç›´æ¥åˆ›å»º DouyinDataManager å®ä¾‹
- æ‰‹åŠ¨è°ƒç”¨ syncToMaster()
- ä½¿ç”¨æ¨¡æ‹Ÿçš„ workerBridge æ¥æ•è·æ¶ˆæ¯

**ç¬¬ä¸€æ¬¡æµ‹è¯•ç»“æœ**: âŒ å¤±è´¥

```
TypeError: Cannot read properties of undefined (reading 'WORKER_DATA_SYNC')
    at DataPusher.pushDataSync (data-pusher.js:304:50)
```

### æ­¥éª¤ 3: è¯Šæ–­ MessageTypes å¯¼å‡ºé—®é¢˜

åˆ›å»ºæµ‹è¯•è„šæœ¬ `tests/æµ‹è¯•MessageTypes.js`ï¼š
```javascript
const { MessageTypes } = require('../packages/shared/protocol/messages');
console.log('MessageTypes:', MessageTypes);  // undefined âŒ
```

**æ ¹æœ¬åŸå› å‘ç°**ï¼š

åœ¨ `packages/shared/protocol/messages.js` ä¸­ï¼š

```javascript
// ç¬¬109-172è¡Œï¼šå¯¼å‡ºæ‰€æœ‰æ¶ˆæ¯ç±»å‹å¸¸é‡
module.exports = {
  WORKER_REGISTER,
  WORKER_HEARTBEAT,
  // ... æ›´å¤šå¸¸é‡
  WORKER_DATA_SYNC,  // âœ… å·²å®šä¹‰
  createMessage,
  createErrorMessage,
};

// ç¬¬175è¡Œï¼šåˆ›å»º MessageTypes å˜é‡
const MessageTypes = module.exports;
```

**é—®é¢˜**: å½“ä»£ç ä¸­ä½¿ç”¨ `const { MessageTypes } = require('@hiscrm-im/shared/protocol/messages')` æ—¶ï¼š
- `module.exports` å¯¹è±¡åŒ…å«æ‰€æœ‰æ¶ˆæ¯ç±»å‹å¸¸é‡
- **ä½†æ²¡æœ‰åŒ…å« `MessageTypes` è¿™ä¸ªå±æ€§**
- å› æ­¤è§£æ„æ—¶ `MessageTypes` ä¸º `undefined`

### æ­¥éª¤ 4: ä¿®å¤ MessageTypes å¯¼å‡º

**ä¿®æ”¹æ–‡ä»¶**: `packages/shared/protocol/messages.js`

```javascript
// ä¾¿æ·è®¿é—®æ‰€æœ‰æ¶ˆæ¯ç±»å‹
const MessageTypes = module.exports;
module.exports.MessageTypes = MessageTypes;  // âœ¨ æ–°å¢è¿™ä¸€è¡Œ
```

è¿™æ ·åšçš„æ•ˆæœï¼š
- `module.exports` å¯¹è±¡ç°åœ¨æœ‰ `MessageTypes` å±æ€§
- `const { MessageTypes } = require(...)` å¯ä»¥æ­£ç¡®è§£æ„
- `MessageTypes` æŒ‡å‘ `module.exports`ï¼ŒåŒ…å«æ‰€æœ‰æ¶ˆæ¯ç±»å‹å¸¸é‡

**æ³¨æ„**: è¿™ä¼šåˆ›å»ºå¾ªç¯å¼•ç”¨ï¼ˆMessageTypes.MessageTypes === MessageTypesï¼‰ï¼Œä½†ä¸å½±å“åŠŸèƒ½ã€‚

### æ­¥éª¤ 5: éªŒè¯ä¿®å¤

é‡æ–°è¿è¡Œ `tests/æµ‹è¯•MessageTypes.js`ï¼š

```
âœ… MessageTypes ç±»å‹: object
âœ… MessageTypes æ˜¯å¦ä¸º undefined: false
âœ… WORKER_DATA_SYNC å­˜åœ¨: true
âœ… WORKER_DATA_SYNC å€¼: worker:data:sync
```

é‡æ–°è¿è¡Œ `tests/æµ‹è¯•DataManageråŒæ­¥.js`ï¼š

```
âœ… DouyinDataManager åˆ›å»ºæˆåŠŸ
âœ… å®šæ—¶å™¨å¯åŠ¨ï¼ˆé—´éš” 30000msï¼‰
âœ… syncToMaster() æˆåŠŸè°ƒç”¨
âœ… pushDataSync() æˆåŠŸæ‰§è¡Œ
âœ… æ¶ˆæ¯æ ¼å¼æ­£ç¡®ï¼šworker:data:sync
âœ… æ•°æ®å¿«ç…§åŒ…å«2ä¸ªä¼šè¯
âœ… æ¯30ç§’è‡ªåŠ¨æ¨é€ï¼ˆtotalPushed: 1 â†’ 2 â†’ 3ï¼‰
```

---

## æ ¹æœ¬åŸå› 

**æŠ€æœ¯æ ¹å› **: `MessageTypes` æœªæ­£ç¡®å¯¼å‡ºåˆ° `module.exports` å¯¹è±¡

**å½±å“èŒƒå›´**:
- âœ… Worker ç«¯ DataPusher æ— æ³•è®¿é—® `MessageTypes.WORKER_DATA_SYNC`
- âœ… å¯¼è‡´ pushDataSync() æŠ›å‡ºå¼‚å¸¸
- âœ… syncToMaster() catch ä½å¼‚å¸¸ï¼Œä½†åªè®°å½•åˆ° loggerï¼ˆæœªè¾“å‡ºåˆ°æ§åˆ¶å°ï¼‰
- âœ… Worker çœ‹èµ·æ¥æ­£å¸¸è¿è¡Œï¼Œä½†å®é™…ä¸Šæ•°æ®åŒæ­¥é™é»˜å¤±è´¥

---

## è§£å†³æ–¹æ¡ˆ

### ä¿®æ”¹æ–‡ä»¶

**packages/shared/protocol/messages.js** (ç¬¬176è¡Œ)

```javascript
// ä¿®æ”¹å‰
const MessageTypes = module.exports;

// ä¿®æ”¹å
const MessageTypes = module.exports;
module.exports.MessageTypes = MessageTypes;  // âœ¨ æ·»åŠ è¿™ä¸€è¡Œ
```

### éƒ¨ç½²æ­¥éª¤

1. âœ… ä¿®æ”¹ shared/protocol/messages.js
2. âš ï¸ é‡å¯æ‰€æœ‰ Worker è¿›ç¨‹ï¼ˆæ¸…é™¤ require ç¼“å­˜ï¼‰
3. âš ï¸ æˆ–è€…é‡å¯æ•´ä¸ªç³»ç»Ÿï¼ˆMaster + Workerï¼‰

---

## éªŒè¯æµ‹è¯•

### å•å…ƒæµ‹è¯•

âœ… **é€šè¿‡** - æµ‹è¯•è„šæœ¬éªŒè¯äº†ï¼š
- MessageTypes æ­£ç¡®å¯¼å‡º
- WORKER_DATA_SYNC å¸¸é‡å¯è®¿é—®
- syncToMaster() æˆåŠŸæ¨é€æ¶ˆæ¯
- å®šæ—¶å™¨æ¯30ç§’è‡ªåŠ¨è§¦å‘

### é›†æˆæµ‹è¯•

âš ï¸ **å¾…éªŒè¯** - å®é™… Worker è¿›ç¨‹éœ€è¦ï¼š
1. é‡å¯ Worker è¿›ç¨‹ä»¥åŠ è½½æ–°çš„ shared æ¨¡å—
2. ç­‰å¾… 30 ç§’è®©å®šæ—¶å™¨è§¦å‘
3. æ£€æŸ¥ Master DataStore æ˜¯å¦æ”¶åˆ°æ•°æ®
4. æ£€æŸ¥ Master æ—¥å¿—æ˜¯å¦æœ‰ "Data sync completed" æ¶ˆæ¯

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³è¡ŒåŠ¨ï¼ˆå¿…éœ€ï¼‰

1. **é‡å¯ Worker è¿›ç¨‹**
   ```bash
   # æ–¹æ³• 1: é€šè¿‡ Master API é‡å¯
   curl -X POST http://localhost:3000/api/v1/workers/worker1/restart

   # æ–¹æ³• 2: æ‰‹åŠ¨åœæ­¢å¹¶ç­‰å¾… Master è‡ªåŠ¨é‡å¯
   taskkill /F /PID <worker-pid>

   # æ–¹æ³• 3: é‡å¯æ•´ä¸ªç³»ç»Ÿ
   # åœæ­¢ Masterï¼ˆä¼šè‡ªåŠ¨åœæ­¢ Workerï¼‰
   # é‡æ–°å¯åŠ¨ Masterï¼ˆä¼šè‡ªåŠ¨å¯åŠ¨ Workerï¼‰
   ```

2. **ç­‰å¾…å¹¶è§‚å¯Ÿ**
   - ç­‰å¾… 45 ç§’ï¼ˆWorker åˆå§‹åŒ– + é¦–æ¬¡åŒæ­¥ï¼‰
   - è¿è¡ŒéªŒè¯è„šæœ¬ï¼š`node tests/æ‰‹åŠ¨è§¦å‘æ•°æ®åŒæ­¥.js`
   - æ£€æŸ¥ DataStore çŠ¶æ€

3. **éªŒè¯æˆåŠŸæ ‡å¿—**
   - DataStore.totalAccounts > 0
   - DataSync.totalReceived > 0
   - Master æ—¥å¿—åŒ…å« "âœ… Data sync completed"

### åç»­ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

1. **æ·»åŠ å¥åº·æ£€æŸ¥**
   - æ¯éš” 5 åˆ†é’Ÿæ£€æŸ¥ Worker æ˜¯å¦æ¨é€æ•°æ®
   - å¦‚æœ 5 åˆ†é’Ÿå†…æ²¡æœ‰æ¨é€ï¼Œå‘é€è­¦å‘Š

2. **æ”¹è¿›æ—¥å¿—è¾“å‡º**
   - å°† syncToMaster() çš„ console.log ä¿ç•™åœ¨ç”Ÿäº§ç¯å¢ƒ
   - æˆ–è€…å°† logger çº§åˆ«è®¾ç½®ä¸º debug å¹¶è¾“å‡ºåˆ°æ–‡ä»¶

3. **æ·»åŠ  Prometheus æŒ‡æ ‡**
   - `worker_data_sync_total` - æ€»æ¨é€æ¬¡æ•°
   - `worker_data_sync_errors` - æ¨é€å¤±è´¥æ¬¡æ•°
   - `worker_data_sync_last_success_time` - æœ€åæˆåŠŸæ¨é€æ—¶é—´

---

## ç»éªŒæ•™è®­

### æŠ€æœ¯å±‚é¢

1. **æ¨¡å—å¯¼å‡ºæ¨¡å¼**
   - ä½¿ç”¨ CommonJS æ—¶ï¼Œ`module.exports =` å’Œè§£æ„ `{ key }` éœ€è¦åŒ¹é…
   - å¦‚æœéœ€è¦åŒæ—¶æ”¯æŒ `const MessageTypes = require()` å’Œ `const { MessageTypes } = require()`ï¼Œéœ€è¦æ˜¾å¼æ·»åŠ  `module.exports.MessageTypes`

2. **æ—¥å¿—å¯è§æ€§**
   - Worker çš„ console.log è¾“å‡ºä¸å¯è§ï¼ˆè¢« Master æ•è·æˆ–ä¸¢å¼ƒï¼‰
   - ç”Ÿäº§ç¯å¢ƒåº”è¯¥ä½¿ç”¨ logger å¹¶è¾“å‡ºåˆ°æ–‡ä»¶
   - è°ƒè¯•æ—¶åº”è¯¥æ·»åŠ æ˜æ˜¾çš„ error çº§åˆ«æ—¥å¿—

3. **æ¨¡å—ç¼“å­˜**
   - Node.js ä¼šç¼“å­˜ require() çš„æ¨¡å—
   - ä¿®æ”¹ shared æ¨¡å—åï¼Œå¿…é¡»é‡å¯æ‰€æœ‰ä½¿ç”¨å®ƒçš„è¿›ç¨‹
   - æˆ–è€…ä½¿ç”¨ `delete require.cache[require.resolve(...)]` æ¸…é™¤ç¼“å­˜ï¼ˆä¸æ¨èç”Ÿäº§ç¯å¢ƒï¼‰

### æµç¨‹å±‚é¢

1. **å•å…ƒæµ‹è¯•çš„é‡è¦æ€§**
   - ç›´æ¥æµ‹è¯•æ¨¡å—å¯¼å‡ºå¯ä»¥å¿«é€Ÿå®šä½é—®é¢˜
   - æµ‹è¯•è„šæœ¬æ¯”ç«¯åˆ°ç«¯è°ƒè¯•å¿« 10å€

2. **é€æ­¥è°ƒè¯•**
   - å…ˆéªŒè¯æœ€åº•å±‚ï¼ˆMessageTypes å¯¼å‡ºï¼‰
   - å†éªŒè¯ä¸­é—´å±‚ï¼ˆDataPusher.pushDataSyncï¼‰
   - æœ€åéªŒè¯é¡¶å±‚ï¼ˆWorker æ•´ä½“æµç¨‹ï¼‰

3. **æ—¥å¿—é©±åŠ¨è°ƒè¯•**
   - åœ¨å…³é”®ä½ç½®æ·»åŠ è°ƒè¯•æ—¥å¿—
   - ä½¿ç”¨ console.log ç¡®ä¿æ—¥å¿—å¯è§
   - æ—¥å¿—åº”è¯¥åŒ…å«æ—¶é—´æˆ³ã€ç»„ä»¶åã€å…³é”®æ•°æ®

---

## é™„å½•ï¼šæµ‹è¯•è„šæœ¬

### æµ‹è¯• MessageTypes å¯¼å‡º

**æ–‡ä»¶**: `tests/æµ‹è¯•MessageTypes.js`

```javascript
const { MessageTypes } = require('../packages/shared/protocol/messages');

console.log('MessageTypes ç±»å‹:', typeof MessageTypes);
console.log('WORKER_DATA_SYNC å­˜åœ¨:', 'WORKER_DATA_SYNC' in MessageTypes);
console.log('WORKER_DATA_SYNC å€¼:', MessageTypes.WORKER_DATA_SYNC);
```

### æµ‹è¯• DataManager åŒæ­¥

**æ–‡ä»¶**: `tests/æµ‹è¯•DataManageråŒæ­¥.js`

```javascript
const { DouyinDataManager } = require('../packages/worker/src/platforms/douyin/douyin-data-manager');
const { DataPusher } = require('../packages/worker/src/platforms/base/data-pusher');

const mockBridge = {
  async sendToMaster(message) {
    console.log('ğŸ“¤ æ¶ˆæ¯ç±»å‹:', message.type);
    console.log('  è´Ÿè½½:', JSON.stringify(message.payload, null, 2));
  }
};

const dataPusher = new DataPusher(mockBridge);
const dataManager = new DouyinDataManager('acc-test', dataPusher);

// æ·»åŠ æµ‹è¯•æ•°æ®
dataManager.upsertConversation({ user_id: '123', user: { nickname: 'æµ‹è¯•' } });

// æ‰‹åŠ¨è§¦å‘åŒæ­¥
dataManager.syncToMaster();
```

### æ£€æŸ¥ DataStore çŠ¶æ€

**æ–‡ä»¶**: `tests/æ‰‹åŠ¨è§¦å‘æ•°æ®åŒæ­¥.js` (å·²å­˜åœ¨)

```bash
node tests/æ‰‹åŠ¨è§¦å‘æ•°æ®åŒæ­¥.js
```

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-30 15:48
**æŠ¥å‘Šç”Ÿæˆè€…**: Claude (Anthropic)
**é—®é¢˜çŠ¶æ€**: âœ… **å·²ä¿®å¤** - ç­‰å¾… Worker é‡å¯éªŒè¯
