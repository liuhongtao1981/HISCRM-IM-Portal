# å®æ—¶ç›‘æ§ + å†å²çˆ¬è™«æ··åˆæ–¹æ¡ˆ - å¼€å‘è®¡åˆ’

**åˆ›å»ºæ—¥æœŸ**: 2025-11-06
**æ–¹æ¡ˆç‰ˆæœ¬**: v1.0
**é¢„è®¡å·¥æœŸ**: 5-7ä¸ªå·¥ä½œæ—¥

---

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

### æ ¸å¿ƒæ€è·¯

å°†ç›‘æ§ç³»ç»Ÿåˆ†ä¸ºä¸¤ä¸ªç‹¬ç«‹ä½†ååŒçš„ä»»åŠ¡ç±»å‹:

1. **å®æ—¶ç›‘æ§ä»»åŠ¡** (å¸¸é©»)
   - ä½¿ç”¨é›¶å»¶è¿Ÿé’©å­ç›‘æ§æ–¹æ¡ˆ
   - æµè§ˆå™¨é¡µé¢æ‰“å¼€åæŒç»­è¿è¡Œ
   - æ•è·æ‰€æœ‰æ–°æ¨é€çš„ç§ä¿¡å’Œè¯„è®º
   - 100%å®æ—¶,é›¶å»¶è¿Ÿ

2. **å†å²çˆ¬è™«ä»»åŠ¡** (å®šæ—¶)
   - ä½¿ç”¨åŸæœ‰çš„çˆ¬è™«é€»è¾‘
   - æ¯ 5-10 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
   - æŠ“å–å†å²æ¶ˆæ¯å’Œé—æ¼æ•°æ®
   - ä½œä¸ºå®æ—¶ç›‘æ§çš„è¡¥å……å’Œå…œåº•

### æ¶æ„ä¼˜åŠ¿

âœ… **å®æ—¶æ€§**: æ–°æ¶ˆæ¯ç«‹å³æ•è·,æ— å»¶è¿Ÿ
âœ… **å®Œæ•´æ€§**: å†å²æ•°æ®å®šæ—¶è¡¥å……,æ— é—æ¼
âœ… **å®¹é”™æ€§**: åŒé‡ä¿éšœ,äº’ä¸ºå¤‡ä»½
âœ… **çµæ´»æ€§**: é…ç½®æ–‡ä»¶æ§åˆ¶é—´éš”å’Œå¼€å…³
âœ… **å¯ç»´æŠ¤**: ä»»åŠ¡åˆ†ç¦»,èŒè´£æ¸…æ™°

---

## ğŸ¯ å¼€å‘ç›®æ ‡

### 1. å®æ—¶ç›‘æ§å±‚

- [ ] æ³¨å…¥é›¶å»¶è¿Ÿé’©å­ç›‘æ§è„šæœ¬åˆ°æµè§ˆå™¨
- [ ] ç›‘æ§ `msgListToPush` (ç§ä¿¡)
- [ ] ç›‘æ§ `noticePushList` (è¯„è®º)
- [ ] å®æ—¶æ¨é€åˆ° Master æœåŠ¡å™¨
- [ ] é¡µé¢å¯¼èˆªæ—¶è‡ªåŠ¨é‡æ–°æ³¨å…¥

### 2. å†å²çˆ¬è™«å±‚

- [ ] æ”¹é€ ç°æœ‰çˆ¬è™«ä¸ºå®šæ—¶ä»»åŠ¡
- [ ] é…ç½®åŒ–æ‰§è¡Œé—´éš” (5-10åˆ†é’Ÿ)
- [ ] å¢é‡æŠ“å–é€»è¾‘ (åªæŠ“æ–°æ•°æ®)
- [ ] ä¸å®æ—¶æ•°æ®å»é‡

### 3. é…ç½®ç®¡ç†

- [ ] æ–°å¢é…ç½®é¡¹: `enableRealtimeMonitor`
- [ ] æ–°å¢é…ç½®é¡¹: `crawlInterval` (åˆ†é’Ÿ)
- [ ] æ–°å¢é…ç½®é¡¹: `realtimeOnly` (ä»…å®æ—¶æ¨¡å¼)
- [ ] è´¦æˆ·çº§åˆ«é…ç½®æ”¯æŒ

### 4. æ•°æ®åŒæ­¥

- [ ] ç»Ÿä¸€æ•°æ®å…¥å£
- [ ] æ™ºèƒ½å»é‡æœºåˆ¶
- [ ] æ•°æ®æºæ ‡è®° (realtime/crawl)
- [ ] å†²çªè§£å†³ç­–ç•¥

---

## ğŸ“ ç³»ç»Ÿæ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Master Server                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         Task Scheduler & Coordinator             â”‚  â”‚
â”‚  â”‚  - ç®¡ç†å®æ—¶ç›‘æ§ä»»åŠ¡                                â”‚  â”‚
â”‚  â”‚  - è°ƒåº¦å†å²çˆ¬è™«ä»»åŠ¡                                â”‚  â”‚
â”‚  â”‚  - ç»Ÿä¸€æ•°æ®æ¥æ”¶å’Œå­˜å‚¨                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“ â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Worker Process  â”‚              â”‚  Worker Process  â”‚
â”‚  (Account 1)     â”‚              â”‚  (Account 2)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                      â”‚
        â†“                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Playwright Browser                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚    å®æ—¶ç›‘æ§å±‚ (å¸¸é©»)                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - é’©å­æ³¨å…¥                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - msgListToPush ç›‘å¬                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - noticePushList ç›‘å¬                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - å®æ—¶æ•°æ®æ¨é€                           â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                     â†“                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚    å†å²çˆ¬è™«å±‚ (å®šæ—¶ 5-10åˆ†é’Ÿ)             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - DOM è§£æ                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - æ»šåŠ¨åŠ è½½                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - å¢é‡æŠ“å–                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - å†å²æ•°æ®è¡¥å……                           â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

```
å®æ—¶ç›‘æ§æµ:
WebSocket Push â†’ msgListToPush.push()
                 â†“
              é’©å­è§¦å‘ (0ms)
                 â†“
              æ•°æ®å¤„ç†å’Œæ ¼å¼åŒ–
                 â†“
              Socket.IO â†’ Master
                 â†“
              æ•°æ®åº“å­˜å‚¨

å†å²çˆ¬è™«æµ:
å®šæ—¶å™¨è§¦å‘ (5-10åˆ†é’Ÿ)
                 â†“
              æ‰“å¼€èŠå¤©çª—å£
                 â†“
              DOM è§£æ + æ»šåŠ¨åŠ è½½
                 â†“
              å¢é‡æ•°æ®è¿‡æ»¤
                 â†“
              Socket.IO â†’ Master
                 â†“
              å»é‡ + æ•°æ®åº“å­˜å‚¨
```

---

## ğŸ—‚ï¸ æ–‡ä»¶ç»“æ„

### æ–°å¢æ–‡ä»¶

```
packages/worker/src/
â”œâ”€â”€ monitoring/                          # æ–°å¢: ç›‘æ§æ¨¡å—
â”‚   â”œâ”€â”€ realtime-monitor.js              # å®æ—¶ç›‘æ§ç®¡ç†å™¨
â”‚   â”œâ”€â”€ hook-injector.js                 # é’©å­æ³¨å…¥å™¨
â”‚   â”œâ”€â”€ crawl-scheduler.js               # çˆ¬è™«è°ƒåº¦å™¨
â”‚   â””â”€â”€ data-deduplicator.js             # æ•°æ®å»é‡å™¨
â”‚
â”œâ”€â”€ platforms/douyin/
â”‚   â”œâ”€â”€ realtime/                        # æ–°å¢: å®æ—¶ç›‘æ§
â”‚   â”‚   â”œâ”€â”€ install-hooks.js             # é’©å­å®‰è£…è„šæœ¬
â”‚   â”‚   â”œâ”€â”€ message-hook.js              # ç§ä¿¡é’©å­å¤„ç†
â”‚   â”‚   â””â”€â”€ comment-hook.js              # è¯„è®ºé’©å­å¤„ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ crawl/                           # é‡æ„: çˆ¬è™«æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ crawl-messages.js            # ç§ä¿¡çˆ¬è™« (æ”¹é€ )
â”‚   â”‚   â”œâ”€â”€ crawl-comments.js            # è¯„è®ºçˆ¬è™« (æ”¹é€ )
â”‚   â”‚   â””â”€â”€ incremental-loader.js        # å¢é‡åŠ è½½å™¨
â”‚   â”‚
â”‚   â””â”€â”€ platform.js                      # æ›´æ–°: å¹³å°ä¸»ç±»

packages/master/src/
â”œâ”€â”€ scheduler/
â”‚   â”œâ”€â”€ realtime-task-manager.js         # æ–°å¢: å®æ—¶ä»»åŠ¡ç®¡ç†
â”‚   â”œâ”€â”€ crawl-task-scheduler.js          # æ–°å¢: çˆ¬è™«ä»»åŠ¡è°ƒåº¦
â”‚   â””â”€â”€ task-coordinator.js              # æ–°å¢: ä»»åŠ¡åè°ƒå™¨
â”‚
â”œâ”€â”€ database/
â”‚   â””â”€â”€ message-dao.js                   # æ›´æ–°: å¢åŠ æ•°æ®æºå­—æ®µ

config/
â”œâ”€â”€ monitoring-config.js                 # æ–°å¢: ç›‘æ§é…ç½®
â””â”€â”€ default-config.json                  # æ›´æ–°: é»˜è®¤é…ç½®
```

---

## ğŸ”§ è¯¦ç»†å¼€å‘ä»»åŠ¡

### é˜¶æ®µä¸€: å®æ—¶ç›‘æ§æ ¸å¿ƒ (2å¤©)

#### ä»»åŠ¡ 1.1: é’©å­æ³¨å…¥å™¨
**æ–‡ä»¶**: `packages/worker/src/monitoring/hook-injector.js`

**åŠŸèƒ½**:
- å°† `test-realtime-hook-monitor-v2.js` æ”¹é€ ä¸ºç”Ÿäº§çº§æ¨¡å—
- æä¾› `injectHooks(page)` æ–¹æ³•
- ç›‘å¬é¡µé¢å¯¼èˆª,è‡ªåŠ¨é‡æ–°æ³¨å…¥
- æä¾›é’©å­çŠ¶æ€æ£€æµ‹

**å…³é”®ä»£ç **:
```javascript
class HookInjector {
  constructor(page) {
    this.page = page;
    this.isInstalled = false;
  }

  async install() {
    // æ³¨å…¥é’©å­è„šæœ¬
    await this.page.addScriptTag({
      path: './src/platforms/douyin/realtime/install-hooks.js'
    });

    // æš´éœ²å›è°ƒå‡½æ•°ç»™é¡µé¢
    await this.page.exposeFunction('sendToWorker', async (data) => {
      await this.handleRealtimeData(data);
    });

    // ç›‘å¬é¡µé¢å¯¼èˆª,è‡ªåŠ¨é‡æ–°æ³¨å…¥
    this.page.on('framenavigated', async () => {
      if (!await this.checkHookStatus()) {
        await this.install();
      }
    });

    this.isInstalled = true;
  }

  async checkHookStatus() {
    return await this.page.evaluate(() => {
      return typeof window.hookMonitor !== 'undefined';
    });
  }

  async handleRealtimeData(data) {
    // å¤„ç†å®æ—¶æ•°æ®,å‘é€åˆ° Master
    this.emit('data', data);
  }
}
```

**é¢„è®¡æ—¶é—´**: 4å°æ—¶

---

#### ä»»åŠ¡ 1.2: å®æ—¶ç›‘æ§ç®¡ç†å™¨
**æ–‡ä»¶**: `packages/worker/src/monitoring/realtime-monitor.js`

**åŠŸèƒ½**:
- ç®¡ç†é’©å­ç”Ÿå‘½å‘¨æœŸ
- æ¥æ”¶å®æ—¶æ•°æ®
- æ ¼å¼åŒ–å¹¶å‘é€åˆ° Master
- é”™è¯¯å¤„ç†å’Œé‡è¯•

**å…³é”®ä»£ç **:
```javascript
class RealtimeMonitor extends EventEmitter {
  constructor(page, accountId, socket) {
    super();
    this.page = page;
    this.accountId = accountId;
    this.socket = socket;
    this.injector = new HookInjector(page);
  }

  async start() {
    await this.injector.install();

    this.injector.on('data', async (data) => {
      try {
        // æ ¼å¼åŒ–æ•°æ®
        const formattedData = this.formatData(data);

        // å‘é€åˆ° Master
        this.socket.emit('worker:realtime_data', {
          accountId: this.accountId,
          dataType: data.type, // 'message' | 'comment'
          data: formattedData,
          source: 'realtime',
          timestamp: Date.now()
        });

        logger.info(`[å®æ—¶ç›‘æ§] ${data.type} å·²å‘é€`, {
          accountId: this.accountId,
          id: formattedData.id
        });
      } catch (error) {
        logger.error('[å®æ—¶ç›‘æ§] æ•°æ®å¤„ç†å¤±è´¥', error);
      }
    });
  }

  async stop() {
    // åœæ­¢ç›‘æ§ (é¡µé¢å…³é—­æ—¶)
  }

  formatData(data) {
    // ç»Ÿä¸€æ•°æ®æ ¼å¼
    return {
      ...data,
      capturedAt: Date.now(),
      source: 'realtime'
    };
  }
}
```

**é¢„è®¡æ—¶é—´**: 4å°æ—¶

---

#### ä»»åŠ¡ 1.3: å¹³å°é›†æˆ
**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/platform.js`

**åŠŸèƒ½**:
- åœ¨ `startMonitoring()` ä¸­å¯åŠ¨å®æ—¶ç›‘æ§
- ç®¡ç†å®æ—¶ç›‘æ§ç”Ÿå‘½å‘¨æœŸ
- é…ç½®æ£€æŸ¥

**å…³é”®ä»£ç **:
```javascript
class DouyinPlatform extends PlatformBase {
  async startMonitoring(accountId) {
    const account = await this.getAccount(accountId);
    const config = account.monitoringConfig || {};

    // å¯åŠ¨å®æ—¶ç›‘æ§ (å¦‚æœå¯ç”¨)
    if (config.enableRealtimeMonitor !== false) {
      await this.startRealtimeMonitor(accountId);
    }

    // å¯åŠ¨å®šæ—¶çˆ¬è™« (å¦‚æœå¯ç”¨)
    if (config.enableCrawl !== false) {
      await this.startCrawlScheduler(accountId);
    }
  }

  async startRealtimeMonitor(accountId) {
    const page = await this.getAccountPage(accountId);

    const monitor = new RealtimeMonitor(
      page,
      accountId,
      this.socket
    );

    await monitor.start();

    this.monitors.set(accountId, monitor);

    logger.info('[å®æ—¶ç›‘æ§] å·²å¯åŠ¨', { accountId });
  }

  async stopMonitoring(accountId) {
    const monitor = this.monitors.get(accountId);
    if (monitor) {
      await monitor.stop();
      this.monitors.delete(accountId);
    }

    const scheduler = this.schedulers.get(accountId);
    if (scheduler) {
      scheduler.stop();
      this.schedulers.delete(accountId);
    }
  }
}
```

**é¢„è®¡æ—¶é—´**: 4å°æ—¶

---

### é˜¶æ®µäºŒ: å†å²çˆ¬è™«æ”¹é€  (1.5å¤©)

#### ä»»åŠ¡ 2.1: çˆ¬è™«è°ƒåº¦å™¨
**æ–‡ä»¶**: `packages/worker/src/monitoring/crawl-scheduler.js`

**åŠŸèƒ½**:
- æŒ‰é…ç½®çš„é—´éš”æ‰§è¡Œçˆ¬è™«
- æ”¯æŒåŠ¨æ€è°ƒæ•´é—´éš”
- ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†

**å…³é”®ä»£ç **:
```javascript
class CrawlScheduler {
  constructor(accountId, config, platform) {
    this.accountId = accountId;
    this.config = config;
    this.platform = platform;
    this.intervalId = null;
    this.isRunning = false;
  }

  start() {
    const intervalMs = (this.config.crawlInterval || 5) * 60 * 1000;

    this.intervalId = setInterval(async () => {
      if (this.isRunning) {
        logger.warn('[çˆ¬è™«è°ƒåº¦] ä¸Šæ¬¡ä»»åŠ¡æœªå®Œæˆ,è·³è¿‡', {
          accountId: this.accountId
        });
        return;
      }

      try {
        this.isRunning = true;
        await this.executeCrawl();
      } catch (error) {
        logger.error('[çˆ¬è™«è°ƒåº¦] æ‰§è¡Œå¤±è´¥', error);
      } finally {
        this.isRunning = false;
      }
    }, intervalMs);

    logger.info('[çˆ¬è™«è°ƒåº¦] å·²å¯åŠ¨', {
      accountId: this.accountId,
      interval: this.config.crawlInterval
    });
  }

  async executeCrawl() {
    logger.info('[çˆ¬è™«è°ƒåº¦] å¼€å§‹æ‰§è¡Œ', {
      accountId: this.accountId
    });

    // æ‰§è¡Œç§ä¿¡çˆ¬è™«
    if (this.config.crawlMessages !== false) {
      await this.platform.crawlDirectMessagesIncremental(
        this.accountId
      );
    }

    // æ‰§è¡Œè¯„è®ºçˆ¬è™«
    if (this.config.crawlComments !== false) {
      await this.platform.crawlCommentsIncremental(
        this.accountId
      );
    }

    logger.info('[çˆ¬è™«è°ƒåº¦] æ‰§è¡Œå®Œæˆ', {
      accountId: this.accountId
    });
  }

  stop() {
    if (this.intervalId) {
      clearInterval(this.intervalId);
      this.intervalId = null;
    }
  }

  updateInterval(minutes) {
    this.config.crawlInterval = minutes;
    this.stop();
    this.start();
  }
}
```

**é¢„è®¡æ—¶é—´**: 3å°æ—¶

---

#### ä»»åŠ¡ 2.2: å¢é‡çˆ¬è™«é€»è¾‘
**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/crawl/incremental-loader.js`

**åŠŸèƒ½**:
- åªæŠ“å–æœ€æ–°çš„æ•°æ®
- ä½¿ç”¨æ—¶é—´æˆ³åˆ¤æ–­æˆªæ­¢ç‚¹
- é¿å…é‡å¤æŠ“å–

**å…³é”®ä»£ç **:
```javascript
class IncrementalLoader {
  constructor(page) {
    this.page = page;
  }

  async loadMessages(conversationId, lastTimestamp) {
    const messages = [];
    let shouldContinue = true;

    // æ‰“å¼€èŠå¤©çª—å£
    await this.openConversation(conversationId);

    while (shouldContinue) {
      // è·å–å½“å‰é¡µé¢çš„æ¶ˆæ¯
      const pageMessages = await this.parseVisibleMessages();

      for (const msg of pageMessages) {
        // å¦‚æœæ¶ˆæ¯æ—¶é—´æ—©äºä¸Šæ¬¡æŠ“å–,åœæ­¢
        if (msg.timestamp <= lastTimestamp) {
          shouldContinue = false;
          break;
        }
        messages.push(msg);
      }

      if (shouldContinue) {
        // æ»šåŠ¨åŠ è½½æ›´å¤š
        const hasMore = await this.scrollUp();
        if (!hasMore) break;
        await this.sleep(1000);
      }
    }

    return messages;
  }

  async parseVisibleMessages() {
    return await this.page.evaluate(() => {
      // DOM è§£æé€»è¾‘
      const messageElements = document.querySelectorAll('.message-item');
      return Array.from(messageElements).map(el => ({
        id: el.dataset.messageId,
        content: el.querySelector('.message-text')?.textContent,
        timestamp: parseInt(el.dataset.timestamp)
      }));
    });
  }

  async scrollUp() {
    return await this.page.evaluate(() => {
      const container = document.querySelector('.message-container');
      const oldScrollTop = container.scrollTop;
      container.scrollTop = 0;
      return container.scrollTop !== oldScrollTop;
    });
  }
}
```

**é¢„è®¡æ—¶é—´**: 4å°æ—¶

---

#### ä»»åŠ¡ 2.3: æ”¹é€ ç°æœ‰çˆ¬è™«
**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/platform.js`

**åŠŸèƒ½**:
- æ–°å¢ `crawlDirectMessagesIncremental()` æ–¹æ³•
- æ–°å¢ `crawlCommentsIncremental()` æ–¹æ³•
- é›†æˆå¢é‡åŠ è½½å™¨

**å…³é”®ä»£ç **:
```javascript
async crawlDirectMessagesIncremental(accountId) {
  const page = await this.getAccountPage(accountId);
  const loader = new IncrementalLoader(page);

  // è·å–ä¸Šæ¬¡çˆ¬å–çš„æ—¶é—´æˆ³
  const lastCrawlTime = await this.getLastCrawlTimestamp(
    accountId,
    'direct_messages'
  );

  // è·å–ä¼šè¯åˆ—è¡¨
  const conversations = await this.getConversations(page);

  for (const conv of conversations) {
    const messages = await loader.loadMessages(
      conv.conversationId,
      lastCrawlTime
    );

    if (messages.length > 0) {
      // å‘é€åˆ° Master
      this.socket.emit('worker:crawl_data', {
        accountId,
        dataType: 'messages',
        data: messages,
        source: 'crawl',
        timestamp: Date.now()
      });

      logger.info(`[å¢é‡çˆ¬è™«] æŠ“å–åˆ° ${messages.length} æ¡æ–°ç§ä¿¡`, {
        accountId,
        conversationId: conv.conversationId
      });
    }
  }

  // æ›´æ–°çˆ¬å–æ—¶é—´æˆ³
  await this.updateLastCrawlTimestamp(
    accountId,
    'direct_messages',
    Date.now()
  );
}
```

**é¢„è®¡æ—¶é—´**: 5å°æ—¶

---

### é˜¶æ®µä¸‰: Master æœåŠ¡å™¨æ”¹é€  (1.5å¤©)

#### ä»»åŠ¡ 3.1: æ•°æ®æ¥æ”¶å’Œå»é‡
**æ–‡ä»¶**: `packages/master/src/worker_manager/data-receiver.js`

**åŠŸèƒ½**:
- æ¥æ”¶å®æ—¶æ•°æ®å’Œçˆ¬è™«æ•°æ®
- ç»Ÿä¸€å…¥å£
- æ™ºèƒ½å»é‡

**å…³é”®ä»£ç **:
```javascript
class DataReceiver {
  constructor(io, db) {
    this.io = io;
    this.db = db;
    this.deduplicator = new DataDeduplicator();
  }

  setupListeners() {
    this.io.of('/worker').on('connection', (socket) => {
      // å®æ—¶æ•°æ®
      socket.on('worker:realtime_data', async (data) => {
        await this.handleRealtimeData(data);
      });

      // çˆ¬è™«æ•°æ®
      socket.on('worker:crawl_data', async (data) => {
        await this.handleCrawlData(data);
      });
    });
  }

  async handleRealtimeData(data) {
    const { accountId, dataType, data: payload, source } = data;

    // å»é‡æ£€æŸ¥
    const isDuplicate = await this.deduplicator.check(
      dataType,
      payload.id
    );

    if (isDuplicate) {
      logger.debug('[æ•°æ®æ¥æ”¶] é‡å¤æ•°æ®,è·³è¿‡', {
        source,
        id: payload.id
      });
      return;
    }

    // ä¿å­˜åˆ°æ•°æ®åº“
    if (dataType === 'message') {
      await this.db.directMessages.create({
        ...payload,
        accountId,
        source,
        capturedAt: Date.now()
      });
    } else if (dataType === 'comment') {
      await this.db.comments.create({
        ...payload,
        accountId,
        source,
        capturedAt: Date.now()
      });
    }

    // è®°å½•å»é‡æ ‡è®°
    await this.deduplicator.mark(dataType, payload.id);

    // æ¨é€é€šçŸ¥ç»™å®¢æˆ·ç«¯
    this.io.of('/client').emit('notification:new', {
      accountId,
      type: dataType,
      data: payload
    });

    logger.info('[æ•°æ®æ¥æ”¶] å·²ä¿å­˜', {
      source,
      type: dataType,
      id: payload.id
    });
  }

  async handleCrawlData(data) {
    const { accountId, dataType, data: items, source } = data;

    let savedCount = 0;

    for (const item of items) {
      const isDuplicate = await this.deduplicator.check(
        dataType,
        item.id
      );

      if (!isDuplicate) {
        if (dataType === 'messages') {
          await this.db.directMessages.create({
            ...item,
            accountId,
            source,
            capturedAt: Date.now()
          });
        } else if (dataType === 'comments') {
          await this.db.comments.create({
            ...item,
            accountId,
            source,
            capturedAt: Date.now()
          });
        }

        await this.deduplicator.mark(dataType, item.id);
        savedCount++;
      }
    }

    logger.info('[æ•°æ®æ¥æ”¶] æ‰¹é‡ä¿å­˜å®Œæˆ', {
      source,
      type: dataType,
      total: items.length,
      saved: savedCount,
      skipped: items.length - savedCount
    });
  }
}
```

**é¢„è®¡æ—¶é—´**: 4å°æ—¶

---

#### ä»»åŠ¡ 3.2: æ•°æ®å»é‡å™¨
**æ–‡ä»¶**: `packages/worker/src/monitoring/data-deduplicator.js`

**åŠŸèƒ½**:
- ä½¿ç”¨ Redis æˆ–å†…å­˜ç¼“å­˜
- å¿«é€Ÿæ£€æµ‹é‡å¤
- TTL è‡ªåŠ¨è¿‡æœŸ

**å…³é”®ä»£ç **:
```javascript
class DataDeduplicator {
  constructor() {
    // ä½¿ç”¨ LRU ç¼“å­˜,æœ€å¤šä¿å­˜ 10000 ä¸ªID
    this.cache = new Map();
    this.maxSize = 10000;
    this.ttl = 24 * 60 * 60 * 1000; // 24å°æ—¶
  }

  async check(dataType, id) {
    const key = `${dataType}:${id}`;
    const entry = this.cache.get(key);

    if (!entry) return false;

    // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
    if (Date.now() - entry.timestamp > this.ttl) {
      this.cache.delete(key);
      return false;
    }

    return true;
  }

  async mark(dataType, id) {
    const key = `${dataType}:${id}`;

    // å¦‚æœç¼“å­˜æ»¡äº†,åˆ é™¤æœ€è€çš„é¡¹
    if (this.cache.size >= this.maxSize) {
      const firstKey = this.cache.keys().next().value;
      this.cache.delete(firstKey);
    }

    this.cache.set(key, {
      timestamp: Date.now()
    });
  }

  clear() {
    this.cache.clear();
  }
}
```

**é¢„è®¡æ—¶é—´**: 2å°æ—¶

---

#### ä»»åŠ¡ 3.3: æ•°æ®åº“ Schema æ›´æ–°
**æ–‡ä»¶**: `packages/master/src/database/schema.sql`

**åŠŸèƒ½**:
- æ·»åŠ  `source` å­—æ®µ ('realtime' | 'crawl')
- æ·»åŠ  `capturedAt` å­—æ®µ
- æ·»åŠ ç´¢å¼•

**SQL**:
```sql
-- æ›´æ–° direct_messages è¡¨
ALTER TABLE direct_messages ADD COLUMN source VARCHAR(20) DEFAULT 'crawl';
ALTER TABLE direct_messages ADD COLUMN captured_at BIGINT;
CREATE INDEX idx_direct_messages_source ON direct_messages(source);

-- æ›´æ–° comments è¡¨
ALTER TABLE comments ADD COLUMN source VARCHAR(20) DEFAULT 'crawl';
ALTER TABLE comments ADD COLUMN captured_at BIGINT;
CREATE INDEX idx_comments_source ON comments(source);

-- æ›´æ–° accounts è¡¨,æ·»åŠ ç›‘æ§é…ç½®
ALTER TABLE accounts ADD COLUMN monitoring_config TEXT;
```

**é¢„è®¡æ—¶é—´**: 1å°æ—¶

---

### é˜¶æ®µå››: é…ç½®ç®¡ç† (0.5å¤©)

#### ä»»åŠ¡ 4.1: é…ç½®æ–‡ä»¶
**æ–‡ä»¶**: `config/default-config.json`

**å†…å®¹**:
```json
{
  "monitoring": {
    "realtime": {
      "enabled": true,
      "autoReinstallOnNavigation": true,
      "dataBufferSize": 100
    },
    "crawl": {
      "enabled": true,
      "intervalMinutes": 5,
      "incrementalOnly": true,
      "maxMessagesPerCrawl": 100
    }
  },
  "accounts": {
    "default": {
      "enableRealtimeMonitor": true,
      "enableCrawl": true,
      "crawlInterval": 5,
      "crawlMessages": true,
      "crawlComments": true,
      "realtimeOnly": false
    }
  }
}
```

**é¢„è®¡æ—¶é—´**: 1å°æ—¶

---

#### ä»»åŠ¡ 4.2: è´¦æˆ·çº§åˆ«é…ç½®
**æ–‡ä»¶**: `packages/master/src/database/account-dao.js`

**åŠŸèƒ½**:
- ä¿å­˜å’Œè¯»å–è´¦æˆ·ç›‘æ§é…ç½®
- é…ç½®ç»§æ‰¿å’Œè¦†ç›–

**å…³é”®ä»£ç **:
```javascript
class AccountDAO {
  async getMonitoringConfig(accountId) {
    const account = await this.findById(accountId);

    const config = account.monitoring_config
      ? JSON.parse(account.monitoring_config)
      : {};

    // åˆå¹¶é»˜è®¤é…ç½®
    return {
      ...defaultConfig.accounts.default,
      ...config
    };
  }

  async updateMonitoringConfig(accountId, config) {
    await this.db.run(
      `UPDATE accounts SET monitoring_config = ? WHERE id = ?`,
      [JSON.stringify(config), accountId]
    );
  }
}
```

**é¢„è®¡æ—¶é—´**: 2å°æ—¶

---

### é˜¶æ®µäº”: æµ‹è¯•å’Œä¼˜åŒ– (1.5å¤©)

#### ä»»åŠ¡ 5.1: å•å…ƒæµ‹è¯•

**æµ‹è¯•æ–‡ä»¶**:
- `tests/unit/hook-injector.test.js`
- `tests/unit/realtime-monitor.test.js`
- `tests/unit/crawl-scheduler.test.js`
- `tests/unit/data-deduplicator.test.js`

**é¢„è®¡æ—¶é—´**: 4å°æ—¶

---

#### ä»»åŠ¡ 5.2: é›†æˆæµ‹è¯•

**æµ‹è¯•åœºæ™¯**:
1. å®æ—¶ç›‘æ§æ•è·æµ‹è¯•
2. å†å²çˆ¬è™«å¢é‡æµ‹è¯•
3. æ•°æ®å»é‡éªŒè¯
4. åŒé‡ä¿éšœæµ‹è¯• (å®æ—¶å¤±è´¥ â†’ çˆ¬è™«è¡¥å……)
5. é…ç½®åŠ¨æ€æ›´æ–°æµ‹è¯•

**æµ‹è¯•è„šæœ¬**: `tests/integration/hybrid-monitoring.test.js`

**é¢„è®¡æ—¶é—´**: 6å°æ—¶

---

#### ä»»åŠ¡ 5.3: æ€§èƒ½ä¼˜åŒ–

**ä¼˜åŒ–é¡¹**:
- [ ] é’©å­æ³¨å…¥æ€§èƒ½ä¼˜åŒ–
- [ ] æ•°æ®å»é‡ç¼“å­˜ä¼˜åŒ–
- [ ] çˆ¬è™«ä»»åŠ¡é˜Ÿåˆ—ä¼˜åŒ–
- [ ] å†…å­˜ä½¿ç”¨ç›‘æ§

**é¢„è®¡æ—¶é—´**: 2å°æ—¶

---

## ğŸ“Š é…ç½®ç¤ºä¾‹

### å…¨åŠŸèƒ½é…ç½® (æ¨è)

```json
{
  "accountId": "douyin_account_123",
  "monitoringConfig": {
    "enableRealtimeMonitor": true,
    "enableCrawl": true,
    "crawlInterval": 5,
    "crawlMessages": true,
    "crawlComments": true
  }
}
```

### ä»…å®æ—¶ç›‘æ§

```json
{
  "accountId": "douyin_account_123",
  "monitoringConfig": {
    "enableRealtimeMonitor": true,
    "enableCrawl": false
  }
}
```

### ä»…å†å²çˆ¬è™«

```json
{
  "accountId": "douyin_account_123",
  "monitoringConfig": {
    "enableRealtimeMonitor": false,
    "enableCrawl": true,
    "crawlInterval": 10
  }
}
```

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### æµ‹è¯•ç”¨ä¾‹

| åœºæ™¯ | æµ‹è¯•æ–¹æ³• | é¢„æœŸç»“æœ |
|-----|---------|---------|
| å®æ—¶æ•è·ç§ä¿¡ | å‘é€æµ‹è¯•ç§ä¿¡ | ç«‹å³æ”¶åˆ°æ•°æ® |
| å®æ—¶æ•è·è¯„è®º | å‘é€æµ‹è¯•è¯„è®º | ç«‹å³æ”¶åˆ°æ•°æ® |
| çˆ¬è™«å¢é‡æŠ“å– | ç­‰å¾…5åˆ†é’Ÿåæ£€æŸ¥ | æŠ“å–åˆ°å†å²æ•°æ® |
| æ•°æ®å»é‡ | å®æ—¶å’Œçˆ¬è™«åŒæ—¶è¿è¡Œ | æ— é‡å¤æ•°æ® |
| é’©å­é‡æ–°æ³¨å…¥ | é¡µé¢åˆ·æ–° | è‡ªåŠ¨æ¢å¤ç›‘æ§ |
| é…ç½®åŠ¨æ€æ›´æ–° | ä¿®æ”¹é—´éš”é…ç½® | ç«‹å³ç”Ÿæ•ˆ |
| é”™è¯¯æ¢å¤ | æ¨¡æ‹Ÿé’©å­å¤±è´¥ | çˆ¬è™«è¡¥å……æ•°æ® |

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### ç›®æ ‡æ€§èƒ½

| æŒ‡æ ‡ | å®æ—¶ç›‘æ§ | å†å²çˆ¬è™« | è¯´æ˜ |
|-----|---------|---------|------|
| å»¶è¿Ÿ | 0-10ms | 5-10åˆ†é’Ÿ | å®æ—¶ä¸ºæ¨é€å»¶è¿Ÿ |
| CPU | ~0.01% | ~2% (æ‰§è¡Œæ—¶) | å•è´¦æˆ· |
| å†…å­˜ | ~1MB | ~5MB (æ‰§è¡Œæ—¶) | å•è´¦æˆ· |
| å‡†ç¡®ç‡ | 100% | 100% | åŒé‡ä¿éšœ |
| æ•°æ®é‡å¤ç‡ | <1% | <1% | æ™ºèƒ½å»é‡ |

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. ä»£ç éƒ¨ç½²

```bash
# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# å®‰è£…ä¾èµ–
npm run install:all

# æ•°æ®åº“è¿ç§»
cd packages/master && npm run migrate

# é‡å¯æœåŠ¡
pm2 restart all
```

### 2. é…ç½®æ›´æ–°

```bash
# æ›´æ–°é…ç½®æ–‡ä»¶
vim config/default-config.json

# æ›´æ–°è´¦æˆ·é…ç½®
# é€šè¿‡ Admin UI æˆ– API
```

### 3. éªŒè¯

```bash
# æ£€æŸ¥å®æ—¶ç›‘æ§çŠ¶æ€
curl http://localhost:3000/api/monitoring/status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs hiscrm-worker-1
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### å®æ—¶ç›‘æ§

1. **é¡µé¢å¯¼èˆª**: é’©å­åœ¨é¡µé¢åˆ·æ–°åå¤±æ•ˆ,éœ€è‡ªåŠ¨é‡æ–°æ³¨å…¥
2. **å†…å­˜ç®¡ç†**: é•¿æ—¶é—´è¿è¡Œéœ€å®šæœŸæ¸…ç†å»é‡ç¼“å­˜
3. **é”™è¯¯æ¢å¤**: é’©å­å¤±è´¥æ—¶åº”æœ‰çˆ¬è™«å…œåº•

### å†å²çˆ¬è™«

1. **é¢‘ç‡æ§åˆ¶**: 5-10åˆ†é’Ÿé—´éš”,é¿å…è¿‡äºé¢‘ç¹
2. **å¢é‡ä¼˜åŒ–**: ä½¿ç”¨æ—¶é—´æˆ³æˆªæ­¢,é¿å…å…¨é‡æŠ“å–
3. **èµ„æºå ç”¨**: çˆ¬è™«æ‰§è¡Œæ—¶CPUå’Œå†…å­˜ä¼šä¸Šå‡

### æ•°æ®å»é‡

1. **ç¼“å­˜å¤§å°**: é»˜è®¤ 10000 æ¡,æ ¹æ®å®é™…è°ƒæ•´
2. **TTL è®¾ç½®**: 24å°æ—¶è‡ªåŠ¨è¿‡æœŸ,é¿å…å†…å­˜æ³„æ¼
3. **å†²çªç­–ç•¥**: å®æ—¶æ•°æ®ä¼˜å…ˆçº§é«˜äºçˆ¬è™«æ•°æ®

---

## ğŸ“… å¼€å‘æ—¶é—´çº¿

| é˜¶æ®µ | ä»»åŠ¡ | å·¥ä½œæ—¥ | å®Œæˆæ—¥æœŸ |
|-----|------|--------|---------|
| é˜¶æ®µä¸€ | å®æ—¶ç›‘æ§æ ¸å¿ƒ | 2å¤© | D+2 |
| é˜¶æ®µäºŒ | å†å²çˆ¬è™«æ”¹é€  | 1.5å¤© | D+3.5 |
| é˜¶æ®µä¸‰ | Master æ”¹é€  | 1.5å¤© | D+5 |
| é˜¶æ®µå›› | é…ç½®ç®¡ç† | 0.5å¤© | D+5.5 |
| é˜¶æ®µäº” | æµ‹è¯•å’Œä¼˜åŒ– | 1.5å¤© | D+7 |

**æ€»è®¡**: 7ä¸ªå·¥ä½œæ—¥

---

## ğŸ¯ é‡Œç¨‹ç¢‘

- [ ] **M1** (D+2): å®æ—¶ç›‘æ§æ ¸å¿ƒå®Œæˆ,å¯ç‹¬ç«‹è¿è¡Œ
- [ ] **M2** (D+3.5): å†å²çˆ¬è™«æ”¹é€ å®Œæˆ,å¯ç‹¬ç«‹è¿è¡Œ
- [ ] **M3** (D+5): åŒç³»ç»Ÿé›†æˆå®Œæˆ,å¯ååŒå·¥ä½œ
- [ ] **M4** (D+5.5): é…ç½®åŒ–å®Œæˆ,å¯çµæ´»æ§åˆ¶
- [ ] **M5** (D+7): æµ‹è¯•å®Œæˆ,ç”Ÿäº§å°±ç»ª

---

## ğŸ“‹ éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- âœ… å®æ—¶ç›‘æ§èƒ½ç«‹å³æ•è·æ–°æ¶ˆæ¯/è¯„è®º
- âœ… å†å²çˆ¬è™«èƒ½æŒ‰é…ç½®é—´éš”æ‰§è¡Œ
- âœ… æ•°æ®å»é‡ç‡ > 99%
- âœ… é…ç½®æ–‡ä»¶èƒ½åŠ¨æ€ç”Ÿæ•ˆ
- âœ… é¡µé¢åˆ·æ–°åè‡ªåŠ¨æ¢å¤ç›‘æ§

### æ€§èƒ½éªŒæ”¶

- âœ… å®æ—¶ç›‘æ§å»¶è¿Ÿ < 100ms
- âœ… CPU å ç”¨ < 5% (å•è´¦æˆ·)
- âœ… å†…å­˜å ç”¨ < 300MB (å•è´¦æˆ·)
- âœ… æ•°æ®å®Œæ•´æ€§ 100%

### ç¨³å®šæ€§éªŒæ”¶

- âœ… è¿ç»­è¿è¡Œ 24 å°æ—¶æ— å´©æºƒ
- âœ… é”™è¯¯æ¢å¤æœºåˆ¶æœ‰æ•ˆ
- âœ… æ—¥å¿—å®Œæ•´å¯è¿½æº¯

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [å®æ—¶é’©å­ç›‘æ§æ–¹æ¡ˆ-é›¶å»¶è¿Ÿ-2025-11-06.md](./å®æ—¶é’©å­ç›‘æ§æ–¹æ¡ˆ-é›¶å»¶è¿Ÿ-2025-11-06.md)
- [React-Fiberå®æ—¶ç›‘æ§å®Œæ•´æ–¹æ¡ˆæ€»ç»“-ç§ä¿¡+è¯„è®º-2025-11-06.md](./React-Fiberå®æ—¶ç›‘æ§å®Œæ•´æ–¹æ¡ˆæ€»ç»“-ç§ä¿¡+è¯„è®º-2025-11-06.md)
- [test-realtime-hook-monitor-v2.js](../tests/test-realtime-hook-monitor-v2.js)

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å¾…å®¡æ ¸
**å¼€å‘çŠ¶æ€**: â³ å¾…å¼€å§‹
**ä¼˜å…ˆçº§**: ğŸ”¥ é«˜

