# 登录状态检测机制 - 最终实现方案

## 实现时间
2025-10-24 15:00

## 用户需求

> Worker 加载用户信息后，启动浏览器，就应该启动一次登录状态检测，然后每次蜘蛛任务之前，也应该检测一次。不用特意加心跳，在特定动作前，加一次检测即可。

## 实现方案

### 两个检测时机

#### ✅ 时机1：Worker 启动时（初始化检测）

**位置**：`packages/worker/src/index.js:147-191`

**时机**：Worker 初始化所有账户浏览器后，在启动监控任务之前

**效果**：
- Worker 启动后立即检测所有账户的真实登录状态
- 上报给 Master 更新数据库
- Admin Web 显示正确的登录状态

#### ✅ 时机2：每次爬虫任务执行前（实时检测）

**位置**：`packages/worker/src/handlers/monitor-task.js:156-192`

**时机**：每次定时监控任务执行时（15-30秒随机间隔）

**效果**：
- 每次爬取前都会实时检测登录状态
- 如果检测到未登录，跳过本次爬取并上报 Master
- 防止在未登录状态下执行爬取任务
- 可以在 30 秒内感知用户掉线

## 完整流程

```
Worker 启动
    ↓
初始化浏览器
    ↓
【检测点1】检查所有账户登录状态 ← Worker 启动时
    ↓
上报状态给 Master
    ↓
启动监控任务（15-30秒随机间隔）
    ↓
    ↓
【定时触发】
    ↓
【检测点2】检查登录状态 ← 每次爬取前
    ↓
已登录？
    ├─ Yes → 执行爬取任务 → 上报数据
    └─ No  → 跳过爬取 → 上报离线状态
         ↓
    等待下次调度（15-30秒后）
         ↓
    【检测点2】再次检查...
```

## 核心优势

### 1. 无需单独心跳机制 ✅
- 不需要单独的 setInterval 定时器
- 利用现有的监控任务调度机制
- 减少系统复杂度和资源消耗

### 2. 及时感知登录状态变化 ✅
- Worker 启动时立即检测（初始状态）
- 每次爬取前检测（15-30秒一次）
- 可以在 30 秒内感知用户掉线

### 3. 防止无效爬取 ✅
- 未登录时不执行爬取任务
- 节省系统资源和带宽
- 避免触发平台反爬虫机制

### 4. 实时同步状态到 Master ✅
- 检测到未登录立即上报 Master
- Master 更新数据库状态
- Admin Web 实时显示最新状态

## 修改文件

### 1. `packages/worker/src/index.js:147-191`
**修改内容**：Worker 启动时检查所有账户登录状态

### 2. `packages/worker/src/handlers/monitor-task.js:156-192`
**修改内容**：每次监控任务执行前实时检查登录状态

### 3. `packages/worker/src/platforms/douyin/platform.js:174-263`
**修改内容**：优化 `checkLoginStatus()` 方法，使用精确选择器

## 测试步骤

1. **重启 Worker**
2. **观察启动日志**：应该看到登录状态检测
3. **刷新 Admin Web**：查看状态是否正确
4. **等待爬虫执行**：每 15-30 秒会再次检测

## 相关文档

- `docs/Worker登录状态误报问题诊断.md`
- `docs/登录检测选择器优化-最终版.md`
