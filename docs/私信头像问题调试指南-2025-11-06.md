# 私信头像问题调试指南

**日期**: 2025-11-06
**目的**: 定位私信消息头像显示不正确的根本原因

## 问题描述

用户反馈: **"还是不对呀"**

私信消息头像显示仍然不正确。可能的问题:
1. Worker 爬取的私信消息没有 `sender_avatar` 字段
2. Master DataStore 保存消息时丢失了头像字段
3. Master 推送给前端时字段名映射错误
4. 前端接收到的数据不完整
5. 前端头像获取逻辑错误（使用了错误的来源）

## 已添加的调试日志

### 1. Master 端调试日志

#### 私信会话 topic 头像 (Line 668-677)

```javascript
// 🔍 调试: 打印前3个会话的头像数据
if (topics.length < 3) {
  logger.debug(`[IM-WS] Conversation topic avatar debug:`, {
    conversationId: conversation.conversationId,
    userName: conversation.userName,
    platform_user_avatar: conversation.platform_user_avatar,
    userAvatar: conversation.userAvatar,
    finalAvatar: topic.avatar
  });
}
```

**查看方式**: Master 服务器控制台
**查看时机**: 选择账户或切换到私信标签时
**预期输出**:
```
[IM-WS] Conversation topic avatar debug: {
  conversationId: 'conv_xxx',
  userName: '用户A',
  platform_user_avatar: 'https://...',  // ✅ 应该有值
  userAvatar: null,                     // 可能为 null
  finalAvatar: 'https://...'            // ✅ 应该有值
}
```

#### 私信消息头像 (Line 812-822)

```javascript
// 🔍 调试: 打印私信消息的 senderAvatar
if (msgs.indexOf(msg) < 3) {  // 只打印前3条消息
  logger.debug(`[IM-WS] Private message avatar debug:`, {
    messageId: msg.messageId,
    direction: msg.direction,
    isOutgoing,
    senderAvatar: msg.senderAvatar,
    senderId: msg.senderId,
    senderName: msg.senderName
  });
}
```

**查看方式**: Master 服务器控制台
**查看时机**: 点击私信会话查看消息列表时
**预期输出**:
```
[IM-WS] Private message avatar debug: {
  messageId: 'msg_xxx',
  direction: 'incoming',        // 'incoming' = 对方发的, 'outgoing' = 我发的
  isOutgoing: false,
  senderAvatar: 'https://...',  // ✅ 对方消息应该有值, 客服消息为 null
  senderId: 'user_xxx',
  senderName: '用户A'
}
```

### 2. 前端调试日志

#### 消息渲染头像逻辑 (Line 947-959)

```typescript
// 🔍 调试: 打印前3条消息的头像数据
if (activeTab === 'private' && selectedTopic && sortedMessages.indexOf(mainMsg) < 3) {
  console.log('[IM-Client] Private message avatar debug:', {
    messageId: mainMsg.id,
    direction: (mainMsg as any).direction,
    fromId: mainMsg.fromId,
    fromName: mainMsg.fromName,
    isReply,
    topicAvatar: selectedTopic?.avatar,
    msgAuthorAvatar: mainMsg.authorAvatar,
    finalAvatarSrc: avatarSrc
  })
}
```

**查看方式**: 浏览器开发者工具控制台 (F12)
**查看时机**: 点击私信会话查看消息列表时
**预期输出**:
```javascript
[IM-Client] Private message avatar debug: {
  messageId: 'msg_xxx',
  direction: 'incoming',            // 'incoming' = 对方发的, 'outgoing' = 我发的
  fromId: 'user_xxx',               // 客服消息为 'monitor_client'
  fromName: '用户A',                // 客服消息为 '客服'
  isReply: false,                   // ✅ 对方消息应该是 false, 客服消息应该是 true
  topicAvatar: 'https://...',       // ✅ 从 conversation 获取的对方头像
  msgAuthorAvatar: 'https://...',   // ⚠️ 可能为 null (私信消息不使用这个字段)
  finalAvatarSrc: 'https://...'     // ✅ 最终使用的头像 URL
}
```

**关键检查点**:
- `isReply` 判断是否正确
  - 对方消息: `isReply = false`
  - 客服消息: `isReply = true`
- `finalAvatarSrc` 的值
  - 对方消息: 应该是 `selectedTopic?.avatar`
  - 客服消息: 应该是 `undefined`

## 调试步骤

### 步骤 1: 启动服务并查看日志

```bash
# 终端 1: 启动 Master
npm run start:master

# 终端 2: 启动 Worker
npm run start:worker

# 终端 3: 启动 IM 客户端
cd packages/crm-pc-im && npm run dev
```

### 步骤 2: 在 IM 客户端触发调试

1. 打开浏览器访问 `http://localhost:5173/monitor`
2. 打开浏览器开发者工具 (F12)，切换到 Console 标签
3. 选择一个账户
4. 切换到"私信"标签 → **查看 Master 控制台的 topic 头像日志**
5. 点击一个私信会话 → **查看 Master 和前端控制台的消息头像日志**

### 步骤 3: 分析日志定位问题

按照数据流顺序检查:

#### 3.1 检查 Worker 数据源

查看 Worker 推送的私信会话数据:

**文件**: `packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js`

**关键字段** (Line 1150-1160):
```javascript
conversation: {
  conversationId: conversationShortId,
  platform_user_avatar: sender.avatar?.url_list?.[0] || null,  // ✅ 这个字段应该有值
  // ...
}
```

**关键字段** (Line 1297):
```javascript
sender_avatar: props.avatar || props.avatarThumb || null,  // ✅ 这个字段应该有值
```

**检查方式**: 在 Worker 控制台搜索 "Detected new message" 日志

#### 3.2 检查 Master DataStore

**预期**: DataStore 应该完整保存 Worker 推送的数据

**检查方式**: 在 Master 控制台查看调试日志

#### 3.3 检查 Master 推送数据

**预期**:
- topic 应该包含 `avatar: conversation.platform_user_avatar`
- message 应该包含 `authorAvatar: msg.senderAvatar`

**检查方式**: 在 Master 控制台查看 `[IM-WS]` 调试日志

#### 3.4 检查前端接收数据

**预期**:
- `selectedTopic.avatar` 应该有值
- `isReply` 判断应该正确

**检查方式**: 在浏览器控制台查看 `[IM-Client]` 调试日志

## 可能的问题和解决方案

### 问题 1: Worker 没有爬取到头像

**症状**:
```
[IM-WS] Conversation topic avatar debug: {
  platform_user_avatar: null,  // ❌ 为 null
  finalAvatar: null
}
```

**原因**: 抖音页面结构变化，Worker 爬取失败

**解决方案**: 更新 Worker 爬虫代码，调整选择器或提取逻辑

### 问题 2: DataStore 丢失了头像字段

**症状**: Master 推送的数据没有头像字段

**原因**: DataStore 的增量合并逻辑有问题

**解决方案**: 检查 `packages/master/src/data/data-store.js` 的 `updateAccountData()` 方法

### 问题 3: 字段名映射错误

**症状**:
```
[IM-WS] Conversation topic avatar debug: {
  platform_user_avatar: null,        // ❌ 为 null
  userAvatar: 'https://...',         // ✅ 有值但字段名错误
  finalAvatar: 'https://...'         // ✅ 有值 (fallback 成功)
}
```

**原因**: Worker 使用了不同的字段名

**解决方案**: 统一字段名或在 Master 中添加更多 fallback

### 问题 4: `isReply` 判断错误

**症状**:
```javascript
[IM-Client] Private message avatar debug: {
  direction: 'incoming',  // ✅ 对方消息
  isReply: true,          // ❌ 错误！应该是 false
  finalAvatarSrc: undefined  // ❌ 因为 isReply=true，头像被设为 undefined
}
```

**原因**: `direction` 字段可能没有正确设置

**解决方案**:
1. 检查 Worker 推送的消息是否包含 `direction` 字段
2. 如果没有，在 Master 中根据 `senderId` 推断 `direction`

### 问题 5: 前端头像来源错误

**症状**:
```javascript
[IM-Client] Private message avatar debug: {
  isReply: false,                 // ✅ 正确
  topicAvatar: null,              // ❌ conversation 没有头像
  msgAuthorAvatar: 'https://...', // ✅ 消息有头像
  finalAvatarSrc: null            // ❌ 使用了 topicAvatar (null)
}
```

**原因**: 应该 fallback 到 `msgAuthorAvatar`

**解决方案**: 修改前端头像获取逻辑:
```typescript
const avatarSrc = isReply ? undefined :
                  (selectedTopic?.avatar || mainMsg.authorAvatar)  // ✅ 添加 fallback
```

## 调试结果记录

### 测试环境

- Master 版本: ___
- Worker 版本: ___
- IM 客户端版本: ___
- 测试账户: ___
- 测试会话: ___

### Master 端日志

```
粘贴 Master 控制台的调试日志
```

### 前端日志

```
粘贴浏览器控制台的调试日志
```

### 问题定位

根据日志定位的问题:

- [ ] Worker 没有爬取到头像
- [ ] DataStore 丢失了头像字段
- [ ] 字段名映射错误
- [ ] `isReply` 判断错误
- [ ] 前端头像来源错误
- [ ] 其他问题: ___

### 解决方案

根据问题定位，采取的解决方案:

```
描述具体的修复方案和修改的代码
```

## 后续优化

调试完成后，应该:

1. **移除调试日志**: 删除所有 `🔍 调试:` 相关的代码
2. **更新文档**: 更新 [IM头像功能完整总结-2025-11-06.md](IM头像功能完整总结-2025-11-06.md)
3. **添加测试**: 编写单元测试和集成测试
4. **生产部署**: 部署修复后的代码

## 相关文档

- [IM头像功能完整总结-2025-11-06.md](IM头像功能完整总结-2025-11-06.md)
- [IM评论人头像显示功能实现.md](IM评论人头像显示功能实现.md)
- [02-MASTER-系统文档.md](02-MASTER-系统文档.md)
- [03-WORKER-系统文档.md](03-WORKER-系统文档.md)
