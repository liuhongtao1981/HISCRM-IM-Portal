# çˆ¬è™«ç»Ÿä¸€æ¥å£è§„èŒƒ

**ç‰ˆæœ¬**: v1.0
**æ—¥æœŸ**: 2025-10-24
**çŠ¶æ€**: ğŸ“ è‰æ¡ˆï¼ˆå¾…å®ç°ï¼‰

---

## ğŸ“‹ è§„èŒƒæ¦‚è¿°

æœ¬è§„èŒƒå®šä¹‰äº†æ‰€æœ‰å¹³å°çˆ¬è™«æ¨¡å—å¿…é¡»éµå¾ªçš„ç»Ÿä¸€æ¥å£å’Œæ•°æ®ç»“æ„æ ‡å‡†ï¼Œç¡®ä¿è·¨å¹³å°çš„ä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

### è®¾è®¡ç›®æ ‡

> "packages\worker\src\platforms\base\platform-base.js åº”è¯¥æœ‰æ•´ä½“é€šç”¨çš„è¿”å›ç»“æ„ï¼Œæ¯ä¸ªå¹³å°æœ€åæ¨é€ç»™åŸºç±»æ¥å£çš„éƒ½åº”è¯¥æ˜¯åŒ…è£…åçš„é€šç”¨ç»“æ„ï¼Œè¿™æ ·å°±ä¸ä¼šæœ‰è·¨å¹³å°å·®å¼‚ï¼Œæ¯ä¸ªå¹³å°åªéœ€è¦æŒ‰ç…§è§„å®šçš„æ¥å£å’Œç»“æ„è¿”å›å¯¹åº”çš„æ•°æ®å³å¯ã€‚"
>
> â€”â€” ç”¨æˆ·éœ€æ±‚

**æ ¸å¿ƒåŸåˆ™**:
1. âœ… ç»Ÿä¸€çš„è¿”å›æ•°æ®ç»“æ„
2. âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
3. âœ… ç»Ÿä¸€çš„æ—¥å¿—è®°å½•æ ¼å¼
4. âœ… ç»Ÿä¸€çš„é…ç½®å‚æ•°ç»“æ„
5. âœ… è·¨å¹³å°é›¶å·®å¼‚

---

## ğŸ¯ çˆ¬è™«ç±»å‹å®šä¹‰

### 1. è¯„è®ºçˆ¬è™« (Comments Crawler)

**åŠŸèƒ½**: çˆ¬å–ä¸€çº§è¯„è®ºå’ŒäºŒçº§/ä¸‰çº§è®¨è®º

**è¿”å›ç»“æ„**:
```typescript
interface CommentsCrawlResult {
  comments: Comment[];      // ä¸€çº§è¯„è®ºåˆ—è¡¨
  discussions: Discussion[]; // äºŒçº§/ä¸‰çº§å›å¤åˆ—è¡¨
  works: Work[];            // å…³è”çš„ä½œå“åˆ—è¡¨
  stats: CrawlStats;        // ç»Ÿè®¡ä¿¡æ¯
}
```

### 2. ç§ä¿¡çˆ¬è™« (Direct Messages Crawler)

**åŠŸèƒ½**: çˆ¬å–ç§ä¿¡å’Œä¼šè¯

**è¿”å›ç»“æ„**:
```typescript
interface DirectMessagesCrawlResult {
  directMessages: DirectMessage[];  // ç§ä¿¡åˆ—è¡¨
  conversations: Conversation[];    // ä¼šè¯åˆ—è¡¨
  stats: CrawlStats;                // ç»Ÿè®¡ä¿¡æ¯
}
```

### 3. ä½œå“çˆ¬è™« (Works Crawler)

**åŠŸèƒ½**: çˆ¬å–ç”¨æˆ·ä½œå“/å†…å®¹

**è¿”å›ç»“æ„**:
```typescript
interface WorksCrawlResult {
  works: Work[];          // ä½œå“åˆ—è¡¨
  stats: CrawlStats;      // ç»Ÿè®¡ä¿¡æ¯
}
```

---

## ğŸ“Š é€šç”¨æ•°æ®ç»“æ„å®šä¹‰

### åŸºç¡€ç±»å‹

```typescript
/**
 * å¹³å°æšä¸¾
 */
enum Platform {
  DOUYIN = 'douyin',           // æŠ–éŸ³
  XIAOHONGSHU = 'xiaohongshu', // å°çº¢ä¹¦
  WEIBO = 'weibo',             // å¾®åš
  BILIBILI = 'bilibili',       // Bç«™
  // ... å…¶ä»–å¹³å°
}

/**
 * ä½œå“ç±»å‹æšä¸¾
 */
enum WorkType {
  VIDEO = 'video',     // è§†é¢‘
  IMAGE = 'image',     // å›¾ç‰‡
  ARTICLE = 'article', // æ–‡ç« 
  AUDIO = 'audio',     // éŸ³é¢‘
  TEXT = 'text',       // çº¯æ–‡æœ¬
}

/**
 * æ¶ˆæ¯ç±»å‹æšä¸¾
 */
enum MessageType {
  TEXT = 'text',         // æ–‡æœ¬
  IMAGE = 'image',       // å›¾ç‰‡
  VIDEO = 'video',       // è§†é¢‘
  AUDIO = 'audio',       // è¯­éŸ³
  LINK = 'link',         // é“¾æ¥
  EMOJI = 'emoji',       // è¡¨æƒ…
  SYSTEM = 'system',     // ç³»ç»Ÿæ¶ˆæ¯
}
```

### 1. Commentï¼ˆè¯„è®ºï¼‰

```typescript
interface Comment {
  // ===== å¿…å¡«å­—æ®µ =====
  platform_comment_id: string;  // å¹³å°è¯„è®ºIDï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
  content: string;               // è¯„è®ºå†…å®¹
  author_name: string;           // è¯„è®ºè€…æ˜µç§°
  author_id: string;             // è¯„è®ºè€…ID
  create_time: number;           // åˆ›å»ºæ—¶é—´ï¼ˆç§’çº§æ—¶é—´æˆ³ï¼‰
  detected_at: number;           // æ£€æµ‹æ—¶é—´ï¼ˆç§’çº§æ—¶é—´æˆ³ï¼‰

  // ===== å¯é€‰å­—æ®µ =====
  author_avatar?: string;        // è¯„è®ºè€…å¤´åƒURL
  like_count?: number;           // ç‚¹èµæ•°ï¼ˆé»˜è®¤0ï¼‰
  reply_count?: number;          // å›å¤æ•°ï¼ˆé»˜è®¤0ï¼‰
  post_title?: string;           // å…³è”ä½œå“æ ‡é¢˜
  post_id?: string;              // å…³è”ä½œå“ID

  // ===== æ‰©å±•å­—æ®µï¼ˆå¹³å°ç‰¹æœ‰ï¼‰ =====
  extra?: Record<string, any>;   // å¹³å°ç‰¹æœ‰æ•°æ®
}
```

### 2. Discussionï¼ˆè®¨è®º/äºŒçº§å›å¤ï¼‰

```typescript
interface Discussion {
  // ===== å¿…å¡«å­—æ®µ =====
  platform_discussion_id: string;  // å¹³å°è®¨è®ºIDï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
  parent_comment_id: string;       // çˆ¶è¯„è®ºIDï¼ˆå¤–é”®ï¼‰
  content: string;                 // å›å¤å†…å®¹
  author_name: string;             // å›å¤è€…æ˜µç§°
  author_id: string;               // å›å¤è€…ID
  create_time: number;             // åˆ›å»ºæ—¶é—´ï¼ˆç§’çº§æ—¶é—´æˆ³ï¼‰
  detected_at: number;             // æ£€æµ‹æ—¶é—´ï¼ˆç§’çº§æ—¶é—´æˆ³ï¼‰

  // ===== å¯é€‰å­—æ®µ =====
  work_id?: string;                // å…³è”ä½œå“IDï¼ˆå¤–é”®ï¼‰
  author_avatar?: string;          // å›å¤è€…å¤´åƒURL
  like_count?: number;             // ç‚¹èµæ•°ï¼ˆé»˜è®¤0ï¼‰
  reply_count?: number;            // ä¸‰çº§å›å¤æ•°ï¼ˆé»˜è®¤0ï¼‰
  replied_to_user_id?: string;     // è¢«å›å¤è€…ID
  replied_to_user_name?: string;   // è¢«å›å¤è€…æ˜µç§°

  // ===== æ‰©å±•å­—æ®µï¼ˆå¹³å°ç‰¹æœ‰ï¼‰ =====
  extra?: Record<string, any>;     // å¹³å°ç‰¹æœ‰æ•°æ®
}
```

### 3. DirectMessageï¼ˆç§ä¿¡ï¼‰

```typescript
interface DirectMessage {
  // ===== å¿…å¡«å­—æ®µ =====
  platform_message_id: string;     // å¹³å°æ¶ˆæ¯IDï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
  conversation_id: string;         // ä¼šè¯IDï¼ˆå¤–é”®ï¼‰
  sender_id: string;               // å‘é€è€…ID
  sender_name: string;             // å‘é€è€…æ˜µç§°
  message_type: MessageType;       // æ¶ˆæ¯ç±»å‹
  content: string;                 // æ¶ˆæ¯å†…å®¹
  created_at: number;              // åˆ›å»ºæ—¶é—´ï¼ˆç§’çº§æ—¶é—´æˆ³ï¼‰
  detected_at: number;             // æ£€æµ‹æ—¶é—´ï¼ˆç§’çº§æ—¶é—´æˆ³ï¼‰

  // ===== å¯é€‰å­—æ®µ =====
  sender_avatar?: string;          // å‘é€è€…å¤´åƒURL
  is_read?: boolean;               // æ˜¯å¦å·²è¯»ï¼ˆé»˜è®¤falseï¼‰
  status?: string;                 // æ¶ˆæ¯çŠ¶æ€ï¼ˆsent/delivered/readï¼‰
  reply_to_message_id?: string;    // è¢«å›å¤çš„æ¶ˆæ¯ID

  // ===== åª’ä½“å­—æ®µ =====
  media_url?: string;              // åª’ä½“æ–‡ä»¶URL
  media_type?: string;             // åª’ä½“ç±»å‹
  media_size?: number;             // åª’ä½“æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
  media_duration?: number;         // åª’ä½“æ—¶é•¿ï¼ˆç§’ï¼‰

  // ===== æ‰©å±•å­—æ®µï¼ˆå¹³å°ç‰¹æœ‰ï¼‰ =====
  extra?: Record<string, any>;     // å¹³å°ç‰¹æœ‰æ•°æ®
}
```

### 4. Conversationï¼ˆä¼šè¯ï¼‰

```typescript
interface Conversation {
  // ===== å¿…å¡«å­—æ®µ =====
  platform_conversation_id: string;  // å¹³å°ä¼šè¯IDï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
  participant_id: string;            // å¯¹æ–¹ç”¨æˆ·ID
  participant_name: string;          // å¯¹æ–¹ç”¨æˆ·æ˜µç§°
  last_message_time: number;         // æœ€åæ¶ˆæ¯æ—¶é—´ï¼ˆç§’çº§æ—¶é—´æˆ³ï¼‰
  detected_at: number;               // æ£€æµ‹æ—¶é—´ï¼ˆç§’çº§æ—¶é—´æˆ³ï¼‰

  // ===== å¯é€‰å­—æ®µ =====
  participant_avatar?: string;       // å¯¹æ–¹ç”¨æˆ·å¤´åƒURL
  unread_count?: number;             // æœªè¯»æ•°ï¼ˆé»˜è®¤0ï¼‰
  last_message_content?: string;     // æœ€åä¸€æ¡æ¶ˆæ¯å†…å®¹
  last_message_type?: MessageType;   // æœ€åä¸€æ¡æ¶ˆæ¯ç±»å‹
  is_pinned?: boolean;               // æ˜¯å¦ç½®é¡¶ï¼ˆé»˜è®¤falseï¼‰
  is_muted?: boolean;                // æ˜¯å¦å…æ‰“æ‰°ï¼ˆé»˜è®¤falseï¼‰
  status?: string;                   // ä¼šè¯çŠ¶æ€ï¼ˆactive/archivedï¼‰

  // ===== æ‰©å±•å­—æ®µï¼ˆå¹³å°ç‰¹æœ‰ï¼‰ =====
  extra?: Record<string, any>;       // å¹³å°ç‰¹æœ‰æ•°æ®
}
```

### 5. Workï¼ˆä½œå“ï¼‰

```typescript
interface Work {
  // ===== å¿…å¡«å­—æ®µ =====
  platform_work_id: string;        // å¹³å°ä½œå“IDï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
  work_type: WorkType;             // ä½œå“ç±»å‹
  title: string;                   // ä½œå“æ ‡é¢˜
  author_id: string;               // ä½œè€…ID
  author_name: string;             // ä½œè€…æ˜µç§°
  publish_time: number;            // å‘å¸ƒæ—¶é—´ï¼ˆç§’çº§æ—¶é—´æˆ³ï¼‰
  detected_at: number;             // æ£€æµ‹æ—¶é—´ï¼ˆç§’çº§æ—¶é—´æˆ³ï¼‰

  // ===== å¯é€‰å­—æ®µ =====
  description?: string;            // ä½œå“æè¿°
  cover_url?: string;              // å°é¢å›¾URL
  content_url?: string;            // å†…å®¹URLï¼ˆè§†é¢‘/å›¾ç‰‡ç­‰ï¼‰
  author_avatar?: string;          // ä½œè€…å¤´åƒURL

  // ===== ç»Ÿè®¡å­—æ®µ =====
  view_count?: number;             // æ’­æ”¾/æµè§ˆæ•°
  like_count?: number;             // ç‚¹èµæ•°
  comment_count?: number;          // è¯„è®ºæ•°
  share_count?: number;            // åˆ†äº«æ•°
  favorite_count?: number;         // æ”¶è—æ•°

  // ===== æ‰©å±•å­—æ®µï¼ˆå¹³å°ç‰¹æœ‰ï¼‰ =====
  extra?: Record<string, any>;     // å¹³å°ç‰¹æœ‰æ•°æ®
}
```

### 6. CrawlStatsï¼ˆçˆ¬å–ç»Ÿè®¡ï¼‰

```typescript
interface CrawlStats {
  // ===== åŸºç¡€ç»Ÿè®¡ =====
  crawl_time: number;              // çˆ¬å–å®Œæˆæ—¶é—´ï¼ˆç§’çº§æ—¶é—´æˆ³ï¼‰
  duration_ms?: number;            // çˆ¬å–è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰

  // ===== æ•°æ®ç»Ÿè®¡ =====
  total_count?: number;            // æ€»æ•°æ®é‡
  new_count?: number;              // æ–°å¢æ•°æ®é‡
  updated_count?: number;          // æ›´æ–°æ•°æ®é‡
  skipped_count?: number;          // è·³è¿‡æ•°æ®é‡
  failed_count?: number;           // å¤±è´¥æ•°æ®é‡

  // ===== APIç»Ÿè®¡ =====
  api_calls?: number;              // APIè°ƒç”¨æ¬¡æ•°
  api_success?: number;            // APIæˆåŠŸæ¬¡æ•°
  api_failed?: number;             // APIå¤±è´¥æ¬¡æ•°

  // ===== æ‰©å±•ç»Ÿè®¡ =====
  extra?: Record<string, any>;     // å…¶ä»–ç»Ÿè®¡æ•°æ®
}
```

---

## ğŸ”§ ç»Ÿä¸€çˆ¬è™«æ¥å£

### PlatformBase åŸºç±»å®šä¹‰

```typescript
/**
 * å¹³å°çˆ¬è™«åŸºç±»
 * æ‰€æœ‰å¹³å°å¿…é¡»ç»§æ‰¿æ­¤ç±»å¹¶å®ç°å…¶æŠ½è±¡æ–¹æ³•
 */
abstract class PlatformBase {
  /**
   * è·å–å¹³å°åç§°
   * @returns å¹³å°æ ‡è¯†ç¬¦ï¼ˆå¦‚ 'douyin', 'xiaohongshu'ï¼‰
   */
  abstract getName(): Platform;

  /**
   * åˆå§‹åŒ–å¹³å°
   * @param account è´¦æˆ·ä¿¡æ¯
   */
  abstract initialize(account: Account): Promise<void>;

  /**
   * å¯åŠ¨ç™»å½•æµç¨‹
   * @param options ç™»å½•é€‰é¡¹
   */
  abstract startLogin(options: LoginOptions): Promise<void>;

  /**
   * çˆ¬å–è¯„è®ºå’Œè®¨è®ºï¼ˆç»Ÿä¸€æ¥å£ï¼‰
   * @param account è´¦æˆ·ä¿¡æ¯
   * @param options çˆ¬å–é€‰é¡¹
   * @returns æ ‡å‡†åŒ–çš„è¯„è®ºçˆ¬å–ç»“æœ
   */
  abstract crawlComments(
    account: Account,
    options?: CrawlOptions
  ): Promise<CommentsCrawlResult>;

  /**
   * çˆ¬å–ç§ä¿¡å’Œä¼šè¯ï¼ˆç»Ÿä¸€æ¥å£ï¼‰
   * @param account è´¦æˆ·ä¿¡æ¯
   * @param options çˆ¬å–é€‰é¡¹
   * @returns æ ‡å‡†åŒ–çš„ç§ä¿¡çˆ¬å–ç»“æœ
   */
  abstract crawlDirectMessages(
    account: Account,
    options?: CrawlOptions
  ): Promise<DirectMessagesCrawlResult>;

  /**
   * çˆ¬å–ä½œå“ï¼ˆç»Ÿä¸€æ¥å£ï¼‰
   * @param account è´¦æˆ·ä¿¡æ¯
   * @param options çˆ¬å–é€‰é¡¹
   * @returns æ ‡å‡†åŒ–çš„ä½œå“çˆ¬å–ç»“æœ
   */
  abstract crawlWorks(
    account: Account,
    options?: CrawlOptions
  ): Promise<WorksCrawlResult>;

  /**
   * å‘é€è¯„è®ºæ•°æ®åˆ° Masterï¼ˆé€šç”¨æ–¹æ³•ï¼‰
   * @param account è´¦æˆ·ä¿¡æ¯
   * @param comments è¯„è®ºåˆ—è¡¨
   * @param works å…³è”ä½œå“åˆ—è¡¨
   */
  protected sendCommentsToMaster(
    account: Account,
    comments: Comment[],
    works?: Work[]
  ): Promise<void>;

  /**
   * å‘é€è®¨è®ºæ•°æ®åˆ° Masterï¼ˆé€šç”¨æ–¹æ³•ï¼‰
   * @param account è´¦æˆ·ä¿¡æ¯
   * @param discussions è®¨è®ºåˆ—è¡¨
   */
  protected sendDiscussionsToMaster(
    account: Account,
    discussions: Discussion[]
  ): Promise<void>;

  /**
   * å‘é€ç§ä¿¡æ•°æ®åˆ° Masterï¼ˆé€šç”¨æ–¹æ³•ï¼‰
   * @param account è´¦æˆ·ä¿¡æ¯
   * @param messages ç§ä¿¡åˆ—è¡¨
   */
  protected sendDirectMessagesToMaster(
    account: Account,
    messages: DirectMessage[]
  ): Promise<void>;

  /**
   * å‘é€ä¼šè¯æ•°æ®åˆ° Masterï¼ˆé€šç”¨æ–¹æ³•ï¼‰
   * @param account è´¦æˆ·ä¿¡æ¯
   * @param conversations ä¼šè¯åˆ—è¡¨
   */
  protected sendConversationsToMaster(
    account: Account,
    conversations: Conversation[]
  ): Promise<void>;

  /**
   * å‘é€ä½œå“æ•°æ®åˆ° Masterï¼ˆé€šç”¨æ–¹æ³•ï¼‰
   * @param account è´¦æˆ·ä¿¡æ¯
   * @param works ä½œå“åˆ—è¡¨
   */
  protected sendWorksToMaster(
    account: Account,
    works: Work[]
  ): Promise<void>;
}
```

### CrawlOptionsï¼ˆçˆ¬å–é€‰é¡¹ï¼‰

```typescript
interface CrawlOptions {
  // ===== æ•°é‡é™åˆ¶ =====
  maxItems?: number;               // æœ€å¤§çˆ¬å–æ•°é‡
  maxPages?: number;               // æœ€å¤§ç¿»é¡µæ•°

  // ===== æ—¶é—´èŒƒå›´ =====
  startTime?: number;              // å¼€å§‹æ—¶é—´ï¼ˆç§’çº§æ—¶é—´æˆ³ï¼‰
  endTime?: number;                // ç»“æŸæ—¶é—´ï¼ˆç§’çº§æ—¶é—´æˆ³ï¼‰

  // ===== å¢é‡çˆ¬å– =====
  lastCrawlTime?: number;          // ä¸Šæ¬¡çˆ¬å–æ—¶é—´
  onlyNew?: boolean;               // ä»…çˆ¬å–æ–°æ•°æ®

  // ===== åŠŸèƒ½å¼€å…³ =====
  includeDiscussions?: boolean;    // æ˜¯å¦åŒ…å«è®¨è®ºï¼ˆé»˜è®¤trueï¼‰
  includeStats?: boolean;          // æ˜¯å¦åŒ…å«ç»Ÿè®¡ï¼ˆé»˜è®¤trueï¼‰

  // ===== æ€§èƒ½æ§åˆ¶ =====
  timeout?: number;                // è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  retryCount?: number;             // é‡è¯•æ¬¡æ•°
  concurrency?: number;            // å¹¶å‘æ•°

  // ===== æ‰©å±•é€‰é¡¹ =====
  extra?: Record<string, any>;     // å¹³å°ç‰¹æœ‰é€‰é¡¹
}
```

---

## ğŸ“ å®ç°ç¤ºä¾‹

### æŠ–éŸ³å¹³å°å®ç°

```typescript
class DouyinPlatform extends PlatformBase {
  getName(): Platform {
    return Platform.DOUYIN;
  }

  async crawlComments(
    account: Account,
    options: CrawlOptions = {}
  ): Promise<CommentsCrawlResult> {
    try {
      // 1. è·å–é¡µé¢
      const page = await this.getOrCreatePage(account.id, 'spider2');

      // 2. è°ƒç”¨ä¸“ç”¨çˆ¬è™«æ¨¡å—
      const rawResult = await crawlCommentsV2(page, account, options);

      // 3. æ•°æ®æ ‡å‡†åŒ–ï¼ˆå°†å¹³å°ç‰¹æœ‰æ•°æ®è½¬æ¢ä¸ºé€šç”¨æ ¼å¼ï¼‰
      const standardizedResult = this.standardizeCommentsResult(rawResult);

      // 4. æ•°æ®ä¸ŠæŠ¥
      await this.sendCommentsToMaster(account, standardizedResult.comments);
      await this.sendDiscussionsToMaster(account, standardizedResult.discussions);

      // 5. è¿”å›æ ‡å‡†æ ¼å¼
      return standardizedResult;
    } catch (error) {
      throw this.standardizeError(error);
    }
  }

  /**
   * å°†æŠ–éŸ³ç‰¹æœ‰æ•°æ®æ ‡å‡†åŒ–ä¸ºé€šç”¨æ ¼å¼
   */
  private standardizeCommentsResult(
    rawResult: any
  ): CommentsCrawlResult {
    return {
      comments: rawResult.comments.map(c => this.standardizeComment(c)),
      discussions: rawResult.discussions.map(d => this.standardizeDiscussion(d)),
      works: rawResult.works.map(w => this.standardizeWork(w)),
      stats: this.standardizeStats(rawResult.stats)
    };
  }

  /**
   * æ ‡å‡†åŒ–å•æ¡è¯„è®ºæ•°æ®
   */
  private standardizeComment(raw: any): Comment {
    return {
      // å¿…å¡«å­—æ®µ
      platform_comment_id: raw.platform_comment_id,
      content: raw.content,
      author_name: raw.author_name,
      author_id: raw.author_id,
      create_time: raw.create_time,
      detected_at: raw.detected_at,

      // å¯é€‰å­—æ®µ
      author_avatar: raw.author_avatar,
      like_count: raw.like_count || 0,
      reply_count: raw.reply_count || 0,
      post_title: raw.post_title,
      post_id: raw.post_id,

      // æ‰©å±•å­—æ®µï¼ˆå¹³å°ç‰¹æœ‰ï¼‰
      extra: {
        digg_count: raw.digg_count,  // æŠ–éŸ³ç‰¹æœ‰ï¼šç‚¹èµæ•°
        // ... å…¶ä»–æŠ–éŸ³ç‰¹æœ‰å­—æ®µ
      }
    };
  }
}
```

---

## ğŸ”„ æ•°æ®æµè½¬æ ‡å‡†

### 1. çˆ¬è™«æ¨¡å— â†’ Platform å±‚

```
crawl-comments.js (Platform-Specific)
  â†“ è¿”å›å¹³å°ç‰¹æœ‰æ ¼å¼
platform.js
  â†“ standardize*() æ–¹æ³•æ ‡å‡†åŒ–
Standard Format (é€šç”¨æ ¼å¼)
```

### 2. Platform å±‚ â†’ Master

```
Standard Format (é€šç”¨æ ¼å¼)
  â†“ sendToMaster() æ–¹æ³•
Socket.IO Event
  â†“
Master receives
  â†“ å­˜å…¥æ•°æ®åº“
Standard Database Schema
```

---

## âœ… æ•°æ®éªŒè¯è§„åˆ™

### å¿…å¡«å­—æ®µéªŒè¯

```typescript
/**
 * éªŒè¯è¯„è®ºæ•°æ®å®Œæ•´æ€§
 */
function validateComment(comment: Comment): boolean {
  const requiredFields = [
    'platform_comment_id',
    'content',
    'author_name',
    'author_id',
    'create_time',
    'detected_at'
  ];

  for (const field of requiredFields) {
    if (!(field in comment) || comment[field] === null || comment[field] === undefined) {
      throw new ValidationError(`Missing required field: ${field}`);
    }
  }

  return true;
}
```

### æ•°æ®ç±»å‹éªŒè¯

```typescript
/**
 * éªŒè¯å­—æ®µç±»å‹
 */
function validateFieldTypes(data: any, schema: Schema): boolean {
  for (const [field, type] of Object.entries(schema)) {
    if (data[field] !== undefined && typeof data[field] !== type) {
      throw new ValidationError(
        `Field ${field} must be ${type}, got ${typeof data[field]}`
      );
    }
  }

  return true;
}
```

---

## ğŸ› ï¸ é”™è¯¯å¤„ç†æ ‡å‡†

### ç»Ÿä¸€é”™è¯¯ç±»å‹

```typescript
/**
 * çˆ¬è™«é”™è¯¯åŸºç±»
 */
class CrawlerError extends Error {
  code: string;
  platform: Platform;
  details?: any;

  constructor(message: string, code: string, platform: Platform, details?: any) {
    super(message);
    this.code = code;
    this.platform = platform;
    this.details = details;
  }
}

/**
 * é”™è¯¯ä»£ç æšä¸¾
 */
enum ErrorCode {
  NETWORK_ERROR = 'NETWORK_ERROR',
  AUTH_ERROR = 'AUTH_ERROR',
  RATE_LIMIT = 'RATE_LIMIT',
  PARSE_ERROR = 'PARSE_ERROR',
  VALIDATION_ERROR = 'VALIDATION_ERROR',
  TIMEOUT = 'TIMEOUT',
  UNKNOWN = 'UNKNOWN'
}
```

### é”™è¯¯æ ‡å‡†åŒ–

```typescript
/**
 * å°†å¹³å°ç‰¹æœ‰é”™è¯¯è½¬æ¢ä¸ºæ ‡å‡†é”™è¯¯
 */
function standardizeError(error: any, platform: Platform): CrawlerError {
  if (error instanceof CrawlerError) {
    return error;
  }

  // æ ¹æ®é”™è¯¯ç±»å‹è½¬æ¢
  if (error.message?.includes('timeout')) {
    return new CrawlerError(error.message, ErrorCode.TIMEOUT, platform);
  }

  if (error.message?.includes('401') || error.message?.includes('403')) {
    return new CrawlerError(error.message, ErrorCode.AUTH_ERROR, platform);
  }

  // é»˜è®¤æœªçŸ¥é”™è¯¯
  return new CrawlerError(
    error.message || 'Unknown error',
    ErrorCode.UNKNOWN,
    platform,
    { originalError: error }
  );
}
```

---

## ğŸ“ æ—¥å¿—è®°å½•æ ‡å‡†

### æ—¥å¿—çº§åˆ«

```typescript
enum LogLevel {
  DEBUG = 'debug',
  INFO = 'info',
  WARN = 'warn',
  ERROR = 'error'
}
```

### æ—¥å¿—æ ¼å¼

```typescript
interface LogEntry {
  timestamp: number;           // æ—¶é—´æˆ³
  level: LogLevel;             // æ—¥å¿—çº§åˆ«
  platform: Platform;          // å¹³å°æ ‡è¯†
  accountId: string;           // è´¦æˆ·ID
  module: string;              // æ¨¡å—åç§°ï¼ˆå¦‚ 'crawlComments'ï¼‰
  message: string;             // æ—¥å¿—æ¶ˆæ¯
  data?: any;                  // é™„åŠ æ•°æ®
}
```

### æ—¥å¿—è®°å½•ç¤ºä¾‹

```typescript
logger.info(`[${platform}][crawlComments] Starting crawl`, {
  accountId: account.id,
  options: options
});

logger.debug(`[${platform}][crawlComments] API intercepted`, {
  url: url,
  count: comments.length
});

logger.error(`[${platform}][crawlComments] Crawl failed`, {
  accountId: account.id,
  error: error.message,
  stack: error.stack
});
```

---

## ğŸš€ è¿ç§»æŒ‡å—

### ç°æœ‰å¹³å°è¿ç§»æ­¥éª¤

1. **å®ç°æ ‡å‡†åŒ–æ–¹æ³•**
   ```typescript
   private standardizeCommentsResult(raw: any): CommentsCrawlResult
   private standardizeComment(raw: any): Comment
   private standardizeDiscussion(raw: any): Discussion
   ```

2. **æ›´æ–°çˆ¬è™«æ–¹æ³•ç­¾å**
   ```typescript
   async crawlComments(
     account: Account,
     options?: CrawlOptions
   ): Promise<CommentsCrawlResult>
   ```

3. **æ·»åŠ æ•°æ®éªŒè¯**
   ```typescript
   validateComment(comment);
   validateDiscussion(discussion);
   ```

4. **ç»Ÿä¸€é”™è¯¯å¤„ç†**
   ```typescript
   catch (error) {
     throw this.standardizeError(error);
   }
   ```

5. **æ›´æ–°æ—¥å¿—æ ¼å¼**
   ```typescript
   logger.info(`[${this.getName()}][crawlComments] ...`);
   ```

---

## ğŸ“Œ å¾…åŠäº‹é¡¹

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰

- [ ] åœ¨ `platform-base.js` ä¸­å®šä¹‰æ¥å£å’Œç±»å‹
- [ ] æŠ–éŸ³å¹³å°å®ç°æ ‡å‡†åŒ–æ–¹æ³•
- [ ] ç¼–å†™æ•°æ®éªŒè¯å·¥å…·å‡½æ•°
- [ ] ç¼–å†™é”™è¯¯æ ‡å‡†åŒ–å·¥å…·å‡½æ•°
- [ ] æ›´æ–°å•å…ƒæµ‹è¯•

### ä¸­æœŸï¼ˆ1ä¸ªæœˆï¼‰

- [ ] å°çº¢ä¹¦å¹³å°é€‚é…æ–°æ¥å£
- [ ] å¾®åšå¹³å°é€‚é…æ–°æ¥å£
- [ ] Bç«™å¹³å°é€‚é…æ–°æ¥å£
- [ ] ç¼–å†™æ¥å£å…¼å®¹æ€§æµ‹è¯•

### é•¿æœŸï¼ˆæŒç»­ï¼‰

- [ ] ç›‘æ§è·¨å¹³å°æ•°æ®ä¸€è‡´æ€§
- [ ] æ”¶é›†åé¦ˆä¼˜åŒ–æ¥å£è®¾è®¡
- [ ] æ‰©å±•æ”¯æŒæ›´å¤šå¹³å°

---

**è§„èŒƒç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-10-24
**ç»´æŠ¤è€…**: Claude Code Assistant
**ä¸‹æ¬¡å®¡æŸ¥**: 2025-11-24
