# 爬虫统一接口规范

**版本**: v1.0
**日期**: 2025-10-24
**状态**: 📝 草案（待实现）

---

## 📋 规范概述

本规范定义了所有平台爬虫模块必须遵循的统一接口和数据结构标准，确保跨平台的一致性和可维护性。

### 设计目标

> "packages\worker\src\platforms\base\platform-base.js 应该有整体通用的返回结构，每个平台最后推送给基类接口的都应该是包装后的通用结构，这样就不会有跨平台差异，每个平台只需要按照规定的接口和结构返回对应的数据即可。"
>
> —— 用户需求

**核心原则**:
1. ✅ 统一的返回数据结构
2. ✅ 统一的错误处理机制
3. ✅ 统一的日志记录格式
4. ✅ 统一的配置参数结构
5. ✅ 跨平台零差异

---

## 🎯 爬虫类型定义

### 1. 评论爬虫 (Comments Crawler)

**功能**: 爬取一级评论和二级/三级讨论

**返回结构**:
```typescript
interface CommentsCrawlResult {
  comments: Comment[];      // 一级评论列表
  discussions: Discussion[]; // 二级/三级回复列表
  works: Work[];            // 关联的作品列表
  stats: CrawlStats;        // 统计信息
}
```

### 2. 私信爬虫 (Direct Messages Crawler)

**功能**: 爬取私信和会话

**返回结构**:
```typescript
interface DirectMessagesCrawlResult {
  directMessages: DirectMessage[];  // 私信列表
  conversations: Conversation[];    // 会话列表
  stats: CrawlStats;                // 统计信息
}
```

### 3. 作品爬虫 (Works Crawler)

**功能**: 爬取用户作品/内容

**返回结构**:
```typescript
interface WorksCrawlResult {
  works: Work[];          // 作品列表
  stats: CrawlStats;      // 统计信息
}
```

---

## 📊 通用数据结构定义

### 基础类型

```typescript
/**
 * 平台枚举
 */
enum Platform {
  DOUYIN = 'douyin',           // 抖音
  XIAOHONGSHU = 'xiaohongshu', // 小红书
  WEIBO = 'weibo',             // 微博
  BILIBILI = 'bilibili',       // B站
  // ... 其他平台
}

/**
 * 作品类型枚举
 */
enum WorkType {
  VIDEO = 'video',     // 视频
  IMAGE = 'image',     // 图片
  ARTICLE = 'article', // 文章
  AUDIO = 'audio',     // 音频
  TEXT = 'text',       // 纯文本
}

/**
 * 消息类型枚举
 */
enum MessageType {
  TEXT = 'text',         // 文本
  IMAGE = 'image',       // 图片
  VIDEO = 'video',       // 视频
  AUDIO = 'audio',       // 语音
  LINK = 'link',         // 链接
  EMOJI = 'emoji',       // 表情
  SYSTEM = 'system',     // 系统消息
}
```

### 1. Comment（评论）

```typescript
interface Comment {
  // ===== 必填字段 =====
  platform_comment_id: string;  // 平台评论ID（唯一标识）
  content: string;               // 评论内容
  author_name: string;           // 评论者昵称
  author_id: string;             // 评论者ID
  create_time: number;           // 创建时间（秒级时间戳）
  detected_at: number;           // 检测时间（秒级时间戳）

  // ===== 可选字段 =====
  author_avatar?: string;        // 评论者头像URL
  like_count?: number;           // 点赞数（默认0）
  reply_count?: number;          // 回复数（默认0）
  post_title?: string;           // 关联作品标题
  post_id?: string;              // 关联作品ID

  // ===== 扩展字段（平台特有） =====
  extra?: Record<string, any>;   // 平台特有数据
}
```

### 2. Discussion（讨论/二级回复）

```typescript
interface Discussion {
  // ===== 必填字段 =====
  platform_discussion_id: string;  // 平台讨论ID（唯一标识）
  parent_comment_id: string;       // 父评论ID（外键）
  content: string;                 // 回复内容
  author_name: string;             // 回复者昵称
  author_id: string;               // 回复者ID
  create_time: number;             // 创建时间（秒级时间戳）
  detected_at: number;             // 检测时间（秒级时间戳）

  // ===== 可选字段 =====
  work_id?: string;                // 关联作品ID（外键）
  author_avatar?: string;          // 回复者头像URL
  like_count?: number;             // 点赞数（默认0）
  reply_count?: number;            // 三级回复数（默认0）
  replied_to_user_id?: string;     // 被回复者ID
  replied_to_user_name?: string;   // 被回复者昵称

  // ===== 扩展字段（平台特有） =====
  extra?: Record<string, any>;     // 平台特有数据
}
```

### 3. DirectMessage（私信）

```typescript
interface DirectMessage {
  // ===== 必填字段 =====
  platform_message_id: string;     // 平台消息ID（唯一标识）
  conversation_id: string;         // 会话ID（外键）
  sender_id: string;               // 发送者ID
  sender_name: string;             // 发送者昵称
  message_type: MessageType;       // 消息类型
  content: string;                 // 消息内容
  created_at: number;              // 创建时间（秒级时间戳）
  detected_at: number;             // 检测时间（秒级时间戳）

  // ===== 可选字段 =====
  sender_avatar?: string;          // 发送者头像URL
  is_read?: boolean;               // 是否已读（默认false）
  status?: string;                 // 消息状态（sent/delivered/read）
  reply_to_message_id?: string;    // 被回复的消息ID

  // ===== 媒体字段 =====
  media_url?: string;              // 媒体文件URL
  media_type?: string;             // 媒体类型
  media_size?: number;             // 媒体文件大小（字节）
  media_duration?: number;         // 媒体时长（秒）

  // ===== 扩展字段（平台特有） =====
  extra?: Record<string, any>;     // 平台特有数据
}
```

### 4. Conversation（会话）

```typescript
interface Conversation {
  // ===== 必填字段 =====
  platform_conversation_id: string;  // 平台会话ID（唯一标识）
  participant_id: string;            // 对方用户ID
  participant_name: string;          // 对方用户昵称
  last_message_time: number;         // 最后消息时间（秒级时间戳）
  detected_at: number;               // 检测时间（秒级时间戳）

  // ===== 可选字段 =====
  participant_avatar?: string;       // 对方用户头像URL
  unread_count?: number;             // 未读数（默认0）
  last_message_content?: string;     // 最后一条消息内容
  last_message_type?: MessageType;   // 最后一条消息类型
  is_pinned?: boolean;               // 是否置顶（默认false）
  is_muted?: boolean;                // 是否免打扰（默认false）
  status?: string;                   // 会话状态（active/archived）

  // ===== 扩展字段（平台特有） =====
  extra?: Record<string, any>;       // 平台特有数据
}
```

### 5. Work（作品）

```typescript
interface Work {
  // ===== 必填字段 =====
  platform_work_id: string;        // 平台作品ID（唯一标识）
  work_type: WorkType;             // 作品类型
  title: string;                   // 作品标题
  author_id: string;               // 作者ID
  author_name: string;             // 作者昵称
  publish_time: number;            // 发布时间（秒级时间戳）
  detected_at: number;             // 检测时间（秒级时间戳）

  // ===== 可选字段 =====
  description?: string;            // 作品描述
  cover_url?: string;              // 封面图URL
  content_url?: string;            // 内容URL（视频/图片等）
  author_avatar?: string;          // 作者头像URL

  // ===== 统计字段 =====
  view_count?: number;             // 播放/浏览数
  like_count?: number;             // 点赞数
  comment_count?: number;          // 评论数
  share_count?: number;            // 分享数
  favorite_count?: number;         // 收藏数

  // ===== 扩展字段（平台特有） =====
  extra?: Record<string, any>;     // 平台特有数据
}
```

### 6. CrawlStats（爬取统计）

```typescript
interface CrawlStats {
  // ===== 基础统计 =====
  crawl_time: number;              // 爬取完成时间（秒级时间戳）
  duration_ms?: number;            // 爬取耗时（毫秒）

  // ===== 数据统计 =====
  total_count?: number;            // 总数据量
  new_count?: number;              // 新增数据量
  updated_count?: number;          // 更新数据量
  skipped_count?: number;          // 跳过数据量
  failed_count?: number;           // 失败数据量

  // ===== API统计 =====
  api_calls?: number;              // API调用次数
  api_success?: number;            // API成功次数
  api_failed?: number;             // API失败次数

  // ===== 扩展统计 =====
  extra?: Record<string, any>;     // 其他统计数据
}
```

---

## 🔧 统一爬虫接口

### PlatformBase 基类定义

```typescript
/**
 * 平台爬虫基类
 * 所有平台必须继承此类并实现其抽象方法
 */
abstract class PlatformBase {
  /**
   * 获取平台名称
   * @returns 平台标识符（如 'douyin', 'xiaohongshu'）
   */
  abstract getName(): Platform;

  /**
   * 初始化平台
   * @param account 账户信息
   */
  abstract initialize(account: Account): Promise<void>;

  /**
   * 启动登录流程
   * @param options 登录选项
   */
  abstract startLogin(options: LoginOptions): Promise<void>;

  /**
   * 爬取评论和讨论（统一接口）
   * @param account 账户信息
   * @param options 爬取选项
   * @returns 标准化的评论爬取结果
   */
  abstract crawlComments(
    account: Account,
    options?: CrawlOptions
  ): Promise<CommentsCrawlResult>;

  /**
   * 爬取私信和会话（统一接口）
   * @param account 账户信息
   * @param options 爬取选项
   * @returns 标准化的私信爬取结果
   */
  abstract crawlDirectMessages(
    account: Account,
    options?: CrawlOptions
  ): Promise<DirectMessagesCrawlResult>;

  /**
   * 爬取作品（统一接口）
   * @param account 账户信息
   * @param options 爬取选项
   * @returns 标准化的作品爬取结果
   */
  abstract crawlWorks(
    account: Account,
    options?: CrawlOptions
  ): Promise<WorksCrawlResult>;

  /**
   * 发送评论数据到 Master（通用方法）
   * @param account 账户信息
   * @param comments 评论列表
   * @param works 关联作品列表
   */
  protected sendCommentsToMaster(
    account: Account,
    comments: Comment[],
    works?: Work[]
  ): Promise<void>;

  /**
   * 发送讨论数据到 Master（通用方法）
   * @param account 账户信息
   * @param discussions 讨论列表
   */
  protected sendDiscussionsToMaster(
    account: Account,
    discussions: Discussion[]
  ): Promise<void>;

  /**
   * 发送私信数据到 Master（通用方法）
   * @param account 账户信息
   * @param messages 私信列表
   */
  protected sendDirectMessagesToMaster(
    account: Account,
    messages: DirectMessage[]
  ): Promise<void>;

  /**
   * 发送会话数据到 Master（通用方法）
   * @param account 账户信息
   * @param conversations 会话列表
   */
  protected sendConversationsToMaster(
    account: Account,
    conversations: Conversation[]
  ): Promise<void>;

  /**
   * 发送作品数据到 Master（通用方法）
   * @param account 账户信息
   * @param works 作品列表
   */
  protected sendWorksToMaster(
    account: Account,
    works: Work[]
  ): Promise<void>;
}
```

### CrawlOptions（爬取选项）

```typescript
interface CrawlOptions {
  // ===== 数量限制 =====
  maxItems?: number;               // 最大爬取数量
  maxPages?: number;               // 最大翻页数

  // ===== 时间范围 =====
  startTime?: number;              // 开始时间（秒级时间戳）
  endTime?: number;                // 结束时间（秒级时间戳）

  // ===== 增量爬取 =====
  lastCrawlTime?: number;          // 上次爬取时间
  onlyNew?: boolean;               // 仅爬取新数据

  // ===== 功能开关 =====
  includeDiscussions?: boolean;    // 是否包含讨论（默认true）
  includeStats?: boolean;          // 是否包含统计（默认true）

  // ===== 性能控制 =====
  timeout?: number;                // 超时时间（毫秒）
  retryCount?: number;             // 重试次数
  concurrency?: number;            // 并发数

  // ===== 扩展选项 =====
  extra?: Record<string, any>;     // 平台特有选项
}
```

---

## 📐 实现示例

### 抖音平台实现

```typescript
class DouyinPlatform extends PlatformBase {
  getName(): Platform {
    return Platform.DOUYIN;
  }

  async crawlComments(
    account: Account,
    options: CrawlOptions = {}
  ): Promise<CommentsCrawlResult> {
    try {
      // 1. 获取页面
      const page = await this.getOrCreatePage(account.id, 'spider2');

      // 2. 调用专用爬虫模块
      const rawResult = await crawlCommentsV2(page, account, options);

      // 3. 数据标准化（将平台特有数据转换为通用格式）
      const standardizedResult = this.standardizeCommentsResult(rawResult);

      // 4. 数据上报
      await this.sendCommentsToMaster(account, standardizedResult.comments);
      await this.sendDiscussionsToMaster(account, standardizedResult.discussions);

      // 5. 返回标准格式
      return standardizedResult;
    } catch (error) {
      throw this.standardizeError(error);
    }
  }

  /**
   * 将抖音特有数据标准化为通用格式
   */
  private standardizeCommentsResult(
    rawResult: any
  ): CommentsCrawlResult {
    return {
      comments: rawResult.comments.map(c => this.standardizeComment(c)),
      discussions: rawResult.discussions.map(d => this.standardizeDiscussion(d)),
      works: rawResult.works.map(w => this.standardizeWork(w)),
      stats: this.standardizeStats(rawResult.stats)
    };
  }

  /**
   * 标准化单条评论数据
   */
  private standardizeComment(raw: any): Comment {
    return {
      // 必填字段
      platform_comment_id: raw.platform_comment_id,
      content: raw.content,
      author_name: raw.author_name,
      author_id: raw.author_id,
      create_time: raw.create_time,
      detected_at: raw.detected_at,

      // 可选字段
      author_avatar: raw.author_avatar,
      like_count: raw.like_count || 0,
      reply_count: raw.reply_count || 0,
      post_title: raw.post_title,
      post_id: raw.post_id,

      // 扩展字段（平台特有）
      extra: {
        digg_count: raw.digg_count,  // 抖音特有：点赞数
        // ... 其他抖音特有字段
      }
    };
  }
}
```

---

## 🔄 数据流转标准

### 1. 爬虫模块 → Platform 层

```
crawl-comments.js (Platform-Specific)
  ↓ 返回平台特有格式
platform.js
  ↓ standardize*() 方法标准化
Standard Format (通用格式)
```

### 2. Platform 层 → Master

```
Standard Format (通用格式)
  ↓ sendToMaster() 方法
Socket.IO Event
  ↓
Master receives
  ↓ 存入数据库
Standard Database Schema
```

---

## ✅ 数据验证规则

### 必填字段验证

```typescript
/**
 * 验证评论数据完整性
 */
function validateComment(comment: Comment): boolean {
  const requiredFields = [
    'platform_comment_id',
    'content',
    'author_name',
    'author_id',
    'create_time',
    'detected_at'
  ];

  for (const field of requiredFields) {
    if (!(field in comment) || comment[field] === null || comment[field] === undefined) {
      throw new ValidationError(`Missing required field: ${field}`);
    }
  }

  return true;
}
```

### 数据类型验证

```typescript
/**
 * 验证字段类型
 */
function validateFieldTypes(data: any, schema: Schema): boolean {
  for (const [field, type] of Object.entries(schema)) {
    if (data[field] !== undefined && typeof data[field] !== type) {
      throw new ValidationError(
        `Field ${field} must be ${type}, got ${typeof data[field]}`
      );
    }
  }

  return true;
}
```

---

## 🛠️ 错误处理标准

### 统一错误类型

```typescript
/**
 * 爬虫错误基类
 */
class CrawlerError extends Error {
  code: string;
  platform: Platform;
  details?: any;

  constructor(message: string, code: string, platform: Platform, details?: any) {
    super(message);
    this.code = code;
    this.platform = platform;
    this.details = details;
  }
}

/**
 * 错误代码枚举
 */
enum ErrorCode {
  NETWORK_ERROR = 'NETWORK_ERROR',
  AUTH_ERROR = 'AUTH_ERROR',
  RATE_LIMIT = 'RATE_LIMIT',
  PARSE_ERROR = 'PARSE_ERROR',
  VALIDATION_ERROR = 'VALIDATION_ERROR',
  TIMEOUT = 'TIMEOUT',
  UNKNOWN = 'UNKNOWN'
}
```

### 错误标准化

```typescript
/**
 * 将平台特有错误转换为标准错误
 */
function standardizeError(error: any, platform: Platform): CrawlerError {
  if (error instanceof CrawlerError) {
    return error;
  }

  // 根据错误类型转换
  if (error.message?.includes('timeout')) {
    return new CrawlerError(error.message, ErrorCode.TIMEOUT, platform);
  }

  if (error.message?.includes('401') || error.message?.includes('403')) {
    return new CrawlerError(error.message, ErrorCode.AUTH_ERROR, platform);
  }

  // 默认未知错误
  return new CrawlerError(
    error.message || 'Unknown error',
    ErrorCode.UNKNOWN,
    platform,
    { originalError: error }
  );
}
```

---

## 📝 日志记录标准

### 日志级别

```typescript
enum LogLevel {
  DEBUG = 'debug',
  INFO = 'info',
  WARN = 'warn',
  ERROR = 'error'
}
```

### 日志格式

```typescript
interface LogEntry {
  timestamp: number;           // 时间戳
  level: LogLevel;             // 日志级别
  platform: Platform;          // 平台标识
  accountId: string;           // 账户ID
  module: string;              // 模块名称（如 'crawlComments'）
  message: string;             // 日志消息
  data?: any;                  // 附加数据
}
```

### 日志记录示例

```typescript
logger.info(`[${platform}][crawlComments] Starting crawl`, {
  accountId: account.id,
  options: options
});

logger.debug(`[${platform}][crawlComments] API intercepted`, {
  url: url,
  count: comments.length
});

logger.error(`[${platform}][crawlComments] Crawl failed`, {
  accountId: account.id,
  error: error.message,
  stack: error.stack
});
```

---

## 🚀 迁移指南

### 现有平台迁移步骤

1. **实现标准化方法**
   ```typescript
   private standardizeCommentsResult(raw: any): CommentsCrawlResult
   private standardizeComment(raw: any): Comment
   private standardizeDiscussion(raw: any): Discussion
   ```

2. **更新爬虫方法签名**
   ```typescript
   async crawlComments(
     account: Account,
     options?: CrawlOptions
   ): Promise<CommentsCrawlResult>
   ```

3. **添加数据验证**
   ```typescript
   validateComment(comment);
   validateDiscussion(discussion);
   ```

4. **统一错误处理**
   ```typescript
   catch (error) {
     throw this.standardizeError(error);
   }
   ```

5. **更新日志格式**
   ```typescript
   logger.info(`[${this.getName()}][crawlComments] ...`);
   ```

---

## 📌 待办事项

### 短期（1-2周）

- [ ] 在 `platform-base.js` 中定义接口和类型
- [ ] 抖音平台实现标准化方法
- [ ] 编写数据验证工具函数
- [ ] 编写错误标准化工具函数
- [ ] 更新单元测试

### 中期（1个月）

- [ ] 小红书平台适配新接口
- [ ] 微博平台适配新接口
- [ ] B站平台适配新接口
- [ ] 编写接口兼容性测试

### 长期（持续）

- [ ] 监控跨平台数据一致性
- [ ] 收集反馈优化接口设计
- [ ] 扩展支持更多平台

---

**规范版本**: v1.0
**最后更新**: 2025-10-24
**维护者**: Claude Code Assistant
**下次审查**: 2025-11-24
