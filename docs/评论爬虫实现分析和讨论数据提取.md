# è¯„è®ºçˆ¬è™«å®ç°åˆ†æå’Œè®¨è®ºæ•°æ®æå–

**åˆ†ææ—¶é—´**: 2025-10-24 21:45
**åˆ†ææ–‡ä»¶**: `packages/worker/src/platforms/douyin/crawl-comments.js`
**åˆ†æç›®çš„**: ç¡®è®¤çˆ¬è™«æ˜¯å¦æŠ“å–è®¨è®ºï¼ˆå›å¤ï¼‰åŠå…¶æ•°æ®ç»“æ„

---

## ä¸€ã€å½“å‰å®ç°æ–¹å¼

### 1.1 æŠ€æœ¯æ–¹æ¡ˆï¼šAPI æ‹¦æˆª âœ…

**æ ¸å¿ƒæŠ€æœ¯**:
```javascript
// Line 57-102: å…¨å±€ API æ‹¦æˆªå™¨
page.on('response', async (response) => {
  const url = response.url();

  // â­ æ‹¦æˆªä¸€çº§è¯„è®º API
  if (commentApiPattern.test(url)) {  // /comment.*list/i
    apiResponses.comments.push({...});
  }

  // â­ æ‹¦æˆªäºŒçº§/ä¸‰çº§å›å¤ APIï¼ˆè®¨è®ºï¼‰
  if (discussionApiPattern.test(url)) {  // /comment.*reply/i
    apiResponses.discussions.push({...});
  }
});
```

**API æ‹¦æˆªæ¨¡å¼**:
- è¯„è®º API: `/comment.*list/i` â†’ ä¸€çº§è¯„è®º
- è®¨è®º API: `/comment.*reply/i` â†’ äºŒçº§/ä¸‰çº§å›å¤

### 1.2 æŠ“å–ç­–ç•¥

```
Step 1: è®¾ç½®å…¨å±€ API æ‹¦æˆªå™¨
         â†“
Step 2: å¯¼èˆªåˆ°è¯„è®ºç®¡ç†é¡µé¢
         â†“
Step 3: æ‰“å¼€"é€‰æ‹©ä½œå“"æ¨¡æ€æ¡†
         â†“
Step 4: è·å–æ‰€æœ‰è§†é¢‘åˆ—è¡¨
         â†“
Step 5: æ‰¹é‡ç‚¹å‡»æœ‰è¯„è®ºçš„è§†é¢‘ â† â­ è§¦å‘è¯„è®º API
         â†“
Step 6: å¤„ç†éœ€è¦åˆ†é¡µçš„è§†é¢‘ (has_more: true)
         â†“
Step 7: è§£ææ‹¦æˆªåˆ°çš„è¯„è®ºæ•°æ®
         â†“
Step 8: è§£ææ‹¦æˆªåˆ°çš„è®¨è®ºæ•°æ® â† â­ è®¨è®º/å›å¤
         â†“
Step 9: è¿”å›ç»“æœ
```

---

## äºŒã€è®¨è®ºï¼ˆå›å¤ï¼‰æ•°æ®ç»“æ„

### 2.1 API å“åº”ç»“æ„

**è¯„è®º API å“åº”** (ä¸€çº§è¯„è®º):
```javascript
{
  comment_info_list: [
    {
      comment_id: "7428949857616888612",
      text: "çœŸå¸Œæœ›å…¨å›½æ¨å¹¿ï¼Œè®©äººç”Ÿæœ€åä¸€ç¨‹æœ‰å°Šä¸¥çš„è°¢å¹•",
      user_info: {
        user_id: "xxx",
        screen_name: "æŸ¯å—1969",
        avatar_url: "https://..."
      },
      create_time: 1728234789,
      digg_count: 4,           // ç‚¹èµæ•°
      reply_count: 2,          // â­ å›å¤æ•°é‡ï¼ˆè®¨è®ºæ•°ï¼‰
    }
  ],
  has_more: true,
  cursor: 20,
  total_count: 77
}
```

**è®¨è®º API å“åº”** (äºŒçº§/ä¸‰çº§å›å¤):
```javascript
{
  reply_list: [
    {
      reply_id: "7428955112345678901",  // æˆ– comment_id
      comment_id: "7428949857616888612", // çˆ¶è¯„è®º ID
      text: "å›å¤æŸ¯å—1969: æ˜¯çš„ï¼Œæˆ‘ä¹Ÿè¿™ä¹ˆè§‰å¾—",
      user_info: {
        user_id: "yyy",
        screen_name: "ç¡•æœç´¯ç´¯",
        avatar_url: "https://..."
      },
      create_time: 1728239456,
      digg_count: 0,
      reply_count: 1,    // ä¸‰çº§å›å¤æ•°é‡
      aweme_id: "7426789012345678901"  // ä½œå“ ID
    }
  ],
  has_more: false,
  cursor: 0
}
```

### 2.2 çˆ¬è™«æå–çš„è®¨è®ºå­—æ®µ

**å½“å‰æå–çš„å­—æ®µ** (Line 453-467):
```javascript
{
  platform_discussion_id: reply.reply_id || reply.comment_id,  // â­ è®¨è®º ID
  parent_comment_id: parentCommentId,                          // â­ çˆ¶è¯„è®º ID
  work_id: reply.aweme_id || null,                             // ä½œå“ ID
  content: reply.text || reply.content,                        // è®¨è®ºå†…å®¹
  author_name: reply.user_info?.screen_name || 'åŒ¿å',         // â­ ä½œè€…æ˜µç§°
  author_id: reply.user_info?.user_id || '',                   // â­ ä½œè€… ID
  author_avatar: reply.user_info?.avatar_url || '',            // â­ ä½œè€…å¤´åƒ
  create_time: createTimeSeconds,                              // åˆ›å»ºæ—¶é—´ï¼ˆç§’ï¼‰
  create_time_formatted: new Date(...).toLocaleString('zh-CN'), // æ ¼å¼åŒ–æ—¶é—´
  like_count: parseInt(reply.digg_count) || 0,                 // ç‚¹èµæ•°
  reply_count: parseInt(reply.reply_count) || 0,               // ä¸‰çº§å›å¤æ•°é‡
  detected_at: Math.floor(Date.now() / 1000),                  // æŠ“å–æ—¶é—´
}
```

### 2.3 å…³é”®ä¿¡æ¯å¯¹ç…§è¡¨

| ç”¨æˆ·éœ€æ±‚å­—æ®µ | API å­—æ®µå | çˆ¬è™«æå–å­—æ®µ | è¯´æ˜ |
|-------------|-----------|------------|------|
| è®¨è®º ID | `reply_id` / `comment_id` | `platform_discussion_id` | âœ… å·²æå– |
| çˆ¶è¯„è®º ID | URL å‚æ•° `comment_id` | `parent_comment_id` | âœ… å·²æå– |
| ä½œè€… ID | `reply.user_info.user_id` | `author_id` | âœ… å·²æå– |
| ä½œè€…æ˜µç§° | `reply.user_info.screen_name` | `author_name` | âœ… å·²æå– |
| ä½œè€…å¤´åƒ | `reply.user_info.avatar_url` | `author_avatar` | âœ… å·²æå– |
| è®¨è®ºå†…å®¹ | `reply.text` / `reply.content` | `content` | âœ… å·²æå– |
| åˆ›å»ºæ—¶é—´ | `reply.create_time` | `create_time` | âœ… å·²æå– |
| ç‚¹èµæ•° | `reply.digg_count` | `like_count` | âœ… å·²æå– |
| ä½œå“ ID | `reply.aweme_id` | `work_id` | âœ… å·²æå– |

**ç»“è®º**: âœ… **æ‰€æœ‰å…³é”®ä¿¡æ¯éƒ½å·²ç»åœ¨çˆ¬è™«ä¸­æå–äº†ï¼**

---

## ä¸‰ã€è®¨è®ºæ•°æ®è§¦å‘æœºåˆ¶

### 3.1 è§¦å‘æ¡ä»¶

è®¨è®º API çš„è§¦å‘éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ä¹‹ä¸€ï¼š

1. **ç”¨æˆ·åœ¨è¯„è®ºç®¡ç†é¡µé¢ç‚¹å‡»"æŸ¥çœ‹Xæ¡å›å¤"æŒ‰é’®**
   - æ‰‹åŠ¨è§¦å‘ `/comment/reply` API
   - è¿”å›è¯¥è¯„è®ºä¸‹çš„æ‰€æœ‰å›å¤

2. **é¡µé¢è‡ªåŠ¨åŠ è½½è®¨è®ºæ•°æ®**
   - æŸäº›é¡µé¢å¯èƒ½è‡ªåŠ¨åŠ è½½çƒ­é—¨è¯„è®ºçš„å›å¤
   - å–å†³äºæŠ–éŸ³å‰ç«¯å®ç°

### 3.2 å½“å‰çˆ¬è™«æ˜¯å¦è§¦å‘ï¼Ÿ

**æ£€æŸ¥ä»£ç **:

```javascript
// Line 159-184: æ‰¹é‡ç‚¹å‡»è§†é¢‘
for (let i = 0; i < maxToProcess; i++) {
  await page.evaluate((idx) => {
    const containers = document.querySelectorAll('.container-Lkxos9');
    if (idx < containers.length) {
      containers[idx].click();  // â­ åªç‚¹å‡»è§†é¢‘ï¼Œä¸ç‚¹å‡»"æŸ¥çœ‹å›å¤"æŒ‰é’®
    }
  }, video.index);

  await page.waitForTimeout(2000);
}
```

**åˆ†æ**:
- âŒ ä»£ç ä¸­**æ²¡æœ‰ç‚¹å‡»"æŸ¥çœ‹Xæ¡å›å¤"æŒ‰é’®**çš„é€»è¾‘
- âš ï¸ ä¾èµ–æŠ–éŸ³å‰ç«¯**è‡ªåŠ¨åŠ è½½**è®¨è®ºæ•°æ®
- âš ï¸ å¦‚æœå‰ç«¯ä¸è‡ªåŠ¨åŠ è½½ï¼Œ**è®¨è®º API ä¸ä¼šè¢«è§¦å‘**

### 3.3 éªŒè¯æ–¹æ³•

è®©æˆ‘ä»¬ä½¿ç”¨ MCP æ¥éªŒè¯è®¨è®º API æ˜¯å¦è¢«è§¦å‘ï¼š

```javascript
// åœ¨ç‚¹å‡»è§†é¢‘åï¼Œæ£€æŸ¥æ˜¯å¦æœ‰è®¨è®º API è¢«æ‹¦æˆª
logger.info(`Intercepted ${apiResponses.discussions.length} discussion API calls`);
```

**é¢„æœŸç»“æœ**:
- å¦‚æœ `apiResponses.discussions.length === 0` â†’ âŒ è®¨è®º API æœªè§¦å‘
- å¦‚æœ `apiResponses.discussions.length > 0` â†’ âœ… è®¨è®º API å·²è§¦å‘

---

## å››ã€é—®é¢˜è¯Šæ–­å’Œè§£å†³æ–¹æ¡ˆ

### 4.1 é—®é¢˜1: è®¨è®º API æœªè§¦å‘

**ç—‡çŠ¶**:
```javascript
apiResponses.discussions.length === 0  // æ²¡æœ‰æ‹¦æˆªåˆ°ä»»ä½•è®¨è®º API
```

**åŸå› **:
1. ç‚¹å‡»è§†é¢‘åï¼Œé¡µé¢**ä¸ä¼šè‡ªåŠ¨åŠ è½½è®¨è®ºæ•°æ®**
2. éœ€è¦æ‰‹åŠ¨ç‚¹å‡»"æŸ¥çœ‹Xæ¡å›å¤"æŒ‰é’®æ‰èƒ½è§¦å‘ API

**è§£å†³æ–¹æ¡ˆA: è‡ªåŠ¨ç‚¹å‡»"æŸ¥çœ‹å›å¤"æŒ‰é’® (æ¨è â­â­â­)**

```javascript
// åœ¨ç‚¹å‡»è§†é¢‘åï¼ŒæŸ¥æ‰¾å¹¶ç‚¹å‡»æ‰€æœ‰"æŸ¥çœ‹å›å¤"æŒ‰é’®
async function clickViewRepliesButtons(page) {
  logger.info('Looking for "æŸ¥çœ‹å›å¤" buttons...');

  // æŸ¥æ‰¾æ‰€æœ‰"æŸ¥çœ‹Xæ¡å›å¤"æŒ‰é’®
  const replyButtons = await page.evaluate(() => {
    const buttons = [];
    const allElements = document.querySelectorAll('*');

    allElements.forEach(el => {
      const text = el.textContent || '';
      if (text.match(/æŸ¥çœ‹\d+æ¡å›å¤/)) {
        buttons.push({
          text: text.trim(),
          xpath: getXPath(el)  // è‡ªå®šä¹‰å‡½æ•°è·å– XPath
        });
      }
    });

    return buttons;
  });

  logger.info(`Found ${replyButtons.length} "æŸ¥çœ‹å›å¤" buttons`);

  // é€ä¸ªç‚¹å‡»æŒ‰é’®
  for (const button of replyButtons) {
    try {
      logger.debug(`Clicking: ${button.text}`);
      await page.evaluate((xpath) => {
        const el = document.evaluate(xpath, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
        if (el) el.click();
      }, button.xpath);

      await page.waitForTimeout(500);  // ç­‰å¾… API å“åº”
    } catch (error) {
      logger.warn(`Failed to click button: ${error.message}`);
    }
  }

  logger.info('Finished clicking all "æŸ¥çœ‹å›å¤" buttons');
}
```

**ä¿®æ”¹åçš„çˆ¬å–æµç¨‹**:
```javascript
// åœ¨ Line 184 ä¹‹åæ·»åŠ 
for (let i = 0; i < maxToProcess; i++) {
  // ç‚¹å‡»è§†é¢‘
  await page.evaluate((idx) => {
    containers[idx].click();
  }, video.index);

  await page.waitForTimeout(2000);

  // â­ æ–°å¢ï¼šç‚¹å‡»æ‰€æœ‰"æŸ¥çœ‹å›å¤"æŒ‰é’®
  await clickViewRepliesButtons(page);
  await page.waitForTimeout(1000);

  // é‡æ–°æ‰“å¼€æ¨¡æ€æ¡†
  if (i < maxToProcess - 1) {
    await page.click('span:has-text("é€‰æ‹©ä½œå“")');
    await page.waitForTimeout(1000);
  }
}
```

**è§£å†³æ–¹æ¡ˆB: ä½¿ç”¨ä¸“é—¨çš„è®¨è®ºçˆ¬è™« (å¤‡é€‰)**

åˆ›å»ºç‹¬ç«‹çš„è®¨è®ºçˆ¬è™«ï¼š

```javascript
// packages/worker/src/platforms/douyin/crawl-discussions.js

async function crawlDiscussions(page, comments) {
  logger.info(`Crawling discussions for ${comments.length} comments`);

  const discussions = [];

  for (const comment of comments) {
    if (comment.reply_count > 0) {
      // ç›´æ¥è°ƒç”¨è®¨è®º API
      const replies = await fetchDiscussionAPI(comment.platform_comment_id);
      discussions.push(...replies);
    }
  }

  return discussions;
}

async function fetchDiscussionAPI(commentId) {
  // é€šè¿‡ evaluate è§¦å‘ API è¯·æ±‚
  // æˆ–ä½¿ç”¨ axios ç›´æ¥è¯·æ±‚ï¼ˆéœ€è¦ Cookieï¼‰
}
```

### 4.2 é—®é¢˜2: æ•°æ®åº“è¡¨ç»“æ„

**æ£€æŸ¥æ•°æ®åº“æ˜¯å¦æœ‰è®¨è®ºè¡¨**:

```sql
-- æŸ¥çœ‹æ˜¯å¦æœ‰ discussions æˆ– comment_replies è¡¨
SELECT name FROM sqlite_master WHERE type='table' AND name LIKE '%discuss%';
SELECT name FROM sqlite_master WHERE type='table' AND name LIKE '%reply%';
```

**å¦‚æœæ²¡æœ‰è®¨è®ºè¡¨ï¼Œéœ€è¦åˆ›å»º**:

```sql
CREATE TABLE IF NOT EXISTS discussions (
  id TEXT PRIMARY KEY DEFAULT (lower(hex(randomblob(16)))),
  platform_discussion_id TEXT NOT NULL,         -- è®¨è®º ID
  parent_comment_id TEXT NOT NULL,              -- çˆ¶è¯„è®º ID
  work_id TEXT,                                 -- ä½œå“ ID
  account_id TEXT NOT NULL,                     -- è´¦æˆ· ID
  platform TEXT DEFAULT 'douyin',               -- å¹³å°

  -- ä½œè€…ä¿¡æ¯
  author_id TEXT NOT NULL,                      -- ä½œè€… ID
  author_name TEXT NOT NULL,                    -- ä½œè€…æ˜µç§°
  author_avatar TEXT,                           -- ä½œè€…å¤´åƒ URL

  -- è®¨è®ºå†…å®¹
  content TEXT NOT NULL,                        -- è®¨è®ºæ–‡æœ¬

  -- ç»Ÿè®¡ä¿¡æ¯
  like_count INTEGER DEFAULT 0,                 -- ç‚¹èµæ•°
  reply_count INTEGER DEFAULT 0,                -- ä¸‰çº§å›å¤æ•°é‡

  -- æ—¶é—´ä¿¡æ¯
  create_time INTEGER NOT NULL,                 -- åˆ›å»ºæ—¶é—´ï¼ˆç§’çº§æ—¶é—´æˆ³ï¼‰
  detected_at INTEGER NOT NULL,                 -- æŠ“å–æ—¶é—´ï¼ˆç§’çº§æ—¶é—´æˆ³ï¼‰

  -- çº¦æŸ
  UNIQUE (platform, account_id, platform_discussion_id),
  FOREIGN KEY (account_id) REFERENCES accounts(id) ON DELETE CASCADE,
  FOREIGN KEY (parent_comment_id) REFERENCES comments(platform_comment_id) ON DELETE CASCADE
);

-- ç´¢å¼•
CREATE INDEX idx_discussions_parent ON discussions(parent_comment_id);
CREATE INDEX idx_discussions_account ON discussions(account_id);
CREATE INDEX idx_discussions_work ON discussions(work_id);
CREATE INDEX idx_discussions_created ON discussions(create_time DESC);
```

### 4.3 é—®é¢˜3: æ•°æ®ä¿å­˜é€»è¾‘

**æ£€æŸ¥æ˜¯å¦ä¿å­˜è®¨è®ºæ•°æ®**:

æŸ¥æ‰¾è°ƒç”¨ `crawlComments()` çš„åœ°æ–¹ï¼š
```bash
grep -rn "crawlComments" packages/worker/src/
```

**å¯èƒ½çš„æ–‡ä»¶**:
- `packages/worker/src/platforms/douyin/platform.js`
- `packages/worker/src/handlers/task-runner.js`

**æ£€æŸ¥è¿”å›æ•°æ®æ˜¯å¦åŒ…å« discussions**:
```javascript
const result = await crawlComments(page, account, options);

// result åº”è¯¥åŒ…å«:
// {
//   comments: [...],
//   discussions: [...],  // â­ æ£€æŸ¥æ˜¯å¦æœ‰è¿™ä¸ªå­—æ®µ
//   works: [...],
//   stats: {...}
// }
```

**ä¿å­˜è®¨è®ºæ•°æ®åˆ°æ•°æ®åº“**:
```javascript
// ä¿å­˜è¯„è®º
for (const comment of result.comments) {
  await commentsDAO.insertComment(comment);
}

// â­ ä¿å­˜è®¨è®º
for (const discussion of result.discussions) {
  await discussionsDAO.insertDiscussion(discussion);
}
```

---

## äº”ã€æµ‹è¯•å’ŒéªŒè¯

### 5.1 æµ‹è¯•è„šæœ¬1: éªŒè¯è®¨è®º API æ‹¦æˆª

```javascript
// tests/æµ‹è¯•è®¨è®ºAPIæ‹¦æˆª.js

const { chromium } = require('playwright');
const path = require('path');

async function testDiscussionAPIInterception() {
  console.log('ğŸ“‹ æµ‹è¯•è®¨è®º API æ‹¦æˆª\n');

  const userDataDir = path.join(__dirname, '../packages/worker/data/browser/worker-1/browser_xxx');

  const context = await chromium.launchPersistentContext(userDataDir, {
    headless: false,
    viewport: { width: 1280, height: 720 },
  });

  const page = await context.newPage();

  // è®¾ç½® API æ‹¦æˆªå™¨
  const apiCalls = {
    comments: [],
    discussions: []
  };

  page.on('response', async (response) => {
    const url = response.url();

    if (/comment.*list/i.test(url)) {
      apiCalls.comments.push({ url, time: Date.now() });
      console.log(`âœ… æ‹¦æˆªåˆ°è¯„è®º API: ${url.substring(0, 100)}...`);
    }

    if (/comment.*reply/i.test(url)) {
      apiCalls.discussions.push({ url, time: Date.now() });
      console.log(`ğŸ”¥ æ‹¦æˆªåˆ°è®¨è®º API: ${url.substring(0, 100)}...`);

      try {
        const json = await response.json();
        console.log(`   å›å¤æ•°é‡: ${json.reply_list?.length || 0}`);
      } catch (e) {}
    }
  });

  // å¯¼èˆªåˆ°è¯„è®ºç®¡ç†é¡µé¢
  console.log('\nğŸ“ å¯¼èˆªåˆ°è¯„è®ºç®¡ç†é¡µé¢...');
  await page.goto('https://creator.douyin.com/creator-micro/interactive/comment', {
    waitUntil: 'networkidle',
    timeout: 30000
  });

  await page.waitForTimeout(3000);

  // æ‰“å¼€é€‰æ‹©ä½œå“
  console.log('\nğŸ“ æ‰“å¼€é€‰æ‹©ä½œå“æ¨¡æ€æ¡†...');
  await page.click('span:has-text("é€‰æ‹©ä½œå“")');
  await page.waitForTimeout(2000);

  // ç‚¹å‡»ç¬¬ä¸€ä¸ªè§†é¢‘
  console.log('\nğŸ“ ç‚¹å‡»ç¬¬ä¸€ä¸ªè§†é¢‘...');
  await page.evaluate(() => {
    const containers = document.querySelectorAll('.container-Lkxos9');
    if (containers.length > 0) {
      containers[0].click();
    }
  });

  await page.waitForTimeout(3000);

  // æŸ¥æ‰¾å¹¶ç‚¹å‡»"æŸ¥çœ‹å›å¤"æŒ‰é’®
  console.log('\nğŸ“ æŸ¥æ‰¾"æŸ¥çœ‹å›å¤"æŒ‰é’®...');
  const replyButtonCount = await page.evaluate(() => {
    const buttons = Array.from(document.querySelectorAll('*')).filter(el =>
      el.textContent && el.textContent.match(/æŸ¥çœ‹\d+æ¡å›å¤/)
    );
    return buttons.length;
  });

  console.log(`âœ… æ‰¾åˆ° ${replyButtonCount} ä¸ª"æŸ¥çœ‹å›å¤"æŒ‰é’®\n`);

  if (replyButtonCount > 0) {
    console.log('ğŸ“ ç‚¹å‡»ç¬¬ä¸€ä¸ª"æŸ¥çœ‹å›å¤"æŒ‰é’®...');
    await page.evaluate(() => {
      const buttons = Array.from(document.querySelectorAll('*')).filter(el =>
        el.textContent && el.textContent.match(/æŸ¥çœ‹\d+æ¡å›å¤/)
      );
      if (buttons.length > 0) {
        buttons[0].click();
      }
    });

    await page.waitForTimeout(2000);
  }

  // è¾“å‡ºç»Ÿè®¡
  console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ğŸ“Š API æ‹¦æˆªç»Ÿè®¡:');
  console.log(`   è¯„è®º API: ${apiCalls.comments.length} æ¬¡`);
  console.log(`   è®¨è®º API: ${apiCalls.discussions.length} æ¬¡`);
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

  if (apiCalls.discussions.length === 0) {
    console.log('âš ï¸  è­¦å‘Š: æ²¡æœ‰æ‹¦æˆªåˆ°è®¨è®º APIï¼');
    console.log('   å¯èƒ½åŸå› :');
    console.log('   1. é¡µé¢æ²¡æœ‰"æŸ¥çœ‹å›å¤"æŒ‰é’®');
    console.log('   2. "æŸ¥çœ‹å›å¤"æŒ‰é’®æ²¡æœ‰è¢«ç‚¹å‡»');
    console.log('   3. API æ¨¡å¼ä¸åŒ¹é…\n');
  } else {
    console.log('âœ… æˆåŠŸæ‹¦æˆªåˆ°è®¨è®º APIï¼\n');
  }

  await page.waitForTimeout(5000);
  await context.close();
}

testDiscussionAPIInterception().catch(console.error);
```

### 5.2 æµ‹è¯•è„šæœ¬2: æŸ¥çœ‹æ•°æ®åº“è®¨è®ºæ•°æ®

```javascript
// tests/æŸ¥çœ‹è®¨è®ºæ•°æ®.js

const Database = require('better-sqlite3');
const path = require('path');

const dbPath = path.join(__dirname, '../packages/master/data/master.db');
const db = new Database(dbPath);

console.log('ğŸ“‹ æŸ¥çœ‹è®¨è®ºæ•°æ®ç»Ÿè®¡\n');

// 1. æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
const tables = db.prepare(`
  SELECT name FROM sqlite_master
  WHERE type='table' AND name LIKE '%discuss%' OR name LIKE '%reply%'
`).all();

console.log('ğŸ“Š ç›¸å…³è¡¨:');
if (tables.length === 0) {
  console.log('   âŒ æ²¡æœ‰æ‰¾åˆ°è®¨è®º/å›å¤ç›¸å…³çš„è¡¨\n');
} else {
  tables.forEach(t => console.log(`   âœ… ${t.name}`));
  console.log('');
}

// 2. å¦‚æœæœ‰ discussions è¡¨ï¼ŒæŸ¥çœ‹ç»Ÿè®¡
if (tables.some(t => t.name === 'discussions')) {
  const stats = db.prepare(`
    SELECT
      COUNT(*) as total,
      COUNT(DISTINCT parent_comment_id) as unique_parents,
      COUNT(DISTINCT author_id) as unique_authors
    FROM discussions
  `).get();

  console.log('ğŸ“Š è®¨è®ºç»Ÿè®¡:');
  console.log(`   æ€»è®¨è®ºæ•°: ${stats.total}`);
  console.log(`   æ¶‰åŠè¯„è®ºæ•°: ${stats.unique_parents}`);
  console.log(`   å‚ä¸ç”¨æˆ·æ•°: ${stats.unique_authors}\n`);

  // 3. æŸ¥çœ‹æœ€è¿‘çš„è®¨è®º
  if (stats.total > 0) {
    const recentDiscussions = db.prepare(`
      SELECT
        author_name,
        content,
        like_count,
        datetime(create_time, 'unixepoch', 'localtime') as created_at
      FROM discussions
      ORDER BY create_time DESC
      LIMIT 5
    `).all();

    console.log('ğŸ“ æœ€è¿‘ 5 æ¡è®¨è®º:');
    recentDiscussions.forEach((d, i) => {
      console.log(`\n  ${i + 1}. ${d.author_name} (${d.created_at})`);
      console.log(`     "${d.content}"`);
      console.log(`     ç‚¹èµ: ${d.like_count}`);
    });
  }
} else {
  console.log('âš ï¸  æ•°æ®åº“ä¸­æ²¡æœ‰ discussions è¡¨');
  console.log('   éœ€è¦åˆ›å»ºè¡¨æˆ–ä¿®æ”¹ schema\n');
}

db.close();
```

---

## å…­ã€å®Œæ•´å®ç°æ–¹æ¡ˆ

### 6.1 ä¿®æ”¹è¯„è®ºçˆ¬è™« - æ·»åŠ ç‚¹å‡»"æŸ¥çœ‹å›å¤"é€»è¾‘

**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/crawl-comments.js`

**ä¿®æ”¹ä½ç½®**: Line 184 ä¹‹å

```javascript
// åœ¨ç‚¹å‡»è§†é¢‘åï¼Œæ·»åŠ ç‚¹å‡»"æŸ¥çœ‹å›å¤"æŒ‰é’®çš„é€»è¾‘
for (let i = 0; i < maxToProcess; i++) {
  const video = videosToClick[i];
  logger.info(`[${i + 1}/${maxToProcess}] Clicking: ${video.title.substring(0, 50)}...`);

  try {
    // 1. ç‚¹å‡»è§†é¢‘
    await page.evaluate((idx) => {
      const containers = document.querySelectorAll('.container-Lkxos9');
      if (idx < containers.length) {
        containers[idx].click();
      }
    }, video.index);

    // 2. ç­‰å¾…è¯„è®ºåŠ è½½
    await page.waitForTimeout(2000);

    // 3. â­ æ–°å¢ï¼šç‚¹å‡»æ‰€æœ‰"æŸ¥çœ‹å›å¤"æŒ‰é’®
    logger.debug('  Looking for "æŸ¥çœ‹å›å¤" buttons...');
    const replyButtonsClicked = await page.evaluate(() => {
      let clicked = 0;
      const allElements = Array.from(document.querySelectorAll('*'));

      allElements.forEach(el => {
        const text = el.textContent || '';
        if (text.match(/æŸ¥çœ‹\d+æ¡å›å¤/) && el.offsetParent !== null) {  // å¯è§å…ƒç´ 
          try {
            el.click();
            clicked++;
          } catch (e) {
            // å¿½ç•¥ç‚¹å‡»å¤±è´¥
          }
        }
      });

      return clicked;
    });

    if (replyButtonsClicked > 0) {
      logger.info(`  âœ… Clicked ${replyButtonsClicked} "æŸ¥çœ‹å›å¤" buttons`);
      await page.waitForTimeout(1500);  // ç­‰å¾…è®¨è®º API å“åº”
    } else {
      logger.debug('  No "æŸ¥çœ‹å›å¤" buttons found or all hidden');
    }

    // 4. é‡æ–°æ‰“å¼€æ¨¡æ€æ¡†ä»¥ä¾¿ç‚¹å‡»ä¸‹ä¸€ä¸ª
    if (i < maxToProcess - 1) {
      await page.click('span:has-text("é€‰æ‹©ä½œå“")', { timeout: 5000 });
      await page.waitForTimeout(1000);
    }
  } catch (error) {
    logger.error(`Failed to click video ${i}: ${error.message}`);
  }
}
```

### 6.2 åˆ›å»ºè®¨è®ºæ•°æ®è®¿é—®å¯¹è±¡ (DAO)

**æ–‡ä»¶**: `packages/master/src/database/discussions-dao.js` (å·²å­˜åœ¨ï¼Œéœ€æ£€æŸ¥)

**éœ€è¦å®ç°çš„æ–¹æ³•**:
```javascript
class DiscussionsDAO {
  insertDiscussion(discussion) { ... }
  getDiscussionsByCommentId(commentId) { ... }
  getRecentDiscussions(limit) { ... }
}
```

### 6.3 ä¿å­˜è®¨è®ºæ•°æ®

**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/platform.js` æˆ–è°ƒç”¨çˆ¬è™«çš„åœ°æ–¹

```javascript
const result = await crawlComments(page, account, options);

logger.info(`Crawled ${result.comments.length} comments, ${result.discussions.length} discussions`);

// ä¿å­˜è¯„è®º
for (const comment of result.comments) {
  await this.saveComment(comment);
}

// â­ ä¿å­˜è®¨è®º
for (const discussion of result.discussions) {
  await this.saveDiscussion(discussion);
}
```

---

## ä¸ƒã€æ€»ç»“

### 7.1 å½“å‰çŠ¶æ€

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| API æ‹¦æˆªå™¨è®¾ç½® | âœ… å®Œæˆ | Line 57-102 |
| è¯„è®º API æ‹¦æˆª | âœ… å®Œæˆ | `/comment.*list/` |
| è®¨è®º API æ‹¦æˆª | âœ… å®Œæˆ | `/comment.*reply/` |
| è®¨è®ºæ•°æ®æå– | âœ… å®Œæˆ | Line 433-483 |
| è®¨è®ºå­—æ®µæå– | âœ… å®Œæ•´ | æ‰€æœ‰å…³é”®å­—æ®µéƒ½å·²æå– |
| è‡ªåŠ¨ç‚¹å‡»"æŸ¥çœ‹å›å¤" | âŒ ç¼ºå¤± | **éœ€è¦æ·»åŠ ** |
| æ•°æ®åº“è¡¨ç»“æ„ | âš ï¸ å¾…ç¡®è®¤ | éœ€æ£€æŸ¥æ˜¯å¦æœ‰ discussions è¡¨ |
| æ•°æ®ä¿å­˜é€»è¾‘ | âš ï¸ å¾…ç¡®è®¤ | éœ€æ£€æŸ¥æ˜¯å¦ä¿å­˜ discussions |

### 7.2 å…³é”®å‘ç°

1. âœ… **çˆ¬è™«å·²å®ç°è®¨è®ºæŠ“å–åŠŸèƒ½**
   - ä½¿ç”¨ API æ‹¦æˆªæ–¹å¼
   - æå–äº†æ‰€æœ‰å…³é”®å­—æ®µï¼ˆIDã€æ˜µç§°ã€å¤´åƒç­‰ï¼‰

2. âš ï¸ **å¯èƒ½å­˜åœ¨çš„é—®é¢˜**
   - æ²¡æœ‰è‡ªåŠ¨ç‚¹å‡»"æŸ¥çœ‹å›å¤"æŒ‰é’®
   - ä¾èµ–å‰ç«¯è‡ªåŠ¨åŠ è½½è®¨è®ºæ•°æ®
   - å¦‚æœå‰ç«¯ä¸è‡ªåŠ¨åŠ è½½ï¼Œè®¨è®º API ä¸ä¼šè§¦å‘

3. ğŸ” **éœ€è¦éªŒè¯**
   - æ•°æ®åº“æ˜¯å¦æœ‰ discussions è¡¨
   - çˆ¬è™«è¿”å›çš„ discussions æ˜¯å¦è¢«ä¿å­˜
   - å®é™…è¿è¡Œæ—¶æ˜¯å¦æ‹¦æˆªåˆ°è®¨è®º API

### 7.3 ç«‹å³è¡ŒåŠ¨é¡¹

1. **è¿è¡Œæµ‹è¯•è„šæœ¬1** - éªŒè¯è®¨è®º API æ˜¯å¦è¢«æ‹¦æˆª
   ```bash
   node tests/æµ‹è¯•è®¨è®ºAPIæ‹¦æˆª.js
   ```

2. **è¿è¡Œæµ‹è¯•è„šæœ¬2** - æŸ¥çœ‹æ•°æ®åº“è®¨è®ºæ•°æ®
   ```bash
   node tests/æŸ¥çœ‹è®¨è®ºæ•°æ®.js
   ```

3. **å¦‚æœè®¨è®º API æœªè§¦å‘** - å®æ–½æ–¹æ¡ˆ 6.1 (æ·»åŠ ç‚¹å‡»"æŸ¥çœ‹å›å¤"é€»è¾‘)

4. **å¦‚æœæ•°æ®åº“æ— è®¨è®ºè¡¨** - åˆ›å»º discussions è¡¨

5. **ç¡®ä¿æ•°æ®ä¿å­˜** - æ£€æŸ¥å¹¶ä¿®æ”¹æ•°æ®ä¿å­˜é€»è¾‘

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-24 21:50
**çŠ¶æ€**: âœ… åˆ†æå®Œæˆ
**ç»“è®º**: çˆ¬è™«å·²å®ç°è®¨è®ºæŠ“å–ï¼Œä½†å¯èƒ½éœ€è¦æ·»åŠ è‡ªåŠ¨ç‚¹å‡»"æŸ¥çœ‹å›å¤"æŒ‰é’®çš„é€»è¾‘
**ä¸‹ä¸€æ­¥**: è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯ â†’ æ ¹æ®ç»“æœå®æ–½æ”¹è¿›æ–¹æ¡ˆ
