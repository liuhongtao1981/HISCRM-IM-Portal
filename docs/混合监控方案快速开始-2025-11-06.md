# 混合监控方案快速开始指南

**日期**: 2025-11-06
**目标**: 5 分钟快速了解并启动混合监控方案

---

## 一、什么是混合监控方案?

混合监控 = **实时监控 (零延迟)** + **定时爬虫 (兜底保障)**

```
┌─────────────────┐        ┌─────────────────┐
│  实时监控层     │        │  定时爬虫层     │
│  < 10ms 延迟    │   +    │  5-10 分钟间隔  │
│  新消息/评论    │        │  历史数据/兜底  │
└─────────────────┘        └─────────────────┘
           │                         │
           └────────┬────────────────┘
                    ▼
           ┌─────────────────┐
           │  DataManager    │
           │  去重+标准化    │
           └─────────────────┘
```

### 优势

| 特性 | 实时监控 | 定时爬虫 | 混合方案 |
|-----|---------|---------|---------|
| **新消息延迟** | < 10ms | 0-30 秒 | < 10ms ✅ |
| **历史数据** | ❌ | ✅ | ✅ |
| **可靠性** | ⚠️ 中 | ✅ 高 | ✅ 最高 |
| **资源消耗** | 极低 | 中 | 低 |

---

## 二、30 秒快速启用

### 1. 配置账户

在 Master 数据库的 `accounts` 表中，设置 `monitoring_config` 字段:

```json
{
  "enableRealtimeMonitor": true,
  "crawlIntervalMin": 5,
  "crawlIntervalMax": 10
}
```

### 2. 重启 Worker

```bash
cd packages/worker
npm start
```

### 3. 验证

查看 Worker 日志:

```
✅ 实时监控启动成功 (账户: xxx)
   Hook 安装: 2/2 (msgListToPush + noticePushList)

   MonitorTask 间隔: 5-10 分钟 (random)
```

---

## 三、配置选项

### 完整配置示例

```json
{
  "enableRealtimeMonitor": true,   // 是否启用实时监控
  "crawlIntervalMin": 5,            // 最小爬虫间隔 (分钟)
  "crawlIntervalMax": 10            // 最大爬虫间隔 (分钟)
}
```

### 推荐配置

#### 场景 1: 生产环境 (推荐)
```json
{
  "enableRealtimeMonitor": true,
  "crawlIntervalMin": 5,
  "crawlIntervalMax": 10
}
```
- ✅ 零延迟新消息
- ✅ 历史数据完整
- ✅ 资源消耗低

#### 场景 2: 测试环境
```json
{
  "enableRealtimeMonitor": true,
  "crawlIntervalMin": 1,
  "crawlIntervalMax": 2
}
```
- ✅ 快速验证
- ⚠️ 资源消耗较高

#### 场景 3: 仅定时爬虫
```json
{
  "enableRealtimeMonitor": false,
  "crawlIntervalMin": 3,
  "crawlIntervalMax": 5
}
```
- ❌ 无实时监控
- ✅ 降低资源消耗

---

## 四、工作原理

### 实时监控流程

```javascript
// 1. 浏览器接收 WebSocket 推送
抖音服务器 → WebSocket → 浏览器前端

// 2. Redux Store 更新
msgListToPush.push(newMessage)  // 私信
noticePushList.push(newNotice)  // 评论

// 3. Hook 劫持 push() 方法
📍 Hook 触发 → window.__sendRealtimeData()

// 4. 发送到 Node.js
page.exposeFunction → DouyinRealtimeMonitor

// 5. 处理并推送
去重 → 格式化 → DataManager → Master
```

**延迟**: < 10ms

### 定时爬虫流程

```javascript
// 1. 定时触发
setTimeout(5-10 分钟随机间隔)

// 2. 爬取数据
Promise.all([
  crawlComments(),
  crawlDirectMessages()
])

// 3. 去重和推送
CacheHandler.filterNew() → Master
```

**延迟**: 0-10 分钟

---

## 五、查看状态

### 实时监控状态

```javascript
// 通过 Platform API
const status = platform.getRealtimeMonitorStatus(accountId);

console.log(status);
// {
//   isRunning: true,
//   hookInstalled: true,
//   account_id: 'xxx',
//   stats: {
//     messagesReceived: 10,
//     commentsReceived: 5,
//     messagesDuplicated: 0,
//     commentsDuplicated: 0,
//     runtime_seconds: 120,
//     cache_size: 15
//   }
// }
```

### 健康检查

```javascript
const healthy = await monitor.healthCheck();
console.log(healthy ? '✅ 正常' : '❌ 异常');
```

---

## 六、测试验证

### 运行测试脚本

```bash
cd tests
node test-hybrid-monitoring.js
```

### 测试项

1. **实时监控 Hook 注入** - 验证 Hook 脚本正确注入
2. **定时爬虫间隔配置** - 验证间隔在 5-10 分钟范围内
3. **Platform.js 集成** - 验证方法存在性和配置解析

### 预期结果

```
╔════════════════════════════════════════════════════════════╗
║        混合监控方案测试套件 (实时 + 定时爬虫)             ║
╚════════════════════════════════════════════════════════════╝

测试 2: 定时爬虫间隔配置 (5-10 分钟)
  ✅ 最小间隔: 5.00 分钟
  ✅ 最大间隔: 9.98 分钟
  ✅ 测试 2 完成! 间隔配置正确

测试 3: 混合方案集成 (platform.js)
  ✅ startRealtimeMonitor
  ✅ stopRealtimeMonitor
  ✅ getRealtimeMonitorStatus
  ✅ parseMonitoringConfig
  ✅ 测试 3 完成! 集成正确
```

---

## 七、常见问题

### Q1: 如何确认实时监控是否生效?

**A**: 查看浏览器控制台:

```
[Hook] 开始安装实时监控...
✅ [Hook] msgListToPush 数组劫持成功
✅ [Hook] noticePushList 数组劫持成功
✅ [Hook] 安装成功! (2/2)
```

### Q2: 定时爬虫间隔可以小于 5 分钟吗?

**A**: 可以,但不推荐:

```json
{
  "crawlIntervalMin": 1,  // 1 分钟
  "crawlIntervalMax": 2   // 2 分钟
}
```

频繁爬取可能被平台检测。建议:
- 生产环境: 5-10 分钟
- 测试环境: 1-3 分钟

### Q3: 实时监控失效了怎么办?

**A**: 定时爬虫会自动兜底,最多延迟 10 分钟。

检查失效原因:
1. 页面是否打开?
2. Hook 脚本是否注入成功?
3. 浏览器控制台是否有错误?

### Q4: 如何禁用实时监控?

**A**: 修改配置:

```json
{
  "enableRealtimeMonitor": false
}
```

重启 Worker 后生效。

### Q5: 实时监控占用多少资源?

**A**: 极低:
- CPU: < 0.1%
- 内存: < 5MB
- 网络: 0 (仅监听,不发送请求)

---

## 八、核心文件位置

| 文件 | 位置 | 说明 |
|-----|------|------|
| **Hook 脚本** | `packages/worker/src/platforms/douyin/hooks/install-realtime-hooks.js` | 浏览器端 Hook |
| **实时监控管理器** | `packages/worker/src/platforms/douyin/realtime-monitor.js` | Node.js 端管理 |
| **Platform 集成** | `packages/worker/src/platforms/douyin/platform.js` | 启动/停止/状态查询 |
| **MonitorTask** | `packages/worker/src/handlers/monitor-task.js` | 定时爬虫 |
| **测试脚本** | `tests/test-hybrid-monitoring.js` | 完整测试套件 |

---

## 九、下一步

### 使用指南

1. ✅ **阅读完整文档**
   - [混合监控方案实现总结](./混合监控方案实现总结-2025-11-06.md)
   - [文件重命名方案](./Douyin平台文件重命名方案-2025-11-06.md)

2. ✅ **配置账户**
   - 修改 `accounts.monitoring_config`
   - 重启 Worker

3. ✅ **验证功能**
   - 运行测试脚本
   - 查看实时监控状态
   - 发送测试消息验证

4. ✅ **监控运行**
   - 查看 Worker 日志
   - 监控统计数据
   - 优化配置参数

---

## 十、支持和反馈

### 文档资源

- **实现总结**: [混合监控方案实现总结-2025-11-06.md](./混合监控方案实现总结-2025-11-06.md)
- **开发计划**: [实时监控+历史爬虫混合方案开发计划-v4-最终版-2025-11-06.md](./实时监控+历史爬虫混合方案开发计划-v4-最终版-2025-11-06.md)

### 问题反馈

如遇问题,请提供:
1. Worker 日志
2. 浏览器控制台日志
3. 配置信息
4. 复现步骤

---

**快速开始指南版本**: v1.0
**最后更新**: 2025-11-06
