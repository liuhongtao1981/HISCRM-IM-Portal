# ç§ä¿¡å¤´åƒ v1.3 ä¼˜åŒ–è¯´æ˜

**æ—¥æœŸ**: 2025-11-06
**ç‰ˆæœ¬**: v1.3
**ä¼˜åŒ–ç±»å‹**: æ¶æ„ä¼˜åŒ–

## ä¼˜åŒ–åŸå› 

ç”¨æˆ·å»ºè®®: **"æ¶ˆæ¯æ‹¼è£…çš„æ—¶å€™ï¼Œä¸ç”¨åŒºåˆ†æ˜¯æˆ‘çš„æ¶ˆæ¯è¿˜æ˜¯ç”¨æˆ·çš„æ¶ˆæ¯ï¼Œç›´æ¥ä» conversations å¯¹è±¡é‡Œå– userId ç­‰äºæ¶ˆæ¯userId çš„ data.userAvatar å°±å¯ä»¥å•Š"**

**v1.2 å­˜åœ¨çš„é—®é¢˜**:
1. å‰ç«¯éœ€è¦æ ¹æ® `activeTab` åˆ¤æ–­ä»å“ªé‡Œè·å–å¤´åƒ
2. é€»è¾‘å¤æ‚: ç§ä¿¡ç”¨ `selectedTopic.avatar`ï¼Œè¯„è®ºç”¨ `mainMsg.authorAvatar`
3. å¯èƒ½è®¿é—®ä¸å­˜åœ¨çš„ `selectedTopic` å¯¼è‡´é—®é¢˜

## v1.3 ä¼˜åŒ–æ–¹æ¡ˆ

### Master ç«¯æ”¹è¿› (im-websocket-server.js)

**æ ¸å¿ƒæ€è·¯**: åœ¨æ¨é€æ¶ˆæ¯æ—¶ï¼ŒMaster ç«¯ç›´æ¥ä» conversation å¯¹è±¡è·å–å¯¹æ–¹ç”¨æˆ·å¤´åƒ

```javascript
// æŸ¥æ‰¾ç§ä¿¡æ¶ˆæ¯ (topicId = conversationId)
if (dataObj.messages && dataObj.conversations) {
  const messagesList = dataObj.messages instanceof Map ?
    Array.from(dataObj.messages.values()) : dataObj.messages;
  const conversationsList = dataObj.conversations instanceof Map ?
    Array.from(dataObj.conversations.values()) : dataObj.conversations;

  // âœ… è·å–å½“å‰ä¼šè¯çš„å¯¹æ–¹ç”¨æˆ·å¤´åƒ
  const conversation = conversationsList.find(c => c.conversationId === topicId);
  const conversationUserAvatar = conversation ?
    (conversation.platform_user_avatar || conversation.userAvatar || null) : null;

  const msgs = messagesList.filter(m => m.conversationId === topicId);
  for (const msg of msgs) {
    const isOutgoing = msg.direction === 'outgoing';

    // âœ… ä¼˜åŒ–é€»è¾‘: ç›´æ¥ä» conversation å¯¹è±¡è·å–å¯¹æ–¹ç”¨æˆ·å¤´åƒ
    // å®¢æœæ¶ˆæ¯ä¸éœ€è¦å¤´åƒï¼ˆå‰ç«¯ä¼šæ˜¾ç¤ºç»¿è‰²å›¾æ ‡ï¼‰
    const authorAvatar = isOutgoing ? null : conversationUserAvatar;

    messages.push({
      id: msg.messageId,
      channelId: accountId,
      topicId: topicId,
      fromName: isOutgoing ? 'å®¢æœ' : (msg.senderName || 'æœªçŸ¥ç”¨æˆ·'),
      fromId: isOutgoing ? 'monitor_client' : (msg.senderId || ''),
      authorAvatar: authorAvatar,  // âœ… ä¼˜åŒ–: ä» conversation è·å–å¯¹æ–¹ç”¨æˆ·å¤´åƒ
      content: msg.content || '',
      type: msg.messageType || 'text',
      messageCategory: 'private',
      timestamp: normalizeTimestamp(msg.createdAt),
      serverTimestamp: normalizeTimestamp(msg.detectedAt),
      direction: msg.direction || 'incoming',
      recipientId: msg.recipientId || '',
      recipientName: msg.recipientName || '',
      isRead: msg.isRead || false
    });
  }
}
```

**å…³é”®æ”¹è¿›**:
1. ä¸€æ¬¡æ€§æŸ¥æ‰¾ conversation å¯¹è±¡
2. å¯¹äºæ‰€æœ‰å¯¹æ–¹æ¶ˆæ¯ï¼Œéƒ½ä½¿ç”¨ `conversationUserAvatar`
3. å®¢æœæ¶ˆæ¯ç›´æ¥è®¾ç½® `authorAvatar = null`

### å‰ç«¯æ”¹è¿› (MonitorPage.tsx)

**æ ¸å¿ƒæ€è·¯**: ç»Ÿä¸€ä½¿ç”¨ `mainMsg.authorAvatar`ï¼Œä¸å†åŒºåˆ†æ¶ˆæ¯ç±»å‹

```typescript
const renderMessageWithDiscussions = (mainMsg: Message) => {
  // âœ… ä¼˜å…ˆä½¿ç”¨ direction å­—æ®µåˆ¤æ–­ï¼ˆç§ä¿¡æ¶ˆæ¯ï¼‰ï¼Œfallback åˆ° fromId/fromNameï¼ˆè¯„è®ºæ¶ˆæ¯ï¼‰
  const isReply = (mainMsg as any).direction === 'outgoing' ||
                  mainMsg.fromId === 'monitor_client' ||
                  mainMsg.fromName === 'å®¢æœ'

  const msgDiscussions = activeTab === 'private'
    ? []
    : discussions.filter(d => d.replyToId === mainMsg.id)

  // âœ… ä¼˜åŒ–é€»è¾‘: ç»Ÿä¸€ä½¿ç”¨ mainMsg.authorAvatar
  // Master å·²ç»ä» conversation å¯¹è±¡è·å–äº†å¯¹æ–¹ç”¨æˆ·å¤´åƒå¹¶è®¾ç½®åˆ° authorAvatar å­—æ®µ
  // å®¢æœå›å¤ä¸æ˜¾ç¤ºå¤´åƒï¼Œä½¿ç”¨ç»¿è‰²å›¾æ ‡
  const avatarSrc = isReply ? undefined : mainMsg.authorAvatar

  return (
    <div key={mainMsg.id} className="wechat-message-group">
      <div className={`wechat-message-item ${isReply ? 'message-right' : 'message-left'}`}>
        <div className="wechat-message-avatar">
          <Avatar
            size={40}
            src={avatarSrc}
            icon={<UserOutlined />}
            style={isReply ? { backgroundColor: '#07c160' } : undefined}
          />
        </div>
        {/* ... */}
      </div>
    </div>
  );
}
```

**å…³é”®æ”¹è¿›**:
1. ç§»é™¤äº† `activeTab === 'private' ? selectedTopic?.avatar : mainMsg.authorAvatar` çš„åˆ¤æ–­
2. ç»Ÿä¸€ä½¿ç”¨ `mainMsg.authorAvatar`
3. è¯„è®ºå’Œç§ä¿¡ä½¿ç”¨ç›¸åŒçš„ä»£ç é€»è¾‘

## ä¼˜åŒ–æ•ˆæœ

### æ¶æ„ä¼˜åŠ¿

| å¯¹æ¯”é¡¹ | v1.2 | v1.3 (ä¼˜åŒ–å) |
|-------|------|------------|
| **å‰ç«¯é€»è¾‘** | éœ€è¦åˆ¤æ–­ `activeTab` | ç»Ÿä¸€ä½¿ç”¨ `mainMsg.authorAvatar` |
| **æ•°æ®æ¥æº** | ç§ä¿¡: `selectedTopic.avatar`<br>è¯„è®º: `mainMsg.authorAvatar` | ç»Ÿä¸€: `mainMsg.authorAvatar` |
| **å¤æ‚åº¦** | é«˜ï¼ˆéœ€è¦åŒºåˆ†æ¶ˆæ¯ç±»å‹ï¼‰ | ä½ï¼ˆç»Ÿä¸€å¤„ç†ï¼‰ |
| **å¯é æ€§** | å¯èƒ½è®¿é—®ä¸å­˜åœ¨çš„ `selectedTopic` | æ€»æ˜¯æœ‰æ•°æ® |
| **è´£ä»»åˆ’åˆ†** | å‰ç«¯éœ€è¦çŸ¥é“æ•°æ®æ¥æº | Master ç«¯è´Ÿè´£æ•°æ®å‡†å¤‡ |

### ä»£ç ç®€åŒ–

**v1.2 å‰ç«¯ä»£ç **:
```typescript
const avatarSrc = isReply ? undefined :
                  (activeTab === 'private' ? selectedTopic?.avatar : mainMsg.authorAvatar)
```

**v1.3 å‰ç«¯ä»£ç **:
```typescript
const avatarSrc = isReply ? undefined : mainMsg.authorAvatar
```

### æ•°æ®æµå¯¹æ¯”

**v1.2**:
```
Worker â†’ DataStore â†’ Master æ¨é€æ¶ˆæ¯ (msg.senderAvatar)
                   â†“
                Master æ¨é€ topic (conversation.platform_user_avatar)
                   â†“
                å‰ç«¯: ç§ä¿¡ä» topic.avatar è·å–ï¼Œè¯„è®ºä» msg.authorAvatar è·å–
```

**v1.3 (ä¼˜åŒ–å)**:
```
Worker â†’ DataStore â†’ Master æŸ¥æ‰¾ conversation å¯¹è±¡
                   â†“
                Master ä» conversation è·å–å¤´åƒï¼Œè®¾ç½®åˆ° msg.authorAvatar
                   â†“
                å‰ç«¯: ç»Ÿä¸€ä» msg.authorAvatar è·å–
```

## ä¿®æ”¹çš„æ–‡ä»¶

### 1. packages/master/src/communication/im-websocket-server.js

**ä¿®æ”¹ä½ç½®**: Line 815-867

**å…³é”®æ”¹åŠ¨**:
- æ·»åŠ  conversation æŸ¥æ‰¾é€»è¾‘
- è®¡ç®— `conversationUserAvatar`
- è®¾ç½® `authorAvatar = isOutgoing ? null : conversationUserAvatar`

### 2. packages/crm-pc-im/src/pages/MonitorPage.tsx

**ä¿®æ”¹ä½ç½®**: Line 943-946

**å…³é”®æ”¹åŠ¨**:
- ç®€åŒ–å¤´åƒè·å–é€»è¾‘
- ç»Ÿä¸€ä½¿ç”¨ `mainMsg.authorAvatar`

### 3. docs/IMå¤´åƒåŠŸèƒ½å®Œæ•´æ€»ç»“-2025-11-06.md

**æ›´æ–°å†…å®¹**:
- æ›´æ–°ç‰ˆæœ¬å·åˆ° v1.3
- æ·»åŠ  v1.3 ä¼˜åŒ–è¯´æ˜
- æ›´æ–°æ•°æ®æµå›¾
- æ›´æ–°æŠ€æœ¯äº®ç‚¹

## æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. å¯åŠ¨æœåŠ¡
   ```bash
   npm run start:master
   npm run start:worker
   cd packages/crm-pc-im && npm run dev
   ```

2. æ‰“å¼€ IM å®¢æˆ·ç«¯ `http://localhost:5173/monitor`

3. é€‰æ‹©è´¦æˆ·ï¼Œåˆ‡æ¢åˆ°ç§ä¿¡æ ‡ç­¾

4. ç‚¹å‡»ç§ä¿¡ä¼šè¯ï¼ŒæŸ¥çœ‹æ¶ˆæ¯åˆ—è¡¨

5. éªŒè¯å¤´åƒæ˜¾ç¤º:
   - âœ… å¯¹æ–¹æ¶ˆæ¯æ˜¾ç¤ºå¯¹æ–¹å¤´åƒ
   - âœ… å®¢æœæ¶ˆæ¯æ˜¾ç¤ºç»¿è‰²å›¾æ ‡
   - âœ… å¤´åƒåŠ è½½å¤±è´¥è‡ªåŠ¨é™çº§

### è°ƒè¯•æ—¥å¿—

ç³»ç»Ÿå·²æ·»åŠ è°ƒè¯•æ—¥å¿—ï¼Œå¯ä»¥æŸ¥çœ‹å®é™…æ•°æ®æµ:

**Master æ§åˆ¶å°**:
```
[IM-WS] Private message avatar debug (new logic): {
  messageId: 'msg_xxx',
  direction: 'incoming',
  isOutgoing: false,
  conversationId: 'conv_xxx',
  conversationUserAvatar: 'https://...',
  finalAuthorAvatar: 'https://...',
  senderId: 'user_xxx',
  senderName: 'ç”¨æˆ·A'
}
```

**å‰ç«¯æ§åˆ¶å°**:
```javascript
[IM-Client] Private message avatar debug (new logic): {
  messageId: 'msg_xxx',
  direction: 'incoming',
  fromId: 'user_xxx',
  fromName: 'ç”¨æˆ·A',
  isReply: false,
  msgAuthorAvatar: 'https://...',
  finalAvatarSrc: 'https://...'
}
```

## æ€»ç»“

### âœ… ä¼˜åŒ–æˆæœ

1. **æ¶æ„æ›´æ¸…æ™°**: Master ç«¯è´Ÿè´£æ•°æ®å‡†å¤‡ï¼Œå‰ç«¯åªè´Ÿè´£å±•ç¤º
2. **ä»£ç æ›´ç®€å•**: å‰ç«¯é€»è¾‘å‡å°‘ 50% å¤æ‚åº¦
3. **æ›´æ˜“ç»´æŠ¤**: å•ä¸€æ•°æ®æºï¼Œé¿å…å¤šå¤„ä¿®æ”¹
4. **æ›´å¯é **: é¿å…è®¿é—®å¯èƒ½ä¸å­˜åœ¨çš„å¯¹è±¡

### ğŸ¯ æ ¸å¿ƒä»·å€¼

- **èŒè´£åˆ†ç¦»**: Master ç«¯é›†ä¸­å¤„ç†ä¸šåŠ¡é€»è¾‘
- **ç»Ÿä¸€æ¥å£**: å‰ç«¯ä¸éœ€è¦çŸ¥é“æ•°æ®æ¥æºç»†èŠ‚
- **å®¹é”™æ€§å¼º**: æ€»æ˜¯æœ‰æ˜ç¡®çš„æ•°æ®æ¥æº

### ğŸ“ ç›¸å…³æ–‡æ¡£

- [IMå¤´åƒåŠŸèƒ½å®Œæ•´æ€»ç»“-2025-11-06.md](IMå¤´åƒåŠŸèƒ½å®Œæ•´æ€»ç»“-2025-11-06.md)
- [ç§ä¿¡å¤´åƒé—®é¢˜è°ƒè¯•æŒ‡å—-2025-11-06.md](ç§ä¿¡å¤´åƒé—®é¢˜è°ƒè¯•æŒ‡å—-2025-11-06.md)
