# 登录助手优化记录 - 支持手动关闭浏览器

## 问题描述

用户在完成手动登录后关闭浏览器，但登录状态没有回传给系统。日志显示：

```
[登录助手] 等待用户头像出现...
[登录助手] 等待登录超时: page.waitForSelector: Target page, context or browser has been closed
[登录助手] ❌ 登录超时
[登录助手] 用户取消登录（手动关闭了浏览器）
```

**根本原因**：
- 登录助手在检测到 URL 跳转到创作者中心后，继续等待用户头像元素加载
- 如果用户在头像加载前关闭浏览器，程序会认为登录失败
- 实际上 URL 已跳转意味着登录很可能成功了，只是页面还没完全加载

## 优化方案

### 方案 1：自动关闭浏览器（默认流程）

**工作流程**：
1. 用户完成登录（扫码/短信验证等）
2. 检测到 URL 跳转到创作者中心
3. 检测到用户头像元素加载（确认登录成功）
4. 在页面上显示绿色横幅："✅ 登录成功！2秒后自动关闭浏览器..."
5. 提取 storageState（cookies 等）
6. 发送给 Master 服务器
7. 2 秒后自动关闭浏览器

**优势**：
- 用户无需手动操作
- 体验流畅，有明确的成功反馈
- 避免用户忘记关闭浏览器

### 方案 2：手动关闭浏览器（备用流程）

**工作流程**：
1. 用户完成登录
2. URL 跳转到创作者中心
3. 用户在头像加载前手动关闭浏览器
4. 系统在 `close` 事件中检查当前 URL
5. 如果 URL 在创作者中心，尝试提取 storageState
6. 发送给 Master 服务器

**优势**：
- 支持用户快速关闭（不等待页面完全加载）
- 容错性强，不会丢失登录状态

## 代码修改

### 1. 添加状态引用

**文件**: [login-assistant.js](../packages/crm-pc-im/src/main/login-assistant.js#L13-L22)

```javascript
class LoginAssistant {
    constructor(socketClient) {
        this.socketClient = socketClient;
        this.activeBrowser = null;
        this.currentContext = null;      // ✅ 保存浏览器上下文引用
        this.currentPage = null;          // ✅ 保存页面引用
        this.currentPlatform = null;      // ✅ 保存平台信息
        this.loginSuccess = false;
        this.currentAccountId = null;
        this.currentTempDir = null;
        // ...
    }
}
```

### 2. 保存上下文引用

**文件**: [login-assistant.js](../packages/crm-pc-im/src/main/login-assistant.js#L80-L94)

```javascript
// 保存引用（用于后续清理和断开连接时提取状态）
this.activeBrowser = context;
this.currentContext = context;
this.currentPlatform = platform;

// 使用 launchPersistentContext 创建的默认页面
const pages = context.pages();
const page = pages.length > 0 ? pages[0] : await context.newPage();

// 保存页面引用
this.currentPage = page;
```

### 3. 添加 URL 检查方法

**文件**: [login-assistant.js](../packages/crm-pc-im/src/main/login-assistant.js#L277-L287)

```javascript
/**
 * 检查 URL 是否是登录后页面
 */
checkIfLoggedInUrl(url, platform) {
    if (platform === 'douyin') {
        return url.includes('creator.douyin.com') && !url.includes('/passport');
    } else if (platform === 'xiaohongshu') {
        return url.includes('creator.xiaohongshu.com') && !url.includes('/login');
    }
    return false;
}
```

### 4. 优化浏览器关闭处理

**文件**: [login-assistant.js](../packages/crm-pc-im/src/main/login-assistant.js#L202-L275)

```javascript
async handleBrowserDisconnected() {
    console.log('[登录助手] 🔴 浏览器已断开连接');

    // 如果还没标记为登录成功，尝试检查是否实际已登录
    if (!this.loginSuccess && this.currentAccountId && this.currentContext && this.currentPage) {
        try {
            // 检查页面 URL 是否已经跳转到登录后页面
            const currentUrl = this.currentPage.url();
            const isLoggedInUrl = this.checkIfLoggedInUrl(currentUrl, this.currentPlatform);

            if (isLoggedInUrl) {
                console.log('[登录助手] ✅ 检测到用户已登录（URL 确认）');

                // 尝试提取登录状态
                const storageState = await this.currentContext.storageState();

                console.log(`[登录助手] ✅ 登录状态已提取`);
                console.log(`   Cookies: ${storageState.cookies.length} 个`);

                // 发送给 Master
                this.socketClient.emit('client:manual-login-success', {
                    accountId: this.currentAccountId,
                    platform: this.currentPlatform,
                    storageState,
                    timestamp: Date.now()
                });

                console.log('[登录助手] ✅ 登录数据已发送给 Master');
                this.sendToRenderer('login-success', { accountId: this.currentAccountId });
                this.loginSuccess = true;
            } else {
                console.log('[登录助手] 用户取消登录（未检测到登录成功）');
                this.sendToRenderer('login-cancelled', { accountId: this.currentAccountId });
            }
        } catch (error) {
            console.error('[登录助手] 检查登录状态失败:', error.message);
            this.sendToRenderer('login-cancelled', { accountId: this.currentAccountId });
        }
    }

    // 清理资源...
}
```

### 5. 添加视觉反馈

**文件**: [login-assistant.js](../packages/crm-pc-im/src/main/login-assistant.js#L191-L213)

```javascript
// 在页面上显示登录成功提示
await page.evaluate(() => {
    const banner = document.createElement('div');
    banner.innerHTML = `
        <div style="
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #52c41a;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 999999;
        ">
            ✅ 登录成功！2秒后自动关闭浏览器...
        </div>
    `;
    document.body.appendChild(banner);
});
```

### 6. 自动关闭浏览器

**文件**: [login-assistant.js](../packages/crm-pc-im/src/main/login-assistant.js#L132-L137)

```javascript
// 等待 2 秒让用户看到登录成功提示
console.log('[登录助手] ⏱️  2秒后自动关闭浏览器...');
await new Promise(resolve => setTimeout(resolve, 2000));

// 关闭浏览器（会触发 'close' 事件）
await this.cleanup();
```

## 登录检测逻辑（与 Worker 一致）

登录成功的判断条件：
1. **URL 检查**：URL 包含 `creator.douyin.com` 且不包含 `/passport`
2. **元素检查**：页面上存在 `[class*="user-avatar"]` 元素

这与 Worker 爬虫的登录检测逻辑完全一致，确保两端行为统一。

## 用户体验

### 自动关闭流程（推荐）

1. 用户扫码/输入验证码完成登录
2. 页面自动跳转到创作者中心
3. 顶部出现绿色横幅："✅ 登录成功！2秒后自动关闭浏览器..."
4. 2 秒后浏览器自动关闭
5. Electron 客户端显示登录成功提示

### 手动关闭流程（备用）

1. 用户扫码/输入验证码完成登录
2. 页面开始跳转到创作者中心
3. 用户立即关闭浏览器（无需等待）
4. 系统自动检测 URL 并提取登录状态
5. Electron 客户端显示登录成功提示

## 技术要点

### 事件监听

- **之前**：`browser.on('disconnected')`
- **现在**：`context.on('close')`（配合 `launchPersistentContext`）

### 状态提取时机

- **方式 1**：`waitForLogin` 成功后，在关闭前提取
- **方式 2**：`close` 事件触发时，根据 URL 判断是否提取

### 容错机制

- 如果 `page.url()` 调用失败（页面已销毁），捕获异常并记录
- 如果 `storageState()` 提取失败，不会影响清理流程
- 所有异常都会记录日志，方便调试

## 测试建议

### 测试场景 1：正常自动关闭

1. 点击"手动登录"按钮
2. 扫码完成登录
3. 等待页面跳转和头像加载
4. 观察绿色横幅提示
5. 验证 2 秒后自动关闭
6. 检查 Master 日志，确认收到登录数据

### 测试场景 2：快速手动关闭

1. 点击"手动登录"按钮
2. 扫码完成登录
3. 页面开始跳转时立即关闭浏览器（不等待完全加载）
4. 检查 Master 日志，确认收到登录数据

### 测试场景 3：登录前关闭

1. 点击"手动登录"按钮
2. 不扫码，直接关闭浏览器
3. 验证显示"登录已取消"提示
4. 检查 Master 日志，确认未收到登录数据

## 相关文件

- [login-assistant.js](../packages/crm-pc-im/src/main/login-assistant.js) - 登录助手主要逻辑
- [登录助手Playwright-API修复记录.md](./登录助手Playwright-API修复记录.md) - Playwright API 修复

## 修复日期

2025-11-25

## 与 Worker 的一致性

| 特性 | Worker 爬虫 | 登录助手 | 是否一致 |
|------|------------|---------|---------|
| URL 检查 | `creator.douyin.com` | `creator.douyin.com` | ✅ |
| 头像元素 | `[class*="user-avatar"]` | `[class*="user-avatar"]` | ✅ |
| 登录判断 | URL + 头像 | URL + 头像 | ✅ |
| 状态提取 | `storageState()` | `storageState()` | ✅ |
