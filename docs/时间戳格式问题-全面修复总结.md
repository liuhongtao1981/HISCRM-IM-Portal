# 时间戳格式问题 - 全面修复总结

## 时间: 2025-11-05 09:50

## 问题汇总

用户发现了系统中多个时间戳格式不一致的问题：

1. ✅ **私信时间显示问题** - IM 客户端所有会话显示 "01/01 08:33"
2. ✅ **作品发布时间格式错误** - `cache_contents.publishTime` 存储中文字符串

## 根本原因

系统中混用了三种时间格式，导致在不同环节出现解析错误：

### 格式1: 毫秒时间戳（数字）
```javascript
1762304707004  // 13位数字
```
- **预期用途**: 内部传输和存储的标准格式
- **实际情况**: 部分地方未统一使用

### 格式2: ISO 8601 字符串
```javascript
"2025-11-04T15:58:27.004Z"
```
- **预期用途**: 日志和调试
- **实际情况**: Worker 发送给 Master 的数据中混用

### 格式3: 中文日期字符串
```javascript
"发布于2025年11月04日 14:16"
```
- **来源**: 抖音 API 的 `create_time` 字段
- **问题**: 直接存储，未解析为时间戳

## 完整修复方案

### 修复1: 私信时间戳 (Worker → Master)

**问题**: Worker 发送 ISO 字符串，Master 解析错误

**文件**: `packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js`

**修改位置**: Line 1405-1406

**修改前**:
```javascript
timestamp: props.createdAt || props.timestamp || props.createTime || new Date().toISOString(),
created_at: props.createdAt || props.timestamp || props.createTime || new Date().toISOString(),
```

**修改后**:
```javascript
timestamp: normalizeTimestamp(props.createdAt || props.timestamp || props.createTime),
created_at: normalizeTimestamp(props.createdAt || props.timestamp || props.createTime),
```

**效果**: 统一发送毫秒时间戳（数字）

### 修复2: Master 端 ISO 字符串解析

**问题**: `parseInt("2025-11-04T...")` 返回 `2025`，导致时间显示为 1970-01-01

**文件**: `packages/master/src/communication/im-websocket-server.js`

**修改位置**: 3处 `normalizeTimestamp()` 函数
- Line 304-309: `getTopicsFromDataStore()` 内部
- Line 504-510: `handleAdminSync()` 内部
- Line 667-672: `findLastMessage()` 内部

**修改内容**: 在 `parseInt()` 之前添加 ISO 8601 格式检测

```javascript
if (typeof timestamp === 'string') {
  // ✅ 优先检测 ISO 8601 格式
  if (timestamp.includes('T') || timestamp.includes('-')) {
    const isoDate = new Date(timestamp);
    if (!isNaN(isoDate.getTime())) {
      return isoDate.getTime();
    }
  }

  // 然后处理中文格式...
  // 最后才使用 parseInt()...
}
```

**效果**: 正确解析 ISO 字符串为毫秒时间戳

### 修复3: 作品发布时间 (中文字符串解析)

**问题**: 抖音 API 的 `create_time` 是中文字符串 `"发布于2025年11月04日 14:16"`

#### 修复3.1: crawl-contents.js

**文件**: `packages/worker/src/platforms/douyin/crawl-contents.js`

**修改位置**: Line 531-547

**修改前**:
```javascript
publish_time: apiData.create_time || work.publish_time,
```

**修改后**:
```javascript
// 解析 publish_time (可能是中文字符串或时间戳)
let publishTime = apiData.create_time || work.publish_time;
if (publishTime && typeof publishTime === 'string') {
  // 尝试解析中文日期字符串 "发布于2025年11月04日 14:16"
  const match = publishTime.match(/(\d{4})年(\d{1,2})月(\d{1,2})日\s+(\d{1,2}):(\d{2})/);
  if (match) {
    const [, year, month, day, hour, minute] = match;
    const date = new Date(
      parseInt(year),
      parseInt(month) - 1,
      parseInt(day),
      parseInt(hour),
      parseInt(minute)
    );
    publishTime = Math.floor(date.getTime() / 1000); // 秒级时间戳
  }
}

publish_time: publishTime,
```

#### 修复3.2: douyin-data-manager.js

**文件**: `packages/worker/src/platforms/douyin/douyin-data-manager.js`

**修改位置**: Line 218, 229

**修改前**:
```javascript
publishTime: douyinData.create_time || douyinData.publish_time || Date.now(),
createdAt: douyinData.create_time || Date.now(),
```

**修改后**:
```javascript
publishTime: this.parsePublishTime(douyinData.create_time || douyinData.publish_time),
createdAt: this.parsePublishTime(douyinData.create_time),
```

**新增方法** (Line 466-505):
```javascript
/**
 * 解析发布时间（支持中文字符串和时间戳）
 */
parsePublishTime(publishTime) {
  if (!publishTime) return Date.now();

  // 如果已经是数字（时间戳），直接返回
  if (typeof publishTime === 'number') {
    return publishTime < 10000000000 ? publishTime * 1000 : publishTime;
  }

  // 如果是字符串，尝试解析中文日期 "发布于2025年11月04日 14:16"
  if (typeof publishTime === 'string') {
    const match = publishTime.match(/(\d{4})年(\d{1,2})月(\d{1,2})日\s+(\d{1,2}):(\d{2})/);
    if (match) {
      const [, year, month, day, hour, minute] = match;
      const date = new Date(
        parseInt(year),
        parseInt(month) - 1,
        parseInt(day),
        parseInt(hour),
        parseInt(minute)
      );
      return date.getTime(); // 毫秒时间戳
    }

    // 尝试其他格式...
  }

  return Date.now();
}
```

**效果**: 正确解析中文日期字符串为毫秒时间戳

## 修复后的数据流

### 私信数据流

```
Worker (虚拟列表)
  ↓
  props.createdAt = "2025-11-04T15:58:27.004Z" (ISO 字符串)
  ↓
  normalizeTimestamp() → 1762304707004 (毫秒时间戳) ✅
  ↓
Master DataStore
  ↓
  存储数字 1762304707004 ✅
  ↓
IM WebSocket Server
  ↓
  直接传递数字 ✅
  ↓
IM Client
  ↓
  显示: 11/04 15:58 ✅
```

### 作品数据流

```
Worker (API拦截)
  ↓
  apiData.create_time = "发布于2025年11月04日 14:16" (中文字符串)
  ↓
  parsePublishTime() / 正则解析 → 1730708160000 (毫秒时间戳) ✅
  ↓
  standardizeWorkData() → Math.floor(timestamp / 1000) → 1730708160 (秒级) ✅
  ↓
Master DataStore
  ↓
  cache_contents.publishTime = 1730708160 ✅
  ↓
IM WebSocket Server
  ↓
  normalizeTimestamp() → 1730708160000 (转为毫秒) ✅
  ↓
IM Client
  ↓
  显示: 11/04 14:16 ✅
```

## 时间格式标准

### 系统统一标准

| 位置 | 格式 | 示例 | 说明 |
|------|------|------|------|
| Worker → Master | 毫秒时间戳 (数字) | `1762304707004` | 所有数据传输 |
| Master DataStore | 毫秒时间戳 (数字) | `1762304707004` | 内存缓存 |
| Master → IM Client | 毫秒时间戳 (数字) | `1762304707004` | WebSocket 传输 |
| 数据库 `cache_messages.createdAt` | ISO 8601 字符串 | `"2025-11-04T15:58:27.004Z"` | 可读性，查询用 |
| 数据库 `cache_messages.updatedAt` | 毫秒时间戳 (数字) | `1762304707004` | 排序、计算用 |
| 数据库 `contents.publish_time` | 秒时间戳 (数字) | `1730708160` | 历史兼容性 |

### 格式转换函数

**Worker 端**:
```javascript
// crawl-direct-messages-v2.js
function normalizeTimestamp(timestamp) {
  // 支持: 毫秒戳、秒戳、ISO字符串、Date对象
  // 输出: 毫秒时间戳 (数字)
  // 包含时区修正: UTC+8 → UTC
}
```

**Master 端**:
```javascript
// im-websocket-server.js
const normalizeTimestamp = (timestamp) => {
  // 支持: ISO字符串、中文字符串、毫秒戳、秒戳
  // 输出: 毫秒时间戳 (数字)
  // 优先级: ISO > 中文 > 数字
}
```

**作品解析**:
```javascript
// douyin-data-manager.js
parsePublishTime(publishTime) {
  // 支持: 中文字符串、毫秒戳、秒戳、ISO字符串
  // 输出: 毫秒时间戳 (数字)
}
```

## 验证步骤

### 1. 验证私信时间

```bash
# 重启 Worker 和 Master
cd packages/worker && npm start
cd packages/master && npm start

# 等待数据抓取后检查
cd packages/master && node -e "
const db = require('better-sqlite3')('./data/master.db');
const msgs = db.prepare('SELECT data FROM cache_messages LIMIT 5').all();
msgs.forEach((row, i) => {
  const data = JSON.parse(row.data);
  console.log(\`消息\${i+1}: \${typeof data.createdAt} - \${data.createdAt}\`);
});
db.close();
"
```

**预期输出**:
```
消息1: number - 1762304707004  ✅
消息2: number - 1762304030221  ✅
```

**错误输出**:
```
消息1: string - 2025-11-04T15:58:27.004Z  ❌
```

### 2. 验证作品发布时间

```bash
cd packages/master && node -e "
const db = require('better-sqlite3')('./data/master.db');
const contents = db.prepare('SELECT data FROM cache_contents LIMIT 5').all();
contents.forEach((row, i) => {
  const data = JSON.parse(row.data);
  console.log(\`作品\${i+1}:\`);
  console.log(\`  publishTime类型: \${typeof data.publishTime}\`);
  console.log(\`  publishTime值: \${data.publishTime}\`);
  if (typeof data.publishTime === 'number') {
    console.log(\`  转换: \${new Date(data.publishTime * 1000).toLocaleString('zh-CN')}\`);
  }
});
db.close();
"
```

**预期输出**:
```
作品1:
  publishTime类型: number  ✅
  publishTime值: 1730708160  ✅
  转换: 2025/11/4 14:16:00  ✅
```

**错误输出**:
```
作品1:
  publishTime类型: string  ❌
  publishTime值: 发布于2025年11月04日 14:16  ❌
```

### 3. 验证 IM 客户端显示

打开 IM 客户端，检查：

**会话列表时间** (修复前 → 修复后):
```
❌ 01/01 08:33 (全部相同，1970年)
✅ 11/04 15:58 (各不相同，正确年份)
```

**作品列表时间** (修复前 → 修复后):
```
❌ 发布于2025年11月04日 14:16 (中文字符串)
✅ 11/04 14:16 (格式化后的时间)
```

## 修复文件清单

| 文件 | 修改内容 | 行数 |
|------|----------|------|
| `packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js` | 使用 normalizeTimestamp() 转换时间戳 | 1405-1406 |
| `packages/master/src/communication/im-websocket-server.js` | 添加 ISO 8601 格式检测 (3处) | 304-309, 504-510, 667-672 |
| `packages/worker/src/platforms/douyin/crawl-contents.js` | 解析中文日期字符串 | 531-547 |
| `packages/worker/src/platforms/douyin/douyin-data-manager.js` | 新增 parsePublishTime() 方法 | 218, 229, 466-505 |

## 技术总结

### parseInt() 的危险

```javascript
parseInt("2025-11-04T15:58:27.004Z")  // 2025 ← 只提取年份!
parseInt("发布于2025年11月04日")        // NaN
parseInt("2025")                       // 2025 ✅
```

**教训**: 永远不要对可能包含非数字字符的字符串使用 `parseInt()`

### 正则表达式解析中文日期

```javascript
const match = str.match(/(\d{4})年(\d{1,2})月(\d{1,2})日\s+(\d{1,2}):(\d{2})/);
// "发布于2025年11月04日 14:16"
// → ["2025年11月04日 14:16", "2025", "11", "04", "14", "16"]
```

**注意**: 月份从 0 开始，需要 `parseInt(month) - 1`

### 时区处理

Worker 的 `normalizeTimestamp()` 包含时区修正：

```javascript
// 抖音 API 返回 UTC+8 时间戳
const TIMEZONE_OFFSET_MS = 8 * 3600 * 1000;  // 8小时
return timestampInMs - TIMEZONE_OFFSET_MS;   // 转为 UTC
```

这确保所有时间戳都是标准 UTC 时间。

## 相关文档

- [时间戳格式统一问题-完整修复方案](./时间戳格式统一问题-完整修复方案.md) - 私信时间戳修复
- [时间戳显示问题-最终修复报告](./时间戳显示问题-最终修复报告.md) - Master 端修复详情
- [私信时间戳显示问题-完整修复报告](./私信时间戳显示问题-完整修复报告.md) - 问题发现过程

## 修复记录

- **私信时间问题发现**: 2025-11-05 09:10
- **Master 端修复**: 2025-11-05 09:35 (3个 normalizeTimestamp 函数)
- **Worker 端修复**: 2025-11-05 09:40 (私信时间戳统一)
- **作品时间问题发现**: 2025-11-05 09:45
- **作品时间修复**: 2025-11-05 09:50 (2个文件，3处修改)
- **测试状态**: ⏳ 待 Worker + Master 重启后验证

## 验证清单

### 私信相关
- [ ] Worker 重启
- [ ] Master 重启
- [ ] 等待新一轮私信抓取
- [ ] cache_messages.createdAt 为数字
- [ ] IM 客户端会话时间各不相同
- [ ] IM 客户端会话时间不是 "01/01 08:33"

### 作品相关
- [ ] 等待新一轮作品抓取
- [ ] cache_contents.publishTime 为数字（秒级）
- [ ] IM 客户端作品列表时间显示正确
- [ ] IM 客户端作品列表时间不是中文字符串

### 整体验证
- [ ] 浏览器控制台所有 timestamp 字段为数字
- [ ] 服务端日志无时间解析警告
- [ ] 所有时间显示为 2025年（非 1970年）
