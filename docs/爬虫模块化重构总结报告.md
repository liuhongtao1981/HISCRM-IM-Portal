# çˆ¬è™«æ¨¡å—åŒ–é‡æ„æ€»ç»“æŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-24
**ç‰ˆæœ¬**: v1.1
**çŠ¶æ€**: å·²å®Œæˆ (éƒ¨åˆ†é—®é¢˜å¾…è§£å†³)

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

æœ¬æ¬¡é‡æ„æˆåŠŸå°†è¯„è®ºå’Œç§ä¿¡çˆ¬è™«ä» `platform.js` ä¸­æŠ½ç¦»ä¸ºç‹¬ç«‹æ¨¡å—,æ˜¾è‘—æå‡äº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æµ‹è¯•æ€§ã€‚é‡æ„å:

- âœ… **è¯„è®ºçˆ¬å–** åŠŸèƒ½æ­£å¸¸ (4æ¡)
- âœ… **ç§ä¿¡çˆ¬å–** åŠŸèƒ½æ­£å¸¸ (15æ¡)
- âœ… **ä¼šè¯çˆ¬å–** åŠŸèƒ½æ­£å¸¸ (3ä¸ª)
- âŒ **è®¨è®ºæŠ“å–** æœªå®ç° (0æ¡,åº”æœ‰1æ¡)
- âš ï¸  **ä½œå“æŠ“å–** å·²ä¿®å¤ä½†æœªæµ‹è¯• (æ—§è¡¨æœ‰1ä¸ªè§†é¢‘,æ–°è¡¨0ä¸ª)

---

## ğŸ¯ é‡æ„ç›®æ ‡

### åŸå§‹ç›®æ ‡

1. **æ¨¡å—åŒ–çˆ¬è™«é€»è¾‘**: å°† `platform.js` ä¸­çš„çˆ¬è™«å®ç°æŠ½ç¦»åˆ°ç‹¬ç«‹æ–‡ä»¶
2. **ç»Ÿä¸€æ•°æ®æ ¼å¼**: ç¡®ä¿ä¸åŒå¹³å°è¿”å›ä¸€è‡´çš„æ•°æ®ç»“æ„
3. **æå‡å¯ç»´æŠ¤æ€§**: å‡å°‘ `platform.js` çš„ä»£ç é‡,æå‡å¯è¯»æ€§
4. **æ”¯æŒæ–°è¡¨ç»“æ„**: ä»æ—§çš„ `douyin_videos` è¡¨è¿ç§»åˆ°æ–°çš„ `works` è¡¨

### å®é™…æˆæœ

| ç›®æ ‡ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| æ¨¡å—åŒ–çˆ¬è™«é€»è¾‘ | âœ… å®Œæˆ | åˆ›å»ºäº† 3 ä¸ªç‹¬ç«‹æ¨¡å— |
| ç»Ÿä¸€æ•°æ®æ ¼å¼ | âœ… å®Œæˆ | å®šä¹‰äº†ç»Ÿä¸€æ¥å£è§„èŒƒ |
| æå‡å¯ç»´æŠ¤æ€§ | âœ… å®Œæˆ | `crawlComments` ä» 400 è¡Œå‡å°‘åˆ° 58 è¡Œ (-85.5%) |
| æ”¯æŒæ–°è¡¨ç»“æ„ | âš ï¸  éƒ¨åˆ†å®Œæˆ | ä»£ç å·²ä¿®å¤,ä½†æœªæµ‹è¯• |

---

## ğŸ“‚ æ–‡ä»¶ç»“æ„

### é‡æ„å‰

```
packages/worker/src/platforms/douyin/
â”œâ”€â”€ platform.js (3,691 è¡Œ)
â”‚   â””â”€â”€ åŒ…å«æ‰€æœ‰çˆ¬è™«é€»è¾‘
â””â”€â”€ crawl-direct-messages-v2.js
```

### é‡æ„å

```
packages/worker/src/platforms/douyin/
â”œâ”€â”€ platform.js (3,262 è¡Œ, -429 è¡Œ / -11.6%)
â”‚   â””â”€â”€ åè°ƒå±‚,è°ƒç”¨å„çˆ¬è™«æ¨¡å—
â”œâ”€â”€ crawl-comments.js (642 è¡Œ) âœ¨ æ–°å¢
â”‚   â””â”€â”€ è¯„è®º+è®¨è®ºçˆ¬å–
â”œâ”€â”€ crawl-works.js (æœªä½¿ç”¨)
â”‚   â””â”€â”€ ç‹¬ç«‹ä½œå“çˆ¬å–
â””â”€â”€ crawl-direct-messages-v2.js
    â””â”€â”€ ç§ä¿¡+ä¼šè¯çˆ¬å–
```

---

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. crawl-comments.js (642 è¡Œ)

**èŒè´£**: çˆ¬å–è¯„è®ºå’Œè®¨è®ºæ•°æ®

**æ ¸å¿ƒåŠŸèƒ½**:
```javascript
async function crawlComments(page, account, options) {
  // 1. è®¾ç½® API æ‹¦æˆªå™¨
  const commentApiPattern = /comment.*list/i;        // ä¸€çº§è¯„è®º
  const discussionApiPattern = /comment.*reply/i;    // äºŒçº§/ä¸‰çº§å›å¤

  // 2. å¯¼èˆªåˆ°è¯„è®ºç®¡ç†é¡µé¢
  await navigateToCommentManage(page);

  // 3. ç‚¹å‡»è§†é¢‘è§¦å‘ API
  for (const video of videoElements) {
    await video.click();
    await page.waitForTimeout(500);
  }

  // 4. è§£ææ•°æ®
  const comments = parseCommentsFromAPI(apiResponses.comments);
  const discussions = parseDiscussionsFromAPI(apiResponses.discussions);
  const works = extractWorksFromComments(videoElements);

  // 5. è¿”å›ç»Ÿä¸€æ ¼å¼
  return { comments, discussions, works, stats };
}
```

**è¿”å›æ•°æ®æ ¼å¼**:
```javascript
{
  comments: [
    {
      id, account_id, platform, platform_comment_id,
      platform_user_id, platform_user_name, content,
      create_time, detected_at, ...
    }
  ],
  discussions: [
    {
      id, account_id, platform, platform_discussion_id,
      parent_comment_id, reply_to_discussion_id,
      content, create_time, detected_at, ...
    }
  ],
  works: [
    {
      aweme_id, title, total_count, actual_count
    }
  ],
  stats: {
    recent_comments_count,
    recent_discussions_count,
    total_videos,
    processed_videos
  }
}
```

### 2. platform.js é‡æ„

**ä¿®æ”¹å‰** (crawlComments æ–¹æ³• - 400 è¡Œ):
```javascript
async crawlComments(account) {
  // API æ‹¦æˆªè®¾ç½® (50 è¡Œ)
  // å¯¼èˆªé€»è¾‘ (30 è¡Œ)
  // ç‚¹å‡»è§†é¢‘ (100 è¡Œ)
  // æ•°æ®è§£æ (120 è¡Œ)
  // åˆ†é¡µå¤„ç† (80 è¡Œ)
  // å‘é€åˆ° Master (20 è¡Œ)
}
```

**ä¿®æ”¹å** (crawlComments æ–¹æ³• - 58 è¡Œ):
```javascript
async crawlComments(account, options = {}) {
  // 1. è·å–é¡µé¢
  const page = await this.getOrCreatePage(account.id, 'spider2');

  // 2. è°ƒç”¨çˆ¬è™«æ¨¡å—
  const { comments, discussions, works, stats } =
    await crawlCommentsV2(page, account, options);

  // 3. å‘é€è¯„è®ºåˆ° Master
  await this.sendCommentsToMaster(account, comments, works);

  // 4. å‘é€è®¨è®ºåˆ° Master
  if (discussions?.length > 0) {
    await this.sendDiscussionsToMaster(account, discussions);
  }

  // 5. è¿”å›ç»“æœ
  return { comments, discussions, works, stats };
}
```

### 3. æ–°å¢æ–¹æ³•

#### sendWorksToMaster (æ–°å¢)

```javascript
async sendWorksToMaster(account, videos) {
  if (!videos || videos.length === 0) return;

  // å°†è§†é¢‘æ•°æ®è½¬æ¢ä¸º works è¡¨æ ¼å¼
  const works = videos.map(video => ({
    account_id: account.id,
    platform: 'douyin',
    platform_work_id: video.aweme_id || video.item_id,
    platform_user_id: account.platform_user_id,
    work_type: 'video',
    title: video.title,
    total_comment_count: video.total_count || 0,
    detected_at: Math.floor(Date.now() / 1000),
  }));

  // å‘é€åˆ° Master
  this.workerBridge.socket.emit('worker:bulk_insert_works', {
    account_id: account.id,
    works: works,
  });
}
```

#### sendDiscussionsToMaster (æ–°å¢)

```javascript
async sendDiscussionsToMaster(account, discussions) {
  if (!discussions || discussions.length === 0) return;

  this.workerBridge.socket.emit('worker:bulk_insert_discussions', {
    account_id: account.id,
    discussions: discussions,
  });
}
```

---

## âœ… æˆåŠŸçš„åŠŸèƒ½

### 1. è¯„è®ºçˆ¬å–

- **çŠ¶æ€**: âœ… å®Œå…¨æ­£å¸¸
- **æ•°æ®é‡**: 4 æ¡è¯„è®º
- **éªŒè¯**: æ•°æ®æ­£ç¡®ä¿å­˜åˆ° `comments` è¡¨
- **æ—¥å¿—**: `Worker bulk inserting 4 comments`

### 2. ç§ä¿¡çˆ¬å–

- **çŠ¶æ€**: âœ… å®Œå…¨æ­£å¸¸
- **æ•°æ®é‡**: 15 æ¡ç§ä¿¡
- **éªŒè¯**: æ•°æ®æ­£ç¡®ä¿å­˜åˆ° `direct_messages` è¡¨
- **æ—¥å¿—**: `Worker bulk inserting 15 messages`

### 3. ä¼šè¯çˆ¬å–

- **çŠ¶æ€**: âœ… å®Œå…¨æ­£å¸¸
- **æ•°æ®é‡**: 3 ä¸ªä¼šè¯
- **éªŒè¯**: æ•°æ®æ­£ç¡®ä¿å­˜åˆ° `conversations` è¡¨
- **è­¦å‘Š**: `No handler for message type: worker:bulk_insert_conversations` (æ•°æ®å·²æ­£ç¡®ä¿å­˜,ä»…æ—¥å¿—è­¦å‘Š)

### 4. å¹¶è¡Œçˆ¬å–

- **çŠ¶æ€**: âœ… å®Œå…¨æ­£å¸¸
- **ç‰¹æ€§**: spider1 (ç§ä¿¡) å’Œ spider2 (è¯„è®º) å¹¶è¡Œè¿è¡Œ
- **éªŒè¯**: ä¸¤ä¸ªçˆ¬è™«å‡ ä¹åŒæ—¶å®Œæˆ

---

## âŒ å­˜åœ¨çš„é—®é¢˜

### é—®é¢˜ 1: è®¨è®º (Discussions) æœªæŠ“å–

**ç°è±¡**:
- æ•°æ®åº“ä¸­ `discussions` è¡¨ä¸ºç©º (0 æ¡)
- ç”¨æˆ·æŠ¥å‘Šå®é™…åº”æœ‰ 1 æ¡è®¨è®º

**åˆ†æ**:
1. Master æ—¥å¿—ä¸­æ²¡æœ‰ `Worker bulk inserting X discussions` çš„è®°å½•
2. `crawlComments` æ–¹æ³•è°ƒç”¨äº† `sendDiscussionsToMaster`,ä½†è¯¥æ–¹æ³•æœªè¢«è§¦å‘
3. è¯´æ˜ `crawlCommentsV2` è¿”å›çš„ `discussions` æ•°ç»„ä¸ºç©º

**å¯èƒ½åŸå› **:
- â“ æŠ–éŸ³é¡µé¢æ²¡æœ‰äºŒçº§/ä¸‰çº§å›å¤
- â“ API æ‹¦æˆªå™¨æ²¡æœ‰æ•è·è®¨è®º API (`/comment.*reply/`)
- â“ æ•°æ®è§£æé€»è¾‘æœ‰è¯¯

**çŠ¶æ€**: âš ï¸  **å¾…è°ƒæŸ¥**

**ä¼˜å…ˆçº§**: é«˜

### é—®é¢˜ 2: ä½œå“ (Works) æœªæŠ“å–åˆ°æ–°è¡¨

**ç°è±¡**:
- æ•°æ®åº“ä¸­ `works` è¡¨ä¸ºç©º (0 æ¡)
- æ—§çš„ `douyin_videos` è¡¨æœ‰ 1 ä¸ªè§†é¢‘
- Master æ—¥å¿—æ˜¾ç¤º: `Returning 4 comment IDs, 1 video IDs, 15 message IDs`

**åˆ†æ**:
1. çˆ¬è™«å·²ç»æŠ“å–è¿‡è¿™ä¸ªè§†é¢‘ (ä¿å­˜åœ¨æ—§è¡¨ `douyin_videos`)
2. é‡æ„åçš„ä»£ç ä½¿ç”¨æ–°è¡¨ `works`,ä½†æ—§æ•°æ®ä¸åœ¨æ–°è¡¨ä¸­
3. çˆ¬è™«å› ä¸º"æ‰€æœ‰è¯„è®ºéƒ½æ˜¯æ—§æ•°æ®"è€Œè·³è¿‡å‘é€

**æ ¹æœ¬åŸå› **:
- æ•°æ®è¿ç§»é—®é¢˜: æ—§è¡¨æ•°æ®æœªè¿ç§»åˆ°æ–°è¡¨
- ç¼“å­˜è¿‡æ»¤: `filterNewComments` è¿‡æ»¤æ‰äº†æ‰€æœ‰è¯„è®º,å¯¼è‡´ `sendWorksToMaster` æœªè¢«è°ƒç”¨

**è§£å†³æ–¹æ¡ˆ**:
1. âœ… **å·²ä¿®å¤**: ä¿®æ”¹ `sendCommentsToMaster`,å³ä½¿æ²¡æœ‰æ–°è¯„è®ºä¹Ÿå‘é€ works
2. â³ **å¾…æµ‹è¯•**: éœ€è¦æ¸…ç©ºç¼“å­˜å¹¶é‡æ–°æŠ“å–ä»¥éªŒè¯ä¿®å¤

**çŠ¶æ€**: âš ï¸  **å·²ä¿®å¤ä½†æœªéªŒè¯**

**ä¼˜å…ˆçº§**: ä¸­

---

## ğŸ“Š æµ‹è¯•ç»“æœ

### æµ‹è¯•ç¯å¢ƒ

- **å¹³å°**: Windows
- **Node.js**: v18+
- **æ•°æ®åº“**: SQLite (packages/master/data/master.db)

### æµ‹è¯•æµç¨‹

1. âœ… æ¸…ç©ºæ•°æ®åº“æµ‹è¯•è¡¨
2. âœ… å¯åŠ¨ Master æœåŠ¡å™¨ (è‡ªåŠ¨å¯åŠ¨ Worker)
3. âœ… Worker æ³¨å†Œå¹¶è¿æ¥
4. âœ… çˆ¬è™«è‡ªåŠ¨æ‰§è¡Œ
5. âš ï¸  æ•°æ®éªŒè¯ (éƒ¨åˆ†æˆåŠŸ)

### æµ‹è¯•æ•°æ®ç»Ÿè®¡

| æ•°æ®ç±»å‹ | é¢„æœŸ | å®é™… | çŠ¶æ€ |
|----------|------|------|------|
| ä½œå“ (works) | 1 | 0 | âŒ |
| è¯„è®º (comments) | 4 | 4 | âœ… |
| è®¨è®º (discussions) | 1 | 0 | âŒ |
| ç§ä¿¡ (direct_messages) | 15 | 15 | âœ… |
| ä¼šè¯ (conversations) | 3 | 3 | âœ… |

---

## ğŸ” å¾…è§£å†³ä»»åŠ¡

### é«˜ä¼˜å…ˆçº§

1. **è°ƒè¯•è®¨è®ºæŠ“å–é—®é¢˜**
   - æ£€æŸ¥ API æ‹¦æˆªå™¨æ˜¯å¦æ•è·è®¨è®º API
   - éªŒè¯æ•°æ®è§£æé€»è¾‘
   - æ·»åŠ è¯¦ç»†æ—¥å¿—è¾“å‡º

2. **éªŒè¯ä½œå“æŠ“å–ä¿®å¤**
   - æ¸…ç©ºè¯„è®ºç¼“å­˜
   - é‡æ–°æŠ“å–æ•°æ®
   - éªŒè¯ works è¡¨æ˜¯å¦æœ‰æ•°æ®

### ä¸­ä¼˜å…ˆçº§

3. **æ•°æ®è¿ç§»**
   - å°† `douyin_videos` è¡¨æ•°æ®è¿ç§»åˆ° `works` è¡¨
   - æ›´æ–°æ‰€æœ‰å¼•ç”¨æ—§è¡¨çš„ä»£ç 

4. **æ¸…ç†æ—¥å¿—è­¦å‘Š**
   - ä¿®å¤ `worker:bulk_insert_conversations` è­¦å‘Š
   - ç»Ÿä¸€æ¶ˆæ¯å‘é€æ–¹å¼

### ä½ä¼˜å…ˆçº§

5. **æ€§èƒ½æµ‹è¯•**
   - æµ‹è¯•å¹¶è¡Œçˆ¬å–çš„æ€§èƒ½
   - ç›‘æ§å†…å­˜ä½¿ç”¨

6. **æ–‡æ¡£æ›´æ–°**
   - æ›´æ–° `03-WORKER-ç³»ç»Ÿæ–‡æ¡£.md`
   - æ›´æ–° `06-WORKER-çˆ¬è™«è°ƒè¯•æŒ‡å—.md`

---

## ğŸ“ æ€»ç»“

### æˆåŠŸä¹‹å¤„

1. âœ… **æ¨¡å—åŒ–æ¶æ„** æ¸…æ™°,ä»£ç æ˜“äºç»´æŠ¤
2. âœ… **è¯„è®ºå’Œç§ä¿¡çˆ¬å–** åŠŸèƒ½å®Œå…¨æ­£å¸¸
3. âœ… **å¹¶è¡Œçˆ¬å–** åŠŸèƒ½æ­£å¸¸å·¥ä½œ
4. âœ… **ä»£ç é‡å‡å°‘** 85.5% (platform.js crawlComments æ–¹æ³•)

### å¾…æ”¹è¿›ä¹‹å¤„

1. âŒ **è®¨è®ºæŠ“å–** åŠŸèƒ½æœªå®ç°
2. âš ï¸  **ä½œå“æŠ“å–** å·²ä¿®å¤ä½†æœªéªŒè¯
3. âš ï¸  **æ•°æ®è¿ç§»** éœ€è¦ä»æ—§è¡¨è¿ç§»åˆ°æ–°è¡¨

### å»ºè®®

1. **ç«‹å³ä»»åŠ¡**: è°ƒè¯•è®¨è®ºæŠ“å–é—®é¢˜
2. **é‡è¦ä»»åŠ¡**: éªŒè¯ä½œå“æŠ“å–ä¿®å¤
3. **åç»­ä»»åŠ¡**: æ•°æ®è¿ç§»å’Œæ–‡æ¡£æ›´æ–°

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-24 10:15:00
**æµ‹è¯•äººå‘˜**: Claude Code Assistant
**ç‰ˆæœ¬**: v1.1
