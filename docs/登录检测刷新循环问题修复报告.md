# 登录检测刷新循环问题修复报告

**时间**: 2025-10-24 16:12
**问题**: 登录状态检测导致二维码页面不断刷新，无法完成登录
**修复状态**: ✅ 代码已修复，等待重启 Worker 测试

---

## 一、问题现象

### 用户反馈

> "乱了,你现在检测登录状态的窗口，一直在刷新，他会反复发送二维码到我的web ，登录不了了，这个需要调整，还得改回来，如果是登录中的话，监控的是二维码那个页面，有没有跳转和头像等信息，不要新开页面了"

### 日志证据

从 Master 日志可以看到：

```
16:03:09 - qrcode_ready (二维码首次生成)
16:03:13 - qrcode_refreshed
16:03:15 - qrcode_refreshed
16:03:17 - qrcode_refreshed
... (每 2 秒刷新一次)
```

**问题根源**: `checkLoginStatus()` 方法每次调用都导航到 `https://creator.douyin.com/`，导致：
1. 登录页面被刷新
2. 二维码重新生成
3. 新二维码发送到 Admin Web UI
4. 用户无法完成扫码登录

---

## 二、代码问题分析

### 旧代码逻辑（有问题）

**文件**: `packages/worker/src/platforms/douyin/platform.js`
**位置**: 第 186-219 行（修改前）

```javascript
async checkLoginStatus(page) {
  try {
    logger.info('[checkLoginStatus] Checking login status by navigating to creator center...');

    // ❌ 问题：每次都导航，即使在登录页面
    const creatorHomeUrl = 'https://creator.douyin.com/';
    await page.goto(creatorHomeUrl, {
      waitUntil: 'domcontentloaded',
      timeout: 30000
    });

    // ... 检查用户信息容器 ...
  }
}
```

**调用链路**:
1. `platform-base.js` 第 173 行：登录监控循环每 2 秒调用一次 `checkLoginStatus()`
2. 抖音平台重写了 `checkLoginStatus()` 方法
3. 每次调用都执行 `page.goto()`，导致页面刷新

---

## 三、修复方案

### 核心思路

用户要求："如果是登录中的话，监控的是二维码那个页面，有没有跳转和头像等信息，不要新开页面了"

**解决方案**:
- ✅ **如果当前在登录页面**：不导航，直接检查当前页面
- ✅ **如果不在登录页面**：安全导航到创作中心检查状态

### 新代码逻辑

```javascript
async checkLoginStatus(page) {
  try {
    const currentUrl = page.url();
    logger.info(`[checkLoginStatus] Current URL: ${currentUrl}`);

    // ⭐ 关键优化：如果当前在登录页面（扫码中），直接检查当前页面，不要导航刷新
    const isOnLoginPage = currentUrl.includes('/passport/web/login') ||
                         currentUrl.includes('/login');

    if (isOnLoginPage) {
      // 🚫 如果在登录页面（显示二维码），不导航，直接检查当前页面
      logger.info(`[checkLoginStatus] ⚠️ On login page, checking current page WITHOUT navigation (avoid QR refresh)`);

      // 在登录页面检测登录状态：检查是否已跳转或出现用户信息
      // 登录成功后页面会自动跳转到创作中心，URL 会改变

    } else {
      // ✅ 不在登录页面，安全导航到创作中心检查状态
      const creatorHomeUrl = 'https://creator.douyin.com/';
      logger.info(`[checkLoginStatus] Not on login page, safe to navigate to ${creatorHomeUrl}...`);

      try {
        await page.goto(creatorHomeUrl, {
          waitUntil: 'domcontentloaded',
          timeout: 30000
        });
        logger.info(`[checkLoginStatus] Navigation completed, new URL: ${page.url()}`);
      } catch (navError) {
        logger.warn(`[checkLoginStatus] Navigation failed:`, navError.message);
        if (page.isClosed()) {
          return { isLoggedIn: false, status: 'error', error: 'Page closed' };
        }
      }
    }

    // 等待页面加载完成
    await page.waitForTimeout(2000);

    // ... 后续检查用户信息容器的逻辑不变 ...
  }
}
```

---

## 四、修复内容总结

### 修改文件

**1. `packages/worker/src/platforms/douyin/platform.js`** (第 186-220 行)

**修改内容**:
- 添加了 `currentUrl` 检查
- 添加了 `isOnLoginPage` 判断逻辑
- 只在不在登录页面时才执行 `page.goto()`
- 在登录页面时跳过导航，直接检查当前页面元素

### 预期效果

✅ **登录页面监控时**:
- 不会触发页面刷新
- 不会生成新的二维码
- 监控当前页面的用户信息容器出现（登录成功的标志）

✅ **非登录页面检查时**:
- 正常导航到创作中心
- 检查登录状态
- 不影响其他流程

---

## 五、测试步骤

### 前提条件
- ✅ 代码已修改完成
- ⚠️ 需要重启 Worker 进程应用新代码

### 测试流程

1. **停止当前 Worker 进程**
   ```bash
   # 如果 Master 自动启动了 Worker，杀掉进程
   taskkill /F /PID 15052

   # 或手动停止 Master（Master 会自动停止 Worker）
   Ctrl+C
   ```

2. **重启 Master 服务器**
   ```bash
   cd packages/master
   npm start
   ```

   Master 会自动启动 Worker（根据配置）

3. **点击登录按钮**
   - 在 Admin Web UI 中点击"登录"
   - 观察二维码是否显示

4. **观察日志输出**

   **预期日志（修复后）**:
   ```
   [checkLoginStatus] Current URL: https://www.douyin.com/passport/web/login
   [checkLoginStatus] ⚠️ On login page, checking current page WITHOUT navigation (avoid QR refresh)
   ```

   **不应该出现**:
   ```
   [checkLoginStatus] Navigating to https://creator.douyin.com/...  ❌
   ```

5. **验证二维码稳定性**
   - 二维码应该保持稳定，不会频繁刷新
   - 可以成功扫码登录

---

## 六、回归测试检查点

### 测试场景 1: 登录流程（主要场景）
- [ ] 点击登录按钮
- [ ] 二维码正常显示
- [ ] 二维码**不会**频繁刷新
- [ ] 扫码后能成功登录
- [ ] 登录成功后跳转到创作中心

### 测试场景 2: Worker 启动时的登录检查
- [ ] Worker 启动时检查账号登录状态
- [ ] 如果账号已登录，能正确识别
- [ ] 如果账号未登录，状态为 `not_logged_in`

### 测试场景 3: 监控任务执行前的登录检查
- [ ] 爬虫任务执行前会检查登录状态
- [ ] 如果未登录，不执行爬虫任务

---

## 七、相关修复历史

本次修复是本会话中**第 4 个登录相关问题**的修复：

### 历史问题修复

1. **问题 1**: 登录状态误报 `logged_in`（虚假阳性）
   - ✅ 已修复：删除了重复的 `checkLoginStatus()` 方法，使用新版本

2. **问题 2**: QR 码处理方法缺失
   - ✅ 已修复：修正了 `handleQRCodeLogin()` 和 `handleSMSLogin()` 的调用

3. **问题 3**: 浏览器上下文关闭错误
   - ✅ 已解决：等待 Worker 完全启动后再发送登录请求

4. **问题 4**: 登录检测刷新循环（当前问题）
   - ✅ 已修复：修改 `checkLoginStatus()` 避免在登录页面导航

---

## 八、下一步操作

### 立即需要做的
1. **用户需要停止当前进程**
2. **重启 Master 服务器**（Master 会自动启动 Worker）
3. **测试登录流程**
4. **确认二维码不再刷新**

### 如果测试失败
1. 查看 Worker 日志，确认新代码是否生效
2. 检查日志中是否有 "On login page, checking current page WITHOUT navigation" 消息
3. 如果仍有问题，提供完整的 Worker 日志供分析

---

## 九、技术要点总结

### 核心原理
- **登录页面 URL 特征**: `/passport/web/login` 或 `/login`
- **创作中心 URL**: `creator.douyin.com`
- **登录成功后**: 页面自动跳转，URL 改变，用户信息容器出现

### 关键设计
- **避免刷新**: 检测当前 URL，只在必要时导航
- **状态监控**: 在当前页面检测元素，而不是刷新页面
- **优雅降级**: 导航失败时，如果页面仍可用，继续检测

---

**状态**: ⏳ 等待用户重启进程测试
**预期结果**: 二维码稳定显示，不再频繁刷新，能成功完成登录
