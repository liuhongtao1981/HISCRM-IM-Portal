# ç™»å½•æ£€æµ‹åˆ·æ–°å¾ªç¯é—®é¢˜ä¿®å¤æŠ¥å‘Š

**æ—¶é—´**: 2025-10-24 16:12
**é—®é¢˜**: ç™»å½•çŠ¶æ€æ£€æµ‹å¯¼è‡´äºŒç»´ç é¡µé¢ä¸æ–­åˆ·æ–°ï¼Œæ— æ³•å®Œæˆç™»å½•
**ä¿®å¤çŠ¶æ€**: âœ… ä»£ç å·²ä¿®å¤ï¼Œç­‰å¾…é‡å¯ Worker æµ‹è¯•

---

## ä¸€ã€é—®é¢˜ç°è±¡

### ç”¨æˆ·åé¦ˆ

> "ä¹±äº†,ä½ ç°åœ¨æ£€æµ‹ç™»å½•çŠ¶æ€çš„çª—å£ï¼Œä¸€ç›´åœ¨åˆ·æ–°ï¼Œä»–ä¼šåå¤å‘é€äºŒç»´ç åˆ°æˆ‘çš„web ï¼Œç™»å½•ä¸äº†äº†ï¼Œè¿™ä¸ªéœ€è¦è°ƒæ•´ï¼Œè¿˜å¾—æ”¹å›æ¥ï¼Œå¦‚æœæ˜¯ç™»å½•ä¸­çš„è¯ï¼Œç›‘æ§çš„æ˜¯äºŒç»´ç é‚£ä¸ªé¡µé¢ï¼Œæœ‰æ²¡æœ‰è·³è½¬å’Œå¤´åƒç­‰ä¿¡æ¯ï¼Œä¸è¦æ–°å¼€é¡µé¢äº†"

### æ—¥å¿—è¯æ®

ä» Master æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼š

```
16:03:09 - qrcode_ready (äºŒç»´ç é¦–æ¬¡ç”Ÿæˆ)
16:03:13 - qrcode_refreshed
16:03:15 - qrcode_refreshed
16:03:17 - qrcode_refreshed
... (æ¯ 2 ç§’åˆ·æ–°ä¸€æ¬¡)
```

**é—®é¢˜æ ¹æº**: `checkLoginStatus()` æ–¹æ³•æ¯æ¬¡è°ƒç”¨éƒ½å¯¼èˆªåˆ° `https://creator.douyin.com/`ï¼Œå¯¼è‡´ï¼š
1. ç™»å½•é¡µé¢è¢«åˆ·æ–°
2. äºŒç»´ç é‡æ–°ç”Ÿæˆ
3. æ–°äºŒç»´ç å‘é€åˆ° Admin Web UI
4. ç”¨æˆ·æ— æ³•å®Œæˆæ‰«ç ç™»å½•

---

## äºŒã€ä»£ç é—®é¢˜åˆ†æ

### æ—§ä»£ç é€»è¾‘ï¼ˆæœ‰é—®é¢˜ï¼‰

**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/platform.js`
**ä½ç½®**: ç¬¬ 186-219 è¡Œï¼ˆä¿®æ”¹å‰ï¼‰

```javascript
async checkLoginStatus(page) {
  try {
    logger.info('[checkLoginStatus] Checking login status by navigating to creator center...');

    // âŒ é—®é¢˜ï¼šæ¯æ¬¡éƒ½å¯¼èˆªï¼Œå³ä½¿åœ¨ç™»å½•é¡µé¢
    const creatorHomeUrl = 'https://creator.douyin.com/';
    await page.goto(creatorHomeUrl, {
      waitUntil: 'domcontentloaded',
      timeout: 30000
    });

    // ... æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯å®¹å™¨ ...
  }
}
```

**è°ƒç”¨é“¾è·¯**:
1. `platform-base.js` ç¬¬ 173 è¡Œï¼šç™»å½•ç›‘æ§å¾ªç¯æ¯ 2 ç§’è°ƒç”¨ä¸€æ¬¡ `checkLoginStatus()`
2. æŠ–éŸ³å¹³å°é‡å†™äº† `checkLoginStatus()` æ–¹æ³•
3. æ¯æ¬¡è°ƒç”¨éƒ½æ‰§è¡Œ `page.goto()`ï¼Œå¯¼è‡´é¡µé¢åˆ·æ–°

---

## ä¸‰ã€ä¿®å¤æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯

ç”¨æˆ·è¦æ±‚ï¼š"å¦‚æœæ˜¯ç™»å½•ä¸­çš„è¯ï¼Œç›‘æ§çš„æ˜¯äºŒç»´ç é‚£ä¸ªé¡µé¢ï¼Œæœ‰æ²¡æœ‰è·³è½¬å’Œå¤´åƒç­‰ä¿¡æ¯ï¼Œä¸è¦æ–°å¼€é¡µé¢äº†"

**è§£å†³æ–¹æ¡ˆ**:
- âœ… **å¦‚æœå½“å‰åœ¨ç™»å½•é¡µé¢**ï¼šä¸å¯¼èˆªï¼Œç›´æ¥æ£€æŸ¥å½“å‰é¡µé¢
- âœ… **å¦‚æœä¸åœ¨ç™»å½•é¡µé¢**ï¼šå®‰å…¨å¯¼èˆªåˆ°åˆ›ä½œä¸­å¿ƒæ£€æŸ¥çŠ¶æ€

### æ–°ä»£ç é€»è¾‘

```javascript
async checkLoginStatus(page) {
  try {
    const currentUrl = page.url();
    logger.info(`[checkLoginStatus] Current URL: ${currentUrl}`);

    // â­ å…³é”®ä¼˜åŒ–ï¼šå¦‚æœå½“å‰åœ¨ç™»å½•é¡µé¢ï¼ˆæ‰«ç ä¸­ï¼‰ï¼Œç›´æ¥æ£€æŸ¥å½“å‰é¡µé¢ï¼Œä¸è¦å¯¼èˆªåˆ·æ–°
    const isOnLoginPage = currentUrl.includes('/passport/web/login') ||
                         currentUrl.includes('/login');

    if (isOnLoginPage) {
      // ğŸš« å¦‚æœåœ¨ç™»å½•é¡µé¢ï¼ˆæ˜¾ç¤ºäºŒç»´ç ï¼‰ï¼Œä¸å¯¼èˆªï¼Œç›´æ¥æ£€æŸ¥å½“å‰é¡µé¢
      logger.info(`[checkLoginStatus] âš ï¸ On login page, checking current page WITHOUT navigation (avoid QR refresh)`);

      // åœ¨ç™»å½•é¡µé¢æ£€æµ‹ç™»å½•çŠ¶æ€ï¼šæ£€æŸ¥æ˜¯å¦å·²è·³è½¬æˆ–å‡ºç°ç”¨æˆ·ä¿¡æ¯
      // ç™»å½•æˆåŠŸåé¡µé¢ä¼šè‡ªåŠ¨è·³è½¬åˆ°åˆ›ä½œä¸­å¿ƒï¼ŒURL ä¼šæ”¹å˜

    } else {
      // âœ… ä¸åœ¨ç™»å½•é¡µé¢ï¼Œå®‰å…¨å¯¼èˆªåˆ°åˆ›ä½œä¸­å¿ƒæ£€æŸ¥çŠ¶æ€
      const creatorHomeUrl = 'https://creator.douyin.com/';
      logger.info(`[checkLoginStatus] Not on login page, safe to navigate to ${creatorHomeUrl}...`);

      try {
        await page.goto(creatorHomeUrl, {
          waitUntil: 'domcontentloaded',
          timeout: 30000
        });
        logger.info(`[checkLoginStatus] Navigation completed, new URL: ${page.url()}`);
      } catch (navError) {
        logger.warn(`[checkLoginStatus] Navigation failed:`, navError.message);
        if (page.isClosed()) {
          return { isLoggedIn: false, status: 'error', error: 'Page closed' };
        }
      }
    }

    // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
    await page.waitForTimeout(2000);

    // ... åç»­æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯å®¹å™¨çš„é€»è¾‘ä¸å˜ ...
  }
}
```

---

## å››ã€ä¿®å¤å†…å®¹æ€»ç»“

### ä¿®æ”¹æ–‡ä»¶

**1. `packages/worker/src/platforms/douyin/platform.js`** (ç¬¬ 186-220 è¡Œ)

**ä¿®æ”¹å†…å®¹**:
- æ·»åŠ äº† `currentUrl` æ£€æŸ¥
- æ·»åŠ äº† `isOnLoginPage` åˆ¤æ–­é€»è¾‘
- åªåœ¨ä¸åœ¨ç™»å½•é¡µé¢æ—¶æ‰æ‰§è¡Œ `page.goto()`
- åœ¨ç™»å½•é¡µé¢æ—¶è·³è¿‡å¯¼èˆªï¼Œç›´æ¥æ£€æŸ¥å½“å‰é¡µé¢å…ƒç´ 

### é¢„æœŸæ•ˆæœ

âœ… **ç™»å½•é¡µé¢ç›‘æ§æ—¶**:
- ä¸ä¼šè§¦å‘é¡µé¢åˆ·æ–°
- ä¸ä¼šç”Ÿæˆæ–°çš„äºŒç»´ç 
- ç›‘æ§å½“å‰é¡µé¢çš„ç”¨æˆ·ä¿¡æ¯å®¹å™¨å‡ºç°ï¼ˆç™»å½•æˆåŠŸçš„æ ‡å¿—ï¼‰

âœ… **éç™»å½•é¡µé¢æ£€æŸ¥æ—¶**:
- æ­£å¸¸å¯¼èˆªåˆ°åˆ›ä½œä¸­å¿ƒ
- æ£€æŸ¥ç™»å½•çŠ¶æ€
- ä¸å½±å“å…¶ä»–æµç¨‹

---

## äº”ã€æµ‹è¯•æ­¥éª¤

### å‰ææ¡ä»¶
- âœ… ä»£ç å·²ä¿®æ”¹å®Œæˆ
- âš ï¸ éœ€è¦é‡å¯ Worker è¿›ç¨‹åº”ç”¨æ–°ä»£ç 

### æµ‹è¯•æµç¨‹

1. **åœæ­¢å½“å‰ Worker è¿›ç¨‹**
   ```bash
   # å¦‚æœ Master è‡ªåŠ¨å¯åŠ¨äº† Workerï¼Œæ€æ‰è¿›ç¨‹
   taskkill /F /PID 15052

   # æˆ–æ‰‹åŠ¨åœæ­¢ Masterï¼ˆMaster ä¼šè‡ªåŠ¨åœæ­¢ Workerï¼‰
   Ctrl+C
   ```

2. **é‡å¯ Master æœåŠ¡å™¨**
   ```bash
   cd packages/master
   npm start
   ```

   Master ä¼šè‡ªåŠ¨å¯åŠ¨ Workerï¼ˆæ ¹æ®é…ç½®ï¼‰

3. **ç‚¹å‡»ç™»å½•æŒ‰é’®**
   - åœ¨ Admin Web UI ä¸­ç‚¹å‡»"ç™»å½•"
   - è§‚å¯ŸäºŒç»´ç æ˜¯å¦æ˜¾ç¤º

4. **è§‚å¯Ÿæ—¥å¿—è¾“å‡º**

   **é¢„æœŸæ—¥å¿—ï¼ˆä¿®å¤åï¼‰**:
   ```
   [checkLoginStatus] Current URL: https://www.douyin.com/passport/web/login
   [checkLoginStatus] âš ï¸ On login page, checking current page WITHOUT navigation (avoid QR refresh)
   ```

   **ä¸åº”è¯¥å‡ºç°**:
   ```
   [checkLoginStatus] Navigating to https://creator.douyin.com/...  âŒ
   ```

5. **éªŒè¯äºŒç»´ç ç¨³å®šæ€§**
   - äºŒç»´ç åº”è¯¥ä¿æŒç¨³å®šï¼Œä¸ä¼šé¢‘ç¹åˆ·æ–°
   - å¯ä»¥æˆåŠŸæ‰«ç ç™»å½•

---

## å…­ã€å›å½’æµ‹è¯•æ£€æŸ¥ç‚¹

### æµ‹è¯•åœºæ™¯ 1: ç™»å½•æµç¨‹ï¼ˆä¸»è¦åœºæ™¯ï¼‰
- [ ] ç‚¹å‡»ç™»å½•æŒ‰é’®
- [ ] äºŒç»´ç æ­£å¸¸æ˜¾ç¤º
- [ ] äºŒç»´ç **ä¸ä¼š**é¢‘ç¹åˆ·æ–°
- [ ] æ‰«ç åèƒ½æˆåŠŸç™»å½•
- [ ] ç™»å½•æˆåŠŸåè·³è½¬åˆ°åˆ›ä½œä¸­å¿ƒ

### æµ‹è¯•åœºæ™¯ 2: Worker å¯åŠ¨æ—¶çš„ç™»å½•æ£€æŸ¥
- [ ] Worker å¯åŠ¨æ—¶æ£€æŸ¥è´¦å·ç™»å½•çŠ¶æ€
- [ ] å¦‚æœè´¦å·å·²ç™»å½•ï¼Œèƒ½æ­£ç¡®è¯†åˆ«
- [ ] å¦‚æœè´¦å·æœªç™»å½•ï¼ŒçŠ¶æ€ä¸º `not_logged_in`

### æµ‹è¯•åœºæ™¯ 3: ç›‘æ§ä»»åŠ¡æ‰§è¡Œå‰çš„ç™»å½•æ£€æŸ¥
- [ ] çˆ¬è™«ä»»åŠ¡æ‰§è¡Œå‰ä¼šæ£€æŸ¥ç™»å½•çŠ¶æ€
- [ ] å¦‚æœæœªç™»å½•ï¼Œä¸æ‰§è¡Œçˆ¬è™«ä»»åŠ¡

---

## ä¸ƒã€ç›¸å…³ä¿®å¤å†å²

æœ¬æ¬¡ä¿®å¤æ˜¯æœ¬ä¼šè¯ä¸­**ç¬¬ 4 ä¸ªç™»å½•ç›¸å…³é—®é¢˜**çš„ä¿®å¤ï¼š

### å†å²é—®é¢˜ä¿®å¤

1. **é—®é¢˜ 1**: ç™»å½•çŠ¶æ€è¯¯æŠ¥ `logged_in`ï¼ˆè™šå‡é˜³æ€§ï¼‰
   - âœ… å·²ä¿®å¤ï¼šåˆ é™¤äº†é‡å¤çš„ `checkLoginStatus()` æ–¹æ³•ï¼Œä½¿ç”¨æ–°ç‰ˆæœ¬

2. **é—®é¢˜ 2**: QR ç å¤„ç†æ–¹æ³•ç¼ºå¤±
   - âœ… å·²ä¿®å¤ï¼šä¿®æ­£äº† `handleQRCodeLogin()` å’Œ `handleSMSLogin()` çš„è°ƒç”¨

3. **é—®é¢˜ 3**: æµè§ˆå™¨ä¸Šä¸‹æ–‡å…³é—­é”™è¯¯
   - âœ… å·²è§£å†³ï¼šç­‰å¾… Worker å®Œå…¨å¯åŠ¨åå†å‘é€ç™»å½•è¯·æ±‚

4. **é—®é¢˜ 4**: ç™»å½•æ£€æµ‹åˆ·æ–°å¾ªç¯ï¼ˆå½“å‰é—®é¢˜ï¼‰
   - âœ… å·²ä¿®å¤ï¼šä¿®æ”¹ `checkLoginStatus()` é¿å…åœ¨ç™»å½•é¡µé¢å¯¼èˆª

---

## å…«ã€ä¸‹ä¸€æ­¥æ“ä½œ

### ç«‹å³éœ€è¦åšçš„
1. **ç”¨æˆ·éœ€è¦åœæ­¢å½“å‰è¿›ç¨‹**
2. **é‡å¯ Master æœåŠ¡å™¨**ï¼ˆMaster ä¼šè‡ªåŠ¨å¯åŠ¨ Workerï¼‰
3. **æµ‹è¯•ç™»å½•æµç¨‹**
4. **ç¡®è®¤äºŒç»´ç ä¸å†åˆ·æ–°**

### å¦‚æœæµ‹è¯•å¤±è´¥
1. æŸ¥çœ‹ Worker æ—¥å¿—ï¼Œç¡®è®¤æ–°ä»£ç æ˜¯å¦ç”Ÿæ•ˆ
2. æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰ "On login page, checking current page WITHOUT navigation" æ¶ˆæ¯
3. å¦‚æœä»æœ‰é—®é¢˜ï¼Œæä¾›å®Œæ•´çš„ Worker æ—¥å¿—ä¾›åˆ†æ

---

## ä¹ã€æŠ€æœ¯è¦ç‚¹æ€»ç»“

### æ ¸å¿ƒåŸç†
- **ç™»å½•é¡µé¢ URL ç‰¹å¾**: `/passport/web/login` æˆ– `/login`
- **åˆ›ä½œä¸­å¿ƒ URL**: `creator.douyin.com`
- **ç™»å½•æˆåŠŸå**: é¡µé¢è‡ªåŠ¨è·³è½¬ï¼ŒURL æ”¹å˜ï¼Œç”¨æˆ·ä¿¡æ¯å®¹å™¨å‡ºç°

### å…³é”®è®¾è®¡
- **é¿å…åˆ·æ–°**: æ£€æµ‹å½“å‰ URLï¼Œåªåœ¨å¿…è¦æ—¶å¯¼èˆª
- **çŠ¶æ€ç›‘æ§**: åœ¨å½“å‰é¡µé¢æ£€æµ‹å…ƒç´ ï¼Œè€Œä¸æ˜¯åˆ·æ–°é¡µé¢
- **ä¼˜é›…é™çº§**: å¯¼èˆªå¤±è´¥æ—¶ï¼Œå¦‚æœé¡µé¢ä»å¯ç”¨ï¼Œç»§ç»­æ£€æµ‹

---

**çŠ¶æ€**: â³ ç­‰å¾…ç”¨æˆ·é‡å¯è¿›ç¨‹æµ‹è¯•
**é¢„æœŸç»“æœ**: äºŒç»´ç ç¨³å®šæ˜¾ç¤ºï¼Œä¸å†é¢‘ç¹åˆ·æ–°ï¼Œèƒ½æˆåŠŸå®Œæˆç™»å½•
