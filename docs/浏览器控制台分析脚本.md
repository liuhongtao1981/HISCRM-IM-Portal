# æµè§ˆå™¨æ§åˆ¶å°ç§ä¿¡IDæå–åˆ†ææŠ¥å‘Š

**åˆ†ææ—¶é—´**: 2025-11-04
**é¡µé¢URL**: https://creator.douyin.com/creator-micro/data/following/chat
**åˆ†ææ–¹æ³•**: MCP Playwrightæµè§ˆå™¨ + React Fiberæ·±åº¦åˆ†æ
**ä¼šè¯**: è918

---

## ğŸ¯ å…³é”®å‘ç°

### âœ… **æˆåŠŸæå–åˆ°åŠ å¯†ID (`secSender`å­—æ®µ)ï¼**

åœ¨åˆ›ä½œè€…ä¸­å¿ƒçš„ç§ä¿¡é¡µé¢ä¸­ï¼Œæ¯æ¡æ¶ˆæ¯éƒ½åŒ…å«ï¼š
- `conversationId`: å¤åˆIDæ ¼å¼ `0:1:2270953921061816:4031246151199119`
- `sender`: çº¯æ•°å­—ID `2270953921061816` æˆ– `4031246151199119`
- â­ **`secSender`**: Base64åŠ å¯†ID `MS4wLjABAAAA...` âœ…

---

## ğŸ“Š æå–çš„æ•°æ®ç¤ºä¾‹

### æ¶ˆæ¯ #1
```json
{
  "message_id": "7568671057889380395",
  "conversation_id": "0:1:2270953921061816:4031246151199119",
  "sender": "2270953921061816",
  "secSender": "MS4wLjABAAAA96ua757Uwv0ST9oZV8PdQp4i92BEfRGMCfQGJD0B7VZ-kI9DT5IZ4gkzOBXu98xA",
  "content": {
    "tips": "ä½ ä»¬å·²äº’ç›¸å…³æ³¨å¯¹æ–¹",
    "aweType": 0
  },
  "conversationShortId": "7568670955065606698",
  "conversationBizType": 1
}
```

### æ¶ˆæ¯ #2
```json
{
  "message_id": "7568671055716386835",
  "conversation_id": "0:1:2270953921061816:4031246151199119",
  "sender": "4031246151199119",
  "secSender": "MS4wLjABAAAAcFGiBQe30yh1CY5GCOxXoZlw_3Toii_-MNBaC4CEFvceIXWh8paOxDgAD54mc1qO",
  "content": {
    "tips": "ä½ ä»¬å·²äº’ç›¸å…³æ³¨å¯¹æ–¹",
    "aweType": 0
  },
  "conversationShortId": "7568670955065606698"
}
```

### æ¶ˆæ¯ #3 (æ–‡æœ¬æ¶ˆæ¯)
```json
{
  "message_id": "7568671043473754678",
  "conversation_id": "0:1:2270953921061816:4031246151199119",
  "sender": "4031246151199119",
  "secSender": "MS4wLjABAAAAcFGiBQe30yh1CY5GCOxXoZlw_3Toii_-MNBaC4CEFvceIXWh8paOxDgAD54mc1qO",
  "content": {
    "aweType": 701,
    "text": "æˆ‘ä»¬å·²äº’ç›¸å…³æ³¨ï¼Œå¯ä»¥å¼€å§‹èŠå¤©äº†"
  }
}
```

---

## ğŸ” æ•°æ®ç»“æ„åˆ†æ

### IDæ ¼å¼å¯¹æ¯”

| å­—æ®µå | æ ¼å¼ | ç¤ºä¾‹ | è¯´æ˜ |
|--------|------|------|------|
| `conversationId` | å¤åˆID (å†’å·åˆ†éš”) | `0:1:2270953921061816:4031246151199119` | åˆ›ä½œè€…ä¸­å¿ƒä½¿ç”¨çš„ä¼šè¯ID |
| `sender` | çº¯æ•°å­—ID | `2270953921061816` | å‘é€è€…çš„æ•°å­—ID |
| â­ **`secSender`** | **Base64åŠ å¯†ID** | **`MS4wLjABAAAA96ua757Uwv0ST9oZV8PdQp4i92BEfRGMCfQGJD0B7VZ-kI9DT5IZ4gkzOBXu98xA`** | **åŠ å¯†çš„user_id** âœ… |
| `conversationShortId` | çº¯æ•°å­—ID | `7568670955065606698` | ä¼šè¯çš„çŸ­ID |

### conversationId ç»“æ„è§£æ

**æ ¼å¼**: `0:1:2270953921061816:4031246151199119`

**çŒœæµ‹ç»“æ„**:
- ç¬¬1æ®µ: `0` - å¯èƒ½æ˜¯ä¼šè¯ç±»å‹æˆ–å¹³å°æ ‡è¯†
- ç¬¬2æ®µ: `1` - å¯èƒ½æ˜¯ä¸šåŠ¡ç±»å‹ (å¯¹åº” `conversationBizType: 1`)
- ç¬¬3æ®µ: `2270953921061816` - ç”¨æˆ·Açš„æ•°å­—ID (å®é™è‡´è¿œ)
- ç¬¬4æ®µ: `4031246151199119` - ç”¨æˆ·Bçš„æ•°å­—ID (è918)

---

## ğŸ’¡ å…³é”®å‘ç°

### 1. **åˆ›ä½œè€…ä¸­å¿ƒé¡µé¢ç¡®å®æœ‰åŠ å¯†IDï¼**

è™½ç„¶ `conversationId` ä½¿ç”¨å¤åˆæ ¼å¼ï¼Œä½†æ¯æ¡æ¶ˆæ¯éƒ½åŒ…å« **`secSender`** å­—æ®µï¼Œå­˜å‚¨äº†Base64åŠ å¯†çš„user_idã€‚

### 2. **ä¸¤ä¸ªç”¨æˆ·çš„åŠ å¯†ID**

ä»æå–çš„6æ¡æ¶ˆæ¯ä¸­è¯†åˆ«å‡ºä¸¤ä¸ªä¸åŒçš„ `secSender`:

| ç”¨æˆ·æ˜µç§° | æ•°å­—ID (sender) | åŠ å¯†ID (secSender) |
|---------|----------------|-------------------|
| å®é™è‡´è¿œ | `2270953921061816` | `MS4wLjABAAAA96ua757Uwv0ST9oZV8PdQp4i92BEfRGMCfQGJD0B7VZ-kI9DT5IZ4gkzOBXu98xA` |
| è918 | `4031246151199119` | `MS4wLjABAAAAcFGiBQe30yh1CY5GCOxXoZlw_3Toii_-MNBaC4CEFvceIXWh8paOxDgAD54mc1qO` |

### 3. **conversationId vs æ•°æ®åº“å­˜å‚¨**

**åˆ›ä½œè€…ä¸­å¿ƒé¡µé¢**:
- `conversationId`: `0:1:2270953921061816:4031246151199119` (å¤åˆæ ¼å¼)
- `sender`: `2270953921061816` æˆ– `4031246151199119` (çº¯æ•°å­—)
- `secSender`: `MS4wLjABAAAA...` (Base64åŠ å¯†ID) âœ…

**æ•°æ®åº“å­˜å‚¨** (æ¥è‡ªä¹‹å‰çš„éªŒè¯):
- `conversation_id`: æ··åˆæ ¼å¼
  - 46.5%: `MS4wLjABAAAA...` (Base64åŠ å¯†ID)
  - 53.5%: çº¯æ•°å­—ID (å¦‚ `71206683390`)

---

## ğŸ¤” ä¸æ•°æ®åº“æ•°æ®çš„å¯¹æ¯”

### Workerçˆ¬å–çš„é¡µé¢ vs åˆ›ä½œè€…ä¸­å¿ƒ

| æ•°æ®æ¥æº | conversationIdæ ¼å¼ | æ˜¯å¦æœ‰åŠ å¯†ID |
|---------|-------------------|-------------|
| **Workerçˆ¬å–é¡µé¢** (`/falcon/webcast_openpc/pages/im/`) | æ··åˆï¼š46.5%åŠ å¯†ID + 53.5%çº¯æ•°å­— | âš ï¸ éƒ¨åˆ†æœ‰ |
| **åˆ›ä½œè€…ä¸­å¿ƒ** (`/creator-micro/data/following/chat`) | å¤åˆID (`0:1:...`) | âœ… æœ‰ (åœ¨`secSender`å­—æ®µ) |

### é—®é¢˜æ ¹æº

1. **Workerçˆ¬å–çš„åŸå§‹ç§ä¿¡é¡µé¢** ä½¿ç”¨ä¸åŒçš„æ•°æ®ç»“æ„
2. **åˆ›ä½œè€…ä¸­å¿ƒ** è™½ç„¶ `conversationId` æ˜¯å¤åˆæ ¼å¼ï¼Œä½†ä¿ç•™äº† `secSender` åŠ å¯†ID
3. **æ•°æ®åº“ä¸­çš„53.5%çº¯æ•°å­—IDæ¶ˆæ¯** å¯èƒ½æ˜¯å› ä¸ºï¼š
   - Workerçˆ¬å–æ—¶æœªæå– `secSender` å­—æ®µ
   - æˆ–è€…åŸå§‹ç§ä¿¡é¡µé¢ç¡®å®æ²¡æœ‰è¿™ä¸ªå­—æ®µ

---

## ğŸ¯ è§£å†³æ–¹æ¡ˆå»ºè®®

### æ–¹æ¡ˆA: å¢å¼ºWorkerçˆ¬è™« - æå– `secSender` å­—æ®µ

ä¿®æ”¹ `packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js`:

```javascript
// å½“å‰æå–é€»è¾‘
const messageData = {
  message_id: props.serverId,
  conversation_id: props.conversationId,
  sender_id: props.sender,
  // ...
};

// ğŸ‘‡ å¢å¼ºåçš„æå–é€»è¾‘
const messageData = {
  message_id: props.serverId,
  conversation_id: props.conversationId,
  sender_id: props.sender,
  sec_sender: props.secSender,  // â­ æ–°å¢ï¼šæå–åŠ å¯†ID
  // ...

  // å¦‚æœconversationIdæ˜¯å¤åˆæ ¼å¼ï¼Œè§£æå‡ºæ•°å­—ID
  parsed_conversation_id: parseConversationId(props.conversationId)
};

function parseConversationId(convId) {
  if (typeof convId === 'string' && convId.includes(':')) {
    // æ ¼å¼: "0:1:2270953921061816:4031246151199119"
    const parts = convId.split(':');
    return {
      type: parts[0],
      bizType: parts[1],
      user1: parts[2],
      user2: parts[3],
      original: convId
    };
  }
  return convId;
}
```

### æ–¹æ¡ˆB: å»ºç«‹IDæ˜ å°„

ä½¿ç”¨ `secSender` å»ºç«‹æ•°å­—IDåˆ°åŠ å¯†IDçš„æ˜ å°„ï¼š

```javascript
// åœ¨CacheDAOä¸­å­˜å‚¨æ˜ å°„
const idMapping = {
  '2270953921061816': 'MS4wLjABAAAA96ua757Uwv0ST9oZV8PdQp4i92BEfRGMCfQGJD0B7VZ-kI9DT5IZ4gkzOBXu98xA',
  '4031246151199119': 'MS4wLjABAAAAcFGiBQe30yh1CY5GCOxXoZlw_3Toii_-MNBaC4CEFvceIXWh8paOxDgAD54mc1qO'
};
```

### æ–¹æ¡ˆC: ä¿®æ”¹IMå®¢æˆ·ç«¯æŸ¥è¯¢é€»è¾‘

æ”¯æŒé€šè¿‡ `secSender` å­—æ®µè¿›è¡Œä¼šè¯åŒ¹é…ï¼š

```javascript
// packages/crm-im-server/src/websocket-server.js
const msgs = messagesList.filter(m => {
  return m.conversationId === topicId ||
         m.rawData?.secSender === topicId ||  // â­ æ–°å¢
         m.senderId === topicId;
});
```

---

## ğŸ“Œ æ€»ç»“

### å›ç­”åŸå§‹é—®é¢˜ï¼š**"åŠ å¯†çš„id æ˜¯ä¸æ˜¯æ¯æ¡æ•°æ®éƒ½æœ‰"**

**åˆ›ä½œè€…ä¸­å¿ƒé¡µé¢**: âœ… **æ˜¯çš„**ï¼Œæ¯æ¡æ¶ˆæ¯éƒ½æœ‰ `secSender` å­—æ®µï¼ˆBase64åŠ å¯†IDï¼‰

**Workerçˆ¬å–çš„æ•°æ®åº“**: âš ï¸ **éƒ¨åˆ†æœ‰**
- ä¼šè¯: 100% æœ‰åŠ å¯†user_id
- æ¶ˆæ¯: 46.5% æœ‰åŠ å¯†conversation_idï¼Œ53.5% æ˜¯çº¯æ•°å­—

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… **éªŒè¯Workerå®é™…çˆ¬å–çš„é¡µé¢** æ˜¯å¦ä¹Ÿæœ‰ `secSender` å­—æ®µ
2. ğŸ”§ **ä¿®æ”¹Workerçˆ¬è™«** æå– `secSender` å­—æ®µ
3. ğŸ”„ **é‡æ–°çˆ¬å–æ•°æ®** è¡¥å……ç¼ºå¤±çš„åŠ å¯†ID
4. ğŸ¯ **æ›´æ–°IMå®¢æˆ·ç«¯** æ”¯æŒ `secSender` å­—æ®µåŒ¹é…

---

## é™„å½•ï¼šå®Œæ•´æ¶ˆæ¯æ•°æ®

### å…¨éƒ¨6æ¡æ¶ˆæ¯çš„å®Œæ•´æ•°æ®

```json
[
  {
    "message_id": "7568671057889380395",
    "conversation_id": "0:1:2270953921061816:4031246151199119",
    "sender": "2270953921061816",
    "secSender": "MS4wLjABAAAA96ua757Uwv0ST9oZV8PdQp4i92BEfRGMCfQGJD0B7VZ-kI9DT5IZ4gkzOBXu98xA",
    "conversationShortId": "7568670955065606698",
    "content": { "tips": "ä½ ä»¬å·²äº’ç›¸å…³æ³¨å¯¹æ–¹", "aweType": 0 }
  },
  {
    "message_id": "7568671055716386835",
    "conversation_id": "0:1:2270953921061816:4031246151199119",
    "sender": "4031246151199119",
    "secSender": "MS4wLjABAAAAcFGiBQe30yh1CY5GCOxXoZlw_3Toii_-MNBaC4CEFvceIXWh8paOxDgAD54mc1qO",
    "conversationShortId": "7568670955065606698",
    "content": { "tips": "ä½ ä»¬å·²äº’ç›¸å…³æ³¨å¯¹æ–¹", "aweType": 0 }
  },
  {
    "message_id": "7568671043473754678",
    "conversation_id": "0:1:2270953921061816:4031246151199119",
    "sender": "4031246151199119",
    "secSender": "MS4wLjABAAAAcFGiBQe30yh1CY5GCOxXoZlw_3Toii_-MNBaC4CEFvceIXWh8paOxDgAD54mc1qO",
    "content": { "aweType": 701, "text": "æˆ‘ä»¬å·²äº’ç›¸å…³æ³¨ï¼Œå¯ä»¥å¼€å§‹èŠå¤©äº†" }
  },
  {
    "message_id": "7568671060925843987",
    "conversation_id": "0:1:2270953921061816:4031246151199119",
    "sender": "2270953921061816",
    "secSender": "MS4wLjABAAAA96ua757Uwv0ST9oZV8PdQp4i92BEfRGMCfQGJD0B7VZ-kI9DT5IZ4gkzOBXu98xA",
    "content": { "aweType": 701, "text": "æˆ‘ä»¬å·²äº’ç›¸å…³æ³¨ï¼Œå¯ä»¥å¼€å§‹èŠå¤©äº†" }
  },
  {
    "message_id": "7568671064537073727",
    "conversation_id": "0:1:2270953921061816:4031246151199119",
    "sender": "2270953921061816",
    "secSender": "MS4wLjABAAAA96ua757Uwv0ST9oZV8PdQp4i92BEfRGMCfQGJD0B7VZ-kI9DT5IZ4gkzOBXu98xA",
    "content": {
      "nickname": "å®é™è‡´è¿œ",
      "hint_text": "æˆ‘ä»¬å·²äº’ç›¸å…³æ³¨ï¼Œå¯ä»¥å¼€å§‹èŠå¤©äº†",
      "pos": 1,
      "hello_text": "æ‰“ä¸ªæ‹›å‘¼å§"
    }
  },
  {
    "message_id": "7568671049757493267",
    "conversation_id": "0:1:2270953921061816:4031246151199119",
    "sender": "4031246151199119",
    "secSender": "MS4wLjABAAAAcFGiBQe30yh1CY5GCOxXoZlw_3Toii_-MNBaC4CEFvceIXWh8paOxDgAD54mc1qO",
    "content": {
      "hello_text": "æ‰“ä¸ªæ‹›å‘¼å§",
      "nickname": "è918",
      "hint_text": "æˆ‘ä»¬å·²äº’ç›¸å…³æ³¨ï¼Œå¯ä»¥å¼€å§‹èŠå¤©äº†",
      "pos": 1
    }
  }
]
```

---

**ç»“è®º**: åˆ›ä½œè€…ä¸­å¿ƒçš„ç§ä¿¡é¡µé¢ç¡®å®åŒ…å«åŠ å¯†ID (`secSender`)ï¼Œä½†æ ¼å¼ä¸æ•°æ®åº“å­˜å‚¨ä¸åŒã€‚éœ€è¦éªŒè¯Workerå®é™…çˆ¬å–çš„åŸå§‹ç§ä¿¡é¡µé¢æ˜¯å¦ä¹Ÿæœ‰è¿™ä¸ªå­—æ®µã€‚
