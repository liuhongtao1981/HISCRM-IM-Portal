# æ–°æ¶ˆæ¯å®æ—¶æ¨é€æ¶æ„è®¾è®¡

## ä¸€ã€éœ€æ±‚æ¦‚è¿°

### 1.1 æ ¸å¿ƒéœ€æ±‚

1. **Worker å±‚**ï¼šé™¤äº†å®šæœŸæ¨é€ï¼ˆ30ç§’ï¼‰ï¼Œæœ‰æ–°æ¶ˆæ¯æ—¶éœ€è¦ä¸»åŠ¨æ¨é€ä¸€æ¬¡
2. **Master å±‚**ï¼šæ”¶åˆ°æ–°æ¶ˆæ¯åï¼Œæ¨é€ç®€æ˜“æ¦‚è¦ç»™ IM å®¢æˆ·ç«¯ï¼ˆä¸æ¨é€å®Œæ•´æ•°æ®ï¼‰
3. **IM å®¢æˆ·ç«¯**ï¼šæ”¶åˆ°æ–°æ¶ˆæ¯æç¤ºåï¼Œä¸»åŠ¨åˆ·æ–° UI
   - æ›´æ–°çº¢ç‚¹æœªè¯»æ•°é‡æ ‡è®°
   - å¦‚æœåœ¨ä¼šè¯å†…ï¼Œåˆ·æ–°ç‰¹å®šçš„ä¼šè¯æˆ–ä½œå“ä¿¡æ¯
   - é‡æ–°åŠ è½½å¯¹è¯å†å²å’Œç§ä¿¡å†å²

### 1.2 è®¾è®¡ç›®æ ‡

- **å®æ—¶æ€§**ï¼šæ–°æ¶ˆæ¯åˆ°è¾¾å 1-3 ç§’å†…å®¢æˆ·ç«¯ UI åˆ·æ–°
- **è½»é‡çº§**ï¼šç®€æ˜“æ¨é€åªåŒ…å«æ¦‚è¦ä¿¡æ¯ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“
- **æ™ºèƒ½åˆ·æ–°**ï¼šå®¢æˆ·ç«¯æ ¹æ®å½“å‰é¡µé¢çŠ¶æ€æ™ºèƒ½åˆ·æ–°å¯¹åº”æ•°æ®
- **å‘åå…¼å®¹**ï¼šä¿ç•™ç°æœ‰çš„å®šæœŸæ¨é€æœºåˆ¶ä½œä¸ºå…œåº•

---

## äºŒã€å½“å‰æ¶æ„åˆ†æ

### 2.1 å½“å‰æ•°æ®æµ

```
Worker (30ç§’å®šæœŸ)
    â†“
AccountDataManager.syncToMaster()
    â†“
DataPusher.pushDataSync(WORKER_DATA_SYNC)
    â†“
Master: DataSyncReceiver.handleWorkerDataSync()
    â†“
æ›´æ–°å†…å­˜ DataStore
    â†“
æ£€æµ‹æ–°æ¶ˆæ¯ detectNewMessages()
    â†“
ã€æœ‰æ–°æ¶ˆæ¯ã€‘â†’ broadcastToMonitors('monitor:topics', {...å®Œæ•´ topics})
    â†“
IM å®¢æˆ·ç«¯ç›‘å¬ 'monitor:topics'
    â†“
dispatch(setTopics(...)) â†’ UI åˆ·æ–°
```

### 2.2 å½“å‰é—®é¢˜

1. **å»¶è¿Ÿè¾ƒé«˜**ï¼šWorker 30ç§’å®šæœŸæ¨é€ï¼Œæ–°æ¶ˆæ¯æœ€å¤šå»¶è¿Ÿ30ç§’
2. **æ¨é€æ•°æ®é‡å¤§**ï¼šæ¯æ¬¡æ¨é€å®Œæ•´çš„ topics åˆ—è¡¨ï¼ˆåŒ…å«æ‰€æœ‰ä½œå“å’Œè¯„è®ºï¼‰
3. **æ— å·®å¼‚åŒ–æ¨é€**ï¼šæ— è®ºæ–°æ¶ˆæ¯ç±»å‹ï¼Œéƒ½æ¨é€ç›¸åŒæ•°æ®ç»“æ„

---

## ä¸‰ã€æ–°æ¶æ„è®¾è®¡

### 3.1 æ•´ä½“æ•°æ®æµï¼ˆä¼˜åŒ–ç‰ˆ - çº¯æŒ‰éœ€æ‹‰å–ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Worker å±‚                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  çˆ¬è™«æ£€æµ‹åˆ°æ–°æ¶ˆæ¯                                              â”‚
â”‚      â†“                                                        â”‚
â”‚  AccountDataManager.addMessage/addComment                   â”‚
â”‚      â†“                                                        â”‚
â”‚  ã€æ£€æµ‹ã€‘æ˜¯å¦ä¸ºæ–°æ¶ˆæ¯ï¼ˆdirection='inbound'ï¼‰                    â”‚
â”‚      â†“                                                        â”‚
â”‚  ã€æ˜¯ã€‘â†’ ç«‹å³æ¨é€æ•°æ®å¿«ç…§ï¼ˆä¸ç­‰30ç§’å®šæœŸï¼‰                        â”‚
â”‚      â†“                                                        â”‚
â”‚  DataPusher.pushDataSync(WORKER_DATA_SYNC)                  â”‚
â”‚      â†“                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Master å±‚                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  DataSyncReceiver.handleWorkerDataSync()                    â”‚
â”‚      â†“                                                        â”‚
â”‚  æ›´æ–°å†…å­˜ DataStore                                           â”‚
â”‚      â†“                                                        â”‚
â”‚  detectNewMessages() â†’ æ£€æµ‹åˆ°æ–°æ¶ˆæ¯                           â”‚
â”‚      â†“                                                        â”‚
â”‚  ã€åªæ¨é€ç®€æ˜“æ¦‚è¦ã€‘âœ¨ä¼˜åŒ–ï¼šä¸æ¨é€å®Œæ•´æ•°æ®                       â”‚
â”‚      â””â”€ ç®€æ˜“æ¨é€: monitor:new_message_hintï¼ˆæ¦‚è¦ä¿¡æ¯ï¼‰        â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       IM å®¢æˆ·ç«¯å±‚                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  ç›‘å¬ 'monitor:new_message_hint' âœ¨æ–°å¢                       â”‚
â”‚      â†“                                                        â”‚
â”‚  ã€é˜²æŠ–å¤„ç†ã€‘1ç§’å†…å¤šæ¡æç¤ºåˆå¹¶å¤„ç† âœ¨æ–°å¢                       â”‚
â”‚      â†“                                                        â”‚
â”‚  ã€åˆ†ææ¦‚è¦ä¿¡æ¯ã€‘                                              â”‚
â”‚      â”œâ”€ ç«‹å³æ›´æ–°çº¢ç‚¹æœªè¯»æ•°ï¼ˆæ— éœ€è¯·æ±‚æœåŠ¡å™¨ï¼‰                    â”‚
â”‚      â”œâ”€ æ˜¾ç¤ºæµè§ˆå™¨é€šçŸ¥ï¼ˆå¯é€‰ï¼‰                                 â”‚
â”‚      â”œâ”€ åˆ¤æ–­æ˜¯å¦åœ¨ç›¸å…³ä¼šè¯/ä½œå“é¡µé¢                            â”‚
â”‚      â””â”€ ã€æŒ‰éœ€æ‹‰å–ã€‘ä¸»åŠ¨è¯·æ±‚è¯¦ç»†æ•°æ®åˆ·æ–° UI                     â”‚
â”‚          â”œâ”€ monitor:request_topicsï¼ˆåˆ·æ–°ä½œå“åˆ—è¡¨ï¼‰            â”‚
â”‚          â”œâ”€ monitor:request_messagesï¼ˆåˆ·æ–°æ¶ˆæ¯åˆ—è¡¨ï¼‰          â”‚
â”‚          â””â”€ monitor:request_channelsï¼ˆåˆ·æ–°é¢‘é“åˆ—è¡¨ï¼‰          â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼ˆä¼˜åŒ–ç‰ˆï¼‰

1. **çº¯æŒ‰éœ€æ‹‰å–ç­–ç•¥** âœ¨ä¼˜åŒ–ï¼š
   - **æœåŠ¡ç«¯**ï¼šåªæ¨é€ç®€æ˜“æ¦‚è¦ï¼ˆ`monitor:new_message_hint`ï¼‰ï¼Œä¸æ¨é€å®Œæ•´æ•°æ®
   - **å®¢æˆ·ç«¯**ï¼šæ”¶åˆ°æç¤ºåä¸»åŠ¨æ‹‰å–éœ€è¦çš„æ•°æ®
   - **ä¼˜åŠ¿**ï¼šå‡è½»æœåŠ¡ç«¯å‹åŠ›ï¼Œå°¤å…¶æ˜¯å®¢æˆ·ç«¯æ•°é‡å¤šæ—¶

2. **å®¢æˆ·ç«¯é˜²æŠ–æœºåˆ¶** âœ¨æ–°å¢ï¼š
   - 1ç§’å†…æ”¶åˆ°å¤šæ¡æ–°æ¶ˆæ¯æç¤ºæ—¶ï¼Œé˜²æŠ–åˆå¹¶å¤„ç†
   - ç«‹å³æ›´æ–°çº¢ç‚¹ï¼ˆä¸é˜²æŠ–ï¼‰ï¼Œè¯¦ç»†åˆ·æ–°å»¶è¿Ÿæ‰§è¡Œï¼ˆé˜²æŠ–ï¼‰
   - é¿å…çŸ­æ—¶é—´å†…é¢‘ç¹è¯·æ±‚æœåŠ¡å™¨

3. **æ™ºèƒ½åˆ·æ–°ç­–ç•¥**ï¼š
   - å®¢æˆ·ç«¯æ ¹æ®å½“å‰é¡µé¢çŠ¶æ€å†³å®šæ˜¯å¦æ‹‰å–è¯¦æƒ…
   - åœ¨ç›¸å…³é¡µé¢ â†’ ä¸»åŠ¨æ‹‰å–å¹¶åˆ·æ–°
   - ä¸åœ¨ç›¸å…³é¡µé¢ â†’ åªæ›´æ–°çº¢ç‚¹ï¼Œä¸æ‹‰å–è¯¦æƒ…

4. **æ¸è¿›å¼å‡çº§**ï¼š
   - å®šæœŸæ¨é€ä¿ç•™ä¸ºå…œåº•æœºåˆ¶ï¼ˆ30ç§’ï¼‰
   - æ–°æ¶ˆæ¯ç«‹å³æ¨é€ä½œä¸ºä¸»è¦æœºåˆ¶ï¼ˆ1-3ç§’ï¼‰
   - ä¸¤ç§æœºåˆ¶å…±å­˜ï¼Œç¡®ä¿æ•°æ®æœ€ç»ˆä¸€è‡´æ€§

---

## å››ã€ç®€æ˜“æ¨é€æ•°æ®ç»“æ„è®¾è®¡

### 4.1 äº‹ä»¶åç§°

```
monitor:new_message_hint
```

### 4.2 æ•°æ®ç»“æ„

```typescript
interface NewMessageHint {
  channelId: string;          // è´¦æˆ· ID
  platform: string;           // å¹³å°ï¼ˆdouyin, xiaohongshuï¼‰
  messageType: 'comment' | 'private_message';  // æ¶ˆæ¯ç±»å‹

  // è¯„è®ºç›¸å…³ï¼ˆmessageType='comment' æ—¶ï¼‰
  topicId?: string;           // ä½œå“ ID
  topicTitle?: string;        // ä½œå“æ ‡é¢˜
  commentCount?: number;      // è¯¥ä½œå“æ–°å¢è¯„è®ºæ•°

  // ç§ä¿¡ç›¸å…³ï¼ˆmessageType='private_message' æ—¶ï¼‰
  conversationId?: string;    // ä¼šè¯ ID
  fromUserId?: string;        // å‘é€è€… ID
  fromUserName?: string;      // å‘é€è€…åç§°
  messageCount?: number;      // è¯¥ä¼šè¯æ–°å¢æ¶ˆæ¯æ•°

  // æ±‡æ€»ä¿¡æ¯
  totalUnreadCount: number;   // è¯¥è´¦æˆ·æ€»æœªè¯»æ•°
  timestamp: number;          // æ—¶é—´æˆ³
}
```

### 4.3 æ•°æ®æ ·ä¾‹

**è¯„è®ºæ¶ˆæ¯ï¼š**
```json
{
  "channelId": "douyin_account_123",
  "platform": "douyin",
  "messageType": "comment",
  "topicId": "7123456789",
  "topicTitle": "æˆ‘çš„æœ€æ–°ä½œå“",
  "commentCount": 3,
  "totalUnreadCount": 15,
  "timestamp": 1699876543210
}
```

**ç§ä¿¡æ¶ˆæ¯ï¼š**
```json
{
  "channelId": "douyin_account_123",
  "platform": "douyin",
  "messageType": "private_message",
  "conversationId": "conv_user_456",
  "fromUserId": "456",
  "fromUserName": "ç²‰ä¸å°æ˜",
  "messageCount": 2,
  "totalUnreadCount": 15,
  "timestamp": 1699876543210
}
```

---

## äº”ã€å„å±‚å®ç°æ–¹æ¡ˆ

### 5.1 Worker å±‚æ”¹åŠ¨

#### æ–‡ä»¶ï¼š`packages/worker/src/platforms/base/account-data-manager.js`

**æ”¹åŠ¨ 1ï¼šæ–°æ¶ˆæ¯æ£€æµ‹æ ‡å¿—**

```javascript
class AccountDataManager {
  constructor(accountId, platform, dataPusher) {
    // ... ç°æœ‰ä»£ç  ...

    // âœ¨ æ–°å¢ï¼šæ–°æ¶ˆæ¯æ£€æµ‹æ ‡å¿—
    this.hasNewMessages = false;
    this.newMessageDetails = {
      comments: [],    // æ–°è¯„è®ºåˆ—è¡¨
      messages: [],    // æ–°ç§ä¿¡åˆ—è¡¨
    };
  }
```

**æ”¹åŠ¨ 2ï¼šæ·»åŠ æ¶ˆæ¯æ—¶æ ‡è®°æ–°æ¶ˆæ¯**

```javascript
upsertMessage(messageData, source = DataSource.API) {
  const message = new Message();
  // ... æ˜ å°„æ•°æ® ...

  this.messages.set(id, message);

  // âœ¨ æ–°å¢ï¼šæ£€æµ‹æ˜¯å¦ä¸ºæ–°æ¶ˆæ¯ï¼ˆinbound ä¸”æœªè¯»ï¼‰
  if (message.direction === 'inbound' && !message.isRead) {
    this.hasNewMessages = true;
    this.newMessageDetails.messages.push(message);

    // ç«‹å³æ¨é€
    this.logger.info(`ğŸ”” æ£€æµ‹åˆ°æ–°ç§ä¿¡ï¼Œè§¦å‘ç«‹å³æ¨é€: ${message.messageId}`);
    this.syncToMasterNow();
  }

  return message;
}

upsertComment(commentData, source = DataSource.API) {
  const comment = new Comment();
  // ... æ˜ å°„æ•°æ® ...

  this.comments.set(id, comment);

  // âœ¨ æ–°å¢ï¼šæ£€æµ‹æ˜¯å¦ä¸ºæ–°è¯„è®ºï¼ˆinbound ä¸”æœªè¯»ï¼‰
  if (comment.direction === 'inbound' && !comment.isRead) {
    this.hasNewMessages = true;
    this.newMessageDetails.comments.push(comment);

    // ç«‹å³æ¨é€
    this.logger.info(`ğŸ”” æ£€æµ‹åˆ°æ–°è¯„è®ºï¼Œè§¦å‘ç«‹å³æ¨é€: ${comment.commentId}`);
    this.syncToMasterNow();
  }

  return comment;
}
```

**æ”¹åŠ¨ 3ï¼šæ–°å¢ç«‹å³æ¨é€æ–¹æ³•**

```javascript
/**
 * ç«‹å³æ¨é€æ•°æ®åˆ° Masterï¼ˆæ–°æ¶ˆæ¯æ—¶è°ƒç”¨ï¼‰
 * ç›¸æ¯”å®šæœŸæ¨é€ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šç«‹å³æ‰§è¡Œï¼Œä¸ç­‰å¾…å®šæ—¶å™¨
 */
async syncToMasterNow() {
  // é˜²æŠ–ï¼šå¦‚æœæ­£åœ¨æ¨é€ï¼Œåˆ™è·³è¿‡
  if (this._isSyncing) {
    this.logger.debug('Already syncing, skip immediate push');
    return;
  }

  this._isSyncing = true;

  try {
    await this.syncToMaster();

    // æ¸…é™¤æ–°æ¶ˆæ¯æ ‡å¿—
    this.hasNewMessages = false;
    this.newMessageDetails = {
      comments: [],
      messages: [],
    };
  } finally {
    this._isSyncing = false;
  }
}
```

---

### 5.2 Master å±‚æ”¹åŠ¨

#### æ–‡ä»¶ï¼š`packages/master/src/communication/data-sync-receiver.js`

**æ”¹åŠ¨ï¼šåªæ¨é€ç®€æ˜“æ¦‚è¦ï¼ˆç§»é™¤å®Œæ•´æ¨é€ï¼‰** âœ¨ä¼˜åŒ–

```javascript
// âœ… æ£€æµ‹æ˜¯å¦æœ‰æ–°æ¶ˆæ¯ï¼Œåªæœ‰æ£€æµ‹åˆ°æ–°æ¶ˆæ¯æ—¶æ‰æ¨é€æ›´æ–°
if (this.imWebSocketServer) {
  const newMessagesInfo = this.detectNewMessages(oldData, snapshot);

  if (newMessagesInfo.hasNew) {
    // âœ¨ åªæ¨é€ç®€æ˜“æ¦‚è¦ï¼Œå®¢æˆ·ç«¯æŒ‰éœ€æ‹‰å–è¯¦ç»†æ•°æ®
    const hints = this.buildNewMessageHints(accountId, snapshot.platform, newMessagesInfo);
    for (const hint of hints) {
      this.imWebSocketServer.broadcastToMonitors('monitor:new_message_hint', hint);
    }

    logger.info(`ğŸ“¤ Broadcasted ${hints.length} new message hints for ${accountId}`);
  }
}
```

**ä¼˜åŒ–è¯´æ˜**ï¼š
- âŒ ç§»é™¤äº† `monitor:topics` å®Œæ•´æ•°æ®æ¨é€
- âœ… åªæ¨é€ç®€æ˜“æ¦‚è¦ `monitor:new_message_hint`
- ğŸ’¡ å®¢æˆ·ç«¯æ”¶åˆ°æç¤ºåä¸»åŠ¨è°ƒç”¨ `monitor:request_topics` / `monitor:request_messages` æ‹‰å–æ•°æ®
- ğŸ¯ å‡è½»æœåŠ¡ç«¯å‹åŠ›ï¼Œå°¤å…¶æ˜¯å®¢æˆ·ç«¯æ•°é‡å¤šæ—¶

**æ”¹åŠ¨ï¼šä¿®æ”¹ detectNewMessages è¿”å›è¯¦ç»†ä¿¡æ¯**

```javascript
/**
 * æ£€æµ‹æ˜¯å¦æœ‰æ–°æ¶ˆæ¯ï¼ˆæ–°è¯„è®ºæˆ–æ–°ç§ä¿¡ï¼‰
 * @param {object} oldData - æ›´æ–°å‰çš„æ•°æ®
 * @param {object} newSnapshot - æ›´æ–°åçš„æ•°æ®å¿«ç…§
 * @returns {object} { hasNew: boolean, comments: [], messages: [] }
 */
detectNewMessages(oldData, newSnapshot) {
  try {
    const result = {
      hasNew: false,
      comments: [],   // æ–°å¢çš„è¯„è®ºåˆ—è¡¨
      messages: [],   // æ–°å¢çš„ç§ä¿¡åˆ—è¡¨
    };

    // æ£€æµ‹æ–°è¯„è®º
    if (newSnapshot.data?.comments) {
      const oldComments = oldData?.data?.comments || [];
      const oldCommentIds = new Set(
        (Array.isArray(oldComments) ? oldComments : Array.from(oldComments.values())).map(c => c.commentId)
      );

      const newCommentsList = Array.isArray(newSnapshot.data.comments)
        ? newSnapshot.data.comments
        : Array.from(newSnapshot.data.comments.values());

      // æ”¶é›†æ–°å¢çš„è¯„è®ºï¼ˆæ’é™¤å®¢æœå‘é€çš„ï¼‰
      for (const comment of newCommentsList) {
        if (!oldCommentIds.has(comment.commentId) && comment.direction !== 'outbound') {
          result.comments.push(comment);
          result.hasNew = true;
          logger.debug(`ğŸ”” æ£€æµ‹åˆ°æ–°è¯„è®º: ${comment.commentId}`);
        }
      }
    }

    // æ£€æµ‹æ–°ç§ä¿¡
    if (newSnapshot.data?.messages) {
      const oldMessages = oldData?.data?.messages || [];
      const oldMessageIds = new Set(
        (Array.isArray(oldMessages) ? oldMessages : Array.from(oldMessages.values())).map(m => m.messageId)
      );

      const newMessagesList = Array.isArray(newSnapshot.data.messages)
        ? newSnapshot.data.messages
        : Array.from(newSnapshot.data.messages.values());

      // æ”¶é›†æ–°å¢çš„ç§ä¿¡ï¼ˆæ’é™¤å®¢æœå‘é€çš„ï¼‰
      for (const message of newMessagesList) {
        if (!oldMessageIds.has(message.messageId) && message.direction !== 'outbound') {
          result.messages.push(message);
          result.hasNew = true;
          logger.debug(`ğŸ”” æ£€æµ‹åˆ°æ–°ç§ä¿¡: ${message.messageId}`);
        }
      }
    }

    return result;

  } catch (error) {
    logger.error('æ£€æµ‹æ–°æ¶ˆæ¯æ—¶å‡ºé”™:', error);
    return { hasNew: false, comments: [], messages: [] };
  }
}
```

**æ”¹åŠ¨ï¼šæ–°å¢æ„å»ºç®€æ˜“æ¦‚è¦æ–¹æ³•**

```javascript
/**
 * æ„å»ºæ–°æ¶ˆæ¯ç®€æ˜“æ¦‚è¦
 * @param {string} accountId - è´¦æˆ· ID
 * @param {string} platform - å¹³å°
 * @param {object} newMessagesInfo - æ–°æ¶ˆæ¯ä¿¡æ¯ { comments: [], messages: [] }
 * @returns {Array<NewMessageHint>} ç®€æ˜“æ¦‚è¦åˆ—è¡¨
 */
buildNewMessageHints(accountId, platform, newMessagesInfo) {
  const hints = [];

  // è®¡ç®—æ€»æœªè¯»æ•°
  const accountData = this.dataStore.getAccountData(accountId);
  const totalUnreadCount = this.calculateUnreadCount(accountData);

  // 1. æŒ‰ä½œå“åˆ†ç»„è¯„è®º
  const commentsByTopic = new Map();
  for (const comment of newMessagesInfo.comments) {
    const topicId = comment.contentId;
    if (!commentsByTopic.has(topicId)) {
      commentsByTopic.set(topicId, []);
    }
    commentsByTopic.get(topicId).push(comment);
  }

  // ä¸ºæ¯ä¸ªä½œå“åˆ›å»ºä¸€ä¸ª hint
  for (const [topicId, comments] of commentsByTopic) {
    const firstComment = comments[0];
    hints.push({
      channelId: accountId,
      platform,
      messageType: 'comment',
      topicId,
      topicTitle: firstComment.contentTitle || 'æœªçŸ¥ä½œå“',
      commentCount: comments.length,
      totalUnreadCount,
      timestamp: Date.now(),
    });
  }

  // 2. æŒ‰ä¼šè¯åˆ†ç»„ç§ä¿¡
  const messagesByConversation = new Map();
  for (const message of newMessagesInfo.messages) {
    const conversationId = message.conversationId;
    if (!messagesByConversation.has(conversationId)) {
      messagesByConversation.set(conversationId, []);
    }
    messagesByConversation.get(conversationId).push(message);
  }

  // ä¸ºæ¯ä¸ªä¼šè¯åˆ›å»ºä¸€ä¸ª hint
  for (const [conversationId, messages] of messagesByConversation) {
    const firstMessage = messages[0];
    hints.push({
      channelId: accountId,
      platform,
      messageType: 'private_message',
      conversationId,
      fromUserId: firstMessage.senderId,
      fromUserName: firstMessage.senderName || 'æœªçŸ¥ç”¨æˆ·',
      messageCount: messages.length,
      totalUnreadCount,
      timestamp: Date.now(),
    });
  }

  return hints;
}

/**
 * è®¡ç®—è´¦æˆ·æ€»æœªè¯»æ•°
 */
calculateUnreadCount(accountData) {
  if (!accountData || !accountData.data) return 0;

  let count = 0;

  // è¯„è®ºæœªè¯»æ•°
  if (accountData.data.comments) {
    const comments = Array.isArray(accountData.data.comments)
      ? accountData.data.comments
      : Array.from(accountData.data.comments.values());
    count += comments.filter(c => !c.isRead && c.direction !== 'outbound').length;
  }

  // ç§ä¿¡æœªè¯»æ•°
  if (accountData.data.messages) {
    const messages = Array.isArray(accountData.data.messages)
      ? accountData.data.messages
      : Array.from(accountData.data.messages.values());
    count += messages.filter(m => !m.isRead && m.direction !== 'outbound').length;
  }

  return count;
}
```

---

### 5.3 IM å®¢æˆ·ç«¯å±‚æ”¹åŠ¨

#### æ–‡ä»¶ï¼š`packages/crm-pc-im/src/pages/MonitorPage.tsx`

**æ”¹åŠ¨ 1ï¼šæ·»åŠ æ–°æ¶ˆæ¯æç¤ºç›‘å¬**

```typescript
useEffect(() => {
  if (!websocketService.getIsConnected()) return

  // ... ç°æœ‰çš„äº‹ä»¶ç›‘å¬ ...

  // âœ¨ æ–°å¢ï¼šç›‘å¬æ–°æ¶ˆæ¯ç®€æ˜“æç¤º
  websocketService.on('monitor:new_message_hint', handleNewMessageHint)

  return () => {
    // ... ç°æœ‰çš„æ¸…ç† ...
    websocketService.off('monitor:new_message_hint')
  }
}, [dispatch, selectedChannel, selectedTopic])
```

**æ”¹åŠ¨ 2ï¼šå¤„ç†æ–°æ¶ˆæ¯æç¤ºï¼ˆå¸¦é˜²æŠ–ï¼‰** âœ¨ä¼˜åŒ–

```typescript
/**
 * é˜²æŠ–å®šæ—¶å™¨ï¼šç”¨äºåˆå¹¶çŸ­æ—¶é—´å†…çš„å¤šæ¡æ¶ˆæ¯æç¤º
 * key: `${channelId}_${messageType}_${topicId|conversationId}`
 * value: setTimeout å®šæ—¶å™¨
 */
const refreshTimers = useRef<Map<string, NodeJS.Timeout>>(new Map())

/**
 * å¤„ç†æ–°æ¶ˆæ¯ç®€æ˜“æç¤ºï¼ˆå¸¦é˜²æŠ–æœºåˆ¶ï¼‰
 */
const handleNewMessageHint = useCallback((hint: NewMessageHint) => {
  console.log('ğŸ”” æ”¶åˆ°æ–°æ¶ˆæ¯æç¤º:', hint)

  // 1ï¸âƒ£ ç«‹å³æ›´æ–°çº¢ç‚¹æœªè¯»æ•°ï¼ˆä¸é˜²æŠ–ï¼Œå®æ—¶æ˜¾ç¤ºï¼‰
  dispatch(updateChannelUnreadCount({
    channelId: hint.channelId,
    unreadCount: hint.totalUnreadCount,
  }))

  // 2ï¸âƒ£ æ˜¾ç¤ºæµè§ˆå™¨é€šçŸ¥ï¼ˆä¸é˜²æŠ–ï¼Œå®æ—¶æé†’ï¼‰
  if (Notification.permission === 'granted') {
    const title = hint.messageType === 'comment' ? 'æ–°è¯„è®º' : 'æ–°ç§ä¿¡'
    const body = hint.messageType === 'comment'
      ? `${hint.topicTitle} æ”¶åˆ° ${hint.commentCount} æ¡æ–°è¯„è®º`
      : `${hint.fromUserName} å‘æ¥ ${hint.messageCount} æ¡æ–°æ¶ˆæ¯`

    new Notification(title, { body })
  }

  // 3ï¸âƒ£ é˜²æŠ–åˆ·æ–°è¯¦ç»†æ•°æ®ï¼ˆ1ç§’å†…å¤šæ¬¡æç¤ºåˆå¹¶å¤„ç†ï¼‰
  const refreshKey = hint.messageType === 'comment'
    ? `${hint.channelId}_comment_${hint.topicId}`
    : `${hint.channelId}_message_${hint.conversationId}`

  // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
  if (refreshTimers.current.has(refreshKey)) {
    clearTimeout(refreshTimers.current.get(refreshKey)!)
    console.log('â° æ¸…é™¤æ—§çš„åˆ·æ–°å®šæ—¶å™¨:', refreshKey)
  }

  // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼ˆ1ç§’åæ‰§è¡Œï¼‰
  const timer = setTimeout(() => {
    console.log('ğŸ“¥ æ‰§è¡Œé˜²æŠ–åˆ·æ–°:', refreshKey)

    if (hint.messageType === 'comment') {
      handleCommentHint(hint)
    } else if (hint.messageType === 'private_message') {
      handlePrivateMessageHint(hint)
    }

    // æ¸…ç†å®šæ—¶å™¨
    refreshTimers.current.delete(refreshKey)
  }, 1000) // 1ç§’é˜²æŠ–

  refreshTimers.current.set(refreshKey, timer)
  console.log('â° è®¾ç½®æ–°çš„åˆ·æ–°å®šæ—¶å™¨:', refreshKey)
}, [dispatch, selectedChannel, selectedTopic])

// ç»„ä»¶å¸è½½æ—¶æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
useEffect(() => {
  return () => {
    refreshTimers.current.forEach(timer => clearTimeout(timer))
    refreshTimers.current.clear()
  }
}, [])

/**
 * å¤„ç†è¯„è®ºæç¤º
 */
const handleCommentHint = useCallback((hint: NewMessageHint) => {
  // å¦‚æœå½“å‰åœ¨è¯¥è´¦æˆ·çš„é¡µé¢
  if (selectedChannel === hint.channelId) {
    console.log('ğŸ“¥ å½“å‰åœ¨è¯¥è´¦æˆ·é¡µé¢ï¼Œåˆ·æ–° topics')

    // ä¸»åŠ¨è¯·æ±‚ topics åˆ·æ–°
    websocketService.emit('monitor:request_topics', {
      channelId: hint.channelId,
    })

    // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹è¯¥ä½œå“çš„è¯„è®º
    if (selectedTopic === hint.topicId) {
      console.log('ğŸ“¥ å½“å‰åœ¨è¯¥ä½œå“é¡µé¢ï¼Œåˆ·æ–° messages')

      // ä¸»åŠ¨è¯·æ±‚ messages åˆ·æ–°
      websocketService.emit('monitor:request_messages', {
        channelId: hint.channelId,
        topicId: hint.topicId,
        messageType: 'comment',
      })
    }
  } else {
    console.log('ğŸ“Œ ä¸åœ¨è¯¥è´¦æˆ·é¡µé¢ï¼Œåªæ›´æ–°çº¢ç‚¹')
  }
}, [selectedChannel, selectedTopic])

/**
 * å¤„ç†ç§ä¿¡æç¤º
 */
const handlePrivateMessageHint = useCallback((hint: NewMessageHint) => {
  // å¦‚æœå½“å‰åœ¨è¯¥è´¦æˆ·çš„é¡µé¢
  if (selectedChannel === hint.channelId) {
    console.log('ğŸ“¥ å½“å‰åœ¨è¯¥è´¦æˆ·é¡µé¢ï¼Œåˆ·æ–° topics')

    // ä¸»åŠ¨è¯·æ±‚ topics åˆ·æ–°
    websocketService.emit('monitor:request_topics', {
      channelId: hint.channelId,
    })

    // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹è¯¥ä¼šè¯çš„ç§ä¿¡
    if (selectedTopic === hint.conversationId) {
      console.log('ğŸ“¥ å½“å‰åœ¨è¯¥ä¼šè¯é¡µé¢ï¼Œåˆ·æ–° messages')

      // ä¸»åŠ¨è¯·æ±‚ messages åˆ·æ–°
      websocketService.emit('monitor:request_messages', {
        channelId: hint.channelId,
        topicId: hint.conversationId,
        messageType: 'direct_message',
      })
    }
  } else {
    console.log('ğŸ“Œ ä¸åœ¨è¯¥è´¦æˆ·é¡µé¢ï¼Œåªæ›´æ–°çº¢ç‚¹')
  }
}, [selectedChannel, selectedTopic])
```

#### æ–‡ä»¶ï¼š`packages/crm-pc-im/src/store/monitorSlice.ts`

**æ”¹åŠ¨ï¼šæ–°å¢æ›´æ–°çº¢ç‚¹çš„ action**

```typescript
// æ–°å¢ï¼šæ›´æ–°é¢‘é“æœªè¯»æ•°
updateChannelUnreadCount: (state, action: PayloadAction<{
  channelId: string
  unreadCount: number
}>) => {
  const { channelId, unreadCount } = action.payload

  const channel = state.channels.find(ch => ch.id === channelId)
  if (channel) {
    channel.unreadCount = unreadCount
  }
}
```

---

## å…­ã€å®ç°æ­¥éª¤

### é˜¶æ®µ 1ï¼šWorker å±‚æ”¹åŠ¨ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

**æ­¥éª¤ 1.1**ï¼šä¿®æ”¹ `account-data-manager.js`
- [ ] æ·»åŠ  `hasNewMessages` æ ‡å¿—
- [ ] æ·»åŠ  `newMessageDetails` å­˜å‚¨
- [ ] åœ¨ `upsertMessage()` ä¸­æ·»åŠ æ–°æ¶ˆæ¯æ£€æµ‹
- [ ] åœ¨ `upsertComment()` ä¸­æ·»åŠ æ–°æ¶ˆæ¯æ£€æµ‹
- [ ] å®ç° `syncToMasterNow()` æ–¹æ³•

**é¢„è®¡å·¥ä½œé‡**ï¼š2-3 å°æ—¶

---

### é˜¶æ®µ 2ï¼šMaster å±‚æ”¹åŠ¨ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

**æ­¥éª¤ 2.1**ï¼šä¿®æ”¹ `data-sync-receiver.js`
- [ ] ä¿®æ”¹ `detectNewMessages()` è¿”å›è¯¦ç»†ä¿¡æ¯
- [ ] å®ç° `buildNewMessageHints()` æ–¹æ³•
- [ ] å®ç° `calculateUnreadCount()` æ–¹æ³•
- [ ] åœ¨ `handleWorkerDataSync()` ä¸­æ¨é€ `monitor:new_message_hint`

**é¢„è®¡å·¥ä½œé‡**ï¼š3-4 å°æ—¶

---

### é˜¶æ®µ 3ï¼šIM å®¢æˆ·ç«¯æ”¹åŠ¨ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

**æ­¥éª¤ 3.1**ï¼šä¿®æ”¹ `MonitorPage.tsx`
- [ ] æ·»åŠ  `monitor:new_message_hint` ç›‘å¬
- [ ] å®ç° `handleNewMessageHint()` æ–¹æ³•
- [ ] å®ç° `handleCommentHint()` æ–¹æ³•
- [ ] å®ç° `handlePrivateMessageHint()` æ–¹æ³•
- [ ] æ·»åŠ æµè§ˆå™¨é€šçŸ¥æ”¯æŒ

**æ­¥éª¤ 3.2**ï¼šä¿®æ”¹ `monitorSlice.ts`
- [ ] æ·»åŠ  `updateChannelUnreadCount` action

**é¢„è®¡å·¥ä½œé‡**ï¼š4-5 å°æ—¶

---

### é˜¶æ®µ 4ï¼šæµ‹è¯•éªŒè¯ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

**æ­¥éª¤ 4.1**ï¼šé›†æˆæµ‹è¯•
- [ ] å¯åŠ¨ Workerã€Masterã€IM å®¢æˆ·ç«¯
- [ ] æ¨¡æ‹Ÿæ–°è¯„è®ºåˆ°è¾¾
- [ ] éªŒè¯ Worker ç«‹å³æ¨é€
- [ ] éªŒè¯ Master æ¨é€ç®€æ˜“æ¦‚è¦
- [ ] éªŒè¯å®¢æˆ·ç«¯ UI åˆ·æ–°

**æ­¥éª¤ 4.2**ï¼šè¾¹ç•Œåœºæ™¯æµ‹è¯•
- [ ] æµ‹è¯•å¿«é€Ÿè¿ç»­æ–°æ¶ˆæ¯
- [ ] æµ‹è¯•åˆ‡æ¢è´¦æˆ·æ—¶çš„çº¢ç‚¹æ›´æ–°
- [ ] æµ‹è¯•åœ¨ä¼šè¯å†…æ—¶çš„è‡ªåŠ¨åˆ·æ–°
- [ ] æµ‹è¯•ä¸åœ¨ä¼šè¯å†…æ—¶ä¸åˆ·æ–°è¯¦æƒ…

**é¢„è®¡å·¥ä½œé‡**ï¼š2-3 å°æ—¶

---

## ä¸ƒã€æŠ€æœ¯ç»†èŠ‚ï¼ˆä¼˜åŒ–ç‰ˆï¼‰

### 7.1 Worker å±‚é˜²æŠ–æœºåˆ¶

Worker å±‚åœ¨æ£€æµ‹åˆ°æ–°æ¶ˆæ¯æ—¶ï¼Œä¼šç«‹å³è§¦å‘æ¨é€ã€‚ä¸ºé¿å…é¢‘ç¹æ¨é€ï¼Œä½¿ç”¨ `_isSyncing` æ ‡å¿—è¿›è¡Œé˜²æŠ–ï¼š

```javascript
if (this._isSyncing) {
  this.logger.debug('Already syncing, skip immediate push');
  return;
}
```

### 7.2 å®¢æˆ·ç«¯é˜²æŠ–æœºåˆ¶ âœ¨æ–°å¢

å®¢æˆ·ç«¯åœ¨çŸ­æ—¶é—´å†…æ”¶åˆ°å¤šæ¡æ–°æ¶ˆæ¯æç¤ºæ—¶ï¼Œä½¿ç”¨é˜²æŠ–æœºåˆ¶é¿å…é¢‘ç¹è¯·æ±‚ï¼š

```typescript
const refreshTimers = useRef<Map<string, NodeJS.Timeout>>(new Map())

// æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
if (refreshTimers.current.has(refreshKey)) {
  clearTimeout(refreshTimers.current.get(refreshKey)!)
}

// è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼ˆ1ç§’åæ‰§è¡Œï¼‰
const timer = setTimeout(() => {
  // æ‰§è¡Œåˆ·æ–°é€»è¾‘
}, 1000)

refreshTimers.current.set(refreshKey, timer)
```

**é˜²æŠ–ç­–ç•¥**ï¼š
- **çº¢ç‚¹æ›´æ–°**ï¼šç«‹å³æ‰§è¡Œï¼ˆä¸é˜²æŠ–ï¼‰ï¼Œç¡®ä¿å®æ—¶æ˜¾ç¤º
- **æµè§ˆå™¨é€šçŸ¥**ï¼šç«‹å³æ‰§è¡Œï¼ˆä¸é˜²æŠ–ï¼‰ï¼Œç¡®ä¿åŠæ—¶æé†’
- **è¯¦ç»†æ•°æ®åˆ·æ–°**ï¼š1ç§’é˜²æŠ–ï¼Œåˆå¹¶çŸ­æ—¶é—´å†…çš„å¤šæ¬¡è¯·æ±‚

### 7.3 æŒ‰éœ€æ‹‰å–ç­–ç•¥ âœ¨ä¼˜åŒ–

**æœåŠ¡ç«¯**ï¼š
- âŒ ä¸æ¨é€å®Œæ•´ topics åˆ—è¡¨
- âœ… åªæ¨é€ç®€æ˜“æ¦‚è¦ï¼ˆ200-500 å­—èŠ‚ï¼‰
- ğŸ’¡ å‡è½»æœåŠ¡ç«¯å‹åŠ›ï¼Œå°¤å…¶æ˜¯å®¢æˆ·ç«¯æ•°é‡å¤šæ—¶

**å®¢æˆ·ç«¯**ï¼š
- æ”¶åˆ°æç¤ºåï¼Œæ ¹æ®å½“å‰é¡µé¢çŠ¶æ€å†³å®šæ˜¯å¦æ‹‰å–
- åœ¨ç›¸å…³é¡µé¢ â†’ ä¸»åŠ¨è°ƒç”¨ `monitor:request_topics` æˆ– `monitor:request_messages`
- ä¸åœ¨ç›¸å…³é¡µé¢ â†’ åªæ›´æ–°çº¢ç‚¹ï¼Œä¸æ‹‰å–è¯¦ç»†æ•°æ®

### 7.4 å…¼å®¹æ€§è€ƒè™‘

- **å®šæœŸæ¨é€**ï¼šä¿ç•™ 30ç§’å®šæœŸæ¨é€ä½œä¸ºå…œåº•ï¼Œç¡®ä¿å³ä½¿ç«‹å³æ¨é€å¤±è´¥ï¼Œä¹Ÿèƒ½æœ€ç»ˆåŒæ­¥æ•°æ®
- **æ¸è¿›å¼å‡çº§**ï¼šå®¢æˆ·ç«¯å¯ä»¥é€‰æ‹©åªå®ç°çº¢ç‚¹æ›´æ–°ï¼Œæš‚ä¸å®ç°è¯¦ç»†åˆ·æ–°

### 7.5 æ€§èƒ½ä¼˜åŒ–

- **ç®€æ˜“æ¨é€**ï¼šåªæ¨é€æ¦‚è¦ä¿¡æ¯ï¼ˆçº¦ 200-500 å­—èŠ‚ï¼‰ï¼Œç›¸æ¯”å®Œæ•´ topicsï¼ˆå¯èƒ½ 10KB+ï¼‰å‡å°‘ 95% æµé‡
- **æ™ºèƒ½åˆ·æ–°**ï¼šå®¢æˆ·ç«¯åªåœ¨éœ€è¦æ—¶è¯·æ±‚è¯¦ç»†æ•°æ®ï¼Œé¿å…ç›²ç›®åˆ·æ–°
- **é˜²æŠ–åˆå¹¶**ï¼š1ç§’å†…å¤šæ¡æ–°æ¶ˆæ¯åˆå¹¶ä¸ºä¸€æ¬¡åˆ·æ–°è¯·æ±‚

---

## å…«ã€ç›‘æ§æŒ‡æ ‡ï¼ˆä¼˜åŒ–ç‰ˆï¼‰

å»ºè®®æ·»åŠ ä»¥ä¸‹ç›‘æ§æŒ‡æ ‡ï¼š

1. **Worker å±‚**ï¼š
   - æ–°æ¶ˆæ¯æ£€æµ‹æ¬¡æ•°
   - ç«‹å³æ¨é€è§¦å‘æ¬¡æ•°
   - ç«‹å³æ¨é€å»¶è¿Ÿï¼ˆä»æ£€æµ‹åˆ°æ¨é€å®Œæˆï¼‰
   - é˜²æŠ–è·³è¿‡æ¬¡æ•°ï¼ˆ_isSyncing è§¦å‘ï¼‰

2. **Master å±‚**ï¼š
   - ç®€æ˜“æ¦‚è¦æ¨é€æ¬¡æ•°
   - æ¨é€å¤±è´¥æ¬¡æ•°
   - æ¨é€å»¶è¿Ÿ
   - æ¯æ¬¡æ¨é€çš„å®¢æˆ·ç«¯æ•°é‡

3. **å®¢æˆ·ç«¯å±‚**ï¼š
   - æ¥æ”¶åˆ°ç®€æ˜“æç¤ºæ¬¡æ•°
   - é˜²æŠ–åˆå¹¶æ¬¡æ•°ï¼ˆå®šæ—¶å™¨è¢«æ¸…é™¤çš„æ¬¡æ•°ï¼‰âœ¨æ–°å¢
   - ä¸»åŠ¨åˆ·æ–°è¯·æ±‚æ¬¡æ•°
   - çº¢ç‚¹æ›´æ–°æ¬¡æ•° âœ¨æ–°å¢
   - UI åˆ·æ–°å»¶è¿Ÿï¼ˆä»æç¤ºåˆ° UI æ›´æ–°ï¼‰

---

## ä¹ã€é£é™©è¯„ä¼°ï¼ˆä¼˜åŒ–ç‰ˆï¼‰

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| Worker é¢‘ç¹æ¨é€å¯¼è‡´æ€§èƒ½é—®é¢˜ | ä¸­ | æ·»åŠ  Worker å±‚é˜²æŠ–æœºåˆ¶ï¼ˆ_isSyncing æ ‡å¿—ï¼‰ |
| å®¢æˆ·ç«¯é¢‘ç¹è¯·æ±‚å¯¼è‡´æœåŠ¡å™¨å‹åŠ› | ä¸­ | æ·»åŠ å®¢æˆ·ç«¯é˜²æŠ–æœºåˆ¶ï¼ˆ1ç§’åˆå¹¶å¤šæ¬¡è¯·æ±‚ï¼‰âœ¨æ–°å¢ |
| Master æ¨é€å¤±è´¥ | ä½ | ä¿ç•™å®šæœŸæ¨é€ä½œä¸ºå…œåº•ï¼ˆ30ç§’ï¼‰ |
| å®¢æˆ·ç«¯ç›‘å¬å™¨æœªæ³¨å†Œ | ä½ | å®¢æˆ·ç«¯é€šè¿‡å®šæœŸæ¨é€è·å–æ•°æ®ï¼ˆå…œåº•æœºåˆ¶ï¼‰ |
| ç½‘ç»œå»¶è¿Ÿå¯¼è‡´æ¨é€é¡ºåºé”™ä¹± | ä½ | ä½¿ç”¨æ—¶é—´æˆ³æ¯”å¯¹ï¼Œå®¢æˆ·ç«¯å¿½ç•¥æ—§æ•°æ® |
| ç®€æ˜“æ¨é€ä¿¡æ¯ä¸è¶³ | ä½ | å®¢æˆ·ç«¯ä¸»åŠ¨æ‹‰å–è¯¦ç»†æ•°æ®ï¼ŒæŒ‰éœ€è·å– |

---

## åã€åç»­ä¼˜åŒ–æ–¹å‘

1. **WebSocket å‹ç¼©**ï¼šå¯ç”¨ Socket.IO çš„å‹ç¼©åŠŸèƒ½ï¼Œè¿›ä¸€æ­¥å‡å°‘æµé‡
2. **æ¨é€ä¼˜å…ˆçº§**ï¼šä¸ºä¸åŒç±»å‹çš„æ¶ˆæ¯è®¾ç½®ä¼˜å…ˆçº§ï¼ˆå¦‚ç§ä¿¡ > è¯„è®ºï¼‰
3. **æ‰¹é‡æ¨é€**ï¼šåœ¨çŸ­æ—¶é—´å†…ï¼ˆå¦‚ 1 ç§’ï¼‰æ”¶åˆ°å¤šæ¡æ–°æ¶ˆæ¯æ—¶ï¼Œæ‰¹é‡æ¨é€ä¸€æ¬¡
4. **ç¦»çº¿æ¶ˆæ¯**ï¼šå®¢æˆ·ç«¯é‡æ–°è¿æ¥åï¼Œæ‹‰å–ç¦»çº¿æœŸé—´çš„æ–°æ¶ˆæ¯

---

---

## é™„å½•ï¼šä¼˜åŒ–ç‚¹æ€»ç»“

### ç›¸æ¯”åˆå§‹è®¾è®¡çš„ä¼˜åŒ–

1. **ç§»é™¤å®Œæ•´æ•°æ®æ¨é€**ï¼ˆé‡‡çº³ç”¨æˆ·å»ºè®®ï¼‰ï¼š
   - âŒ ç§»é™¤ï¼š`monitor:topics` å®Œæ•´æ•°æ®æ¨é€
   - âœ… ä¿ç•™ï¼š`monitor:new_message_hint` ç®€æ˜“æ¦‚è¦æ¨é€
   - ğŸ’¡ ç†ç”±ï¼šå®¢æˆ·ç«¯æ•°é‡å¤šæ—¶ï¼Œå®Œæ•´æ¨é€ä¼šå¢åŠ æœåŠ¡ç«¯å‹åŠ›

2. **æ·»åŠ å®¢æˆ·ç«¯é˜²æŠ–æœºåˆ¶**ï¼ˆé‡‡çº³ç”¨æˆ·å»ºè®®ï¼‰ï¼š
   - âœ… çº¢ç‚¹æ›´æ–°ï¼šç«‹å³æ‰§è¡Œï¼ˆä¸é˜²æŠ–ï¼‰
   - âœ… æµè§ˆå™¨é€šçŸ¥ï¼šç«‹å³æ‰§è¡Œï¼ˆä¸é˜²æŠ–ï¼‰
   - âœ… è¯¦ç»†æ•°æ®åˆ·æ–°ï¼š1ç§’é˜²æŠ–åˆå¹¶
   - ğŸ’¡ ç†ç”±ï¼šé¿å…çŸ­æ—¶é—´å†…é¢‘ç¹è¯·æ±‚æœåŠ¡å™¨

3. **çº¯æŒ‰éœ€æ‹‰å–è®¾è®¡**ï¼š
   - æœåŠ¡ç«¯ï¼šåªæ¨é€ç®€æ˜“æ¦‚è¦
   - å®¢æˆ·ç«¯ï¼šä¸»åŠ¨æ‹‰å–éœ€è¦çš„æ•°æ®
   - ğŸ’¡ ç†ç”±ï¼šæ›´åˆç†çš„æ¶æ„è®¾è®¡ï¼Œå‡è½»æœåŠ¡ç«¯å‹åŠ›

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.1ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
**åˆ›å»ºæ—¶é—´**ï¼š2025-11-13
**æœ€åæ›´æ–°**ï¼š2025-11-13
**ä½œè€…**ï¼šClaude Code
**æ–‡ä»¶è·¯å¾„**ï¼š`docs/æ–°æ¶ˆæ¯å®æ—¶æ¨é€æ¶æ„è®¾è®¡.md`
