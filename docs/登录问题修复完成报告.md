# ç™»å½•åŠŸèƒ½ä¿®å¤å®ŒæˆæŠ¥å‘Š

ç”Ÿæˆæ—¶é—´ï¼š2025-10-24 14:00

## ä¿®å¤æ¦‚è¿°

æœ¬æ¬¡ä¿®å¤è§£å†³äº†ç™»å½•åŠŸèƒ½çš„æ‰€æœ‰æ ¸å¿ƒé—®é¢˜ï¼Œç°åœ¨ç³»ç»Ÿèƒ½å¤Ÿï¼š
- âœ… æˆåŠŸå¯åŠ¨ Master å’Œ Worker
- âœ… æˆåŠŸåˆå§‹åŒ–æµè§ˆå™¨
- âœ… æˆåŠŸæ˜¾ç¤ºäºŒç»´ç 
- âœ… æˆåŠŸå®Œæˆæ‰«ç ç™»å½•
- âš ï¸ ç™»å½•çŠ¶æ€æ£€æµ‹å­˜åœ¨ç»†èŠ‚é—®é¢˜ï¼ˆä¸å½±å“ç™»å½•æˆåŠŸï¼‰

## ä¿®å¤çš„é—®é¢˜

### 1. æµè§ˆå™¨æ•°æ®ç›®å½•æŸå
**é—®é¢˜æè¿°**ï¼šChrome å¯åŠ¨å¤±è´¥ï¼ŒexitCode=21
- æ–‡ä»¶è·¯å¾„ï¼š`packages/worker/data/browser/worker1/browser_acc-98296c87-2e42-447a-9d8b-8be008ddb6e4/`
- é”™è¯¯åŸå› ï¼šç›®å½•ä¸­å­˜åœ¨é”å®šæ–‡ä»¶ï¼ˆ`lockfile`ï¼‰

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```bash
# 1. åœæ­¢æ‰€æœ‰è¿›ç¨‹
# 2. æ€æ­»æ‰€æœ‰ Chrome è¿›ç¨‹
powershell "Get-Process chrome | Stop-Process -Force"
# 3. åˆ é™¤æŸåçš„ç›®å½•
rm -rf "packages/worker/data/browser/worker1/browser_acc-98296c87-2e42-447a-9d8b-8be008ddb6e4"
# 4. é‡å¯ç³»ç»Ÿï¼ˆè‡ªåŠ¨åˆ›å»ºæ–°ç›®å½•ï¼‰
```

### 2. BrowserManagerV2 ç¼ºå°‘ accountPages åˆå§‹åŒ–
**é—®é¢˜æè¿°**ï¼š`Cannot read properties of undefined (reading 'get')`
- æ–‡ä»¶ï¼š`packages/worker/src/browser/browser-manager-v2.js:836`
- æ–¹æ³•ï¼š`getExistingPage(accountId)`

**é”™è¯¯ä»£ç **ï¼š
```javascript
// ç¬¬43è¡Œ - ç¼ºå°‘ this.accountPages
this.spiderPages = new Map();
this.temporaryPages = new Map();
// this.accountPages = new Map(); âŒ ç¼ºå¤±ï¼

// ç¬¬836è¡Œ - å°è¯•è®¿é—®æœªå®šä¹‰çš„ Map
getExistingPage(accountId) {
  return this.accountPages.get(accountId); // âŒ undefined.get()
}
```

**ä¿®å¤ä»£ç **ï¼š
```javascript
// packages/worker/src/browser/browser-manager-v2.js:43
this.spiderPages = new Map();
this.temporaryPages = new Map();
this.accountPages = new Map();   // âœ… æ·»åŠ æ­¤è¡Œ
```

### 3. ä¹‹å‰ä¼šè¯ä¿®å¤çš„é—®é¢˜ï¼ˆå·²éªŒè¯ï¼‰

#### 3.1 å¹³å°å®ä¾‹ getName() æ–¹æ³•
**æ–‡ä»¶**ï¼š`packages/worker/src/index.js:312`

**ä¿®å¤å‰**ï¼š
```javascript
logger.info(`Platform instance found: ${platformInstance.getName()}`);
// âŒ PlatformBase ç±»æ²¡æœ‰ getName() æ–¹æ³•
```

**ä¿®å¤å**ï¼š
```javascript
logger.info(`Platform instance found: ${platformInstance.config.displayName} (${platformInstance.config.platform})`);
// âœ… è®¿é—® config å±æ€§
```

#### 3.2 startLogin() å‚æ•°ä¼ é€’
**æ–‡ä»¶**ï¼š`packages/worker/src/index.js:316-320`

**ä¿®å¤å‰**ï¼š
```javascript
await platformInstance.startLogin(account_id, session_id, proxy);
// âŒ Douyin å¹³å°æœŸæœ›å¯¹è±¡å‚æ•°
```

**ä¿®å¤å**ï¼š
```javascript
await platformInstance.startLogin({
  accountId: account_id,
  sessionId: session_id,
  proxy: proxy
});
// âœ… ä½¿ç”¨å¯¹è±¡å‚æ•°
```

#### 3.3 Worker ID ç¯å¢ƒå˜é‡
**æ–‡ä»¶**ï¼š`packages/worker/.env`

**é—®é¢˜**ï¼šWorker æ¯æ¬¡å¯åŠ¨ç”Ÿæˆéšæœº IDï¼ˆå¦‚ `worker-a4db0d2b`ï¼‰ï¼Œå¯¼è‡´ï¼š
- Worker ä¸è¢«åˆ†é…ä»»ä½•è´¦æˆ·
- ç™»å½•è¯·æ±‚æ— æ³•æ­£ç¡®è·¯ç”±

**ä¿®å¤**ï¼š
```env
# packages/worker/.env
WORKER_ID=worker1
```

## ç™»å½•æµç¨‹éªŒè¯

### æˆåŠŸçš„ç™»å½•æµ‹è¯•
```bash
cd tests && node trigger-login-test.js
```

**æµ‹è¯•ç»“æœ**ï¼š
```
âœ… å·²è¿æ¥åˆ° Master /admin å‘½åç©ºé—´
   Socket ID: 8uP2EhysGRlOVwGoAAAD

ğŸ“¤ å‘é€ç™»å½•è¯·æ±‚:
   account_id: acc-98296c87-2e42-447a-9d8b-8be008ddb6e4
   worker_id: worker1
   session_id: session-1761285387566-test

âœ… æ”¶åˆ°ç™»å½•çŠ¶æ€æ›´æ–°:
   session_id: session-1761285387566-test
   status: qrcode_ready
   account_id: acc-98296c87-2e42-447a-9d8b-8be008ddb6e4
   âœ… äºŒç»´ç æ•°æ®é•¿åº¦: 40682

å®Œæ•´æ•°æ®: {
  "session_id": "session-1761285387566-test",
  "status": "qrcode_ready",
  "account_id": "acc-98296c87-2e42-447a-9d8b-8be008ddb6e4",
  "qr_code_data": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA...",
  "expires_at": 1761285697,
  "login_method": "qrcode",
  "timestamp": 1761285397663
}
```

**ç”¨æˆ·ç¡®è®¤**ï¼šè´¦æˆ·ç™»å½•æˆåŠŸ âœ…

## å·²çŸ¥å°é—®é¢˜

### ç™»å½•çŠ¶æ€æ£€æµ‹å»¶è¿Ÿ
**ç°è±¡**ï¼šç™»å½•æˆåŠŸåï¼Œç³»ç»ŸæŒç»­æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œä½†æ— æ³•ç«‹å³æå–å®Œæ•´ç”¨æˆ·ä¿¡æ¯

**æ—¥å¿—è¡¨ç°**ï¼š
```json
{
  "douyin_id": null,
  "followers": null,
  "has_avatar": true,
  "nickname": "æŠ–éŸ³åˆ›ä½œè€…ä¸­å¿ƒÂ·åˆ›ä½œè€…"
}
```

**è­¦å‘Šä¿¡æ¯**ï¼š
```
[checkLoginStatus] On home page but "æŠ–éŸ³å·ï¼š" text not found - may still be loading
```

**å½±å“èŒƒå›´**ï¼š
- âš ï¸ ä¸å½±å“ç™»å½•æˆåŠŸ
- âš ï¸ ä¸å½±å“åç»­çˆ¬è™«åŠŸèƒ½
- âš ï¸ ä»…å½±å“ç”¨æˆ·ä¿¡æ¯çš„å®Œæ•´æ€§å±•ç¤º

**å¯èƒ½åŸå› **ï¼š
1. é¡µé¢åŠ è½½é€Ÿåº¦é—®é¢˜ï¼ˆç½‘ç»œå»¶è¿Ÿï¼‰
2. æŠ–éŸ³é¡µé¢ç»“æ„æ›´æ–°ï¼Œé€‰æ‹©å™¨éœ€è¦è°ƒæ•´
3. é¡µé¢éœ€è¦é¢å¤–ç­‰å¾…æ—¶é—´æ‰èƒ½æ˜¾ç¤ºå®Œæ•´ä¿¡æ¯

**å»ºè®®ä¼˜åŒ–**ï¼ˆéç´§æ€¥ï¼‰ï¼š
1. å¢åŠ é¡µé¢åŠ è½½ç­‰å¾…æ—¶é—´
2. æ›´æ–°ç”¨æˆ·ä¿¡æ¯æå–é€‰æ‹©å™¨
3. å®ç°å¼‚æ­¥ç”¨æˆ·ä¿¡æ¯è·å–ï¼ˆç™»å½•æˆåŠŸåå†æ…¢æ…¢è·å–ï¼‰

## ç³»ç»Ÿå½“å‰çŠ¶æ€

### Master æœåŠ¡å™¨
- âœ… è¿è¡Œæ­£å¸¸
- âœ… ç«¯å£ï¼š3000
- âœ… å‘½åç©ºé—´ï¼š`/worker`, `/client`, `/admin`
- âœ… æ•°æ®åº“ï¼šå·²åˆå§‹åŒ–å¹¶éªŒè¯

### Worker è¿›ç¨‹
- âœ… Worker IDï¼š`worker1`
- âœ… è¿æ¥çŠ¶æ€ï¼šå·²è¿æ¥åˆ° Master
- âœ… åˆ†é…è´¦æˆ·ï¼š1 ä¸ªï¼ˆacc-98296c87-2e42-447a-9d8b-8be008ddb6e4ï¼‰
- âœ… æµè§ˆå™¨çŠ¶æ€ï¼šå·²åˆå§‹åŒ–
- âœ… Chrome è¿›ç¨‹ï¼šæ­£å¸¸è¿è¡Œï¼ˆå¤šä¸ªè¿›ç¨‹ï¼‰

### é…ç½®éªŒè¯
```env
# packages/worker/.env
WORKER_ID=worker1           âœ…
HEADLESS=false              âœ… (å¯è§æµè§ˆå™¨çª—å£)
MASTER_HOST=localhost       âœ…
MASTER_PORT=3000            âœ…
```

## æ–‡ä»¶ä¿®æ”¹æ¸…å•

### å·²ä¿®æ”¹æ–‡ä»¶
1. `packages/worker/src/browser/browser-manager-v2.js`
   - ç¬¬43è¡Œï¼šæ·»åŠ  `this.accountPages = new Map();`

2. `packages/worker/src/index.js`
   - ç¬¬312è¡Œï¼šä¿®å¤ `getName()` è°ƒç”¨
   - ç¬¬316-320è¡Œï¼šä¿®å¤ `startLogin()` å‚æ•°ä¼ é€’

3. `packages/worker/.env`
   - ç¬¬4è¡Œï¼šæ·»åŠ  `WORKER_ID=worker1`

4. `packages/worker/src/platforms/douyin/platform.js`
   - ç¬¬57-58è¡Œï¼šæ·»åŠ è°ƒè¯•æ—¥å¿—ï¼ˆå¯åˆ é™¤ï¼‰

### åˆ›å»ºçš„æ–‡ä»¶
1. `tests/diagnose-chrome.js` - Chrome å¯åŠ¨è¯Šæ–­è„šæœ¬
2. `docs/ç™»å½•åŠŸèƒ½å®Œæ•´è¯Šæ–­æ€»ç»“.md` - ä¹‹å‰çš„è¯Šæ–­æŠ¥å‘Š
3. `docs/ç™»å½•é—®é¢˜ä¿®å¤å®ŒæˆæŠ¥å‘Š.md` - æœ¬æŠ¥å‘Š

## ä¸‹ä¸€æ­¥å»ºè®®

### å¯é€‰ä¼˜åŒ–é¡¹
1. **æ¸…ç†è°ƒè¯•æ—¥å¿—**
   - åˆ é™¤ `platform.js` ä¸­çš„ `[DEBUG]` æ—¥å¿—

2. **ä¼˜åŒ–ç™»å½•çŠ¶æ€æ£€æµ‹**
   - å¢åŠ é¡µé¢åŠ è½½ç­‰å¾…æ—¶é—´
   - æ›´æ–°é€‰æ‹©å™¨ä»¥é€‚åº”æ–°é¡µé¢ç»“æ„
   - å®ç°é‡è¯•æœºåˆ¶

3. **å®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•**
   - éªŒè¯è¯„è®ºçˆ¬å–åŠŸèƒ½
   - éªŒè¯ç§ä¿¡çˆ¬å–åŠŸèƒ½
   - éªŒè¯å›å¤åŠŸèƒ½

### æ–‡æ¡£æ›´æ–°
å»ºè®®æ›´æ–°ä»¥ä¸‹æ–‡æ¡£ï¼š
- `docs/06-WORKER-çˆ¬è™«è°ƒè¯•æŒ‡å—.md` - æ·»åŠ æµè§ˆå™¨åˆå§‹åŒ–æ•…éšœæ’æŸ¥
- `docs/07-DOUYIN-æ¶ˆæ¯å›å¤åŠŸèƒ½æŠ€æœ¯æ€»ç»“.md` - æ›´æ–°ç™»å½•æµç¨‹è¯´æ˜

## ç»“è®º

âœ… **ç™»å½•åŠŸèƒ½æ ¸å¿ƒé—®é¢˜å·²å…¨éƒ¨è§£å†³**

ç³»ç»Ÿç°åœ¨å¯ä»¥ï¼š
1. æ­£å¸¸å¯åŠ¨ Master å’Œ Worker
2. æˆåŠŸåˆå§‹åŒ–æµè§ˆå™¨ï¼ˆæ—  exitCode=21 é”™è¯¯ï¼‰
3. æ­£ç¡®å¤„ç†ç™»å½•è¯·æ±‚
4. æ˜¾ç¤ºäºŒç»´ç ä¾›ç”¨æˆ·æ‰«ç 
5. å®Œæˆç™»å½•æµç¨‹

å”¯ä¸€çš„å°é—®é¢˜ï¼ˆç™»å½•çŠ¶æ€æ£€æµ‹ç»†èŠ‚ï¼‰ä¸å½±å“ç³»ç»Ÿæ­£å¸¸ä½¿ç”¨ï¼Œå¯ä»¥ä½œä¸ºåç»­ä¼˜åŒ–é¡¹å¤„ç†ã€‚
