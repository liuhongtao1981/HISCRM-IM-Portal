# ç§ä¿¡æŠ“å–ä¿®å¤ - æœ€ç»ˆç‰ˆæœ¬

**æ—¥æœŸ**: 2025-11-05 17:00
**çŠ¶æ€**: ä»£ç ä¿®å¤ä¸­

---

## å·²å®Œæˆçš„ä¿®å¤

### 1. âœ… ä¿®å¤è¿”å›å€¼ç»“æ„ï¼ˆå‘åå…¼å®¹ï¼‰

**é—®é¢˜**: `extractMessagesFromVirtualList()` è¿”å›å¯¹è±¡ `{ messages, debugInfo, allPropsDebug }`ï¼Œä½†è°ƒç”¨å¤„æœŸæœ›æ•°ç»„

**ä¿®å¤**:
```javascript
// ä¿®æ”¹å‰:
return {
  messages: deduped,
  debugInfo: debugInfo,
  allPropsDebug: allPropsDebug
};

// ä¿®æ”¹å:
return deduped;  // ç›´æ¥è¿”å›æ•°ç»„
```

**è°ƒç”¨å¤„åŒæ­¥ä¿®æ”¹**:
```javascript
// ä¿®æ”¹å‰:
const extractResult = await extractMessagesFromVirtualList(page);
const messages = extractResult.messages;

// ä¿®æ”¹å:
const messages = await extractMessagesFromVirtualList(page);
```

### 2. âœ… åˆ é™¤æ–°å¢çš„å†—ä½™å‡½æ•°

åˆ é™¤äº†ä»¥ä¸‹3ä¸ªä¸´æ—¶æ·»åŠ çš„å‡½æ•°ï¼ˆå…±240è¡Œä»£ç ï¼‰:
- `scrollVirtualListToIndex()` - è™šæ‹Ÿåˆ—è¡¨æ»šåŠ¨
- `extractMessagesFromDOM()` - DOMæ¶ˆæ¯æå–
- `extractVisibleConversations()` - å¯è§ä¼šè¯æå–

è¿™äº›å‡½æ•°æ˜¯ä¸ºäº†å¤„ç†äºŒè¿›åˆ¶Protobufå“åº”çš„ä¸´æ—¶æ–¹æ¡ˆï¼Œä½†å®é™…ä¸éœ€è¦ã€‚

### 3. âœ… æ¢å¤å¯¼èˆªé€»è¾‘åˆ°åŸå§‹çŠ¶æ€

**é—®é¢˜**: ä¿®æ”¹äº† `page.goto()` çš„å‚æ•°ï¼Œå¯¼è‡´é¡µé¢æœªå®Œå…¨åŠ è½½

**ä¿®å¤**:
```javascript
// ä¿®æ”¹å‰:
await page.goto(..., {
  waitUntil: 'domcontentloaded',
  timeout: 15000
});

// ä¿®æ”¹åï¼ˆæ¢å¤åŸå§‹ï¼‰:
await page.goto(..., {
  waitUntil: 'networkidle',
  timeout: 30000
});
```

### 4. âœ… åˆ é™¤APIæ‹¦æˆªå™¨ä¸­çš„äºŒè¿›åˆ¶å¤„ç†

**é—®é¢˜**: æ·»åŠ äº†å¤æ‚çš„äºŒè¿›åˆ¶Protobufæ£€æµ‹é€»è¾‘ï¼Œä½†å®é™…æ˜¯JSONå“åº”

**ä¿®å¤**:
```javascript
// ä¿®æ”¹å‰:
async function onMessageInitAPI(body) {
  if (!body) return;
  if (body.__isBinary) {
    // ... 20è¡ŒäºŒè¿›åˆ¶å¤„ç†ä»£ç  ...
    return;
  }
  if (!body.data || !body.data.messages) return;
  // ...
}

// ä¿®æ”¹åï¼ˆæ¢å¤åŸå§‹ï¼‰:
async function onMessageInitAPI(body) {
  if (!body || !body.data || !body.data.messages) return;
  // ...
}
```

---

## å¾…å®Œæˆçš„ä¿®å¤

### 5. ğŸ”„ æ·»åŠ æœ€å°‘ä½†å…³é”®çš„è°ƒè¯•æ—¥å¿—

**éœ€è¦æ·»åŠ çš„æ—¥å¿—ä½ç½®**:

1. **åœ¨ `page.evaluate()` å†…éƒ¨** (æµè§ˆå™¨ç¯å¢ƒ):
   ```javascript
   console.log(`ğŸ” æ‰¾åˆ° ${allElements.length} ä¸ªå…ƒç´ `);
   console.log(`âœ… æ‰¾åˆ°æ¶ˆæ¯ props`);  // æ‰¾åˆ°propsæ—¶
   console.log(`âœ… æ·»åŠ æ¶ˆæ¯ ${messages.length}`);  // æ·»åŠ æ¶ˆæ¯æ—¶
   console.log(`âœ… æå–å®Œæˆ: ${deduped.length} æ¡æ¶ˆæ¯`);
   ```

2. **åœ¨ Node.js ç«¯ç›‘å¬æµè§ˆå™¨æ—¥å¿—**:
   ```javascript
   // åœ¨è°ƒç”¨ extractMessagesFromVirtualList ä¹‹å‰æ·»åŠ ç›‘å¬
   page.on('console', msg => {
     logger.info(`[æµè§ˆå™¨] ${msg.text()}`);
   });
   ```

3. **åœ¨ Node.js ç«¯è®°å½•ç»“æœ**:
   ```javascript
   const messages = await extractMessagesFromVirtualList(page);
   logger.info(`ğŸ“¥ æå–ç»“æœ: ${messages.length} æ¡æ¶ˆæ¯`);
   ```

### 6. ğŸ”„ ä¿®å¤æ‰€æœ‰è¿”å›ç©ºå¯¹è±¡çš„åœ°æ–¹

å½“å‰ä»£ç ä¸­è¿˜æœ‰å¤šå¤„è¿”å› `{ messages: [] }` éœ€è¦æ”¹ä¸º `[]`:

```bash
grep -n "return { messages: \[\]" packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js
```

éœ€è¦å…¨éƒ¨ä¿®æ”¹ä¸º `return []`ã€‚

---

## å…³é”®é—®é¢˜è¯Šæ–­

### ä¸ºä»€ä¹ˆ Git ç‰ˆæœ¬ä¹Ÿè¿”å› 0 æ¡æ¶ˆæ¯ï¼Ÿ

ç»è¿‡æµ‹è¯•å‘ç°ï¼Œå›é€€åˆ° Git ç‰ˆæœ¬ (`6d9ff28`) åé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯´æ˜**é—®é¢˜ä¸æ˜¯æ˜¨å¤©çš„è°ƒè¯•ä»£ç å¯¼è‡´çš„**ã€‚

**çœŸæ­£çš„é—®é¢˜å¯èƒ½æ˜¯**:

#### å¯èƒ½æ€§ 1: DOM é€‰æ‹©å™¨é”™è¯¯

Git ç‰ˆæœ¬ä½¿ç”¨çš„é€‰æ‹©å™¨ï¼š
```javascript
const allElements = document.querySelectorAll('[class*="message"], [class*="item"], [role*="article"]');
```

è¿™ä¸ªé€‰æ‹©å™¨å¯èƒ½**æ‰¾ä¸åˆ°æŠ–éŸ³ç§ä¿¡çš„æ¶ˆæ¯å…ƒç´ **ã€‚

**æ­£ç¡®çš„é€‰æ‹©å™¨** (è°ƒè¯•ç‰ˆæœ¬):
```javascript
const messageContainer = document.querySelector('.box-content-jSgLQF');
const allElements = Array.from(messageContainer.children[0].children);
```

#### å¯èƒ½æ€§ 2: React Fiber æ¡ä»¶æ£€æŸ¥è¿‡ä¸¥æ ¼

Git ç‰ˆæœ¬çš„æ¡ä»¶ï¼š
```javascript
if (props.conversationId || props.serverId || props.content || props.message) {
  // ä½¿ç”¨ ORï¼Œåªè¦æœ‰ä¸€ä¸ªå­—æ®µå°±å¯ä»¥
}
```

è°ƒè¯•ç‰ˆæœ¬çš„æ¡ä»¶ï¼š
```javascript
if (props.serverId && props.content && props.sender && props.conversationId) {
  // ä½¿ç”¨ ANDï¼Œå¿…é¡»å…¨éƒ¨éƒ½æœ‰ï¼âŒ è¿™å¤ªä¸¥æ ¼äº†
}
```

**æ¨è**ï¼šä¿æŒ Git ç‰ˆæœ¬çš„ OR é€»è¾‘ï¼Œä½†ä½¿ç”¨è°ƒè¯•ç‰ˆæœ¬çš„é€‰æ‹©å™¨ã€‚

#### å¯èƒ½æ€§ 3: æ²¡æœ‰ç­‰å¾…æ¶ˆæ¯åŠ è½½

æ‰“å¼€ä¼šè¯åï¼Œæ¶ˆæ¯å¯èƒ½éœ€è¦æ—¶é—´æ¸²æŸ“åˆ° DOMã€‚

**å½“å‰ä»£ç **:
```javascript
await page.waitForTimeout(1000);  // å›ºå®šç­‰å¾…1ç§’
const messages = await extractMessagesFromVirtualList(page);
```

**å¯èƒ½éœ€è¦**:
```javascript
await page.waitForSelector('.box-content-jSgLQF', { timeout: 5000 });
await page.waitForTimeout(2000);  // å¢åŠ ç­‰å¾…æ—¶é—´
const messages = await extractMessagesFromVirtualList(page);
```

---

## æ¨èçš„æœ€ç»ˆæ–¹æ¡ˆ

### æ–¹æ¡ˆ A: æœ€å°ä¿®æ”¹ï¼ˆæ¨èï¼‰

1. âœ… ä½¿ç”¨è°ƒè¯•ç‰ˆæœ¬çš„ `.box-content-jSgLQF` é€‰æ‹©å™¨
2. âœ… ä¿æŒ Git ç‰ˆæœ¬çš„ OR æ¡ä»¶æ£€æŸ¥
3. âœ… æ·»åŠ æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—ç›‘å¬
4. âœ… å¢åŠ ç­‰å¾…æ—¶é—´åˆ° 2-3 ç§’

```javascript
async function extractMessagesFromVirtualList(page) {
  return await page.evaluate(() => {
    const messages = [];

    // âœ… ä½¿ç”¨æ­£ç¡®çš„é€‰æ‹©å™¨
    const messageContainer = document.querySelector('.box-content-jSgLQF');
    if (!messageContainer || !messageContainer.children[0]) {
      console.log('âŒ æœªæ‰¾åˆ°æ¶ˆæ¯å®¹å™¨');
      return [];
    }

    const allElements = Array.from(messageContainer.children[0].children);
    console.log(`ğŸ” æ‰¾åˆ° ${allElements.length} ä¸ªå…ƒç´ `);

    allElements.forEach((element) => {
      const fiberKey = Object.keys(element).find(key => key.startsWith('__react'));
      if (!fiberKey) return;

      let current = element[fiberKey];
      let depth = 0;

      while (current && depth < 20) {
        if (current.memoizedProps) {
          const props = current.memoizedProps;

          // âœ… ä¿æŒå®½æ¾çš„ OR æ¡ä»¶
          if (props.conversationId || props.serverId || props.content || props.message) {
            const textContent = (props.content?.text || props.text || '');

            if (textContent || props.serverId) {
              // æ„å»ºæ¶ˆæ¯å¯¹è±¡...
              messages.push(message);
            }
            break;
          }
        }
        current = current.child;
        depth++;
      }
    });

    console.log(`âœ… æå–å®Œæˆ: ${messages.length} æ¡æ¶ˆæ¯`);
    return messages;
  });
}
```

### æ–¹æ¡ˆ B: å¦‚æœæ–¹æ¡ˆAå¤±è´¥ï¼Œä½¿ç”¨APIæ‹¦æˆªæ•°æ®

å¦‚æœDOM/Fiberæå–æŒç»­å¤±è´¥ï¼Œå®Œå…¨ä¾èµ–APIæ‹¦æˆªæ•°æ®ï¼š

```javascript
async function crawlCompleteMessageHistory(page, conversation, account) {
  // ä¼˜å…ˆä½¿ç”¨APIæ•°æ®
  if (apiData.init.length > 0 || apiData.history.length > 0) {
    logger.info('ä½¿ç”¨APIæ‹¦æˆªæ•°æ®');
    const messages = extractCompleteMessageObjects([], apiData);
    return messages;
  }

  // APIæ— æ•°æ®æ—¶æ‰æå–DOM
  const messages = await extractMessagesFromVirtualList(page);
  return messages;
}
```

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³**: ä¿®å¤æ‰€æœ‰ `return { messages: [] }` ä¸º `return []`
2. **ç«‹å³**: æ·»åŠ æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—ç›‘å¬
3. **æµ‹è¯•**: é‡å¯ Worker è¿è¡Œä¸€æ¬¡å®Œæ•´æŠ“å–
4. **åˆ†æ**: æŸ¥çœ‹æ–°çš„æ—¥å¿—è¾“å‡ºï¼Œç¡®å®šæ˜¯å“ªä¸ªç¯èŠ‚å¤±è´¥
5. **ä¿®å¤**: æ ¹æ®æ—¥å¿—è°ƒæ•´ä»£ç 

---

**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js`
**å½“å‰è¡Œæ•°**: ~1800 è¡Œ
**ä¿®æ”¹å»ºè®®**: ä½¿ç”¨æ–¹æ¡ˆAï¼ˆæœ€å°ä¿®æ”¹ï¼‰
