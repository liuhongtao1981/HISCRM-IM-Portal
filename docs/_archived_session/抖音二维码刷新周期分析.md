# æŠ–éŸ³äºŒç»´ç åˆ·æ–°å‘¨æœŸåˆ†ææŠ¥å‘Š

**åˆ†ææ—¥æœŸ**: 2025-10-20
**ç³»ç»Ÿ**: HisCRM-IM
**å¹³å°**: æŠ–éŸ³ (Douyin)

## ğŸ“Š å½“å‰å®ç°çš„äºŒç»´ç åˆ·æ–°å‚æ•°

### æ ¸å¿ƒæ—¶é—´é…ç½®

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| **QR_CODE_LIFETIME** | 150,000 ms | **äºŒç»´ç æœ‰æ•ˆæœŸï¼š2åˆ†30ç§’ï¼ˆ150ç§’ï¼‰** |
| **LOGIN_CHECK_INTERVAL** | 2,000 ms | è½®è¯¢ç™»å½•çŠ¶æ€çš„é—´éš”ï¼šæ¯2ç§’æ£€æŸ¥ä¸€æ¬¡ |
| **QR_CODE_TIMEOUT** | 30,000 ms | ç­‰å¾…äºŒç»´ç åŠ è½½çš„è¶…æ—¶ï¼š30ç§’ |
| **POPUP_WAIT_TIME** | 5,000 ms | ç­‰å¾…ç™»å½•æµ®å±‚å¼¹å‡ºçš„æ—¶é—´ï¼š5ç§’ |
| **LOGIN_TIMEOUT** | 300,000 ms | æ€»ä½“ç™»å½•è¶…æ—¶ï¼š5åˆ†é’Ÿ |
| **maxQRCodeRefreshes** | 3 | æœ€å¤šåˆ·æ–°äºŒç»´ç æ¬¡æ•°ï¼š3æ¬¡ |

**æºæ–‡ä»¶**: [packages/worker/src/browser/douyin-login-handler.js:32-36](packages/worker/src/browser/douyin-login-handler.js#L32-L36)

---

## ğŸ”„ äºŒç»´ç åˆ·æ–°æµç¨‹

### 1. **ç™»å½•æµç¨‹å¯åŠ¨**
```
å¼€å§‹ç™»å½• â†’ å¯¼èˆªåˆ°é¦–é¡µ â†’ ç­‰å¾…ç™»å½•æµ®å±‚(5ç§’) â†’ ç­‰å¾…äºŒç»´ç åŠ è½½
â†’ æå–äºŒç»´ç (Base64) â†’ å¼€å§‹è½®è¯¢ç™»å½•çŠ¶æ€
```

### 2. **è½®è¯¢ç™»å½•çŠ¶æ€**ï¼ˆæ¯2ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
è½®è¯¢å‡½æ•°: `startLoginStatusPolling()` [line 458](packages/worker/src/browser/douyin-login-handler.js#L458)

```javascript
const pollInterval = setInterval(async () => {
  // 1. æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
  const isLoggedIn = await this.checkLoginStatus(session.page);

  if (isLoggedIn) {
    // ç™»å½•æˆåŠŸï¼Œåœæ­¢è½®è¯¢
    return;
  }

  // 2. æ£€æŸ¥äºŒç»´ç æ˜¯å¦è¿‡æœŸ
  if (qrCodeAge > this.QR_CODE_LIFETIME) {  // è¶…è¿‡ 150ç§’
    if (refreshCount < 3) {
      // 3. åˆ·æ–°äºŒç»´ç ï¼ˆé‡æ–°åŠ è½½é¡µé¢ï¼‰
      await this.refreshQRCode(accountId, sessionId);
    } else {
      // è¾¾åˆ°æœ€å¤§åˆ·æ–°æ¬¡æ•°ï¼Œç™»å½•å¤±è´¥
      throw new Error('QR code refresh limit exceeded');
    }
  }
}, this.LOGIN_CHECK_INTERVAL);  // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
```

### 3. **äºŒç»´ç åˆ·æ–°çš„å…·ä½“æ­¥éª¤**
`refreshQRCode()` å‡½æ•° [line 389](packages/worker/src/browser/douyin-login-handler.js#L389):

1. **é‡æ–°åŠ è½½é¡µé¢** - `page.reload()`
2. **ç­‰å¾…ç™»å½•æµ®å±‚** - ç­‰å¾…5ç§’
3. **ç­‰å¾…æ–°äºŒç»´ç åŠ è½½** - æœ€å¤š30ç§’
4. **æå–æ–°äºŒç»´ç ** - Base64ç¼–ç æˆªå›¾
5. **æ›´æ–°ä¼šè¯ä¿¡æ¯** - é‡ç½®è®¡æ—¶å™¨ (`qrCodeGeneratedAt = Date.now()`)
6. **é€šçŸ¥Master** - å‘é€æ–°äºŒç»´ç 

---

## ğŸ“ˆ äºŒç»´ç ç”Ÿå‘½å‘¨æœŸæ—¶é—´è½´

```
t = 0ç§’        äºŒç»´ç ç”Ÿæˆ
â†“ (+150ç§’)
t = 150ç§’      â° äºŒç»´ç è¿‡æœŸ (ç¬¬1ä¸ªäºŒç»´ç å¤±æ•ˆ)
              â””â†’ è‡ªåŠ¨è§¦å‘ refreshQRCode()
              â””â†’ é¡µé¢é‡æ–°åŠ è½½
              â””â†’ æ–°äºŒç»´ç ç”Ÿæˆ
â†“ (+150ç§’)
t = 300ç§’      â° ç¬¬2ä¸ªäºŒç»´ç è¿‡æœŸ
              â””â†’ è‡ªåŠ¨è§¦å‘ refreshQRCode()
              â””â†’ é¡µé¢é‡æ–°åŠ è½½
              â””â†’ æ–°äºŒç»´ç ç”Ÿæˆ
â†“ (+150ç§’)
t = 450ç§’      â° ç¬¬3ä¸ªäºŒç»´ç è¿‡æœŸ
              â””â†’ è‡ªåŠ¨è§¦å‘ refreshQRCode()
              â””â†’ é¡µé¢é‡æ–°åŠ è½½
              â””â†’ æ–°äºŒç»´ç ç”Ÿæˆ
â†“ (+150ç§’)
t = 600ç§’      â° è¾¾åˆ°æœ€å¤§åˆ·æ–°æ¬¡æ•° (3æ¬¡)
              â””â†’ âŒ ç™»å½•å¤±è´¥ - "QR code refresh limit exceeded"
```

**æ€»ä½“æœ€é•¿ç™»å½•æ—¶é—´**: **~600ç§’ (10åˆ†é’Ÿ)** = 4ä¸ªäºŒç»´ç å‘¨æœŸ

---

## ğŸ” æŠ–éŸ³çœŸå®è¡Œä¸º vs å½“å‰å®ç°

### é—®é¢˜è¯Šæ–­

ä½ æåˆ°"äºŒç»´ç åˆ·æ–°æ—¶é—´ä¸æŠ–éŸ³çœŸå®çš„ä¸åŒ"ï¼Œè¿™å¯èƒ½æœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š

| æƒ…å†µ | å½“å‰å®ç° | æŠ–éŸ³çœŸå® | å½±å“ |
|------|---------|---------|------|
| **åˆ·æ–°é¢‘ç‡** | 150ç§’åˆ·æ–°ä¸€æ¬¡ | â“ éœ€è¦éªŒè¯ | å¦‚æœæŠ–éŸ³åˆ·æ–°æ›´å¿«ï¼Œç”¨æˆ·ä½“éªŒä¼šå·® |
| **æ£€æŸ¥é—´éš”** | æ¯2ç§’æ£€æŸ¥ | â“ éœ€è¦éªŒè¯ | å¦‚æœä¸åŒï¼Œå¯èƒ½å¯¼è‡´æ¼æ‰è¿‡æœŸæç¤º |
| **æœ€å¤šåˆ·æ–°æ¬¡æ•°** | 3æ¬¡ | â“ éœ€è¦éªŒè¯ | å¦‚æœæŠ–éŸ³å…è®¸æ›´å¤š/æ›´å°‘åˆ·æ–° |

### éœ€è¦éªŒè¯çš„å…·ä½“æ•°æ®

è¦å‡†ç¡®è·çŸ¥æŠ–éŸ³çš„çœŸå®äºŒç»´ç åˆ·æ–°å‘¨æœŸï¼Œéœ€è¦ï¼š

1. **è§‚å¯Ÿç½‘ç»œè¯·æ±‚** - æŸ¥çœ‹å‰ç«¯æ¯æ¬¡åˆ·æ–°äºŒç»´ç æ—¶çš„APIè°ƒç”¨
2. **æ£€æŸ¥è¿‡æœŸæç¤º** - é¡µé¢ä¸Šæ˜¯å¦æœ‰"äºŒç»´ç å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°"çš„æç¤ºåŠå…¶è§¦å‘æ—¶é—´
3. **åˆ†æJavaScriptä»£ç ** - æŠ–éŸ³å‰ç«¯çš„äºŒç»´ç ç®¡ç†é€»è¾‘
4. **æŠ“åŒ…åˆ†æ** - ç›‘æ§äºŒç»´ç ç›¸å…³çš„ç½‘ç»œæµé‡

---

## ğŸ› ï¸ å¦‚ä½•è·å–çœŸå®çš„æŠ–éŸ³äºŒç»´ç åˆ·æ–°å‘¨æœŸ

### æ–¹æ³•1: æµè§ˆå™¨DevToolsè§‚å¯Ÿ

1. æ‰“å¼€ https://www.douyin.com/login
2. æ‰“å¼€DevTools â†’ Networkæ ‡ç­¾
3. è¿‡æ»¤åŒ…å«"qrcode"ã€"login"çš„è¯·æ±‚
4. è§‚å¯Ÿå¹¶è®°å½•ä»¥ä¸‹æ—¶é—´ç‚¹ï¼š
   - ç¬¬ä¸€ä¸ªäºŒç»´ç å‡ºç°çš„æ—¶é—´
   - äºŒç»´ç å˜åŒ–ï¼ˆåˆ·æ–°ï¼‰çš„æ—¶é—´é—´éš”
   - è¿‡æœŸæç¤ºå‡ºç°çš„æ—¶é—´
   - æ–°äºŒç»´ç ç”Ÿæˆçš„æ—¶é—´

### æ–¹æ³•2: æµè§ˆå™¨Consoleç›‘æ§

```javascript
// åœ¨DevTools Consoleä¸­æ‰§è¡Œä»¥ä¸‹ä»£ç 

// ç›‘æ§äºŒç»´ç å…ƒç´ å˜åŒ–
const qrImg = document.querySelector('img[alt="äºŒç»´ç "]');
let lastSrc = qrImg?.src;
let refreshTimes = [];
let startTime = Date.now();

const observer = new MutationObserver(() => {
  const newSrc = qrImg?.src;
  if (newSrc !== lastSrc) {
    lastSrc = newSrc;
    const elapsed = (Date.now() - startTime) / 1000;
    refreshTimes.push(elapsed);
    console.log(`ğŸ”„ QR Code Refreshed at ${elapsed}s`);
    console.log('Refresh intervals (seconds):',
      refreshTimes.slice(1).map((t, i) => t - refreshTimes[i]).filter(v => v > 1));
  }
});

observer.observe(document.body, {
  subtree: true,
  attributes: true,
  attributeFilter: ['src']
});

// æ¯10ç§’æ‰“å°ä¸€æ¬¡ç»Ÿè®¡ä¿¡æ¯
setInterval(() => {
  console.log(`â±ï¸  Elapsed: ${((Date.now() - startTime) / 1000).toFixed(1)}s`);
  console.log(`ğŸ“Š Refresh count: ${refreshTimes.length}`);
  if (refreshTimes.length > 1) {
    const intervals = refreshTimes.slice(1).map((t, i) => t - refreshTimes[i]).filter(v => v > 1);
    console.log(`ğŸ“ˆ Average interval: ${(intervals.reduce((a, b) => a + b, 0) / intervals.length).toFixed(1)}s`);
  }
}, 10000);
```

### æ–¹æ³•3: Playwrightè‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬

åˆ›å»ºè„šæœ¬ `packages/worker/scripts/monitor-douyin-qr-refresh.js`:

```javascript
const { chromium } = require('playwright');

async function monitorQRRefresh() {
  const browser = await chromium.launch({ headless: false });
  const page = await browser.newPage();

  const refreshLog = [];
  let lastQRCode = null;
  let startTime = Date.now();

  // ç›‘æ§æ‰€æœ‰å“åº”ä¸­çš„äºŒç»´ç æ•°æ®
  page.on('response', response => {
    const url = response.url();
    if (url.includes('qrcode') || url.includes('login')) {
      const elapsed = (Date.now() - startTime) / 1000;
      console.log(`[${elapsed.toFixed(1)}s] Response: ${url}`);
      refreshLog.push({ timestamp: elapsed, url });
    }
  });

  // ç›‘æ§DOMå˜åŒ–
  await page.goto('https://www.douyin.com/login');

  await page.evaluate(() => {
    const qrImg = document.querySelector('img[alt="äºŒç»´ç "]');
    if (!qrImg) return;

    let lastSrc = qrImg.src;
    let refreshCount = 0;
    let startTime = Date.now();

    const checkInterval = setInterval(() => {
      const newSrc = qrImg?.src;
      if (newSrc && newSrc !== lastSrc) {
        lastSrc = newSrc;
        refreshCount++;
        const elapsed = (Date.now() - startTime) / 1000;
        console.log(`ğŸ”„ QR Refresh #${refreshCount} at ${elapsed.toFixed(1)}s`);
      }
    }, 1000);

    // ç›‘å¬é¡µé¢å…³é—­
    window.addEventListener('beforeunload', () => {
      clearInterval(checkInterval);
    });
  });

  // ä¿æŒé¡µé¢å¼€æ”¾30åˆ†é’Ÿä»¥è§‚å¯Ÿå¤šä¸ªåˆ·æ–°å‘¨æœŸ
  await page.waitForTimeout(30 * 60 * 1000);
  await browser.close();
}

monitorQRRefresh().catch(console.error);
```

è¿è¡Œæ–¹å¼:
```bash
cd packages/worker
node scripts/monitor-douyin-qr-refresh.js
```

---

## ğŸ“ å½“å‰ä»£ç çš„å…³é”®ä½ç½®

| åŠŸèƒ½ | æ–‡ä»¶ | è¡Œå· |
|------|------|------|
| æ—¶é—´é…ç½® | `douyin-login-handler.js` | [32-36](packages/worker/src/browser/douyin-login-handler.js#L32-L36) |
| äºŒç»´ç åˆ·æ–°é€»è¾‘ | `douyin-login-handler.js` | [389-431](packages/worker/src/browser/douyin-login-handler.js#L389-L431) |
| è½®è¯¢ç™»å½•çŠ¶æ€ | `douyin-login-handler.js` | [458-530](packages/worker/src/browser/douyin-login-handler.js#L458-L530) |
| ç™»å½•çŠ¶æ€æ£€æŸ¥ | `douyin-login-handler.js` | [537-583](packages/worker/src/browser/douyin-login-handler.js#L537-L583) |

---

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

1. **è¿è¡Œç›‘æ§è„šæœ¬** - ä½¿ç”¨æ–¹æ³•3ä¸­çš„è„šæœ¬åœ¨çœŸå®æŠ–éŸ³ä¸Šè§‚å¯ŸäºŒç»´ç åˆ·æ–°å‘¨æœŸ
2. **å¯¹æ¯”æ•°æ®** - å°†å®é™…è§‚å¯Ÿæ•°æ®ä¸å½“å‰å®ç°çš„150ç§’å¯¹æ¯”
3. **è°ƒæ•´å‚æ•°** - å¦‚æœå‘ç°ä¸ç¬¦ï¼Œä¿®æ”¹ `QR_CODE_LIFETIME` å€¼
4. **æµ‹è¯•éªŒè¯** - ä¿®æ”¹åè¿›è¡Œç™»å½•æµ‹è¯•ï¼Œç¡®ä¿åŠŸèƒ½æ­£å¸¸

---

## ğŸ“ ç›¸å…³é—®é¢˜æ’æŸ¥

**Q: ä¸ºä»€ä¹ˆç”¨æˆ·åæ˜ äºŒç»´ç åˆ·æ–°å¤ªå¿«/å¤ªæ…¢?**
- æ£€æŸ¥ `QR_CODE_LIFETIME` çš„å€¼æ˜¯å¦åˆç†
- æ£€æŸ¥æµè§ˆå™¨çš„ç³»ç»Ÿæ—¶é—´æ˜¯å¦å‡†ç¡®
- æŸ¥çœ‹æ—¥å¿—ä¸­ "QR code expired" çš„æ—¶é—´é—´éš”

**Q: å¦‚ä½•ç¦ç”¨è‡ªåŠ¨åˆ·æ–°?**
ä¿®æ”¹ [douyin-login-handler.js:484](packages/worker/src/browser/douyin-login-handler.js#L484):
```javascript
// æ”¹ä¸º
if (qrCodeAge > this.QR_CODE_LIFETIME * 999) { // ç¦ç”¨åˆ·æ–°
```

**Q: å¦‚ä½•å¢åŠ æœ€å¤§åˆ·æ–°æ¬¡æ•°?**
ä¿®æ”¹ [douyin-login-handler.js:69](packages/worker/src/browser/douyin-login-handler.js#L69):
```javascript
maxQRCodeRefreshes: 5, // æ”¹ä¸º5æ¬¡
```

