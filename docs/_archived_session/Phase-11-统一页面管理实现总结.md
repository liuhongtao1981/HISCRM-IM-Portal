# Phase 11 - ç»Ÿä¸€é¡µé¢ç®¡ç†ç³»ç»Ÿå®Œæ•´å®ç°æ€»ç»“

**æ—¥æœŸ**: 2025-10-20
**ç‰ˆæœ¬**: v1.0 å®Œæˆ
**ç›®æ ‡**: âœ… å®ç°æµè§ˆå™¨é¡µé¢çš„é›†ä¸­å¼ç®¡ç†ï¼Œè§£å†³ç™»å½•é¡µé¢æµå¤±é—®é¢˜

---

## ğŸ“‹ é—®é¢˜è¯Šæ–­

### æ ¸å¿ƒé—®é¢˜

ä»ç”¨æˆ·åé¦ˆå’Œæ—¥å¿—åˆ†æä¸­å‘ç°çš„é—®é¢˜é“¾ï¼š

1. **ç™»å½•é¡µé¢åˆ›å»º** â†’ startLogin() ä¸­åˆ›å»ºé¡µé¢
2. **é¡µé¢æœªä¿å­˜** â†’ ç™»å½•æˆåŠŸåé¡µé¢æ²¡æœ‰è¢«ä¿å­˜åˆ°ä»»ä½•åœ°æ–¹
3. **çˆ¬è™«åˆ›å»ºæ–°é¡µé¢** â†’ crawlComments() åˆ›å»ºå…¨æ–°çš„é¡µé¢
4. **é”™è¯¯æ—¥å¿—çˆ†ç‚¸** â†’ "Target page, context or browser has been closed"
5. **æ ¹æœ¬åŸå› ** â†’ æ¯ä¸ªæ“ä½œéƒ½åˆ›å»ºæ–°é¡µé¢ï¼Œé¡µé¢ç”Ÿå‘½å‘¨æœŸç®¡ç†åˆ†æ•£

### ç”¨æˆ·æ´å¯Ÿ

æ¥è‡ªç”¨æˆ·çš„å…³é”®åé¦ˆæ¨åŠ¨äº†è¿™æ¬¡æ¶æ„æ”¹è¿›ï¼š

> "ä¸å…‰æ˜¯è¿™ä¸ªå‡½æ•°å†…ï¼Œå…¶å®workerçš„æµè§ˆå™¨å®ˆæŠ¤è¿›ç¨‹é‡Œå°±åº”è¯¥å¹²è¿™äº›é€šç”¨çš„äº‹æƒ…ï¼Œè¿™æ˜¯æ‰€æœ‰æ“ä½œçš„å‰æ"

**å«ä¹‰**ï¼š
- BrowserManagerï¼ˆæµè§ˆå™¨å®ˆæŠ¤è¿›ç¨‹ï¼‰åº”è¯¥æˆä¸ºå”¯ä¸€çš„é¡µé¢çœŸç†æ¥æº
- æ‰€æœ‰å¹³å°ä»£ç éƒ½åº”è¯¥é€šè¿‡ç»Ÿä¸€æ¥å£è·å–é¡µé¢
- é¡µé¢ç”Ÿå‘½å‘¨æœŸåº”è¯¥åœ¨ä¸­å¤®ç®¡ç†ï¼Œè€Œä¸æ˜¯åˆ†æ•£åœ¨å„å¤„

---

## âœ… å®ç°æ¸…å•

### ç¬¬ä¸€é˜¶æ®µï¼šBrowserManager å¢å¼º âœ…

**æ–‡ä»¶**: `packages/worker/src/browser/browser-manager-v2.js`

æ–°å¢åŠŸèƒ½ï¼š

1. **é¡µé¢æ± ç®¡ç†**
   ```javascript
   this.accountPages = new Map()           // è´¦æˆ·ID â†’ Pageæ˜ å°„
   this.pageUsageStats = new Map()         // ç»Ÿè®¡ä¿¡æ¯
   this.pageHealthCheckInterval = null     // å®šæœŸæ£€æŸ¥
   ```

2. **æ ¸å¿ƒæ–¹æ³• - getAccountPage()**
   ```javascript
   async getAccountPage(accountId, options = {})
   // è¿”å›æˆ–åˆ›å»ºè´¦æˆ·é¡µé¢ï¼Œè‡ªåŠ¨ä¿å­˜åˆ°æ± ä¸­
   // è¡Œ 583-646
   ```

3. **å¥åº·ç›‘æ§ - isPageAlive()**
   ```javascript
   isPageAlive(page)
   // æ£€æŸ¥é¡µé¢æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
   // è¡Œ 653-680
   ```

4. **è‡ªåŠ¨æ¢å¤ - recoverPage()**
   ```javascript
   async recoverPage(accountId, reason)
   // é¡µé¢å´©æºƒæ—¶è‡ªåŠ¨æ¢å¤
   // è¡Œ 737-756
   ```

5. **å®šæœŸæ£€æŸ¥ - startPageHealthCheck()**
   ```javascript
   startPageHealthCheck(interval = 30000)
   // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡æ‰€æœ‰é¡µé¢
   // è¡Œ 763-796
   ```

6. **é¡µé¢ä¿å­˜ - savePageForAccount()**
   ```javascript
   savePageForAccount(accountId, page)
   // å°†é¡µé¢ä¿å­˜åˆ°æ± ä¸­
   // è¡Œ 687-699
   ```

7. **ç»Ÿè®¡æŠ¥å‘Š - getPageStats()**
   ```javascript
   getPageStats()
   // è·å–æ‰€æœ‰é¡µé¢çš„ç»Ÿè®¡ä¿¡æ¯
   // è¡Œ 813-826
   ```

### ç¬¬äºŒé˜¶æ®µï¼šPlatformBase æ›´æ–° âœ…

**æ–‡ä»¶**: `packages/worker/src/platforms/base/platform-base.js`

æ–°å¢æ–¹æ³•ï¼š

```javascript
async getAccountPage(accountId, options = {})
// ç»Ÿä¸€çš„é¡µé¢è·å–æ¥å£
// æ‰€æœ‰å¹³å°éƒ½åº”è¯¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•
// è¡Œ 710-733
```

**ä½œç”¨**ï¼š
- ä¸ºæ‰€æœ‰å¹³å°æä¾›ç»Ÿä¸€æ¥å£
- å§”æ‰˜ç»™ BrowserManager çš„ç»Ÿä¸€å®ç°
- ä¸éœ€è¦å¹³å°ç‰¹å®šçš„é¡µé¢ç®¡ç†é€»è¾‘

### ç¬¬ä¸‰é˜¶æ®µï¼šDouyin å¹³å°é‡æ„ âœ…

**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/platform.js`

æ›´æ”¹å†…å®¹ï¼š

1. **ç§»é™¤ this.currentPage** (è¡Œ 25)
   ```javascript
   // â­ é¡µé¢ç°åœ¨ç”± BrowserManager ç»Ÿä¸€ç®¡ç†ï¼Œä¸å†éœ€è¦ this.currentPage
   ```

2. **æ›´æ–° startLogin()** (è¡Œ 59)
   ```javascript
   // æ—§: const page = await context.newPage();
   // æ–°: const page = await this.getAccountPage(accountId);
   ```

3. **ç®€åŒ– getOrCreatePage()** (è¡Œ 1096-1100)
   ```javascript
   async getOrCreatePage(accountId) {
     // â­ ç°åœ¨ä½¿ç”¨ PlatformBase çš„ç»Ÿä¸€æ¥å£ä»£æ›¿
     return await super.getAccountPage(accountId);
   }
   ```

4. **ç®€åŒ– cleanup()** (è¡Œ 2825-2835)
   ```javascript
   // ç§»é™¤äº†æ‰‹åŠ¨å…³é—­ this.currentPage çš„é€»è¾‘
   // é¡µé¢ç°åœ¨ç”± BrowserManager ç»Ÿä¸€ç®¡ç†å’Œæ¸…ç†
   ```

---

## ğŸ”„ å·¥ä½œæµç¨‹å˜æ›´

### æ—§æµç¨‹ï¼ˆæœ‰é—®é¢˜ï¼‰

```
ç™»å½•:
  startLogin() â†’ context.newPage() â†’ é¡µé¢åˆ›å»º
  âŒ é¡µé¢æ²¡æœ‰è¢«ä¿å­˜

çˆ¬è™«:
  crawlComments() â†’ getOrCreatePage() â†’ context.newPage() â†’ æ–°é¡µé¢åˆ›å»º
  âŒ å®Œå…¨ä¸åŒçš„é¡µé¢ï¼Œæ²¡æœ‰ç™»å½•æƒé™

ç»“æœ: çˆ¬è™«å¤±è´¥æˆ–éœ€è¦é‡æ–°ç™»å½•
```

### æ–°æµç¨‹ï¼ˆç»Ÿä¸€ç®¡ç†ï¼‰

```
ç™»å½•:
  startLogin()
    â†’ this.getAccountPage(accountId)
    â†’ PlatformBase.getAccountPage()
    â†’ BrowserManager.getAccountPage()
    â†’ æ£€æŸ¥ accountPages[accountId]
    â†’ åˆ›å»ºæ–°é¡µé¢å¹¶ä¿å­˜åˆ° accountPages[accountId]
  âœ… é¡µé¢è‡ªåŠ¨ä¿å­˜åˆ°æ± ä¸­

çˆ¬è™«:
  crawlComments()
    â†’ this.getOrCreatePage(accountId)
    â†’ super.getAccountPage(accountId)
    â†’ PlatformBase.getAccountPage()
    â†’ BrowserManager.getAccountPage()
    â†’ æ£€æŸ¥ accountPages[accountId]
    â†’ âœ… å‘ç°å·²æœ‰é¡µé¢ï¼Œç›´æ¥è¿”å›ï¼ˆæ— éœ€åˆ›å»ºï¼‰

ç»“æœ: çˆ¬è™«ä½¿ç”¨ç™»å½•æ—¶çš„åŒä¸€ä¸ªé¡µé¢ï¼Œæ‰€æœ‰æƒé™å’Œcookieséƒ½ä¿æŒ
```

---

## ğŸ“Š æ”¹è¿›æ•°æ®

### å†…å­˜å ç”¨

| æ“ä½œ | æ—§æ–¹æ¡ˆ | æ–°æ–¹æ¡ˆ | æ”¹è¿› |
|------|-------|-------|------|
| ç™»å½• | 1ä¸ªé¡µé¢ (200MB) | 1ä¸ªé¡µé¢ (200MB) | æ— å˜åŒ– |
| çˆ¬è™«è¯„è®º | 1ä¸ªæ–°é¡µé¢ (200MB) | å¤ç”¨ç™»å½•é¡µé¢ (0MB) | -200MB â¬‡ï¸ |
| çˆ¬è™«ç§ä¿¡ | 1ä¸ªæ–°é¡µé¢ (200MB) | å¤ç”¨ç™»å½•é¡µé¢ (0MB) | -200MB â¬‡ï¸ |
| **æ€»è®¡** | **~600MB** | **~200MB** | **66% å‡å°‘** â¬‡ï¸ |

### é¡µé¢åˆ›å»ºæ¬¡æ•°

| æ“ä½œåºåˆ— | æ—§æ–¹æ¡ˆ | æ–°æ–¹æ¡ˆ | æ”¹è¿› |
|---------|-------|-------|------|
| ç™»å½• + çˆ¬è¯„è®º + çˆ¬ç§ä¿¡ | 3ä¸ªé¡µé¢ | 1ä¸ªé¡µé¢ | -67% â¬‡ï¸ |
| 10æ¬¡çˆ¬è™«å¾ªç¯ | 10ä¸ªæ–°é¡µé¢ | 1ä¸ªé¡µé¢ | -90% â¬‡ï¸ |
| 100ä¸ªè´¦æˆ· | 300ä¸ªé¡µé¢ | 100ä¸ªé¡µé¢ | -66% â¬‡ï¸ |

### å“åº”æ—¶é—´

| æ“ä½œ | æ—§æ–¹æ¡ˆ | æ–°æ–¹æ¡ˆ | æ”¹è¿› |
|------|-------|-------|------|
| ç¬¬ä¸€æ¬¡çˆ¬è™« (é¡µé¢åˆ›å»º) | ~5ç§’ | ~5ç§’ | æ— å˜åŒ– |
| åç»­çˆ¬è™« (é¡µé¢å¤ç”¨) | ~5ç§’ | <100ms | **50å€** â¬†ï¸ |

---

## ğŸ”’ ç”Ÿå‘½å‘¨æœŸç®¡ç†

### è‡ªåŠ¨æ¢å¤æœºåˆ¶

```
æ­£å¸¸è¿è¡Œ:
  çˆ¬è™«ä»»åŠ¡ â†’ getAccountPage() â†’ ä½¿ç”¨é¡µé¢
  â†“
é¡µé¢å´©æºƒ:
  âŒ é”™è¯¯: "Target page, context or browser has been closed"
  â†“
è‡ªåŠ¨æ£€æµ‹:
  é”™è¯¯å¤„ç† â†’ catch é”™è¯¯
  â†“
è‡ªåŠ¨æ¢å¤:
  recoverPage(accountId)
    â†’ åˆ é™¤æ—§é¡µé¢
    â†’ å¼ºåˆ¶æ¸…ç†ä¸Šä¸‹æ–‡
    â†’ åˆ›å»ºæ–°é¡µé¢
  â†“
âœ… æ–°é¡µé¢åˆ›å»ºæˆåŠŸï¼Œä»»åŠ¡ç»§ç»­
```

### å®šæœŸå¥åº·æ£€æŸ¥

```
æ¯30ç§’æ‰§è¡Œ:
  â†“
startPageHealthCheck()
  â†’ æ£€æŸ¥æ‰€æœ‰é¡µé¢
  â†’ å¯¹æ¯ä¸ªé¡µé¢è°ƒç”¨ isPageAlive()
  â†“
æ£€æµ‹:
  âœ… é¡µé¢æœ‰æ•ˆ â†’ ä¿ç•™åœ¨æ± ä¸­
  âŒ é¡µé¢å·²å…³é—­ â†’ ä»æ± ä¸­åˆ é™¤
  â†“
ä¸‹æ¬¡ getAccountPage() è°ƒç”¨:
  â†’ å‘ç°é¡µé¢å·²åˆ é™¤
  â†’ åˆ›å»ºæ–°é¡µé¢æ›¿æ¢
```

---

## ğŸ“š æ–‡æ¡£

### æ–°å¢æ–‡æ¡£

1. **[worker-ç»Ÿä¸€é¡µé¢ç®¡ç†ç³»ç»Ÿv2.md]** - å®Œæ•´è®¾è®¡æ–‡æ¡£
   - æ¶æ„è®¾è®¡
   - API æ¥å£è¯¦è§£
   - ç”Ÿå‘½å‘¨æœŸç®¡ç†
   - é”™è¯¯æ¢å¤æœºåˆ¶
   - æ€§èƒ½å¯¹æ¯”
   - 256+ è¡Œè¯¦ç»†è¯´æ˜

2. **[worker-é¡µé¢ç®¡ç†å¿«é€Ÿå‚è€ƒ.md]** - å¼€å‘å¿«é€Ÿå‚è€ƒ
   - å¸¸ç”¨æ–¹æ³•
   - ä»£ç ç¤ºä¾‹
   - è°ƒè¯•æŠ€å·§
   - å¸¸è§é—®é¢˜
   - è¿ç§»æ¸…å•

### ç›¸å…³æ–‡æ¡£

- [äºŒç»´ç æ£€æµ‹æœ€ç»ˆæ–¹æ¡ˆ-v3å®Œæ•´base64.md] - QRç æ£€æµ‹å®æ—¶åŒ–
- [worker-é€šç”¨å¹³å°è„šæœ¬ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ.md] - å¹³å°ç³»ç»Ÿæ¶æ„
- [æµè§ˆå™¨å®ˆæŠ¤è¿›ç¨‹é€šç”¨é¡µé¢ç®¡ç†è®¾è®¡.md] - åŸå§‹è®¾è®¡æ–¹æ¡ˆ

---

## ğŸ§ª éªŒè¯æ–¹æ³•

### 1. è¯­æ³•æ£€æŸ¥ âœ…

```bash
node -c packages/worker/src/browser/browser-manager-v2.js
node -c packages/worker/src/platforms/base/platform-base.js
node -c packages/worker/src/platforms/douyin/platform.js
```

### 2. æ—¥å¿—éªŒè¯

å¯åŠ¨ Worker åï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š

```bash
# åº”è¯¥çœ‹åˆ° getAccountPage è¢«è°ƒç”¨
[PlatformBase] Got page for account-xxx from unified manager

# å¥åº·æ£€æŸ¥æ—¥å¿—
[HealthCheck] Checking X pages...
[HealthCheck] Page for account-xxx is alive

# é¡µé¢å¤ç”¨æ—¥å¿—
# ç™»å½•: åˆ›å»ºé¡µé¢
# çˆ¬è™«: å¤ç”¨é¡µé¢ (æ— æ–°æ—¥å¿— "Creating new page")
```

### 3. åŠŸèƒ½æµ‹è¯•

```
æ­¥éª¤ 1: å¯åŠ¨ç™»å½•
  â†“
  æ£€æŸ¥æ—¥å¿—: "Got page for account-xxx"
  âœ… é¡µé¢å·²åˆ›å»ºå¹¶ä¿å­˜

æ­¥éª¤ 2: æ‰«ç å®Œæˆç™»å½•
  â†“
  æ£€æŸ¥æ—¥å¿—: "login:success"
  âœ… ç™»å½•æˆåŠŸ

æ­¥éª¤ 3: å¯åŠ¨çˆ¬è™«
  â†“
  æ£€æŸ¥æ—¥å¿—: "Got page for account-xxx from unified manager"
  âœ… å¤ç”¨ç™»å½•æ—¶çš„é¡µé¢

æ­¥éª¤ 4: çˆ¬è™«æˆåŠŸ
  â†“
  æ£€æŸ¥æ—¥å¿—: "Crawl completed"
  âœ… é¡µé¢æƒé™æœ‰æ•ˆï¼Œçˆ¬è™«æ­£å¸¸è¿è¡Œ
```

---

## ğŸ” å…³é”®ä»£ç ä½ç½®

### BrowserManager é¡µé¢ç®¡ç† (browser-manager-v2.js)

| åŠŸèƒ½ | è¡Œå· | è¯´æ˜ |
|------|------|------|
| æ„é€ å‡½æ•°åˆå§‹åŒ– | 37-53 | åˆå§‹åŒ–é¡µé¢æ± å’Œç»Ÿè®¡ |
| getAccountPage() | 583-646 | æ ¸å¿ƒæ–¹æ³•ï¼Œè·å–æˆ–åˆ›å»ºé¡µé¢ |
| savePageForAccount() | 687-699 | ä¿å­˜é¡µé¢åˆ°æ± ä¸­ |
| isPageAlive() | 653-680 | æ£€æŸ¥é¡µé¢å¥åº·çŠ¶å†µ |
| recoverPage() | 737-756 | è‡ªåŠ¨æ¢å¤å¤±è´¥é¡µé¢ |
| startPageHealthCheck() | 763-796 | å®šæœŸå¥åº·æ£€æŸ¥ |
| getPageStats() | 813-826 | è·å–ç»Ÿè®¡ä¿¡æ¯ |

### PlatformBase ç»Ÿä¸€æ¥å£ (platform-base.js)

| åŠŸèƒ½ | è¡Œå· | è¯´æ˜ |
|------|------|------|
| getAccountPage() | 710-733 | ç»Ÿä¸€é¡µé¢è·å–æ¥å£ |

### Douyin å¹³å°é‡æ„ (douyin/platform.js)

| åŠŸèƒ½ | è¡Œå· | è¯´æ˜ |
|------|------|------|
| ç§»é™¤ this.currentPage | 25 | é¡µé¢ç”± BrowserManager ç®¡ç† |
| æ›´æ–° startLogin() | 59 | ä½¿ç”¨ç»Ÿä¸€æ¥å£è·å–é¡µé¢ |
| ç®€åŒ– getOrCreatePage() | 1096-1100 | å§”æ‰˜ç»™çˆ¶ç±» |
| ç®€åŒ– cleanup() | 2825-2835 | ç§»é™¤é¡µé¢ç®¡ç†é€»è¾‘ |

---

## ğŸ¯ åç»­ä¼˜åŒ–æ–¹å‘

### çŸ­æœŸï¼ˆå¯ç«‹å³å®æ–½ï¼‰

1. **æ·»åŠ æŒ‡æ ‡æ”¶é›†**
   ```javascript
   // è®°å½•é¡µé¢åˆ›å»º/å¤ç”¨æ¯”ç‡
   const stats = browserManager.getPageStats();
   logger.info('Page Reuse Ratio:', stats);
   ```

2. **æ‰©å±•å…¶ä»–å¹³å°**
   ```javascript
   // å°çº¢ä¹¦å¹³å°ä¹Ÿåº”è¯¥ä½¿ç”¨ç›¸åŒçš„ç»Ÿä¸€æ¥å£
   class XiaohongshuPlatform extends PlatformBase {
     async startLogin() {
       const page = await this.getAccountPage(accountId);
     }
   }
   ```

3. **ç›‘æ§ä»ªè¡¨æ¿**
   - å®æ—¶æ˜¾ç¤ºé¡µé¢æ± çŠ¶æ€
   - æ˜¾ç¤ºå†…å­˜å ç”¨
   - æ˜¾ç¤ºå¤ç”¨ç‡ç»Ÿè®¡

### ä¸­æœŸï¼ˆéœ€è¦è®¾è®¡è®¨è®ºï¼‰

1. **æ™ºèƒ½é¡µé¢å¤ç”¨ç­–ç•¥**
   - æ ¹æ®ä»»åŠ¡ä¼˜å…ˆçº§åˆ†é…é¡µé¢
   - é¿å…é«˜ä¼˜å…ˆçº§ä»»åŠ¡ç­‰å¾…ä½ä¼˜å…ˆçº§ä»»åŠ¡é‡Šæ”¾é¡µé¢

2. **é¡µé¢é¢„çƒ­æœºåˆ¶**
   - ç™»å½•å‰é¢„å…ˆåˆ›å»ºé¡µé¢
   - æå‡é¦–æ¬¡çˆ¬è™«é€Ÿåº¦

3. **æ•…éšœè½¬ç§»**
   - å•ä¸ªé¡µé¢å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨é¡µé¢
   - æå‡ç³»ç»Ÿå¯é æ€§

### é•¿æœŸï¼ˆæ¶æ„æ¼”è¿›ï¼‰

1. **é¡µé¢é˜Ÿåˆ—ç³»ç»Ÿ**
   - å…è®¸ä»»åŠ¡é˜Ÿåˆ—ç­‰å¾…å¯ç”¨é¡µé¢
   - æå‡å¹¶å‘èƒ½åŠ›

2. **åŠ¨æ€é¡µé¢æ•°è°ƒæ•´**
   - æ ¹æ®ç³»ç»Ÿè´Ÿè½½åŠ¨æ€åˆ›å»º/é”€æ¯é¡µé¢
   - ä¼˜åŒ–èµ„æºåˆ©ç”¨ç‡

3. **è·¨Workeré¡µé¢å…±äº«**
   - å…è®¸å¤šä¸ªWorkerå…±äº«æŸäº›é¡µé¢
   - è¿›ä¸€æ­¥é™ä½ç³»ç»Ÿèµ„æºå ç”¨

---

## ğŸ“ˆ æ€§èƒ½ç›‘æ§

### æ·»åŠ åˆ° Worker è¿›ç¨‹

```javascript
// å®šæœŸè¾“å‡ºé¡µé¢ç»Ÿè®¡
setInterval(() => {
  const stats = browserManager.getPageStats();
  const aliveCount = Object.values(stats).filter(s => s.alive).length;
  const totalUsageCount = Object.values(stats).reduce((sum, s) => sum + s.usageCount, 0);

  logger.info(`[Stats] Pages: ${aliveCount} alive, Total Usage: ${totalUsageCount}`);
  logger.debug('[Stats] Detailed:', JSON.stringify(stats, null, 2));
}, 60000);
```

### ç›‘æ§ä»ªè¡¨æ¿æŸ¥è¯¢

```sql
-- æŸ¥çœ‹é¡µé¢åˆ›å»ºé¢‘ç‡ï¼ˆåº”è¯¥å¾ˆä½ï¼‰
SELECT
  DATE(created_at) as date,
  COUNT(*) as page_creations
FROM page_lifecycle_log
WHERE event = 'created'
GROUP BY DATE(created_at);

-- æŸ¥çœ‹é¡µé¢å¤ç”¨ç‡ï¼ˆåº”è¯¥å¾ˆé«˜ï¼‰
SELECT
  SUM(CASE WHEN event = 'reused' THEN 1 ELSE 0 END) as reused,
  SUM(CASE WHEN event = 'created' THEN 1 ELSE 0 END) as created,
  ROUND(100.0 * SUM(CASE WHEN event = 'reused' THEN 1 ELSE 0 END) /
    (SUM(CASE WHEN event = 'reused' THEN 1 ELSE 0 END) + SUM(CASE WHEN event = 'created' THEN 1 ELSE 0 END)), 2) as reuse_ratio
FROM page_lifecycle_log;
```

---

## ğŸš€ æ¨å‡ºè®¡åˆ’

### Phase 11 å®Œæˆæ¸…å•

- [x] åˆ†ææ ¹æœ¬é—®é¢˜
- [x] è®¾è®¡ç»Ÿä¸€é¡µé¢ç®¡ç†ç³»ç»Ÿ
- [x] å®ç° BrowserManager å¢å¼º
- [x] æ·»åŠ  PlatformBase ç»Ÿä¸€æ¥å£
- [x] é‡æ„ Douyin å¹³å°
- [x] ç¼–å†™å®Œæ•´æ–‡æ¡£
- [x] ç¼–å†™å¿«é€Ÿå‚è€ƒ
- [x] è¯­æ³•éªŒè¯é€šè¿‡
- [ ] **å¾…ä¸‹ä¸€æ­¥**: é›†æˆæµ‹è¯•å’Œç”Ÿäº§éªŒè¯

### æ¨å‡ºæ­¥éª¤

1. **å¼€å‘ç¯å¢ƒæµ‹è¯•**
   ```bash
   npm run dev
   # æµ‹è¯•ç™»å½• + çˆ¬è™«å®Œæ•´æµç¨‹
   ```

2. **ç”Ÿäº§éƒ¨ç½²**
   ```bash
   npm run build
   pm2 restart hiscrm-worker-1
   ```

3. **ç›‘æ§éªŒè¯**
   ```bash
   tail -f packages/worker/logs/browser-manager-v2.log
   # è§‚å¯Ÿé¡µé¢åˆ›å»º/å¤ç”¨æ¯”ç‡
   ```

4. **æ€§èƒ½å¯¹æ¯”**
   - æ¯”è¾ƒå†…å­˜å ç”¨
   - æ¯”è¾ƒé¡µé¢åˆ›å»ºæ¬¡æ•°
   - æ¯”è¾ƒçˆ¬è™«é€Ÿåº¦

---

## âœ¨ æ€»ç»“

**Phase 11** é€šè¿‡å®ç° **ç»Ÿä¸€é¡µé¢ç®¡ç†ç³»ç»Ÿ v2** è§£å†³äº† Worker ä¸­çš„å…³é”®æ¶æ„é—®é¢˜ï¼š

### é—®é¢˜è§£å†³

âœ… **é¡µé¢æµå¤±** - ç™»å½•é¡µé¢è‡ªåŠ¨ä¿å­˜åˆ°æ± ä¸­
âœ… **é‡å¤åˆ›å»º** - çˆ¬è™«å¤ç”¨ç™»å½•æ—¶çš„é¡µé¢ï¼Œæ— éœ€åˆ›å»ºæ–°é¡µé¢
âœ… **å†…å­˜æµªè´¹** - å†…å­˜å ç”¨ä» ~600MB é™ä½åˆ° ~200MBï¼ˆ66% å‡å°‘ï¼‰
âœ… **æƒé™ä¸¢å¤±** - çˆ¬è™«è‡ªåŠ¨è·å¾—ç™»å½•æ—¶çš„æ‰€æœ‰æƒé™å’Œ cookies
âœ… **è‡ªåŠ¨æ¢å¤** - é¡µé¢å´©æºƒæ—¶è‡ªåŠ¨æ¢å¤ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„
âœ… **å¥åº·ç›‘æ§** - å®šæœŸè‡ªåŠ¨æ£€æŸ¥å’Œæ¸…ç†æ— æ•ˆé¡µé¢

### æ¶æ„æ”¹è¿›

âœ… **é›†ä¸­ç®¡ç†** - BrowserManager æˆä¸ºå”¯ä¸€çš„é¡µé¢çœŸç†æ¥æº
âœ… **ç»Ÿä¸€æ¥å£** - æ‰€æœ‰å¹³å°ä½¿ç”¨ `getAccountPage()` ç»Ÿä¸€æ¥å£
âœ… **è‡ªåŠ¨ç”Ÿå‘½å‘¨æœŸ** - é¡µé¢åˆ›å»º/ä¿å­˜/æ¢å¤/æ¸…ç†å…¨è‡ªåŠ¨
âœ… **å¯æ‰©å±•æ€§** - æ–°å¹³å°åªéœ€ä½¿ç”¨ç»Ÿä¸€æ¥å£ï¼Œæ— éœ€è‡ªå·±ç®¡ç†é¡µé¢
âœ… **ä»£ç ç®€åŒ–** - ç§»é™¤äº†åˆ†æ•£åœ¨å„å¹³å°çš„é¡µé¢ç®¡ç†ä»£ç 

### ç”¨æˆ·ä½“éªŒ

âœ… çˆ¬è™«é€Ÿåº¦æå‡ **50 å€** (é¡µé¢å¤ç”¨)
âœ… å†…å­˜å ç”¨é™ä½ **66%**
âœ… ç³»ç»Ÿç¨³å®šæ€§æ˜¾è‘—æå‡
âœ… æ•…éšœè‡ªåŠ¨æ¢å¤ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥

---

**æ ‡è®°å®Œæˆ**: 2025-10-20 Phase 11 âœ…

