# è¯„è®ºå›å¤/è®¨è®ºç»“æ„åˆ†ææŠ¥å‘Š

**è°ƒæŸ¥æ—¶é—´**: 2025-10-24 21:35
**è°ƒæŸ¥å¯¹è±¡**: æŠ–éŸ³åˆ›ä½œè€…ä¸­å¿ƒ - è¯„è®ºç®¡ç†é¡µé¢
**è°ƒæŸ¥ç›®çš„**: åˆ†æè¯„è®ºä¸­çš„"è®¨è®º"(å›å¤çº¿ç¨‹)ç»“æ„ï¼Œç¡®è®¤æ˜¯å¦æ­£ç¡®æŠ“å–

---

## ä¸€ã€é¡µé¢ç»“æ„åˆ†æ

### 1.1 è¯„è®ºç®¡ç†é¡µé¢ URL

```
https://creator.douyin.com/creator-micro/data/following/comment
```

**æ³¨æ„**: éœ€è¦é€šè¿‡å¯¼èˆªèœå•è¿›å…¥ï¼Œç›´æ¥è·³è½¬ URL å¯èƒ½å¤±è´¥ã€‚

æ­£ç¡®å¯¼èˆªè·¯å¾„ï¼š
```
äº’åŠ¨ç®¡ç† â†’ è¯„è®ºç®¡ç† â†’ é€‰æ‹©ä½œå“ â†’ é€‰æ‹©æœ‰è¯„è®ºçš„è§†é¢‘
```

### 1.2 è¯„è®ºåˆ—è¡¨ç»“æ„

```yaml
# é¡¶å±‚è¯„è®ºå®¹å™¨
- generic [è¯„è®ºåˆ—è¡¨å®¹å™¨]:
  - generic [è¯„è®º1]:
    - checkbox [é€‰æ‹©æ¡†]
    - listitem [å¤´åƒ]
    - generic [è¯„è®ºå†…å®¹åŒº]:
      - generic [ç”¨æˆ·å]
      - generic [å‘å¸ƒæ—¶é—´]
      - generic [è¯„è®ºæ–‡æœ¬å†…å®¹]
      - generic [æ“ä½œæŒ‰é’®åŒº]:
        - generic [ç‚¹èµæ•°æŒ‰é’®]: "12"  # â­ è¿™æ˜¯ç‚¹èµæ•°ï¼Œä¸æ˜¯å›å¤æ•°ï¼
        - img [ç‚¹èµå›¾æ ‡]
        - generic [å›å¤æŒ‰é’®]: "å›å¤"
        - generic [åˆ é™¤æŒ‰é’®]: "åˆ é™¤"
        - generic [ä¸¾æŠ¥æŒ‰é’®]: "ä¸¾æŠ¥"
    - generic [æŸ¥çœ‹å›å¤æŒ‰é’®]:  # â­ è¿™æ‰æ˜¯å›å¤/è®¨è®ºçš„å…¥å£ï¼
      - text: "æŸ¥çœ‹3æ¡å›å¤"
      - img [å±•å¼€å›¾æ ‡]
```

### 1.3 å±•å¼€å›å¤åçš„ç»“æ„

```yaml
- generic [ä¸»è¯„è®º]:
  - [ä¸»è¯„è®ºåŸºæœ¬ä¿¡æ¯...åŒä¸Š]
  - generic [å›å¤å®¹å™¨]:  # â­ å±•å¼€åå‡ºç°
    - generic [å›å¤1]:
      - checkbox [é€‰æ‹©æ¡†]
      - listitem [å¤´åƒ]
      - generic [å›å¤å†…å®¹åŒº]:
        - generic [ç”¨æˆ·å]: "æœ¨â€¦æ˜“"
        - generic [å‘å¸ƒæ—¶é—´]: "10æœˆ06æ—¥ 17:12"
        - generic [å›å¤æ–‡æœ¬]:
          - text: "å¾·è€åŒ»é™¢"
        - generic [æ“ä½œæŒ‰é’®åŒº]: [åŒä¸»è¯„è®ºç»“æ„]

    - generic [å›å¤2]:
      - generic [ç”¨æˆ·å]: "ç¡•æœç´¯ç´¯"
      - generic [å‘å¸ƒæ—¶é—´]: "10æœˆ06æ—¥ 20:26"
      - generic [å›å¤æ–‡æœ¬]:
        - generic: "å›å¤æœ¨â€¦æ˜“:"  # â­ æ ‡è®°å›å¤å¯¹è±¡
        - text: "æ˜¯ç§ç«‹åŒ»é™¢å§ï¼Ÿ"
        - generic [æ“ä½œæŒ‰é’®åŒº]

    - generic [å›å¤3]:
      - generic [ç”¨æˆ·å]: "æœ¨â€¦æ˜“"
      - generic [æ—¶é—´]: "10æœˆ07æ—¥ 01:22"
      - generic [å›å¤æ–‡æœ¬]:
        - generic: "å›å¤ç¡•æœç´¯ç´¯:"  # â­ æ ‡è®°å›å¤å¯¹è±¡
        - text: "å¯¹ï¼Œæˆ‘çˆ¶äº²å°±æ˜¯åœ¨é‚£èµ°çš„"
        - generic [æ“ä½œæŒ‰é’®åŒº]

    - generic [æ”¶èµ·æŒ‰é’®]:  # â­ å±•å¼€åï¼Œ"æŸ¥çœ‹Xæ¡å›å¤"å˜æˆ"æ”¶èµ·"
      - text: "æ”¶èµ·"
      - img [æ”¶èµ·å›¾æ ‡]
```

---

## äºŒã€å…³é”®å‘ç°

### 2.1 å›å¤/è®¨è®ºçš„è¯†åˆ«æ–¹å¼

| å…ƒç´  | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **è¯„è®ºæ—çš„æ•°å­—** | ç‚¹èµæ•°ï¼Œä¸æ˜¯å›å¤æ•°ï¼ | `"12"`, `"4"`, `"0"` |
| **"æŸ¥çœ‹Xæ¡å›å¤"æŒ‰é’®** | çœŸæ­£çš„å›å¤/è®¨è®ºå…¥å£ | `"æŸ¥çœ‹3æ¡å›å¤"`, `"æŸ¥çœ‹8æ¡å›å¤"` |
| **å›å¤å®¹å™¨** | ç‚¹å‡»åå±•å¼€ï¼ŒåŒ…å«æ‰€æœ‰å›å¤ | `generic [ref=e1978]` |
| **å›å¤å‰ç¼€** | äºŒçº§åŠä»¥ä¸Šå›å¤å¸¦æœ‰ `"å›å¤XXX:"` | `"å›å¤æœ¨â€¦æ˜“:"` |

### 2.2 å›å¤å±‚çº§å…³ç³»

```
ä¸»è¯„è®º (ä¸€çº§)
  â”œâ”€ å›å¤1 (äºŒçº§) - ç›´æ¥å›å¤ä¸»è¯„è®º
  â”œâ”€ å›å¤2 (äºŒçº§) - "å›å¤XXX:" è¡¨ç¤ºå›å¤çš„æ˜¯å›å¤1
  â””â”€ å›å¤3 (äºŒçº§) - "å›å¤XXX:" è¡¨ç¤ºå›å¤çš„æ˜¯å›å¤2
```

**æ³¨æ„**: æŠ–éŸ³çš„å›å¤ç»“æ„æ˜¯**æ‰å¹³åŒ–**çš„ï¼Œæ‰€æœ‰å›å¤éƒ½åœ¨åŒä¸€å±‚çº§ï¼Œé€šè¿‡ `"å›å¤XXX:"` å‰ç¼€æ¥æ ‡è¯†å›å¤å…³ç³»ã€‚

### 2.3 å±•å¼€/æ”¶èµ·æœºåˆ¶

```
åˆå§‹çŠ¶æ€: [æŸ¥çœ‹3æ¡å›å¤] â–¼
   â†“ ç‚¹å‡»
å±•å¼€çŠ¶æ€:
   [å›å¤1]
   [å›å¤2]
   [å›å¤3]
   [æ”¶èµ·] â–²
```

---

## ä¸‰ã€DOM é€‰æ‹©å™¨åˆ†æ

### 3.1 ä¸»è¯„è®ºåˆ—è¡¨é€‰æ‹©å™¨

```javascript
// è¯„è®ºåˆ—è¡¨å®¹å™¨
const commentList = document.querySelector('[role="tabpanel"] > div > div:nth-child(3)');

// æ‰€æœ‰ä¸»è¯„è®º
const mainComments = commentList.querySelectorAll(':scope > div');

// æ¯ä¸ªä¸»è¯„è®ºçš„ç»“æ„
mainComments.forEach(comment => {
  const checkbox = comment.querySelector('[type="checkbox"]');
  const avatar = comment.querySelector('[role="listitem"] img');
  const username = comment.querySelector('generic:nth-child(3) > generic:nth-child(1)');
  const time = comment.querySelector('generic:nth-child(3) > generic:nth-child(2)');
  const content = comment.querySelector('generic:nth-child(3) > generic:nth-child(3)');

  // â­ ç‚¹èµæ•° (ä¸æ˜¯å›å¤æ•°ï¼)
  const likeCount = comment.querySelector('generic:nth-child(3) > generic:nth-last-child(2) > generic:first-child');

  // â­ æŸ¥çœ‹å›å¤æŒ‰é’®
  const viewRepliesButton = comment.querySelector('generic:last-child');
  if (viewRepliesButton && viewRepliesButton.textContent.includes('æŸ¥çœ‹')) {
    const replyCount = parseInt(viewRepliesButton.textContent.match(/\d+/)[0]);
    console.log(`è¯¥è¯„è®ºæœ‰ ${replyCount} æ¡å›å¤`);
  }
});
```

### 3.2 å›å¤åˆ—è¡¨é€‰æ‹©å™¨

```javascript
// ä¸»è¯„è®ºä¸‹çš„å›å¤å®¹å™¨ (å±•å¼€åå‡ºç°)
const repliesContainer = comment.querySelector('generic:nth-child(3) > div');

if (repliesContainer) {
  // æ‰€æœ‰å›å¤
  const replies = repliesContainer.querySelectorAll(':scope > div:not(:last-child)');

  replies.forEach(reply => {
    const username = reply.querySelector('generic:nth-child(3) > generic:nth-child(1)');
    const time = reply.querySelector('generic:nth-child(3) > generic:nth-child(2)');
    const contentDiv = reply.querySelector('generic:nth-child(3) > generic:nth-child(3)');

    // æ£€æŸ¥æ˜¯å¦æœ‰ "å›å¤XXX:" å‰ç¼€
    const replyToPrefix = contentDiv.querySelector('generic:first-child');
    const replyToUser = replyToPrefix ? replyToPrefix.textContent.replace('å›å¤', '').replace(':', '') : null;

    // å›å¤å†…å®¹ (å»é™¤ "å›å¤XXX:" å‰ç¼€)
    const replyText = Array.from(contentDiv.childNodes)
      .filter(node => node.nodeType === Node.TEXT_NODE)
      .map(node => node.textContent.trim())
      .join('');

    console.log({
      username: username.textContent,
      time: time.textContent,
      replyTo: replyToUser,
      content: replyText
    });
  });
}
```

---

## å››ã€API æ‹¦æˆªåˆ†æ

### 4.1 å¯èƒ½çš„ API ç«¯ç‚¹

æ ¹æ®é¡µé¢è¡Œä¸ºæ¨æµ‹ï¼Œå¯èƒ½å­˜åœ¨ä»¥ä¸‹ APIï¼š

```
1. è·å–è¯„è®ºåˆ—è¡¨:
   GET /api/comment/list?aweme_id=xxx&count=20

2. è·å–æŸæ¡è¯„è®ºçš„å›å¤:
   GET /api/comment/reply/list?comment_id=xxx&count=20

3. ç‚¹èµè¯„è®º:
   POST /api/comment/digg

4. åˆ é™¤è¯„è®º:
   POST /api/comment/delete
```

**å»ºè®®**: ä½¿ç”¨ API æ‹¦æˆªæ¥è·å–å®Œæ•´çš„å›å¤æ•°æ®ï¼Œé¿å… DOM è§£æçš„å¤æ‚æ€§ã€‚

### 4.2 API æ‹¦æˆªå®ç°

```javascript
// åœ¨ crawl-comments.js ä¸­æ·»åŠ  API æ‹¦æˆª
async function setupAPIInterceptors(page) {
  await page.route('**/api/comment/**', async (route) => {
    const url = route.request().url();
    const response = await route.fetch();
    const json = await response.json();

    if (url.includes('/reply/list')) {
      // ä¿å­˜å›å¤æ•°æ®
      apiResponses.replies = apiResponses.replies || [];
      apiResponses.replies.push(json);
    }

    await route.continue();
  });
}
```

---

## äº”ã€å½“å‰çˆ¬è™«å®ç°æ£€æŸ¥

### 5.1 æ£€æŸ¥ç°æœ‰ä»£ç 

éœ€è¦æ£€æŸ¥ä»¥ä¸‹æ–‡ä»¶æ˜¯å¦æ­£ç¡®å¤„ç†å›å¤/è®¨è®ºï¼š

```
packages/worker/src/platforms/douyin/crawl-comments.js
```

### 5.2 é¢„æœŸé—®é¢˜

æ ¹æ®ç§ä¿¡çˆ¬è™«çš„ç»éªŒï¼Œå¯èƒ½å­˜åœ¨çš„é—®é¢˜ï¼š

1. **åªæŠ“å–ä¸»è¯„è®ºï¼ŒæœªæŠ“å–å›å¤**
   - åªæå–äº†è¯„è®ºåˆ—è¡¨ï¼Œæœªç‚¹å‡»"æŸ¥çœ‹Xæ¡å›å¤"æŒ‰é’®
   - æ•°æ®åº“ä¸­æ²¡æœ‰å›å¤æ•°æ®

2. **æœªå»ºç«‹å›å¤å…³ç³»**
   - å³ä½¿æŠ“å–äº†å›å¤ï¼Œä¹Ÿæ²¡æœ‰è®°å½• `reply_to` å…³ç³»
   - æ— æ³•è¿˜åŸè¯„è®ºæ ‘ç»“æ„

3. **é€‰æ‹©å™¨é”™è¯¯**
   - å¯èƒ½å°†"ç‚¹èµæ•°"è¯¯è®¤ä¸º"å›å¤æ•°"
   - å¯¼è‡´å›å¤ç»Ÿè®¡ä¸å‡†ç¡®

### 5.3 æ•°æ®åº“è¡¨ç»“æ„æ£€æŸ¥

æ£€æŸ¥ `comments` è¡¨æ˜¯å¦æœ‰ä»¥ä¸‹å­—æ®µï¼š

```sql
-- ä¸»è¯„è®ºç›¸å…³
comment_id TEXT PRIMARY KEY,
parent_comment_id TEXT,  -- çˆ¶è¯„è®ºID (ä¸€çº§è¯„è®ºä¸ºNULL)
reply_to_user_id TEXT,   -- å›å¤çš„ç”¨æˆ·ID
reply_to_user_name TEXT, -- å›å¤çš„ç”¨æˆ·å
reply_count INTEGER,     -- å›å¤æ•°é‡
like_count INTEGER,      -- ç‚¹èµæ•°é‡

-- å¦‚æœç¼ºå°‘è¿™äº›å­—æ®µï¼Œéœ€è¦æ·»åŠ 
```

---

## å…­ã€çˆ¬è™«æ”¹è¿›æ–¹æ¡ˆ

### 6.1 æ–¹æ¡ˆA: DOM è§£æ (å½“å‰æ–¹æ¡ˆ)

**æ­¥éª¤**:

1. **æå–ä¸»è¯„è®ºåˆ—è¡¨**
   ```javascript
   const mainComments = await extractMainComments(page);
   ```

2. **éå†æ¯æ¡ä¸»è¯„è®º**
   ```javascript
   for (const comment of mainComments) {
     // æ£€æŸ¥æ˜¯å¦æœ‰å›å¤
     const viewRepliesButton = comment.querySelector('æŸ¥çœ‹Xæ¡å›å¤');

     if (viewRepliesButton) {
       // ç‚¹å‡»å±•å¼€å›å¤
       await viewRepliesButton.click();
       await page.waitForTimeout(1000);

       // æå–å›å¤åˆ—è¡¨
       const replies = await extractReplies(comment);

       // ä¿å­˜å›å¤æ•°æ®
       replies.forEach(reply => {
         reply.parent_comment_id = comment.comment_id;
         saveReply(reply);
       });

       // æ”¶èµ·å›å¤
       await comment.querySelector('æ”¶èµ·').click();
     }
   }
   ```

3. **è§£æå›å¤å…³ç³»**
   ```javascript
   function extractReplies(commentElement) {
     const repliesContainer = commentElement.querySelector('å›å¤å®¹å™¨');
     const replyElements = repliesContainer.querySelectorAll('å›å¤å…ƒç´ ');

     return Array.from(replyElements).map(elem => {
       const replyToPrefix = elem.querySelector('å›å¤XXX:');

       return {
         comment_id: generateId(),
         parent_comment_id: parentId,
         user_name: elem.querySelector('ç”¨æˆ·å').textContent,
         content: elem.querySelector('å†…å®¹').textContent,
         reply_to_user_name: replyToPrefix ? extractUsername(replyToPrefix) : null,
         created_at: parseTime(elem.querySelector('æ—¶é—´').textContent),
         like_count: parseInt(elem.querySelector('ç‚¹èµæ•°').textContent),
       };
     });
   }
   ```

**ä¼˜ç‚¹**:
- ä¸ä¾èµ– APIï¼Œæ›´ç¨³å®š
- å¯ä»¥å¤„ç†å„ç§è¾¹ç¼˜æƒ…å†µ

**ç¼ºç‚¹**:
- éœ€è¦é€ä¸ªå±•å¼€å›å¤ï¼Œé€Ÿåº¦æ…¢
- DOM ç»“æ„å˜åŒ–ä¼šå¯¼è‡´å¤±æ•ˆ
- é¡µé¢æ“ä½œå¤æ‚ï¼Œå®¹æ˜“å‡ºé”™

### 6.2 æ–¹æ¡ˆB: API æ‹¦æˆª (æ¨è â­)

**æ­¥éª¤**:

1. **è®¾ç½® API æ‹¦æˆªå™¨**
   ```javascript
   await page.route('**/api/comment/**', captureCommentAPI);
   ```

2. **è§¦å‘ API è°ƒç”¨**
   ```javascript
   // ç‚¹å‡»"æŸ¥çœ‹å›å¤"æŒ‰é’®ä¼šè§¦å‘ API è¯·æ±‚
   await viewRepliesButton.click();

   // ç­‰å¾… API å“åº”
   await page.waitForResponse(response =>
     response.url().includes('/reply/list')
   );
   ```

3. **ä» API å“åº”ä¸­æå–æ•°æ®**
   ```javascript
   const replyData = apiResponses.replies.find(r =>
     r.comment_id === parentCommentId
   );

   replyData.reply_list.forEach(reply => {
     saveReply({
       comment_id: reply.cid,
       parent_comment_id: parentCommentId,
       user_id: reply.user.uid,
       user_name: reply.user.nickname,
       content: reply.text,
       reply_to_user_id: reply.reply_to_userid,
       reply_to_user_name: reply.reply_to_username,
       created_at: reply.create_time * 1000,
       like_count: reply.digg_count,
     });
   });
   ```

**ä¼˜ç‚¹**:
- é€Ÿåº¦å¿«ï¼Œæ•°æ®å®Œæ•´
- ä¸å— DOM ç»“æ„å˜åŒ–å½±å“
- è·å–çš„æ•°æ®æ›´å‡†ç¡®ï¼ˆå« IDã€æ—¶é—´æˆ³ç­‰ï¼‰

**ç¼ºç‚¹**:
- ä¾èµ– API ç»“æ„ï¼ŒAPI å˜åŒ–ä¼šå¤±æ•ˆ
- éœ€è¦é€†å‘åˆ†æ API å‚æ•°

### 6.3 æ–¹æ¡ˆC: æ··åˆæ–¹æ¡ˆ (æœ€ç¨³å¥ â­â­â­)

ç»“åˆ DOM è§£æå’Œ API æ‹¦æˆªï¼š

```javascript
async function crawlCommentsWithReplies(page, videoId) {
  // 1. è®¾ç½® API æ‹¦æˆª
  const apiResponses = {};
  await setupAPIInterceptors(page, apiResponses);

  // 2. å¯¼èˆªåˆ°è¯„è®ºé¡µé¢
  await navigateToComments(page, videoId);

  // 3. è·å–ä¸»è¯„è®ºåˆ—è¡¨
  const mainComments = await extractMainComments(page);

  // 4. éå†ä¸»è¯„è®ºï¼Œå±•å¼€å›å¤
  for (const comment of mainComments) {
    const viewRepliesButton = await findViewRepliesButton(comment);

    if (viewRepliesButton) {
      // ç‚¹å‡»å±•å¼€ (ä¼šè§¦å‘ API è¯·æ±‚)
      await viewRepliesButton.click();
      await page.waitForTimeout(500);

      // ä¼˜å…ˆä½¿ç”¨ API æ•°æ®
      const apiReplies = apiResponses.replies?.[comment.comment_id];

      if (apiReplies) {
        // ä» API æå–å›å¤æ•°æ®
        saveRepliesFromAPI(apiReplies, comment.comment_id);
      } else {
        // é™çº§åˆ° DOM è§£æ
        const domReplies = await extractRepliesFromDOM(comment);
        saveRepliesFromDOM(domReplies, comment.comment_id);
      }

      // æ”¶èµ·å›å¤
      await clickCollapseButton(comment);
    }
  }

  return {
    comments: mainComments.length,
    replies: Object.values(apiResponses.replies).flat().length
  };
}
```

---

## ä¸ƒã€æµ‹è¯•è®¡åˆ’

### 7.1 æµ‹è¯•ç”¨ä¾‹

| æµ‹è¯•åœºæ™¯ | é¢„æœŸç»“æœ |
|---------|---------|
| è¯„è®ºæ— å›å¤ | ä¸å±•å¼€ï¼Œä¸æŠ“å– |
| è¯„è®ºæœ‰1æ¡å›å¤ | å±•å¼€ï¼ŒæŠ“å–1æ¡ |
| è¯„è®ºæœ‰å¤šæ¡å›å¤ (3-10æ¡) | å±•å¼€ï¼ŒæŠ“å–æ‰€æœ‰ |
| è¯„è®ºæœ‰å¤§é‡å›å¤ (>10æ¡) | å±•å¼€ï¼Œå¤„ç†åˆ†é¡µ |
| å›å¤ä¸­æœ‰"å›å¤XXX:" | æ­£ç¡®è§£æ reply_to |
| å›å¤ä¸­æœ‰è¡¨æƒ…ç¬¦å· | æ­£ç¡®ä¿å­˜ |
| å¤šå±‚åµŒå¥—å›å¤ | æ­£ç¡®å»ºç«‹æ ‘ç»“æ„ |

### 7.2 æµ‹è¯•è„šæœ¬

```javascript
// tests/æµ‹è¯•è¯„è®ºå›å¤æŠ“å–.js

const Database = require('better-sqlite3');
const path = require('path');

async function testCommentReplies() {
  console.log('ğŸ“‹ æµ‹è¯•è¯„è®ºå›å¤æŠ“å–åŠŸèƒ½\n');

  // 1. è¿æ¥æ•°æ®åº“
  const dbPath = path.join(__dirname, '../packages/master/data/master.db');
  const db = new Database(dbPath);

  // 2. æŸ¥è¯¢è¯„è®ºç»Ÿè®¡
  const stats = db.prepare(`
    SELECT
      COUNT(*) as total_comments,
      COUNT(CASE WHEN parent_comment_id IS NULL THEN 1 END) as main_comments,
      COUNT(CASE WHEN parent_comment_id IS NOT NULL THEN 1 END) as replies
    FROM comments
  `).get();

  console.log('ğŸ“Š è¯„è®ºç»Ÿè®¡:');
  console.log(`  æ€»è¯„è®ºæ•°: ${stats.total_comments}`);
  console.log(`  ä¸»è¯„è®ºæ•°: ${stats.main_comments}`);
  console.log(`  å›å¤æ•°: ${stats.replies}\n`);

  // 3. æ£€æŸ¥å›å¤å…³ç³»
  const repliesWithParent = db.prepare(`
    SELECT
      c1.content as reply_content,
      c1.reply_to_user_name,
      c2.content as parent_content
    FROM comments c1
    LEFT JOIN comments c2 ON c1.parent_comment_id = c2.comment_id
    WHERE c1.parent_comment_id IS NOT NULL
    LIMIT 5
  `).all();

  if (repliesWithParent.length > 0) {
    console.log('âœ… å›å¤å…³ç³»ç¤ºä¾‹:');
    repliesWithParent.forEach((r, i) => {
      console.log(`\n  ${i + 1}. å›å¤å†…å®¹: "${r.reply_content}"`);
      console.log(`     å›å¤å¯¹è±¡: ${r.reply_to_user_name}`);
      console.log(`     ä¸»è¯„è®º: "${r.parent_content}"`);
    });
  } else {
    console.log('âŒ æ•°æ®åº“ä¸­æ²¡æœ‰å›å¤æ•°æ®ï¼');
  }

  db.close();
}

testCommentReplies().catch(console.error);
```

---

## å…«ã€ç»“è®ºå’Œå»ºè®®

### 8.1 å½“å‰é—®é¢˜ç¡®è®¤

æ ¹æ®ç”¨æˆ·åé¦ˆ"è¯„è®ºé‡Œçš„è®¨è®ºæˆ‘ä»¬è²Œä¼¼æ²¡æœ‰æŠ“å–å›æ¥"ï¼Œç»è¿‡åˆ†æç¡®è®¤ï¼š

1. âœ… **å›å¤/è®¨è®ºç¡®å®å­˜åœ¨**
   - é€šè¿‡"æŸ¥çœ‹Xæ¡å›å¤"æŒ‰é’®å¯ä»¥å±•å¼€
   - æ¯æ¡ä¸»è¯„è®ºå¯èƒ½æœ‰å¤šæ¡å›å¤

2. âš ï¸ **å¯èƒ½çš„æŠ“å–é—®é¢˜**
   - å½“å‰çˆ¬è™«å¯èƒ½åªæŠ“å–äº†ä¸»è¯„è®º
   - æœªç‚¹å‡»"æŸ¥çœ‹å›å¤"æŒ‰é’®å±•å¼€å›å¤åˆ—è¡¨
   - æ•°æ®åº“ä¸­ç¼ºå°‘å›å¤æ•°æ®

### 8.2 ç«‹å³è¡ŒåŠ¨é¡¹

1. **æ£€æŸ¥ç°æœ‰ä»£ç **
   ```bash
   # æ£€æŸ¥ crawl-comments.js æ˜¯å¦å¤„ç†å›å¤
   grep -n "æŸ¥çœ‹.*å›å¤" packages/worker/src/platforms/douyin/crawl-comments.js
   grep -n "reply" packages/worker/src/platforms/douyin/crawl-comments.js
   ```

2. **æ£€æŸ¥æ•°æ®åº“**
   ```sql
   SELECT COUNT(*) FROM comments WHERE parent_comment_id IS NOT NULL;
   -- å¦‚æœç»“æœä¸º 0ï¼Œç¡®è®¤æ²¡æœ‰æŠ“å–å›å¤
   ```

3. **å®ç°å›å¤æŠ“å–åŠŸèƒ½**
   - å‚è€ƒæœ¬æŠ¥å‘Šç¬¬å…­ç« "çˆ¬è™«æ”¹è¿›æ–¹æ¡ˆ"
   - æ¨èä½¿ç”¨"æ–¹æ¡ˆC: æ··åˆæ–¹æ¡ˆ"

### 8.3 åç»­ä¼˜åŒ–

1. **æ•°æ®åº“ Schema ä¼˜åŒ–**
   ```sql
   ALTER TABLE comments ADD COLUMN reply_count INTEGER DEFAULT 0;
   ALTER TABLE comments ADD COLUMN like_count INTEGER DEFAULT 0;
   ALTER TABLE comments ADD COLUMN reply_to_user_id TEXT;
   ALTER TABLE comments ADD COLUMN reply_to_user_name TEXT;
   ```

2. **æ€§èƒ½ä¼˜åŒ–**
   - ä½¿ç”¨æ‰¹é‡æ’å…¥å‡å°‘æ•°æ®åº“æ“ä½œ
   - åªå±•å¼€æœ‰å›å¤çš„è¯„è®º
   - ä½¿ç”¨ API æ‹¦æˆªæé«˜é€Ÿåº¦

3. **ç›‘æ§å’Œæ—¥å¿—**
   ```javascript
   logger.info(`[Phase X] æŠ“å–è¯„è®º: ${mainComments.length} æ¡ä¸»è¯„è®º, ${totalReplies} æ¡å›å¤`);
   ```

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-24 21:40
**çŠ¶æ€**: âœ… åˆ†æå®Œæˆï¼Œç­‰å¾…å®ç°
**ä¸‹ä¸€æ­¥**: æ£€æŸ¥ç°æœ‰ä»£ç  â†’ å®ç°å›å¤æŠ“å–åŠŸèƒ½ â†’ æµ‹è¯•éªŒè¯
