# è™šæ‹Ÿåˆ—è¡¨è°ƒè¯•è¾“å‡º - ä»£ç ä¿®å¤å®Œæˆ

## æ—¶é—´: 2025-11-05 08:52

## é—®é¢˜å›é¡¾

ä¹‹å‰çš„è°ƒè¯•ä»£ç ä½¿ç”¨äº† `console.log`,è¿™ä¼šè¾“å‡ºåˆ°**æµè§ˆå™¨æ§åˆ¶å°**è€Œä¸æ˜¯ Node.js æ—¥å¿—æ–‡ä»¶,å¯¼è‡´æˆ‘ä»¬æ— æ³•åœ¨æ—¥å¿—ä¸­çœ‹åˆ°è™šæ‹Ÿåˆ—è¡¨çš„å­—æ®µä¿¡æ¯ã€‚

## ä¿®å¤æ–¹æ¡ˆ

é‡‡ç”¨**æ•°æ®å›ä¼ æ³•**: åœ¨ `page.evaluate()` å†…éƒ¨æ”¶é›†è°ƒè¯•ä¿¡æ¯,ç„¶åä½œä¸ºè¿”å›å€¼ä¼ å› Node.js,åœ¨ Node.js å±‚é¢è®°å½•åˆ°æ—¥å¿—æ–‡ä»¶ã€‚

### ä»£ç ä¿®æ”¹

**æ–‡ä»¶**: [`packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js`](../packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js)

#### ä¿®æ”¹ 1: å‡½æ•°ç­¾åå’Œå˜é‡å£°æ˜ (line 1114-1117)

```javascript
// æ—§ä»£ç 
return await page.evaluate(() => {
  const messages = [];
  let hasDebugPrinted = false;

// æ–°ä»£ç 
const { messages, debugInfo } = await page.evaluate(() => {
  const messages = [];
  let debugInfo = null; // ğŸ” è°ƒè¯•ä¿¡æ¯ï¼šå°†ä½œä¸ºè¿”å›å€¼ä¼ å›Node.js
  let hasDebugPrinted = false;
```

#### ä¿®æ”¹ 2: æ”¶é›†è°ƒè¯•ä¿¡æ¯è€Œä¸æ˜¯æ‰“å° (line 1191-1214)

```javascript
// æ—§ä»£ç  (console.log åœ¨æµè§ˆå™¨ä¸­)
if (!hasDebugPrinted) {
  hasDebugPrinted = true;
  console.log('ğŸ” [DEBUG] è™šæ‹Ÿåˆ—è¡¨ props å¯¹è±¡çš„æ‰€æœ‰å­—æ®µ:');
  console.log('æ‰€æœ‰é”®: ' + JSON.stringify(Object.keys(props)));
  const timeKeys = ...;
  console.log('æ—¶é—´ç›¸å…³å­—æ®µ:');
  timeKeys.forEach(key => {
    console.log(`  ${key}: ${props[key]} (type: ${typeof props[key]})`);
  });
  console.log('å®Œæ•´ props å¯¹è±¡: ' + JSON.stringify(props, null, 2).substring(0, 2000));
}

// æ–°ä»£ç  (æ”¶é›†åˆ° debugInfo å¯¹è±¡)
if (!hasDebugPrinted) {
  hasDebugPrinted = true;
  const allKeys = Object.keys(props);
  const timeKeys = allKeys.filter(k =>
    k.toLowerCase().includes('time') ||
    k.toLowerCase().includes('create') ||
    k.toLowerCase().includes('timestamp') ||
    k.toLowerCase().includes('date')
  );
  const timeFields = {};
  timeKeys.forEach(key => {
    timeFields[key] = {
      value: props[key],
      type: typeof props[key]
    };
  });
  debugInfo = {
    allKeys: allKeys,
    timeKeys: timeKeys,
    timeFields: timeFields,
    propsPreview: JSON.stringify(props, null, 2).substring(0, 2000)
  };
}
```

#### ä¿®æ”¹ 3: è¿”å›åŒ…å«è°ƒè¯•ä¿¡æ¯çš„å¯¹è±¡ (line 1433)

```javascript
// æ—§ä»£ç 
return deduped;

// æ–°ä»£ç 
return { messages: deduped, debugInfo: debugInfo };
```

#### ä¿®æ”¹ 4: è®°å½•è°ƒè¯•ä¿¡æ¯åˆ°æ—¥å¿— (line 1528-1541)

```javascript
// ğŸ” è®°å½•è°ƒè¯•ä¿¡æ¯åˆ°æ—¥å¿—
if (debugInfo) {
  logger.info('ğŸ” [DEBUG] è™šæ‹Ÿåˆ—è¡¨ props å¯¹è±¡è°ƒè¯•ä¿¡æ¯:');
  logger.info(`  æ‰€æœ‰é”® (${debugInfo.allKeys.length}ä¸ª): ${JSON.stringify(debugInfo.allKeys)}`);
  logger.info(`  æ—¶é—´ç›¸å…³å­—æ®µ (${debugInfo.timeKeys.length}ä¸ª): ${JSON.stringify(debugInfo.timeKeys)}`);
  logger.info('  æ—¶é—´å­—æ®µè¯¦æƒ…:');
  Object.entries(debugInfo.timeFields).forEach(([key, info]) => {
    logger.info(`    ${key}: ${info.value} (type: ${info.type})`);
  });
  logger.info('  Props å¯¹è±¡é¢„è§ˆ (å‰2000å­—ç¬¦):');
  logger.info(debugInfo.propsPreview);
}

return messages;
```

## å·¥ä½œåŸç†

### æµç¨‹å›¾

```
æµè§ˆå™¨ç¯å¢ƒ (page.evaluate)
â”œâ”€ 1. éå†è™šæ‹Ÿåˆ—è¡¨å…ƒç´ 
â”œâ”€ 2. æå– React Fiber props
â”œâ”€ 3. æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰æ•ˆ props æ—¶
â”‚   â””â”€ æ”¶é›†æ‰€æœ‰å­—æ®µåˆ° debugInfo å¯¹è±¡
â”œâ”€ 4. æå–æ‰€æœ‰æ¶ˆæ¯åˆ° messages æ•°ç»„
â””â”€ 5. è¿”å› { messages, debugInfo }
        â”‚
        â†“
Node.js ç¯å¢ƒ
â”œâ”€ 6. è§£æ„èµ‹å€¼: const { messages, debugInfo } = await page.evaluate(...)
â”œâ”€ 7. if (debugInfo) æ£€æŸ¥æ˜¯å¦æœ‰è°ƒè¯•ä¿¡æ¯
â”œâ”€ 8. logger.info() è®°å½•åˆ°æ—¥å¿—æ–‡ä»¶
â””â”€ 9. return messages
```

### å…³é”®æ”¹è¿›

1. **æµè§ˆå™¨åˆ° Node.js çš„æ•°æ®ä¼ é€’**: ä½¿ç”¨è¿”å›å€¼è€Œä¸æ˜¯ `console.log`
2. **æ—¥å¿—æ–‡ä»¶å¯è§**: è°ƒè¯•ä¿¡æ¯ç°åœ¨ä¼šå‡ºç°åœ¨ `packages/worker/logs/douyin-platform.log`
3. **ç»“æ„åŒ–æ•°æ®**: è°ƒè¯•ä¿¡æ¯ä»¥å¯¹è±¡å½¢å¼ä¼ é€’,ä¾¿äºå¤„ç†
4. **ä¸€æ¬¡æ€§æ”¶é›†**: åªæ”¶é›†ç¬¬ä¸€ä¸ªæœ‰æ•ˆ props å¯¹è±¡çš„ä¿¡æ¯,é¿å…é‡å¤

## è°ƒè¯•ä¿¡æ¯å†…å®¹

è°ƒè¯•è¾“å‡ºå°†åŒ…å«:

1. **æ‰€æœ‰é”®åˆ—è¡¨**: props å¯¹è±¡çš„æ‰€æœ‰å±æ€§å(æ•°ç»„)
2. **æ—¶é—´ç›¸å…³å­—æ®µåˆ—è¡¨**: åŒ…å« time/create/timestamp/date çš„å­—æ®µå
3. **æ—¶é—´å­—æ®µè¯¦æƒ…**: æ¯ä¸ªæ—¶é—´å­—æ®µçš„å€¼å’Œç±»å‹
4. **Props å¯¹è±¡é¢„è§ˆ**: å®Œæ•´ props å¯¹è±¡çš„ JSON å­—ç¬¦ä¸²(å‰2000å­—ç¬¦)

### ç¤ºä¾‹è¾“å‡º

```
ğŸ” [DEBUG] è™šæ‹Ÿåˆ—è¡¨ props å¯¹è±¡è°ƒè¯•ä¿¡æ¯:
  æ‰€æœ‰é”® (45ä¸ª): ["serverId","content","sender","conversationId","isFromMe","createdAt",...]
  æ—¶é—´ç›¸å…³å­—æ®µ (3ä¸ª): ["createdAt","timestamp","createTime"]
  æ—¶é—´å­—æ®µè¯¦æƒ…:
    createdAt: 1730708286000 (type: number)
    timestamp: 1730708286000 (type: number)
    createTime: 1730708286 (type: number)
  Props å¯¹è±¡é¢„è§ˆ (å‰2000å­—ç¬¦):
  {
    "serverId": "7568666231667689009",
    "content": { "text": "ä¸´ç»ˆå…³æ€€ï¼Œå¤šå°‘ä¸€å¤©ã€‚ç™Œç—‡æ™šæœŸ" },
    "sender": "71206683390",
    "conversationId": "0:1:3607962860399156:71206683390",
    "isFromMe": false,
    "createdAt": 1730708286000,
    "timestamp": 1730708286000,
    "createTime": 1730708286,
    ...
  }
```

## ä¸‹ä¸€æ­¥

1. **é‡å¯ Master å’Œ Worker**: è®©ä¿®æ”¹åçš„ä»£ç ç”Ÿæ•ˆ
2. **ç­‰å¾…ç§ä¿¡æŠ“å–**: ç­‰å¾…ä¸‹ä¸€æ¬¡æŠ“å–å‘¨æœŸ(æˆ–æ‰‹åŠ¨è§¦å‘)
3. **æŸ¥çœ‹æ—¥å¿—**: æ£€æŸ¥ `packages/worker/logs/douyin-platform.log` ä¸­çš„è°ƒè¯•è¾“å‡º
4. **åˆ†ææ—¶é—´å­—æ®µ**: ç¡®å®šæ­£ç¡®çš„æ—¶é—´æˆ³å­—æ®µå(å¯èƒ½æ˜¯ `createdAt`, `timestamp`, æˆ– `create_time`)
5. **æ›´æ–°ä»£ç **: æ ¹æ®å®é™…å­—æ®µåæ›´æ–°æ—¶é—´æˆ³æå–é€»è¾‘

## éªŒè¯æ­¥éª¤

```bash
# 1. é‡å¯ Master (å¦‚æœæ­£åœ¨è¿è¡Œ)
cd packages/master && npm start

# 2. ç­‰å¾… Worker è‡ªåŠ¨å¯åŠ¨å’ŒæŠ“å–

# 3. æŸ¥çœ‹è°ƒè¯•è¾“å‡º
tail -f packages/worker/logs/douyin-platform.log | grep -A 20 "DEBUG"

# æˆ–è€…æŸ¥çœ‹å®Œæ•´æ—¥å¿—
grep "ğŸ” \[DEBUG\]" packages/worker/logs/douyin-platform.log -A 20
```

## ç›¸å…³æ–‡æ¡£

- [è™šæ‹Ÿåˆ—è¡¨è°ƒè¯•ä»£ç ä¿®å¤æŠ¥å‘Š](./è™šæ‹Ÿåˆ—è¡¨è°ƒè¯•ä»£ç ä¿®å¤æŠ¥å‘Š.md) - ä¹‹å‰çš„ä¿®å¤(è°ƒè¯•æ¡ä»¶bug)
- [æ—¶é—´æˆ³é—®é¢˜æœ€ç»ˆå‘ç°](./æ—¶é—´æˆ³é—®é¢˜æœ€ç»ˆå‘ç°.md) - æ—¶é—´æˆ³é—®é¢˜åˆ†æ
- [ä»£ç æ–‡ä»¶](../packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js) - ä¿®æ”¹åçš„æºæ–‡ä»¶
