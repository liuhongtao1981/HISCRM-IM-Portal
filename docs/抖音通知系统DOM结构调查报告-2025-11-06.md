# æŠ–éŸ³é€šçŸ¥ç³»ç»Ÿ DOM ç»“æ„è°ƒæŸ¥æŠ¥å‘Š

**è°ƒæŸ¥æ—¥æœŸ**: 2025-11-06
**è°ƒæŸ¥ç›®æ ‡**: åˆ†ææŠ–éŸ³ Web ç«¯é€šçŸ¥ç³»ç»Ÿï¼ˆäº’åŠ¨æ¶ˆæ¯ï¼‰çš„ DOM ç»“æ„å’Œæ•°æ®æå–æ–¹æ³•
**æŠ€æœ¯æ ˆ**: React + React Fiber

---

## ä¸€ã€æ¦‚è¿°

æŠ–éŸ³ Web ç«¯çš„é€šçŸ¥ç³»ç»Ÿï¼ˆäº’åŠ¨æ¶ˆæ¯ï¼‰åŒ…å«ç‚¹èµã€è¯„è®ºã€å…³æ³¨ç­‰äº’åŠ¨é€šçŸ¥ã€‚ä¸ç§ä¿¡ç³»ç»Ÿç±»ä¼¼ï¼Œé€šçŸ¥æ•°æ®å­˜å‚¨åœ¨ React çŠ¶æ€ç®¡ç†å¯¹è±¡ `noticeStore` ä¸­ï¼Œå¯ä»¥é€šè¿‡ React Fiber ç›´æ¥æå–ï¼Œæ— éœ€ä¸ UI äº¤äº’ã€‚

### å…³é”®å‘ç°

1. **æ•°æ®æº**: `noticeStore` å¯¹è±¡ï¼ˆç±»ä¼¼ç§ä¿¡çš„ `imStore`ï¼‰
2. **è®¿é—®æ–¹å¼**: é€šè¿‡ React Fiber æ ‘éå†è·å–
3. **æ•°æ®å®Œæ•´æ€§**: åŒ…å«æ‰€æœ‰é€šçŸ¥æ•°æ®ã€ç”¨æˆ·ä¿¡æ¯ã€æœªè¯»è®¡æ•°
4. **æ— éœ€ UI äº¤äº’**: å¯ç›´æ¥ä» JavaScript æå–æ•°æ®ï¼Œä¸éœ€è¦è§¦å‘é€šçŸ¥é¢æ¿æ˜¾ç¤º

---

## äºŒã€noticeStore æ•°æ®ç»“æ„

### 2.1 noticeStore æ ¸å¿ƒå±æ€§

```javascript
noticeStore = {
  // åŸºç¡€çŠ¶æ€
  showNoticeDlg: true,              // é€šçŸ¥é¢æ¿æ˜¯å¦æ˜¾ç¤º
  isLogin: true,                    // æ˜¯å¦ç™»å½•
  uid: "2270953921061816",          // å½“å‰ç”¨æˆ· ID
  noticeLatestTime: 1762397820000,  // æœ€æ–°é€šçŸ¥æ—¶é—´æˆ³
  canShowNoticePush: false,         // æ˜¯å¦å¯æ˜¾ç¤ºæ¨é€é€šçŸ¥

  // é€šçŸ¥åˆ—è¡¨å¯¹è±¡
  noticeListObj: {
    noticeList: [],      // é€šçŸ¥æ•°ç»„
    minTime: 1757745149, // æœ€æ—©é€šçŸ¥æ—¶é—´
    maxTime: 1762307887, // æœ€æ–°é€šçŸ¥æ—¶é—´
    hasMore: 1,          // æ˜¯å¦æœ‰æ›´å¤šé€šçŸ¥ï¼ˆåˆ†é¡µï¼‰
    loading: false       // åŠ è½½çŠ¶æ€
  },

  // ç”¨æˆ·ä¿¡æ¯æ˜ å°„ï¼ˆUID -> ç”¨æˆ·å¯¹è±¡ï¼‰
  userListObj: {
    "ç”¨æˆ·UID": {
      uid: "...",
      short_id: "...",
      nickname: "...",
      avatar_thumb: { url_list: [...] },
      avatar_300: { url_list: [...] }
    }
  },

  // åˆ†ç»„æ˜ å°„ï¼ˆæŒ‰é€šçŸ¥ç±»å‹åˆ†ç»„ï¼‰
  noticeGroupMap: {
    "6": [],   // æŸç±»é€šçŸ¥
    "7": [],   // æŸç±»é€šçŸ¥
    "8": [],   // æŸç±»é€šçŸ¥
    // ...
  },

  // æœªè¯»è®¡æ•°ï¼ˆæŒ‰ç±»å‹ï¼‰
  noticeUnreadCountMap: {
    "7": 0,
    "8": 0,
    "9": 0,
    "10": 0,
    "26": 0,
    "-1": 0
  },

  // å…¶ä»–å±æ€§
  showNoticeTypeList: false,
  noticeListInsertNoticeId: "",
  followRecommendUserListObj: {},
  showUserList: false,
  showFollowRecommendUserList: false,
  curNoticeFilter: null,
  userListFilter: null,
  noticePushList: [],
  followStatusMap: {},
  abTestData: {}
}
```

### 2.2 å•æ¡é€šçŸ¥æ•°æ®ç»“æ„

æ¯æ¡é€šçŸ¥çš„å®Œæ•´ç»“æ„ï¼š

```javascript
{
  // åŸºç¡€ä¿¡æ¯
  nid: 7569468864996639793,        // é€šçŸ¥ IDï¼ˆæ•°å­—ï¼‰
  nid_str: "7569468864996639793",  // é€šçŸ¥ IDï¼ˆå­—ç¬¦ä¸²ï¼‰
  type: 41,                        // é€šçŸ¥ç±»å‹ï¼ˆ41=ç‚¹èµ, 31=è¯„è®º, 33=å…³æ³¨ï¼‰
  create_time: 1762404308,         // åˆ›å»ºæ—¶é—´æˆ³ï¼ˆç§’ï¼‰
  read_time: 1762404395,           // é˜…è¯»æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
  has_read: true,                  // æ˜¯å¦å·²è¯»

  aweme_id: "7550508912979774777", // å…³è”ä½œå“ ID
  user_id: 2270953921061816,       // ç”¨æˆ· IDï¼ˆå½“å‰ç”¨æˆ·ï¼‰
  item_disable: false,             // æ˜¯å¦ç¦ç”¨
  interactive_biz_id: 1004100,     // ä¸šåŠ¡ ID
  landing_group: 0,                // è½åœ°ç»„

  // ç±»å‹ç‰¹å®šæ•°æ®
  digg: {                          // ç‚¹èµé€šçŸ¥ï¼ˆtype=41ï¼‰
    count: 1,                      // ç‚¹èµæ•°
    user_id: "ç‚¹èµè€…UID",
    uid: "ç‚¹èµè€…UID",
    user: {                        // ç‚¹èµè€…ä¿¡æ¯ï¼ˆå¯èƒ½ä¸º nullï¼Œéœ€ä» userListObj è·å–ï¼‰
      uid: "...",
      short_id: "...",
      nickname: "...",
      avatar_thumb: { url_list: [...] }
    }
  },

  comment: {                       // è¯„è®ºé€šçŸ¥ï¼ˆtype=31ï¼‰
    cid: "è¯„è®ºID",
    text: "è¯„è®ºå†…å®¹",
    user_id: "è¯„è®ºè€…UID",
    user: { /* ç”¨æˆ·ä¿¡æ¯ */ }
  },

  follow: {                        // å…³æ³¨é€šçŸ¥ï¼ˆtype=33ï¼‰
    user_id: "å…³æ³¨è€…UID",
    user: { /* ç”¨æˆ·ä¿¡æ¯ */ }
  },

  general_notice: {                // é€šç”¨é€šçŸ¥æ¶ˆæ¯
    notice_msg: "é€šçŸ¥æ–‡æœ¬"
  }
}
```

### 2.3 é€šçŸ¥ç±»å‹æšä¸¾

```javascript
const NOTICE_TYPES = {
  31: 'comment',   // è¯„è®ºäº†ä½ çš„ä½œå“
  33: 'follow',    // å…³æ³¨äº†ä½ 
  41: 'digg',      // èµäº†ä½ çš„ä½œå“
  // å…¶ä»–ç±»å‹å¾…è¡¥å……...
};
```

---

## ä¸‰ã€æ•°æ®æå–æ–¹æ³•

### 3.1 è·å– noticeStore å¯¹è±¡

é€šè¿‡ React Fiber æ ‘éå†è·å– `noticeStore`ï¼š

```javascript
function getNoticeStore() {
  // æ–¹æ³•1: ä»ä»»æ„é€šçŸ¥å…ƒç´ è·å–
  const allDivs = Array.from(document.querySelectorAll('div'));
  const notificationItem = allDivs.find(el => {
    const text = el.textContent || '';
    return text.includes('èµäº†ä½ çš„ä½œå“') && text.length > 15 && text.length < 120;
  });

  if (!notificationItem) {
    return null;
  }

  const fiberKey = Object.keys(notificationItem).find(k => k.startsWith('__reactFiber'));
  if (!fiberKey) {
    return null;
  }

  let currentFiber = notificationItem[fiberKey];
  let depth = 0;

  // å‘ä¸Šéå† Fiber æ ‘æŸ¥æ‰¾ noticeStore
  while (currentFiber && depth < 30) {
    if (currentFiber.memoizedProps?.noticeStore) {
      return currentFiber.memoizedProps.noticeStore;
    }
    currentFiber = currentFiber.return;
    depth++;
  }

  return null;
}
```

### 3.2 æå–å®Œæ•´é€šçŸ¥åˆ—è¡¨ï¼ˆå«ç”¨æˆ·ä¿¡æ¯ï¼‰

```javascript
function extractAllNotifications() {
  const noticeStore = getNoticeStore();
  if (!noticeStore) {
    return { success: false, error: 'æœªæ‰¾åˆ° noticeStore' };
  }

  // 1. æå–ç”¨æˆ·ä¿¡æ¯æ˜ å°„
  const userMap = {};
  if (noticeStore.userListObj) {
    for (const uid in noticeStore.userListObj) {
      const user = noticeStore.userListObj[uid];
      userMap[uid] = {
        uid: user.uid,
        short_id: user.short_id,
        nickname: user.nickname,
        avatar_url: user.avatar_thumb?.url_list?.[0] || user.avatar_300?.url_list?.[0]
      };
    }
  }

  // 2. æå–é€šçŸ¥åˆ—è¡¨
  const noticeList = noticeStore.noticeListObj?.noticeList || [];

  // 3. å…³è”ç”¨æˆ·ä¿¡æ¯
  const fullNotifications = noticeList.map(notice => {
    const result = {
      nid: notice.nid_str || notice.nid,
      type: notice.type,
      create_time: notice.create_time,
      has_read: notice.has_read,
      aweme_id: notice.aweme_id,
      read_time: notice.read_time
    };

    // æ ¹æ®ç±»å‹æå–ç›¸åº”ä¿¡æ¯
    if (notice.type === 41 && notice.digg) {
      // ç‚¹èµé€šçŸ¥
      const diggUid = notice.digg.user_id || notice.digg.uid;
      result.action = 'digg';
      result.user = userMap[diggUid] || { uid: diggUid };
      result.digg_count = notice.digg.count;
    } else if (notice.type === 31 && notice.comment) {
      // è¯„è®ºé€šçŸ¥
      const commentUid = notice.comment.user_id || notice.comment.uid;
      result.action = 'comment';
      result.user = userMap[commentUid] || { uid: commentUid };
      result.comment_text = notice.comment.text;
      result.comment_id = notice.comment.cid;
    } else if (notice.type === 33 && notice.follow) {
      // å…³æ³¨é€šçŸ¥
      const followUid = notice.follow.user_id || notice.follow.uid;
      result.action = 'follow';
      result.user = userMap[followUid] || { uid: followUid };
    }

    // é€šç”¨é€šçŸ¥æ¶ˆæ¯
    if (notice.general_notice?.notice_msg) {
      result.notice_msg = notice.general_notice.notice_msg;
    }

    return result;
  });

  return {
    success: true,
    notifications: fullNotifications,
    totalCount: fullNotifications.length,
    hasMore: noticeStore.noticeListObj?.hasMore === 1,
    unreadCounts: noticeStore.noticeUnreadCountMap
  };
}
```

### 3.3 å®Œæ•´çš„ Playwright æå–å‡½æ•°

```javascript
async function extractDouyinNotifications(page) {
  return await page.evaluate(() => {
    try {
      // æŸ¥æ‰¾é€šçŸ¥é¡¹
      const allDivs = Array.from(document.querySelectorAll('div'));
      const notificationItem = allDivs.find(el => {
        const text = el.textContent || '';
        return text.includes('èµäº†ä½ çš„ä½œå“') && text.length > 15 && text.length < 120;
      });

      if (!notificationItem) {
        return { success: false, error: 'æœªæ‰¾åˆ°é€šçŸ¥å…ƒç´ ' };
      }

      // è·å– React Fiber
      const fiberKey = Object.keys(notificationItem).find(k => k.startsWith('__reactFiber'));
      if (!fiberKey) {
        return { success: false, error: 'æœªæ‰¾åˆ° React Fiber' };
      }

      // éå†æŸ¥æ‰¾ noticeStore
      let currentFiber = notificationItem[fiberKey];
      let noticeStore = null;
      let depth = 0;

      while (currentFiber && depth < 30) {
        if (currentFiber.memoizedProps?.noticeStore) {
          noticeStore = currentFiber.memoizedProps.noticeStore;
          break;
        }
        currentFiber = currentFiber.return;
        depth++;
      }

      if (!noticeStore) {
        return { success: false, error: 'æœªæ‰¾åˆ° noticeStore' };
      }

      // æå–ç”¨æˆ·ä¿¡æ¯æ˜ å°„
      const userMap = {};
      if (noticeStore.userListObj) {
        for (const uid in noticeStore.userListObj) {
          const user = noticeStore.userListObj[uid];
          if (user && typeof user === 'object') {
            userMap[uid] = {
              uid: user.uid,
              short_id: user.short_id,
              nickname: user.nickname,
              avatar_url: user.avatar_thumb?.url_list?.[0] || user.avatar_300?.url_list?.[0]
            };
          }
        }
      }

      // æå–é€šçŸ¥åˆ—è¡¨
      const noticeList = noticeStore.noticeListObj?.noticeList || [];
      const notifications = noticeList.map(notice => {
        const result = {
          nid: notice.nid_str || String(notice.nid),
          type: notice.type,
          create_time: notice.create_time,
          has_read: notice.has_read,
          aweme_id: notice.aweme_id,
          read_time: notice.read_time
        };

        // æ ¹æ®ç±»å‹æå–ä¿¡æ¯
        if (notice.type === 41 && notice.digg) {
          const diggUid = String(notice.digg.user_id || notice.digg.uid);
          result.action = 'digg';
          result.user = userMap[diggUid] || { uid: diggUid };
          result.digg_count = notice.digg.count;
        } else if (notice.type === 31 && notice.comment) {
          const commentUid = String(notice.comment.user_id || notice.comment.uid);
          result.action = 'comment';
          result.user = userMap[commentUid] || { uid: commentUid };
          result.comment_text = notice.comment.text;
          result.comment_id = notice.comment.cid;
        } else if (notice.type === 33 && notice.follow) {
          const followUid = String(notice.follow.user_id || notice.follow.uid);
          result.action = 'follow';
          result.user = userMap[followUid] || { uid: followUid };
        }

        if (notice.general_notice?.notice_msg) {
          result.notice_msg = notice.general_notice.notice_msg;
        }

        return result;
      });

      return {
        success: true,
        notifications: notifications,
        totalCount: notifications.length,
        hasMore: noticeStore.noticeListObj?.hasMore === 1,
        unreadCounts: noticeStore.noticeUnreadCountMap,
        metadata: {
          minTime: noticeStore.noticeListObj?.minTime,
          maxTime: noticeStore.noticeListObj?.maxTime,
          latestTime: noticeStore.noticeLatestTime
        }
      };

    } catch (error) {
      return {
        success: false,
        error: error.message,
        stack: error.stack
      };
    }
  });
}
```

---

## å››ã€é€šçŸ¥ç±»å‹è¯¦è§£

### 4.1 ç‚¹èµé€šçŸ¥ï¼ˆtype: 41ï¼‰

**æ–‡æœ¬**: "XXX èµäº†ä½ çš„ä½œå“"

**æ•°æ®ç»“æ„**:
```javascript
{
  nid: "7569468864996639793",
  type: 41,
  action: "digg",
  aweme_id: "7550508912979774777",  // è¢«ç‚¹èµçš„ä½œå“
  user: {
    uid: "...",
    nickname: "åŒ— æŠ–ğŸŒˆ",
    avatar_url: "https://..."
  },
  digg_count: 1,
  create_time: 1762404308,
  has_read: true
}
```

### 4.2 è¯„è®ºé€šçŸ¥ï¼ˆtype: 31ï¼‰

**æ–‡æœ¬**: "XXX è¯„è®ºäº†ä½ çš„ä½œå“"

**æ•°æ®ç»“æ„**:
```javascript
{
  nid: "7569134956065850427",
  type: 31,
  action: "comment",
  aweme_id: "7569052156192394530",  // è¢«è¯„è®ºçš„ä½œå“
  user: {
    uid: "...",
    nickname: "ç§‹èŠå§",
    avatar_url: "https://..."
  },
  comment_text: "[èµ][èµ][èµ]",      // è¯„è®ºå†…å®¹
  comment_id: "...",                 // è¯„è®º ID
  create_time: 1762326565,
  has_read: true
}
```

### 4.3 å…³æ³¨é€šçŸ¥ï¼ˆtype: 33ï¼‰

**æ–‡æœ¬**: "XXX å…³æ³¨äº†ä½ "

**æ•°æ®ç»“æ„**:
```javascript
{
  nid: "7569066886173164581",
  type: 33,
  action: "follow",
  aweme_id: "0",                    // å…³æ³¨é€šçŸ¥æ— ä½œå“ ID
  user: {
    uid: "...",
    nickname: "çš“å“¥ç¼¬æ²™å¦åˆ†æ•£ç‰‡",
    avatar_url: "https://..."
  },
  create_time: 1762310716,
  has_read: true
}
```

---

## äº”ã€DOM ç»“æ„åˆ†æ

### 5.1 é€šçŸ¥é¢æ¿ç»“æ„

é€šçŸ¥é¢æ¿ä½äºé¡µé¢å·¦ä¾§è¾¹æ çš„ listitem ä¸­ï¼š

```yaml
- listitem:
  - generic:
    - generic:  # å¤´éƒ¨
      - generic: "äº’åŠ¨æ¶ˆæ¯"
      - generic [cursor=pointer]:  # "å…¨éƒ¨æ¶ˆæ¯"é“¾æ¥
        - text: "å…¨éƒ¨æ¶ˆæ¯"
        - img
    - generic:  # é€šçŸ¥åˆ—è¡¨å®¹å™¨
      - generic [cursor=pointer]:  # å•ä¸ªé€šçŸ¥é¡¹
        - generic:  # å†…å®¹åŒºåŸŸ
          - link:  # ç”¨æˆ·é“¾æ¥
            - generic:  # å¤´åƒå®¹å™¨
              - img  # ç”¨æˆ·å¤´åƒ
          - generic:  # æ–‡æœ¬ä¿¡æ¯
            - link: "ç”¨æˆ·æ˜µç§°"
            - generic: "èµäº†ä½ çš„ä½œå“"
            - generic: "æ—¶é—´"
        - img  # ä½œå“ç¼©ç•¥å›¾
```

### 5.2 å•ä¸ªé€šçŸ¥é¡¹å…ƒç´ 

æ¯ä¸ªé€šçŸ¥é¡¹æ˜¯ä¸€ä¸ªåŒ…å«ä»¥ä¸‹ä¿¡æ¯çš„ divï¼š

- **ç”¨æˆ·å¤´åƒ**: `<img>` å…ƒç´ 
- **ç”¨æˆ·æ˜µç§°**: `<link>` å…ƒç´ ï¼ŒåŒ…å«ç”¨æˆ·ä¸»é¡µé“¾æ¥
- **æ“ä½œæè¿°**: "èµäº†ä½ çš„ä½œå“" / "è¯„è®ºäº†ä½ çš„ä½œå“" / "å…³æ³¨äº†ä½ "
- **æ—¶é—´**: "12:45" / "æ˜¨å¤©" ç­‰
- **ä½œå“ç¼©ç•¥å›¾**: å³ä¾§çš„ `<img>` å…ƒç´ ï¼ˆå…³æ³¨é€šçŸ¥æ²¡æœ‰ï¼‰

### 5.3 React Fiber è®¿é—®è·¯å¾„

ä»é€šçŸ¥é¡¹å…ƒç´ åˆ° `noticeStore` çš„å…¸å‹è·¯å¾„ï¼š

```
é€šçŸ¥é¡¹ DIV
  â””â”€ __reactFiber$xxx
      â””â”€ return (depth 1)
          â””â”€ memoizedProps.notice (å•æ¡é€šçŸ¥æ•°æ®)
          â””â”€ return (depth 2-6)
              â””â”€ memoizedProps.noticeStore (å®Œæ•´ store)
```

**å…³é”®ç‚¹**:
- `noticeStore` é€šå¸¸åœ¨ depth 1-11 å±‚
- æ¯ä¸ªé€šçŸ¥é¡¹çš„ `memoizedProps` ä¸­æœ‰ `notice` å¯¹è±¡ï¼ˆå•æ¡æ•°æ®ï¼‰
- å‘ä¸Šéå†å¯æ‰¾åˆ° `noticeStore`ï¼ˆå®Œæ•´æ•°æ®ï¼‰

---

## å…­ã€å®é™…åº”ç”¨ç¤ºä¾‹

### 6.1 ç›‘æ§æ–°é€šçŸ¥

```javascript
let lastNoticeTime = 0;

async function checkNewNotifications(page) {
  const result = await extractDouyinNotifications(page);

  if (!result.success) {
    console.error('æå–é€šçŸ¥å¤±è´¥:', result.error);
    return [];
  }

  const newNotifications = result.notifications.filter(notice => {
    return notice.create_time > lastNoticeTime && !notice.has_read;
  });

  if (newNotifications.length > 0) {
    lastNoticeTime = Math.max(...newNotifications.map(n => n.create_time));
    console.log(`å‘ç° ${newNotifications.length} æ¡æ–°é€šçŸ¥`);
  }

  return newNotifications;
}
```

### 6.2 è¿‡æ»¤è¯„è®ºé€šçŸ¥

```javascript
async function getCommentNotifications(page) {
  const result = await extractDouyinNotifications(page);

  if (!result.success) {
    return [];
  }

  const comments = result.notifications.filter(notice => {
    return notice.type === 31 && notice.action === 'comment';
  });

  return comments.map(comment => ({
    user: comment.user.nickname,
    text: comment.comment_text,
    aweme_id: comment.aweme_id,
    time: new Date(comment.create_time * 1000).toLocaleString()
  }));
}
```

### 6.3 ç»Ÿè®¡æœªè¯»é€šçŸ¥

```javascript
async function getUnreadStats(page) {
  const result = await extractDouyinNotifications(page);

  if (!result.success) {
    return null;
  }

  const unreadNotifications = result.notifications.filter(n => !n.has_read);

  return {
    total: unreadNotifications.length,
    byType: {
      digg: unreadNotifications.filter(n => n.action === 'digg').length,
      comment: unreadNotifications.filter(n => n.action === 'comment').length,
      follow: unreadNotifications.filter(n => n.action === 'follow').length
    },
    unreadCounts: result.unreadCounts
  };
}
```

---

## ä¸ƒã€æ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µ

### 7.1 æ•°æ®ä¸€è‡´æ€§

1. **ç”¨æˆ·ä¿¡æ¯å…³è”**:
   - é€šçŸ¥å¯¹è±¡ä¸­çš„ `user` å­—æ®µå¯èƒ½ä¸º `null`
   - éœ€è¦ä» `noticeStore.userListObj` ä¸­é€šè¿‡ UID æŸ¥æ‰¾å®Œæ•´ç”¨æˆ·ä¿¡æ¯
   - å»ºè®®å…ˆæ„å»º `userMap`ï¼Œå†å…³è”é€šçŸ¥æ•°æ®

2. **ID ç±»å‹**:
   - `nid` å¯èƒ½æ˜¯æ•°å­—æˆ–å­—ç¬¦ä¸²
   - å»ºè®®ç»Ÿä¸€ä½¿ç”¨ `nid_str` å­—ç¬¦ä¸²ç‰ˆæœ¬
   - UID ä¹Ÿå»ºè®®è½¬ä¸ºå­—ç¬¦ä¸²è¿›è¡Œæ˜ å°„

### 7.2 æ€§èƒ½ä¼˜åŒ–

1. **é¿å…é¢‘ç¹æå–**:
   - `noticeStore` åªåœ¨é€šçŸ¥æ›´æ–°æ—¶å˜åŒ–
   - å»ºè®®è®¾ç½®åˆç†çš„è½®è¯¢é—´éš”ï¼ˆå¦‚ 15-30 ç§’ï¼‰

2. **é™åˆ¶æå–æ•°é‡**:
   - `noticeList` å¯èƒ½åŒ…å«å¤§é‡å†å²é€šçŸ¥
   - ä½¿ç”¨ `.slice()` é™åˆ¶æå–æ•°é‡

3. **ç¼“å­˜ç”¨æˆ·ä¿¡æ¯**:
   - ç”¨æˆ·ä¿¡æ¯å˜åŒ–ä¸é¢‘ç¹
   - å¯ä»¥ç¼“å­˜ `userListObj` å‡å°‘é‡å¤å¤„ç†

### 7.3 é”™è¯¯å¤„ç†

1. **å…ƒç´ æŸ¥æ‰¾å¤±è´¥**:
   - ç”¨æˆ·å¯èƒ½æœªç™»å½•æˆ–æœªæ‰“å¼€é€šçŸ¥é¢æ¿
   - æ£€æŸ¥è¿”å›çš„ `success` å­—æ®µ

2. **æ•°æ®ç»“æ„å˜åŒ–**:
   - æŠ–éŸ³å¯èƒ½æ›´æ–° React ç»“æ„
   - å»ºè®®æ·»åŠ ç‰ˆæœ¬æ£€æµ‹å’Œå›é€€æœºåˆ¶

3. **è·¨åŸŸé™åˆ¶**:
   - éœ€è¦åœ¨æŠ–éŸ³é¡µé¢ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ
   - ä½¿ç”¨ Playwright çš„ `page.evaluate()`

### 7.4 åæ£€æµ‹å»ºè®®

1. **éšæœºå»¶è¿Ÿ**: åœ¨æ•°æ®æå–ä¹‹é—´æ·»åŠ éšæœºå»¶è¿Ÿ
2. **é™åˆ¶é¢‘ç‡**: é¿å…è¿‡äºé¢‘ç¹çš„æ•°æ®æå–
3. **æ¨¡æ‹Ÿç”¨æˆ·è¡Œä¸º**: é…åˆæ­£å¸¸çš„é¡µé¢æµè§ˆæ“ä½œ

---

## å…«ã€ä¸ç§ä¿¡ç³»ç»Ÿçš„å¯¹æ¯”

| ç‰¹æ€§ | ç§ä¿¡ç³»ç»Ÿ (imStore) | é€šçŸ¥ç³»ç»Ÿ (noticeStore) |
|------|-------------------|----------------------|
| æ•°æ®æºå¯¹è±¡ | `imStore` | `noticeStore` |
| è®¿é—®è·¯å¾„ | `button[data-e2e="im-entry"]` â†’ Fiber | ä»»æ„é€šçŸ¥å…ƒç´  â†’ Fiber |
| åˆ—è¡¨æ•°æ® | `converSationListOrigin` (108æ¡) | `noticeListObj.noticeList` (10+æ¡) |
| ç”¨æˆ·æ˜ å°„ | åœ¨ä¼šè¯å¯¹è±¡å†…éƒ¨ | `userListObj` ç‹¬ç«‹æ˜ å°„ |
| åˆ†é¡µæ”¯æŒ | âœ“ (è™šæ‹Ÿæ»šåŠ¨) | âœ“ (hasMore æ ‡è®°) |
| æœªè¯»è®¡æ•° | `_badgeCount` æ¯ä¸ªä¼šè¯ | `noticeUnreadCountMap` æŒ‰ç±»å‹ |
| å®æ—¶æ›´æ–° | WebSocket (Byted IM SDK) | å¯èƒ½é€šè¿‡ WebSocket æˆ–è½®è¯¢ |

---

## ä¹ã€æ€»ç»“

### 9.1 æ ¸å¿ƒè¦ç‚¹

1. **æ•°æ®æº**: `noticeStore` åŒ…å«æ‰€æœ‰é€šçŸ¥æ•°æ®
2. **è®¿é—®æ–¹å¼**: é€šè¿‡ React Fiber æ ‘éå†
3. **ç”¨æˆ·å…³è”**: éœ€è¦ä» `userListObj` æŸ¥æ‰¾ç”¨æˆ·ä¿¡æ¯
4. **é€šçŸ¥ç±»å‹**: 41=ç‚¹èµ, 31=è¯„è®º, 33=å…³æ³¨
5. **æ— éœ€ UI**: å¯ç›´æ¥æå–æ•°æ®ï¼Œæ— éœ€æ˜¾ç¤ºé€šçŸ¥é¢æ¿

### 9.2 æŠ€æœ¯ä¼˜åŠ¿

- âœ… **é›¶ä¾µå…¥**: ä¸éœ€è¦ä¿®æ”¹é¡µé¢ DOM
- âœ… **å®Œæ•´æ•°æ®**: è·å–æ‰€æœ‰é€šçŸ¥ï¼Œä¸å— UI é™åˆ¶
- âœ… **é«˜æ•ˆç‡**: ç›´æ¥è®¿é—®å†…å­˜æ•°æ®ï¼Œæ— éœ€è§£æ DOM
- âœ… **å®æ—¶æ€§**: æ•°æ®ä¸å‰ç«¯çŠ¶æ€åŒæ­¥

### 9.3 åº”ç”¨åœºæ™¯

1. **è‡ªåŠ¨åŒ–ç›‘æ§**: å®æ—¶ç›‘æ§æ–°è¯„è®ºã€æ–°ç‚¹èµ
2. **æ•°æ®ç»Ÿè®¡**: ç»Ÿè®¡äº’åŠ¨æ•°æ®ã€åˆ†æç”¨æˆ·è¡Œä¸º
3. **é€šçŸ¥èšåˆ**: æ•´åˆå¤šä¸ªè´¦å·çš„é€šçŸ¥
4. **è‡ªåŠ¨å›å¤**: æ£€æµ‹è¯„è®ºé€šçŸ¥å¹¶è‡ªåŠ¨å›å¤

---

## åã€é™„å½•

### 10.1 å®Œæ•´ä»£ç ç¤ºä¾‹

å‚è§ç¬¬ä¸‰èŠ‚çš„ `extractDouyinNotifications()` å‡½æ•°ã€‚

### 10.2 æµ‹è¯•è„šæœ¬

```javascript
// åœ¨æŠ–éŸ³é¡µé¢çš„æµè§ˆå™¨æ§åˆ¶å°ä¸­è¿è¡Œ
(async () => {
  // å¤åˆ¶ extractDouyinNotifications å‡½æ•°ä»£ç ...

  const result = await extractDouyinNotifications();
  console.log('æå–ç»“æœ:', result);

  if (result.success) {
    console.table(result.notifications);
  }
})();
```

### 10.3 ç›¸å…³æ–‡æ¡£

- [æŠ–éŸ³ç§ä¿¡DOMç»“æ„è°ƒæŸ¥æŠ¥å‘Š-2025-11-06.md](./æŠ–éŸ³ç§ä¿¡DOMç»“æ„è°ƒæŸ¥æŠ¥å‘Š-2025-11-06.md)
- [05-DOUYIN-å¹³å°å®ç°æŠ€æœ¯ç»†èŠ‚.md](./05-DOUYIN-å¹³å°å®ç°æŠ€æœ¯ç»†èŠ‚.md)
- [React Fiber æ¶æ„æ–‡æ¡£](https://github.com/acdlite/react-fiber-architecture)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**ä½œè€…**: Claude Code
**æœ€åæ›´æ–°**: 2025-11-06
