# çˆ¬è™«ç³»ç»Ÿä¸æ–°æ•°æ®åº“ç»“æ„å¯¹æ¥åˆ†æ

> åˆ†ææ—¶é—´: 2025-10-24
> æ•°æ®åº“ç‰ˆæœ¬: v1.0 (2025-10-23)
> åˆ†æèŒƒå›´: Worker çˆ¬è™« â†’ Master æ•°æ®åº“å­˜å‚¨

---

## ä¸€ã€æ–°å¢æ•°æ®è¡¨æ¦‚è§ˆ

### 1.1 æ ¸å¿ƒ IM ç›¸å…³è¡¨ (æ–°å¢/æ‰©å±•)

| è¡¨å | çŠ¶æ€ | åˆ—æ•° | DAO çŠ¶æ€ | Worker æ”¯æŒ |
|-----|------|------|---------|-------------|
| `works` | âœ… æ–°å¢ | 21 åˆ— | âŒ ç¼ºå¤± | âŒ æ— å¯¹æ¥ |
| `discussions` | âœ… æ–°å¢ | 17 åˆ— | âŒ ç¼ºå¤± | âŒ æ— å¯¹æ¥ |
| `conversations` | âœ… æ‰©å±• | 16 åˆ— | âœ… å·²å®ç° | âœ… å·²å¯¹æ¥ |
| `direct_messages` | âœ… æ‰©å±• | 26 åˆ— | âœ… å·²å®ç° | âœ… å·²å¯¹æ¥ |
| `comments` | âœ… æ‰©å±• | 16 åˆ— | âœ… å·²å®ç° | âœ… å·²å¯¹æ¥ |
| `douyin_videos` | âš ï¸ è¿‡æ—¶ | 20 åˆ— | âœ… å·²å®ç° | âš ï¸ å¾…è¿ç§» |

### 1.2 æ–°å¢å­—æ®µè¯¦æƒ…

#### `works` è¡¨ (ä½œå“ç®¡ç† - é€šç”¨è¡¨)
```sql
CREATE TABLE works (
  id TEXT PRIMARY KEY,
  account_id TEXT NOT NULL,
  platform TEXT NOT NULL,
  platform_work_id TEXT NOT NULL,
  platform_user_id TEXT,

  -- ä½œå“ç±»å‹å’Œä¿¡æ¯
  work_type TEXT NOT NULL CHECK(work_type IN ('video', 'article', 'image', 'audio', 'text')),
  title TEXT,
  description TEXT,
  cover TEXT,
  url TEXT,
  publish_time INTEGER,

  -- ç»Ÿè®¡ä¿¡æ¯
  total_comment_count INTEGER DEFAULT 0,
  new_comment_count INTEGER DEFAULT 0,
  like_count INTEGER DEFAULT 0,
  share_count INTEGER DEFAULT 0,
  view_count INTEGER DEFAULT 0,

  -- çˆ¬å–çŠ¶æ€
  last_crawl_time INTEGER,
  crawl_status TEXT DEFAULT 'pending',
  crawl_error TEXT,

  -- æ ‡è®°
  is_new BOOLEAN DEFAULT 1,
  push_count INTEGER DEFAULT 0,

  -- æ—¶é—´æˆ³
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,

  UNIQUE(account_id, platform, platform_work_id),
  FOREIGN KEY (account_id) REFERENCES accounts(id) ON DELETE CASCADE
);
```

**ç”¨é€”**: æ›¿ä»£ `douyin_videos` è¡¨ï¼Œæ”¯æŒå¤šå¹³å°å¤šç±»å‹ä½œå“ (è§†é¢‘/å›¾æ–‡/éŸ³é¢‘ç­‰)

---

#### `discussions` è¡¨ (è¯„è®ºåŒºè®¨è®º)
```sql
CREATE TABLE discussions (
  id TEXT PRIMARY KEY,
  account_id TEXT NOT NULL,
  platform TEXT NOT NULL,
  platform_user_id TEXT,
  platform_discussion_id TEXT,

  -- å…³è”åˆ°çˆ¶è¯„è®º
  parent_comment_id TEXT NOT NULL,

  -- è®¨è®ºå†…å®¹
  content TEXT NOT NULL,
  author_name TEXT,
  author_id TEXT,

  -- å…³è”ä½œå“ä¿¡æ¯
  work_id TEXT,
  post_id TEXT,
  post_title TEXT,

  -- çŠ¶æ€
  is_read BOOLEAN DEFAULT 0,
  is_new BOOLEAN DEFAULT 1,
  push_count INTEGER DEFAULT 0,
  author_avatar TEXT,
  like_count INTEGER DEFAULT 0,

  -- æ—¶é—´æˆ³
  detected_at INTEGER NOT NULL,
  created_at INTEGER NOT NULL,

  UNIQUE(account_id, platform_user_id, platform_discussion_id),
  FOREIGN KEY (account_id) REFERENCES accounts(id) ON DELETE CASCADE,
  FOREIGN KEY (parent_comment_id) REFERENCES comments(id) ON DELETE CASCADE,
  FOREIGN KEY (work_id) REFERENCES works(id) ON DELETE SET NULL
);
```

**ç”¨é€”**: å¤„ç†è¯„è®ºä¸‹çš„å›å¤å’Œè®¨è®ºï¼ˆäºŒçº§è¯„è®º/ä¸‰çº§è¯„è®ºï¼‰

---

#### `conversations` è¡¨ (æ‰©å±•å­—æ®µ)
æ–°å¢å­—æ®µ:
- `is_pinned BOOLEAN` - æ˜¯å¦ç½®é¡¶
- `is_muted BOOLEAN` - æ˜¯å¦é™éŸ³
- `last_message_type TEXT` - æœ€åæ¶ˆæ¯ç±»å‹ (text/image/video/audio)
- `status TEXT` - ä¼šè¯çŠ¶æ€ (active/archived/blocked)

---

#### `direct_messages` è¡¨ (æ‰©å±•å­—æ®µ)
æ–°å¢å­—æ®µ:
- `sender_name TEXT` - å‘é€è€…åç§°
- `status TEXT` - æ¶ˆæ¯çŠ¶æ€ (sent/delivered/read/failed)
- `reply_to_message_id TEXT` - å›å¤çš„æ¶ˆæ¯ ID
- `media_url TEXT` - åª’ä½“ URL
- `media_thumbnail TEXT` - åª’ä½“ç¼©ç•¥å›¾
- `file_size INTEGER` - æ–‡ä»¶å¤§å°
- `file_name TEXT` - æ–‡ä»¶åç§°
- `duration INTEGER` - éŸ³è§†é¢‘æ—¶é•¿
- `is_deleted BOOLEAN` - æ˜¯å¦å·²åˆ é™¤
- `is_recalled BOOLEAN` - æ˜¯å¦å·²æ’¤å›
- `recalled_at INTEGER` - æ’¤å›æ—¶é—´

---

#### `comments` è¡¨ (æ‰©å±•å­—æ®µ)
æ–°å¢å­—æ®µ:
- `author_avatar TEXT` - ä½œè€…å¤´åƒ
- `like_count INTEGER` - ç‚¹èµæ•°
- `reply_count INTEGER` - å›å¤æ•°

---

## äºŒã€ç°æœ‰çˆ¬è™«å®ç°çŠ¶æ€

### 2.1 æŠ–éŸ³å¹³å°çˆ¬è™«

#### âœ… å·²å®ç°
- **ç§ä¿¡çˆ¬è™«**: `crawl-direct-messages-v2.js`
  - æ”¯æŒè™šæ‹Ÿåˆ—è¡¨å®Œæ•´å†å²æŠ“å–
  - API æ‹¦æˆªè·å–å®Œæ•´æ¶ˆæ¯ ID
  - ä¼šè¯è¡¨æ•°æ®å­˜å‚¨
  - æ¶ˆæ¯-ä¼šè¯å…³è”

- **è¯„è®ºçˆ¬è™«**: åŸºç¡€å®ç° (éœ€æ‰©å±•)
  - å½“å‰ä»…æŠ“å–ä¸€çº§è¯„è®º
  - å­˜å‚¨åˆ° `comments` è¡¨

#### âŒ æœªå®ç°
- **ä½œå“çˆ¬è™«**:
  - å½“å‰ä½¿ç”¨ `douyin_videos` è¡¨ (ä»…è§†é¢‘)
  - æœªè¿ç§»åˆ°é€šç”¨ `works` è¡¨
  - ä¸æ”¯æŒå›¾æ–‡/éŸ³é¢‘ç­‰å…¶ä»–ç±»å‹

- **è®¨è®ºçˆ¬è™«**:
  - æœªæŠ“å–è¯„è®ºåŒºçš„äºŒçº§/ä¸‰çº§å›å¤
  - æœªå­˜å‚¨åˆ° `discussions` è¡¨

### 2.2 Worker â†’ Master æ•°æ®ä¸ŠæŠ¥

#### âœ… å·²å®ç°ä¸ŠæŠ¥
```javascript
// message-reporter.js
reportComments(accountId, comments)        // âœ… æ”¯æŒ
reportDirectMessages(accountId, messages)  // âœ… æ”¯æŒ
reportConversations(accountId, conversations) // âœ… æ”¯æŒ (ä»…æ—¥å¿—)
```

#### âŒ æœªå®ç°ä¸ŠæŠ¥
```javascript
reportWorks(accountId, works)              // âŒ ç¼ºå¤±
reportDiscussions(accountId, discussions)  // âŒ ç¼ºå¤±
```

### 2.3 Master æ•°æ®å¤„ç†

#### âœ… å·²å®ç° DAO
- `CommentsDAO` â†’ `comments` è¡¨
- `DirectMessagesDAO` â†’ `direct_messages` è¡¨
- `ConversationsDAO` â†’ `conversations` è¡¨
- `DouyinVideoDAO` â†’ `douyin_videos` è¡¨ (æ—§è¡¨)

#### âŒ ç¼ºå¤± DAO
- âŒ `WorksDAO` â†’ `works` è¡¨
- âŒ `DiscussionsDAO` â†’ `discussions` è¡¨

---

## ä¸‰ã€å¾…å¼€å‘åŠŸèƒ½æ¸…å•

### 3.1 æ ¸å¿ƒå¼€å‘ä»»åŠ¡ (é«˜ä¼˜å…ˆçº§)

#### ğŸ“‹ ä»»åŠ¡ 1: å®ç° `WorksDAO`
**æ–‡ä»¶**: `packages/master/src/database/works-dao.js`

**éœ€è¦å®ç°çš„æ–¹æ³•**:
```javascript
class WorksDAO {
  // åŸºç¡€ CRUD
  insert(work)                          // æ’å…¥å•ä¸ªä½œå“
  bulkInsert(works)                     // æ‰¹é‡æ’å…¥ä½œå“
  update(id, updates)                   // æ›´æ–°ä½œå“ä¿¡æ¯
  delete(id)                            // åˆ é™¤ä½œå“

  // æŸ¥è¯¢
  findById(id)                          // æ ¹æ® ID æŸ¥è¯¢
  findByPlatformWorkId(accountId, platform, platformWorkId) // å”¯ä¸€çº¦æŸæŸ¥è¯¢
  findByAccount(accountId, options)     // æŒ‰è´¦æˆ·æŸ¥è¯¢ (åˆ†é¡µ/è¿‡æ»¤)
  findByPlatform(platform, options)     // æŒ‰å¹³å°æŸ¥è¯¢
  findByWorkType(workType, options)     // æŒ‰ä½œå“ç±»å‹æŸ¥è¯¢

  // ç»Ÿè®¡
  getWorkStats(accountId)               // è·å–ä½œå“ç»Ÿè®¡
  updateCommentCount(workId, count)     // æ›´æ–°è¯„è®ºæ•°
  updateViewCount(workId, count)        // æ›´æ–°æµè§ˆæ•°

  // çˆ¬å–çŠ¶æ€
  updateCrawlStatus(workId, status, error)  // æ›´æ–°çˆ¬å–çŠ¶æ€
  getPendingWorks(limit)                // è·å–å¾…çˆ¬å–ä½œå“
}
```

**å‚è€ƒæ–‡ä»¶**: `douyin-video-dao.js`, `comments-dao.js`

---

#### ğŸ“‹ ä»»åŠ¡ 2: å®ç° `DiscussionsDAO`
**æ–‡ä»¶**: `packages/master/src/database/discussions-dao.js`

**éœ€è¦å®ç°çš„æ–¹æ³•**:
```javascript
class DiscussionsDAO {
  // åŸºç¡€ CRUD
  insert(discussion)                    // æ’å…¥å•ä¸ªè®¨è®º
  bulkInsert(discussions)               // æ‰¹é‡æ’å…¥è®¨è®º
  update(id, updates)                   // æ›´æ–°è®¨è®º
  delete(id)                            // åˆ é™¤è®¨è®º

  // æŸ¥è¯¢
  findById(id)                          // æ ¹æ® ID æŸ¥è¯¢
  findByParentComment(parentCommentId)  // æŸ¥è¯¢æŸè¯„è®ºä¸‹çš„æ‰€æœ‰è®¨è®º
  findByWork(workId, options)           // æŸ¥è¯¢æŸä½œå“ä¸‹çš„æ‰€æœ‰è®¨è®º
  findByAccount(accountId, options)     // æŒ‰è´¦æˆ·æŸ¥è¯¢

  // æ ‡è®°çŠ¶æ€
  markAsRead(id)                        // æ ‡è®°ä¸ºå·²è¯»
  markAsNotNew(id)                      // æ ‡è®°ä¸ºéæ–°æ¶ˆæ¯

  // ç»Ÿè®¡
  getUnreadCount(accountId)             // è·å–æœªè¯»è®¨è®ºæ•°
  getDiscussionStats(accountId)         // è·å–è®¨è®ºç»Ÿè®¡
}
```

**å‚è€ƒæ–‡ä»¶**: `comments-dao.js`, `messages-dao.js`

---

#### ğŸ“‹ ä»»åŠ¡ 3: Worker å®ç°ä½œå“çˆ¬è™«
**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/crawl-works.js`

**åŠŸèƒ½éœ€æ±‚**:
1. è®¿é—®ç”¨æˆ·ä¸»é¡µæˆ–åˆ›ä½œè€…ä¸­å¿ƒ
2. æŠ“å–æ‰€æœ‰ä½œå“åˆ—è¡¨ (è§†é¢‘/å›¾æ–‡ç­‰)
3. æå–ä½œå“è¯¦æƒ…:
   - ä½œå“ç±»å‹ (video/image/article)
   - æ ‡é¢˜ã€å°é¢ã€æè¿°
   - ç»Ÿè®¡æ•°æ® (ç‚¹èµ/è¯„è®º/åˆ†äº«/æ’­æ”¾)
   - å‘å¸ƒæ—¶é—´
4. ä¸ŠæŠ¥åˆ° Master

**å®ç°æ­¥éª¤**:
```javascript
async function crawlWorks(page, account) {
  // 1. å¯¼èˆªåˆ°ç”¨æˆ·ä¸»é¡µæˆ–åˆ›ä½œè€…ä¸­å¿ƒ
  await page.goto(`https://creator.douyin.com/...`);

  // 2. æå–ä½œå“åˆ—è¡¨ (è™šæ‹Ÿåˆ—è¡¨æ»šåŠ¨åŠ è½½)
  const works = await extractWorksFromVirtualList(page, account);

  // 3. å¯¹æ¯ä¸ªä½œå“è·å–è¯¦ç»†ä¿¡æ¯
  for (const work of works) {
    const details = await getWorkDetails(page, work);
    work.details = details;
  }

  // 4. è¿”å›æ ‡å‡†åŒ–æ•°æ®
  return works.map(work => ({
    id: uuidv4(),
    account_id: account.id,
    platform: 'douyin',
    platform_work_id: work.aweme_id,
    platform_user_id: account.platform_user_id,
    work_type: detectWorkType(work),
    title: work.title,
    description: work.description,
    cover: work.cover_url,
    url: work.share_url,
    publish_time: work.create_time,
    total_comment_count: work.statistics.comment_count,
    new_comment_count: 0,
    like_count: work.statistics.digg_count,
    share_count: work.statistics.share_count,
    view_count: work.statistics.play_count,
    last_crawl_time: Math.floor(Date.now() / 1000),
    crawl_status: 'success',
    is_new: true,
    push_count: 0,
    created_at: Math.floor(Date.now() / 1000),
    updated_at: Math.floor(Date.now() / 1000),
  }));
}
```

---

#### ğŸ“‹ ä»»åŠ¡ 4: Worker å®ç°è®¨è®ºçˆ¬è™«
**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/crawl-discussions.js`

**åŠŸèƒ½éœ€æ±‚**:
1. åœ¨å·²çˆ¬å–çš„è¯„è®ºåŸºç¡€ä¸Š
2. å±•å¼€æ¯ä¸ªè¯„è®ºçš„å›å¤åˆ—è¡¨
3. æŠ“å–äºŒçº§/ä¸‰çº§å›å¤
4. å…³è”åˆ°çˆ¶è¯„è®ºå’Œä½œå“
5. ä¸ŠæŠ¥åˆ° Master

**å®ç°æ­¥éª¤**:
```javascript
async function crawlDiscussions(page, account, parentComment) {
  // 1. ç‚¹å‡»å±•å¼€è¯„è®ºçš„å›å¤
  await expandCommentReplies(page, parentComment);

  // 2. æ»šåŠ¨åŠ è½½æ‰€æœ‰å›å¤
  const replies = await loadAllReplies(page, parentComment);

  // 3. è¿”å›æ ‡å‡†åŒ–æ•°æ®
  return replies.map(reply => ({
    id: uuidv4(),
    account_id: account.id,
    platform: 'douyin',
    platform_user_id: account.platform_user_id,
    platform_discussion_id: reply.cid,
    parent_comment_id: parentComment.id,
    content: reply.text,
    author_name: reply.user.nickname,
    author_id: reply.user.uid,
    author_avatar: reply.user.avatar_url,
    work_id: parentComment.work_id,
    post_id: parentComment.post_id,
    post_title: parentComment.post_title,
    like_count: reply.digg_count,
    is_read: false,
    is_new: true,
    push_count: 0,
    detected_at: Math.floor(Date.now() / 1000),
    created_at: reply.create_time,
  }));
}
```

---

#### ğŸ“‹ ä»»åŠ¡ 5: Worker æ¶ˆæ¯ä¸ŠæŠ¥å™¨æ‰©å±•
**æ–‡ä»¶**: `packages/worker/src/communication/message-reporter.js`

**æ–°å¢æ–¹æ³•**:
```javascript
class MessageReporter {
  /**
   * ä¸ŠæŠ¥ä½œå“
   */
  reportWorks(accountId, works) {
    if (!Array.isArray(works) || works.length === 0) return;

    logger.info(`Reporting ${works.length} works for account ${accountId}`);

    // æ–¹å¼ 1: å•æ¡ä¸ŠæŠ¥ (ç±»ä¼¼ comments)
    for (const work of works) {
      this.reportMessage(accountId, 'work', work);
    }

    // æ–¹å¼ 2: æ‰¹é‡ä¸ŠæŠ¥ (æ€§èƒ½æ›´å¥½)
    const message = createMessage(WORKER_BULK_INSERT_WORKS, {
      account_id: accountId,
      works: works,
    });
    this.socketClient.sendMessage(message);
  }

  /**
   * ä¸ŠæŠ¥è®¨è®º
   */
  reportDiscussions(accountId, discussions) {
    if (!Array.isArray(discussions) || discussions.length === 0) return;

    logger.info(`Reporting ${discussions.length} discussions for account ${accountId}`);

    for (const discussion of discussions) {
      this.reportMessage(accountId, 'discussion', discussion);
    }
  }

  /**
   * æ‰¹é‡ä¸ŠæŠ¥æ‰€æœ‰æ•°æ®
   */
  reportAll(accountId, detectedMessages) {
    if (detectedMessages.comments?.length > 0) {
      this.reportComments(accountId, detectedMessages.comments);
    }

    if (detectedMessages.directMessages?.length > 0) {
      this.reportDirectMessages(accountId, detectedMessages.directMessages);
    }

    if (detectedMessages.conversations?.length > 0) {
      this.reportConversations(accountId, detectedMessages.conversations);
    }

    // âœ¨ æ–°å¢
    if (detectedMessages.works?.length > 0) {
      this.reportWorks(accountId, detectedMessages.works);
    }

    // âœ¨ æ–°å¢
    if (detectedMessages.discussions?.length > 0) {
      this.reportDiscussions(accountId, detectedMessages.discussions);
    }
  }
}
```

---

#### ğŸ“‹ ä»»åŠ¡ 6: Master æ¶ˆæ¯æ¥æ”¶å™¨æ‰©å±•
**æ–‡ä»¶**: `packages/master/src/communication/message-receiver.js`

**æ–°å¢å¤„ç†å™¨**:
```javascript
const WorksDAO = require('../database/works-dao');
const DiscussionsDAO = require('../database/discussions-dao');

class MessageReceiver {
  constructor(db) {
    this.worksDAO = new WorksDAO(db);
    this.discussionsDAO = new DiscussionsDAO(db);
  }

  /**
   * å¤„ç†ä½œå“æ¶ˆæ¯
   */
  async handleWorkMessage(data) {
    const { account_id, data: work } = data;

    logger.info(`Received work for account ${account_id}:`, work.platform_work_id);

    try {
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
      const existing = await this.worksDAO.findByPlatformWorkId(
        account_id,
        work.platform,
        work.platform_work_id
      );

      if (existing) {
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        await this.worksDAO.update(existing.id, {
          total_comment_count: work.total_comment_count,
          like_count: work.like_count,
          share_count: work.share_count,
          view_count: work.view_count,
          last_crawl_time: work.last_crawl_time,
          updated_at: Math.floor(Date.now() / 1000),
        });
      } else {
        // æ’å…¥æ–°ä½œå“
        await this.worksDAO.insert(work);
      }
    } catch (error) {
      logger.error('Failed to handle work message:', error);
    }
  }

  /**
   * å¤„ç†è®¨è®ºæ¶ˆæ¯
   */
  async handleDiscussionMessage(data) {
    const { account_id, data: discussion } = data;

    logger.info(`Received discussion for account ${account_id}:`, discussion.platform_discussion_id);

    try {
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
      const existing = await this.discussionsDAO.findByPlatformDiscussionId(
        account_id,
        discussion.platform_user_id,
        discussion.platform_discussion_id
      );

      if (!existing) {
        await this.discussionsDAO.insert(discussion);

        // å‘é€é€šçŸ¥
        await this.notifyNewDiscussion(discussion);
      }
    } catch (error) {
      logger.error('Failed to handle discussion message:', error);
    }
  }

  /**
   * æ³¨å†Œæ–°çš„æ¶ˆæ¯å¤„ç†å™¨
   */
  registerHandlers() {
    // ç°æœ‰å¤„ç†å™¨...

    // âœ¨ æ–°å¢
    this.socket.on('worker:work_detected', (data) => {
      this.handleWorkMessage(data);
    });

    this.socket.on('worker:discussion_detected', (data) => {
      this.handleDiscussionMessage(data);
    });

    this.socket.on('worker:bulk_insert_works', async (data) => {
      const { account_id, works } = data;
      await this.worksDAO.bulkInsert(works);
      logger.info(`Bulk inserted ${works.length} works for account ${account_id}`);
    });
  }
}
```

---

#### ğŸ“‹ ä»»åŠ¡ 7: åè®®æ¶ˆæ¯ç±»å‹æ‰©å±•
**æ–‡ä»¶**: `packages/shared/protocol/messages.js`

**æ–°å¢æ¶ˆæ¯ç±»å‹**:
```javascript
// Worker â†’ Master æ¶ˆæ¯
const WORKER_WORK_DETECTED = 'worker:work_detected';
const WORKER_DISCUSSION_DETECTED = 'worker:discussion_detected';
const WORKER_BULK_INSERT_WORKS = 'worker:bulk_insert_works';
const WORKER_BULK_INSERT_DISCUSSIONS = 'worker:bulk_insert_discussions';

// Master â†’ Worker æ¶ˆæ¯
const MASTER_CRAWL_WORKS = 'master:crawl_works';
const MASTER_CRAWL_DISCUSSIONS = 'master:crawl_discussions';

module.exports = {
  // ç°æœ‰æ¶ˆæ¯ç±»å‹...

  // âœ¨ æ–°å¢
  WORKER_WORK_DETECTED,
  WORKER_DISCUSSION_DETECTED,
  WORKER_BULK_INSERT_WORKS,
  WORKER_BULK_INSERT_DISCUSSIONS,
  MASTER_CRAWL_WORKS,
  MASTER_CRAWL_DISCUSSIONS,
};
```

---

#### ğŸ“‹ ä»»åŠ¡ 8: è¿ç§» `douyin_videos` åˆ° `works`
**æ–‡ä»¶**: `packages/master/src/database/migrations/migrate-videos-to-works.js`

**è¿ç§»è„šæœ¬**:
```javascript
/**
 * å°† douyin_videos è¡¨æ•°æ®è¿ç§»åˆ° works è¡¨
 */
async function migrateDouyinVideosToWorks(db) {
  const douyinVideoDAO = new DouyinVideoDAO(db);
  const worksDAO = new WorksDAO(db);

  logger.info('Starting migration: douyin_videos â†’ works');

  // 1. è·å–æ‰€æœ‰ douyin_videos æ•°æ®
  const videos = await db.all('SELECT * FROM douyin_videos');

  logger.info(`Found ${videos.length} videos to migrate`);

  // 2. è½¬æ¢ä¸º works æ ¼å¼
  const works = videos.map(video => ({
    id: video.id,
    account_id: video.account_id,
    platform: 'douyin',
    platform_work_id: video.platform_videos_id,
    platform_user_id: video.platform_user_id,
    work_type: 'video', // æ‰€æœ‰ douyin_videos éƒ½æ˜¯è§†é¢‘
    title: video.title,
    description: null,
    cover: video.cover,
    url: null,
    publish_time: video.publish_time ? new Date(video.publish_time).getTime() / 1000 : null,
    total_comment_count: video.total_comment_count || 0,
    new_comment_count: video.new_comment_count || 0,
    like_count: video.like_count || 0,
    share_count: video.share_count || 0,
    view_count: video.play_count || 0,
    last_crawl_time: video.last_crawl_time,
    crawl_status: video.crawl_status || 'pending',
    crawl_error: video.crawl_error,
    is_new: video.is_new || false,
    push_count: video.push_count || 0,
    created_at: video.created_at,
    updated_at: video.updated_at,
  }));

  // 3. æ‰¹é‡æ’å…¥åˆ° works è¡¨
  await worksDAO.bulkInsert(works);

  logger.info(`âœ… Migration completed: ${works.length} works inserted`);

  // 4. (å¯é€‰) å¤‡ä»½å¹¶åˆ é™¤æ—§è¡¨
  // await db.run('CREATE TABLE douyin_videos_backup AS SELECT * FROM douyin_videos');
  // await db.run('DROP TABLE douyin_videos');
}
```

---

### 3.2 æ¬¡è¦å¼€å‘ä»»åŠ¡ (ä¸­ä¼˜å…ˆçº§)

#### ğŸ“‹ ä»»åŠ¡ 9: æ‰©å±•è¯„è®ºçˆ¬è™«æ”¯æŒæ–°å­—æ®µ
**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/crawl-comments.js`

**æ–°å¢å­—æ®µæå–**:
```javascript
// ç°æœ‰å®ç°
const comment = {
  platform_comment_id: fiber.cid,
  content: fiber.text,
  author_name: fiber.user.nickname,
  author_id: fiber.user.uid,
  // âœ¨ æ–°å¢
  author_avatar: fiber.user.avatar_url,
  like_count: fiber.digg_count,
  reply_count: fiber.reply_comment_total,
};
```

---

#### ğŸ“‹ ä»»åŠ¡ 10: æ‰©å±•ç§ä¿¡çˆ¬è™«æ”¯æŒæ–°å­—æ®µ
**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js`

**æ–°å¢å­—æ®µæå–**:
```javascript
const message = {
  // ç°æœ‰å­—æ®µ...

  // âœ¨ æ–°å¢
  sender_name: props.senderName,
  status: props.status || 'sent',
  reply_to_message_id: props.reply_to,

  // åª’ä½“å­—æ®µ
  media_url: props.content?.url,
  media_thumbnail: props.content?.thumbnail,
  file_size: props.content?.file_size,
  file_name: props.content?.file_name,
  duration: props.content?.duration,

  // åˆ é™¤/æ’¤å›
  is_deleted: props.is_deleted || false,
  is_recalled: props.is_recalled || false,
  recalled_at: props.recalled_at,
};
```

---

#### ğŸ“‹ ä»»åŠ¡ 11: ä¼šè¯è¡¨æ”¯æŒæ–°å­—æ®µ
**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js`

**æ‰©å±•ä¼šè¯æå–**:
```javascript
const conversation = {
  // ç°æœ‰å­—æ®µ...

  // âœ¨ æ–°å¢
  is_pinned: apiData.is_pinned || false,
  is_muted: apiData.is_muted || false,
  last_message_type: detectMessageType(apiData.last_message),
  status: apiData.status || 'active',
};
```

---

## å››ã€å¼€å‘ä¼˜å…ˆçº§å»ºè®®

### ğŸ”´ P0 - æ ¸å¿ƒåŸºç¡€ (å¿…é¡»ä¼˜å…ˆå®Œæˆ)
1. âœ… **ä»»åŠ¡ 1**: å®ç° `WorksDAO` (1-2 å¤©)
2. âœ… **ä»»åŠ¡ 2**: å®ç° `DiscussionsDAO` (1-2 å¤©)
3. âœ… **ä»»åŠ¡ 7**: åè®®æ¶ˆæ¯ç±»å‹æ‰©å±• (0.5 å¤©)

### ğŸŸ  P1 - æ ¸å¿ƒåŠŸèƒ½ (é«˜ä¼˜å…ˆçº§)
4. âœ… **ä»»åŠ¡ 3**: Worker å®ç°ä½œå“çˆ¬è™« (3-5 å¤©)
5. âœ… **ä»»åŠ¡ 5**: Worker æ¶ˆæ¯ä¸ŠæŠ¥å™¨æ‰©å±• (1 å¤©)
6. âœ… **ä»»åŠ¡ 6**: Master æ¶ˆæ¯æ¥æ”¶å™¨æ‰©å±• (1 å¤©)

### ğŸŸ¡ P2 - æ‰©å±•åŠŸèƒ½ (ä¸­ä¼˜å…ˆçº§)
7. âœ… **ä»»åŠ¡ 4**: Worker å®ç°è®¨è®ºçˆ¬è™« (2-3 å¤©)
8. âœ… **ä»»åŠ¡ 9**: æ‰©å±•è¯„è®ºçˆ¬è™«æ”¯æŒæ–°å­—æ®µ (1 å¤©)
9. âœ… **ä»»åŠ¡ 10**: æ‰©å±•ç§ä¿¡çˆ¬è™«æ”¯æŒæ–°å­—æ®µ (1 å¤©)
10. âœ… **ä»»åŠ¡ 11**: ä¼šè¯è¡¨æ”¯æŒæ–°å­—æ®µ (0.5 å¤©)

### ğŸŸ¢ P3 - æ•°æ®è¿ç§» (ä½ä¼˜å…ˆçº§)
11. âœ… **ä»»åŠ¡ 8**: è¿ç§» `douyin_videos` åˆ° `works` (1-2 å¤©)

---

## äº”ã€æŠ€æœ¯éš¾ç‚¹é¢„ä¼°

### 5.1 ä½œå“çˆ¬è™«æŒ‘æˆ˜
- **è™šæ‹Ÿåˆ—è¡¨æ»šåŠ¨**: ä½œå“åˆ—è¡¨é€šå¸¸æ˜¯è™šæ‹Ÿæ»šåŠ¨ï¼Œéœ€è¦ç±»ä¼¼ç§ä¿¡çˆ¬è™«çš„åˆ†é¡µåŠ è½½é€»è¾‘
- **ä½œå“ç±»å‹æ£€æµ‹**: æŠ–éŸ³æ”¯æŒè§†é¢‘/å›¾æ–‡/åˆé›†ç­‰å¤šç§ç±»å‹ï¼Œéœ€è¦å‡†ç¡®è¯†åˆ«
- **API æ‹¦æˆª**: å¯èƒ½éœ€è¦æ‹¦æˆª `/aweme/v1/web/aweme/post/` ç­‰ API è·å–å®Œæ•´æ•°æ®

### 5.2 è®¨è®ºçˆ¬è™«æŒ‘æˆ˜
- **åµŒå¥—å±‚çº§**: è¯„è®ºå¯èƒ½æœ‰å¤šçº§åµŒå¥— (è¯„è®º â†’ å›å¤ â†’ å›å¤çš„å›å¤)
- **å±•å¼€äº¤äº’**: éœ€è¦æ¨¡æ‹Ÿç‚¹å‡»"æŸ¥çœ‹æ›´å¤šå›å¤"æŒ‰é’®
- **æ€§èƒ½é—®é¢˜**: æ¯ä¸ªè¯„è®ºå±•å¼€å›å¤ä¼šå¢åŠ é¡µé¢æ“ä½œæ¬¡æ•°ï¼Œéœ€è¦ä¼˜åŒ–

### 5.3 æ•°æ®ä¸€è‡´æ€§
- **å¤–é”®å…³ç³»**: `discussions` è¡¨ä¾èµ– `comments` å’Œ `works` è¡¨ï¼Œéœ€è¦ç¡®ä¿æ•°æ®æ’å…¥é¡ºåº
- **é‡å¤æ£€æµ‹**: ä½¿ç”¨å”¯ä¸€çº¦æŸ `(account_id, platform_user_id, platform_discussion_id)` å»é‡

---

## å…­ã€æµ‹è¯•éªŒè¯è®¡åˆ’

### 6.1 DAO å•å…ƒæµ‹è¯•
**æ–‡ä»¶**: `tests/works-dao.test.js`, `tests/discussions-dao.test.js`

```javascript
describe('WorksDAO', () => {
  test('should insert work', async () => {
    const work = { /* ... */ };
    const id = await worksDAO.insert(work);
    expect(id).toBeDefined();
  });

  test('should enforce unique constraint', async () => {
    const work = { account_id: 'acc1', platform: 'douyin', platform_work_id: 'w1' };
    await worksDAO.insert(work);

    await expect(worksDAO.insert(work)).rejects.toThrow('UNIQUE constraint');
  });

  // ... æ›´å¤šæµ‹è¯•
});
```

### 6.2 é›†æˆæµ‹è¯•
**æ–‡ä»¶**: `tests/crawler-integration.test.js`

```javascript
describe('Works Crawler Integration', () => {
  test('should crawl works and save to database', async () => {
    const account = { id: 'acc1', platform_user_id: 'u1' };

    // 1. çˆ¬å–ä½œå“
    const works = await crawlWorks(page, account);

    // 2. ä¸ŠæŠ¥åˆ° Master
    messageReporter.reportWorks(account.id, works);

    // 3. éªŒè¯æ•°æ®åº“
    const saved = await worksDAO.findByAccount(account.id);
    expect(saved.length).toBeGreaterThan(0);
  });
});
```

---

## ä¸ƒã€æ€»ç»“

### å½“å‰çŠ¶æ€
- âœ… **å·²å®Œæˆ**: `conversations`, `direct_messages`, `comments` çš„çˆ¬è™«å’Œå­˜å‚¨
- âš ï¸ **éƒ¨åˆ†å®Œæˆ**: `douyin_videos` (éœ€è¿ç§»åˆ° `works`)
- âŒ **æœªå¼€å§‹**: `works`, `discussions` çš„çˆ¬è™«å’Œå­˜å‚¨

### éœ€è¦å¼€å‘çš„æ ¸å¿ƒç»„ä»¶
1. **2 ä¸ª DAO ç±»**: `WorksDAO`, `DiscussionsDAO`
2. **2 ä¸ªçˆ¬è™«è„šæœ¬**: `crawl-works.js`, `crawl-discussions.js`
3. **æ¶ˆæ¯ä¸ŠæŠ¥æ‰©å±•**: `message-reporter.js`
4. **æ¶ˆæ¯æ¥æ”¶æ‰©å±•**: `message-receiver.js`
5. **åè®®æ‰©å±•**: `messages.js` æ–°å¢æ¶ˆæ¯ç±»å‹
6. **æ•°æ®è¿ç§»**: `douyin_videos` â†’ `works`

### é¢„ä¼°å·¥ä½œé‡
- **æ€»å·¥æ—¶**: 15-20 å¤© (1 ä¸ªå¼€å‘äººå‘˜å…¨èŒ)
- **å…³é”®è·¯å¾„**: DAO â†’ åè®® â†’ çˆ¬è™« â†’ ä¸ŠæŠ¥ â†’ æ¥æ”¶ â†’ æµ‹è¯•

### å»ºè®®å®æ–½é¡ºåº
1. Week 1: å®Œæˆ P0 å’Œ P1 ä»»åŠ¡ (DAO + åŸºç¡€å¯¹æ¥)
2. Week 2: å®Œæˆ P2 ä»»åŠ¡ (ä½œå“çˆ¬è™«)
3. Week 3: å®Œæˆ P2-P3 ä»»åŠ¡ (è®¨è®ºçˆ¬è™« + å­—æ®µæ‰©å±• + è¿ç§»)
4. Week 4: æµ‹è¯•å’Œä¼˜åŒ–

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2025-10-24
**ç»´æŠ¤è€…**: Claude Code
