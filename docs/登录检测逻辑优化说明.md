# 登录检测逻辑优化说明

生成时间：2025-10-24 14:15

## 问题背景

**原问题**：系统误判登录状态
- 用户还未扫码，页面仍显示二维码
- 但系统检测到 URL 为 `/creator-micro/home`，就直接认为已登录
- 返回"登录成功"，但实际用户还未登录

**根本原因**：
- 旧逻辑优先检查 URL，只要 URL 包含 `/creator-micro/home` 就认为已登录
- 但抖音的登录页面 URL 也可能是 `/creator-micro/home`（显示登录界面）

## 新的登录检测逻辑

### 整体流程

```
startLogin()
    ↓
判断当前是否在登录流程中
    ↓
┌─────────────────────┬─────────────────────┐
│  场景1：在登录流程中  │ 场景2：不在登录流程中  │
│  (复用当前页面)       │  (新建 tab 检测)      │
└─────────────────────┴─────────────────────┘
    ↓                        ↓
检测登录方式                 检测登录方式
    ↓                        ↓
┌──────┬──────┬──────┐   ┌───────┬────────┐
│已登录│二维码│ SMS  │   │已登录 │未登录  │
└──────┴──────┴──────┘   └───────┴────────┘
    ↓      ↓      ↓         ↓         ↓
  返回   显示   显示     关闭检测  关闭检测
  成功   二维码  SMS     tab，     tab，
                       返回成功  原页面登录
```

### 场景1：正在登录流程中

**判断条件**：
```javascript
const isInLoginFlow = currentUrl.includes('creator.douyin.com') &&
                     (currentUrl.includes('/login') ||
                      currentUrl === 'https://creator.douyin.com/' ||
                      currentUrl === 'about:blank');
```

**处理逻辑**：
1. ✅ **复用当前页面**（不新建 tab）
2. 如果是 `about:blank` 或首页，导航到登录页
3. 检测登录方式（二维码/SMS/已登录）
4. 显示相应的登录界面

**使用场景**：
- 用户首次登录（页面为空）
- 用户手动打开登录页面
- 正在扫码登录过程中

### 场景2：不在登录流程中

**判断条件**：
- 当前页面不在 `creator.douyin.com`
- 或者 URL 不是登录相关页面

**处理逻辑**：

#### 子场景 2A：已登录
1. ✅ **新建 tab** 导航到创作中心首页
2. 检测到有用户头像（已登录）
3. ❌ **关闭检测 tab**
4. 原页面导航到创作中心首页
5. 返回登录成功

#### 子场景 2B：未登录
1. ✅ **新建 tab** 导航到创作中心首页
2. 检测到无用户头像（未登录）
3. ❌ **关闭检测 tab**
4. 原页面导航到登录页
5. 显示二维码/SMS 登录界面

**使用场景**：
- 定期检查登录状态
- 用户正在其他页面（如内容页、数据页）
- 爬虫运行中检测登录是否过期

## 登录状态检测逻辑（detectLoginMethod）

### 检测顺序（从上到下）

**1. 检查用户头像** ✅ 优先级最高
```javascript
// 只检测页面顶部导航栏的用户头像
const avatarSelectors = [
  '#header-avatar > div',        // 顶部导航栏
  '#header-avatar',
  'header [class*="avatar"]',    // 在 header 标签内
  '.header [class*="avatar"]',   // 在 header 类内
];

for (const selector of avatarSelectors) {
  const userAvatar = await page.$(selector);
  if (userAvatar && await userAvatar.isVisible()) {
    return { type: 'logged_in' }; // ✅ 找到头像 = 已登录
  }
}
```

**2. URL 辅助记录** ℹ️ 仅作日志
```javascript
// URL 不再作为判断依据，仅记录日志
const currentUrl = page.url();
logger.info(`Current URL: ${currentUrl}, no avatar found - showing login page`);
```

**3. 检查二维码登录**
```javascript
// 等待页面加载
await page.waitForTimeout(1000);

// 尝试多个二维码选择器
const qrCodeSelectors = [
  '#animate_qrcode_container > div[class*="qrcode"] > img',
  '#animate_qrcode_container img',
  'img[class*="qrcode"]',
  // ...
];

for (const selector of qrCodeSelectors) {
  const qrElement = await page.$(selector);
  if (qrElement && await qrElement.isVisible()) {
    return { type: 'qrcode', selector }; // ✅ 找到二维码
  }
}
```

**4. 尝试切换到二维码**
```javascript
// 如果没有二维码，查找"切换到二维码"按钮
const qrSwitchSelectors = [
  'text=二维码登录',
  'text=扫码登录',
  // ...
];

// 点击切换按钮后重新检查二维码
```

**5. 检查 SMS 登录**
```javascript
// 查找手机号输入框
const phoneInputSelectors = [
  'input[placeholder*="手机号"]',
  'input[type="tel"]',
  // ...
];

// 返回 SMS 登录信息
```

## 关键改进点

### ✅ 修复1：检测顺序优化

**旧逻辑**（错误）：
```javascript
// ❌ 先检查 URL
if (currentUrl.includes('/creator-micro/home')) {
  return { type: 'logged_in' }; // 误判！
}

// 再检查头像（永远不会执行到这里）
if (avatar && avatar.isVisible()) {
  return { type: 'logged_in' };
}
```

**新逻辑**（正确）：
```javascript
// ✅ 先检查头像（最可靠）
if (avatar && avatar.isVisible()) {
  return { type: 'logged_in' }; // 准确判断
}

// URL 仅作日志记录
logger.info(`Current URL: ${currentUrl}`);
```

### ✅ 修复2：新建 tab 检测登录状态

**场景**：用户可能在其他页面，需要检查是否已登录

**旧逻辑**：
- 直接在当前页面导航到登录页
- 如果用户正在查看内容，会打断操作

**新逻辑**：
- 新建 tab 用于检测
- 检测完成后关闭 tab
- 不影响用户当前操作

### ✅ 修复3：登录流程页面复用

**场景**：用户正在扫码登录

**旧逻辑**：
- 可能新建 tab 或刷新页面
- 导致二维码失效

**新逻辑**：
- 检测到在登录流程中，复用当前页面
- 不会打断用户的扫码操作

## 代码位置

### startLogin() 方法
**文件**：`packages/worker/src/platforms/douyin/platform.js`
**行号**：50-192

**关键变量**：
- `page`: 原始主页面
- `checkPage`: 用于检测的页面（可能是 page 或新建的 tab）
- `isInLoginFlow`: 判断是否在登录流程中

### detectLoginMethod() 方法
**文件**：`packages/worker/src/platforms/douyin/platform.js`
**行号**：211-350+

**返回值**：
```javascript
// 已登录
{ type: 'logged_in' }

// 二维码登录
{ type: 'qrcode', selector: '...', expirySelector: '...' }

// SMS 登录
{ type: 'sms', phoneSelector: '...', codeSelector: '...', ... }
```

## 使用示例

### 示例1：首次登录
```
用户操作：Admin Web 点击"登录"按钮
    ↓
1. startLogin() 获取当前页面（可能是 about:blank）
2. 判断：isInLoginFlow = true（因为是空页面）
3. 复用当前页面，导航到 creator.douyin.com
4. detectLoginMethod() 检测：
   - 无头像 → 不是已登录
   - 有二维码 → 返回 'qrcode'
5. 显示二维码供用户扫描
```

### 示例2：检查登录状态（用户在内容页）
```
系统操作：定期检查登录状态
    ↓
1. startLogin() 获取当前页面（正在查看某个视频详情页）
2. 判断：isInLoginFlow = false（不在登录页面）
3. 新建 tab，导航到 creator-micro/home
4. detectLoginMethod() 检测：
   - 有头像 → 已登录
5. 关闭检测 tab
6. 原页面继续显示视频详情（不打断用户操作）
7. 返回"已登录"
```

### 示例3：检查登录状态（登录已过期）
```
系统操作：定期检查登录状态
    ↓
1. startLogin() 获取当前页面（正在查看数据页）
2. 判断：isInLoginFlow = false
3. 新建 tab，导航到 creator-micro/home
4. detectLoginMethod() 检测：
   - 无头像 → 未登录
5. 关闭检测 tab
6. 原页面导航到登录页
7. 显示二维码
8. 等待用户扫描登录
```

## 注意事项

### 1. 页面对象管理
- `page` = 原始主页面（不会改变）
- `checkPage` = 检测页面（可能是 page 或新 tab）
- 登录处理统一使用 `checkPage`

### 2. Tab 生命周期
- 新建的检测 tab 必须在使用完后关闭
- 避免 tab 泄漏导致内存占用

### 3. 用户体验
- 在登录流程中不要新建 tab
- 不在登录流程中才新建 tab 检测
- 检测完成后及时关闭 tab

### 4. 截图调试
- 每次检测都会截图：`login_check_${timestamp}.png`
- 方便调试和排查问题

## 测试建议

### 测试场景1：首次登录
1. 清空浏览器数据
2. 触发登录
3. **预期**：显示二维码，不新建 tab

### 测试场景2：已登录检测
1. 完成登录
2. 导航到内容页
3. 再次触发登录检测
4. **预期**：新建 tab 检测，发现已登录，关闭 tab，原页面不受影响

### 测试场景3：登录过期检测
1. 手动删除 cookies
2. 触发登录检测
3. **预期**：新建 tab 检测，发现未登录，关闭 tab，原页面显示登录界面

### 测试场景4：正在扫码时检测
1. 显示二维码
2. 用户扫码过程中，触发登录检测
3. **预期**：复用当前页面，不新建 tab，不打断扫码

## 总结

新逻辑的核心思想：
1. **头像检测优先**：最可靠的登录状态判断
2. **智能 tab 管理**：根据场景决定是否新建 tab
3. **不打断用户**：登录流程中复用页面，其他场景新建 tab
4. **及时清理资源**：检测完成后关闭 tab

这样既能准确判断登录状态，又能提供良好的用户体验。
