# 账号删除完整流程

## 概述

当 Admin Web 删除账号后，系统会自动完成以下清理工作：
1. 通知 Worker 停止监控该账号
2. 关闭 Worker 上对应账号的浏览器进程
3. 清除 Master DataStore 内存中的账号数据
4. 删除数据库中的账号记录

## 完整流程

### 1. Admin Web 发起删除请求

```javascript
DELETE /api/v1/accounts/:id
```

### 2. Master API 处理

**文件**: `packages/master/src/api/routes/accounts.js:283-310`

```javascript
router.delete('/:id', (req, res) => {
  try {
    // ✅ 在删除前触发任务撤销逻辑
    if (accountAssigner) {
      accountAssigner.revokeDeletedAccount(req.params.id);
    }

    // 删除数据库记录
    const deleted = accountsDAO.delete(req.params.id);

    if (!deleted) {
      return res.status(404).json({
        success: false,
        error: 'Account not found',
      });
    }

    res.json({
      success: true,
      message: 'Account deleted successfully',
    });
  } catch (error) {
    logger.error(`Failed to delete account ${req.params.id}:`, error);
    res.status(500).json({
      success: false,
      error: 'Internal server error',
    });
  }
});
```

### 3. AccountAssigner 撤销任务

**文件**: `packages/master/src/worker_manager/account-assigner.js:169-226`

```javascript
revokeDeletedAccount(accountId) {
  try {
    logger.info(`Revoking tasks for deleted account ${accountId}`);

    // 查找账户的 assigned_worker_id
    const account = this.db
      .prepare('SELECT assigned_worker_id FROM accounts WHERE id = ?')
      .get(accountId);

    if (!account || !account.assigned_worker_id) {
      logger.warn(`Account ${accountId} has no assigned worker, skipping revoke`);

      // ✅ 即使没有分配 Worker，也需要清除 DataStore 中的数据
      if (this.dataStore) {
        const deleted = this.dataStore.deleteAccount(accountId);
        if (deleted) {
          logger.info(`✓ Cleared DataStore for account ${accountId} (no worker assigned)`);
        }
      }

      return true;
    }

    const workerId = account.assigned_worker_id;

    // ✅ 撤销任务（通知 Worker 停止监控并关闭浏览器）
    this.taskScheduler.revokeTask(workerId, accountId);

    // 更新 Worker 的 assigned_accounts 计数
    const currentCount = this.db
      .prepare('SELECT assigned_accounts FROM workers WHERE id = ?')
      .get(workerId)?.assigned_accounts || 0;

    const newCount = Math.max(0, currentCount - 1);
    this.db
      .prepare('UPDATE workers SET assigned_accounts = ? WHERE id = ?')
      .run(newCount, workerId);

    // ✅ 清除 DataStore 中的账号数据
    if (this.dataStore) {
      const deleted = this.dataStore.deleteAccount(accountId);
      if (deleted) {
        logger.info(`✓ Cleared DataStore for account ${accountId}`);
      } else {
        logger.warn(`Account ${accountId} not found in DataStore (may not have been crawled yet)`);
      }
    } else {
      logger.warn('DataStore not available, skipping memory cleanup');
    }

    logger.info(`Tasks revoked for account ${accountId} from worker ${workerId}`);

    return true;
  } catch (error) {
    logger.error(`Failed to revoke account ${accountId}:`, error);
    return false;
  }
}
```

### 4. TaskScheduler 发送撤销消息

**文件**: `packages/master/src/scheduler/task-scheduler.js`

```javascript
revokeTask(workerId, accountId) {
  const socket = this.workerRegistry.getWorkerSocket(workerId);
  if (!socket) {
    logger.warn(`Worker ${workerId} not found, cannot revoke task`);
    return;
  }

  // 发送 MASTER_TASK_REVOKE 消息
  const message = createMessage(MASTER_TASK_REVOKE, {
    account_id: accountId,
  });

  socket.emit('message', message);
  logger.info(`Sent task revoke for account ${accountId} to worker ${workerId}`);
}
```

### 5. Worker 接收撤销消息

**文件**: `packages/worker/src/index.js:347-349`

```javascript
socketClient.onMessage(MASTER_TASK_REVOKE, (msg) => {
  handleTaskRevoke(msg);
});
```

### 6. Worker 处理撤销任务

**文件**: `packages/worker/src/index.js:487-506`

```javascript
async function handleTaskRevoke(msg) {
  const { payload } = msg;
  logger.info(`Received task revoke for account ${payload.account_id}`);

  try {
    // 1. 从任务执行器移除
    taskRunner.removeTask(payload.account_id);

    // 2. 从注册表移除
    workerRegistration.removeAccount(payload.account_id);

    // 3. ✅ 关闭浏览器并清理资源
    await accountInitializer.removeAccount(payload.account_id);

    logger.info(`✓ Successfully removed monitoring task for account ${payload.account_id}`);

  } catch (error) {
    logger.error(`Failed to handle task revoke for account ${payload.account_id}:`, error);
  }
}
```

### 7. AccountInitializer 移除账号

**文件**: `packages/worker/src/handlers/account-initializer.js:342-357`

```javascript
async removeAccount(accountId) {
  try {
    logger.info(`Removing account ${accountId}`);

    // ✅ 关闭浏览器
    await this.browserManager.closeBrowser(accountId);

    // 从已初始化集合中移除
    this.initializedAccounts.delete(accountId);

    logger.info(`✓ Account ${accountId} removed`);

  } catch (error) {
    logger.error(`Failed to remove account ${accountId}:`, error);
  }
}
```

### 8. BrowserManager 关闭浏览器

**文件**: `packages/worker/src/browser/browser-manager.js`

```javascript
async closeBrowser(accountId) {
  const context = this.contexts.get(accountId);
  if (context) {
    await context.close();
    this.contexts.delete(accountId);
    logger.info(`✓ Browser closed for account ${accountId}`);
  }

  // 清理资源
  this.pages.delete(accountId);
  this.tabManager.clearAccount(accountId);
}
```

### 9. DataStore 清除内存数据

**文件**: `packages/master/src/data/data-store.js:486-493`

```javascript
deleteAccount(accountId) {
  if (this.accounts.delete(accountId)) {
    logger.info(`Deleted account data: ${accountId}`);
    this.updateStats();
    return true;
  }
  return false;
}
```

## 修改的文件

### 1. `packages/master/src/worker_manager/account-assigner.js`

- **修改构造函数**：添加 `dataStore` 参数
  ```javascript
  constructor(db, workerRegistry, taskScheduler, dataStore = null)
  ```

- **修改 revokeDeletedAccount**：添加 DataStore 清理逻辑
  ```javascript
  if (this.dataStore) {
    const deleted = this.dataStore.deleteAccount(accountId);
    if (deleted) {
      logger.info(`✓ Cleared DataStore for account ${accountId}`);
    }
  }
  ```

### 2. `packages/master/src/index.js`

- **修改 AccountAssigner 初始化**：传入 dataStore
  ```javascript
  accountAssigner = new AccountAssigner(db, workerRegistry, taskScheduler, dataStore);
  ```

## 数据清理范围

删除账号时会清理以下数据：

### Master 端
1. **数据库记录** (`accounts` 表)
2. **DataStore 内存数据**：
   - 评论数据 (`comments` Map)
   - 作品数据 (`contents` Map)
   - 会话数据 (`conversations` Map)
   - 私信数据 (`messages` Map)
   - 通知数据 (`notifications` Map)
3. **Worker 分配计数** (`workers.assigned_accounts`)

### Worker 端
1. **浏览器进程**（PersistentContext）
2. **浏览器用户数据目录** (`./data/browser/{worker-id}/browser_{account-id}/`)
3. **指纹配置文件** (`./data/browser/{worker-id}/fingerprints/{account-id}_fingerprint.json`)
4. **存储状态文件** (`./data/browser/{worker-id}/storage-states/{account-id}_storage.json`)
5. **任务执行器中的定时任务**
6. **平台监控任务**

## 日志输出示例

### Master 端日志

```
[account-assigner] Revoking tasks for deleted account acc_123456
[account-assigner] Sent task revoke for account acc_123456 to worker worker-1
[data-store] Deleted account data: acc_123456
[account-assigner] ✓ Cleared DataStore for account acc_123456
[account-assigner] Tasks revoked for account acc_123456 from worker worker-1
```

### Worker 端日志

```
[worker] Received task revoke for account acc_123456
[task-runner] Removed task for account acc_123456
[worker-registration] Removed account acc_123456 from registry
[account-initializer] Removing account acc_123456
[browser-manager] ✓ Browser closed for account acc_123456
[account-initializer] ✓ Account acc_123456 removed
[worker] ✓ Successfully removed monitoring task for account acc_123456
```

## 注意事项

1. **删除前确认**：删除操作不可逆，建议在 Admin Web 添加二次确认提示
2. **数据备份**：重要账号删除前建议先导出数据
3. **浏览器关闭**：浏览器关闭可能需要几秒钟，Worker 会自动处理
4. **内存释放**：删除账号后，Worker 进程的内存占用会相应减少（约 200MB/账号）
5. **任务调度**：如果 Worker 不在线，撤销消息会失败，但不影响数据库删除
6. **DataStore 清理**：即使账号从未被爬取过（DataStore 中无数据），也会正常处理

## 测试步骤

1. **准备测试账号**
   ```bash
   # 创建测试账号
   curl -X POST http://localhost:3000/api/v1/accounts \
     -H "Content-Type: application/json" \
     -d '{
       "platform": "douyin",
       "account_name": "测试账号",
       "account_id": "test_12345"
     }'
   ```

2. **等待账号初始化**
   - 查看 Worker 日志，确认浏览器已启动
   - 查看任务列表，确认监控任务已运行

3. **删除账号**
   ```bash
   curl -X DELETE http://localhost:3000/api/v1/accounts/{account_id}
   ```

4. **验证清理结果**
   - Master 日志：应看到 DataStore 清除成功
   - Worker 日志：应看到浏览器关闭成功
   - 数据库：账号记录已删除
   - 浏览器进程：对应的浏览器进程已退出
   - 内存：Worker 进程内存占用减少

## 常见问题

### Q1: 删除账号后 Worker 浏览器没有关闭？

**检查步骤**：
1. 查看 Worker 日志，确认是否收到 `MASTER_TASK_REVOKE` 消息
2. 检查 Worker 与 Master 的 Socket.IO 连接是否正常
3. 查看是否有错误日志

### Q2: DataStore 清理失败？

**可能原因**：
1. AccountAssigner 初始化时没有传入 dataStore
2. 账号从未被爬取过，DataStore 中无数据（这是正常的）

### Q3: 删除后内存没有释放？

**解决方案**：
1. 等待几秒钟，浏览器关闭需要时间
2. 检查 Worker 日志，确认浏览器已正确关闭
3. 如果仍未释放，可能是浏览器进程僵死，需要手动 kill 进程

## 相关文档

- [02-MASTER-系统文档.md](./02-MASTER-系统文档.md)
- [03-WORKER-系统文档.md](./03-WORKER-系统文档.md)
- [账户管理 API 文档](./API对比总结-原版IM-vs-Master.md)
