# 日志路径统一配置 - 已完成

**日期**: 2025-10-29
**版本**: v1.0
**状态**: ✅ 已完成

---

## 一、问题描述

### 原始问题

**日志路径使用相对路径**,导致不同启动方式产生不同的日志位置:

```javascript
// 原代码: packages/shared/utils/logger.js
function createLogger(serviceName, logDir = './logs') {  // ❌ 相对路径
  // ...
}
```

**问题示例**:
```bash
# Worker 在 packages/worker 启动
cd packages/worker && npm start
# 日志路径: packages/worker/logs/ ✅

# Worker 从根目录启动
cd <project-root> && npm run start:worker
# 日志路径: <root>/logs/ ❌  错误位置!
```

---

## 二、解决方案

### 实现逻辑

**优先级**: 环境变量 > 自动推断 > 默认路径

#### 1. 环境变量优先

```bash
# 在 .env 文件中配置
LOG_DIR=/absolute/path/to/logs
```

如果设置了 `LOG_DIR` 环境变量,所有日志都写入指定目录。

#### 2. 服务名称自动推断

根据 `serviceName` 自动推断日志目录:

| 服务名称模式 | 日志目录 | 示例 |
|-------------|---------|------|
| 包含 `master`, `-dao`, `notification` | `packages/master/logs` | `master`, `account-dao` |
| 包含 `worker`, `platform`, `data-manager`, `crawl-`, `spider`, `api-interceptor`, `cache-` | `packages/worker/logs` | `douyin-platform`, `data-manager:acc-001` |
| 包含 `admin` | `packages/admin-web/logs` | `admin-web` |
| 其他 | `<root>/logs` | `shared`, `unknown-service` |

**关键点**: Master 服务优先匹配（避免 `worker-dao` 被识别为 Worker 服务）

#### 3. 自动创建目录

```javascript
// 确保日志目录存在
if (!fs.existsSync(logDir)) {
  fs.mkdirSync(logDir, { recursive: true });
}
```

---

## 三、代码实现

### 修改的文件

**文件**: [packages/shared/utils/logger.js](../packages/shared/utils/logger.js)

**新增函数**: `getLogDir(serviceName)`

```javascript
/**
 * 获取统一的日志目录
 * 优先级: 环境变量 > 自动推断 > 默认路径
 */
function getLogDir(serviceName) {
  // 1. 优先使用环境变量
  if (process.env.LOG_DIR) {
    return process.env.LOG_DIR;
  }

  // 2. 根据服务名称自动推断日志目录
  const PROJECT_ROOT = path.resolve(__dirname, '../../..');

  // Master 相关服务（优先匹配）
  if (serviceName.includes('master') ||
      serviceName.includes('-dao') ||
      serviceName.includes('notification')) {
    return path.join(PROJECT_ROOT, 'packages/master/logs');
  }

  // Worker 相关服务
  if (serviceName.includes('worker') ||
      serviceName.includes('platform') ||
      serviceName.includes('data-manager') ||
      serviceName.includes('douyin-data') ||
      serviceName.includes('browser-manager') ||
      serviceName.includes('crawl-') ||
      serviceName.includes('spider') ||
      serviceName.includes('api-interceptor') ||
      serviceName.includes('cache-')) {
    return path.join(PROJECT_ROOT, 'packages/worker/logs');
  }

  // Admin Web 相关服务
  if (serviceName.includes('admin')) {
    return path.join(PROJECT_ROOT, 'packages/admin-web/logs');
  }

  // 默认: 项目根目录下的 logs
  return path.join(PROJECT_ROOT, 'logs');
}
```

**修改 `createLogger()` 函数**:

```javascript
function createLogger(serviceName, logDir) {
  // 如果未指定 logDir，自动推断
  if (!logDir) {
    logDir = getLogDir(serviceName);
  }

  // 确保日志目录存在
  if (!fs.existsSync(logDir)) {
    fs.mkdirSync(logDir, { recursive: true });
  }

  // ... 创建 logger
}
```

**修改行数**: +52 行 (新增 `getLogDir` 函数 + 修改 `createLogger`)

---

## 四、测试验证

### 测试脚本

**文件**: [tests/验证日志路径统一配置.js](../tests/验证日志路径统一配置.js)

**测试覆盖**:
- 8 个 Worker 服务
- 4 个 Master 服务
- 1 个 Admin 服务
- 2 个默认服务
- 1 个环境变量覆盖测试

**测试结果**: ✅ **15 通过 / 0 失败**

```
✅ worker                              → packages\worker\logs
✅ douyin-platform                     → packages\worker\logs
✅ data-manager:acc-001                → packages\worker\logs
✅ douyin-data:acc-001                 → packages\worker\logs
✅ browser-manager-v2                  → packages\worker\logs
✅ crawl-direct-messages-v2            → packages\worker\logs
✅ api-interceptor                     → packages\worker\logs
✅ cache-manager                       → packages\worker\logs
✅ master                              → packages\master\logs
✅ worker-dao                          → packages\master\logs
✅ account-dao                         → packages\master\logs
✅ notification-broadcaster            → packages\master\logs
✅ admin-web                           → packages\admin-web\logs
✅ shared                              → logs
✅ unknown-service                     → logs
```

**环境变量覆盖**: ✅ 成功

---

## 五、实际效果

### Worker 日志示例

现在所有 Worker 相关日志都统一写入 `packages/worker/logs/`:

```bash
packages/worker/logs/
├── douyin-platform.log
├── douyin-platform-error.log
├── data-manager:acc-98296c87-....log      # ✅ 统一路径
├── data-manager:acc-98296c87-...-error.log
├── douyin-data:acc-98296c87-....log       # ✅ 统一路径
├── douyin-data:acc-98296c87-...-error.log
├── browser-manager-v2.log
├── crawl-direct-messages-v2.log
├── api-interceptor.log
└── ...
```

### Master 日志示例

```bash
packages/master/logs/
├── master.log
├── master-error.log
├── account-dao.log
├── worker-dao.log          # ✅ 正确识别为 Master 服务
├── notification-broadcaster.log
└── ...
```

---

## 六、向后兼容性

### 现有代码无需修改

所有使用 `createLogger()` 的代码**无需任何修改**:

```javascript
// 原有代码（无需修改）
const logger = createLogger('data-manager:acc-001');

// 行为改变:
// 之前: 日志可能写入 ./logs/ (相对路径)
// 现在: 日志统一写入 packages/worker/logs/ (绝对路径) ✅
```

### 自定义路径仍然支持

```javascript
// 如果需要自定义路径（不常用）
const logger = createLogger('custom-service', '/custom/log/path');
```

---

## 七、环境变量使用

### 生产环境推荐配置

```bash
# packages/master/.env
LOG_DIR=/var/log/hiscrm/master

# packages/worker/.env
LOG_DIR=/var/log/hiscrm/worker
```

### Docker 部署配置

```yaml
# docker-compose.yml
services:
  master:
    environment:
      - LOG_DIR=/app/logs/master
    volumes:
      - ./logs/master:/app/logs/master

  worker:
    environment:
      - LOG_DIR=/app/logs/worker
    volumes:
      - ./logs/worker:/app/logs/worker
```

---

## 八、注意事项

### 1. Worker 需要重启

修改 `logger.js` 后,**Worker 和 Master 需要重启**才能加载新配置:

```bash
# 停止
pm2 stop all

# 启动
pm2 start packages/master/src/index.js --name hiscrm-master
pm2 start packages/worker/src/index.js --name hiscrm-worker
```

### 2. 旧日志文件

修改前创建的日志文件可能在旧位置,不会自动迁移:

```bash
# 清理旧日志（可选）
find . -name "*.log" -path "*/logs/*" -type f -mtime +7 -delete
```

### 3. 服务名称命名规范

为了让自动推断正确工作,建议遵循命名规范:

| 类型 | 命名规范 | 示例 |
|------|---------|------|
| Worker 服务 | 包含 `worker`, `platform`, `crawl-`, `data-manager` | `douyin-platform`, `crawl-comments` |
| Master 服务 | 包含 `master`, `-dao`, `notification` | `master`, `account-dao` |
| Admin 服务 | 包含 `admin` | `admin-web`, `admin-api` |

---

## 九、相关文档

- [DataManager日志验证-待完成.md](./DataManager日志验证-待完成.md) - DataManager 日志问题排查
- [Phase3-DataManager数据关系完整性验证.md](./Phase3-DataManager数据关系完整性验证.md) - DataManager 测试
- [本地端数据抓取完整总结.md](./本地端数据抓取完整总结.md) - Phase 3 总结

---

## 十、总结

### ✅ 已完成

1. ✅ 统一日志路径配置（环境变量 > 自动推断 > 默认）
2. ✅ 自动创建日志目录
3. ✅ 15 个测试用例全部通过
4. ✅ 向后兼容（无需修改现有代码）
5. ✅ 支持环境变量覆盖
6. ✅ 详细文档和测试脚本

### 核心优势

- **统一性**: 所有日志都在预期位置,便于监控和调试
- **灵活性**: 支持环境变量覆盖,适应不同部署环境
- **自动化**: 根据服务名称自动推断,无需手动配置
- **兼容性**: 现有代码无需修改,平滑升级

### 关键数字

- **52 行** 新增代码
- **15 个** 测试用例通过
- **3 个** 日志目录（Master/Worker/默认）
- **100%** 向后兼容

---

**下一步**: 重启 Worker 并验证 DataManager 日志输出

**版本**: v1.0 (2025-10-29)
