# 评论数据零问题调查报告

**时间**: 2025-10-30 11:05
**问题**: DataManager 快照显示 `comments: 0`，而 `contents: 20` 数据正常

## 调查结果

### 1. 作品 API 拦截 ✅ 正常

**API 模式**: `**/aweme/v1/creator/item/list{/,}?**`
**拦截日志**:
```
🎯 [API] 作品列表 API 被触发！
📦 [API] 作品列表包含 20 个作品
✅ [API] 作品列表 -> DataManager: 20 个作品
```

**结果**: 作品 API 拦截器工作正常，数据成功写入 DataManager。

---

### 2. 评论 API 拦截 ❌ 异常

**API 模式修改前**: `**/comment/list?**`
**API 模式修改后**: `**/comment/list{/,}?**`

**拦截日志**: **无任何日志**（api-interceptor.log 中没有评论相关记录）

**爬虫返回结果**:
```json
{
  "comments": 0,
  "discussions": 0,
  "contents": 0
}
```

### 3. 可能的根本原因

#### 原因 A: 评论页面未找到有评论的视频
评论爬虫的逻辑（[crawl-comments.js:207-224](packages/worker/src/platforms/douyin/crawl-comments.js#L207-L224)）：
1. 点击"选择作品"按钮
2. 获取所有视频元素 (`.container-Lkxos9`)
3. 筛选 `commentCountText > 0` 的视频
4. 如果没有找到有评论的视频，直接返回空数组

**缺失日志**:
- 没有看到 `Found X video elements`
- 没有看到 `Videos with comments: X`
- 没有看到 `Videos to Click (with comment counts):`

**推测**: 评论爬虫可能在步骤 2 或 3 失败，没有找到任何有评论的视频。

#### 原因 B: 评论 API URL 模式不匹配
即使修改了模式为 `**/comment/list{/,}?**`，也没有触发任何拦截日志。

**可能情况**:
1. 评论 API 的实际 URL 路径与模式不匹配
2. 评论 API 可能使用了不同的域名或路径结构
3. 评论页面可能使用了 GraphQL 或其他 API 格式

#### 原因 C: DOM 选择器失效
评论爬虫使用的 CSS 选择器可能已过时：
- `.container-Lkxos9` - 视频容器
- `.title-LUOP3b` - 视频标题
- `.right-os7ZB9 > div:last-child` - 评论数量

**影响**: 如果选择器失效，`videoElements` 数组为空，导致：
```javascript
if (videosToClick.length === 0) {
  logger.warn('No videos with comments found');
  return { comments: [], ... };
}
```

---

## 下一步调查建议

### 方案 1: 添加详细日志
修改 `crawl-comments.js`，添加更多调试日志：
```javascript
logger.info(`Found ${videoElements.length} video elements`);
logger.info(`Videos with comments: ${videosToClick.length}`);
```

确认是否是选择器问题。

### 方案 2: 使用 HAR 文件抓包
使用 Playwright 的网络抓包功能，记录评论页面的所有请求：
```javascript
await page.routeFromHAR('tests/comment-page.har', {
  url: '**/comment/**',
  update: true,
});
```

分析实际的评论 API URL。

### 方案 3: 使用 MCP 浏览器工具人工检查
通过 MCP Playwright 工具：
1. 导航到 `https://creator.douyin.com/creator-micro/content/comment-manage`
2. 点击"选择作品"
3. 查看实际的 DOM 结构和 API 请求
4. 确认正确的选择器和 API 模式

---

## 临时结论

评论数据为 0 的根本原因是：**评论爬虫未能找到有评论的视频或未能触发评论 API**。

可能是以下之一：
1. DOM 选择器已失效（视频列表加载失败）
2. 评论 API URL 模式不匹配（需要抓包验证）
3. 账号实际没有视频有评论（但从 contents 数据看有视频 commentCount > 0）

**建议优先级**:
1. 使用 MCP 浏览器工具人工检查（最快确认）
2. 添加详细日志并重新运行
3. HAR 抓包分析实际 API（最准确）
