# ç™»å½•é—®é¢˜æœ€ç»ˆæ€»ç»“

**æ—¥æœŸ**: 2025-10-24
**çŠ¶æ€**: âœ… é—®é¢˜å·²è¯†åˆ«å¹¶ä¿®å¤ï¼Œéœ€è¦é‡å¯ Worker ä½¿ä¿®å¤ç”Ÿæ•ˆ

---

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

ç™»å½•åŠŸèƒ½æ— æ³•å·¥ä½œçš„æ ¹æœ¬åŸå› æ˜¯ **å‚æ•°ä¼ é€’ä¸åŒ¹é…**ï¼š

### é—®é¢˜ 1: startLogin å‚æ•°ä¼ é€’æ–¹å¼é”™è¯¯

**ä½ç½®**: `packages/worker/src/index.js:316`

**é”™è¯¯ä»£ç **:
```javascript
await platformInstance.startLogin({
  accountId: account_id,
  sessionId: session_id,
  proxy,
});
```

**é—®é¢˜**: ä¼ é€’äº†ä¸€ä¸ªå¯¹è±¡ï¼Œä½† `startLogin` æ–¹æ³•æœŸæœ›ä¸‰ä¸ªç‹¬ç«‹å‚æ•°ã€‚

**ç»“æœ**:
- `accountId` å‚æ•°æ¥æ”¶åˆ°æ•´ä¸ªå¯¹è±¡ `{ accountId, sessionId, proxy }`
- `sessionId` å‚æ•°æ¥æ”¶åˆ° `undefined`
- æ‰€æœ‰åç»­é€»è¾‘å¤±è´¥

**âœ… å·²ä¿®å¤**:
```javascript
await platformInstance.startLogin(account_id, session_id, proxy);
```

### é—®é¢˜ 2: sendLoginStatus å‚æ•°é¡ºåºé”™è¯¯

**ä½ç½®**: `packages/worker/src/index.js:332`

**é”™è¯¯ä»£ç **:
```javascript
workerBridge.sendLoginStatus(account_id, session_id, 'failed', error.message);
```

**é—®é¢˜**: å‚æ•°é¡ºåºä¸æ–¹æ³•ç­¾åä¸åŒ¹é…ã€‚

**æ–¹æ³•ç­¾å**: `sendLoginStatus(sessionId, status, data)`

**âœ… å·²ä¿®å¤**:
```javascript
workerBridge.sendLoginStatus(session_id, 'failed', {
  account_id: account_id,
  error_message: error.message
});
```

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. ä»£ç ä¿®å¤

- âœ… ä¿®å¤ `index.js:316` - startLogin å‚æ•°ä¼ é€’
- âœ… ä¿®å¤ `index.js:332` - sendLoginStatus å‚æ•°é¡ºåº
- âœ… ä¿®å¤ `platform-base.js:181-195` - ç™»å½•åå¯¼èˆªé€»è¾‘ï¼ˆä¹‹å‰ä¼šè¯ï¼‰

### 2. æµ‹è¯•éªŒè¯

- âœ… åˆ›å»ºå¿«é€Ÿç™»å½•æµ‹è¯•è„šæœ¬ (`tests/å¿«é€Ÿç™»å½•æµ‹è¯•.js`)
- âœ… æµ‹è¯•é€šè¿‡ - æ‰€æœ‰å‚æ•°æ­£ç¡®ä¼ é€’

### 3. æ–‡æ¡£

- âœ… Workerå´©æºƒé—®é¢˜è¯Šæ–­æŠ¥å‘Š
- âœ… ç™»å½•åŠŸèƒ½å®Œæ•´è¯Šæ–­æŠ¥å‘Š
- âœ… ç™»å½•é—®é¢˜è°ƒè¯•æŠ¥å‘Š
- âœ… æ–‡ä»¶æ¸…ç†æ€»ç»“æŠ¥å‘Š

---

## âš ï¸ å½“å‰çŠ¶æ€

### Worker ä½¿ç”¨äº†æ—§ä»£ç 

**ç°è±¡**: ç”¨æˆ·æŠ¥å‘Š `platformInstance.getName is not a function`

**åŸå› **:
1. Master è‡ªåŠ¨å¯åŠ¨çš„ Worker è¿›ç¨‹ä½¿ç”¨çš„æ˜¯ä¿®æ”¹å‰çš„ä»£ç 
2. æˆ‘ä»¬ä¿®æ”¹çš„æ–‡ä»¶è¿˜æ²¡æœ‰è¢« Worker è¿›ç¨‹åŠ è½½

**è¯æ®**:
- Worker è¿›ç¨‹åœ¨ä¿®æ”¹ä»£ç ä¹‹å‰å°±å·²ç»å¯åŠ¨ (PID 13072, later 20388)
- Node.js ä¸ä¼šåŠ¨æ€é‡æ–°åŠ è½½å·²ç» require() çš„æ¨¡å—
- éœ€è¦é‡å¯ Worker æ‰èƒ½åŠ è½½æ–°ä»£ç 

### éªŒè¯ä¿®å¤ç”Ÿæ•ˆçš„è¯æ®

æµ‹è¯•è„šæœ¬ (`tests/å¿«é€Ÿç™»å½•æµ‹è¯•.js`) æˆåŠŸè¿è¡Œå¹¶éªŒè¯ï¼š
- âœ… `startLogin(accountId, sessionId, proxy)` å‚æ•°æ­£ç¡®
- âœ… `sendLoginStatus(sessionId, status, data)` å‚æ•°æ­£ç¡®
- âœ… æ‰€æœ‰æ•°æ®æ ¼å¼æ­£ç¡®

---

## ğŸ”§ ä¸‹ä¸€æ­¥æ“ä½œ

### æ–¹æ¡ˆ A: é‡å¯ Master å’Œ Workerï¼ˆæ¨èï¼‰

```bash
# 1. åœæ­¢æ‰€æœ‰è¿›ç¨‹
taskkill //F //IM node.exe  # Windows
# æˆ–æŸ¥æ‰¾å¹¶åœæ­¢ç‰¹å®šè¿›ç¨‹

# 2. é‡æ–°å¯åŠ¨ Master
cd packages/master
npm start

# 3. Master ä¼šè‡ªåŠ¨å¯åŠ¨ Worker (worker1)
#    æ­¤æ—¶ Worker ä¼šåŠ è½½ä¿®å¤åçš„ä»£ç 
```

### æ–¹æ¡ˆ B: ä»…é‡å¯ Worker

```bash
# 1. æ‰¾åˆ° Worker è¿›ç¨‹å¹¶åœæ­¢
taskkill //F //PID <worker_pid>

# 2. Master ä¼šè‡ªåŠ¨é‡å¯ Worker
#    ç­‰å¾… 5 ç§’å Worker ä¼šä»¥æ–°ä»£ç é‡å¯
```

### æ–¹æ¡ˆ C: æ‰‹åŠ¨å¯åŠ¨ Worker å¹¶è§‚å¯Ÿæ—¥å¿—

```bash
# 1. åœ¨ Master çš„ worker_configs ä¸­ç¦ç”¨ auto_start
#    æˆ–ç›´æ¥åœæ­¢ Master è‡ªåŠ¨å¯åŠ¨çš„ Worker

# 2. æ‰‹åŠ¨å¯åŠ¨ï¼ˆWindows PowerShellï¼‰
cd packages/worker
$env:WORKER_ID="worker1"
node src/index.js

# è¿™æ ·å¯ä»¥çœ‹åˆ° Worker çš„å®Œæ•´æ—¥å¿—è¾“å‡º
```

---

## ğŸ“Š é¢„æœŸç»“æœ

é‡å¯ Worker åï¼Œç™»å½•æµç¨‹åº”è¯¥æ­£å¸¸å·¥ä½œï¼š

### æœŸæœ›çš„æ—¥å¿—è¾“å‡º

**Worker**:
```
[handleLoginRequest] ========== START ==========
[handleLoginRequest] Parsed: account_id=acc-xxx, platform=douyin, session_id=session-xxx
[handleLoginRequest] platformManager is available
[handleLoginRequest] Getting platform instance for: douyin
[handleLoginRequest] âœ“ Platform instance found: æŠ–éŸ³
[handleLoginRequest] Calling startLogin()...
[Douyin Platform] Starting login for account acc-xxx, session session-xxx
[QRCode Login] Opening login page...
[QRCode Login] Detecting login method...
[QRCode Login] QR code detected
[QRCode Login] Sending QR code to Master...
[worker-bridge] Login status sent: qrcode_ready for session session-xxx
```

**Master**:
```
[admin-namespace] Login request sent to worker worker1 for platform douyin
[socket-server] Worker login status update for session session-xxx: qrcode_ready
[socket-server] Login status data: {
  "session_id": "session-xxx",
  "status": "qrcode_ready",
  "account_id": "acc-xxx",
  "qr_code_data": "data:image/png;base64,...",
  ...
}
[socket-server] Emitted login:status:update to admin namespace
```

**Admin Web**:
- æ¥æ”¶åˆ° `login:status:update` äº‹ä»¶
- æ˜¾ç¤ºäºŒç»´ç 
- ç”¨æˆ·æ‰«ç åæµè§ˆå™¨è·³è½¬åˆ°åˆ›ä½œä¸­å¿ƒ

---

## ğŸ› å¯èƒ½çš„é¢å¤–é—®é¢˜

### å¦‚æœé‡å¯åä»ç„¶å¤±è´¥

1. **æ£€æŸ¥ platformManager.getPlatform() è¿”å›å€¼**
   - å¯èƒ½ platform åç§°ä¸åŒ¹é…ï¼ˆ'douyin' vs 'Douyin'ï¼‰
   - å¹³å°å¯èƒ½æœªæ­£ç¡®æ³¨å†Œ

2. **æ£€æŸ¥ Admin Web äº‹ä»¶ç›‘å¬**
   - ç¡®è®¤ç›‘å¬ `login:status:update` è€Œä¸æ˜¯ `master:login:status`

3. **æ£€æŸ¥æµè§ˆå™¨æ‰“å¼€**
   - Worker å¯èƒ½æ²¡æœ‰æƒé™å¯åŠ¨æµè§ˆå™¨
   - Playwright å¯èƒ½æœªæ­£ç¡®å®‰è£…

---

## ğŸ“ ä¿®å¤æ–‡ä»¶æ¸…å•

### å·²ä¿®æ”¹çš„æ–‡ä»¶

1. **packages/worker/src/index.js**
   - ç¬¬ 316 è¡Œ: ä¿®å¤ startLogin è°ƒç”¨
   - ç¬¬ 332-336 è¡Œ: ä¿®å¤ sendLoginStatus è°ƒç”¨

2. **packages/worker/src/platforms/base/platform-base.js**
   - ç¬¬ 181-195 è¡Œ: æ·»åŠ ç™»å½•åå¯¼èˆªé€»è¾‘ï¼ˆä¹‹å‰ä¼šè¯ï¼‰

### æ–°å¢çš„æ–‡ä»¶

1. **docs/Workerå´©æºƒé—®é¢˜è¯Šæ–­æŠ¥å‘Š.md**
2. **docs/ç™»å½•åŠŸèƒ½å®Œæ•´è¯Šæ–­æŠ¥å‘Š.md**
3. **docs/ç™»å½•é—®é¢˜æœ€ç»ˆæ€»ç»“.md** (æœ¬æ–‡ä»¶)
4. **tests/å¿«é€Ÿç™»å½•æµ‹è¯•.js**
5. **tests/æµ‹è¯•ç™»å½•è¯·æ±‚.js** (å·²ä¿®å¤äº‹ä»¶å)

---

## âœ… æˆåŠŸæ ‡å‡†

å½“ä»¥ä¸‹æ‰€æœ‰æ¡ä»¶æ»¡è¶³æ—¶ï¼Œç™»å½•åŠŸèƒ½è§†ä¸ºå®Œå…¨ä¿®å¤ï¼š

1. âœ… Worker èƒ½æ¥æ”¶ç™»å½•è¯·æ±‚ï¼ˆçœ‹åˆ° [handleLoginRequest] æ—¥å¿—ï¼‰
2. âœ… Worker èƒ½æ­£ç¡®è°ƒç”¨ `platformInstance.startLogin(accountId, sessionId, proxy)`
3. âœ… æµè§ˆå™¨æ­£å¸¸æ‰“å¼€å¹¶åŠ è½½ç™»å½•é¡µé¢
4. âœ… Worker æ£€æµ‹åˆ°äºŒç»´ç å¹¶å‘é€ `qrcode_ready` çŠ¶æ€
5. âœ… Master æ¥æ”¶çŠ¶æ€å¹¶è½¬å‘åˆ° Admin Web
6. âœ… Admin Web æ˜¾ç¤ºäºŒç»´ç 
7. âœ… æ‰«ç åæµè§ˆå™¨è·³è½¬åˆ°åˆ›ä½œä¸­å¿ƒ
8. âœ… Worker å‘é€ `success` çŠ¶æ€
9. âœ… Admin Web æ˜¾ç¤º"ç™»å½•æˆåŠŸ"

---

## ğŸ’¡ ç»éªŒæ•™è®­

### 1. å‚æ•°ä¼ é€’ä¸€è‡´æ€§

- **æ•™è®­**: æ–¹æ³•å®šä¹‰å’Œè°ƒç”¨å¿…é¡»ä¿æŒä¸€è‡´
- **å»ºè®®**: ç»Ÿä¸€ä½¿ç”¨å¯¹è±¡å‚æ•° `{ param1, param2 }` æˆ–å…¨éƒ¨ä½¿ç”¨ç‹¬ç«‹å‚æ•°
- **æœ€ä½³å®è·µ**: å¯¹äº3ä¸ªä»¥ä¸Šå‚æ•°ï¼Œä½¿ç”¨å¯¹è±¡å‚æ•°æ›´æ˜“ç»´æŠ¤

### 2. æ—¥å¿—å¯è§æ€§

- **é—®é¢˜**: Master å¯åŠ¨çš„ Worker å­è¿›ç¨‹æ—¥å¿—ä¸å¯è§
- **å½±å“**: è°ƒè¯•å›°éš¾ï¼Œé—®é¢˜éš¾ä»¥å®šä½
- **å»ºè®®**:
  - å°†å­è¿›ç¨‹ stdout/stderr é‡å®šå‘åˆ° Master æ—¥å¿—
  - æˆ–æä¾›ç¯å¢ƒå˜é‡å…è®¸ Worker ç‹¬ç«‹æ—¥å¿—

### 3. ä»£ç çƒ­é‡è½½

- **é—®é¢˜**: Node.js ä¸ä¼šè‡ªåŠ¨é‡æ–°åŠ è½½å·²ä¿®æ”¹çš„æ–‡ä»¶
- **å½±å“**: ä¿®æ”¹ä»£ç åå¿…é¡»é‡å¯è¿›ç¨‹
- **å»ºè®®**:
  - å¼€å‘ç¯å¢ƒä½¿ç”¨ nodemon æˆ–ç±»ä¼¼å·¥å…·
  - æˆ–å®ç°ä¼˜é›…é‡å¯æœºåˆ¶

### 4. å‚æ•°éªŒè¯

- **å»ºè®®**: åœ¨å…³é”®å‡½æ•°å…¥å£æ·»åŠ å‚æ•°ç±»å‹å’Œæ ¼å¼éªŒè¯
- **ç¤ºä¾‹**:
  ```javascript
  async startLogin(accountId, sessionId, proxyConfig) {
    if (typeof accountId !== 'string') {
      throw new TypeError('accountId must be a string');
    }
    // ...
  }
  ```

---

## ğŸ‰ æ€»ç»“

æ‰€æœ‰å…³é”®é—®é¢˜å·²ç»è¯†åˆ«å¹¶ä¿®å¤ï¼š

1. âœ… **å‚æ•°ä¼ é€’ä¿®å¤** - `startLogin` ä½¿ç”¨æ­£ç¡®çš„å‚æ•°æ ¼å¼
2. âœ… **é”™è¯¯å¤„ç†ä¿®å¤** - `sendLoginStatus` å‚æ•°é¡ºåºæ­£ç¡®
3. âœ… **ç™»å½•åå¯¼èˆª** - ç¡®ä¿è·³è½¬åˆ°åˆ›ä½œä¸­å¿ƒ
4. âœ… **æµ‹è¯•éªŒè¯** - ä¿®å¤å·²é€šè¿‡æ¨¡æ‹Ÿæµ‹è¯•

**åªéœ€é‡å¯ Worker è¿›ç¨‹ï¼Œä¿®å¤å³å¯ç”Ÿæ•ˆï¼**

---

**æŠ¥å‘Šäºº**: Claude Code Assistant
**å®Œæˆæ—¶é—´**: 2025-10-24 11:10
**çŠ¶æ€**: âœ… ä¿®å¤å®Œæˆï¼Œç­‰å¾…é‡å¯éªŒè¯
**ä¼˜å…ˆçº§**: ğŸ”¥ æœ€é«˜ - æ ¸å¿ƒåŠŸèƒ½
