# 爬虫数据质量问题报告

**检查时间**: 2025-10-24
**检查范围**: 私信爬虫抓取的数据质量
**状态**: ⚠️ 发现多个严重问题

---

## 数据统计

当前数据库中的数据：
- 📩 私信总数: **15条**
- 💬 会话总数: **10个**
- 💭 评论总数: **4条**

---

## 🔴 严重问题

### 问题1: 会话列表提取错误 - 抓取了导航菜单

**现象**：

会话列表中的数据：
```
[1] 首页
[2] 内容管理
[3] 互动管理关注管理粉丝管理评论管理弹幕管理私信管理
[4] 关注管理
[5] 粉丝管理
[6] 评论管理
[7] 弹幕管理
[8] 私信管理
[9] 变现中心
[10] 创作中心
```

**问题分析**：

这些明显是抖音创作者中心的**侧边栏导航菜单**，不是真实的私信会话！

**根本原因**：

[crawl-direct-messages-v2.js:400-414](../packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js#L400-L414) 使用了过于宽泛的选择器：

```javascript
const selectorsToTry = [
  '[role="list"] [role="list-item"]',  // ❌ 会匹配所有列表项
  '[class*="conversation-item"]',
  'li'                                  // ❌ 会匹配所有 li 元素
];
```

第一个选择器 `[role="list"] [role="list-item"]` 会匹配到：
- ✅ 私信会话列表的 list-item
- ❌ 侧边栏导航菜单的 list-item
- ❌ 页面顶部标签的 list-item
- ❌ 任何其他使用 ARIA role 的列表

**影响**：

- ❌ 会话列表数据完全错误
- ❌ 无法根据会话列表打开正确的会话
- ❌ 导致爬虫逻辑失效

**建议修复**：

使用更精确的选择器，只匹配私信会话区域的列表：

```javascript
const selectorsToTry = [
  // ✅ 方案1: 限定在私信内容区域
  '.chat-content [role="list-item"]',

  // ✅ 方案2: 使用更具体的父容器
  '[class*="conversation"] [role="list-item"]',

  // ✅ 方案3: 排除导航区域
  'main [role="list-item"]:not(nav [role="list-item"])'
];
```

---

### 问题2: 私信数据缺少发送者/接收者信息

**现象**：

所有私信记录中：
- `platform_sender_name`: NULL（对于 inbound 消息）
- `platform_receiver_name`: NULL（对于所有消息）
- 只有 outbound 消息有 `platform_sender_id: "self"` 和 `platform_sender_name: "Me"`

**数据示例**：

```json
{
  "platform_sender_id": "self",
  "platform_sender_name": "Me",        // ✅ outbound 有
  "platform_receiver_id": null,         // ❌ 应该有对方的ID
  "platform_receiver_name": null,       // ❌ 应该有对方的名字
  "direction": "outbound"
}
```

```json
{
  "platform_sender_id": null,           // ❌ 应该有对方的ID
  "platform_sender_name": null,         // ❌ 应该有对方的名字
  "platform_receiver_id": null,
  "platform_receiver_name": null,
  "direction": "inbound"
}
```

**影响**：

- ❌ 无法知道是谁发的消息（inbound）
- ❌ 无法知道发给谁的消息（outbound）
- ❌ 数据无法用于分析用户互动
- ❌ 通知推送时无法显示发送者名字

**建议修复**：

1. **从会话上下文获取用户信息**：
   - 打开会话时记录 `conversation.platform_user_name`
   - inbound 消息：sender = conversation 用户
   - outbound 消息：receiver = conversation 用户

2. **从 API 响应中提取**：
   - 使用拦截到的 API 数据
   - 提取 `sender_user_id`, `sender_nickname`

---

### 问题3: 消息类型为数字 "7" 而不是可读类型

**现象**：

所有消息的 `message_type` 都是 `"7"`：

```
消息类型分布:
7: 15 条
```

**预期**：

应该是可读的类型：
- `"text"` - 文本消息
- `"image"` - 图片消息
- `"video"` - 视频消息
- `"audio"` - 语音消息
- `"file"` - 文件消息

**根本原因**：

爬虫代码直接使用了抖音 API 返回的原始 `type` 字段值（数字），没有进行映射转换。

**影响**：

- ❌ 数据可读性差
- ❌ 无法通过类型过滤消息
- ❌ 前端显示需要额外的映射逻辑

**建议修复**：

创建类型映射表：

```javascript
const MESSAGE_TYPE_MAP = {
  1: 'text',
  2: 'image',
  3: 'video',
  4: 'audio',
  5: 'file',
  7: 'text',  // 可能是富文本或特殊文本
  // ... 其他类型
};

const messageType = MESSAGE_TYPE_MAP[apiResponse.type] || 'unknown';
```

---

### 问题4: 时间戳异常 - 未来的时间

**现象**：

数据中的时间戳显示为**未来的时间**：

```
检测时间: 2025/10/24 21:10:48  ← 未来！
抓取时间: 2025/10/21 15:32:32  ← 未来！
```

实际当前时间应该是 2025-01-24 左右（根据上下文推测）。

**可能原因**：

1. **时间戳单位错误**：
   - 如果后端使用毫秒时间戳，但没除以1000
   - `1761031952000` (毫秒) → `1761031952` (当成秒) = 2025年

2. **系统时间错误**：
   - 服务器系统时间设置错误

3. **时区转换问题**：
   - UTC vs 本地时间混淆

**验证**：

当前时间戳 `1761031952` 转换：
```javascript
new Date(1761031952 * 1000)
// 输出: 2025-10-21T07:32:32.000Z
```

如果当前实际是 2025-01-24，那么这个时间戳确实是未来的。

**建议检查**：

1. 检查服务器系统时间
2. 检查爬虫代码中的时间戳生成：
   ```javascript
   Math.floor(Date.now() / 1000)  // 秒
   Date.now()                      // 毫秒
   ```

---

## 🟡 次要问题

### 问题5: 所有消息都有 message_id

虽然这不是问题，但值得注意：

```
有ID的消息: 15
无ID的消息: 0
```

这是好事，说明 API 拦截成功提取到了消息 ID。

### 问题6: 会话数量少于实际会话

截图显示有17个会话，但数据库只有10个：

```
会话总数: 10  ← 应该是 17
```

可能原因：
- 会话列表选择器匹配到的是导航菜单（10个菜单项）
- 真正的会话列表没有被提取

---

## 数据完整性检查

### ✅ 正确的部分

1. **消息 ID 提取成功**：
   - 所有消息都有 `platform_message_id`
   - ID 格式正确：`"7563574607023179302"`

2. **消息方向识别正确**：
   - `direction: "inbound"` - 收到的消息
   - `direction: "outbound"` - 发出的消息

3. **消息内容提取成功**：
   - 文本内容完整
   - 内容可读

### ❌ 错误的部分

1. **会话列表完全错误** - 抓取了导航菜单
2. **缺少用户信息** - sender/receiver name/id 为空
3. **消息类型不可读** - 数字 "7" 而不是 "text"
4. **时间戳异常** - 显示未来时间

---

## 测试建议

### 1. 测试会话列表提取

创建测试脚本，打开私信页面后：

```javascript
// 测试不同选择器
const selectors = [
  '[role="list"] [role="list-item"]',           // 当前使用的
  '.chat-content [role="list-item"]',            // 建议的
  '[class*="conversation"] [role="list-item"]'   // 备用的
];

for (const selector of selectors) {
  const items = await page.locator(selector).all();
  console.log(`选择器: ${selector}`);
  console.log(`匹配数量: ${items.length}`);

  for (let i = 0; i < Math.min(3, items.length); i++) {
    const text = await items[i].textContent();
    console.log(`  [${i}] ${text.substring(0, 50)}`);
  }
}
```

**预期输出**：

```
选择器: [role="list"] [role="list-item"]
匹配数量: 27  ← 太多了！包含了导航菜单
  [0] 首页
  [1] 内容管理
  [2] 互动管理...

选择器: .chat-content [role="list-item"]
匹配数量: 17  ← 正确！
  [0] 夕阳正好12:26你收到一条新类型消息...
  [1] 珈宏11:57给您详细介绍一下...
  [2] 用户3537998782024zs昨天你收到一条...
```

### 2. 测试用户信息提取

打开一个会话后，检查：

```javascript
// 从会话标题提取用户名
const userName = await page.evaluate(() => {
  // 方法1: 从标题提取
  const title = document.querySelector('[class*="chat-header"]')?.textContent;

  // 方法2: 从会话元素的数据属性
  const userElement = document.querySelector('[data-user-id]');

  return { title, userId: userElement?.dataset.userId };
});

console.log('用户信息:', userName);
```

### 3. 测试消息类型映射

检查 API 响应中的 type 字段：

```javascript
// 统计所有消息的类型
const typeStats = {};
apiResponses.history.forEach(resp => {
  resp.data?.messages?.forEach(msg => {
    const type = msg.type || msg.message_type;
    typeStats[type] = (typeStats[type] || 0) + 1;
  });
});

console.log('消息类型分布:', typeStats);
// 预期: { 1: 5, 2: 3, 7: 10 }
```

---

## 修复优先级

| 优先级 | 问题 | 影响 | 修复难度 |
|--------|------|------|----------|
| 🔴 P0 | 会话列表提取错误 | 爬虫完全失效 | 简单（改选择器） |
| 🔴 P0 | 缺少用户信息 | 数据无法使用 | 中等（提取逻辑） |
| 🟡 P1 | 消息类型为数字 | 可读性差 | 简单（映射表） |
| 🟡 P1 | 时间戳异常 | 时间显示错误 | 简单（检查系统时间） |

---

## 下一步行动

1. **立即修复 P0 问题**：
   - 修复会话列表选择器
   - 添加用户信息提取逻辑

2. **创建测试脚本**：
   - 验证会话列表选择器
   - 验证用户信息提取

3. **重新抓取数据**：
   - 清空错误数据
   - 使用修复后的爬虫重新抓取

4. **数据验证**：
   - 检查会话列表是否正确
   - 检查用户信息是否完整
   - 检查时间戳是否合理

---

**报告生成时间**: 2025-10-24
**下一步**: 修复会话列表选择器和用户信息提取逻辑
