# Master ç³»ç»Ÿå¾…åŠäº‹é¡¹

**æ–‡æ¡£ç‰ˆæœ¬**: v1.3
**åˆ›å»ºæ—¶é—´**: 2025-10-31
**æœ€åæ›´æ–°**: 2025-11-03
**çŠ¶æ€**: è¿›è¡Œä¸­ (3/5 å·²å®Œæˆ)

---

## ğŸ“‹ å¾…åŠä»»åŠ¡æ¸…å•

### 1. ç§»é™¤åºŸå¼ƒçš„ API âœ…

**ä¼˜å…ˆçº§**: ğŸ”´ é«˜
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2025-11-03)

#### å·²ç§»é™¤çš„ API

**ä½ç½®**: `packages/master/src/api/routes/im/` (å·²åˆ é™¤)

å·²åˆ é™¤çš„åºŸå¼ƒ API ç«¯ç‚¹ï¼ˆ7 ä¸ªæ–‡ä»¶ï¼‰ï¼š

```
packages/master/src/api/routes/im/
â”œâ”€â”€ index.js             # IM API ä¸»è·¯ç”±
â”œâ”€â”€ accounts.js          # è´¦æˆ·ç›¸å…³ API
â”œâ”€â”€ messages.js          # æ¶ˆæ¯ç›¸å…³ API
â”œâ”€â”€ conversations.js     # ä¼šè¯ç›¸å…³ API
â”œâ”€â”€ contents.js          # ä½œå“ç›¸å…³ API
â”œâ”€â”€ discussions.js       # è®¨è®ºç›¸å…³ API
â””â”€â”€ unified-messages.js  # ç»Ÿä¸€æ¶ˆæ¯ API
```

#### ç§»é™¤éªŒè¯

- [x] ç¡®è®¤å“ªäº› API å·²è¢«æ–°çš„ IM WebSocket æœåŠ¡å™¨æ›¿ä»£
- [x] æ£€æŸ¥æ˜¯å¦æœ‰å®¢æˆ·ç«¯ä»åœ¨ä½¿ç”¨è¿™äº› APIï¼ˆç¡®è®¤æ— å®¢æˆ·ç«¯ä½¿ç”¨ï¼‰
- [x] åˆ é™¤æ‰€æœ‰ REST API æ–‡ä»¶
- [x] æ›´æ–° `packages/master/src/index.js` ç§»é™¤è·¯ç”±é…ç½®
- [x] åˆ›å»ºå˜æ›´è¯´æ˜æ–‡æ¡£

#### å®Œæˆå†…å®¹

1. **åˆ é™¤æ–‡ä»¶**: ç§»é™¤æ•´ä¸ª `packages/master/src/api/routes/im/` ç›®å½•
2. **æ›´æ–°è·¯ç”±**: ä¿®æ”¹ `index.js` ç¬¬ 1276-1277 è¡Œ,ç§»é™¤ IM API è·¯ç”±æŒ‚è½½
3. **æ–‡æ¡£**: åˆ›å»º `docs/åºŸå¼ƒREST-APIç§»é™¤è¯´æ˜.md` è®°å½•å˜æ›´è¯¦æƒ…

#### å‚è€ƒæ–‡æ¡£
- `packages/master/src/communication/im-websocket-server.js` - WebSocket æœåŠ¡å™¨ï¼ˆå®é™…ä½¿ç”¨ï¼‰
- `docs/åºŸå¼ƒREST-APIç§»é™¤è¯´æ˜.md` - ç§»é™¤è¯´æ˜æ–‡æ¡£

---

### 2. Master æ•°æ®æ—¶æ•ˆæ€§æ§åˆ¶

**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­
**çŠ¶æ€**: â³ å¾…å¤„ç†

#### éœ€æ±‚è¯´æ˜

å½“å‰ Master çš„ DataStore æ˜¯çº¯å†…å­˜æ•°æ®ç»“æ„ï¼Œç¼ºä¹æ—¶æ•ˆæ€§æ§åˆ¶æœºåˆ¶ã€‚éœ€è¦å®ç°ï¼š

#### å®ç°è¦ç‚¹

1. **æ•°æ®è¿‡æœŸç­–ç•¥**
   - [ ] è¯„è®ºæ•°æ®ï¼šä¿ç•™æœ€è¿‘ 7 å¤©
   - [ ] ç§ä¿¡æ•°æ®ï¼šä¿ç•™æœ€è¿‘ 30 å¤©
   - [ ] é€šçŸ¥æ•°æ®ï¼šä¿ç•™æœ€è¿‘ 3 å¤©
   - [ ] ç™»å½•ä¼šè¯ï¼šä¿ç•™æœ€è¿‘ 24 å°æ—¶

2. **å®šæ—¶æ¸…ç†æœºåˆ¶**
   ```javascript
   // ç¤ºä¾‹ï¼šæ¯å°æ—¶æ¸…ç†ä¸€æ¬¡è¿‡æœŸæ•°æ®
   setInterval(() => {
     dataStore.cleanExpiredData();
   }, 60 * 60 * 1000);
   ```

3. **é…ç½®åŒ–æ—¶æ•ˆå‚æ•°**
   ```javascript
   // packages/master/src/config/data-retention.js
   module.exports = {
     comments: 7 * 24 * 60 * 60 * 1000,      // 7 å¤©
     directMessages: 30 * 24 * 60 * 60 * 1000, // 30 å¤©
     notifications: 3 * 24 * 60 * 60 * 1000,   // 3 å¤©
     loginSessions: 24 * 60 * 60 * 1000        // 24 å°æ—¶
   };
   ```

#### å½±å“èŒƒå›´
- `packages/master/src/worker_manager/data-store.js`
- `packages/master/src/communication/im-websocket-server.js`

---

### 3. æ•°æ®åº“è¡¨æ ¼æŒ‰é€šç”¨æ ¼å¼è®¾è®¡

**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­
**çŠ¶æ€**: â³ å¾…å¤„ç†

#### å½“å‰é—®é¢˜

Master æ•°æ®åº“ schema ç¼ºå°‘æ ‡å‡†åŒ–çš„é€šç”¨å­—æ®µï¼š

#### éœ€è¦æ·»åŠ çš„é€šç”¨å­—æ®µ

**æ‰€æœ‰è¡¨éƒ½åº”åŒ…å«**:
```sql
-- æ—¶é—´æˆ³å­—æ®µ
created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
updated_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),

-- è½¯åˆ é™¤å­—æ®µ
deleted_at INTEGER DEFAULT NULL,
is_deleted INTEGER DEFAULT 0,

-- æ•°æ®ç‰ˆæœ¬å­—æ®µï¼ˆç”¨äºä¹è§‚é”ï¼‰
version INTEGER DEFAULT 1,

-- å®¡è®¡å­—æ®µ
created_by TEXT DEFAULT NULL,
updated_by TEXT DEFAULT NULL
```

#### éœ€è¦ä¿®æ”¹çš„è¡¨

- [ ] `comments` è¡¨ - æ·»åŠ  `updated_at`, `deleted_at`, `version`
- [ ] `direct_messages` è¡¨ - æ·»åŠ  `updated_at`, `deleted_at`, `version`
- [ ] `conversations` è¡¨ - æ·»åŠ  `updated_at`, `deleted_at`, `version`
- [ ] `replies` è¡¨ - æ·»åŠ  `updated_at`, `deleted_at`, `version`
- [ ] `notifications` è¡¨ - æ·»åŠ  `updated_at`, `deleted_at`, `version`
- [ ] `login_sessions` è¡¨ - æ·»åŠ  `updated_at`, `deleted_at`, `version`

#### è‡ªåŠ¨è§¦å‘å™¨

```sql
-- è‡ªåŠ¨æ›´æ–° updated_at
CREATE TRIGGER update_{table_name}_timestamp
AFTER UPDATE ON {table_name}
FOR EACH ROW
BEGIN
  UPDATE {table_name} SET updated_at = strftime('%s', 'now')
  WHERE id = NEW.id;
END;
```

#### è¿ç§»æ­¥éª¤

1. [ ] åˆ›å»ºæ–°çš„ schema æ–‡ä»¶: `packages/master/src/database/schema-v2.sql`
2. [ ] ç¼–å†™è¿ç§»è„šæœ¬: `packages/master/src/database/migrations/001_add_common_fields.sql`
3. [ ] æ›´æ–°æ‰€æœ‰ DAO ç±»ä»¥æ”¯æŒæ–°å­—æ®µ
4. [ ] æ›´æ–° schema-validator.js
5. [ ] æµ‹è¯•è¿ç§»è„šæœ¬
6. [ ] åº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒ

---

### 4. Master æ•°æ®æŒä¹…åŒ– âœ…

**ä¼˜å…ˆçº§**: ğŸ”´ é«˜
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2025-11-03)

#### å®ç°æ¦‚è¿°

å·²å®ç°å®Œæ•´çš„ Master æ•°æ®æŒä¹…åŒ–ç³»ç»Ÿï¼Œè§£å†³äº† DataStore çº¯å†…å­˜æ•°æ®ä¸¢å¤±å’Œå†…å­˜å¢é•¿é—®é¢˜ã€‚

#### æ ¸å¿ƒç‰¹æ€§

1. **å†…å­˜ä¼˜å…ˆæ¶æ„**: æ‰€æœ‰æ“ä½œåœ¨å†…å­˜ä¸­è¿›è¡Œï¼Œæ•°æ®åº“ä½œä¸ºå¤‡ä»½
2. **é›¶è½¬æ¢æˆæœ¬**: æ•°æ®åº“ä½¿ç”¨ JSON å­˜å‚¨ï¼Œä¸å†…å­˜ç»“æ„å®Œå…¨ä¸€è‡´
3. **å¢é‡æŒä¹…åŒ–**: ä½¿ç”¨è„æ ‡è®°ï¼ˆDirty Flagï¼‰æœºåˆ¶ï¼ŒåªæŒä¹…åŒ–å˜æ›´æ•°æ®
4. **è‡ªåŠ¨å¯åŠ¨åŠ è½½**: Master å¯åŠ¨æ—¶ä»æ•°æ®åº“æ¢å¤æœ€è¿‘æ•°æ®
5. **å®šæœŸè‡ªåŠ¨æŒä¹…åŒ–**: æ¯ 5 åˆ†é’Ÿè‡ªåŠ¨æŒä¹…åŒ–ä¸€æ¬¡
6. **ä¼˜é›…å…³é—­**: SIGTERM/SIGINT è§¦å‘æœ€ç»ˆæŒä¹…åŒ–
7. **æ•°æ®è¿‡æœŸæ¸…ç†**: æŒ‰æ•°æ®ç±»å‹é…ç½®ä¸åŒçš„ä¿ç•™ç­–ç•¥
8. **è°ƒè¯• API**: 5 ä¸ª DEBUG API ç«¯ç‚¹ç”¨äºç›‘æ§å’Œæ‰‹åŠ¨æ§åˆ¶

#### å·²å®ç°åŠŸèƒ½

**Phase 1: æ•°æ®åº“ Schema** âœ…
- [x] åˆ›å»º `cache-schema.sql` - 6 ä¸ªç¼“å­˜è¡¨ï¼ˆmetadata, comments, contents, conversations, messages, notificationsï¼‰
- [x] å®ç° `cache-schema-validator.js` - Schema å®Œæ•´æ€§éªŒè¯å·¥å…·
- [x] åˆ›å»º `data-retention.js` - æ•°æ®ä¿ç•™ç­–ç•¥é…ç½®
- [x] å¯ç”¨ WAL æ¨¡å¼ - æ”¯æŒå¹¶å‘è¯»å†™

**Phase 2: æŒä¹…åŒ–å±‚** âœ…
- [x] å®ç° `CacheDAO` ç±» - æ•°æ®è®¿é—®å±‚ï¼ˆ500 è¡Œä»£ç ï¼‰
  - æ‰¹é‡ UPSERT æ“ä½œï¼ˆäº‹åŠ¡æ”¯æŒï¼‰
  - æŒ‰è´¦æˆ·æŸ¥è¯¢æ•°æ®
  - è¿‡æœŸæ•°æ®æ¸…ç†æ–¹æ³•
  - é¢„ç¼–è¯‘ SQL è¯­å¥ä¼˜åŒ–
- [x] å®ç° `PersistenceManager` ç±» - æŒä¹…åŒ–ç®¡ç†å™¨ï¼ˆ580 è¡Œä»£ç ï¼‰
  - å¯åŠ¨æ—¶ä»æ•°æ®åº“åŠ è½½æ•°æ®
  - å®šæœŸæŒä¹…åŒ–ï¼ˆ5 åˆ†é’Ÿé—´éš”ï¼‰
  - ä¼˜é›…å…³é—­å¤„ç†
  - å®šæ—¶æ¸…ç†è¿‡æœŸæ•°æ®

**Phase 3: DataStore å¢å¼º** âœ…
- [x] æ·»åŠ è„æ ‡è®°æœºåˆ¶ï¼ˆDirty Flagï¼‰
- [x] å®ç° `exportDirtySnapshot()` - å¢é‡å¯¼å‡º
- [x] å®ç° `clearDirtyFlags()` - æ¸…ç†è„æ ‡è®°
- [x] å®ç° `cleanExpiredData()` - å†…å­˜æ•°æ®è¿‡æœŸæ¸…ç†
- [x] ç»¼åˆæµ‹è¯•é€šè¿‡ï¼ˆ100%ï¼‰

**Phase 4: Master é›†æˆ** âœ…
- [x] é›†æˆ PersistenceManager åˆ° Master å¯åŠ¨æµç¨‹
- [x] æ·»åŠ  SIGTERM/SIGINT ä¼˜é›…å…³é—­å¤„ç†
- [x] åˆ›å»º 5 ä¸ª DEBUG API ç«¯ç‚¹ï¼š
  - `GET /api/debug/persistence/stats` - è·å–ç»Ÿè®¡ä¿¡æ¯
  - `POST /api/debug/persistence/persist` - æ‰‹åŠ¨æŒä¹…åŒ–
  - `POST /api/debug/persistence/reload` - é‡æ–°åŠ è½½æ•°æ®
  - `POST /api/debug/persistence/cleanup/:dataType` - æ¸…ç†è¿‡æœŸæ•°æ®
  - `GET /api/debug/persistence/cache-stats` - ç¼“å­˜è¡¨ç»Ÿè®¡

#### æ•°æ®ä¿ç•™ç­–ç•¥

**å†…å­˜ä¿ç•™æœŸ**:
- è¯„è®ºï¼ˆcommentsï¼‰: 7 å¤©
- ç§ä¿¡ï¼ˆmessagesï¼‰: 30 å¤©
- ä½œå“ï¼ˆcontentsï¼‰: 30 å¤©
- ä¼šè¯ï¼ˆconversationsï¼‰: 30 å¤©
- é€šçŸ¥ï¼ˆnotificationsï¼‰: 3 å¤©

**æ•°æ®åº“ä¿ç•™æœŸ**:
- è¯„è®ºï¼ˆcommentsï¼‰: 30 å¤©
- ç§ä¿¡ï¼ˆmessagesï¼‰: 90 å¤©
- ä½œå“ï¼ˆcontentsï¼‰: æ°¸ä¹…
- ä¼šè¯ï¼ˆconversationsï¼‰: 90 å¤©
- é€šçŸ¥ï¼ˆnotificationsï¼‰: 7 å¤©

#### æ€§èƒ½æ•°æ®

- **æŒä¹…åŒ–é€Ÿåº¦**: 2-5msï¼ˆ6 é¡¹æ•°æ®ï¼‰
- **åŠ è½½é€Ÿåº¦**: 2-4msï¼ˆ6 é¡¹æ•°æ®ï¼‰
- **å¢é‡æŒä¹…åŒ–**: 0-2msï¼ˆå•ä¸ªè´¦æˆ·ï¼‰
- **å†…å­˜å ç”¨**: æ¯è´¦æˆ·çº¦ 50KBï¼ˆ1000 æ¡æ¶ˆæ¯ï¼‰

#### æµ‹è¯•ç»“æœ

æµ‹è¯•è„šæœ¬: `tests/test-persistence.js`

```
âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ
âœ… æ•°æ®æŒä¹…åŒ–å®Œæˆ (2ms, 6 items)
âœ… æ•°æ®ä¸€è‡´æ€§éªŒè¯é€šè¿‡
âœ… å†…å­˜æ¸…ç©ºæˆåŠŸ
âœ… æ•°æ®åŠ è½½å®Œæˆ (2ms, 6 items)
âœ… åŠ è½½æ•°æ®ä¸€è‡´æ€§éªŒè¯é€šè¿‡
âœ… å¢é‡æŒä¹…åŒ–å®Œæˆ (0ms, 1 item)
âœ… æ•°æ®è¿‡æœŸæ¸…ç†å®Œæˆ
âœ… ç»Ÿè®¡ä¿¡æ¯è·å–æˆåŠŸ
âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
```

#### ç›¸å…³æ–‡ä»¶

**æ ¸å¿ƒå®ç°**:
- `packages/master/src/database/cache-schema.sql` - æ•°æ®åº“ Schema
- `packages/master/src/persistence/cache-dao.js` - æ•°æ®è®¿é—®å±‚
- `packages/master/src/persistence/persistence-manager.js` - æŒä¹…åŒ–ç®¡ç†å™¨
- `packages/master/src/data/data-store.js` - å¢å¼ºçš„ DataStore
- `packages/master/src/index.js` - Master é›†æˆ

**é…ç½®æ–‡ä»¶**:
- `packages/master/src/config/data-retention.js` - æ•°æ®ä¿ç•™é…ç½®

**æµ‹è¯•æ–‡ä»¶**:
- `tests/test-cache-schema.js` - Schema éªŒè¯æµ‹è¯•
- `tests/test-persistence.js` - æŒä¹…åŒ–åŠŸèƒ½æµ‹è¯•

**æ–‡æ¡£**:
- `docs/Masteræ•°æ®æŒä¹…åŒ–å¼€å‘æ–¹æ¡ˆ.md` - å®Œæ•´è®¾è®¡æ–¹æ¡ˆ

#### åç»­ä¼˜åŒ–å»ºè®®

1. **æ€§èƒ½ç›‘æ§**: åœ¨ç”Ÿäº§ç¯å¢ƒç›‘æ§æŒä¹…åŒ–æ€§èƒ½ï¼Œæ ¹æ®å®é™…æ•°æ®é‡è°ƒæ•´é—´éš”
2. **å¤‡ä»½ç­–ç•¥**: è€ƒè™‘å®ç°æ•°æ®åº“å®šæœŸå¤‡ä»½åŠŸèƒ½
3. **Redis æ”¯æŒ**: å¦‚æœ‰é«˜å¹¶å‘éœ€æ±‚ï¼Œå¯æ·»åŠ  Redis é€‚é…å™¨ï¼ˆå¯é€‰ï¼‰
4. **å‹ç¼©å­˜å‚¨**: å¯¹å†å²æ•°æ®å®ç°å‹ç¼©å­˜å‚¨ä»¥èŠ‚çœç©ºé—´ï¼ˆå¯é€‰ï¼‰

---

### 5. Master æ•°æ®å·²è¯»çŠ¶æ€å¤„ç† âœ…

**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2025-11-03)

#### å®ç°æ¦‚è¿°

å·²å®Œæ•´å®ç° Master æ•°æ®å·²è¯»çŠ¶æ€å¤„ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ•°æ®åº“ Schema å˜æ›´ã€DAO å±‚æ–¹æ³•ã€WebSocket äº‹ä»¶å¤„ç†å’Œæµ‹è¯•éªŒè¯ã€‚

#### æ ¸å¿ƒç‰¹æ€§

1. **å·²è¯»æ—¶é—´æˆ³**: ç²¾ç¡®è®°å½•æ¯æ¡æ¶ˆæ¯çš„å·²è¯»æ—¶é—´
2. **æ‰¹é‡æ“ä½œ**: æ”¯æŒä¸€æ¬¡æ€§æ ‡è®°å¤šæ¡æ¶ˆæ¯
3. **çµæ´»æŸ¥è¯¢**: æŒ‰è´¦æˆ·ã€ä½œå“ã€ä¼šè¯ç»´åº¦æŸ¥è¯¢å’Œæ ‡è®°
4. **å®æ—¶é€šçŸ¥**: WebSocket å¹¿æ’­å·²è¯»çŠ¶æ€å˜æ›´
5. **é«˜æ•ˆç´¢å¼•**: ä¼˜åŒ–æœªè¯»æŸ¥è¯¢æ€§èƒ½

#### å·²å®ç°åŠŸèƒ½

**Phase 1: æ•°æ®åº“ Schema å˜æ›´** âœ…
- [x] æ·»åŠ  `read_at` å­—æ®µåˆ° comments è¡¨
- [x] æ·»åŠ  `read_at` å­—æ®µåˆ° direct_messages è¡¨
- [x] åˆ›å»ºæœªè¯»æŸ¥è¯¢ä¼˜åŒ–ç´¢å¼•ï¼ˆ4 ä¸ªï¼‰
- [x] ç¼–å†™æ•°æ®åº“è¿ç§»è„šæœ¬

**Phase 2: DAO å±‚å®ç°** âœ…

*CommentsDAO æ–°å¢æ–¹æ³•*:
- [x] `markAsRead(id, readAt)` - å•æ¡æ ‡è®°ï¼ˆæ”¯æŒ read_atï¼‰
- [x] `markBatchAsRead(ids, readAt)` - æ‰¹é‡æ ‡è®°
- [x] `markTopicAsRead(postId, accountId, readAt)` - æŒ‰ä½œå“æ ‡è®°
- [x] `countUnread(accountId)` - ç»Ÿè®¡æœªè¯»
- [x] `countUnreadByAccount()` - æŒ‰è´¦æˆ·ç»Ÿè®¡

*DirectMessagesDAO æ–°å¢æ–¹æ³•*:
- [x] `markAsRead(id, readAt)` - å•æ¡æ ‡è®°ï¼ˆæ”¯æŒ read_atï¼‰
- [x] `markBatchAsRead(ids, readAt)` - æ‰¹é‡æ ‡è®°
- [x] `markConversationAsRead(conversationId, accountId, readAt)` - æŒ‰ä¼šè¯æ ‡è®°
- [x] `countUnread(accountId)` - ç»Ÿè®¡æœªè¯»
- [x] `countUnreadByAccount()` - æŒ‰è´¦æˆ·ç»Ÿè®¡

**Phase 3: WebSocket äº‹ä»¶å¤„ç†** âœ…

*æ–°å¢ WebSocket äº‹ä»¶* (5 ä¸ª):
- [x] `monitor:mark_as_read` - å•æ¡æ¶ˆæ¯æ ‡è®°å·²è¯»
- [x] `monitor:mark_batch_as_read` - æ‰¹é‡æ ‡è®°å·²è¯»
- [x] `monitor:mark_topic_as_read` - æŒ‰ä½œå“æ ‡è®°æ‰€æœ‰è¯„è®ºå·²è¯»
- [x] `monitor:mark_conversation_as_read` - æŒ‰ä¼šè¯æ ‡è®°æ‰€æœ‰ç§ä¿¡å·²è¯»
- [x] `monitor:get_unread_count` - è·å–æœªè¯»è®¡æ•°

*å¹¿æ’­äº‹ä»¶* (5 ä¸ª):
- [x] `monitor:message_read` - å•æ¡å·²è¯»é€šçŸ¥
- [x] `monitor:messages_read` - æ‰¹é‡å·²è¯»é€šçŸ¥
- [x] `monitor:topic_read` - ä½œå“å·²è¯»é€šçŸ¥
- [x] `monitor:conversation_read` - ä¼šè¯å·²è¯»é€šçŸ¥
- [x] `monitor:unread_count_response` - æœªè¯»è®¡æ•°å“åº”

**Phase 4: æµ‹è¯•éªŒè¯** âœ…
- [x] ç¼–å†™å®Œæ•´æµ‹è¯•è„šæœ¬ï¼ˆ12 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- [x] CommentsDAO åŠŸèƒ½æµ‹è¯•
- [x] DirectMessagesDAO åŠŸèƒ½æµ‹è¯•
- [x] read_at å­—æ®µéªŒè¯
- [x] æœªè¯»è®¡æ•°éªŒè¯
- [x] æ‰€æœ‰æµ‹è¯•é€šè¿‡ âœ…

#### ä½¿ç”¨ç¤ºä¾‹

**å®¢æˆ·ç«¯æ ‡è®°å•æ¡æ¶ˆæ¯å·²è¯»**:
```javascript
socket.emit('monitor:mark_as_read', {
  type: 'comment',  // æˆ– 'message'
  id: 'comment_id',
  channelId: 'account_id'
});

// ç›‘å¬å¹¿æ’­
socket.on('monitor:message_read', (data) => {
  console.log('Message read:', data.id, data.read_at);
});
```

**æ‰¹é‡æ ‡è®°å·²è¯»**:
```javascript
socket.emit('monitor:mark_batch_as_read', {
  type: 'comment',
  ids: ['id1', 'id2', 'id3'],
  channelId: 'account_id'
});
```

**è·å–æœªè¯»è®¡æ•°**:
```javascript
socket.emit('monitor:get_unread_count', {
  channelId: 'account_id'  // å¯é€‰ï¼Œä¸ä¼ åˆ™è·å–æ‰€æœ‰é¢‘é“
});

socket.on('monitor:unread_count_response', (data) => {
  console.log('Unread:', data.unread.total);
});
```

#### æ€§èƒ½æ•°æ®

- **æ‰¹é‡æ ‡è®°**: 5 æ¡æ¶ˆæ¯ < 5ms
- **ä¼šè¯æ ‡è®°**: 2 æ¡æ¶ˆæ¯ < 3ms
- **æœªè¯»ç»Ÿè®¡**: < 2msï¼ˆæœ‰ç´¢å¼•ä¼˜åŒ–ï¼‰
- **æ•°æ®åº“æ“ä½œ**: ä½¿ç”¨äº‹åŠ¡ï¼Œä¿è¯åŸå­æ€§

#### æµ‹è¯•ç»“æœ

æµ‹è¯•è„šæœ¬: `tests/test-read-status.js`

```
âœ… CommentsDAO: 6/6 æµ‹è¯•é€šè¿‡
âœ… MessagesDAO: 6/6 æµ‹è¯•é€šè¿‡
âœ… æ‰¹é‡æ ‡è®°: 5 æ¡æˆåŠŸ
âœ… ä¼šè¯æ ‡è®°: 2 æ¡æˆåŠŸ
âœ… æœªè¯»è®¡æ•°: 43 â†’ 35
âœ… read_at å­—æ®µ: 8 æ¡å·²è®¾ç½®
```

#### ç›¸å…³æ–‡ä»¶

**æ ¸å¿ƒå®ç°**:
- `packages/master/src/database/comments-dao.js` - CommentsDAO å¢å¼ºï¼ˆ+129 è¡Œï¼‰
- `packages/master/src/database/messages-dao.js` - MessagesDAO å¢å¼ºï¼ˆ+125 è¡Œï¼‰
- `packages/master/src/communication/im-websocket-server.js` - WebSocket äº‹ä»¶ï¼ˆ+285 è¡Œï¼‰
- `packages/master/src/index.js` - Master é›†æˆ

**è¿ç§»è„šæœ¬**:
- `packages/master/src/database/migrations/add-read-at-field.sql` - SQL è¿ç§»
- `packages/master/src/database/migrations/migrate-read-at.js` - æ‰§è¡Œè„šæœ¬

**æµ‹è¯•æ–‡ä»¶**:
- `tests/test-read-status.js` - åŠŸèƒ½æµ‹è¯•ï¼ˆ220 è¡Œï¼‰

**æ–‡æ¡£**:
- `docs/Masteræ•°æ®å·²è¯»çŠ¶æ€å¤„ç†è®¾è®¡æ–¹æ¡ˆ.md` - å®Œæ•´è®¾è®¡æ–‡æ¡£

#### åç»­ä¼˜åŒ–å»ºè®®

1. **PC IM å‰ç«¯é›†æˆ**: åœ¨ MonitorPage.tsx ä¸­è°ƒç”¨å·²è¯» API
2. **è‡ªåŠ¨æ ‡è®°å·²è¯»**: å®ç°æ¶ˆæ¯æŸ¥çœ‹åè‡ªåŠ¨æ ‡è®°ï¼ˆå¯é€‰ï¼‰
3. **å·²è¯»å›æ‰§**: æ˜¾ç¤ºæ¶ˆæ¯è¢«è°è¯»è¿‡ï¼ˆå¤šç”¨æˆ·åœºæ™¯ï¼‰
4. **æ€§èƒ½ç›‘æ§**: åœ¨ç”Ÿäº§ç¯å¢ƒç›‘æ§å·²è¯»æ“ä½œæ€§èƒ½

---

## ğŸ“Š ä»»åŠ¡ä¼˜å…ˆçº§çŸ©é˜µ

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | å¤æ‚åº¦ | é¢„è®¡å·¥æ—¶ | å®é™…å·¥æ—¶ | çŠ¶æ€ |
|------|--------|--------|----------|----------|------|
| ç§»é™¤åºŸå¼ƒçš„ API | ğŸ”´ é«˜ | ä½ | 4 å°æ—¶ | 2 å°æ—¶ | âœ… å·²å®Œæˆ |
| Master æ•°æ®æŒä¹…åŒ– | ğŸ”´ é«˜ | é«˜ | 16 å°æ—¶ | 12 å°æ—¶ | âœ… å·²å®Œæˆ |
| æ•°æ®å·²è¯»çŠ¶æ€å¤„ç† | ğŸŸ¡ ä¸­ | ä¸­ | 8 å°æ—¶ | 5 å°æ—¶ | âœ… å·²å®Œæˆ |
| æ•°æ®æ—¶æ•ˆæ€§æ§åˆ¶ | ğŸŸ¡ ä¸­ | ä¸­ | 8 å°æ—¶ | - | ğŸ”„ éƒ¨åˆ†å®Œæˆ |
| æ•°æ®åº“è¡¨æ ¼æ ‡å‡†åŒ– | ğŸŸ¡ ä¸­ | é«˜ | 12 å°æ—¶ | - | â³ å¾…å¤„ç† |

**æ€»è®¡**: çº¦ 48 å°æ—¶ï¼ˆ6 ä¸ªå·¥ä½œæ—¥ï¼‰
**å·²å®Œæˆ**: 19 å°æ—¶ï¼ˆ3 ä¸ªä»»åŠ¡ï¼‰
**å‰©ä½™**: 20 å°æ—¶ï¼ˆ2.5 ä¸ªå·¥ä½œæ—¥ï¼‰

**æ³¨**:
- æ•°æ®æ—¶æ•ˆæ€§æ§åˆ¶å·²é€šè¿‡æŒä¹…åŒ–ç³»ç»Ÿéƒ¨åˆ†å®ç°ï¼ˆæ•°æ®è¿‡æœŸæ¸…ç†ï¼‰ï¼Œä½†ä»éœ€æ·»åŠ æ›´ç»†ç²’åº¦çš„é…ç½®å’Œç›‘æ§
- æ•°æ®å·²è¯»çŠ¶æ€å¤„ç†å®é™…è€—æ—¶ 5 å°æ—¶ï¼ˆPhase 1-4 å…¨éƒ¨å®Œæˆï¼‰

---

## ğŸ”„ å®æ–½é¡ºåºå»ºè®®

### ç¬¬ä¸€é˜¶æ®µï¼šç´§æ€¥ä¿®å¤ï¼ˆ1-2 å¤©ï¼‰âœ… å·²å®Œæˆ
1. âœ… **ç§»é™¤åºŸå¼ƒçš„ API** - å·²å®Œæˆ (2025-11-03ï¼Œ2 å°æ—¶)
2. âœ… **Master æ•°æ®æŒä¹…åŒ–** - å·²å®Œæˆ (2025-11-03ï¼Œ12 å°æ—¶)
   - å®ç°äº†å®Œæ•´çš„æŒä¹…åŒ–ç³»ç»Ÿ
   - è‡ªåŠ¨æ•°æ®åŠ è½½å’Œä¿å­˜
   - æ•°æ®è¿‡æœŸæ¸…ç†
   - DEBUG API ç«¯ç‚¹

### ç¬¬äºŒé˜¶æ®µï¼šåŠŸèƒ½å®Œå–„ï¼ˆ2-3 å¤©ï¼‰âœ… å·²å®Œæˆ
3. âœ… **æ•°æ®å·²è¯»çŠ¶æ€å¤„ç†** - å·²å®Œæˆ (2025-11-03ï¼Œ5 å°æ—¶)
   - æ•°æ®åº“ Schema å˜æ›´ï¼ˆread_at å­—æ®µ + ç´¢å¼•ï¼‰
   - DAO å±‚æ‰¹é‡å·²è¯»æ–¹æ³•
   - WebSocket å®æ—¶å·²è¯»äº‹ä»¶
   - å®Œæ•´çš„é›†æˆæµ‹è¯•
4. ğŸ”„ **æ•°æ®æ—¶æ•ˆæ€§æ§åˆ¶** - éƒ¨åˆ†å®Œæˆï¼ˆå·²å®ç°æ•°æ®è¿‡æœŸæ¸…ç†ï¼Œéœ€è¦ç»†ç²’åº¦é…ç½®ï¼‰

### ç¬¬ä¸‰é˜¶æ®µï¼šæŠ€æœ¯å€ºåŠ¡ï¼ˆ1-2 å¤©ï¼‰â³ å¾…å¼€å§‹
5. â³ **æ•°æ®åº“è¡¨æ ¼æ ‡å‡†åŒ–** - å¾…å¤„ç†ï¼ˆæå‡ä»£ç è´¨é‡ï¼‰

---

## ğŸ“ å¤‡æ³¨

- æ‰€æœ‰æ•°æ®åº“ schema å˜æ›´éœ€è¦ç¼–å†™è¿ç§»è„šæœ¬
- æ–°å¢åŠŸèƒ½éœ€è¦ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
- å®Œæˆåæ›´æ–°ç›¸å…³æ–‡æ¡£
- è€ƒè™‘å‘åå…¼å®¹æ€§ï¼Œé¿å…ç ´åç°æœ‰åŠŸèƒ½

---

**æ–‡æ¡£ç»´æŠ¤è€…**: Claude Code
**æœ€åæ›´æ–°**: 2025-11-03

## ğŸ“ˆ æ›´æ–°å†å²

- **v1.3** (2025-11-03): å®Œæˆæ•°æ®å·²è¯»çŠ¶æ€å¤„ç†ä»»åŠ¡ï¼ˆSchema + DAO + WebSocket + æµ‹è¯•ï¼‰
- **v1.2** (2025-11-03): å®Œæˆ Master æ•°æ®æŒä¹…åŒ–ä»»åŠ¡ï¼Œæ›´æ–°ä»»åŠ¡çŠ¶æ€å’Œè¿›åº¦
- **v1.1** (2025-11-03): å®ŒæˆåºŸå¼ƒ API ç§»é™¤ä»»åŠ¡
- **v1.0** (2025-10-31): åˆå§‹ç‰ˆæœ¬ï¼Œåˆ›å»ºå¾…åŠäº‹é¡¹æ¸…å•
