# 抖音平台基础框架重构说明

## 📋 概述

本次重构创建了一个全新的、干净的抖音平台基础框架，**仅保留登录相关功能**，移除了所有爬虫实现。这为后续基于 GlobalAPIInterceptor 的新架构爬虫实现奠定了基础。

**版本**: 2.0.0
**日期**: 2025-10-27
**文件**: `packages/worker/src/platforms/douyin/platform.js`

---

## ✅ 已实现的功能

### 1. 配置文件读取

**配置来源**: `packages/worker/src/platforms/douyin/config.json`

```javascript
// PlatformManager 会加载 config.json 并传给构造函数
class DouyinPlatform extends PlatformBase {
  constructor(config, workerBridge, browserManager) {
    super(config, workerBridge, browserManager);

    // 处理和扩展配置
    this.platformConfig = this.processPlatformConfig(config);
  }
}
```

**配置处理逻辑** (`processPlatformConfig`):
- ✅ 将逗号分隔的选择器字符串转换为数组
- ✅ 扩展额外的选择器（qrCodeCanvas, qrCodeContainer 等）
- ✅ 规范化 timeouts（使用 config.json 的值或默认值）
- ✅ 添加内容管理 URL

**config.json 示例**:
```json
{
  "platform": "douyin",
  "displayName": "抖音",
  "version": "1.0.0",
  "urls": {
    "home": "https://www.douyin.com/",
    "creatorCenter": "https://creator.douyin.com/",
    "commentManagement": "...",
    "messageManagement": "..."
  },
  "selectors": {
    "qrCodeImage": "img[alt*='二维码'], img[src*='qrcode'], canvas",
    "loginSuccess": ".user-info, .avatar"
  },
  "timeouts": {
    "loginCheck": 300000,
    "pageLoad": 15000
  }
}
```

### 2. 登录检测 (`detectLoginMethod`)

**功能**:
- 检查是否已登录（Cookie + 页面元素）
- 检测二维码登录方式
- 支持多种登录成功标识

**返回值**:
```javascript
{
  type: 'qrcode' | 'logged_in' | 'unknown',
  element?: ElementHandle,
  qrElements?: { image?, canvas?, container? }
}
```

**检测逻辑**:
1. 优先检查是否已登录（最高优先级）
2. 查找二维码元素（Image / Canvas / Container）
3. 未知登录方式

### 3. 登录状态检查 (`checkLoginStatus`)

**检查方式**:
- ✅ 页面元素检测（支持多个选择器）
- ✅ Cookie 检测（sessionid, sid, passport_csrf_token）

**选择器来源**: `config.json` 中的 `selectors.loginSuccess`

### 4. 二维码查找 (`findQRCodeElement`)

**支持的元素**:
- `qrCodeImage` - 二维码图片（支持数组形式的多个选择器）
- `qrCodeCanvas` - Canvas 元素
- `qrCodeContainer` - 二维码容器

**返回值**:
```javascript
{
  image?: ElementHandle,
  canvas?: ElementHandle,
  container?: ElementHandle
}
```

### 5. 二维码登录流程 (`handleQRCodeLogin`)

**流程**:
1. 提取二维码图片（Base64）
2. 发送二维码到 Master（`qrcode_ready` 状态）
3. 等待用户扫码（调用 `waitForLogin`）
4. 保存登录状态（Cookies + StorageState）
5. 发送登录成功消息

**参数配置**:
- `timeout`: 从 `config.json` 的 `timeouts.loginCheck`（默认 300000ms = 5分钟）
- `checkInterval`: 2000ms（每 2 秒检查一次）
- `qrRefreshInterval`: 3000ms（每 3 秒检查二维码是否刷新）

### 6. 二维码提取 (`extractQRCode`)

**提取策略**（三层降级）:
1. **优先**: 从 Canvas 提取（`canvas.toDataURL('image/png')`）
2. **次要**: 从 Image 元素提取（直接返回 Base64 或通过 Canvas 转换）
3. **降级**: 容器截图（`container.screenshot()`）

**支持数组选择器**: 如果 `qrCodeImage` 是数组，使用第一个选择器

### 7. 登录状态持久化 (`saveLoginState`)

**保存内容**:
- ✅ Cookies
- ✅ LocalStorage
- ✅ SessionStorage

**文件路径**: `data/browser/{workerId}/storage-states/{accountId}_storage.json`

### 8. 浏览器上下文管理 (`getOrCreateBrowserContext`)

**功能**:
- 复用已有上下文（节省内存）
- 支持代理配置
- 集成指纹管理

**上下文缓存**: `this.accountContexts` (Map)

### 9. 登录 API 接口 (`startLogin`)

**方法签名**（与旧版保持一致）:
```javascript
async startLogin(options) {
  const { accountId, sessionId, proxy = null } = options;
  // ...
}
```

**流程**:
1. 获取或创建浏览器上下文
2. 导航到登录页面
3. 检测登录方式
4. 根据登录方式处理（已登录 / 二维码登录）

---

## ⏸️ 待实现的功能（占位方法）

所有爬虫相关方法都已创建占位，调用时会抛出 `"not implemented yet"` 错误：

```javascript
async startMonitoring(accountId)         // 开始监控
async stopMonitoring(accountId)          // 停止监控
async crawlWorks(accountId)              // 爬取作品列表
async crawlComments(accountId)           // 爬取评论
async crawlDirectMessages(accountId)     // 爬取私信
async sendReply(accountId, replyData)    // 发送回复
```

**下一步**: 实现 GlobalAPIInterceptor，然后依次添加爬虫功能。

---

## 🔧 技术细节

### 配置扩展逻辑

旧版 `config.json` 中的选择器可能是逗号分隔的字符串：

```json
{
  "selectors": {
    "qrCodeImage": "img[alt*='二维码'], img[src*='qrcode'], canvas"
  }
}
```

新框架会自动将其转换为数组：

```javascript
{
  selectors: {
    qrCodeImage: [
      "img[alt*='二维码']",
      "img[src*='qrcode']",
      "canvas"
    ]
  }
}
```

### 登录状态监控

使用 PlatformBase 提供的 `waitForLogin` 通用框架方法：

```javascript
await this.waitForLogin(page, accountId, sessionId, {
  timeout: this.platformConfig.timeouts.loginCheck,  // 5 分钟
  checkInterval: 2000,                               // 每 2 秒检查
  qrSelector: this.platformConfig.selectors.qrCodeImage[0],
  qrRefreshInterval: 3000,                           // 每 3 秒检查二维码刷新
});
```

**检查项**:
- Cookie 变化
- 页面元素变化
- 二维码刷新（自动重新发送新的二维码）

### 浏览器指纹和隔离

每个账户都有独立的浏览器上下文：

```
data/browser/{workerId}/
├── browser_{accountId}/         # 用户数据目录
├── fingerprints/{accountId}_fingerprint.json
└── storage-states/{accountId}_storage.json
```

---

## 📊 与旧版的区别

| 功能 | 旧版 | 新版 |
|------|------|------|
| 配置加载 | 构造函数内重新读取 config.json | PlatformManager 传入，processPlatformConfig 处理 |
| 登录 API | `startLogin(options)` | `startLogin(options)` ✅ 保持一致 |
| 爬虫功能 | 包含完整实现 | **全部移除**，仅保留占位 |
| 配置扩展 | 硬编码在构造函数中 | `processPlatformConfig` 方法处理 |
| 选择器处理 | 字符串形式 | **支持数组形式**，自动转换 |
| 二维码提取 | 单一选择器 | **支持多选择器**，三层降级策略 |

---

## 🎯 下一步计划

1. ✅ **已完成**: 创建抖音平台基础框架（仅登录功能）
2. ⏳ **进行中**: 实现 GlobalAPIInterceptor 全局拦截器
3. ⏳ **待办**: 实现作品爬虫 (`crawlers/works.js`)
4. ⏳ **待办**: 实现评论爬虫 (`crawlers/comments.js`)
5. ⏳ **待办**: 实现私信爬虫 (`crawlers/messages.js`)
6. ⏳ **待办**: 集成爬虫到 `platform.js`

---

## 🧪 测试建议

### 测试登录功能

```javascript
// tests/test-douyin-login.js
const DouyinPlatform = require('../packages/worker/src/platforms/douyin/platform');

async function testLogin() {
  const config = require('../packages/worker/src/platforms/douyin/config.json');
  const platform = new DouyinPlatform(config, mockBridge, mockBrowserManager);

  const result = await platform.startLogin({
    accountId: 'test-account-001',
    sessionId: 'test-session-001',
    proxy: null
  });

  console.log('登录结果:', result);
}
```

### 测试配置加载

```javascript
const platform = new DouyinPlatform(config, bridge, browserManager);

console.log('平台名称:', platform.getName());  // 'douyin'
console.log('登录超时:', platform.platformConfig.timeouts.loginCheck);  // 300000
console.log('二维码选择器:', platform.platformConfig.selectors.qrCodeImage);
// 输出: ['img[alt*="二维码"]', 'img[src*="qrcode"]', 'canvas']
```

---

## 📖 参考文档

- `packages/worker/src/platforms/base/platform-base.js` - 平台基类
- `packages/worker/src/platform-manager.js` - 平台管理器
- `packages/worker/src/platforms/douyin/config.json` - 抖音平台配置
- `docs/03-WORKER-系统文档.md` - Worker 系统文档
- `docs/04-WORKER-平台扩展指南.md` - 平台扩展指南

---

## 🔒 注意事项

1. **不要直接修改 config.json**
   所有配置扩展应在 `processPlatformConfig` 方法中进行

2. **保持 API 签名一致**
   `startLogin(options)` 接口必须与旧版保持一致，以保证兼容性

3. **选择器数组处理**
   所有使用选择器的地方都要检查是否为数组，使用第一个或遍历

4. **占位方法必须抛出错误**
   未实现的方法必须明确抛出 `"not implemented yet"` 错误，而不是静默失败

---

**版本历史**:
- v2.0.0 (2025-10-27) - 重构为纯登录框架，移除所有爬虫功能
- v1.x.x (历史版本) - 包含完整爬虫实现

**作者**: Claude Code
**最后更新**: 2025-10-27
