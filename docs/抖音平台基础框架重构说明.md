# æŠ–éŸ³å¹³å°åŸºç¡€æ¡†æ¶é‡æ„è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬æ¬¡é‡æ„åˆ›å»ºäº†ä¸€ä¸ªå…¨æ–°çš„ã€å¹²å‡€çš„æŠ–éŸ³å¹³å°åŸºç¡€æ¡†æ¶ï¼Œ**ä»…ä¿ç•™ç™»å½•ç›¸å…³åŠŸèƒ½**ï¼Œç§»é™¤äº†æ‰€æœ‰çˆ¬è™«å®ç°ã€‚è¿™ä¸ºåç»­åŸºäº GlobalAPIInterceptor çš„æ–°æ¶æ„çˆ¬è™«å®ç°å¥ å®šäº†åŸºç¡€ã€‚

**ç‰ˆæœ¬**: 2.0.0
**æ—¥æœŸ**: 2025-10-27
**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/platform.js`

---

## âœ… å·²å®ç°çš„åŠŸèƒ½

### 1. é…ç½®æ–‡ä»¶è¯»å–

**é…ç½®æ¥æº**: `packages/worker/src/platforms/douyin/config.json`

```javascript
// PlatformManager ä¼šåŠ è½½ config.json å¹¶ä¼ ç»™æ„é€ å‡½æ•°
class DouyinPlatform extends PlatformBase {
  constructor(config, workerBridge, browserManager) {
    super(config, workerBridge, browserManager);

    // å¤„ç†å’Œæ‰©å±•é…ç½®
    this.platformConfig = this.processPlatformConfig(config);
  }
}
```

**é…ç½®å¤„ç†é€»è¾‘** (`processPlatformConfig`):
- âœ… å°†é€—å·åˆ†éš”çš„é€‰æ‹©å™¨å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°ç»„
- âœ… æ‰©å±•é¢å¤–çš„é€‰æ‹©å™¨ï¼ˆqrCodeCanvas, qrCodeContainer ç­‰ï¼‰
- âœ… è§„èŒƒåŒ– timeoutsï¼ˆä½¿ç”¨ config.json çš„å€¼æˆ–é»˜è®¤å€¼ï¼‰
- âœ… æ·»åŠ å†…å®¹ç®¡ç† URL

**config.json ç¤ºä¾‹**:
```json
{
  "platform": "douyin",
  "displayName": "æŠ–éŸ³",
  "version": "1.0.0",
  "urls": {
    "home": "https://www.douyin.com/",
    "creatorCenter": "https://creator.douyin.com/",
    "commentManagement": "...",
    "messageManagement": "..."
  },
  "selectors": {
    "qrCodeImage": "img[alt*='äºŒç»´ç '], img[src*='qrcode'], canvas",
    "loginSuccess": ".user-info, .avatar"
  },
  "timeouts": {
    "loginCheck": 300000,
    "pageLoad": 15000
  }
}
```

### 2. ç™»å½•æ£€æµ‹ (`detectLoginMethod`)

**åŠŸèƒ½**:
- æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ï¼ˆCookie + é¡µé¢å…ƒç´ ï¼‰
- æ£€æµ‹äºŒç»´ç ç™»å½•æ–¹å¼
- æ”¯æŒå¤šç§ç™»å½•æˆåŠŸæ ‡è¯†

**è¿”å›å€¼**:
```javascript
{
  type: 'qrcode' | 'logged_in' | 'unknown',
  element?: ElementHandle,
  qrElements?: { image?, canvas?, container? }
}
```

**æ£€æµ‹é€»è¾‘**:
1. ä¼˜å…ˆæ£€æŸ¥æ˜¯å¦å·²ç™»å½•ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
2. æŸ¥æ‰¾äºŒç»´ç å…ƒç´ ï¼ˆImage / Canvas / Containerï¼‰
3. æœªçŸ¥ç™»å½•æ–¹å¼

### 3. ç™»å½•çŠ¶æ€æ£€æŸ¥ (`checkLoginStatus`)

**æ£€æŸ¥æ–¹å¼**:
- âœ… é¡µé¢å…ƒç´ æ£€æµ‹ï¼ˆæ”¯æŒå¤šä¸ªé€‰æ‹©å™¨ï¼‰
- âœ… Cookie æ£€æµ‹ï¼ˆsessionid, sid, passport_csrf_tokenï¼‰

**é€‰æ‹©å™¨æ¥æº**: `config.json` ä¸­çš„ `selectors.loginSuccess`

### 4. äºŒç»´ç æŸ¥æ‰¾ (`findQRCodeElement`)

**æ”¯æŒçš„å…ƒç´ **:
- `qrCodeImage` - äºŒç»´ç å›¾ç‰‡ï¼ˆæ”¯æŒæ•°ç»„å½¢å¼çš„å¤šä¸ªé€‰æ‹©å™¨ï¼‰
- `qrCodeCanvas` - Canvas å…ƒç´ 
- `qrCodeContainer` - äºŒç»´ç å®¹å™¨

**è¿”å›å€¼**:
```javascript
{
  image?: ElementHandle,
  canvas?: ElementHandle,
  container?: ElementHandle
}
```

### 5. äºŒç»´ç ç™»å½•æµç¨‹ (`handleQRCodeLogin`)

**æµç¨‹**:
1. æå–äºŒç»´ç å›¾ç‰‡ï¼ˆBase64ï¼‰
2. å‘é€äºŒç»´ç åˆ° Masterï¼ˆ`qrcode_ready` çŠ¶æ€ï¼‰
3. ç­‰å¾…ç”¨æˆ·æ‰«ç ï¼ˆè°ƒç”¨ `waitForLogin`ï¼‰
4. ä¿å­˜ç™»å½•çŠ¶æ€ï¼ˆCookies + StorageStateï¼‰
5. å‘é€ç™»å½•æˆåŠŸæ¶ˆæ¯

**å‚æ•°é…ç½®**:
- `timeout`: ä» `config.json` çš„ `timeouts.loginCheck`ï¼ˆé»˜è®¤ 300000ms = 5åˆ†é’Ÿï¼‰
- `checkInterval`: 2000msï¼ˆæ¯ 2 ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
- `qrRefreshInterval`: 3000msï¼ˆæ¯ 3 ç§’æ£€æŸ¥äºŒç»´ç æ˜¯å¦åˆ·æ–°ï¼‰

### 6. äºŒç»´ç æå– (`extractQRCode`)

**æå–ç­–ç•¥**ï¼ˆä¸‰å±‚é™çº§ï¼‰:
1. **ä¼˜å…ˆ**: ä» Canvas æå–ï¼ˆ`canvas.toDataURL('image/png')`ï¼‰
2. **æ¬¡è¦**: ä» Image å…ƒç´ æå–ï¼ˆç›´æ¥è¿”å› Base64 æˆ–é€šè¿‡ Canvas è½¬æ¢ï¼‰
3. **é™çº§**: å®¹å™¨æˆªå›¾ï¼ˆ`container.screenshot()`ï¼‰

**æ”¯æŒæ•°ç»„é€‰æ‹©å™¨**: å¦‚æœ `qrCodeImage` æ˜¯æ•°ç»„ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªé€‰æ‹©å™¨

### 7. ç™»å½•çŠ¶æ€æŒä¹…åŒ– (`saveLoginState`)

**ä¿å­˜å†…å®¹**:
- âœ… Cookies
- âœ… LocalStorage
- âœ… SessionStorage

**æ–‡ä»¶è·¯å¾„**: `data/browser/{workerId}/storage-states/{accountId}_storage.json`

### 8. æµè§ˆå™¨ä¸Šä¸‹æ–‡ç®¡ç† (`getOrCreateBrowserContext`)

**åŠŸèƒ½**:
- å¤ç”¨å·²æœ‰ä¸Šä¸‹æ–‡ï¼ˆèŠ‚çœå†…å­˜ï¼‰
- æ”¯æŒä»£ç†é…ç½®
- é›†æˆæŒ‡çº¹ç®¡ç†

**ä¸Šä¸‹æ–‡ç¼“å­˜**: `this.accountContexts` (Map)

### 9. ç™»å½• API æ¥å£ (`startLogin`)

**æ–¹æ³•ç­¾å**ï¼ˆä¸æ—§ç‰ˆä¿æŒä¸€è‡´ï¼‰:
```javascript
async startLogin(options) {
  const { accountId, sessionId, proxy = null } = options;
  // ...
}
```

**æµç¨‹**:
1. è·å–æˆ–åˆ›å»ºæµè§ˆå™¨ä¸Šä¸‹æ–‡
2. å¯¼èˆªåˆ°ç™»å½•é¡µé¢
3. æ£€æµ‹ç™»å½•æ–¹å¼
4. æ ¹æ®ç™»å½•æ–¹å¼å¤„ç†ï¼ˆå·²ç™»å½• / äºŒç»´ç ç™»å½•ï¼‰

---

## â¸ï¸ å¾…å®ç°çš„åŠŸèƒ½ï¼ˆå ä½æ–¹æ³•ï¼‰

æ‰€æœ‰çˆ¬è™«ç›¸å…³æ–¹æ³•éƒ½å·²åˆ›å»ºå ä½ï¼Œè°ƒç”¨æ—¶ä¼šæŠ›å‡º `"not implemented yet"` é”™è¯¯ï¼š

```javascript
async startMonitoring(accountId)         // å¼€å§‹ç›‘æ§
async stopMonitoring(accountId)          // åœæ­¢ç›‘æ§
async crawlWorks(accountId)              // çˆ¬å–ä½œå“åˆ—è¡¨
async crawlComments(accountId)           // çˆ¬å–è¯„è®º
async crawlDirectMessages(accountId)     // çˆ¬å–ç§ä¿¡
async sendReply(accountId, replyData)    // å‘é€å›å¤
```

**ä¸‹ä¸€æ­¥**: å®ç° GlobalAPIInterceptorï¼Œç„¶åä¾æ¬¡æ·»åŠ çˆ¬è™«åŠŸèƒ½ã€‚

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### é…ç½®æ‰©å±•é€»è¾‘

æ—§ç‰ˆ `config.json` ä¸­çš„é€‰æ‹©å™¨å¯èƒ½æ˜¯é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ï¼š

```json
{
  "selectors": {
    "qrCodeImage": "img[alt*='äºŒç»´ç '], img[src*='qrcode'], canvas"
  }
}
```

æ–°æ¡†æ¶ä¼šè‡ªåŠ¨å°†å…¶è½¬æ¢ä¸ºæ•°ç»„ï¼š

```javascript
{
  selectors: {
    qrCodeImage: [
      "img[alt*='äºŒç»´ç ']",
      "img[src*='qrcode']",
      "canvas"
    ]
  }
}
```

### ç™»å½•çŠ¶æ€ç›‘æ§

ä½¿ç”¨ PlatformBase æä¾›çš„ `waitForLogin` é€šç”¨æ¡†æ¶æ–¹æ³•ï¼š

```javascript
await this.waitForLogin(page, accountId, sessionId, {
  timeout: this.platformConfig.timeouts.loginCheck,  // 5 åˆ†é’Ÿ
  checkInterval: 2000,                               // æ¯ 2 ç§’æ£€æŸ¥
  qrSelector: this.platformConfig.selectors.qrCodeImage[0],
  qrRefreshInterval: 3000,                           // æ¯ 3 ç§’æ£€æŸ¥äºŒç»´ç åˆ·æ–°
});
```

**æ£€æŸ¥é¡¹**:
- Cookie å˜åŒ–
- é¡µé¢å…ƒç´ å˜åŒ–
- äºŒç»´ç åˆ·æ–°ï¼ˆè‡ªåŠ¨é‡æ–°å‘é€æ–°çš„äºŒç»´ç ï¼‰

### æµè§ˆå™¨æŒ‡çº¹å’Œéš”ç¦»

æ¯ä¸ªè´¦æˆ·éƒ½æœ‰ç‹¬ç«‹çš„æµè§ˆå™¨ä¸Šä¸‹æ–‡ï¼š

```
data/browser/{workerId}/
â”œâ”€â”€ browser_{accountId}/         # ç”¨æˆ·æ•°æ®ç›®å½•
â”œâ”€â”€ fingerprints/{accountId}_fingerprint.json
â””â”€â”€ storage-states/{accountId}_storage.json
```

---

## ğŸ“Š ä¸æ—§ç‰ˆçš„åŒºåˆ«

| åŠŸèƒ½ | æ—§ç‰ˆ | æ–°ç‰ˆ |
|------|------|------|
| é…ç½®åŠ è½½ | æ„é€ å‡½æ•°å†…é‡æ–°è¯»å– config.json | PlatformManager ä¼ å…¥ï¼ŒprocessPlatformConfig å¤„ç† |
| ç™»å½• API | `startLogin(options)` | `startLogin(options)` âœ… ä¿æŒä¸€è‡´ |
| çˆ¬è™«åŠŸèƒ½ | åŒ…å«å®Œæ•´å®ç° | **å…¨éƒ¨ç§»é™¤**ï¼Œä»…ä¿ç•™å ä½ |
| é…ç½®æ‰©å±• | ç¡¬ç¼–ç åœ¨æ„é€ å‡½æ•°ä¸­ | `processPlatformConfig` æ–¹æ³•å¤„ç† |
| é€‰æ‹©å™¨å¤„ç† | å­—ç¬¦ä¸²å½¢å¼ | **æ”¯æŒæ•°ç»„å½¢å¼**ï¼Œè‡ªåŠ¨è½¬æ¢ |
| äºŒç»´ç æå– | å•ä¸€é€‰æ‹©å™¨ | **æ”¯æŒå¤šé€‰æ‹©å™¨**ï¼Œä¸‰å±‚é™çº§ç­–ç•¥ |

---

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

1. âœ… **å·²å®Œæˆ**: åˆ›å»ºæŠ–éŸ³å¹³å°åŸºç¡€æ¡†æ¶ï¼ˆä»…ç™»å½•åŠŸèƒ½ï¼‰
2. â³ **è¿›è¡Œä¸­**: å®ç° GlobalAPIInterceptor å…¨å±€æ‹¦æˆªå™¨
3. â³ **å¾…åŠ**: å®ç°ä½œå“çˆ¬è™« (`crawlers/works.js`)
4. â³ **å¾…åŠ**: å®ç°è¯„è®ºçˆ¬è™« (`crawlers/comments.js`)
5. â³ **å¾…åŠ**: å®ç°ç§ä¿¡çˆ¬è™« (`crawlers/messages.js`)
6. â³ **å¾…åŠ**: é›†æˆçˆ¬è™«åˆ° `platform.js`

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯•ç™»å½•åŠŸèƒ½

```javascript
// tests/test-douyin-login.js
const DouyinPlatform = require('../packages/worker/src/platforms/douyin/platform');

async function testLogin() {
  const config = require('../packages/worker/src/platforms/douyin/config.json');
  const platform = new DouyinPlatform(config, mockBridge, mockBrowserManager);

  const result = await platform.startLogin({
    accountId: 'test-account-001',
    sessionId: 'test-session-001',
    proxy: null
  });

  console.log('ç™»å½•ç»“æœ:', result);
}
```

### æµ‹è¯•é…ç½®åŠ è½½

```javascript
const platform = new DouyinPlatform(config, bridge, browserManager);

console.log('å¹³å°åç§°:', platform.getName());  // 'douyin'
console.log('ç™»å½•è¶…æ—¶:', platform.platformConfig.timeouts.loginCheck);  // 300000
console.log('äºŒç»´ç é€‰æ‹©å™¨:', platform.platformConfig.selectors.qrCodeImage);
// è¾“å‡º: ['img[alt*="äºŒç»´ç "]', 'img[src*="qrcode"]', 'canvas']
```

---

## ğŸ“– å‚è€ƒæ–‡æ¡£

- `packages/worker/src/platforms/base/platform-base.js` - å¹³å°åŸºç±»
- `packages/worker/src/platform-manager.js` - å¹³å°ç®¡ç†å™¨
- `packages/worker/src/platforms/douyin/config.json` - æŠ–éŸ³å¹³å°é…ç½®
- `docs/03-WORKER-ç³»ç»Ÿæ–‡æ¡£.md` - Worker ç³»ç»Ÿæ–‡æ¡£
- `docs/04-WORKER-å¹³å°æ‰©å±•æŒ‡å—.md` - å¹³å°æ‰©å±•æŒ‡å—

---

## ğŸ”’ æ³¨æ„äº‹é¡¹

1. **ä¸è¦ç›´æ¥ä¿®æ”¹ config.json**
   æ‰€æœ‰é…ç½®æ‰©å±•åº”åœ¨ `processPlatformConfig` æ–¹æ³•ä¸­è¿›è¡Œ

2. **ä¿æŒ API ç­¾åä¸€è‡´**
   `startLogin(options)` æ¥å£å¿…é¡»ä¸æ—§ç‰ˆä¿æŒä¸€è‡´ï¼Œä»¥ä¿è¯å…¼å®¹æ€§

3. **é€‰æ‹©å™¨æ•°ç»„å¤„ç†**
   æ‰€æœ‰ä½¿ç”¨é€‰æ‹©å™¨çš„åœ°æ–¹éƒ½è¦æ£€æŸ¥æ˜¯å¦ä¸ºæ•°ç»„ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæˆ–éå†

4. **å ä½æ–¹æ³•å¿…é¡»æŠ›å‡ºé”™è¯¯**
   æœªå®ç°çš„æ–¹æ³•å¿…é¡»æ˜ç¡®æŠ›å‡º `"not implemented yet"` é”™è¯¯ï¼Œè€Œä¸æ˜¯é™é»˜å¤±è´¥

---

**ç‰ˆæœ¬å†å²**:
- v2.0.0 (2025-10-27) - é‡æ„ä¸ºçº¯ç™»å½•æ¡†æ¶ï¼Œç§»é™¤æ‰€æœ‰çˆ¬è™«åŠŸèƒ½
- v1.x.x (å†å²ç‰ˆæœ¬) - åŒ…å«å®Œæ•´çˆ¬è™«å®ç°

**ä½œè€…**: Claude Code
**æœ€åæ›´æ–°**: 2025-10-27
