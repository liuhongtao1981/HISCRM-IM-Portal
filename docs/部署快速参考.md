# HisCRM-IM éƒ¨ç½²å¿«é€Ÿå‚è€ƒ

## ğŸš€ å¿«é€Ÿéƒ¨ç½²å‘½ä»¤

### ä¸€é”®éƒ¨ç½²ï¼ˆæ¨èï¼‰

```bash
# 1. å®‰è£…ç¯å¢ƒ
cd /var/www/hiscrm-im
chmod +x scripts/*.sh
bash scripts/install-environment.sh

# 2. é…ç½®ç¯å¢ƒå˜é‡
cp scripts/config/master.env.production packages/master/.env
nano packages/master/.env  # ä¿®æ”¹ ENCRYPTION_KEY å’Œ CORS_ORIGIN

cp scripts/config/admin-web.env.production packages/admin-web/.env
nano packages/admin-web/.env  # ä¿®æ”¹ REACT_APP_MASTER_URL

# 3. ä¸€é”®éƒ¨ç½²
bash scripts/deploy-all.sh
```

## ğŸ“¦ å•ç‹¬éƒ¨ç½²å‘½ä»¤

### Master æœåŠ¡å™¨

```bash
cd /var/www/hiscrm-im
bash scripts/deploy-master.sh
```

### Admin Web

```bash
cd /var/www/hiscrm-im
export ADMIN_DOMAIN="admin.yourdomain.com"
export NGINX_PORT=80
bash scripts/deploy-admin-web.sh
```

### CRM PC IMï¼ˆWindowsï¼‰

```powershell
# é…ç½®ç”Ÿäº§æœåŠ¡å™¨åœ°å€
notepad packages\crm-pc-im\config.json

# æ‰“åŒ…
scripts\build-pc-im.bat
```

## ğŸ”§ å¸¸ç”¨ç®¡ç†å‘½ä»¤

### PM2 ç®¡ç†

```bash
pm2 status                    # æŸ¥çœ‹çŠ¶æ€
pm2 logs hiscrm-master       # æŸ¥çœ‹æ—¥å¿—
pm2 restart hiscrm-master    # é‡å¯æœåŠ¡
pm2 stop hiscrm-master       # åœæ­¢æœåŠ¡
pm2 monit                    # å®æ—¶ç›‘æ§
pm2 save                     # ä¿å­˜é…ç½®
```

### Nginx ç®¡ç†

```bash
sudo systemctl status nginx          # æŸ¥çœ‹çŠ¶æ€
sudo systemctl restart nginx         # é‡å¯
sudo systemctl reload nginx          # é‡æ–°åŠ è½½é…ç½®
sudo nginx -t                        # æµ‹è¯•é…ç½®
sudo tail -f /var/log/nginx/error.log  # æŸ¥çœ‹æ—¥å¿—
```

### æ•°æ®åº“ç®¡ç†

```bash
# è¿›å…¥æ•°æ®åº“
sqlite3 /var/www/hiscrm-im/packages/master/data/master.db

# å¤‡ä»½æ•°æ®åº“
cp /var/www/hiscrm-im/packages/master/data/master.db \
   /backup/master.db.$(date +%Y%m%d)

# ä¼˜åŒ–æ•°æ®åº“
sqlite3 master.db "VACUUM;"

# å®Œæ•´æ€§æ£€æŸ¥
sqlite3 master.db "PRAGMA integrity_check;"
```

## ğŸ” å¿«é€Ÿè¯Šæ–­

### æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
# Master çŠ¶æ€
pm2 status hiscrm-master

# Nginx çŠ¶æ€
sudo systemctl status nginx

# ç«¯å£å ç”¨
sudo netstat -tulpn | grep 3000
sudo netstat -tulpn | grep 80
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# Master æ—¥å¿—
pm2 logs hiscrm-master --lines 100

# Nginx æ—¥å¿—
sudo tail -100 /var/log/nginx/error.log

# ç³»ç»Ÿæ—¥å¿—
sudo tail -100 /var/log/syslog
```

### æµ‹è¯•è¿æ¥

```bash
# æµ‹è¯• Master API
curl http://localhost:3000/api/v1/health

# æµ‹è¯• WebSocket
curl http://localhost:3000/socket.io/

# æµ‹è¯• Nginx
curl http://localhost
```

## ğŸ” å®‰å…¨å‘½ä»¤

### é˜²ç«å¢™

```bash
# æŸ¥çœ‹çŠ¶æ€
sudo ufw status

# å…è®¸ç«¯å£
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw allow 3000/tcp  # Master

# å¯ç”¨é˜²ç«å¢™
sudo ufw enable
```

### SSL è¯ä¹¦ï¼ˆLet's Encryptï¼‰

```bash
# å®‰è£… Certbot
sudo apt-get install -y certbot python3-certbot-nginx

# è·å–è¯ä¹¦
sudo certbot --nginx -d yourdomain.com

# è‡ªåŠ¨ç»­æœŸæµ‹è¯•
sudo certbot renew --dry-run
```

## ğŸ”„ æ›´æ–°å’Œå›æ»š

### æ›´æ–°æµç¨‹

```bash
# 1. å¤‡ä»½
cp /var/www/hiscrm-im/packages/master/data/master.db \
   /backup/master.db.$(date +%Y%m%d-%H%M%S)

# 2. æ‹‰å–æ–°ä»£ç 
cd /var/www/hiscrm-im
git pull

# 3. å®‰è£…ä¾èµ–
npm install
cd packages/master && npm install

# 4. é‡å¯æœåŠ¡
pm2 restart hiscrm-master

# 5. é‡æ–°æ„å»º Admin Webï¼ˆå¦‚æœéœ€è¦ï¼‰
cd packages/admin-web
npm run build
sudo rm -rf /var/www/html/hiscrm-admin/*
sudo cp -r build/* /var/www/html/hiscrm-admin/
```

### å›æ»šæµç¨‹

```bash
# 1. åœæ­¢æœåŠ¡
pm2 stop hiscrm-master

# 2. æ¢å¤ä»£ç 
cd /var/www
git checkout <commit-hash>

# 3. æ¢å¤æ•°æ®åº“
cp /backup/master.db.YYYYMMDD-HHMMSS \
   /var/www/hiscrm-im/packages/master/data/master.db

# 4. é‡å¯æœåŠ¡
pm2 restart hiscrm-master
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### PM2 Cluster æ¨¡å¼

```bash
# å¯åŠ¨å¤šä¸ªå®ä¾‹
pm2 scale hiscrm-master 4

# æˆ–åœ¨éƒ¨ç½²æ—¶è®¾ç½®
export PM2_INSTANCES=4
bash scripts/deploy-master.sh
```

### Nginx ä¼˜åŒ–

ç¼–è¾‘ `/etc/nginx/nginx.conf`ï¼š

```nginx
worker_processes auto;
worker_connections 1024;

gzip on;
gzip_comp_level 5;
gzip_types text/plain text/css application/json application/javascript;
```

## ğŸ”¨ æ•…éšœå¤„ç†

### Master æ— æ³•å¯åŠ¨

```bash
# 1. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
pm2 logs hiscrm-master --err --lines 100

# 2. æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tulpn | grep 3000

# 3. æ£€æŸ¥é…ç½®
cat packages/master/.env

# 4. æ‰‹åŠ¨å¯åŠ¨æµ‹è¯•
cd packages/master
node src/index.js
```

### WebSocket è¿æ¥å¤±è´¥

```bash
# 1. æ£€æŸ¥ Master è¿è¡Œ
pm2 status

# 2. æ£€æŸ¥é˜²ç«å¢™
sudo ufw status

# 3. æ£€æŸ¥ CORS
grep CORS_ORIGIN packages/master/.env

# 4. æµ‹è¯•è¿æ¥
curl http://localhost:3000/socket.io/
```

### å†…å­˜ä¸è¶³

```bash
# 1. æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h
pm2 status

# 2. é…ç½®å†…å­˜é™åˆ¶
pm2 restart hiscrm-master --max-memory-restart 500M

# 3. è°ƒæ•´é…ç½®
# ç¼–è¾‘ packages/master/.env
MAX_ACCOUNTS_PER_WORKER=5
MAX_BROWSERS_PER_WORKER=5
```

## ğŸ“ é‡è¦æ–‡ä»¶è·¯å¾„

### é…ç½®æ–‡ä»¶

```
/var/www/hiscrm-im/packages/master/.env
/var/www/hiscrm-im/packages/admin-web/.env
/etc/nginx/sites-available/hiscrm-admin-web
/etc/nginx/sites-enabled/hiscrm-admin-web
```

### æ•°æ®æ–‡ä»¶

```
/var/www/hiscrm-im/packages/master/data/master.db
/var/www/hiscrm-im/packages/master/logs/
```

### æ—¥å¿—æ–‡ä»¶

```
~/.pm2/logs/hiscrm-master-out.log
~/.pm2/logs/hiscrm-master-error.log
/var/log/nginx/access.log
/var/log/nginx/error.log
/var/log/syslog
```

### Web æ–‡ä»¶

```
/var/www/html/hiscrm-admin/
```

## ğŸ¯ ç¯å¢ƒå˜é‡å¿«é€Ÿè®¾ç½®

### Master (.env)

```env
# å¿…æ”¹é¡¹
PORT=3000
ENCRYPTION_KEY=<32ä½éšæœºå­—ç¬¦ä¸²>
CORS_ORIGIN=https://yourdomain.com
NODE_ENV=production
LOG_LEVEL=info
BROWSER_HEADLESS=true
MONITORING_ENABLED=true
```

ç”ŸæˆåŠ å¯†å¯†é’¥ï¼š

```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### Admin Web (.env)

```env
REACT_APP_API_URL=/api/v1
REACT_APP_MASTER_URL=http://your-server-ip:3000
```

### CRM PC IM (config.json)

```json
{
  "websocket": {
    "url": "http://your-server-ip:3000"
  }
}
```

## ğŸ“ ç´§æ€¥è”ç³»

### æœåŠ¡å™¨ä¿¡æ¯

```
æœåŠ¡å™¨ IP: _________________
SSH ç«¯å£: __________________
SSH ç”¨æˆ·: __________________
```

### è®¿é—®åœ°å€

```
Admin Web: http://___________________
Master API: http://___________________:3000
```

### ç®¡ç†å‘˜è´¦å·

```
ç”¨æˆ·å: _______________________
å¯†ç : _________________________
```

---

**å¿«é€Ÿå‚è€ƒç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2025-01-20

**æç¤º**: å°†æ­¤æ–‡æ¡£æ‰“å°æˆ–ä¿å­˜ä¸º PDFï¼Œä»¥ä¾¿åœ¨éƒ¨ç½²å’Œè¿ç»´æ—¶å¿«é€ŸæŸ¥æ‰¾å‘½ä»¤ã€‚
