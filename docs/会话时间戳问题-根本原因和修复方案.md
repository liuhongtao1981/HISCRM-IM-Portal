# ä¼šè¯æ—¶é—´æˆ³é—®é¢˜ - æ ¹æœ¬åŸå› å’Œä¿®å¤æ–¹æ¡ˆ

## æ—¶é—´: 2025-11-05 09:10

## é—®é¢˜æè¿°

**ç”¨æˆ·åé¦ˆ**: "æ¯ä¸ªæ¶ˆæ¯çš„æ—¶é—´éƒ½æ˜¯ä¸€æ ·çš„"

**éªŒè¯ç»“æœ**:
- âœ… **æ¶ˆæ¯ï¼ˆmessagesï¼‰æ—¶é—´æˆ³** - å„ä¸ç›¸åŒï¼Œæ­£ç¡®
- âŒ **ä¼šè¯ï¼ˆconversationsï¼‰æ—¶é—´æˆ³** - å…¨éƒ¨ç›¸åŒï¼Œé”™è¯¯

## æ•°æ®éªŒè¯

### æ¶ˆæ¯æ—¶é—´æˆ³ï¼ˆæ­£ç¡®ï¼‰

```
æ¶ˆæ¯1: 2025-11-04T15:58:27.004Z
æ¶ˆæ¯2: 2025-11-04T00:50:40.221Z
æ¶ˆæ¯3: 2025-11-04T05:55:31.099Z
æ¶ˆæ¯4: 2025-11-03T00:49:57.011Z
...
ç»Ÿè®¡: 20æ¡æ¶ˆæ¯ï¼Œ20ä¸ªä¸åŒæ—¶é—´æˆ³ âœ…
```

### ä¼šè¯æ—¶é—´æˆ³ï¼ˆé”™è¯¯ï¼‰

```
ä¼šè¯1: lastMessageTime: 1762304070258 â†’ 2025-11-05 00:54:30.258
ä¼šè¯2: lastMessageTime: 1762304070258 â†’ 2025-11-05 00:54:30.258
ä¼šè¯3: lastMessageTime: 1762304070258 â†’ 2025-11-05 00:54:30.258
...
ç»Ÿè®¡: 20ä¸ªä¼šè¯ï¼Œåªæœ‰2ä¸ªä¸åŒæ—¶é—´æˆ³ï¼ˆç›¸å·®1æ¯«ç§’ï¼‰ âŒ
```

**æ‰€æœ‰ä¼šè¯çš„æ—¶é—´éƒ½æ˜¯**: `2025-11-05 00:54:30` (UTC) = `2025-11-05 08:54:30` (UTC+8)
â†’ **è¿™æ­£æ˜¯çˆ¬è™«æ‰§è¡Œçš„æ—¶é—´ï¼**

## æ ¹æœ¬åŸå› 

### ä»£ç åˆ†æ

**æ–‡ä»¶**: [`packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js`](../packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js)

#### 1. API æå–è·¯å¾„ï¼ˆLine 481ï¼‰

```javascript
const conversation = {
  id: generateConversationId(account.id, userId),
  account_id: account.id,
  platform_user_id: userId,
  platform_user_name: userName,
  platform_user_avatar: userAvatar,
  last_message_time: Math.floor(Date.now() / 1000),  // âŒ ç›´æ¥ä½¿ç”¨å½“å‰æ—¶é—´
  last_message_content: '',  // API ä¸åŒ…å«æ¶ˆæ¯å†…å®¹
  platform_message_id: null,
  // ...
};
```

**é—®é¢˜**:
- æ³¨é‡Šè¯´ "API ä¸åŒ…å«æ¶ˆæ¯ä¿¡æ¯ï¼Œä½¿ç”¨å½“å‰æ—¶é—´"
- ä½†è¿™æ˜¯**é”™è¯¯çš„å‡è®¾** - è™šæ‹Ÿåˆ—è¡¨ï¼ˆReact Fiberï¼‰ä¸­æœ‰å®Œæ•´çš„æ¶ˆæ¯æ•°æ®

#### 2. DOM æå–è·¯å¾„ï¼ˆLine 616-648ï¼‰

```javascript
// å°è¯•ä»æ–‡æœ¬ä¸­æå–æ—¶é—´å­—ç¬¦ä¸²
const timeMatch = content.match(/(\d{1,2}:\d{2}|\d{1,2}-\d{2}|\d{4}-\d{1,2}-\d{1,2})/);
const time = timeMatch ? timeMatch[0] : '';

const conversation = {
  // ...
  last_message_time: time ? parseInt(time) : Math.floor(Date.now() / 1000),  // âŒ å¤±è´¥åˆ™ç”¨å½“å‰æ—¶é—´
  // ...
};
```

**é—®é¢˜**:
1. æ­£åˆ™è¡¨è¾¾å¼åªèƒ½åŒ¹é… "HH:MM" æˆ– "MM-DD" æ ¼å¼çš„å­—ç¬¦ä¸²
2. æå–çš„æ˜¯**æ–‡æœ¬**ï¼ˆå¦‚ "10:30"ï¼‰ï¼Œä¸æ˜¯æ—¶é—´æˆ³
3. `parseInt("10:30")` = `10`ï¼Œè¿™æ˜¯é”™è¯¯çš„æ•°å€¼
4. å¤§éƒ¨åˆ†æƒ…å†µä¸‹åŒ¹é…å¤±è´¥ï¼Œfallback åˆ° `Date.now()`

### æ•°æ®æµ

```
APIæå– â†’ æ²¡æœ‰æå–lastMessageTime â†’ ä½¿ç”¨ Date.now()
   â†“
DOMæå– â†’ æ­£åˆ™åŒ¹é…æ–‡æœ¬å¤±è´¥ â†’ ä½¿ç”¨ Date.now()
   â†“
æ‰€æœ‰ä¼šè¯çš„ lastMessageTime = å½“å‰æ—¶é—´ï¼ˆç›¸åŒï¼‰
   â†“
å­˜å…¥æ•°æ®åº“ cache_conversations
   â†“
IMå®¢æˆ·ç«¯æ˜¾ç¤ºï¼šæ‰€æœ‰ä¼šè¯æ—¶é—´éƒ½ä¸€æ · âŒ
```

## æ­£ç¡®çš„æ•°æ®æº

### è™šæ‹Ÿåˆ—è¡¨ï¼ˆReact Fiberï¼‰ä¸­çš„æ•°æ®

æ ¹æ®ä¹‹å‰çš„ä»£ç åˆ†æï¼Œè™šæ‹Ÿåˆ—è¡¨çš„ props å¯¹è±¡å¯èƒ½åŒ…å«ï¼š

**å¯èƒ½çš„æ—¶é—´å­—æ®µ**:
- `createdAt`
- `timestamp`
- `createTime`
- `sendTime`
- `create_time`
- `send_time`
- `lastMessageTime`
- `last_message_time`

**é—®é¢˜**: æˆ‘ä»¬è¿˜æ²¡æœ‰çœ‹åˆ°å®é™…çš„ props å¯¹è±¡ç»“æ„ï¼Œå› ä¸ºè°ƒè¯•è¾“å‡ºæ²¡æœ‰æ‰§è¡Œã€‚

### å®é™…æ¶ˆæ¯æ•°æ®

ä»æ•°æ®åº“ä¸­çœ‹åˆ°ï¼Œ**æ¶ˆæ¯ï¼ˆmessagesï¼‰çš„æ—¶é—´æˆ³æ˜¯æ­£ç¡®çš„**ï¼Œè¯´æ˜æ¶ˆæ¯æå–é€»è¾‘æ˜¯æœ‰æ•ˆçš„ã€‚

æˆ‘ä»¬å¯ä»¥ï¼š
1. æå–æ¯ä¸ªä¼šè¯çš„æ‰€æœ‰æ¶ˆæ¯
2. æ‰¾åˆ°æœ€æ–°æ¶ˆæ¯çš„æ—¶é—´æˆ³
3. ä½¿ç”¨è¿™ä¸ªæ—¶é—´æˆ³ä½œä¸ºä¼šè¯çš„ `lastMessageTime`

## ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: ä»å·²æœ‰æ¶ˆæ¯æ•°æ®ä¸­è®¡ç®—ï¼ˆç«‹å³å¯è¡Œï¼‰

**æ€è·¯**: çˆ¬è™«å·²ç»æ­£ç¡®æå–äº†æ¶ˆæ¯æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¤„ç†ä¼šè¯æ—¶ï¼Œä»æ¶ˆæ¯åˆ—è¡¨ä¸­è·å–æœ€æ–°æ¶ˆæ¯çš„æ—¶é—´æˆ³ã€‚

**ä¿®æ”¹ä½ç½®**: `crawl-direct-messages-v2.js` ä¸»çˆ¬è™«é€»è¾‘

**å®ç°æ­¥éª¤**:

1. **åœ¨æ‰“å¼€æ¯ä¸ªä¼šè¯å¹¶æå–æ¶ˆæ¯å**ï¼Œè®°å½•è¯¥ä¼šè¯çš„æœ€æ–°æ¶ˆæ¯æ—¶é—´
2. **æ›´æ–°ä¼šè¯å¯¹è±¡çš„ `last_message_time`**

**ä»£ç ç¤ºä¾‹**:

```javascript
// å½“å‰ä»£ç  (line ~850-950)
for (const conv of conversations) {
  // ç‚¹å‡»ä¼šè¯
  await clickConversation(page, conv, index);

  // æå–æ¶ˆæ¯
  const messages = await extractMessagesFromVirtualList(page);

  // âœ… æ–°å¢ï¼šè®¡ç®—æœ€æ–°æ¶ˆæ¯æ—¶é—´
  if (messages && messages.length > 0) {
    const latestMessage = messages.reduce((latest, msg) => {
      return msg.created_at > latest.created_at ? msg : latest;
    });

    conv.last_message_time = latestMessage.created_at; // âœ… ä½¿ç”¨å®é™…æ¶ˆæ¯æ—¶é—´
    conv.last_message_content = latestMessage.content.substring(0, 100);
  }

  // å­˜å‚¨æ¶ˆæ¯...
}
```

**ä¼˜ç‚¹**:
- åˆ©ç”¨å·²æœ‰çš„æ­£ç¡®æ•°æ®
- ä¸éœ€è¦é¢å¤–çš„æ•°æ®æå–
- ç«‹å³å¯è¡Œ

**ç¼ºç‚¹**:
- éœ€è¦å…ˆæå–æ¶ˆæ¯ï¼Œæ‰èƒ½æ›´æ–°ä¼šè¯æ—¶é—´
- å¦‚æœä¼šè¯æ²¡æœ‰æ¶ˆæ¯ï¼Œä»ç„¶ä¼šfallbackåˆ°å½“å‰æ—¶é—´

### æ–¹æ¡ˆ B: ä»è™šæ‹Ÿåˆ—è¡¨æå–ä¼šè¯æ—¶é—´ï¼ˆæœ€ä½³æ–¹æ¡ˆï¼‰

**æ€è·¯**: åœ¨ä¼šè¯åˆ—è¡¨çš„è™šæ‹Ÿåˆ—è¡¨ä¸­ï¼Œæ¯ä¸ªä¼šè¯é¡¹åº”è¯¥åŒ…å«æœ€åæ¶ˆæ¯æ—¶é—´ã€‚

**ä¿®æ”¹ä½ç½®**: `extractConversationsList()` å‡½æ•°

**å®ç°æ­¥éª¤**:

1. **æ·»åŠ è°ƒè¯•ä»£ç ** - æŸ¥çœ‹ä¼šè¯åˆ—è¡¨è™šæ‹Ÿåˆ—è¡¨çš„ props ç»“æ„
2. **æå–æ—¶é—´å­—æ®µ** - æ ¹æ®å®é™…å­—æ®µåæå– `lastMessageTime`
3. **æ›´æ–°ä¼šè¯å¯¹è±¡** - ä½¿ç”¨æå–çš„æ—¶é—´è€Œä¸æ˜¯ `Date.now()`

**è°ƒè¯•ä»£ç **ï¼ˆç±»ä¼¼æ¶ˆæ¯è™šæ‹Ÿåˆ—è¡¨è°ƒè¯•ï¼‰:

```javascript
// åœ¨ extractConversationsList() ä¸­æ·»åŠ 
async function extractConversationsList(page, account) {
  // ...ç°æœ‰ä»£ç ...

  return await page.evaluate(() => {
    const conversations = [];
    let hasDebugPrinted = false;

    // æŸ¥æ‰¾ä¼šè¯åˆ—è¡¨å®¹å™¨
    const conversationElements = document.querySelectorAll('...');

    conversationElements.forEach((element, index) => {
      // è·å– React Fiber
      const fiberKey = Object.keys(element).find(key =>
        key.startsWith('__reactFiber$')
      );

      if (!fiberKey) return;

      const fiber = element[fiberKey];
      const props = deepSearchProps(fiber); // éœ€è¦å®ç°ç±»ä¼¼ deepSearchMessage

      // ğŸ” è°ƒè¯•è¾“å‡ºï¼ˆç¬¬ä¸€æ¬¡ï¼‰
      if (props && !hasDebugPrinted) {
        hasDebugPrinted = true;
        const allKeys = Object.keys(props);
        const timeKeys = allKeys.filter(k =>
          k.toLowerCase().includes('time') ||
          k.toLowerCase().includes('message')
        );

        debugInfo = {
          allKeys: allKeys,
          timeKeys: timeKeys,
          sampleProps: JSON.stringify(props, null, 2).substring(0, 2000)
        };
      }

      // æå–ä¼šè¯æ•°æ®
      const conversation = {
        // ...
        last_message_time: props.lastMessageTime ||  // âœ… å°è¯•å„ç§å­—æ®µå
                          props.last_message_time ||
                          props.timestamp ||
                          props.updateTime ||
                          Math.floor(Date.now() / 1000), // æœ€åfallback
        // ...
      };

      conversations.push(conversation);
    });

    return { conversations, debugInfo };
  });
}
```

**ä¼˜ç‚¹**:
- æå–çœŸå®çš„ä¼šè¯æ—¶é—´
- ä¸ä¾èµ–æ¶ˆæ¯æ•°æ®
- æ€§èƒ½æ›´å¥½ï¼ˆä¸éœ€è¦æ‰“å¼€æ¯ä¸ªä¼šè¯ï¼‰

**ç¼ºç‚¹**:
- éœ€è¦å…ˆäº†è§£è™šæ‹Ÿåˆ—è¡¨çš„æ•°æ®ç»“æ„ï¼ˆéœ€è¦è°ƒè¯•è¾“å‡ºï¼‰
- å®ç°ç¨å¤æ‚

### æ–¹æ¡ˆ C: æ··åˆæ–¹æ¡ˆï¼ˆæ¨èï¼‰

**ç»“åˆæ–¹æ¡ˆAå’Œæ–¹æ¡ˆBçš„ä¼˜ç‚¹**:

1. **ä¼˜å…ˆçº§1**: ä»ä¼šè¯è™šæ‹Ÿåˆ—è¡¨çš„ props ä¸­æå–æ—¶é—´ï¼ˆæ–¹æ¡ˆBï¼‰
2. **ä¼˜å…ˆçº§2**: ä»å·²æå–çš„æ¶ˆæ¯ä¸­è®¡ç®—æœ€æ–°æ—¶é—´ï¼ˆæ–¹æ¡ˆAï¼‰
3. **ä¼˜å…ˆçº§3**: ä½¿ç”¨ Date.now() ä½œä¸ºæœ€åfallback

**ä»£ç ç¤ºä¾‹**:

```javascript
// 1. åœ¨ extractConversationsList ä¸­å°è¯•æå–
conv.last_message_time = props.lastMessageTime || props.last_message_time || null;

// 2. åœ¨ä¸»çˆ¬è™«å¾ªç¯ä¸­ï¼Œå¦‚æœæ²¡æœ‰æå–åˆ°æ—¶é—´ï¼Œä»æ¶ˆæ¯è®¡ç®—
if (!conv.last_message_time && messages.length > 0) {
  const latestMessage = messages.reduce((latest, msg) =>
    msg.created_at > latest.created_at ? msg : latest
  );
  conv.last_message_time = latestMessage.created_at;
}

// 3. æœ€åfallback
conv.last_message_time = conv.last_message_time || Math.floor(Date.now() / 1000);
```

## éªŒè¯æ–¹æ³•

### ä¿®å¤å‰éªŒè¯

```bash
cd packages/master && node -e "
const db = require('better-sqlite3')('./data/master.db');
const convs = db.prepare('SELECT data FROM cache_conversations LIMIT 10').all();
const times = convs.map(c => {
  const data = JSON.parse(c.data);
  return new Date(data.lastMessageTime).toISOString();
});
console.log('ä¼šè¯æ—¶é—´:', new Set(times).size === 1 ? 'âŒ å…¨éƒ¨ç›¸åŒ' : 'âœ… å„ä¸ç›¸åŒ');
console.log(times);
db.close();
"
```

**é¢„æœŸè¾“å‡º**: âŒ å…¨éƒ¨ç›¸åŒ

### ä¿®å¤åéªŒè¯

è¿è¡Œç›¸åŒçš„å‘½ä»¤ï¼Œé¢„æœŸè¾“å‡º: âœ… å„ä¸ç›¸åŒ

```
ä¼šè¯æ—¶é—´: âœ… å„ä¸ç›¸åŒ
[
  "2025-11-04T15:58:27.000Z",
  "2025-11-04T00:50:40.000Z",
  "2025-11-03T05:30:12.000Z",
  "2025-11-02T10:21:32.000Z",
  ...
]
```

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### çŸ­æœŸï¼ˆç«‹å³æ‰§è¡Œï¼‰:
1. âœ… é—®é¢˜åˆ†æå®Œæˆ
2. â³ å®ç°**æ–¹æ¡ˆA**ï¼ˆä»æ¶ˆæ¯è®¡ç®—ä¼šè¯æ—¶é—´ï¼‰- æœ€å¿«ä¿®å¤
3. â³ æµ‹è¯•å¹¶éªŒè¯ä¿®å¤æ•ˆæœ

### ä¸­æœŸï¼ˆæœ¬å‘¨å†…ï¼‰:
1. â³ æ·»åŠ ä¼šè¯è™šæ‹Ÿåˆ—è¡¨è°ƒè¯•ä»£ç 
2. â³ æŸ¥çœ‹ä¼šè¯ props å¯¹è±¡çš„å®é™…ç»“æ„
3. â³ å®ç°**æ–¹æ¡ˆB**ï¼ˆä»ä¼šè¯è™šæ‹Ÿåˆ—è¡¨æå–æ—¶é—´ï¼‰

### é•¿æœŸï¼ˆä¼˜åŒ–ï¼‰:
1. â³ å®ç°**æ–¹æ¡ˆC**ï¼ˆæ··åˆæ–¹æ¡ˆï¼‰- æœ€ç¨³å®š
2. â³ æ·»åŠ æ—¶é—´æˆ³éªŒè¯ï¼ˆæ£€æµ‹å¼‚å¸¸å€¼ï¼‰
3. â³ æ›´æ–°æ–‡æ¡£å’Œæµ‹è¯•

## æŠ€æœ¯ç»†èŠ‚

### æ—¶é—´æˆ³æ ¼å¼è½¬æ¢

**å½“å‰ä¼šè¯æ—¶é—´**: Unix ç§’æ—¶é—´æˆ³ï¼ˆæ•´æ•°ï¼‰
```javascript
last_message_time: 1762304070  // ç§’
```

**æ¶ˆæ¯æ—¶é—´**: ISO 8601 å­—ç¬¦ä¸²
```javascript
created_at: "2025-11-04T15:58:27.004Z"
```

**è½¬æ¢æ–¹æ³•**:
```javascript
// ISO 8601 â†’ Unix ç§’
const timestamp = Math.floor(new Date("2025-11-04T15:58:27.004Z").getTime() / 1000);
// 1730735907

// Unix ç§’ â†’ ISO 8601
const isoString = new Date(1730735907 * 1000).toISOString();
// "2025-11-04T15:58:27.000Z"
```

### ç›¸å…³ä»£ç æ–‡ä»¶

- **ä¼šè¯æå–**: [crawl-direct-messages-v2.js:430-670](../packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js#L430-L670)
- **æ¶ˆæ¯æå–**: [crawl-direct-messages-v2.js:1114-1541](../packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js#L1114-L1541)
- **ä¸»çˆ¬è™«é€»è¾‘**: [crawl-direct-messages-v2.js:800-1050](../packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js#L800-L1050)

## å‚è€ƒæ–‡æ¡£

- [è™šæ‹Ÿåˆ—è¡¨è°ƒè¯•è¾“å‡º-ä»£ç ä¿®å¤](./è™šæ‹Ÿåˆ—è¡¨è°ƒè¯•è¾“å‡º-ä»£ç ä¿®å¤.md)
- [è™šæ‹Ÿåˆ—è¡¨è°ƒè¯•è¾“å‡º-æ‰§è¡Œç»“æœåˆ†æ](./è™šæ‹Ÿåˆ—è¡¨è°ƒè¯•è¾“å‡º-æ‰§è¡Œç»“æœåˆ†æ.md)
- [æ—¶é—´æˆ³é—®é¢˜æœ€ç»ˆå‘ç°](./æ—¶é—´æˆ³é—®é¢˜æœ€ç»ˆå‘ç°.md)
