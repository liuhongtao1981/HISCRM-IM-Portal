# 数据库增强与 IM 集成完整实现

## 概述

本文档记录了 HisCRM-IM 系统的数据库结构增强和 IM 集成的完整实现过程。

**实现目标**：完善数据库结构以支持完整的业务模型（账号、作品、评论、讨论、私信），并通过 /api/im 接口对接 IM 系统。

**完成时间**：2025-10-23

---

## 业务模型

### 核心实体

1. **账号 (Accounts)** - 平台账号（已存在）
2. **作品 (Works)** - 视频或文章（新增）
3. **评论 (Comments)** - 对作品的回复（已存在）
4. **讨论 (Discussions)** - 对评论的回复（新增）
5. **私信 (Direct Messages)** - 对账号的私信（已存在）

### 业务关系

```
账号 (Account)
  ↓
作品 (Work)
  ↓
评论 (Comment)
  ↓
讨论 (Discussion)

账号 (Account)
  ↓
私信 (Direct Message)
```

---

## 数据库设计

### 1. works 表（作品表）

统一的作品表，支持多平台、多类型（视频、文章等）。

**核心字段**：

```sql
CREATE TABLE IF NOT EXISTS works (
  id TEXT PRIMARY KEY,
  account_id TEXT NOT NULL,
  platform TEXT NOT NULL,
  platform_work_id TEXT NOT NULL,
  platform_user_id TEXT,

  -- 作品类型和信息
  work_type TEXT NOT NULL CHECK(work_type IN ('video', 'article', 'image', 'audio', 'text')),
  title TEXT,
  description TEXT,
  cover TEXT,
  url TEXT,
  publish_time INTEGER,

  -- 统计信息
  total_comment_count INTEGER DEFAULT 0,
  new_comment_count INTEGER DEFAULT 0,
  like_count INTEGER DEFAULT 0,
  share_count INTEGER DEFAULT 0,
  view_count INTEGER DEFAULT 0,

  -- 爬取状态
  last_crawl_time INTEGER,
  crawl_status TEXT DEFAULT 'pending',
  crawl_error TEXT,

  -- 标记
  is_new BOOLEAN DEFAULT 1,
  push_count INTEGER DEFAULT 0,

  -- 时间戳
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,

  -- 三字段组合唯一约束
  UNIQUE(account_id, platform, platform_work_id),

  FOREIGN KEY (account_id) REFERENCES accounts(id) ON DELETE CASCADE
);
```

**关键特性**：
- 支持多种作品类型：视频、文章、图片、音频、文本
- 统一的统计信息字段
- 平台无关的设计
- 三字段组合唯一约束防止重复

### 2. discussions 表（讨论表）

讨论表（二级评论）- 对评论的回复。

**核心字段**：

```sql
CREATE TABLE IF NOT EXISTS discussions (
  id TEXT PRIMARY KEY,
  account_id TEXT NOT NULL,
  platform TEXT NOT NULL,
  platform_user_id TEXT,
  platform_discussion_id TEXT,

  -- 关联到父评论
  parent_comment_id TEXT NOT NULL,

  -- 讨论内容
  content TEXT NOT NULL,
  author_name TEXT,
  author_id TEXT,

  -- 关联作品信息
  work_id TEXT,
  post_id TEXT,
  post_title TEXT,

  -- 状态
  is_read BOOLEAN DEFAULT 0,
  is_new BOOLEAN DEFAULT 1,
  push_count INTEGER DEFAULT 0,

  -- 时间戳
  detected_at INTEGER NOT NULL,
  created_at INTEGER NOT NULL,

  -- 三字段组合唯一约束
  UNIQUE(account_id, platform_user_id, platform_discussion_id),

  FOREIGN KEY (account_id) REFERENCES accounts(id) ON DELETE CASCADE,
  FOREIGN KEY (parent_comment_id) REFERENCES comments(id) ON DELETE CASCADE,
  FOREIGN KEY (work_id) REFERENCES works(id) ON DELETE SET NULL
);
```

**关键特性**：
- 关联到父评论（parent_comment_id）
- 支持作品信息关联
- 级联删除和外键约束
- 三字段组合唯一约束

### 3. 数据迁移

**迁移脚本**：`packages/master/src/database/add-works-discussions-tables.js`

**迁移内容**：
1. 创建 works 表
2. 创建 discussions 表
3. 迁移现有 douyin_videos 数据到 works 表

**运行方式**：
```bash
node packages/master/src/database/add-works-discussions-tables.js
```

**迁移结果**：
- ✅ works 表创建成功
- ✅ 成功迁移 1 个视频到 works 表
- ✅ discussions 表创建成功

---

## DAO 层实现

### 1. WorksDAO

**文件位置**：`packages/master/src/dao/WorksDAO.js`

**核心方法**：

```javascript
class WorksDAO {
  create(work)                          // 创建作品
  findById(id)                          // 根据 ID 查询
  findByPlatformWorkId(...)             // 根据平台作品 ID 查询
  findByAccountId(accountId, options)   // 查询账号的所有作品
  findAll(options)                      // 查询所有作品（分页）
  update(id, updates)                   // 更新作品
  updateStats(id, stats)                // 更新统计信息
  delete(id)                            // 删除作品
  count(options)                        // 统计作品数量
  markAsRead(id)                        // 标记为已读
  markManyAsRead(ids)                   // 批量标记为已读
}
```

### 2. DiscussionsDAO

**文件位置**：`packages/master/src/dao/DiscussionsDAO.js`

**核心方法**：

```javascript
class DiscussionsDAO {
  create(discussion)                        // 创建讨论
  findById(id)                              // 根据 ID 查询
  findByParentCommentId(parentId, options)  // 根据父评论 ID 查询
  findByAccountId(accountId, options)       // 查询账号的所有讨论
  findByWorkId(workId, options)             // 根据作品 ID 查询
  findAll(options)                          // 查询所有讨论（分页）
  update(id, updates)                       // 更新讨论
  markAsRead(id)                            // 标记为已读
  markManyAsRead(ids)                       // 批量标记为已读
  delete(id)                                // 删除讨论
  count(options)                            // 统计讨论数量
  getCommentDiscussionStats(commentId)      // 获取评论的讨论统计
}
```

---

## 数据转换层

### 1. WorkTransformer

**文件位置**：`packages/master/src/api/transformers/work-transformer.js`

**功能**：转换 Master 作品格式 ↔ IM 作品格式

**核心方法**：
- `toIMWork(masterWork)` - Master 格式 → IM 格式
- `toMasterWork(imWork)` - IM 格式 → Master 格式
- `toIMWorks(masterWorks)` - 批量转换

**时间戳转换**：
- Master 格式：秒级时间戳
- IM 格式：毫秒级时间戳

### 2. DiscussionTransformer

**文件位置**：`packages/master/src/api/transformers/discussion-transformer.js`

**功能**：转换 Master 讨论格式 ↔ IM 讨论格式

**核心方法**：
- `toIMDiscussion(masterDiscussion)` - Master 格式 → IM 格式
- `toMasterDiscussion(imDiscussion)` - IM 格式 → Master 格式
- `toIMDiscussions(masterDiscussions)` - 批量转换

### 3. UnifiedMessageTransformer

**文件位置**：`packages/master/src/api/transformers/unified-message-transformer.js`

**功能**：将不同业务类型（评论、讨论、私信）统一转换为 IM 消息格式

**核心方法**：

```javascript
class UnifiedMessageTransformer {
  // 转换方法
  static commentToIMMessage(comment)           // 评论 → IM 消息
  static discussionToIMMessage(discussion)     // 讨论 → IM 消息
  static directMessageToIMMessage(dm)          // 私信 → IM 消息

  // 查询方法
  static async getUnifiedMessages(db, options) // 统一查询所有类型消息

  // 标记已读
  static markAsRead(db, businessType, messageId)
  static markManyAsRead(db, businessType, messageIds)

  // 统计
  static getUnreadStats(db, accountId)         // 获取未读消息统计
}
```

**消息类型映射**：

| 业务类型 | IM 消息类型 | business_type 标识 |
|---------|------------|-------------------|
| 评论     | comment    | comment           |
| 讨论     | discussion | discussion        |
| 私信     | text/image/file | direct_message |

---

## API 接口

### 1. 作品相关接口

**路由文件**：`packages/master/src/api/routes/im/works.js`

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/im/works | 获取作品列表 |
| GET | /api/im/works/:workId | 获取单个作品 |
| POST | /api/im/works | 创建作品 |
| PUT | /api/im/works/:workId | 更新作品 |
| PUT | /api/im/works/:workId/read | 标记作品为已读 |
| DELETE | /api/im/works/:workId | 删除作品 |
| GET | /api/im/works/:workId/stats | 获取作品统计 |

**示例请求**：

```bash
# 获取作品列表
curl http://localhost:3000/api/im/works?count=10&platform=douyin

# 获取单个作品
curl http://localhost:3000/api/im/works/{workId}

# 标记作品为已读
curl -X PUT http://localhost:3000/api/im/works/{workId}/read
```

### 2. 讨论相关接口

**路由文件**：`packages/master/src/api/routes/im/discussions.js`

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/im/discussions | 获取讨论列表 |
| GET | /api/im/discussions/:discussionId | 获取单个讨论 |
| POST | /api/im/discussions | 创建讨论 |
| PUT | /api/im/discussions/:discussionId | 更新讨论 |
| PUT | /api/im/discussions/:discussionId/read | 标记讨论为已读 |
| DELETE | /api/im/discussions/:discussionId | 删除讨论 |
| GET | /api/im/comments/:commentId/discussions | 获取评论的所有讨论 |

**示例请求**：

```bash
# 获取讨论列表
curl http://localhost:3000/api/im/discussions?count=10&parent_comment_id={commentId}

# 获取评论的讨论统计
curl http://localhost:3000/api/im/comments/{commentId}/discussions
```

### 3. 统一消息接口

**路由文件**：`packages/master/src/api/routes/im/unified-messages.js`

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/im/unified-messages | 获取统一消息列表 |
| GET | /api/im/unified-messages/stats | 获取未读统计 |
| PUT | /api/im/unified-messages/:messageId/read | 标记消息为已读 |
| PUT | /api/im/unified-messages/read-many | 批量标记消息为已读 |

**示例请求**：

```bash
# 获取所有类型的消息
curl http://localhost:3000/api/im/unified-messages?count=20&account_id={accountId}

# 只获取评论和讨论
curl "http://localhost:3000/api/im/unified-messages?types=comment,discussion"

# 获取未读统计
curl http://localhost:3000/api/im/unified-messages/stats?account_id={accountId}
```

**响应示例**：

```json
{
  "data": {
    "messages": [
      {
        "msg_id": "uuid",
        "conversation_id": "work_123",
        "msg_type": "comment",
        "business_type": "comment",
        "sender": {
          "user_id": "user123",
          "user_name": "用户名",
          "avatar": ""
        },
        "content": "评论内容",
        "work_id": "work123",
        "work_title": "作品标题",
        "is_read": false,
        "is_new": true,
        "create_time": 1698765432000,
        "detected_at": 1698765432000,
        "platform": "douyin"
      }
    ]
  },
  "status_code": 0,
  "cursor": 20,
  "has_more": true
}
```

---

## 客户端集成

### 1. TypeScript 接口定义

**文件位置**：`packages/crm-pc-im/src/services/api.ts`

**新增接口**：

```typescript
// 作品接口
export interface IMWork {
  work_id: string
  platform: string
  platform_work_id: string
  work_type: string
  title: string
  description: string
  cover: string
  url: string
  publish_time: number
  stats: {
    total_comments: number
    new_comments: number
    likes: number
    shares: number
    views: number
  }
  is_new: boolean
  crawl_status: string
  created_at: number
  updated_at: number
  last_crawl_time: number
}

// 讨论接口
export interface IMDiscussion {
  discussion_id: string
  platform: string
  platform_discussion_id: string
  parent_comment_id: string
  content: string
  author: {
    author_id: string
    author_name: string
  }
  work_id: string
  post_id: string
  post_title: string
  is_read: boolean
  is_new: boolean
  detected_at: number
  created_at: number
}

// 统一消息接口
export interface IMUnifiedMessage {
  msg_id: string
  conversation_id: string
  msg_type: string
  business_type: 'comment' | 'discussion' | 'direct_message'
  sender: {
    user_id: string
    user_name: string
    avatar: string
  }
  receiver?: {
    user_id: string
    user_name: string
    avatar: string
  }
  content: string
  work_id?: string
  work_title?: string
  parent_comment_id?: string
  direction?: string
  is_read: boolean
  is_new: boolean
  create_time: number
  detected_at: number
  platform: string
  platform_comment_id?: string
  platform_discussion_id?: string
  platform_message_id?: string
  status?: string
}
```

### 2. API 服务方法

**新增方法**：

```typescript
class APIService {
  // 作品相关
  async getWorks(params)              // 获取作品列表
  async getWork(workId)               // 获取单个作品
  async markWorkAsRead(workId)        // 标记作品为已读

  // 讨论相关
  async getDiscussions(params)        // 获取讨论列表
  async getDiscussion(discussionId)   // 获取单个讨论
  async markDiscussionAsRead(discussionId) // 标记讨论为已读

  // 统一消息
  async getUnifiedMessages(params)    // 获取统一消息列表
  async getUnreadStats(accountId)     // 获取未读统计
  async markUnifiedMessageAsRead(messageId, businessType) // 标记消息为已读
}
```

---

## 测试

### 1. 增强版 IM API 测试

**文件位置**：`tests/test-enhanced-im-api.js`

**测试内容**：
1. ✅ 数据库表验证（works 和 discussions 表）
2. 获取作品列表
3. 获取单个作品
4. 获取讨论列表
5. 创建讨论
6. 获取统一消息列表
7. 获取未读统计

**运行方式**：

```bash
# 启动 Master 服务器
cd packages/master
npm start

# 运行测试
node tests/test-enhanced-im-api.js
```

**测试结果**（数据库验证）：
```
✓ works 表存在，包含 1 条记录
✓ discussions 表存在，包含 0 条记录
```

### 2. 原有 IM API 测试

**文件位置**：`tests/test-im-api-integration.js`

**测试内容**：
- 账户管理接口
- 会话管理接口
- 消息管理接口

---

## 系统架构

### 数据流图

```
┌─────────────────┐
│  crm-pc-im      │
│  客户端         │
└────────┬────────┘
         │ HTTP API
         ↓
┌─────────────────┐
│  /api/im        │
│  IM 兼容层      │
└────────┬────────┘
         │
    ┌────┴──────┬──────────┐
    ↓           ↓          ↓
┌────────┐ ┌────────┐ ┌──────────┐
│ Works  │ │ Discus │ │ Unified  │
│ Router │ │ Router │ │ Messages │
└───┬────┘ └───┬────┘ └────┬─────┘
    │          │           │
    ↓          ↓           ↓
┌────────────────────────────┐
│    Transformers            │
│  (数据格式转换层)          │
└────────────┬───────────────┘
             │
             ↓
┌────────────────────────────┐
│         DAO Layer          │
│  (数据访问对象)            │
└────────────┬───────────────┘
             │
             ↓
┌────────────────────────────┐
│      SQLite Database       │
│  (works, discussions,      │
│   comments, direct_msgs)   │
└────────────────────────────┘
```

### 消息类型映射

```
┌──────────────┐     ┌──────────────┐
│   Comment    │────▶│ IM Message   │
│   Table      │     │ (comment)    │
└──────────────┘     └──────────────┘

┌──────────────┐     ┌──────────────┐
│  Discussion  │────▶│ IM Message   │
│   Table      │     │ (discussion) │
└──────────────┘     └──────────────┘

┌──────────────┐     ┌──────────────┐
│ Direct Msg   │────▶│ IM Message   │
│   Table      │     │ (text/image) │
└──────────────┘     └──────────────┘
```

---

## 文件清单

### 数据库相关
- ✅ `packages/master/src/database/schema.sql` - 更新 schema（新增 works 和 discussions 表）
- ✅ `packages/master/src/database/add-works-discussions-tables.js` - 数据库迁移脚本

### DAO 层
- ✅ `packages/master/src/dao/WorksDAO.js` - 作品数据访问对象
- ✅ `packages/master/src/dao/DiscussionsDAO.js` - 讨论数据访问对象

### 数据转换层
- ✅ `packages/master/src/api/transformers/work-transformer.js` - 作品转换器
- ✅ `packages/master/src/api/transformers/discussion-transformer.js` - 讨论转换器
- ✅ `packages/master/src/api/transformers/unified-message-transformer.js` - 统一消息转换器

### API 路由
- ✅ `packages/master/src/api/routes/im/works.js` - 作品路由
- ✅ `packages/master/src/api/routes/im/discussions.js` - 讨论路由
- ✅ `packages/master/src/api/routes/im/unified-messages.js` - 统一消息路由
- ✅ `packages/master/src/api/routes/im/index.js` - IM 路由入口（已更新）

### 客户端
- ✅ `packages/crm-pc-im/src/services/api.ts` - API 服务（新增接口方法和类型定义）

### 测试
- ✅ `tests/test-enhanced-im-api.js` - 增强版 IM API 集成测试

---

## 关键特性

### 1. 数据完整性

- ✅ 使用 UUID 主键
- ✅ 三字段组合唯一约束（防止重复）
- ✅ 外键关系和级联删除
- ✅ CHECK 约束保证数据有效性

### 2. 时间戳转换

- Master 格式：秒级时间戳
- IM 格式：毫秒级时间戳
- 自动转换层处理所有转换

### 3. 统一消息接口

- 单一接口获取所有类型消息（评论、讨论、私信）
- 统一的未读管理
- 统一的标记已读接口
- business_type 字段标识消息类型

### 4. 扩展性

- work_type 支持多种作品类型
- platform 字段支持多平台
- 灵活的查询和过滤选项

---

## 使用指南

### 1. 启动服务

```bash
# 启动 Master 服务器
cd packages/master
npm start

# 启动 crm-pc-im 客户端
cd packages/crm-pc-im
npm run dev
```

### 2. API 调用示例

```javascript
import { apiService } from './services/api'

// 获取作品列表
const worksResponse = await apiService.getWorks({
  count: 20,
  platform: 'douyin',
  work_type: 'video'
})

// 获取讨论列表
const discussionsResponse = await apiService.getDiscussions({
  parent_comment_id: 'comment123',
  is_new: true
})

// 获取统一消息（包含评论、讨论、私信）
const messagesResponse = await apiService.getUnifiedMessages({
  account_id: 'account123',
  types: 'comment,discussion,direct_message',
  is_new: true
})

// 获取未读统计
const statsResponse = await apiService.getUnreadStats('account123')
console.log(statsResponse.data) // { total_unread: 10, comment_unread: 5, ... }

// 标记消息为已读
await apiService.markUnifiedMessageAsRead('msg123', 'comment')
```

### 3. 数据库操作示例

```javascript
const Database = require('better-sqlite3')
const WorksDAO = require('./dao/WorksDAO')
const DiscussionsDAO = require('./dao/DiscussionsDAO')

const db = new Database('./data/master.db')

// 作品操作
const worksDAO = new WorksDAO(db)

// 创建作品
const work = worksDAO.create({
  account_id: 'account123',
  platform: 'douyin',
  platform_work_id: 'work123',
  work_type: 'video',
  title: '作品标题',
  cover: 'https://...',
  total_comment_count: 10
})

// 查询作品
const works = worksDAO.findByAccountId('account123', {
  work_type: 'video',
  limit: 10
})

// 讨论操作
const discussionsDAO = new DiscussionsDAO(db)

// 创建讨论
const discussion = discussionsDAO.create({
  account_id: 'account123',
  platform: 'douyin',
  parent_comment_id: 'comment123',
  content: '讨论内容',
  author_name: '用户名'
})

// 查询评论的讨论
const discussions = discussionsDAO.findByParentCommentId('comment123')
```

---

## 下一步计划

### 短期计划

1. ✅ 完成数据库结构设计
2. ✅ 实现 DAO 层
3. ✅ 实现数据转换层
4. ✅ 实现 API 接口
5. ✅ 更新客户端
6. ✅ 编写测试
7. ✅ 生成技术文档

### 长期计划

1. **UI 组件开发**
   - 作品列表组件
   - 讨论展示组件
   - 统一消息列表组件

2. **WebSocket 实时推送**
   - 实时评论通知
   - 实时讨论通知
   - 统一消息推送

3. **性能优化**
   - 消息分页加载优化
   - 缓存策略
   - 索引优化

4. **功能增强**
   - 消息搜索
   - 消息过滤
   - 批量操作

---

## 总结

本次实现完成了以下核心目标：

✅ **数据库增强**
- 新增 works 表（作品表）
- 新增 discussions 表（讨论表）
- 完成数据迁移

✅ **DAO 层实现**
- WorksDAO 完整实现
- DiscussionsDAO 完整实现

✅ **数据转换层**
- WorkTransformer
- DiscussionTransformer
- UnifiedMessageTransformer

✅ **API 接口**
- 7 个作品相关接口
- 7 个讨论相关接口
- 4 个统一消息接口

✅ **客户端集成**
- TypeScript 接口定义
- API 服务方法
- 完整的类型支持

✅ **测试和文档**
- 集成测试脚本
- 技术文档

**数据库统计**：
- 总表数：18 个（16 个原有 + 2 个新增）
- works 表：1 条记录（迁移自 douyin_videos）
- discussions 表：0 条记录（新表）

**API 统计**：
- 原有 IM 接口：19 个
- 新增接口：18 个
- 总计：37 个 API 接口

系统现已支持完整的业务模型，可以统一管理账号、作品、评论、讨论、私信等所有业务实体，并通过 /api/im 接口为客户端提供标准化的 IM 格式数据访问。

---

**文档版本**：v1.0
**最后更新**：2025-10-23
**作者**：Claude Code
