# ç™»å½•æ£€æµ‹ç”¨æˆ·ä¿¡æ¯è‡ªåŠ¨åŒæ­¥ä¿®å¤è®°å½•

**æ—¥æœŸ**ï¼š2025-11-25
**é—®é¢˜**ï¼šWorker ç™»å½•æ£€æµ‹ä»»åŠ¡æ£€æµ‹åˆ°è´¦æˆ·å·²ç™»å½•åï¼Œæå–äº†ç”¨æˆ·ä¿¡æ¯ï¼ˆæ˜µç§°ã€å¤´åƒã€æŠ–éŸ³å·ï¼‰ï¼Œä½†æ²¡æœ‰åŒæ­¥ç»™ Master å’Œ IM å®¢æˆ·ç«¯

---

## é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 

Worker çš„ `LoginDetectionTask` å®šæœŸæ£€æŸ¥è´¦æˆ·ç™»å½•çŠ¶æ€æ—¶ï¼š
1. âœ… è°ƒç”¨ `platform.checkLoginStatus(page)` æˆåŠŸæå–äº† `userInfo`
2. âŒ åªä½¿ç”¨äº† `loginStatus.isLoggedIn` å­—æ®µä¸ŠæŠ¥ç™»å½•çŠ¶æ€
3. âŒ **å®Œå…¨å¿½ç•¥äº† `loginStatus.userInfo`** å­—æ®µ
4. âŒ å¯¼è‡´æ•°æ®åº“ä¸­ `platform_username`ã€`avatar`ã€`platform_user_id` å­—æ®µå§‹ç»ˆä¸º NULL

### é—®é¢˜åœºæ™¯

**è§¦å‘æ¡ä»¶**ï¼šè´¦æˆ·é€šè¿‡ cookies è‡ªåŠ¨ç™»å½•ï¼ˆéæ‰‹åŠ¨æ‰«ç ç™»å½•ï¼‰

**ç°è±¡**ï¼š
- Worker æ—¥å¿—æ˜¾ç¤ºï¼šç™»å½•çŠ¶æ€æ£€æµ‹æˆåŠŸ
- Master æ—¥å¿—æ˜¾ç¤ºï¼š`[Status Push] âœ… æ¨é€è´¦æˆ·çŠ¶æ€æ›´æ–°: xxx, login_status=logged_in`
- ä½†æ•°æ®åº“æŸ¥è¯¢æ˜¾ç¤ºï¼š`platform_username`ã€`avatar`ã€`platform_user_id` å‡ä¸º NULL
- IM å®¢æˆ·ç«¯ç•Œé¢ï¼šæ— æ³•æ˜¾ç¤ºç”¨æˆ·å¤´åƒå’Œæ˜µç§°

### ä¸æ‰‹åŠ¨ç™»å½•çš„åŒºåˆ«

| ç™»å½•æ–¹å¼ | è§¦å‘äº‹ä»¶ | userInfo æ˜¯å¦ä¿å­˜ | åŸå›  |
|---------|---------|------------------|-----|
| æ‰‹åŠ¨æ‰«ç ç™»å½• | `worker:login:success` (æ‰‹åŠ¨è§¦å‘) | âœ… ä¿å­˜ | login-handler.js å®Œæ•´å¤„ç† userInfo |
| è‡ªåŠ¨ç™»å½•ï¼ˆcookiesï¼‰ | `WORKER_ACCOUNT_STATUS` (å®šæœŸä¸ŠæŠ¥) | âŒ ä¸ä¿å­˜ | åªä¸ŠæŠ¥ login_statusï¼Œæœªä¸ŠæŠ¥ userInfo |

---

## è§£å†³æ–¹æ¡ˆ

### è®¾è®¡æ€è·¯

**å¤ç”¨ç°æœ‰çš„ç™»å½•æˆåŠŸå¤„ç†æµç¨‹**ï¼š
- Worker æ£€æµ‹åˆ°ç™»å½•ä¸”æœ‰ userInfo æ—¶ï¼Œé€šè¿‡ `worker:login:success` äº‹ä»¶å‘é€ç»™ Master
- Master åŒºåˆ†ä¸¤ç§åœºæ™¯å¤„ç†ï¼š
  - **åœºæ™¯1**ï¼šæ‰‹åŠ¨ç™»å½•ï¼ˆæœ‰ session_idï¼‰â†’ ä½¿ç”¨ loginHandler.handleLoginSuccess()
  - **åœºæ™¯2**ï¼šç™»å½•æ£€æµ‹ï¼ˆåªæœ‰ account_idï¼‰â†’ ç›´æ¥æ›´æ–°æ•°æ®åº“å¹¶æ¨é€ IM

### ä¿®æ”¹å†…å®¹

---

## ä¿®å¤ 1ï¼šWorker å‘é€ç”¨æˆ·ä¿¡æ¯

**æ–‡ä»¶**ï¼š`packages/worker/src/handlers/login-detection-task.js`

### 1.1 åœ¨ç™»å½•æ£€æµ‹æ—¶å‘é€ userInfoï¼ˆç¬¬ 255-258 è¡Œï¼‰

```javascript
// è°ƒç”¨å¹³å°çš„ç™»å½•çŠ¶æ€æ£€æµ‹æ–¹æ³•
const loginStatus = await this.platformInstance.checkLoginStatus(page);
const newStatus = loginStatus.isLoggedIn ? 'logged_in' : 'not_logged_in';

logger.debug(`Login status check result: ${newStatus} (previous: ${this.currentLoginStatus})`);

// ğŸ”‘ å¦‚æœæ£€æµ‹åˆ°å·²ç™»å½•ä¸”æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œå‘é€ç»™ Master ä¿å­˜
if (newStatus === 'logged_in' && loginStatus.userInfo) {
  await this.sendUserInfoToMaster(loginStatus.userInfo);
}
```

**è¯´æ˜**ï¼š
- æ£€æŸ¥ `loginStatus.userInfo` æ˜¯å¦å­˜åœ¨
- è°ƒç”¨æ–°å¢çš„ `sendUserInfoToMaster()` æ–¹æ³•å‘é€ç”¨æˆ·ä¿¡æ¯

### 1.2 æ–°å¢ sendUserInfoToMaster æ–¹æ³•ï¼ˆç¬¬ 510-550 è¡Œï¼‰

```javascript
/**
 * å‘é€ç”¨æˆ·ä¿¡æ¯ç»™ Master ä¿å­˜
 * @param {Object} userInfo - ç”¨æˆ·ä¿¡æ¯ (nickname, avatar, uid/douyin_id, followers, following ç­‰)
 */
async sendUserInfoToMaster(userInfo) {
  try {
    // è·å– SocketClient å®ä¾‹ï¼ˆé€šè¿‡ taskRunnerï¼‰
    const socketClient = this.taskRunner?.socketClient;
    if (!socketClient || !socketClient.isConnected()) {
      logger.warn(`Socket not connected, cannot send user info for account ${this.account.id}`);
      return;
    }

    logger.info(`ğŸ“¤ Sending user info to Master for account ${this.account.id}:`, {
      nickname: userInfo.nickname,
      douyin_id: userInfo.douyin_id || userInfo.uid,
      has_avatar: !!userInfo.avatar
    });

    // æ„é€  worker:login:success æ¶ˆæ¯ï¼ˆå¤ç”¨ç°æœ‰çš„ç™»å½•æˆåŠŸå¤„ç†æµç¨‹ï¼‰
    // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä¸éœ€è¦ session_idï¼Œåªéœ€è¦ account_id å’Œ user_info
    const payload = {
      account_id: this.account.id,
      user_info: {
        platform_username: userInfo.nickname,
        avatar: userInfo.avatar,
        platform_user_id: userInfo.uid || userInfo.douyin_id,
        total_followers: userInfo.followers || 0,
        total_following: userInfo.following || 0,
      },
      timestamp: Date.now(),
    };

    // å‘é€æ¶ˆæ¯
    socketClient.emit('worker:login:success', payload);
    logger.info(`âœ… User info sent to Master: ${userInfo.nickname} (${userInfo.douyin_id || userInfo.uid})`);

  } catch (error) {
    logger.error(`Failed to send user info to Master for account ${this.account.id}:`, error);
  }
}
```

**è¯´æ˜**ï¼š
- é€šè¿‡ `this.taskRunner.socketClient` è·å– Socket å®¢æˆ·ç«¯
- æ„é€ åŒ…å« `account_id` å’Œ `user_info` çš„æ¶ˆæ¯ï¼ˆä¸éœ€è¦ session_idï¼‰
- å‘é€ `worker:login:success` äº‹ä»¶ç»™ Master

---

## ä¿®å¤ 2ï¼šMaster å¤„ç†ç”¨æˆ·ä¿¡æ¯

**æ–‡ä»¶**ï¼š`packages/master/src/index.js`

### 2.1 æ‰©å±• onLoginSuccess handlerï¼ˆç¬¬ 632-716 è¡Œï¼‰

```javascript
tempHandlers.onLoginSuccess = (data) => {
  // ğŸ”‘ åœºæ™¯1ï¼šæ‰‹åŠ¨ç™»å½•æµç¨‹ï¼ˆæœ‰ session_idï¼‰
  if (data.session_id) {
    // æå–çœŸå®çš„è´¦æˆ·ID (ä» user_info.uid æˆ– user_info.douyin_id)
    const realAccountId = data.user_info ? (data.user_info.uid || data.user_info.douyin_id) : null;

    loginHandler.handleLoginSuccess(
      data.session_id,
      data.cookies,           // Cookie æ•°ç»„
      data.cookies_valid_until,
      realAccountId,          // çœŸå®è´¦æˆ·ID
      data.user_info,         // ç”¨æˆ·ä¿¡æ¯
      data.fingerprint        // æµè§ˆå™¨æŒ‡çº¹
    );
  }
  // ğŸ”‘ åœºæ™¯2ï¼šç™»å½•æ£€æµ‹æµç¨‹ï¼ˆåªæœ‰ account_id å’Œ user_infoï¼Œç”¨äºæ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼‰
  else if (data.account_id && data.user_info) {
    logger.info(`[Login Detection] Received user info for account ${data.account_id}:`, {
      nickname: data.user_info.platform_username,
      platform_user_id: data.user_info.platform_user_id
    });

    try {
      const now = Math.floor(Date.now() / 1000);

      // æ„å»ºåŠ¨æ€æ›´æ–° SQL
      const updateFields = ['updated_at = ?'];
      const params = [now];

      // æ›´æ–° platform_usernameï¼ˆæ˜µç§°ï¼‰
      if (data.user_info.platform_username) {
        updateFields.push('platform_username = ?');
        params.push(data.user_info.platform_username);
        logger.info(`[Login Detection] Updating platform_username to: ${data.user_info.platform_username}`);
      }

      // æ›´æ–° avatarï¼ˆå¤´åƒï¼‰
      if (data.user_info.avatar) {
        updateFields.push('avatar = ?');
        params.push(data.user_info.avatar);
        logger.info(`[Login Detection] Updating avatar to: ${data.user_info.avatar}`);
      }

      // æ›´æ–° platform_user_idï¼ˆæŠ–éŸ³å·/uidï¼‰ï¼Œä»…åœ¨ä¸ºç©ºæ—¶æ›´æ–°
      if (data.user_info.platform_user_id) {
        const currentAccount = db.prepare('SELECT platform_user_id FROM accounts WHERE id = ?').get(data.account_id);
        if (!currentAccount || !currentAccount.platform_user_id) {
          updateFields.push('platform_user_id = ?');
          params.push(data.user_info.platform_user_id);
          logger.info(`[Login Detection] Updating platform_user_id to: ${data.user_info.platform_user_id}`);
        }
      }

      // æ›´æ–° total_followers å’Œ total_following
      if (data.user_info.total_followers !== undefined) {
        updateFields.push('total_followers = ?');
        params.push(data.user_info.total_followers);
      }

      if (data.user_info.total_following !== undefined) {
        updateFields.push('total_following = ?');
        params.push(data.user_info.total_following);
      }

      // æ·»åŠ  WHERE æ¡ä»¶çš„ accountId
      params.push(data.account_id);

      const sql = `UPDATE accounts SET ${updateFields.join(', ')} WHERE id = ?`;
      const result = db.prepare(sql).run(...params);

      if (result.changes > 0) {
        logger.info(`[Login Detection] âœ… User info updated successfully for account ${data.account_id}`);

        // æ¨é€è´¦æˆ·çŠ¶æ€å˜æ›´åˆ° IM å®¢æˆ·ç«¯
        accountStatusUpdater.pushAccountStatusToIM(data.account_id);
      } else {
        logger.warn(`[Login Detection] Account ${data.account_id} not found or not updated`);
      }
    } catch (error) {
      logger.error(`[Login Detection] Failed to update user info for account ${data.account_id}:`, error);
    }
  } else {
    logger.warn('[Login Detection] Invalid login success data: missing session_id or account_id');
  }
};
```

**è¯´æ˜**ï¼š
- **åœºæ™¯1**ï¼šæ‰‹åŠ¨ç™»å½•ï¼ˆæœ‰ `session_id`ï¼‰â†’ è°ƒç”¨ `loginHandler.handleLoginSuccess()`ï¼Œèµ°å®Œæ•´çš„ç™»å½•æµç¨‹
- **åœºæ™¯2**ï¼šç™»å½•æ£€æµ‹ï¼ˆåªæœ‰ `account_id`ï¼‰â†’ ç›´æ¥æ›´æ–°æ•°æ®åº“å­—æ®µï¼š
  - `platform_username`ï¼ˆæ˜µç§°ï¼‰
  - `avatar`ï¼ˆå¤´åƒï¼‰
  - `platform_user_id`ï¼ˆæŠ–éŸ³å·/UIDï¼‰
  - `total_followers`ã€`total_following`ï¼ˆç²‰ä¸æ•°ã€å…³æ³¨æ•°ï¼‰
- æ›´æ–°æˆåŠŸåï¼Œè°ƒç”¨ `accountStatusUpdater.pushAccountStatusToIM()` æ¨é€ç»™ IM å®¢æˆ·ç«¯

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **é‡å¯ Master æœåŠ¡**ï¼ˆåº”ç”¨ index.js ä¿®æ”¹ï¼‰ï¼š
   ```bash
   cd packages/master && npm start
   ```

2. **é‡å¯ Worker æœåŠ¡**ï¼ˆåº”ç”¨ login-detection-task.js ä¿®æ”¹ï¼‰ï¼š
   ```bash
   cd packages/worker && npm start
   ```

3. **ç­‰å¾…ç™»å½•æ£€æµ‹ä»»åŠ¡æ‰§è¡Œ**ï¼ˆé»˜è®¤ 30 ç§’é—´éš”ï¼‰ï¼š
   - Worker ä¼šè‡ªåŠ¨æ£€æµ‹ç™»å½•çŠ¶æ€
   - æå–ç”¨æˆ·ä¿¡æ¯å¹¶å‘é€ç»™ Master

4. **è§‚å¯Ÿæ—¥å¿—**ï¼š

   **Worker æ—¥å¿—**ï¼š
   ```
   ğŸ“¤ Sending user info to Master for account acc-xxx: { nickname: 'èŠ³èŠ³', douyin_id: 'MS4w...', has_avatar: true }
   âœ… User info sent to Master: èŠ³èŠ³ (MS4w...)
   ```

   **Master æ—¥å¿—**ï¼š
   ```
   [Login Detection] Received user info for account acc-xxx: { nickname: 'èŠ³èŠ³', platform_user_id: 'MS4w...' }
   [Login Detection] Updating platform_username to: èŠ³èŠ³
   [Login Detection] Updating avatar to: https://...
   [Login Detection] Updating platform_user_id to: MS4w...
   [Login Detection] âœ… User info updated successfully for account acc-xxx
   [Status Push] âœ… æ¨é€è´¦æˆ·çŠ¶æ€æ›´æ–°åˆ° IM: acc-xxx
   ```

5. **éªŒè¯æ•°æ®åº“**ï¼š
   ```bash
   cd packages/master
   node check-account.js
   ```

   åº”æ˜¾ç¤ºï¼š
   ```json
   {
     "platform_username": "èŠ³èŠ³",
     "avatar": "https://p3-pc.douyinpic.com/...",
     "platform_user_id": "MS4wLjABAAAA...",
     "login_status": "logged_in",
     "worker_status": "online"
   }
   ```

6. **éªŒè¯ IM å®¢æˆ·ç«¯**ï¼š
   - æŸ¥çœ‹ IM å®¢æˆ·ç«¯ç•Œé¢
   - åº”æ˜¾ç¤ºç”¨æˆ·å¤´åƒå’Œæ˜µç§°
   - æ— éœ€æ‰‹åŠ¨åˆ·æ–°ï¼ˆå®æ—¶æ¨é€ï¼‰

### é¢„æœŸç»“æœ

- âœ… Worker æ¯æ¬¡ç™»å½•æ£€æµ‹æ—¶è‡ªåŠ¨æå–å¹¶å‘é€ç”¨æˆ·ä¿¡æ¯
- âœ… Master æ¥æ”¶å¹¶ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°æ•°æ®åº“
- âœ… Master æ¨é€æ›´æ–°åˆ° IM å®¢æˆ·ç«¯
- âœ… IM å®¢æˆ·ç«¯å®æ—¶æ˜¾ç¤ºå¤´åƒå’Œæ˜µç§°
- âœ… æ•°æ®åº“å­—æ®µæ­£ç¡®æ›´æ–°

---

## æŠ€æœ¯è¦ç‚¹

### 1. æ¶ˆæ¯æ ¼å¼å¤ç”¨

**Worker å‘é€**ï¼š
```javascript
{
  account_id: 'acc-xxx',        // è´¦æˆ· IDï¼ˆåŒºåˆ†åœºæ™¯çš„å…³é”®ï¼‰
  user_info: {
    platform_username: 'èŠ³èŠ³',
    avatar: 'https://...',
    platform_user_id: 'MS4w...',
    total_followers: 1234,
    total_following: 56
  },
  timestamp: 1732517621000
}
```

**æ‰‹åŠ¨ç™»å½•å‘é€**ï¼ˆåŒ…å« session_idï¼‰ï¼š
```javascript
{
  session_id: 'login-session-xxx',  // ç™»å½•ä¼šè¯ IDï¼ˆåŒºåˆ†åœºæ™¯çš„å…³é”®ï¼‰
  account_id: 'acc-xxx',
  cookies: [...],
  cookies_valid_until: 1732604021,
  user_info: { ... },
  fingerprint: { ... }
}
```

### 2. åœºæ™¯åŒºåˆ†é€»è¾‘

```javascript
if (data.session_id) {
  // æ‰‹åŠ¨ç™»å½•æµç¨‹ â†’ loginHandler.handleLoginSuccess()
} else if (data.account_id && data.user_info) {
  // ç™»å½•æ£€æµ‹æµç¨‹ â†’ ç›´æ¥æ›´æ–°æ•°æ®åº“
} else {
  // æ— æ•ˆæ•°æ®
}
```

### 3. å®æ—¶æ¨é€é“¾è·¯

```
Worker (LoginDetectionTask)
  â†“ worker:login:success
Master (onLoginSuccess handler)
  â†“ UPDATE accounts SET platform_username = ?, avatar = ?
Database (master.db)
  â†“ accountStatusUpdater.pushAccountStatusToIM()
Master (IM WebSocket Server)
  â†“ channel:status_update
Electron (main.ts)
  â†“ account-status-updated
IM Client (MonitorPage.tsx)
  â†“ æ˜¾ç¤ºå¤´åƒå’Œæ˜µç§°
```

---

## å…³è”æ–‡ä»¶

### Worker ç«¯
- `packages/worker/src/handlers/login-detection-task.js`ï¼šç™»å½•æ£€æµ‹ä»»åŠ¡ï¼ˆæ–°å¢ sendUserInfoToMaster æ–¹æ³•ï¼‰
- `packages/worker/src/platforms/douyin/platform.js`ï¼šæŠ–éŸ³å¹³å°å®ç°ï¼ˆåŒ…å« checkLoginStatus å’Œ extractUserInfo æ–¹æ³•ï¼‰

### Master ç«¯
- `packages/master/src/index.js`ï¼šMaster åˆå§‹åŒ–ï¼ˆæ‰©å±• onLoginSuccess handlerï¼‰
- `packages/master/src/worker_manager/account-status-updater.js`ï¼šè´¦æˆ·çŠ¶æ€æ›´æ–°å™¨ï¼ˆæ¨é€åˆ° IMï¼‰
- `packages/master/src/login/login-handler.js`ï¼šç™»å½•å¤„ç†å™¨ï¼ˆæ‰‹åŠ¨ç™»å½•æµç¨‹ï¼‰

### IM å®¢æˆ·ç«¯
- `packages/crm-pc-im/electron/main.ts`ï¼šç›‘å¬ `channel:status_update` äº‹ä»¶
- `packages/crm-pc-im/src/pages/MonitorPage.tsx`ï¼šæ˜¾ç¤ºè´¦æˆ·çŠ¶æ€

---

## åç»­ä¼˜åŒ–å»ºè®®

1. **å®šæœŸåˆ·æ–°ç”¨æˆ·ä¿¡æ¯**ï¼š
   - å½“å‰åªåœ¨æ£€æµ‹åˆ°ç™»å½•æ—¶å‘é€ä¸€æ¬¡ç”¨æˆ·ä¿¡æ¯
   - å¯ä»¥è€ƒè™‘å®šæœŸåˆ·æ–°ï¼ˆå¦‚ç²‰ä¸æ•°å˜åŒ–ï¼‰

2. **å¢é‡æ›´æ–°ä¼˜åŒ–**ï¼š
   - å½“å‰æ¯æ¬¡æ£€æµ‹éƒ½å‘é€å®Œæ•´çš„ userInfo
   - å¯ä»¥æ·»åŠ æœ¬åœ°ç¼“å­˜ï¼Œåªåœ¨ä¿¡æ¯å˜åŒ–æ—¶å‘é€

3. **é”™è¯¯é‡è¯•æœºåˆ¶**ï¼š
   - å½“ Socket æœªè¿æ¥æ—¶ï¼Œæš‚æ—¶æ— æ³•å‘é€ç”¨æˆ·ä¿¡æ¯
   - å¯ä»¥æ·»åŠ é‡è¯•é˜Ÿåˆ—

4. **æ—¥å¿—çº§åˆ«è°ƒæ•´**ï¼š
   - ç”Ÿäº§ç¯å¢ƒå¯ä»¥å°† `ğŸ“¤ Sending user info` æ—¥å¿—æ”¹ä¸º debug çº§åˆ«
   - é¿å…é¢‘ç¹è¾“å‡º

---

## ç›¸å…³æ–‡æ¡£

- [è´¦æˆ·çŠ¶æ€å’Œç”¨æˆ·ä¿¡æ¯æ¨é€ä¿®å¤è®°å½•.md](./è´¦æˆ·çŠ¶æ€å’Œç”¨æˆ·ä¿¡æ¯æ¨é€ä¿®å¤è®°å½•.md) - æ‰‹åŠ¨ç™»å½•æµç¨‹çš„ç”¨æˆ·ä¿¡æ¯æ¨é€ä¿®å¤
- [Electronè¿æ¥ä¿®å¤è®°å½•.md](./Electronè¿æ¥ä¿®å¤è®°å½•.md) - IM å®¢æˆ·ç«¯ WebSocket è¿æ¥ä¿®å¤
- [æ‰‹åŠ¨ç™»å½•åŠŸèƒ½å®ç°æ–‡æ¡£.md](./æ‰‹åŠ¨ç™»å½•åŠŸèƒ½å®ç°æ–‡æ¡£.md) - æ‰‹åŠ¨ç™»å½•åŠŸèƒ½æ•´ä½“è®¾è®¡
