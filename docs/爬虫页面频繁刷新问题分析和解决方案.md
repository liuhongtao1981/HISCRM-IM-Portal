# 爬虫页面频繁刷新问题分析和解决方案

**问题时间**: 2025-10-24 21:00
**问题描述**: 执行任务时,爬虫窗口一直刷新
**状态**: 📋 分析完成,等待确认解决方案

---

## 问题分析

### 用户反馈

用户截图显示抖音创作者中心的私信管理页面处于加载状态,并反馈:
> "执行任务的时候,会一直刷新我的任务tab"

### 根本原因

这**不是bug,而是当前设计的预期行为**:

```javascript
// packages/worker/src/handlers/monitor-task.js

// 1. 爬虫任务每 15-30 秒执行一次
this.minInterval = 15;  // 最小间隔15秒
this.maxInterval = 30;  // 最大间隔30秒

// 2. 每次执行时调用爬虫方法
await this.platformInstance.crawlDirectMessages(this.account);
```

```javascript
// packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js

async function crawlDirectMessagesV2(page, account) {
  // ❌ 每次都导航到私信页面
  await page.goto('https://creator.douyin.com/creator-micro/data/following/chat', {
    waitUntil: 'domcontentloaded',
    timeout: 30000
  });

  // 抓取数据...
}
```

**流程**:
```
T0: 爬虫任务启动
  ↓
调用 crawlDirectMessages()
  ↓
page.goto() → 页面刷新
  ↓
抓取数据
  ↓
等待 15-30 秒
  ↓
再次调用 crawlDirectMessages()
  ↓
page.goto() → 页面再次刷新  ← 用户看到的"一直刷新"
  ↓
循环...
```

### 为什么要 goto()?

当前设计每次都 `goto()` 的原因:

1. **确保在正确页面**: 防止用户手动切换页面导致爬虫失败
2. **重置页面状态**: 清除上次爬取留下的DOM状态
3. **触发API请求**: 页面加载时会触发会话列表API

---

## 影响分析

### 用户体验影响

1. **视觉干扰**: 用户看到窗口不断刷新,加载圆圈旋转
2. **操作打断**: 如果用户正在查看某个会话,会被强制刷新回列表
3. **流量消耗**: 每次刷新都重新加载页面资源

### 平台检测风险

1. **频繁导航**: 每 15-30 秒刷新一次,可能被识别为自动化行为
2. **固定间隔**: 虽然有随机化,但仍然是周期性行为
3. **完整加载**: 每次都完整加载页面,增加检测概率

---

## 解决方案对比

### 方案A: 智能页面检查 (推荐 ⭐)

**核心思路**: 检查当前页面URL,只在需要时导航

```javascript
async function crawlDirectMessagesV2(page, account) {
  logger.info(`Starting private message crawl for account ${account.id}`);

  // ⭐ 智能页面检查
  const currentUrl = page.url();
  const targetUrl = 'https://creator.douyin.com/creator-micro/data/following/chat';

  if (!currentUrl.includes('creator-micro/data/following/chat')) {
    // 不在私信页面,需要导航
    logger.info(`Not on message page (current: ${currentUrl}), navigating...`);
    await page.goto(targetUrl, {
      waitUntil: 'domcontentloaded',
      timeout: 30000
    });
    await page.waitForTimeout(2000);
  } else {
    // 已在私信页面,刷新数据即可
    logger.info(`Already on message page, refreshing data...`);

    // 方式1: 软刷新 - 点击会话列表刷新按钮 (如果有)
    // await page.click('[data-testid="refresh-button"]');

    // 方式2: 软刷新 - 重新请求API (不刷新页面)
    // 等待会话列表更新
    await page.waitForTimeout(1000);
  }

  // 后续抓取逻辑...
  const conversations = await extractConversationsList(page, account);
  // ...
}
```

**优点**:
- ✅ 首次运行时导航到正确页面
- ✅ 后续运行不刷新页面,用户体验好
- ✅ 减少流量消耗
- ✅ 降低平台检测风险

**缺点**:
- ⚠️ 如果页面状态异常,可能需要手动恢复
- ⚠️ 需要处理会话列表数据刷新

### 方案B: 增量检测 (最优 ⭐⭐⭐)

**核心思路**: 不刷新页面,直接读取当前会话列表,只检测新消息

```javascript
async function crawlDirectMessagesV2(page, account) {
  logger.info(`Starting incremental private message crawl`);

  // 1. 智能导航 (同方案A)
  const currentUrl = page.url();
  if (!currentUrl.includes('creator-micro/data/following/chat')) {
    logger.info(`Navigating to message page...`);
    await page.goto('https://creator.douyin.com/creator-micro/data/following/chat', {
      waitUntil: 'domcontentloaded',
      timeout: 30000
    });
    await page.waitForTimeout(2000);
  } else {
    logger.info(`Already on message page, performing incremental check...`);
  }

  // 2. 提取当前会话列表 (不刷新页面)
  const conversations = await extractConversationsList(page, account);

  // 3. ⭐ 只检查有新消息的会话
  const conversationsWithNewMessages = conversations.filter(conv => {
    // 检查是否有未读消息标记
    return conv.has_unread || conv.unread_count > 0;
  });

  logger.info(`Found ${conversationsWithNewMessages.length}/${conversations.length} conversations with new messages`);

  // 4. 只爬取有新消息的会话
  const directMessages = [];
  for (const conversation of conversationsWithNewMessages) {
    const messages = await crawlConversationMessages(page, conversation, account);
    directMessages.push(...messages);
  }

  return {
    conversations,
    directMessages,
    stats: {
      totalConversations: conversations.length,
      checkedConversations: conversationsWithNewMessages.length,
      newMessages: directMessages.length
    }
  };
}
```

**优点**:
- ✅ 极大减少页面刷新
- ✅ 只处理有新消息的会话,效率高
- ✅ 用户体验最佳
- ✅ 平台检测风险最低

**缺点**:
- ⚠️ 首次运行需要全量爬取
- ⚠️ 需要准确识别未读消息

### 方案C: 增加刷新间隔

**核心思路**: 减少爬虫执行频率

```javascript
// packages/worker/src/handlers/monitor-task.js

// 原来: 15-30秒
this.minInterval = 15;
this.maxInterval = 30;

// 改为: 60-120秒 (1-2分钟)
this.minInterval = 60;
this.maxInterval = 120;
```

**优点**:
- ✅ 实现简单
- ✅ 减少页面刷新频率
- ✅ 降低检测风险

**缺点**:
- ❌ 消息延迟增加
- ❌ 没有解决页面刷新问题

### 方案D: 后台标签页 (备选)

**核心思路**: 爬虫窗口隐藏,不显示给用户

```javascript
// 创建爬虫窗口时设置为后台
const context = await browser.newContext({
  // ... 其他配置
  viewport: null,  // 不设置视口
});

// 或者最小化窗口
await page.evaluate(() => {
  window.resizeTo(1, 1);
  window.moveTo(screen.width, screen.height);
});
```

**优点**:
- ✅ 用户看不到刷新
- ✅ 不改变爬虫逻辑

**缺点**:
- ❌ 调试困难
- ❌ 不符合我们的设计(用户需要看到浏览器运行)

---

## 推荐方案

### 短期方案: 方案A (智能页面检查)

**实施步骤**:
1. 修改 `crawlDirectMessagesV2()` 添加URL检查
2. 只在不在私信页面时才 `goto()`
3. 在私信页面时等待1秒即可

**代码修改**:
```javascript
// packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js

async function crawlDirectMessagesV2(page, account) {
  logger.info(`[Phase 8] Starting private message crawl for account ${account.id}`);

  try {
    // 第 1 步: 初始化 API 拦截器
    const apiResponses = { /* ... */ };
    await setupAPIInterceptors(page, apiResponses);

    // 第 2 步: ⭐ 智能导航
    const currentUrl = page.url();
    const targetUrl = 'https://creator.douyin.com/creator-micro/data/following/chat';

    if (!currentUrl.includes('creator-micro/data/following/chat')) {
      logger.info(`[Phase 8] Not on message page, navigating from ${currentUrl}...`);
      await page.goto(targetUrl, {
        waitUntil: 'domcontentloaded',
        timeout: 30000
      });
      await page.waitForTimeout(2000);
      logger.info(`[Phase 8] Navigated to message page`);
    } else {
      logger.info(`[Phase 8] Already on message page (${currentUrl}), skipping navigation`);
      // 等待短暂时间确保页面稳定
      await page.waitForTimeout(1000);
    }

    // 第 3 步: 获取会话列表 (从当前页面直接提取)
    const conversations = await extractConversationsList(page, account);
    logger.info(`[Phase 8] Extracted ${conversations.length} conversations`);

    // ... 后续逻辑不变 ...
  } catch (error) {
    logger.error(`[Phase 8] Error in crawl:`, error);
    throw error;
  }
}
```

**预期效果**:
```
第1次执行 (T=0s):
  - 当前URL: about:blank
  - 检测到不在私信页面
  - 导航到私信页面 ← 页面刷新
  - 抓取数据

第2次执行 (T=20s):
  - 当前URL: creator.douyin.com/creator-micro/data/following/chat
  - 检测到已在私信页面
  - 跳过导航 ← 不刷新!
  - 直接抓取数据

第3次执行 (T=45s):
  - 同第2次,不刷新
  - 直接抓取数据
```

### 长期方案: 方案B (增量检测)

**实施步骤**:
1. 实现方案A (智能导航)
2. 添加未读消息检测逻辑
3. 只爬取有新消息的会话
4. 首次运行或定期(如每小时)进行全量爬取

**优势**:
- 效率最高
- 用户体验最佳
- 最接近真实用户行为

---

## 实施建议

### Phase 1: 立即实施 (方案A)

1. **修改私信爬虫** - `crawl-direct-messages-v2.js`
   - 添加URL检查
   - 只在必要时导航

2. **修改评论爬虫** - `crawl-comments.js`
   - 同样添加URL检查
   - 统一处理逻辑

3. **测试验证**
   - 启动Worker
   - 观察爬虫窗口
   - 确认只有首次刷新页面

### Phase 2: 优化提升 (方案B)

1. **实现未读检测**
   - 分析会话列表DOM结构
   - 提取未读标记
   - 只处理有未读的会话

2. **全量/增量混合策略**
   - 增量检测: 每 15-30 秒
   - 全量爬取: 每 1 小时
   - 确保不遗漏消息

### Phase 3: 配置化 (可选)

允许用户配置刷新策略:
```javascript
// worker_configs 表
{
  crawl_strategy: 'incremental',  // 'full' | 'incremental' | 'smart'
  crawl_interval: 30,              // 秒
  full_crawl_interval: 3600,       // 秒 (每小时全量一次)
  force_navigation: false          // 是否每次强制刷新页面
}
```

---

## 风险评估

### 方案A 风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 页面状态异常导致爬取失败 | 低 | 中 | 添加错误重试,失败后强制刷新 |
| 会话列表数据未更新 | 低 | 低 | 定期(每小时)强制刷新一次 |
| 页面路由变化检测失败 | 极低 | 高 | 使用更精确的URL匹配 |

### 方案B 风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 未读标记识别错误 | 中 | 中 | 结合全量爬取,定期校验 |
| 遗漏消息 | 低 | 高 | 每小时全量爬取一次兜底 |
| 首次运行时间长 | 低 | 低 | 显示进度提示 |

---

## 相关文件

需要修改的文件:
1. `packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js`
2. `packages/worker/src/platforms/douyin/crawl-comments.js`
3. `packages/worker/src/handlers/monitor-task.js` (可选,调整间隔)

需要测试的场景:
1. 首次启动爬虫 - 验证导航正常
2. 第二次执行爬虫 - 验证不刷新页面
3. 手动切换页面后执行爬虫 - 验证能检测并导航回去
4. 长时间运行 - 验证稳定性

---

## 用户确认问题

在实施前,需要确认:

1. **是否需要保留实时性?**
   - 当前: 15-30秒检测一次
   - 如果改为智能导航,可能略微延迟消息发现时间
   - 是否可接受?

2. **是否接受增量检测?**
   - 只检测有未读标记的会话
   - 效率高,但可能遗漏某些边缘情况
   - 是否可接受?

3. **是否需要配置化?**
   - 允许用户自己调整刷新策略
   - 增加复杂度
   - 是否需要?

---

**报告生成时间**: 2025-10-24 21:00
**问题状态**: 📋 分析完成
**推荐方案**: 方案A (智能页面检查) - 短期快速解决
**下一步**: 等待用户确认后实施
