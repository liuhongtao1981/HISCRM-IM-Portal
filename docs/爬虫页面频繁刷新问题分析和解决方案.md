# çˆ¬è™«é¡µé¢é¢‘ç¹åˆ·æ–°é—®é¢˜åˆ†æå’Œè§£å†³æ–¹æ¡ˆ

**é—®é¢˜æ—¶é—´**: 2025-10-24 21:00
**é—®é¢˜æè¿°**: æ‰§è¡Œä»»åŠ¡æ—¶,çˆ¬è™«çª—å£ä¸€ç›´åˆ·æ–°
**çŠ¶æ€**: ğŸ“‹ åˆ†æå®Œæˆ,ç­‰å¾…ç¡®è®¤è§£å†³æ–¹æ¡ˆ

---

## é—®é¢˜åˆ†æ

### ç”¨æˆ·åé¦ˆ

ç”¨æˆ·æˆªå›¾æ˜¾ç¤ºæŠ–éŸ³åˆ›ä½œè€…ä¸­å¿ƒçš„ç§ä¿¡ç®¡ç†é¡µé¢å¤„äºåŠ è½½çŠ¶æ€,å¹¶åé¦ˆ:
> "æ‰§è¡Œä»»åŠ¡çš„æ—¶å€™,ä¼šä¸€ç›´åˆ·æ–°æˆ‘çš„ä»»åŠ¡tab"

### æ ¹æœ¬åŸå› 

è¿™**ä¸æ˜¯bug,è€Œæ˜¯å½“å‰è®¾è®¡çš„é¢„æœŸè¡Œä¸º**:

```javascript
// packages/worker/src/handlers/monitor-task.js

// 1. çˆ¬è™«ä»»åŠ¡æ¯ 15-30 ç§’æ‰§è¡Œä¸€æ¬¡
this.minInterval = 15;  // æœ€å°é—´éš”15ç§’
this.maxInterval = 30;  // æœ€å¤§é—´éš”30ç§’

// 2. æ¯æ¬¡æ‰§è¡Œæ—¶è°ƒç”¨çˆ¬è™«æ–¹æ³•
await this.platformInstance.crawlDirectMessages(this.account);
```

```javascript
// packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js

async function crawlDirectMessagesV2(page, account) {
  // âŒ æ¯æ¬¡éƒ½å¯¼èˆªåˆ°ç§ä¿¡é¡µé¢
  await page.goto('https://creator.douyin.com/creator-micro/data/following/chat', {
    waitUntil: 'domcontentloaded',
    timeout: 30000
  });

  // æŠ“å–æ•°æ®...
}
```

**æµç¨‹**:
```
T0: çˆ¬è™«ä»»åŠ¡å¯åŠ¨
  â†“
è°ƒç”¨ crawlDirectMessages()
  â†“
page.goto() â†’ é¡µé¢åˆ·æ–°
  â†“
æŠ“å–æ•°æ®
  â†“
ç­‰å¾… 15-30 ç§’
  â†“
å†æ¬¡è°ƒç”¨ crawlDirectMessages()
  â†“
page.goto() â†’ é¡µé¢å†æ¬¡åˆ·æ–°  â† ç”¨æˆ·çœ‹åˆ°çš„"ä¸€ç›´åˆ·æ–°"
  â†“
å¾ªç¯...
```

### ä¸ºä»€ä¹ˆè¦ goto()?

å½“å‰è®¾è®¡æ¯æ¬¡éƒ½ `goto()` çš„åŸå› :

1. **ç¡®ä¿åœ¨æ­£ç¡®é¡µé¢**: é˜²æ­¢ç”¨æˆ·æ‰‹åŠ¨åˆ‡æ¢é¡µé¢å¯¼è‡´çˆ¬è™«å¤±è´¥
2. **é‡ç½®é¡µé¢çŠ¶æ€**: æ¸…é™¤ä¸Šæ¬¡çˆ¬å–ç•™ä¸‹çš„DOMçŠ¶æ€
3. **è§¦å‘APIè¯·æ±‚**: é¡µé¢åŠ è½½æ—¶ä¼šè§¦å‘ä¼šè¯åˆ—è¡¨API

---

## å½±å“åˆ†æ

### ç”¨æˆ·ä½“éªŒå½±å“

1. **è§†è§‰å¹²æ‰°**: ç”¨æˆ·çœ‹åˆ°çª—å£ä¸æ–­åˆ·æ–°,åŠ è½½åœ†åœˆæ—‹è½¬
2. **æ“ä½œæ‰“æ–­**: å¦‚æœç”¨æˆ·æ­£åœ¨æŸ¥çœ‹æŸä¸ªä¼šè¯,ä¼šè¢«å¼ºåˆ¶åˆ·æ–°å›åˆ—è¡¨
3. **æµé‡æ¶ˆè€—**: æ¯æ¬¡åˆ·æ–°éƒ½é‡æ–°åŠ è½½é¡µé¢èµ„æº

### å¹³å°æ£€æµ‹é£é™©

1. **é¢‘ç¹å¯¼èˆª**: æ¯ 15-30 ç§’åˆ·æ–°ä¸€æ¬¡,å¯èƒ½è¢«è¯†åˆ«ä¸ºè‡ªåŠ¨åŒ–è¡Œä¸º
2. **å›ºå®šé—´éš”**: è™½ç„¶æœ‰éšæœºåŒ–,ä½†ä»ç„¶æ˜¯å‘¨æœŸæ€§è¡Œä¸º
3. **å®Œæ•´åŠ è½½**: æ¯æ¬¡éƒ½å®Œæ•´åŠ è½½é¡µé¢,å¢åŠ æ£€æµ‹æ¦‚ç‡

---

## è§£å†³æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆA: æ™ºèƒ½é¡µé¢æ£€æŸ¥ (æ¨è â­)

**æ ¸å¿ƒæ€è·¯**: æ£€æŸ¥å½“å‰é¡µé¢URL,åªåœ¨éœ€è¦æ—¶å¯¼èˆª

```javascript
async function crawlDirectMessagesV2(page, account) {
  logger.info(`Starting private message crawl for account ${account.id}`);

  // â­ æ™ºèƒ½é¡µé¢æ£€æŸ¥
  const currentUrl = page.url();
  const targetUrl = 'https://creator.douyin.com/creator-micro/data/following/chat';

  if (!currentUrl.includes('creator-micro/data/following/chat')) {
    // ä¸åœ¨ç§ä¿¡é¡µé¢,éœ€è¦å¯¼èˆª
    logger.info(`Not on message page (current: ${currentUrl}), navigating...`);
    await page.goto(targetUrl, {
      waitUntil: 'domcontentloaded',
      timeout: 30000
    });
    await page.waitForTimeout(2000);
  } else {
    // å·²åœ¨ç§ä¿¡é¡µé¢,åˆ·æ–°æ•°æ®å³å¯
    logger.info(`Already on message page, refreshing data...`);

    // æ–¹å¼1: è½¯åˆ·æ–° - ç‚¹å‡»ä¼šè¯åˆ—è¡¨åˆ·æ–°æŒ‰é’® (å¦‚æœæœ‰)
    // await page.click('[data-testid="refresh-button"]');

    // æ–¹å¼2: è½¯åˆ·æ–° - é‡æ–°è¯·æ±‚API (ä¸åˆ·æ–°é¡µé¢)
    // ç­‰å¾…ä¼šè¯åˆ—è¡¨æ›´æ–°
    await page.waitForTimeout(1000);
  }

  // åç»­æŠ“å–é€»è¾‘...
  const conversations = await extractConversationsList(page, account);
  // ...
}
```

**ä¼˜ç‚¹**:
- âœ… é¦–æ¬¡è¿è¡Œæ—¶å¯¼èˆªåˆ°æ­£ç¡®é¡µé¢
- âœ… åç»­è¿è¡Œä¸åˆ·æ–°é¡µé¢,ç”¨æˆ·ä½“éªŒå¥½
- âœ… å‡å°‘æµé‡æ¶ˆè€—
- âœ… é™ä½å¹³å°æ£€æµ‹é£é™©

**ç¼ºç‚¹**:
- âš ï¸ å¦‚æœé¡µé¢çŠ¶æ€å¼‚å¸¸,å¯èƒ½éœ€è¦æ‰‹åŠ¨æ¢å¤
- âš ï¸ éœ€è¦å¤„ç†ä¼šè¯åˆ—è¡¨æ•°æ®åˆ·æ–°

### æ–¹æ¡ˆB: å¢é‡æ£€æµ‹ (æœ€ä¼˜ â­â­â­)

**æ ¸å¿ƒæ€è·¯**: ä¸åˆ·æ–°é¡µé¢,ç›´æ¥è¯»å–å½“å‰ä¼šè¯åˆ—è¡¨,åªæ£€æµ‹æ–°æ¶ˆæ¯

```javascript
async function crawlDirectMessagesV2(page, account) {
  logger.info(`Starting incremental private message crawl`);

  // 1. æ™ºèƒ½å¯¼èˆª (åŒæ–¹æ¡ˆA)
  const currentUrl = page.url();
  if (!currentUrl.includes('creator-micro/data/following/chat')) {
    logger.info(`Navigating to message page...`);
    await page.goto('https://creator.douyin.com/creator-micro/data/following/chat', {
      waitUntil: 'domcontentloaded',
      timeout: 30000
    });
    await page.waitForTimeout(2000);
  } else {
    logger.info(`Already on message page, performing incremental check...`);
  }

  // 2. æå–å½“å‰ä¼šè¯åˆ—è¡¨ (ä¸åˆ·æ–°é¡µé¢)
  const conversations = await extractConversationsList(page, account);

  // 3. â­ åªæ£€æŸ¥æœ‰æ–°æ¶ˆæ¯çš„ä¼šè¯
  const conversationsWithNewMessages = conversations.filter(conv => {
    // æ£€æŸ¥æ˜¯å¦æœ‰æœªè¯»æ¶ˆæ¯æ ‡è®°
    return conv.has_unread || conv.unread_count > 0;
  });

  logger.info(`Found ${conversationsWithNewMessages.length}/${conversations.length} conversations with new messages`);

  // 4. åªçˆ¬å–æœ‰æ–°æ¶ˆæ¯çš„ä¼šè¯
  const directMessages = [];
  for (const conversation of conversationsWithNewMessages) {
    const messages = await crawlConversationMessages(page, conversation, account);
    directMessages.push(...messages);
  }

  return {
    conversations,
    directMessages,
    stats: {
      totalConversations: conversations.length,
      checkedConversations: conversationsWithNewMessages.length,
      newMessages: directMessages.length
    }
  };
}
```

**ä¼˜ç‚¹**:
- âœ… æå¤§å‡å°‘é¡µé¢åˆ·æ–°
- âœ… åªå¤„ç†æœ‰æ–°æ¶ˆæ¯çš„ä¼šè¯,æ•ˆç‡é«˜
- âœ… ç”¨æˆ·ä½“éªŒæœ€ä½³
- âœ… å¹³å°æ£€æµ‹é£é™©æœ€ä½

**ç¼ºç‚¹**:
- âš ï¸ é¦–æ¬¡è¿è¡Œéœ€è¦å…¨é‡çˆ¬å–
- âš ï¸ éœ€è¦å‡†ç¡®è¯†åˆ«æœªè¯»æ¶ˆæ¯

### æ–¹æ¡ˆC: å¢åŠ åˆ·æ–°é—´éš”

**æ ¸å¿ƒæ€è·¯**: å‡å°‘çˆ¬è™«æ‰§è¡Œé¢‘ç‡

```javascript
// packages/worker/src/handlers/monitor-task.js

// åŸæ¥: 15-30ç§’
this.minInterval = 15;
this.maxInterval = 30;

// æ”¹ä¸º: 60-120ç§’ (1-2åˆ†é’Ÿ)
this.minInterval = 60;
this.maxInterval = 120;
```

**ä¼˜ç‚¹**:
- âœ… å®ç°ç®€å•
- âœ… å‡å°‘é¡µé¢åˆ·æ–°é¢‘ç‡
- âœ… é™ä½æ£€æµ‹é£é™©

**ç¼ºç‚¹**:
- âŒ æ¶ˆæ¯å»¶è¿Ÿå¢åŠ 
- âŒ æ²¡æœ‰è§£å†³é¡µé¢åˆ·æ–°é—®é¢˜

### æ–¹æ¡ˆD: åå°æ ‡ç­¾é¡µ (å¤‡é€‰)

**æ ¸å¿ƒæ€è·¯**: çˆ¬è™«çª—å£éšè—,ä¸æ˜¾ç¤ºç»™ç”¨æˆ·

```javascript
// åˆ›å»ºçˆ¬è™«çª—å£æ—¶è®¾ç½®ä¸ºåå°
const context = await browser.newContext({
  // ... å…¶ä»–é…ç½®
  viewport: null,  // ä¸è®¾ç½®è§†å£
});

// æˆ–è€…æœ€å°åŒ–çª—å£
await page.evaluate(() => {
  window.resizeTo(1, 1);
  window.moveTo(screen.width, screen.height);
});
```

**ä¼˜ç‚¹**:
- âœ… ç”¨æˆ·çœ‹ä¸åˆ°åˆ·æ–°
- âœ… ä¸æ”¹å˜çˆ¬è™«é€»è¾‘

**ç¼ºç‚¹**:
- âŒ è°ƒè¯•å›°éš¾
- âŒ ä¸ç¬¦åˆæˆ‘ä»¬çš„è®¾è®¡(ç”¨æˆ·éœ€è¦çœ‹åˆ°æµè§ˆå™¨è¿è¡Œ)

---

## æ¨èæ–¹æ¡ˆ

### çŸ­æœŸæ–¹æ¡ˆ: æ–¹æ¡ˆA (æ™ºèƒ½é¡µé¢æ£€æŸ¥)

**å®æ–½æ­¥éª¤**:
1. ä¿®æ”¹ `crawlDirectMessagesV2()` æ·»åŠ URLæ£€æŸ¥
2. åªåœ¨ä¸åœ¨ç§ä¿¡é¡µé¢æ—¶æ‰ `goto()`
3. åœ¨ç§ä¿¡é¡µé¢æ—¶ç­‰å¾…1ç§’å³å¯

**ä»£ç ä¿®æ”¹**:
```javascript
// packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js

async function crawlDirectMessagesV2(page, account) {
  logger.info(`[Phase 8] Starting private message crawl for account ${account.id}`);

  try {
    // ç¬¬ 1 æ­¥: åˆå§‹åŒ– API æ‹¦æˆªå™¨
    const apiResponses = { /* ... */ };
    await setupAPIInterceptors(page, apiResponses);

    // ç¬¬ 2 æ­¥: â­ æ™ºèƒ½å¯¼èˆª
    const currentUrl = page.url();
    const targetUrl = 'https://creator.douyin.com/creator-micro/data/following/chat';

    if (!currentUrl.includes('creator-micro/data/following/chat')) {
      logger.info(`[Phase 8] Not on message page, navigating from ${currentUrl}...`);
      await page.goto(targetUrl, {
        waitUntil: 'domcontentloaded',
        timeout: 30000
      });
      await page.waitForTimeout(2000);
      logger.info(`[Phase 8] Navigated to message page`);
    } else {
      logger.info(`[Phase 8] Already on message page (${currentUrl}), skipping navigation`);
      // ç­‰å¾…çŸ­æš‚æ—¶é—´ç¡®ä¿é¡µé¢ç¨³å®š
      await page.waitForTimeout(1000);
    }

    // ç¬¬ 3 æ­¥: è·å–ä¼šè¯åˆ—è¡¨ (ä»å½“å‰é¡µé¢ç›´æ¥æå–)
    const conversations = await extractConversationsList(page, account);
    logger.info(`[Phase 8] Extracted ${conversations.length} conversations`);

    // ... åç»­é€»è¾‘ä¸å˜ ...
  } catch (error) {
    logger.error(`[Phase 8] Error in crawl:`, error);
    throw error;
  }
}
```

**é¢„æœŸæ•ˆæœ**:
```
ç¬¬1æ¬¡æ‰§è¡Œ (T=0s):
  - å½“å‰URL: about:blank
  - æ£€æµ‹åˆ°ä¸åœ¨ç§ä¿¡é¡µé¢
  - å¯¼èˆªåˆ°ç§ä¿¡é¡µé¢ â† é¡µé¢åˆ·æ–°
  - æŠ“å–æ•°æ®

ç¬¬2æ¬¡æ‰§è¡Œ (T=20s):
  - å½“å‰URL: creator.douyin.com/creator-micro/data/following/chat
  - æ£€æµ‹åˆ°å·²åœ¨ç§ä¿¡é¡µé¢
  - è·³è¿‡å¯¼èˆª â† ä¸åˆ·æ–°!
  - ç›´æ¥æŠ“å–æ•°æ®

ç¬¬3æ¬¡æ‰§è¡Œ (T=45s):
  - åŒç¬¬2æ¬¡,ä¸åˆ·æ–°
  - ç›´æ¥æŠ“å–æ•°æ®
```

### é•¿æœŸæ–¹æ¡ˆ: æ–¹æ¡ˆB (å¢é‡æ£€æµ‹)

**å®æ–½æ­¥éª¤**:
1. å®ç°æ–¹æ¡ˆA (æ™ºèƒ½å¯¼èˆª)
2. æ·»åŠ æœªè¯»æ¶ˆæ¯æ£€æµ‹é€»è¾‘
3. åªçˆ¬å–æœ‰æ–°æ¶ˆæ¯çš„ä¼šè¯
4. é¦–æ¬¡è¿è¡Œæˆ–å®šæœŸ(å¦‚æ¯å°æ—¶)è¿›è¡Œå…¨é‡çˆ¬å–

**ä¼˜åŠ¿**:
- æ•ˆç‡æœ€é«˜
- ç”¨æˆ·ä½“éªŒæœ€ä½³
- æœ€æ¥è¿‘çœŸå®ç”¨æˆ·è¡Œä¸º

---

## å®æ–½å»ºè®®

### Phase 1: ç«‹å³å®æ–½ (æ–¹æ¡ˆA)

1. **ä¿®æ”¹ç§ä¿¡çˆ¬è™«** - `crawl-direct-messages-v2.js`
   - æ·»åŠ URLæ£€æŸ¥
   - åªåœ¨å¿…è¦æ—¶å¯¼èˆª

2. **ä¿®æ”¹è¯„è®ºçˆ¬è™«** - `crawl-comments.js`
   - åŒæ ·æ·»åŠ URLæ£€æŸ¥
   - ç»Ÿä¸€å¤„ç†é€»è¾‘

3. **æµ‹è¯•éªŒè¯**
   - å¯åŠ¨Worker
   - è§‚å¯Ÿçˆ¬è™«çª—å£
   - ç¡®è®¤åªæœ‰é¦–æ¬¡åˆ·æ–°é¡µé¢

### Phase 2: ä¼˜åŒ–æå‡ (æ–¹æ¡ˆB)

1. **å®ç°æœªè¯»æ£€æµ‹**
   - åˆ†æä¼šè¯åˆ—è¡¨DOMç»“æ„
   - æå–æœªè¯»æ ‡è®°
   - åªå¤„ç†æœ‰æœªè¯»çš„ä¼šè¯

2. **å…¨é‡/å¢é‡æ··åˆç­–ç•¥**
   - å¢é‡æ£€æµ‹: æ¯ 15-30 ç§’
   - å…¨é‡çˆ¬å–: æ¯ 1 å°æ—¶
   - ç¡®ä¿ä¸é—æ¼æ¶ˆæ¯

### Phase 3: é…ç½®åŒ– (å¯é€‰)

å…è®¸ç”¨æˆ·é…ç½®åˆ·æ–°ç­–ç•¥:
```javascript
// worker_configs è¡¨
{
  crawl_strategy: 'incremental',  // 'full' | 'incremental' | 'smart'
  crawl_interval: 30,              // ç§’
  full_crawl_interval: 3600,       // ç§’ (æ¯å°æ—¶å…¨é‡ä¸€æ¬¡)
  force_navigation: false          // æ˜¯å¦æ¯æ¬¡å¼ºåˆ¶åˆ·æ–°é¡µé¢
}
```

---

## é£é™©è¯„ä¼°

### æ–¹æ¡ˆA é£é™©

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| é¡µé¢çŠ¶æ€å¼‚å¸¸å¯¼è‡´çˆ¬å–å¤±è´¥ | ä½ | ä¸­ | æ·»åŠ é”™è¯¯é‡è¯•,å¤±è´¥åå¼ºåˆ¶åˆ·æ–° |
| ä¼šè¯åˆ—è¡¨æ•°æ®æœªæ›´æ–° | ä½ | ä½ | å®šæœŸ(æ¯å°æ—¶)å¼ºåˆ¶åˆ·æ–°ä¸€æ¬¡ |
| é¡µé¢è·¯ç”±å˜åŒ–æ£€æµ‹å¤±è´¥ | æä½ | é«˜ | ä½¿ç”¨æ›´ç²¾ç¡®çš„URLåŒ¹é… |

### æ–¹æ¡ˆB é£é™©

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| æœªè¯»æ ‡è®°è¯†åˆ«é”™è¯¯ | ä¸­ | ä¸­ | ç»“åˆå…¨é‡çˆ¬å–,å®šæœŸæ ¡éªŒ |
| é—æ¼æ¶ˆæ¯ | ä½ | é«˜ | æ¯å°æ—¶å…¨é‡çˆ¬å–ä¸€æ¬¡å…œåº• |
| é¦–æ¬¡è¿è¡Œæ—¶é—´é•¿ | ä½ | ä½ | æ˜¾ç¤ºè¿›åº¦æç¤º |

---

## ç›¸å…³æ–‡ä»¶

éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶:
1. `packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js`
2. `packages/worker/src/platforms/douyin/crawl-comments.js`
3. `packages/worker/src/handlers/monitor-task.js` (å¯é€‰,è°ƒæ•´é—´éš”)

éœ€è¦æµ‹è¯•çš„åœºæ™¯:
1. é¦–æ¬¡å¯åŠ¨çˆ¬è™« - éªŒè¯å¯¼èˆªæ­£å¸¸
2. ç¬¬äºŒæ¬¡æ‰§è¡Œçˆ¬è™« - éªŒè¯ä¸åˆ·æ–°é¡µé¢
3. æ‰‹åŠ¨åˆ‡æ¢é¡µé¢åæ‰§è¡Œçˆ¬è™« - éªŒè¯èƒ½æ£€æµ‹å¹¶å¯¼èˆªå›å»
4. é•¿æ—¶é—´è¿è¡Œ - éªŒè¯ç¨³å®šæ€§

---

## ç”¨æˆ·ç¡®è®¤é—®é¢˜

åœ¨å®æ–½å‰,éœ€è¦ç¡®è®¤:

1. **æ˜¯å¦éœ€è¦ä¿ç•™å®æ—¶æ€§?**
   - å½“å‰: 15-30ç§’æ£€æµ‹ä¸€æ¬¡
   - å¦‚æœæ”¹ä¸ºæ™ºèƒ½å¯¼èˆª,å¯èƒ½ç•¥å¾®å»¶è¿Ÿæ¶ˆæ¯å‘ç°æ—¶é—´
   - æ˜¯å¦å¯æ¥å—?

2. **æ˜¯å¦æ¥å—å¢é‡æ£€æµ‹?**
   - åªæ£€æµ‹æœ‰æœªè¯»æ ‡è®°çš„ä¼šè¯
   - æ•ˆç‡é«˜,ä½†å¯èƒ½é—æ¼æŸäº›è¾¹ç¼˜æƒ…å†µ
   - æ˜¯å¦å¯æ¥å—?

3. **æ˜¯å¦éœ€è¦é…ç½®åŒ–?**
   - å…è®¸ç”¨æˆ·è‡ªå·±è°ƒæ•´åˆ·æ–°ç­–ç•¥
   - å¢åŠ å¤æ‚åº¦
   - æ˜¯å¦éœ€è¦?

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-24 21:00
**é—®é¢˜çŠ¶æ€**: ğŸ“‹ åˆ†æå®Œæˆ
**æ¨èæ–¹æ¡ˆ**: æ–¹æ¡ˆA (æ™ºèƒ½é¡µé¢æ£€æŸ¥) - çŸ­æœŸå¿«é€Ÿè§£å†³
**ä¸‹ä¸€æ­¥**: ç­‰å¾…ç”¨æˆ·ç¡®è®¤åå®æ–½
