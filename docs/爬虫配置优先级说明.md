# 爬虫配置优先级说明

## 配置来源和优先级

系统中存在两种爬虫配置来源：

### 1. 平台配置文件 (config.json)

**位置**: `packages/worker/src/platforms/douyin/config.json`

**作用**: 为所有账户提供默认配置

**示例**:
```json
{
  "crawlers": {
    "commentCrawler": {
      "enabled": false,  // 关闭评论爬虫
      "interval": { "min": 60, "max": 600 }
    },
    "apiCrawler": {
      "enabled": true,   // 启用 API 爬虫
      "interval": 30
    }
  }
}
```

### 2. 账户配置 (monitoring_config)

**位置**: 数据库 `accounts` 表的 `monitoring_config` 字段

**作用**: 为单个账户自定义配置

**示例**:
```json
{
  "enableRealtimeMonitor": true,  // 覆盖平台配置
  "apiCrawlerInterval": 60000
}
```

## 优先级规则

**账户配置 > 平台配置 > 代码默认值**

代码实现（[platform.js:1689](../packages/worker/src/platforms/douyin/platform.js#L1689)）：
```javascript
return { ...defaultConfig, ...config };  // 账户配置覆盖默认配置
```

## 常见问题

### 问题：修改了 config.json 但配置没生效

**原因**: 账户的 `monitoring_config` 字段有旧配置，覆盖了平台配置

**现象**:
- 在 `config.json` 中设置 `commentCrawler.enabled = false`
- 但评论爬虫仍在运行

**解决方案**:

#### 方案 1: 清空所有账户配置（推荐）

使用提供的脚本：
```bash
cd tests
清空账户监控配置.bat
```

或手动执行 SQL：
```sql
UPDATE accounts SET monitoring_config = NULL;
```

#### 方案 2: 清空特定账户配置

```sql
UPDATE accounts
SET monitoring_config = NULL
WHERE id = 'your-account-id';
```

#### 方案 3: 修改账户配置而不是删除

```sql
UPDATE accounts
SET monitoring_config = '{"enableRealtimeMonitor": false}'
WHERE id = 'your-account-id';
```

### 执行后必须重启

清空配置后必须重启 Worker 进程：
```bash
# 停止所有 node 进程
taskkill /F /IM node.exe

# 重启 Worker
cd packages/worker
npm start
```

## 配置设计原则

### 何时使用平台配置 (config.json)

- ✅ 所有账户使用相同配置
- ✅ 快速调整所有账户的爬虫行为
- ✅ 测试环境 vs 生产环境配置切换

### 何时使用账户配置 (monitoring_config)

- ✅ 某个账户需要特殊配置（如 VIP 账户更频繁抓取）
- ✅ 临时调整单个账户的爬虫参数
- ✅ 灰度测试新配置

### 最佳实践

1. **默认使用平台配置** - 将 `monitoring_config` 保持为 `NULL`
2. **特殊账户才设置账户配置** - 仅在需要时覆盖
3. **定期清理过期配置** - 避免账户配置与平台配置冲突
4. **修改配置后重启** - 确保配置生效

## 配置字段映射

| config.json 字段 | monitoring_config 字段 | 说明 |
|-----------------|----------------------|------|
| `crawlers.commentCrawler.enabled` | `enableRealtimeMonitor` | 评论爬虫开关 |
| `crawlers.commentCrawler.interval.min` | `crawlIntervalMin` | 评论爬虫最小间隔(分钟) |
| `crawlers.commentCrawler.interval.max` | `crawlIntervalMax` | 评论爬虫最大间隔(分钟) |
| `crawlers.apiCrawler.enabled` | `enableAPICrawler` | API 爬虫开关 |
| `crawlers.apiCrawler.autoStart` | `apiCrawlerAutoStart` | API 爬虫自动启动 |
| `crawlers.apiCrawler.interval` | `apiCrawlerInterval` | API 爬虫间隔(毫秒) |
| `crawlers.apiCrawler.works.pageSize` | `apiCrawlerWorksPageSize` | 作品分页大小 |
| `crawlers.apiCrawler.comments.enabled` | `apiCrawlerCommentsEnabled` | 评论抓取开关 |
| `crawlers.apiCrawler.replies.enabled` | `apiCrawlerRepliesEnabled` | 二级评论抓取开关 |

完整映射见 [platform.js:parseMonitoringConfig](../packages/worker/src/platforms/douyin/platform.js#L1640-L1678)

## 相关文档

- [抖音平台爬虫配置说明](./抖音平台爬虫配置说明.md)
- [API爬虫使用指南](./API爬虫使用指南.md)
