# æ—¶é—´æˆ³æ ¼å¼é—®é¢˜æœ€ç»ˆè¯Šæ–­æŠ¥å‘Š

## é—®é¢˜ç—‡çŠ¶

å®¢æˆ·ç«¯ IM ç•Œé¢çš„"ä½œå“è¯„è®º"æ ‡ç­¾é¡µä¸­ï¼Œæ‰€æœ‰ä½œå“çš„æ—¶é—´æˆ³æ˜¾ç¤ºä¸º "01/21" (1970å¹´1æœˆ21æ—¥)ï¼Œè€Œä¸æ˜¯æ­£ç¡®çš„å½“å‰æ—¥æœŸã€‚

## æ ¹æœ¬åŸå› 

é€šè¿‡ `tests/check-datastore-vs-database.js` è„šæœ¬æ£€æŸ¥æ•°æ®åº“ï¼Œå‘ç°ï¼š

### âŒ ä½œå“ (cache_contents) çš„æ—¶é—´æˆ³å­˜å‚¨æ ¼å¼**é”™è¯¯**

```sql
-- æ•°æ®åº“ä¸­å®é™…å­˜å‚¨çš„å€¼
publishTime: "å‘å¸ƒäº2025å¹´11æœˆ02æ—¥ 09:00"  â† ä¸­æ–‡å­—ç¬¦ä¸²ï¼
createdAt: "å‘å¸ƒäº2025å¹´11æœˆ02æ—¥ 09:00"   â† ä¸­æ–‡å­—ç¬¦ä¸²ï¼
lastCrawlTime: null
```

**é—®é¢˜**: Worker çˆ¬è™«åœ¨çˆ¬å–ä½œå“æ—¶ï¼Œå°†å‘å¸ƒæ—¶é—´å­˜å‚¨ä¸º**ä¸­æ–‡æ—¥æœŸå­—ç¬¦ä¸²**ï¼Œè€Œä¸æ˜¯**æ•°å­—æ—¶é—´æˆ³**ã€‚

### âœ… ä¼šè¯ (cache_conversations) çš„æ—¶é—´æˆ³å­˜å‚¨æ ¼å¼**æ­£ç¡®**

```sql
-- æ•°æ®åº“ä¸­å®é™…å­˜å‚¨çš„å€¼
createdAt: 1762154908752          â† 13ä½æ¯«ç§’çº§æ•°å­— âœ…
lastMessageTime: 1762154908752   â† 13ä½æ¯«ç§’çº§æ•°å­— âœ…
```

### âœ… è¯„è®º (cache_comments) çš„æ—¶é—´æˆ³å­˜å‚¨æ ¼å¼**éœ€è¦å½’ä¸€åŒ–**

```sql
-- æ•°æ®åº“ä¸­å®é™…å­˜å‚¨çš„å€¼
createdAt: 1761959443  â† 10ä½ç§’çº§æ•°å­— (éœ€è¦ *1000)
```

## æ•°æ®æµåˆ†æ

```
Worker çˆ¬å–ä½œå“
  â†“
ä»æŠ–éŸ³ç½‘é¡µ DOM ä¸­æå– "å‘å¸ƒäº2025å¹´11æœˆ02æ—¥ 09:00"
  â†“
crawl-contents.js: standardizeWorkData()
  â†“
publishTime = work.publish_time  â† work.publish_time å·²ç»æ˜¯å­—ç¬¦ä¸²
  â†“
å­˜å‚¨åˆ° cache_contents è¡¨çš„ data å­—æ®µ (JSON)
  â†“
Master ä»æ•°æ®åº“åŠ è½½åˆ° DataStore (å†…å­˜)
  â†“
im-websocket-server.js: getTopicsFromDataStore()
  â†“
topic.createdTime = normalizeTimestamp(content.publishTime)
  â†“
normalizeTimestamp("å‘å¸ƒäº2025å¹´11æœˆ02æ—¥ 09:00")
  â†“
String("å‘å¸ƒäº...") è½¬æ¢ä¸º Number = NaN
  â†“
NaN < 10000000000 ? NaN * 1000 : NaN  â† è¿”å› NaN
  â†“
å®¢æˆ·ç«¯æ”¶åˆ° topic.createdTime = NaN
  â†“
new Date(NaN) = Invalid Date
  â†“
formatTime(Invalid Date) â†’ "01/21"
```

## ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: ä¿®å¤ Worker çˆ¬è™« - è§£æä¸­æ–‡æ—¥æœŸå­—ç¬¦ä¸² (æ¨è)

åœ¨ `packages/worker/src/platforms/douyin/crawl-contents.js` ä¸­æ·»åŠ æ—¥æœŸå­—ç¬¦ä¸²è§£æå‡½æ•°ï¼š

```javascript
/**
 * è§£ææŠ–éŸ³æ—¥æœŸå­—ç¬¦ä¸²ä¸ºæ—¶é—´æˆ³
 * @param {string} dateStr - "å‘å¸ƒäº2025å¹´11æœˆ02æ—¥ 09:00"
 * @returns {number} ç§’çº§æ—¶é—´æˆ³
 */
function parseDouyinDateString(dateStr) {
  if (!dateStr || typeof dateStr !== 'string') {
    return null;
  }

  // åŒ¹é…æ ¼å¼: "å‘å¸ƒäº2025å¹´11æœˆ02æ—¥ 09:00"
  const match = dateStr.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥\s+(\d{1,2}):(\d{2})/);
  if (!match) {
    logger.warn(`æ— æ³•è§£ææ—¥æœŸå­—ç¬¦ä¸²: ${dateStr}`);
    return null;
  }

  const [, year, month, day, hour, minute] = match;
  const date = new Date(
    parseInt(year),
    parseInt(month) - 1,  // æœˆä»½ä» 0 å¼€å§‹
    parseInt(day),
    parseInt(hour),
    parseInt(minute)
  );

  return Math.floor(date.getTime() / 1000);  // è¿”å›ç§’çº§æ—¶é—´æˆ³
}

// ä¿®æ”¹ standardizeWorkData() å‡½æ•°
function standardizeWorkData(work, account) {
  // å¤„ç† publish_time
  let publishTime = work.publish_time || null;

  if (publishTime) {
    // å¦‚æœæ˜¯å­—ç¬¦ä¸² (ä¾‹å¦‚ "å‘å¸ƒäº2025å¹´11æœˆ02æ—¥ 09:00")
    if (typeof publishTime === 'string') {
      publishTime = parseDouyinDateString(publishTime);
      logger.debug(`Parsed publish_time string to timestamp: ${work.publish_time} -> ${publishTime}`);
    }
    // å¦‚æœæ˜¯ 13 ä½æ¯«ç§’çº§æ—¶é—´æˆ³ï¼Œè½¬æ¢ä¸º 10 ä½ç§’çº§
    else if (String(publishTime).length === 13) {
      publishTime = Math.floor(publishTime / 1000);
      logger.debug(`Converted publish_time from milliseconds to seconds: ${work.publish_time} -> ${publishTime}`);
    }
  }

  return {
    // ... å…¶ä»–å­—æ®µ ...
    publish_time: publishTime,
    last_crawl_time: Math.floor(Date.now() / 1000),
  };
}
```

### æ–¹æ¡ˆ B: ä¸´æ—¶ä¿®å¤ - åœ¨ Master ç«¯å½’ä¸€åŒ– (å·²å®ç°ï¼Œä½†ä¸å¤Ÿ)

å·²åœ¨ `im-websocket-server.js` ä¸­å®ç°äº† `normalizeTimestamp()` å‡½æ•°ï¼Œä½†å®ƒæ— æ³•å¤„ç†å­—ç¬¦ä¸²è¾“å…¥ã€‚

**å½“å‰å®ç°çš„å±€é™**:
```javascript
const normalizeTimestamp = (timestamp) => {
  if (!timestamp) return Date.now();
  if (timestamp < 10000000000) {
    return timestamp * 1000;  // ç§’çº§ â†’ æ¯«ç§’çº§
  }
  return timestamp;  // å·²ç»æ˜¯æ¯«ç§’çº§
};
```

**é—®é¢˜**: å½“ `timestamp = "å‘å¸ƒäº2025å¹´11æœˆ02æ—¥ 09:00"` æ—¶ï¼š
```javascript
Number("å‘å¸ƒäº...") = NaN
NaN < 10000000000  â†’ false
return NaN  â† é”™è¯¯ï¼
```

### æ–¹æ¡ˆ C: å¢å¼º Master ç«¯å½’ä¸€åŒ– (ä¸´æ—¶ç¼“è§£)

ä¿®æ”¹ `im-websocket-server.js` ä¸­çš„ `normalizeTimestamp()` å‡½æ•°ï¼š

```javascript
const normalizeTimestamp = (timestamp) => {
  if (!timestamp) return Date.now();

  // ğŸ”§ æ–°å¢: å¤„ç†å­—ç¬¦ä¸²ç±»å‹çš„æ—¶é—´æˆ³
  if (typeof timestamp === 'string') {
    // å°è¯•è§£æä¸­æ–‡æ—¥æœŸå­—ç¬¦ä¸² "å‘å¸ƒäº2025å¹´11æœˆ02æ—¥ 09:00"
    const match = timestamp.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥\s+(\d{1,2}):(\d{2})/);
    if (match) {
      const [, year, month, day, hour, minute] = match;
      const date = new Date(
        parseInt(year),
        parseInt(month) - 1,
        parseInt(day),
        parseInt(hour),
        parseInt(minute)
      );
      return date.getTime();  // è¿”å›æ¯«ç§’çº§æ—¶é—´æˆ³
    }

    // å¦‚æœæ˜¯çº¯æ•°å­—å­—ç¬¦ä¸²ï¼Œè½¬æ¢ä¸ºæ•°å­—
    const numericTimestamp = parseInt(timestamp);
    if (!isNaN(numericTimestamp)) {
      timestamp = numericTimestamp;
    } else {
      // æ— æ³•è§£æï¼Œè¿”å›å½“å‰æ—¶é—´
      logger.warn(`[DEBUG] æ— æ³•è§£ææ—¶é—´æˆ³å­—ç¬¦ä¸²: ${timestamp}`);
      return Date.now();
    }
  }

  // å¤„ç†æ•°å­—ç±»å‹çš„æ—¶é—´æˆ³
  if (timestamp < 10000000000) {
    return timestamp * 1000;  // ç§’çº§ â†’ æ¯«ç§’çº§
  }
  return timestamp;  // å·²ç»æ˜¯æ¯«ç§’çº§
};
```

## æ¨èå®æ–½æ­¥éª¤

### çŸ­æœŸä¿®å¤ (ç«‹å³å®æ–½)

1. **ä¿®æ”¹ Master ç«¯çš„ `normalizeTimestamp()` å‡½æ•°** (æ–¹æ¡ˆ C)
   - æ–‡ä»¶: `packages/master/src/communication/im-websocket-server.js`
   - ä¿®æ”¹ä½ç½®: è¡Œ 297, 442 (getTopicsFromDataStore å’Œ getMessagesFromDataStore)
   - æ·»åŠ å­—ç¬¦ä¸²è§£æé€»è¾‘

2. **é‡å¯ Master æœåŠ¡å™¨**
   ```bash
   # ç»ˆæ­¢æ—§è¿›ç¨‹
   powershell -Command "Stop-Process -Id <PID> -Force"

   # å¯åŠ¨æ–°è¿›ç¨‹
   cd packages/master && npm start
   ```

3. **éªŒè¯ä¿®å¤**
   - åˆ·æ–°å®¢æˆ·ç«¯ IM ç•Œé¢
   - æ£€æŸ¥"ä½œå“è¯„è®º"æ ‡ç­¾é¡µçš„æ—¶é—´æˆ³æ˜¯å¦æ˜¾ç¤ºæ­£ç¡®æ—¥æœŸ

### é•¿æœŸä¿®å¤ (åç»­å®æ–½)

1. **ä¿®å¤ Worker çˆ¬è™«** (æ–¹æ¡ˆ A)
   - åœ¨ `crawl-contents.js` ä¸­æ·»åŠ æ—¥æœŸå­—ç¬¦ä¸²è§£æå‡½æ•°
   - ç¡®ä¿ `publishTime` å§‹ç»ˆå­˜å‚¨ä¸ºæ•°å­—æ—¶é—´æˆ³
   - æ·»åŠ å•å…ƒæµ‹è¯•éªŒè¯è§£æé€»è¾‘

2. **æ•°æ®è¿ç§» (å¯é€‰)**
   - åˆ›å»ºè„šæœ¬è¿ç§»ç°æœ‰çš„å­—ç¬¦ä¸²æ—¶é—´æˆ³ä¸ºæ•°å­—æ—¶é—´æˆ³
   - æˆ–ç­‰å¾… Worker é‡æ–°çˆ¬å–æ•°æ®è‡ªåŠ¨è¦†ç›–

3. **æ·»åŠ éªŒè¯**
   - åœ¨ CacheDAO ä¸­æ·»åŠ æ—¶é—´æˆ³æ ¼å¼éªŒè¯
   - è®°å½•è­¦å‘Šæ—¥å¿—æç¤ºæ•°æ®æ ¼å¼å¼‚å¸¸

## æµ‹è¯•éªŒè¯

### éªŒè¯æ•°æ®åº“ä¸­çš„æ—¶é—´æˆ³æ ¼å¼

```bash
node tests/check-datastore-vs-database.js
```

**æœŸæœ›è¾“å‡º (ä¿®å¤å‰)**:
```
ã€ä½œå“æ—¶é—´æˆ³æ£€æŸ¥ã€‘
âŒ publishTime: å‘å¸ƒäº2025å¹´11æœˆ02æ—¥ 09:00
   æ ¼å¼: æœªçŸ¥æ ¼å¼
   è½¬æ¢ä¸ºæ—¥æœŸ: Invalid Date
```

**æœŸæœ›è¾“å‡º (ä¿®å¤å - Worker ç«¯ä¿®å¤)**:
```
ã€ä½œå“æ—¶é—´æˆ³æ£€æŸ¥ã€‘
âœ… publishTime: 1730547600
   æ ¼å¼: ç§’çº§ (10ä½)
   è½¬æ¢ä¸ºæ—¥æœŸ: 2025/11/2 09:00:00
```

### éªŒè¯å®¢æˆ·ç«¯æ˜¾ç¤º

1. æ‰“å¼€æµè§ˆå™¨è®¿é—® http://localhost:5173
2. ç™»å½•å¹¶è¿›å…¥ IM ç•Œé¢
3. ç‚¹å‡»"ä½œå“è¯„è®º"æ ‡ç­¾é¡µ
4. æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦æ˜¾ç¤ºä¸ºå½“å‰æ—¥æœŸ (ä¾‹å¦‚ "11/02") è€Œä¸æ˜¯ "01/21"

## æŠ€æœ¯è¦ç‚¹

### ä¸­æ–‡æ—¥æœŸå­—ç¬¦ä¸²æ ¼å¼

```javascript
æ ¼å¼: "å‘å¸ƒäºYYYYå¹´MMæœˆDDæ—¥ HH:mm"
ç¤ºä¾‹: "å‘å¸ƒäº2025å¹´11æœˆ02æ—¥ 09:00"

æ­£åˆ™è¡¨è¾¾å¼: /(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥\s+(\d{1,2}):(\d{2})/
æ•è·ç»„: [å…¨åŒ¹é…, å¹´, æœˆ, æ—¥, æ—¶, åˆ†]
```

### JavaScript Date å¯¹è±¡è¡Œä¸º

```javascript
new Date(2025, 10, 2, 9, 0)  // æ³¨æ„: æœˆä»½ä» 0 å¼€å§‹ï¼Œ10 = 11æœˆ
  â†’ Sun Nov 02 2025 09:00:00

date.getTime()  // è¿”å›æ¯«ç§’çº§æ—¶é—´æˆ³
  â†’ 1730545200000

Math.floor(date.getTime() / 1000)  // è½¬æ¢ä¸ºç§’çº§
  â†’ 1730545200
```

## ç›¸å…³æ–‡ä»¶

### Master æœåŠ¡å™¨
- `packages/master/src/communication/im-websocket-server.js` (è¡Œ 297, 442)
  - `normalizeTimestamp()` å‡½æ•°éœ€è¦å¢å¼º

### Worker çˆ¬è™«
- `packages/worker/src/platforms/douyin/crawl-contents.js` (è¡Œ 574-609)
  - `standardizeWorkData()` å‡½æ•°éœ€è¦æ·»åŠ æ—¥æœŸè§£æ

### æµ‹è¯•è„šæœ¬
- `tests/check-datastore-vs-database.js` - è¯Šæ–­è„šæœ¬
- `tests/check-comment-timestamp.js` - è¯„è®ºæ—¶é—´æˆ³æ£€æŸ¥

### æ•°æ®åº“è¡¨
- `cache_contents` - ä½œå“æ•°æ® (é—®é¢˜æºå¤´)
- `cache_conversations` - ä¼šè¯æ•°æ® (æ ¼å¼æ­£ç¡®)
- `cache_comments` - è¯„è®ºæ•°æ® (ç§’çº§ï¼Œéœ€å½’ä¸€åŒ–)

## çŠ¶æ€

âš ï¸ **é—®é¢˜è¯Šæ–­å®Œæˆ** - 2025å¹´11æœˆ3æ—¥

### å·²è¯Šæ–­
âœ… è¯†åˆ«æ ¹æœ¬åŸå› : Worker å­˜å‚¨ä¸­æ–‡æ—¥æœŸå­—ç¬¦ä¸²è€Œéæ•°å­—æ—¶é—´æˆ³
âœ… è¯†åˆ«æ•°æ®æµè·¯å¾„: DOM â†’ Worker â†’ Database â†’ DataStore â†’ IM WS Server â†’ Client
âœ… æä¾›ä¸‰ç§ä¿®å¤æ–¹æ¡ˆ (çŸ­æœŸ + é•¿æœŸ)

### å¾…å®æ–½
â³ å®æ–½çŸ­æœŸä¿®å¤: å¢å¼º Master ç«¯ `normalizeTimestamp()` å‡½æ•°
â³ å®æ–½é•¿æœŸä¿®å¤: ä¿®å¤ Worker çˆ¬è™«çš„æ—¥æœŸè§£æé€»è¾‘
â³ éªŒè¯ä¿®å¤æ•ˆæœ

---

**æŠ¥å‘Šè€…**: Claude Code
**æ—¥æœŸ**: 2025-11-03
**ç‰ˆæœ¬**: Master v1.0.0, Worker v1.0.0, CRM-PC-IM v0.0.1
