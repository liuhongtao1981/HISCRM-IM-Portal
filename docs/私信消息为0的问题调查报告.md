# ç§ä¿¡æ¶ˆæ¯ä¸º0çš„é—®é¢˜è°ƒæŸ¥æŠ¥å‘Š

**æ›´æ–°æ—¶é—´**: 2025-11-04 (æœ€æ–°å‘ç°)
**çŠ¶æ€**: âœ… **å·²æ‰¾åˆ°çœŸæ­£çš„æ ¹æœ¬åŸå› ï¼**

---

## ğŸ¯ æœ€æ–°å‘ç°ï¼šçœŸæ­£çš„æ ¹æœ¬åŸå› ï¼ˆ2025-11-04ï¼‰

**ä½¿ç”¨ MCP Playwright å·¥å…·æ·±åº¦è°ƒæŸ¥åï¼Œå‘ç°äº†é—®é¢˜çš„çœŸæ­£åŸå› ï¼**

### é—®é¢˜æ ¹æº

å½“å‰çˆ¬è™«ä»£ç æŸ¥æ‰¾çš„æ˜¯**é”™è¯¯çš„å®¹å™¨**ï¼š

```javascript
// âŒ é”™è¯¯ï¼šå½“å‰ä»£ç æŸ¥æ‰¾çš„æ˜¯å·¦ä¾§ä¼šè¯åˆ—è¡¨
const grids = await page.$$('[role="grid"]');
// è¿™ä¸ªå®¹å™¨ä½äº (248, 142)ï¼ŒåŒ…å«çš„æ˜¯ conversation + user å¯¹è±¡ï¼ˆä¼šè¯å…ƒæ•°æ®ï¼‰
// è€Œä¸æ˜¯æ¶ˆæ¯å†…å®¹ï¼
```

**æ­£ç¡®çš„æ¶ˆæ¯å®¹å™¨ä½ç½®**ï¼š
- âœ… å®¹å™¨ç±»å: `.box-content-jSgLQF`
- âœ… ä½ç½®: (545, 71) - **å³ä¾§æ¶ˆæ¯é¢æ¿**
- âœ… å°ºå¯¸: 558Ã—492
- âœ… æ•°æ®ç»“æ„: å®Œæ•´çš„æ¶ˆæ¯å¯¹è±¡ï¼ˆserverId, content, sender, createdAt ç­‰ï¼‰

### éªŒè¯ç»“æœ

ä½¿ç”¨ MCP Playwright æˆåŠŸç‚¹å‡»ä¼šè¯å¹¶æå–åˆ°æ¶ˆæ¯æ•°æ®ï¼š

```javascript
{
  serverId: "7568671043473754678",
  conversationId: "0:1:2270953921061816:4031246151199119",
  sender: "4031246151199119",
  content: { aweType: 701, text: "æˆ‘ä»¬å·²äº’ç›¸å…³æ³¨ï¼Œå¯ä»¥å¼€å§‹èŠå¤©äº†" },
  createdAt: "2025-11-04T01:09:21.106Z",
  type: 7,
  isFromMe: false,
  nickname: "è918",
  // ... æ›´å¤šå­—æ®µ
}
```

**ç»“è®º**:
- âŒ ä¹‹å‰çš„è¯Šæ–­ï¼ˆæµè§ˆå™¨å¯åŠ¨å¤±è´¥ã€ç­‰å¾…æ—¶é—´ä¸è¶³ï¼‰éƒ½æ˜¯è¡¨é¢é—®é¢˜
- âœ… **çœŸæ­£çš„é—®é¢˜**ï¼šçˆ¬è™«æŸ¥æ‰¾çš„å®¹å™¨ä½ç½®é”™è¯¯ï¼Œåˆ†æçš„æ˜¯ä¼šè¯åˆ—è¡¨è€Œä¸æ˜¯æ¶ˆæ¯å†…å®¹

è¯¦ç»†åˆ†æè§ä¸‹æ–‡ "Â§ æœ€æ–°è°ƒæŸ¥ç»“æœ" ç« èŠ‚ã€‚

---

## é—®é¢˜æè¿°

**ç”¨æˆ·åé¦ˆï¼š** IMå®¢æˆ·ç«¯æ˜¾ç¤º37ä¸ªä¼šè¯ï¼Œä½†æ•°æ®åº“ä¸­æ²¡æœ‰ä»»ä½•ç§ä¿¡æ¶ˆæ¯ï¼ˆcache_messagesè¡¨ä¸º0æ¡è®°å½•ï¼‰

## é—®é¢˜åˆ†æï¼ˆå†å²è¯Šæ–­ï¼‰

### 1. æ•°æ®åº“çŠ¶æ€

**æŸ¥è¯¢ç»“æœï¼š**
```sql
SELECT COUNT(*) FROM cache_conversations;  -- 37
SELECT COUNT(*) FROM cache_messages;       -- 0
SELECT COUNT(*) FROM cache_comments;       -- 7
SELECT COUNT(*) FROM cache_contents;       -- 20
```

**ç»“è®ºï¼š** âœ… ä¼šè¯åˆ—è¡¨çˆ¬å–æ­£å¸¸ï¼ŒâŒ æ¶ˆæ¯å†…å®¹å®Œå…¨ç¼ºå¤±

### 2. Workeræ—¥å¿—åˆ†æ

#### 2.1 æµè§ˆå™¨å¯åŠ¨å¤±è´¥ï¼ˆæ ¹æœ¬åŸå› ï¼‰

**é”™è¯¯æ—¥å¿—ï¼š**
```
2025-11-04 08:59:42.731 [browser-manager-v2] error:
Failed to launch persistent context for account acc-98296c87-2e42-447a-9d8b-8be008ddb6e4
browserType.launchPersistentContext: Target page, context or browser has been closed
Browser logs:
  <launched> pid=21164
  <process did exit: exitCode=21, signal=null>
```

**é—®é¢˜ï¼š** Playwright å¯åŠ¨æµè§ˆå™¨è¿›ç¨‹åç«‹å³å´©æºƒï¼ˆexitCode=21ï¼‰

**å½±å“ï¼š** Worker æ²¡æœ‰å¯ç”¨çš„æµè§ˆå™¨å®ä¾‹ â†’ æ— æ³•æ‰§è¡Œä»»ä½•çˆ¬è™«ä»»åŠ¡

#### 2.2 çˆ¬è™«æ—¥å¿—åˆ†æï¼ˆæ¬¡è¦é—®é¢˜ï¼‰

ä» `packages/worker/logs/crawl-direct-messages-v2.log` å¯ä»¥çœ‹åˆ°ï¼š

**ä¼šè¯åˆ—è¡¨çˆ¬å–ï¼š** âœ… æˆåŠŸ
```
[Phase 8] Processing conversation 10/244: ä¸´ç»ˆå…³æ€€æœåŠ¡â€”â€”ç™¾ä¸–åœ†æ»¡
âœ… [API] ä¼šè¯åˆ—è¡¨ -> DataManager: 20 ä¸ªä¼šè¯
```

**æ¶ˆæ¯å†…å®¹çˆ¬å–ï¼š** âŒ å¤±è´¥
```
[openConversationByIndex] âœ… Successfully opened conversation at index 9
âœ… Reached convergence at attempt 2. Total messages: 0  â† é—®é¢˜ï¼
[Phase 8] Conversation ä¸´ç»ˆå…³æ€€æœåŠ¡â€”â€”ç™¾ä¸–åœ†æ»¡: 0 messages
```

**é—®é¢˜åˆ†æï¼š**
1. æ‰“å¼€ä¼šè¯åï¼Œçˆ¬è™«åªå°è¯•äº† 2 æ¬¡å°±è®¤ä¸º"æ”¶æ•›"ï¼ˆæ•°æ®å·²åŠ è½½å®Œï¼‰
2. `extractMessagesFromVirtualList()` ä»React Fiberæå–æ¶ˆæ¯ï¼Œä½†è¿”å›ç©ºæ•°ç»„
3. åŸå› ï¼šReact Fiber æ•°æ®è¿˜æ²¡åŠ è½½å‡ºæ¥ï¼Œçˆ¬è™«å°±æå‰é€€å‡ºäº†

## æ ¹æœ¬åŸå› æ€»ç»“

æœ‰ **ä¸¤ä¸ªçº§è”é—®é¢˜**ï¼š

### ä¸»è¦é—®é¢˜ï¼šæµè§ˆå™¨å¯åŠ¨å¤±è´¥
- **ç—‡çŠ¶**ï¼šPlaywright å¯åŠ¨ Chromium åç«‹å³å´©æºƒï¼ˆexitCode=21ï¼‰
- **å½±å“**ï¼šWorker å®Œå…¨æ— æ³•å·¥ä½œ
- **å¯èƒ½åŸå› **ï¼š
  1. User Data Directory æŸåï¼ˆ`packages/worker/data/browser/worker1/browser_acc-98296c87-2e42-447a-9d8b-8be008ddb6e4/`ï¼‰
  2. æµè§ˆå™¨äºŒè¿›åˆ¶æ–‡ä»¶æŸå
  3. ç³»ç»Ÿèµ„æºä¸è¶³
  4. é˜²ç—…æ¯’è½¯ä»¶æ‹¦æˆª

### æ¬¡è¦é—®é¢˜ï¼šæ¶ˆæ¯ç­‰å¾…æ—¶é—´ä¸è¶³
- **ç—‡çŠ¶**ï¼šæ‰“å¼€ä¼šè¯åæœªç­‰å¾…æ¶ˆæ¯åŠ è½½å°±å¼€å§‹æå–
- **å½±å“**ï¼šå³ä½¿æµè§ˆå™¨æ­£å¸¸å¯åŠ¨ï¼Œä¹Ÿä¼šæ¼æŠ“æ¶ˆæ¯
- **å·²ä¿®å¤**ï¼šæ·»åŠ äº† `waitForSelector` å’Œé¢å¤–ç­‰å¾…æ—¶é—´

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šæ¸…ç†æµè§ˆå™¨User Dataï¼ˆæ¨èï¼‰

```bash
# 1. åœæ­¢ Worker
# Ctrl+C æˆ– kill workerè¿›ç¨‹

# 2. åˆ é™¤æŸåçš„æµè§ˆå™¨æ•°æ®
rm -rf packages/worker/data/browser/worker1/browser_acc-98296c87-2e42-447a-9d8b-8be008ddb6e4

# 3. é‡å¯ Worker
cd packages/worker && npm run dev
```

### æ–¹æ¡ˆ2ï¼šé‡æ–°å®‰è£…Playwrightæµè§ˆå™¨

```bash
cd packages/worker
npx playwright install chromium
npm run dev
```

### æ–¹æ¡ˆ3ï¼šæ‰‹åŠ¨æ¸…ç†å¹¶é‡ç½®

```bash
# 1. å®Œå…¨æ¸…ç†æ‰€æœ‰æµè§ˆå™¨æ•°æ®
cd packages/worker
rm -rf data/browser/*
rm -rf data/fingerprints/*
rm -rf data/storage-states/*

# 2. é‡æ–°åˆå§‹åŒ–
npm run dev
```

## ä»£ç ä¿®å¤

å·²ä¿®å¤ `crawl-direct-messages-v2.js` ä¸­çš„ç­‰å¾…é€»è¾‘ï¼š

**ä¿®æ”¹æ–‡ä»¶ï¼š** `packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js:866`

**ä¿®æ”¹å†…å®¹ï¼š**
```javascript
async function crawlCompleteMessageHistory(page, conversation, account, apiData) {
  // âœ… æ–°å¢ï¼šç¬¬ 0 æ­¥ - ç­‰å¾…æ¶ˆæ¯åŠ è½½
  logger.info(`[crawlCompleteMessageHistory] Step 0: Waiting for messages to load...`);

  try {
    // ç­‰å¾…æ¶ˆæ¯å®¹å™¨å‡ºç°ï¼ˆæœ€å¤šç­‰å¾…5ç§’ï¼‰
    await page.waitForSelector('[role="grid"], [role="list"], [class*="message"]', {
      timeout: 5000
    });

    // é¢å¤–ç­‰å¾…1ç§’è®©React Fiberæ•°æ®åŠ è½½
    await page.waitForTimeout(1000);

    // æ£€æŸ¥æ˜¯å¦æœ‰æ¶ˆæ¯
    const initialCheck = await page.evaluate(() => {
      const allElements = document.querySelectorAll('[class*="message"], [class*="item"]');
      return {
        elementCount: allElements.length,
        hasReactFiber: Array.from(allElements).some(el =>
          Object.keys(el).some(key => key.startsWith('__react'))
        )
      };
    });

    logger.info(`[crawlCompleteMessageHistory] Initial check: ${initialCheck.elementCount} elements, hasReactFiber: ${initialCheck.hasReactFiber}`);

    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ¶ˆæ¯å…ƒç´ ï¼Œå†ç­‰å¾…2ç§’
    if (initialCheck.elementCount === 0) {
      logger.warn(`[crawlCompleteMessageHistory] No message elements found, waiting additional 2 seconds...`);
      await page.waitForTimeout(2000);
    }
  } catch (error) {
    logger.error(`[crawlCompleteMessageHistory] Error during initial wait:`, error.message);
  }

  // åŸæœ‰çš„æ»šåŠ¨å’Œæå–é€»è¾‘...
}
```

**ä½œç”¨ï¼š**
- ç¡®ä¿åœ¨å¼€å§‹æå–æ¶ˆæ¯å‰ï¼ŒReact Fiber æ•°æ®å·²åŠ è½½
- å‡å°‘"å‡æ”¶æ•›"ï¼ˆè¯¯è®¤ä¸ºå·²åŠ è½½å®Œä½†å…¶å®è¿˜åœ¨åŠ è½½ä¸­ï¼‰

## éªŒè¯æ­¥éª¤

ä¿®å¤åéœ€è¦éªŒè¯ï¼š

1. **æµè§ˆå™¨å¯åŠ¨æˆåŠŸ**
   ```bash
   # æŸ¥çœ‹ Worker æ—¥å¿—
   tail -f packages/worker/logs/worker.log

   # åº”è¯¥çœ‹åˆ°ï¼š
   # âœ“ Launched browser for account acc-...
   # âœ“ Browser initialized successfully
   ```

2. **ä¼šè¯åˆ—è¡¨çˆ¬å–æ­£å¸¸**
   ```bash
   # åº”è¯¥çœ‹åˆ°ï¼š
   # [Phase 8] Extracted 244 conversations
   ```

3. **æ¶ˆæ¯å†…å®¹çˆ¬å–æˆåŠŸ**
   ```bash
   # æŸ¥çœ‹ç§ä¿¡çˆ¬è™«æ—¥å¿—
   tail -f packages/worker/logs/crawl-direct-messages-v2.log

   # åº”è¯¥çœ‹åˆ°ï¼š
   # [crawlCompleteMessageHistory] Initial check: 15 elements, hasReactFiber: true
   # âœ… Reached convergence at attempt 5. Total messages: 15
   # [Phase 8] Conversation XXX: 15 messages
   ```

4. **æ•°æ®åº“éªŒè¯**
   ```bash
   sqlite3 packages/master/data/master.db
   sqlite> SELECT COUNT(*) FROM cache_messages;
   # åº”è¯¥å¤§äº 0
   ```

5. **IMå®¢æˆ·ç«¯éªŒè¯**
   - åˆ·æ–° http://localhost:5177/monitor
   - ç‚¹å‡»ä»»æ„ä¼šè¯
   - åº”è¯¥èƒ½çœ‹åˆ°æ¶ˆæ¯å†å²è®°å½•

## ç›¸å…³æ–‡ä»¶

- `packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js` - ç§ä¿¡çˆ¬è™«ï¼ˆå·²ä¿®å¤ï¼‰
- `packages/worker/src/browser/browser-manager-v2.js` - æµè§ˆå™¨ç®¡ç†å™¨
- `packages/worker/logs/crawl-direct-messages-v2.log` - çˆ¬è™«æ—¥å¿—
- `packages/master/data/master.db` - ä¸»æ•°æ®åº“

## æ—¶é—´çº¿

- **2025-11-04 08:49** - ç”¨æˆ·å‘ç°æ¶ˆæ¯ä¸º0
- **2025-11-04 08:59** - Worker å¯åŠ¨ï¼Œæµè§ˆå™¨å¯åŠ¨å¤±è´¥ï¼ˆexitCode=21ï¼‰
- **2025-11-04 09:00** - åˆ†ææ—¥å¿—ï¼Œå‘ç°ä¸¤ä¸ªé—®é¢˜
- **2025-11-04 09:01** - ä¿®å¤æ¶ˆæ¯ç­‰å¾…é€»è¾‘
- **å¾…å®š** - æ¸…ç†æµè§ˆå™¨æ•°æ®ï¼Œé‡æ–°éªŒè¯

## éªŒè¯ç»“æœ

### 1. ä»£ç ä¿®å¤ âœ…
- æ–‡ä»¶ï¼š`crawl-direct-messages-v2.js`
- ä¿®æ”¹ï¼šæ·»åŠ æ¶ˆæ¯åŠ è½½ç­‰å¾…é€»è¾‘
- çŠ¶æ€ï¼šå·²å®Œæˆ

### 2. æµè§ˆå™¨æµ‹è¯• âœ…
è¿è¡Œäº† `tests/test-browser-launch.js`ï¼Œæµ‹è¯•ç»“æœï¼š
```
æµ‹è¯• 1: æœ€å°å‚æ•°å¯åŠ¨...                        âœ… æˆåŠŸ
æµ‹è¯• 2: æ·»åŠ  --disable-dev-shm-usage...       âœ… æˆåŠŸ
æµ‹è¯• 3: ä½¿ç”¨ç®€åŒ–çš„ Worker å‚æ•°...             âœ… æˆåŠŸ
æµ‹è¯• 4: ä½¿ç”¨ Worker å®Œæ•´å‚æ•°...               âœ… æˆåŠŸ
```

**ç»“è®ºï¼š** Playwright æœ¬èº«å¯ä»¥æ­£å¸¸å¯åŠ¨æµè§ˆå™¨ï¼Œé—®é¢˜åœ¨äº Worker çš„ BrowserManager å®ç°ã€‚

### 3. Worker å¯åŠ¨éªŒè¯ âŒ
é‡å¯ Master å’Œ Worker åï¼š
- Master: âœ… æ­£å¸¸å¯åŠ¨ï¼ˆç«¯å£ 3000ï¼‰
- Worker: âœ… æ³¨å†ŒæˆåŠŸ
- æµè§ˆå™¨: âŒ å¯åŠ¨åç«‹å³å´©æºƒï¼ˆexitCode=21ï¼‰

**é”™è¯¯æ—¥å¿—ï¼š**
```
2025-11-04 09:07:03.428 [browser-manager-v2] error:
Failed to launch persistent context for account acc-98296c87-2e42-447a-9d8b-8be008ddb6e4
browserType.launchPersistentContext: Target page, context or browser has been closed
<launched> pid=24452
<process did exit: exitCode=21, signal=null>
```

**ç—‡çŠ¶å·®å¼‚ï¼š**
| æµ‹è¯•è„šæœ¬ | Worker BrowserManager |
|---------|---------------------|
| âœ… æˆåŠŸå¯åŠ¨ | âŒ ç«‹å³å´©æºƒ (exitCode=21) |
| ç®€å•å‚æ•° | **å¤æ‚å‚æ•° + æŒ‡çº¹é…ç½®** |
| æ–°ç›®å½• | å¯èƒ½æœ‰æ®‹ç•™æ•°æ® |

### 4. é—®é¢˜å®šä½ ğŸ”

**å¯èƒ½åŸå› ï¼š**

1. **æŒ‡çº¹é…ç½®å†²çª** âš ï¸
   - Worker ä½¿ç”¨äº†è‡ªå®šä¹‰æŒ‡çº¹é…ç½®ï¼ˆ`fingerprints/acc-xxx_fingerprint.json`ï¼‰
   - æŒ‡çº¹ä¸­çš„æŸäº›å‚æ•°å¯èƒ½å¯¼è‡´æµè§ˆå™¨å´©æºƒ
   - æµ‹è¯•è„šæœ¬æœªä½¿ç”¨æŒ‡çº¹é…ç½®ï¼Œå¯ä»¥æ­£å¸¸å¯åŠ¨

2. **User Data Directory æŸå** âš ï¸
   - å°½ç®¡åˆ é™¤äº†æµè§ˆå™¨ç›®å½•ï¼Œä½†å¯èƒ½æœ‰å…¶ä»–æ®‹ç•™
   - Storage State æ–‡ä»¶å¯èƒ½æŸå

3. **BrowserManager å‚æ•°é—®é¢˜** âš ï¸
   - æŸ¥çœ‹ `browser-manager-v2.js:341` çš„å‚æ•°é…ç½®
   - å¯èƒ½æœ‰ä¸ Windows ç¯å¢ƒä¸å…¼å®¹çš„å‚æ•°

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### æ–¹æ¡ˆAï¼šç®€åŒ–æµè§ˆå™¨å¯åŠ¨å‚æ•°ï¼ˆæ¨èï¼‰

ä¿®æ”¹ `packages/worker/src/browser/browser-manager-v2.js`ï¼Œä¸´æ—¶ç¦ç”¨æŒ‡çº¹é…ç½®ï¼Œä½¿ç”¨æœ€å°å‚æ•°å¯åŠ¨ï¼š

```javascript
// ä¸´æ—¶ä¿®æ”¹ï¼šä½¿ç”¨æœ€å°å‚æ•°
const context = await chromium.launchPersistentContext(userDataDir, {
  headless: false,
  args: [
    '--no-sandbox',
    '--disable-setuid-sandbox',
    '--disable-dev-shm-usage'
  ]
});
```

### æ–¹æ¡ˆBï¼šæ£€æŸ¥æŒ‡çº¹é…ç½®æ–‡ä»¶

æŸ¥çœ‹ `packages/worker/data/browser/worker1/fingerprints/acc-98296c87-2e42-447a-9d8b-8be008ddb6e4_fingerprint.json`ï¼Œçœ‹æ˜¯å¦æœ‰å¼‚å¸¸å‚æ•°ã€‚

### æ–¹æ¡ˆCï¼šå®Œå…¨æ¸…ç†å¹¶é‡ç½®

```bash
# åˆ é™¤æ‰€æœ‰æµè§ˆå™¨ç›¸å…³æ•°æ®
rm -rf packages/worker/data/browser/worker1/*
rm -rf packages/worker/data/fingerprints/*
rm -rf packages/worker/data/storage-states/*

# é‡å¯ Worker
cd packages/worker && npm run dev
```

---

## Â§ æœ€æ–°è°ƒæŸ¥ç»“æœï¼ˆ2025-11-04ï¼‰

### è°ƒæŸ¥å·¥å…·
- MCP Playwright (Chrome DevTools Protocol)
- ç›´æ¥æµè§ˆå™¨æ“æ§å’Œ React Fiber æ·±åº¦åˆ†æ

### è°ƒæŸ¥æ­¥éª¤

#### æ­¥éª¤ 1: ä½¿ç”¨ MCP å¯¼èˆªåˆ°ç§ä¿¡é¡µé¢

```javascript
await page.goto('https://creator.douyin.com/creator-micro/data/following/chat');
```

**ç»“æœ**: âœ… æˆåŠŸåŠ è½½ï¼Œçœ‹åˆ° 4 ä¸ªé€‰é¡¹å¡ï¼ˆå…¨éƒ¨ã€æœ‹å‹ç§ä¿¡ã€é™Œç”Ÿäººç§ä¿¡ã€ç¾¤æ¶ˆæ¯ï¼‰

#### æ­¥éª¤ 2: ç‚¹å‡»ä¼šè¯

```javascript
await page.getByText('è918').click();
```

**ç»“æœ**: âœ… æˆåŠŸç‚¹å‡»ï¼Œå³ä¾§æ˜¾ç¤ºæ¶ˆæ¯å†…å®¹é¢æ¿

#### æ­¥éª¤ 3: åˆ†ææ‰€æœ‰ `[role="grid"]` å®¹å™¨

```javascript
const grids = document.querySelectorAll('[role="grid"]');
// æ‰¾åˆ° 4 ä¸ªå®¹å™¨
```

**å‘ç°**:
- å®¹å™¨ #0: ä½ç½® (0, 0), å°ºå¯¸ 0Ã—0 - ç©ºå®¹å™¨
- å®¹å™¨ #1: ä½ç½® (224, 202), å°ºå¯¸ 300Ã—497 - **å·¦ä¾§ä¼šè¯åˆ—è¡¨**
- å®¹å™¨ #2-3: ä½ç½® (0, 0), å°ºå¯¸ 0Ã—0 - ç©ºå®¹å™¨

**å…³é”®å‘ç°**: æ‰€æœ‰ `[role="grid"]` å®¹å™¨éƒ½åœ¨å·¦ä¾§ï¼ˆx < 300ï¼‰ï¼Œ**å³ä¾§æ¶ˆæ¯é¢æ¿ä¸ä½¿ç”¨è™šæ‹Ÿåˆ—è¡¨ï¼**

#### æ­¥éª¤ 4: æŸ¥æ‰¾å³ä¾§æ¶ˆæ¯å®¹å™¨

```javascript
// æŸ¥æ‰¾å³ä¾§å¤§å®¹å™¨ï¼ˆx > 500, width > 400, height > 300ï¼‰
const rightPanels = allDivs.filter(el => {
  const rect = el.getBoundingClientRect();
  return rect.x > 500 && rect.width > 400 && rect.height > 300;
});
```

**æ‰¾åˆ°å…³é”®å®¹å™¨**:
```javascript
{
  position: { x: 545, y: 71, width: 558, height: 492 },
  className: "box-content-jSgLQF",  // â† æ¶ˆæ¯é¢æ¿å®¹å™¨ï¼
  childCount: 8,
  hasReactFiber: true
}
```

#### æ­¥éª¤ 5: ä» React Fiber æå–æ¶ˆæ¯æ•°æ®

```javascript
const messageContainer = document.querySelector('.box-content-jSgLQF');
const innerContainer = messageContainer.children[0];
const children = Array.from(innerContainer.children);  // 8ä¸ªæ¶ˆæ¯å…ƒç´ 

// éå†æ¯ä¸ªå­å…ƒç´ 
for (let i = 0; i < children.length; i++) {
  const fiberKey = Object.keys(children[i]).find(k => k.startsWith('__reactFiber$'));
  const fiber = children[i][fiberKey];

  // æ·±åº¦æœç´¢ (depth 3) æ‰¾åˆ°æ¶ˆæ¯å¯¹è±¡
  const messageData = deepSearch(fiber);
}
```

**æˆåŠŸæå–åˆ° 2 æ¡æ¶ˆæ¯**:

**æ¶ˆæ¯ 1**:
```javascript
{
  serverId: "7568671043473754678",
  conversationId: "0:1:2270953921061816:4031246151199119",
  conversationShortId: "7568670955065606698",
  sender: "4031246151199119",
  secSender: "MS4wLjABAAAAcFGiBQe30yh1CY5GCOxXoZlw_3Toii_-MNBaC4CEFvceIXWh8paOxDgAD54mc1qO",
  content: {
    aweType: 701,
    text: "æˆ‘ä»¬å·²äº’ç›¸å…³æ³¨ï¼Œå¯ä»¥å¼€å§‹èŠå¤©äº†"
  },
  createdAt: "2025-11-04T01:09:21.106Z",
  type: 7,
  isFromMe: false,
  nickname: "è918",
  avatar: "https://p11.douyinpic.com/aweme/100x100/...",
  ext: {
    "s:mode": "0",
    "s:biz_aid": "1128",
    "s:server_message_create_time": "1762218561110",
    // ... æ›´å¤šæ‰©å±•ä¿¡æ¯
  }
}
```

**æ¶ˆæ¯ 2**:
```javascript
{
  serverId: "7568671060925843987",
  sender: "2270953921061816",
  content: {
    aweType: 701,
    text: "æˆ‘ä»¬å·²äº’ç›¸å…³æ³¨ï¼Œå¯ä»¥å¼€å§‹èŠå¤©äº†"
  },
  createdAt: "2025-11-04T01:09:21.085Z",
  isFromMe: true,
  nickname: "å®é™è‡´è¿œ",
  // ... å…¶ä»–å­—æ®µ
}
```

### å¯¹æ¯”ï¼šå·¦ä¾§ä¼šè¯åˆ—è¡¨ vs å³ä¾§æ¶ˆæ¯é¢æ¿

| ç‰¹å¾ | å·¦ä¾§ä¼šè¯åˆ—è¡¨ | å³ä¾§æ¶ˆæ¯é¢æ¿ |
|------|------------|------------|
| **é€‰æ‹©å™¨** | `[role="grid"]` | `.box-content-jSgLQF` |
| **ä½ç½®** | (224, 202) | (545, 71) |
| **æ¸²æŸ“æ–¹å¼** | React è™šæ‹Ÿåˆ—è¡¨ | æ™®é€š DOM åˆ—è¡¨ |
| **æ•°æ®å¯¹è±¡** | `conversation` + `user` | `message` å®Œæ•´å¯¹è±¡ |
| **å­—æ®µç¤ºä¾‹** | `conversation.id`, `user.nickname` | `serverId`, `content`, `createdAt` |
| **ç”¨é€”** | ä¼šè¯åˆ—è¡¨å…ƒæ•°æ® | æ¶ˆæ¯å†å²å†…å®¹ |

### å½“å‰çˆ¬è™«çš„é”™è¯¯

**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js`

**é”™è¯¯ä»£ç **:
```javascript
// âŒ æŸ¥æ‰¾çš„æ˜¯å·¦ä¾§ä¼šè¯åˆ—è¡¨è™šæ‹Ÿåˆ—è¡¨
const grids = await page.$$('[role="grid"]');

// âŒ åˆ†æçš„æ˜¯ä¼šè¯å…ƒæ•°æ®ï¼Œä¸æ˜¯æ¶ˆæ¯å†…å®¹
const messages = await extractMessagesFromVirtualList(page, ...);
```

**ä¸ºä»€ä¹ˆä¼šå¤±è´¥**:
1. ç‚¹å‡»ä¼šè¯åï¼Œä»£ç æŸ¥æ‰¾ `[role="grid"]` å®¹å™¨
2. æ‰¾åˆ°çš„æ˜¯**å·¦ä¾§ä¼šè¯åˆ—è¡¨**ï¼ˆä½ç½® 224, 202ï¼‰
3. ä» React Fiber æå–çš„æ˜¯ `conversation` å’Œ `user` å¯¹è±¡
4. æ²¡æœ‰ `serverId`ã€`content`ã€`createdAt` ç­‰æ¶ˆæ¯å­—æ®µ
5. è¿”å›ç©ºæ•°ç»„ï¼Œæ•°æ®åº“ä¸­æ¶ˆæ¯ä¸º 0

### æ­£ç¡®çš„æå–é€»è¾‘

```javascript
// âœ… ç‚¹å‡»ä¼šè¯åç­‰å¾…æ¶ˆæ¯åŠ è½½
await page.click(conversationElement);
await page.waitForTimeout(2000);

// âœ… æŸ¥æ‰¾å³ä¾§æ¶ˆæ¯å®¹å™¨ï¼ˆä¸æ˜¯è™šæ‹Ÿåˆ—è¡¨ï¼‰
const messageContainer = await page.$('.box-content-jSgLQF');
// æˆ–ä½¿ç”¨é€šç”¨é€‰æ‹©å™¨ï¼š
// const messageContainer = await page.evaluate(() => {
//   const divs = Array.from(document.querySelectorAll('div'));
//   return divs.find(el => {
//     const rect = el.getBoundingClientRect();
//     return rect.x > 500 && rect.width > 400 &&
//            el.textContent.includes('æˆ‘ä»¬å·²äº’ç›¸å…³æ³¨');
//   });
// });

if (!messageContainer) {
  console.log('æœªæ‰¾åˆ°æ¶ˆæ¯å®¹å™¨');
  return [];
}

// âœ… è·å–æ¶ˆæ¯å…ƒç´ åˆ—è¡¨
const innerContainer = await messageContainer.$('> *');
const children = await innerContainer.$$('> *');

// âœ… ä» React Fiber æå–æ¶ˆæ¯å¯¹è±¡
const messages = [];
for (const child of children) {
  const messageData = await child.evaluate(el => {
    const fiberKey = Object.keys(el).find(k => k.startsWith('__reactFiber$'));
    if (!fiberKey) return null;

    // æ·±åº¦æœç´¢æ‰¾åˆ°æ¶ˆæ¯å¯¹è±¡
    function deepSearch(fiber, depth = 0) {
      if (!fiber || depth > 20) return null;

      if (fiber.memoizedProps) {
        const props = fiber.memoizedProps;
        // æ£€æŸ¥æ˜¯å¦æ˜¯å®Œæ•´çš„æ¶ˆæ¯å¯¹è±¡
        if (props.serverId && props.content && props.sender && props.conversationId) {
          return {
            serverId: props.serverId,
            conversationId: props.conversationId,
            sender: props.sender,
            content: props.content,
            createdAt: props.createdAt,
            type: props.type,
            isFromMe: props.isFromMe,
            nickname: props.nickname,
            avatar: props.avatar
          };
        }
      }

      // é€’å½’æœç´¢
      let result = fiber.child && deepSearch(fiber.child, depth + 1);
      if (result) return result;

      result = depth < 5 && fiber.sibling && deepSearch(fiber.sibling, depth + 1);
      return result;
    }

    return deepSearch(el[fiberKey]);
  });

  if (messageData) {
    messages.push(messageData);
  }
}

return messages;
```

### æ•°æ®åº“å­—æ®µæ˜ å°„

| React Fiber å­—æ®µ | æ•°æ®åº“å­—æ®µ | ç¤ºä¾‹å€¼ |
|-----------------|-----------|--------|
| `serverId` | `message_id` | "7568671043473754678" |
| `conversationId` | `conversation_id` | "0:1:2270953921061816:4031246151199119" |
| `sender` | `sender_id` | "4031246151199119" |
| `secSender` | `sender_sec_id` | "MS4wLjABAAAA..." |
| `content.text` | `content` | "æˆ‘ä»¬å·²äº’ç›¸å…³æ³¨ï¼Œå¯ä»¥å¼€å§‹èŠå¤©äº†" |
| `content.aweType` | `message_type` | 701 |
| `createdAt` | `timestamp` | "2025-11-04T01:09:21.106Z" |
| `isFromMe` | `is_from_owner` | false |
| `nickname` | `sender_nickname` | "è918" |
| `type` | `msg_type` | 7 |

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… **å·²å®Œæˆ**: ä½¿ç”¨ MCP Playwright å®šä½é—®é¢˜æ ¹æº
2. â³ **å¾…å¤„ç†**: ä¿®æ”¹ `crawl-direct-messages-v2.js` ä¸­çš„å®¹å™¨æŸ¥æ‰¾é€»è¾‘
3. â³ **å¾…å¤„ç†**: æ›´æ–° React Fiber æå–å‡½æ•°
4. â³ **å¾…å¤„ç†**: æµ‹è¯•æ–°ä»£ç 
5. â³ **å¾…å¤„ç†**: éªŒè¯æ•°æ®åº“ä¸­æ¶ˆæ¯æ­£å¸¸ä¿å­˜

---

## æ€»ç»“

### å†å²è¯Šæ–­ vs çœŸå®åŸå› 

| å†å²è¯Šæ–­ | çœŸå®åŸå›  |
|---------|---------|
| âŒ æµè§ˆå™¨å¯åŠ¨å¤±è´¥ï¼ˆexitCode=21ï¼‰ | âœ… å®¹å™¨æŸ¥æ‰¾ä½ç½®é”™è¯¯ |
| âŒ æ¶ˆæ¯åŠ è½½ç­‰å¾…æ—¶é—´ä¸è¶³ | âœ… æŸ¥æ‰¾çš„æ˜¯ä¼šè¯åˆ—è¡¨ï¼Œä¸æ˜¯æ¶ˆæ¯é¢æ¿ |
| âŒ React Fiber æ•°æ®æœªåŠ è½½ | âœ… åˆ†æçš„å®¹å™¨å°±ä¸å¯¹ï¼Œå½“ç„¶æå–ä¸åˆ°æ¶ˆæ¯ |

### æœ€ç»ˆç»“è®º

**é—®é¢˜æ ¹æº**: å½“å‰çˆ¬è™«ä»£ç ä½¿ç”¨ `[role="grid"]` æŸ¥æ‰¾å®¹å™¨ï¼Œæ‰¾åˆ°çš„æ˜¯**å·¦ä¾§ä¼šè¯åˆ—è¡¨**ï¼ˆä½ç½® 224,202ï¼‰ï¼Œè€Œä¸æ˜¯**å³ä¾§æ¶ˆæ¯é¢æ¿**ï¼ˆä½ç½® 545,71ï¼‰ã€‚

ä¸¤ä¸ªå®¹å™¨çš„æ•°æ®ç»“æ„å®Œå…¨ä¸åŒï¼š
- å·¦ä¾§: `conversation` + `user` å¯¹è±¡ï¼ˆä¼šè¯å…ƒæ•°æ®ï¼‰
- å³ä¾§: `message` å¯¹è±¡ï¼ˆå®Œæ•´æ¶ˆæ¯æ•°æ®ï¼ŒåŒ…å« serverIdã€contentã€createdAt ç­‰ï¼‰

**è§£å†³æ–¹æ¡ˆ**: ä¿®æ”¹çˆ¬è™«ä»£ç ï¼ŒæŸ¥æ‰¾å³ä¾§æ¶ˆæ¯å®¹å™¨ï¼ˆ`.box-content-jSgLQF` æˆ–é€šç”¨ä½ç½®é€‰æ‹©å™¨ï¼‰ï¼Œå¹¶ä»æ­£ç¡®çš„ React Fiber ç»“æ„ä¸­æå–æ¶ˆæ¯å¯¹è±¡ã€‚

---

**æŠ¥å‘Šå®Œæˆæ—¶é—´**: 2025-11-04
**è°ƒæŸ¥å·¥å…·**: Claude Code + MCP Playwright
**çŠ¶æ€**: âœ… é—®é¢˜å·²å®Œå…¨å®šä½ï¼Œç­‰å¾…ä»£ç ä¿®å¤
