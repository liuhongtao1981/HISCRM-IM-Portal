# ç™»å½•åŠŸèƒ½å®Œæ•´è¯Šæ–­æ€»ç»“

**æ—¥æœŸ**: 2025-10-24
**ä¼šè¯**: ç™»å½•åŠŸèƒ½ä¿®å¤
**çŠ¶æ€**: ä»£ç ä¿®å¤å®Œæˆ,æµè§ˆå™¨ç¯å¢ƒé—®é¢˜é˜»å¡

---

## âœ… å·²æˆåŠŸä¿®å¤çš„ä»£ç é—®é¢˜ (3ä¸ª)

### 1. `platformInstance.getName is not a function`

**æ–‡ä»¶**: [`packages/worker/src/index.js:312`](packages/worker/src/index.js#L312)

**é—®é¢˜åŸå› **: `PlatformBase` ç±»æ²¡æœ‰å®šä¹‰ `getName()` æ–¹æ³•

**ä¿®å¤å†…å®¹**:
```javascript
// ä¿®å¤å‰
logger.info(`[handleLoginRequest] âœ“ Platform instance found: ${platformInstance.getName()}`);

// ä¿®å¤å
logger.info(`[handleLoginRequest] âœ“ Platform instance found: ${platformInstance.config.displayName} (${platformInstance.config.platform})`);
```

**çŠ¶æ€**: âœ… å®Œæˆ

---

### 2. `startLogin()` å‚æ•°ä¼ é€’ä¸åŒ¹é…

**æ–‡ä»¶**: [`packages/worker/src/index.js:316-320`](packages/worker/src/index.js#L316-L320)

**é—®é¢˜åŸå› **:
- åŸºç±»å®šä¹‰ä½¿ç”¨ä¸‰ä¸ªç‹¬ç«‹å‚æ•°
- æŠ–éŸ³å¹³å°å®ç°ä½¿ç”¨å¯¹è±¡å‚æ•°
- éœ€è¦åŒ¹é…æŠ–éŸ³å¹³å°çš„ç­¾å

**ä¿®å¤å†…å®¹**:
```javascript
// ä¿®å¤å
await platformInstance.startLogin({
  accountId: account_id,
  sessionId: session_id,
  proxy: proxy
});
```

**çŠ¶æ€**: âœ… å®Œæˆ

---

### 3. Worker ID ç¯å¢ƒå˜é‡é…ç½®

**æ–‡ä»¶**: [`packages/worker/.env:4`](packages/worker/.env#L4)

**é—®é¢˜åŸå› **: æœªé…ç½® `WORKER_ID`,å¯¼è‡´æ¯æ¬¡å¯åŠ¨ç”Ÿæˆéšæœº ID

**ä¿®å¤å†…å®¹**:
```env
# Worker IDï¼ˆå¿…é¡»ä¸æ•°æ®åº“ä¸­çš„ worker_id ä¸€è‡´ï¼‰
WORKER_ID=worker1
```

**éªŒè¯ç»“æœ**:
- âœ… Worker æˆåŠŸä»¥ `worker1` ID å¯åŠ¨
- âœ… è¢«åˆ†é…äº†è´¦æˆ· `acc-98296c87-2e42-447a-9d8b-8be008ddb6e4`

**çŠ¶æ€**: âœ… å®Œæˆ

---

## âŒ å½“å‰é˜»å¡é—®é¢˜:æµè§ˆå™¨åˆå§‹åŒ–å¤±è´¥ (ç¯å¢ƒé—®é¢˜)

### é”™è¯¯è¯¦æƒ…

```
browserType.launchPersistentContext: Target page, context or browser has been closed
Browser logs:
<launched> pid=14708
<process did exit: exitCode=21, signal=null>
```

### é—®é¢˜åˆ†æ

**æ ¸å¿ƒåŸå› **: Chrome exitCode=21 è¡¨ç¤ºæµè§ˆå™¨åˆå§‹åŒ–å¤±è´¥

**å·²å°è¯•çš„ä¿®å¤æ–¹æ¡ˆ**:
1. âŒ åˆ é™¤æµè§ˆå™¨æ•°æ®ç›®å½• - æ–‡ä»¶è¢«é”å®š
2. âŒ æ€æ­»æ‰€æœ‰ Chrome è¿›ç¨‹ - æ–‡ä»¶ä»è¢«é”å®š
3. âŒ é‡å‘½åæ—§æ•°æ®ç›®å½•å¹¶åˆ›å»ºæ–°ç›®å½• - **Chrome ä»ç„¶å¤±è´¥**

**å…³é”®å‘ç°**: å³ä½¿ä½¿ç”¨å…¨æ–°çš„æ•°æ®ç›®å½•,Chrome ä»ä»¥ exitCode=21 é€€å‡º,è¯´æ˜è¿™ä¸æ˜¯æ•°æ®ç›®å½•é—®é¢˜ã€‚

### å¯èƒ½çš„åŸå› 

1. **Playwright Chromium ç‰ˆæœ¬ä¸å…¼å®¹**
   - Playwright ä½¿ç”¨çš„ Chromium ç‰ˆæœ¬: 1194
   - å¯èƒ½ä¸ Windows ç³»ç»Ÿæˆ–å…¶ä»–è½¯ä»¶å†²çª

2. **ç³»ç»Ÿç¯å¢ƒé™åˆ¶**
   - é˜²ç—…æ¯’è½¯ä»¶é˜»æ­¢ Chrome å¯åŠ¨
   - Windows å®‰å…¨ç­–ç•¥é™åˆ¶
   - ç¼ºå°‘å¿…è¦çš„ç³»ç»Ÿåº“

3. **Chrome æ²™ç®±é—®é¢˜**
   - è™½ç„¶å·²æ·»åŠ  `--no-sandbox` å‚æ•°
   - å¯èƒ½ä»æœ‰æ²™ç®±ç›¸å…³çš„åˆå§‹åŒ–å¤±è´¥

### æµè§ˆå™¨å¯åŠ¨å‚æ•°

```
chrome.exe
  --no-sandbox
  --disable-setuid-sandbox
  --disable-dev-shm-usage
  --disable-blink-features=AutomationControlled
  --window-size=1440,900
  --user-data-dir=E:\HISCRM-IM-main\packages\worker\data\browser\worker1\browser_acc-xxx
  --remote-debugging-pipe
```

---

## ğŸ” æ¨èè§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ç¦ç”¨æŒä¹…åŒ–ä¸Šä¸‹æ–‡,æ”¹ç”¨å¸¸è§„æµè§ˆå™¨ (æ¨è)

ä¿®æ”¹ [`packages/worker/src/browser/browser-manager-v2.js`](packages/worker/src/browser/browser-manager-v2.js),åœ¨ç™»å½•æ—¶ä¸ä½¿ç”¨ `launchPersistentContext`,è€Œæ˜¯ä½¿ç”¨ `launch` + `newContext`:

```javascript
// æ–¹æ¡ˆ 1: ä½¿ç”¨éæŒä¹…åŒ–æµè§ˆå™¨è¿›è¡Œç™»å½•
async launchBrowserForLogin(accountId, proxy) {
  const browser = await playwright.chromium.launch({
    headless: false,  // ç™»å½•éœ€è¦å¯è§æµè§ˆå™¨
    args: ['--no-sandbox', '--disable-setuid-sandbox']
  });

  const context = await browser.newContext({
    // åº”ç”¨æŒ‡çº¹é…ç½®
    ...this.getFingerprint(accountId)
  });

  return { browser, context };
}
```

**ä¼˜ç‚¹**:
- é¿å¼€ persistent context çš„å¤æ‚æ€§
- ç™»å½•æˆåŠŸåå†ä¿å­˜ cookies
- æ›´å®¹æ˜“è°ƒè¯•

**ç¼ºç‚¹**:
- éœ€è¦ä¿®æ”¹æµè§ˆå™¨ç®¡ç†é€»è¾‘
- ç™»å½•åéœ€è¦æ‰‹åŠ¨ä¿å­˜ cookies

---

### æ–¹æ¡ˆ 2: ä½¿ç”¨ç³»ç»Ÿå®‰è£…çš„ Chrome

ä¿®æ”¹ Playwright é…ç½®,ä½¿ç”¨ç³»ç»Ÿå·²å®‰è£…çš„ Chrome è€Œé Playwright æ†ç»‘çš„ Chromium:

```javascript
const browser = await playwright.chromium.launch({
  channel: 'chrome',  // ä½¿ç”¨ç³»ç»Ÿ Chrome
  headless: false
});
```

**ä¼˜ç‚¹**:
- ä½¿ç”¨ç¨³å®šç‰ˆ Chrome
- é¿å¼€ Playwright Chromium çš„å…¼å®¹æ€§é—®é¢˜

**ç¼ºç‚¹**:
- éœ€è¦ç³»ç»Ÿå®‰è£… Chrome
- ä¸åŒæœºå™¨çš„ Chrome ç‰ˆæœ¬å¯èƒ½ä¸ä¸€è‡´

---

### æ–¹æ¡ˆ 3: è¯Šæ–­ Chrome å¯åŠ¨å¤±è´¥çš„è¯¦ç»†åŸå› 

åˆ›å»ºè¯Šæ–­è„šæœ¬,å°è¯•å¯åŠ¨ Chrome å¹¶æ•è·è¯¦ç»†é”™è¯¯:

```javascript
// tests/diagnose-chrome.js
const { chromium } = require('playwright');

async function diagnoseChrome() {
  try {
    console.log('å°è¯•å¯åŠ¨ Playwright Chromium...');

    const browser = await chromium.launch({
      headless: false,
      args: ['--no-sandbox']
    });

    console.log('âœ… Chromium å¯åŠ¨æˆåŠŸ!');
    await browser.close();

  } catch (error) {
    console.log('âŒ Chromium å¯åŠ¨å¤±è´¥:');
    console.log(error);
  }

  try {
    console.log('\nå°è¯•å¯åŠ¨ç³»ç»Ÿ Chrome...');

    const browser = await chromium.launch({
      channel: 'chrome',
      headless: false
    });

    console.log('âœ… Chrome å¯åŠ¨æˆåŠŸ!');
    await browser.close();

  } catch (error) {
    console.log('âŒ Chrome å¯åŠ¨å¤±è´¥:');
    console.log(error);
  }
}

diagnoseChrome();
```

---

## ğŸ“Š ç™»å½•åŠŸèƒ½ä¿®å¤è¿›åº¦

| æ­¥éª¤ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| 1. Admin Web å‘é€ç™»å½•è¯·æ±‚ | âœ… | æ­£å¸¸å·¥ä½œ |
| 2. Master æ¥æ”¶å¹¶è½¬å‘ | âœ… | æ­£å¸¸å·¥ä½œ |
| 3. Worker æ¥æ”¶ç™»å½•è¯·æ±‚ | âœ… | ä¿®å¤åæ­£å¸¸ |
| 4. Worker è·å–å¹³å°å®ä¾‹ | âœ… | ä¿®å¤åæ­£å¸¸ |
| 5. è°ƒç”¨ `startLogin()` | âœ… | ä¿®å¤åæ­£å¸¸ |
| 6. **æµè§ˆå™¨åˆå§‹åŒ–** | âŒ | **Chrome exitCode=21 é˜»å¡** |
| 7. æ‰“å¼€ç™»å½•é¡µé¢ | â¸ | æœªæ‰§è¡Œ (è¢«æ­¥éª¤6é˜»å¡) |
| 8. æ˜¾ç¤ºäºŒç»´ç  | â¸ | æœªæ‰§è¡Œ |
| 9. æ‰«ç ç™»å½• | â¸ | æœªæ‰§è¡Œ |
| 10. å‘é€æˆåŠŸçŠ¶æ€ | â¸ | æœªæ‰§è¡Œ |

**å½“å‰é˜»å¡**: æ­¥éª¤ 6 - æµè§ˆå™¨åˆå§‹åŒ–

---

## ğŸ’¡ ç«‹å³å¯æ‰§è¡Œçš„æµ‹è¯•

### æµ‹è¯• 1: è¯Šæ–­ Chrome å¯åŠ¨

åˆ›å»ºå¹¶è¿è¡Œè¯Šæ–­è„šæœ¬:

```bash
# åˆ›å»ºæµ‹è¯•æ–‡ä»¶ tests/diagnose-chrome.js (å†…å®¹è§ä¸Šæ–¹æ–¹æ¡ˆ3)

# è¿è¡Œè¯Šæ–­
cd tests
node diagnose-chrome.js
```

### æµ‹è¯• 2: ä¸´æ—¶ç¦ç”¨è´¦æˆ·åˆå§‹åŒ–

ä¿®æ”¹ Worker å¯åŠ¨é€»è¾‘,è·³è¿‡è´¦æˆ·åˆå§‹åŒ–,ç›´æ¥è¿›å…¥å¾…å‘½çŠ¶æ€:

```javascript
// packages/worker/src/index.js
// ä¸´æ—¶æ³¨é‡Šæ‰è´¦æˆ·åˆå§‹åŒ–
// await accountInitializer.initializeAccounts(accounts);

logger.warn('âš ï¸  Skipped account initialization for debugging');
```

ç„¶åå°è¯•è§¦å‘ç™»å½•,çœ‹çœ‹ `startLogin()` ä¸­çš„æµè§ˆå™¨å¯åŠ¨æ˜¯å¦ä¼šæˆåŠŸã€‚

---

## ğŸ“ ä¿®å¤æ–‡ä»¶æ¸…å•

### å·²ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | è¡Œå· | ä¿®æ”¹å†…å®¹ | çŠ¶æ€ |
|------|------|----------|------|
| `packages/worker/src/index.js` | 312 | ä¿®å¤ `getName()` è°ƒç”¨ | âœ… |
| `packages/worker/src/index.js` | 316-320 | ä¿®å¤ `startLogin` å‚æ•° | âœ… |
| `packages/worker/.env` | 4 | æ·»åŠ  `WORKER_ID=worker1` | âœ… |

### å¾…ä¿®æ”¹çš„æ–‡ä»¶ (æ ¹æ®é€‰æ‹©çš„æ–¹æ¡ˆ)

**æ–¹æ¡ˆ 1 - ä½¿ç”¨éæŒä¹…åŒ–æµè§ˆå™¨**:
- `packages/worker/src/browser/browser-manager-v2.js` - æ·»åŠ  `launchBrowserForLogin()` æ–¹æ³•
- `packages/worker/src/platforms/douyin/platform.js` - ä¿®æ”¹ `startLogin()` ä½¿ç”¨æ–°æ–¹æ³•

**æ–¹æ¡ˆ 2 - ä½¿ç”¨ç³»ç»Ÿ Chrome**:
- `packages/worker/src/browser/browser-manager-v2.js` - æ·»åŠ  `channel: 'chrome'` é€‰é¡¹

**æ–¹æ¡ˆ 3 - ç¦ç”¨åˆå§‹åŒ–**:
- `packages/worker/src/index.js` - æ³¨é‡Šè´¦æˆ·åˆå§‹åŒ–é€»è¾‘

---

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

### ä¼˜å…ˆçº§ 1: è¯Šæ–­å¹¶ä¿®å¤ Chrome å¯åŠ¨é—®é¢˜

1. **è¿è¡Œè¯Šæ–­è„šæœ¬** (è§æµ‹è¯•1)
   - æµ‹è¯• Playwright Chromium æ˜¯å¦èƒ½å¯åŠ¨
   - æµ‹è¯•ç³»ç»Ÿ Chrome æ˜¯å¦èƒ½å¯åŠ¨
   - è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯

2. **æ ¹æ®è¯Šæ–­ç»“æœé€‰æ‹©æ–¹æ¡ˆ**:
   - å¦‚æœç³»ç»Ÿ Chrome å¯ä»¥å¯åŠ¨ â†’ ä½¿ç”¨æ–¹æ¡ˆ 2
   - å¦‚æœéƒ½æ— æ³•å¯åŠ¨ â†’ æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒ (é˜²ç—…æ¯’/å®‰å…¨ç­–ç•¥)
   - å¦‚æœé—®é¢˜ä»…åœ¨ persistent context â†’ ä½¿ç”¨æ–¹æ¡ˆ 1

### ä¼˜å…ˆçº§ 2: ä¸´æ—¶ç»•è¿‡é—®é¢˜

1. **ç¦ç”¨è´¦æˆ·åˆå§‹åŒ–** (è§æµ‹è¯•2)
2. **ç›´æ¥è§¦å‘ç™»å½•è¯·æ±‚**
3. **éªŒè¯ç™»å½•æµç¨‹ä»£ç é€»è¾‘**

è¿™æ ·å³ä½¿æµè§ˆå™¨æœ‰é—®é¢˜,ä¹Ÿèƒ½éªŒè¯å…¶ä»–ä»£ç æ˜¯å¦æ­£ç¡®ã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **è°ƒè¯•æŠ¥å‘Š**: [ç™»å½•åŠŸèƒ½è°ƒè¯•è¿›å±•æŠ¥å‘Š.md](ç™»å½•åŠŸèƒ½è°ƒè¯•è¿›å±•æŠ¥å‘Š.md)
- **ç³»ç»Ÿæ–‡æ¡£**: [03-WORKER-ç³»ç»Ÿæ–‡æ¡£.md](03-WORKER-ç³»ç»Ÿæ–‡æ¡£.md)
- **å¹³å°å®ç°**: [05-DOUYIN-å¹³å°å®ç°æŠ€æœ¯ç»†èŠ‚.md](05-DOUYIN-å¹³å°å®ç°æŠ€æœ¯ç»†èŠ‚.md)

---

## æ€»ç»“

âœ… **å·²å®Œæˆ**:
- ä¿®å¤äº†ç™»å½•æµç¨‹ä¸­çš„3ä¸ªä»£ç é”™è¯¯
- Worker èƒ½æ­£ç¡®å¯åŠ¨å¹¶æ³¨å†Œ
- ç™»å½•è¯·æ±‚èƒ½æ­£ç¡®ä¼ é€’åˆ°å¹³å°å®ä¾‹

âŒ **æœªå®Œæˆ**:
- æµè§ˆå™¨åˆå§‹åŒ–å¤±è´¥ (Chrome exitCode=21)
- æ— æ³•æ‰“å¼€ç™»å½•é¡µé¢æ˜¾ç¤ºäºŒç»´ç 
- æ— æ³•å®Œæˆå®Œæ•´çš„ç™»å½•æµç¨‹æµ‹è¯•

ğŸ”§ **å»ºè®®æ–¹æ¡ˆ**:
1. è¿è¡Œè¯Šæ–­è„šæœ¬ç¡®å®šé—®é¢˜æ ¹æº
2. æ ¹æ®è¯Šæ–­ç»“æœé€‰æ‹©ç»•è¿‡æˆ–ä¿®å¤æ–¹æ¡ˆ
3. æµ‹è¯•å®Œæ•´ç™»å½•æµç¨‹

**æŠ¥å‘Šäºº**: Claude Code Assistant
**æœ€åæ›´æ–°**: 2025-10-24 11:50
