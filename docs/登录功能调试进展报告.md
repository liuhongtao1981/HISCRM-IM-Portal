# ç™»å½•åŠŸèƒ½è°ƒè¯•è¿›å±•æŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-24
**çŠ¶æ€**: è°ƒè¯•è¿›è¡Œä¸­ - å‘ç°æ–°é—®é¢˜
**ä¼šè¯**: ç»§ç»­ä¼šè¯

---

## ğŸ“Š é—®é¢˜è¿½è¸ª

### âœ… å·²ä¿®å¤çš„é—®é¢˜

#### 1. `platformInstance.getName is not a function` (å·²è§£å†³)

**ä½ç½®**: `packages/worker/src/index.js:312`

**é—®é¢˜**: `PlatformBase` ç±»æ²¡æœ‰å®šä¹‰ `getName()` æ–¹æ³•

**ä¿®å¤**:
```javascript
// ä¿®å¤å‰
logger.info(`[handleLoginRequest] âœ“ Platform instance found: ${platformInstance.getName()}`);

// ä¿®å¤å
logger.info(`[handleLoginRequest] âœ“ Platform instance found: ${platformInstance.config.displayName} (${platformInstance.config.platform})`);
```

**çŠ¶æ€**: âœ… å®Œæˆ

---

#### 2. `startLogin()` å‚æ•°ä¼ é€’ä¸ä¸€è‡´ (å·²è§£å†³)

**ä½ç½®**: `packages/worker/src/index.js:316-320`

**é—®é¢˜**:
- `PlatformBase` åŸºç±»å®šä¹‰: `async startLogin(accountId, sessionId, proxyConfig)`
- æŠ–éŸ³å¹³å°å®ç°: `async startLogin(options)` å¹¶è§£æ„ `{ accountId, sessionId, proxy }`
- è°ƒç”¨æ–¹å¼éœ€è¦åŒ¹é…æŠ–éŸ³å¹³å°å®ç°

**ä¿®å¤**:
```javascript
// ä¿®å¤å‰ (ç¬¬ä¸€æ¬¡å°è¯• - é”™è¯¯)
await platformInstance.startLogin(account_id, session_id, proxy);

// ä¿®å¤å (æ­£ç¡®)
await platformInstance.startLogin({
  accountId: account_id,
  sessionId: session_id,
  proxy: proxy
});
```

**çŠ¶æ€**: âœ… å®Œæˆ

---

### âŒ å½“å‰æœªè§£å†³çš„é—®é¢˜

#### 3. `Cannot read properties of undefined (reading 'get')` (æœ€æ–°é—®é¢˜)

**é”™è¯¯æ¶ˆæ¯**:
```
Login failed: Cannot read properties of undefined (reading 'get')
```

**ç°è±¡**:
1. Worker æ¥æ”¶åˆ°ç™»å½•è¯·æ±‚
2. ç«‹å³æŠ¥é”™å¹¶å‘é€å¤±è´¥çŠ¶æ€ç»™ Master
3. æ²¡æœ‰è¯¦ç»†çš„å †æ ˆè·Ÿè¸ªä¿¡æ¯

**å¯èƒ½çš„åŸå› **:
- æŸä¸ªå¯¹è±¡ (å¯èƒ½æ˜¯ Map æˆ–é›†åˆ) ä¸º `undefined`
- åœ¨æŠ–éŸ³å¹³å°çš„ `startLogin()` æ–¹æ³•ä¸­è®¿é—®äº†æœªåˆå§‹åŒ–çš„å±æ€§

**éœ€è¦çš„è°ƒè¯•ä¿¡æ¯**:
- å®Œæ•´çš„é”™è¯¯å †æ ˆè·Ÿè¸ª
- Worker çš„è¯¦ç»†æ—¥å¿—è¾“å‡º
- ç¡®å®šæ˜¯å“ªä¸ªå¯¹è±¡çš„ `.get()` æ–¹æ³•è¢«è°ƒç”¨

**çŠ¶æ€**: âš ï¸  æ­£åœ¨è°ƒæŸ¥

---

#### 4. Worker ID ç¯å¢ƒå˜é‡è®¾ç½®å¤±è´¥

**é—®é¢˜**: æ— æ³•é€šè¿‡ç¯å¢ƒå˜é‡æ­£ç¡®è®¾ç½® `WORKER_ID=worker1`

**å°è¯•çš„æ–¹æ³•**:
1. âŒ `set WORKER_ID=worker1&& node src/index.js` - è¯­æ³•é”™è¯¯,ç¯å¢ƒå˜é‡æœªç”Ÿæ•ˆ
2. âŒ PowerShell `$env:WORKER_ID='worker1'; node src/index.js` - è¯­æ³•é”™è¯¯

**å½“å‰ç°è±¡**:
- Worker æ€»æ˜¯ä»¥éšæœº ID å¯åŠ¨ (å¦‚ `worker-a4db0d2b`, `worker-6282674c`)
- ä¸ä¼šè¢«åˆ†é…åˆ°ä»»ä½•è´¦æˆ· (æ˜¾ç¤º "0 accounts assigned")

**å½±å“**:
- æ— æ³•æ‰‹åŠ¨å¯åŠ¨ `worker1` æ¥è°ƒè¯•ç™»å½•åŠŸèƒ½
- Master è‡ªåŠ¨å¯åŠ¨çš„ Worker æ—¥å¿—ä¸å¯è§

**çŠ¶æ€**: âš ï¸  é˜»å¡è°ƒè¯•

---

## ğŸ” è°ƒè¯•å†ç¨‹

### ä¼šè¯å¼€å§‹

ç”¨æˆ·ç¡®è®¤å·²æ€æ­»æ‰€æœ‰è¿›ç¨‹,è¯·æ±‚ç»§ç»­ä¿®å¤ç™»å½•åŠŸèƒ½ã€‚

### ç¬¬ä¸€è½®ä¿®å¤

**é—®é¢˜**: `platformInstance.getName is not a function`

**è°ƒæŸ¥è¿‡ç¨‹**:
1. åˆ›å»ºæµ‹è¯•è„šæœ¬ `tests/test-platform-load.js`
2. ç›´æ¥å®ä¾‹åŒ– `DouyinPlatform` å¹¶æ£€æŸ¥å¯ç”¨æ–¹æ³•
3. å‘ç° `getName()` æ–¹æ³•ä¸å­˜åœ¨
4. æ£€æŸ¥ `PlatformBase` ç±»å®šä¹‰,ç¡®è®¤æ²¡æœ‰æ­¤æ–¹æ³•
5. å¹³å°åç§°å­˜å‚¨åœ¨ `this.config.platform` å’Œ `this.config.displayName`

**ä¿®å¤**: ä½¿ç”¨ `config` å±æ€§è®¿é—®å¹³å°åç§°

---

### ç¬¬äºŒè½®ä¿®å¤

**é—®é¢˜**: `Cannot read properties of undefined (reading 'length')`

**è°ƒæŸ¥è¿‡ç¨‹**:
1. é‡å¯ Worker éªŒè¯ç¬¬ä¸€æ¬¡ä¿®å¤
2. è§¦å‘ç™»å½•è¯·æ±‚
3. æ”¶åˆ°æ–°é”™è¯¯: `Cannot read properties of undefined (reading 'length')`
4. æ£€æŸ¥æŠ–éŸ³å¹³å°çš„ `startLogin()` æ–¹æ³•ç­¾å
5. å‘ç°æ–¹æ³•æœŸæœ›å¯¹è±¡å‚æ•°,ä¸æ˜¯ç‹¬ç«‹å‚æ•°

**é”™è¯¯åŸå› **:
```javascript
// æŠ–éŸ³å¹³å°å®šä¹‰
async startLogin(options) {
  const { accountId, sessionId, proxy } = options;
  // ...
}

// æˆ‘çš„é”™è¯¯è°ƒç”¨
await platformInstance.startLogin(account_id, session_id, proxy);
// å¯¼è‡´: options = account_id (å­—ç¬¦ä¸²)
// è§£æ„å¤±è´¥: { accountId, sessionId, proxy } = "acc-xxx"
// ç»“æœ: æ‰€æœ‰å˜é‡éƒ½æ˜¯ undefined
```

**ä¿®å¤**: æ¢å¤ä½¿ç”¨å¯¹è±¡å‚æ•°ä¼ é€’

---

### ç¬¬ä¸‰è½®è°ƒè¯•

**é—®é¢˜**: `Cannot read properties of undefined (reading 'get')`

**è°ƒæŸ¥è¿‡ç¨‹**:
1. é‡å¯ Worker éªŒè¯ç¬¬äºŒæ¬¡ä¿®å¤
2. è§¦å‘ç™»å½•è¯·æ±‚
3. æ”¶åˆ°æ–°é”™è¯¯: `Cannot read properties of undefined (reading 'get')`
4. å°è¯•æ‰‹åŠ¨å¯åŠ¨ Worker æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
5. é‡åˆ°ç¯å¢ƒå˜é‡è®¾ç½®é—®é¢˜

**å½“å‰çŠ¶æ€**: è¢«ç¯å¢ƒå˜é‡é—®é¢˜é˜»å¡,æ— æ³•çœ‹åˆ°å®Œæ•´çš„ Worker æ—¥å¿—

---

## ğŸ“ ä¿®å¤æ–‡ä»¶æ¸…å•

### å·²ä¿®æ”¹çš„æ–‡ä»¶

1. **packages/worker/src/index.js**
   - ç¬¬ 312 è¡Œ: ä¿®å¤ `getName()` è°ƒç”¨ â†’ ä½¿ç”¨ `config.displayName`
   - ç¬¬ 316-320 è¡Œ: ä¿®å¤ `startLogin` å‚æ•° â†’ ä½¿ç”¨å¯¹è±¡å‚æ•°

### æ–°å¢çš„æµ‹è¯•æ–‡ä»¶

1. **tests/test-platform-load.js** - å¹³å°åŠ è½½æµ‹è¯• (è°ƒè¯•ç”¨)
2. **tests/trigger-login-test.js** - ç™»å½•è§¦å‘æµ‹è¯•

---

## ğŸ› å·²çŸ¥é—®é¢˜

### 1. å¹³å°æ¥å£ä¸ä¸€è‡´

**é—®é¢˜**: `PlatformBase` åŸºç±»å’ŒæŠ–éŸ³å¹³å°å®ç°çš„ `startLogin()` æ–¹æ³•ç­¾åä¸ä¸€è‡´

**åŸºç±»** (`platform-base.js:43`):
```javascript
async startLogin(accountId, sessionId, proxyConfig) {
  throw new Error('startLogin must be implemented by subclass');
}
```

**æŠ–éŸ³å®ç°** (`douyin/platform.js:50-51`):
```javascript
async startLogin(options) {
  const { accountId, sessionId, proxy } = options;
  // ...
}
```

**å»ºè®®ä¿®å¤**: ç»Ÿä¸€ä¸ºå¯¹è±¡å‚æ•°,å¹¶æ›´æ–°åŸºç±»ç­¾å

---

### 2. Worker æ—¥å¿—ä¸å¯è§

**é—®é¢˜**: Master é€šè¿‡ `LocalProcessManager` å¯åŠ¨çš„ Worker å­è¿›ç¨‹,stdout/stderr æœªè¢«é‡å®šå‘

**å½±å“**: æ— æ³•çœ‹åˆ° Worker çš„è¯¦ç»†æ—¥å¿—,è°ƒè¯•å›°éš¾

**ä¸´æ—¶æ–¹æ¡ˆ**: æ‰‹åŠ¨å¯åŠ¨ Worker (ä½†ç¯å¢ƒå˜é‡è®¾ç½®æœ‰é—®é¢˜)

**é•¿æœŸä¿®å¤**: ä¿®æ”¹ `packages/master/src/worker_manager/local-process-manager.js`,é‡å®šå‘å­è¿›ç¨‹è¾“å‡º

---

### 3. Windows ç¯å¢ƒå˜é‡è®¾ç½®

**é—®é¢˜**: åœ¨ Windows å‘½ä»¤è¡Œä¸­è®¾ç½® `WORKER_ID` ç¯å¢ƒå˜é‡å¤±è´¥

**éœ€è¦çš„æ–¹æ³•**:
- æ–¹æ¡ˆ 1: ä½¿ç”¨ `.env` æ–‡ä»¶
- æ–¹æ¡ˆ 2: åœ¨ PowerShell ä¸­ä½¿ç”¨æ­£ç¡®çš„è¯­æ³•
- æ–¹æ¡ˆ 3: ä¿®æ”¹ `package.json` æ·»åŠ  npm è„šæœ¬

---

## ğŸ”œ ä¸‹ä¸€æ­¥è®¡åˆ’

### ç«‹å³è¡ŒåŠ¨

1. **è§£å†³ç¯å¢ƒå˜é‡é—®é¢˜**:
   - é€‰é¡¹ A: åˆ›å»º `packages/worker/.env` æ–‡ä»¶,è®¾ç½® `WORKER_ID=worker1`
   - é€‰é¡¹ B: ä½¿ç”¨æ­£ç¡®çš„ PowerShell è¯­æ³•
   - é€‰é¡¹ C: ä¿®æ”¹ Master çš„ LocalProcessManager,è®©å®ƒé‡å®šå‘ Worker æ—¥å¿—

2. **è·å–å®Œæ•´é”™è¯¯å †æ ˆ**:
   - æˆåŠŸå¯åŠ¨ `worker1`
   - è§¦å‘ç™»å½•è¯·æ±‚
   - æŸ¥çœ‹å®Œæ•´çš„é”™è¯¯å †æ ˆè·Ÿè¸ª
   - å®šä½ `.get()` è°ƒç”¨çš„å…·ä½“ä½ç½®

3. **ä¿®å¤ `.get()` é”™è¯¯**:
   - æ ¹æ®å †æ ˆè·Ÿè¸ªå®šä½é—®é¢˜ä»£ç 
   - æ£€æŸ¥æ˜¯å¦æœ‰æœªåˆå§‹åŒ–çš„ Map æˆ–é›†åˆ
   - ä¿®å¤å¹¶æµ‹è¯•

### é•¿æœŸä¼˜åŒ–

1. **ç»Ÿä¸€å¹³å°æ¥å£**: æ›´æ–° `PlatformBase` å’Œæ‰€æœ‰å¹³å°å®ç°,ä½¿ç”¨ä¸€è‡´çš„æ–¹æ³•ç­¾å
2. **æ”¹è¿›æ—¥å¿—ç³»ç»Ÿ**: Worker æ—¥å¿—é‡å®šå‘åˆ° Master
3. **å¢å¼ºé”™è¯¯å¤„ç†**: åœ¨å…³é”®æ–¹æ³•ä¸­æ·»åŠ å‚æ•°éªŒè¯å’Œè¯¦ç»†é”™è¯¯ä¿¡æ¯

---

## ğŸ“Š å®Œæ•´è°ƒç”¨é“¾è·¯

### é¢„æœŸçš„ç™»å½•æµç¨‹

```
1. Admin Web å‘é€ç™»å½•è¯·æ±‚
   â†“
2. Master /admin namespace æ¥æ”¶ (admin-namespace.js)
   event: 'master:login:start'
   data: { account_id, worker_id, session_id }
   â†“
3. Master è½¬å‘åˆ° Worker (socket-server.js)
   emit to room: `worker:${worker_id}`
   event: 'master:login:start'
   data: { account_id, session_id, platform, proxy }
   â†“
4. Worker æ¥æ”¶ (index.js:179)
   handler: handleLoginRequest(data)
   â†“
5. Worker è°ƒç”¨å¹³å°å®ä¾‹ (index.js:316)
   âœ… platformInstance.startLogin({ accountId, sessionId, proxy })
   â†“
6. æŠ–éŸ³å¹³å°æ‰§è¡Œç™»å½• (douyin/platform.js:50+)
   âŒ è¿™é‡Œå‘ç”Ÿé”™è¯¯: "Cannot read properties of undefined (reading 'get')"
   â†“
7. Worker å‘é€å¤±è´¥çŠ¶æ€
   event: 'worker:login:status'
   data: { session_id, status: 'failed', error_message, ... }
   â†“
8. Master è½¬å‘åˆ° Admin Web
   event: 'login:status:update'
```

---

## ğŸ’¡ å…³é”®å‘ç°

### 1. å¹³å°ç³»ç»Ÿæ¶æ„

- **PlatformManager**: åŠ è½½å’Œç®¡ç†æ‰€æœ‰å¹³å°å®ä¾‹
- **PlatformBase**: æŠ½è±¡åŸºç±»,å®šä¹‰é€šç”¨æ¥å£
- **DouyinPlatform**: æŠ–éŸ³ç‰¹å®šå®ç°
- **é…ç½®æ–‡ä»¶**: `platforms/douyin/config.json`

### 2. å¹³å°å®ä¾‹ç»“æ„

```javascript
platformInstance = {
  config: {
    platform: 'douyin',
    displayName: 'æŠ–éŸ³',
    version: '1.0.0',
    capabilities: [...],
    urls: { ... }
  },
  bridge: workerBridge,
  browserManager: browserManager,
  accountSessions: Map<accountId, session>,
  accountContexts: Map<accountId, context>,
  // ... methods
}
```

### 3. `.get()` é”™è¯¯çš„å¯èƒ½æ¥æº

åŸºäºä»£ç ç»“æ„,`.get()` å¯èƒ½æ¥è‡ª:
- `this.accountSessions.get(accountId)`
- `this.accountContexts.get(accountId)`
- `browserManager` çš„æŸä¸ª Map
- `config.urls.get(...)` (å¦‚æœ urls æ˜¯ Map)

---

## âœ… éªŒè¯æ£€æŸ¥æ¸…å•

å½“æ‰€æœ‰é—®é¢˜ä¿®å¤å,éªŒè¯ä»¥ä¸‹æ¡ä»¶:

- [ ] Worker èƒ½ä»¥ `worker1` ID å¯åŠ¨
- [ ] Worker è¢«åˆ†é…åˆ°è´¦æˆ· `acc-98296c87-2e42-447a-9d8b-8be008ddb6e4`
- [ ] Worker æ¥æ”¶ç™»å½•è¯·æ±‚
- [ ] è°ƒç”¨ `startLogin()` æ—¶å‚æ•°æ­£ç¡®ä¼ é€’
- [ ] æµè§ˆå™¨æˆåŠŸæ‰“å¼€
- [ ] æ£€æµ‹åˆ°ç™»å½•æ–¹å¼ (äºŒç»´ç /çŸ­ä¿¡)
- [ ] Worker å‘é€ `qrcode_ready` çŠ¶æ€
- [ ] Master è½¬å‘çŠ¶æ€åˆ° Admin Web
- [ ] Admin Web æ˜¾ç¤ºäºŒç»´ç 
- [ ] æ‰«ç åæµè§ˆå™¨è·³è½¬åˆ°åˆ›ä½œä¸­å¿ƒ
- [ ] Worker å‘é€ `success` çŠ¶æ€
- [ ] Admin Web æ˜¾ç¤º"ç™»å½•æˆåŠŸ"

---

**æŠ¥å‘Šäºº**: Claude Code Assistant
**æœ€åæ›´æ–°**: 2025-10-24 11:39
**çŠ¶æ€**: è°ƒè¯•è¿›è¡Œä¸­ - éœ€è¦è§£å†³ç¯å¢ƒå˜é‡é—®é¢˜ä»¥ç»§ç»­è°ƒè¯•
