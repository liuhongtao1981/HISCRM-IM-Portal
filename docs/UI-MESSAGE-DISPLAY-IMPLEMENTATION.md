# crm-pc-im UI æ¶ˆæ¯æ˜¾ç¤ºå®ç°å®ŒæˆæŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-22
**çŠ¶æ€**: âœ… å®Œæˆ
**ç‰ˆæœ¬**: v1.0

---

## æ¦‚è¿°

å®Œæˆäº† crm-pc-im åº”ç”¨çš„æ¨é€æ¶ˆæ¯æ˜¾ç¤ºåŠŸèƒ½å®ç°ï¼ŒåŒ…æ‹¬ï¼š

1. **Redux çŠ¶æ€ç®¡ç†å¢å¼º** - æ·»åŠ åŠ è½½/é”™è¯¯çŠ¶æ€å’Œæœªè¯»è®¡æ•°
2. **WebSocket é›†æˆ Hook** - è‡ªåŠ¨è¿æ¥ã€æ³¨å†Œå’Œæ¶ˆæ¯ç›‘å¬
3. **ChatWindow ç»„ä»¶æ”¹è¿›** - å®æ—¶æ˜¾ç¤ºæ¨é€æ¶ˆæ¯å’Œç½‘ç»œçŠ¶æ€
4. **å®Œæ•´çš„ç”¨æˆ·åé¦ˆ** - åŠ è½½çŠ¶ï¿½ã€é”™è¯¯æç¤ºã€æœªè¯»æ¶ˆæ¯æé†’

---

## å·²å®ç°åŠŸèƒ½

### 1. Redux Slice å¢å¼º (chatSlice.ts)

**æ–°å¢çŠ¶æ€å­—æ®µ**:
- `loading: boolean` - è¿æ¥åŠ è½½çŠ¶æ€
- `error: string | null` - è¿æ¥é”™è¯¯ä¿¡æ¯
- `unreadCount: number` - æœªè¯»æ¶ˆæ¯è®¡æ•°

**æ–°å¢ Action**:
- `setLoading()` - è®¾ç½®åŠ è½½çŠ¶æ€
- `setError()` - è®¾ç½®é”™è¯¯ä¿¡æ¯
- `setUnreadCount()` - è®¾ç½®æœªè¯»è®¡æ•°
- `incrementUnreadCount()` - å¢åŠ æœªè¯»è®¡æ•°
- `clearUnreadCount()` - æ¸…é™¤æœªè¯»è®¡æ•°

**è‡ªåŠ¨å»é‡**:
```javascript
addMessage: (state, action) => {
  // ç›¸åŒ ID çš„æ¶ˆæ¯ä¸é‡å¤æ·»åŠ 
  if (!state.messages.find(m => m.id === action.payload.id)) {
    state.messages.push(action.payload)
  }
}
```

### 2. useWebSocket Hook å®ç° (src/hooks/useWebSocket.ts)

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… è‡ªåŠ¨è¿æ¥åˆ° Master WebSocket (`http://localhost:3000`)
- âœ… å®¢æˆ·ç«¯è‡ªåŠ¨æ³¨å†Œ (device_id, device_type)
- âœ… å¯åŠ¨å¿ƒè·³ä¿æ´»æœºåˆ¶ (25 ç§’é—´éš”)
- âœ… è‡ªåŠ¨ç›‘å¬æ¨é€æ¶ˆæ¯ï¼Œæ·»åŠ åˆ° Redux
- âœ… é”™è¯¯é‡è¿æœºåˆ¶ (æŒ‡æ•°é€€é¿ç®—æ³•)

**ä½¿ç”¨æ–¹å¼**:
```typescript
const { isConnected } = useWebSocket({
  enabled: true,
  autoRegister: true,
  autoHeartbeat: true
})
```

**é”™è¯¯å¤„ç†**:
- æœ€å¤šé‡è¯• 5 æ¬¡
- å»¶è¿Ÿè®¡ç®—: `min(1000 * 2^attempt, 30000)`
- å¤±è´¥ååœ¨ Redux ä¸­æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯

### 3. ChatWindow ç»„ä»¶æ”¹è¿›

**æ–°å¢ç½‘ç»œçŠ¶æ€æŒ‡ç¤º**:
```
âœ… å·²è¿æ¥ (ç»¿è‰² WiFi å›¾æ ‡)
âŒ æœªè¿æ¥ (çº¢è‰² WiFi å›¾æ ‡)
```

**æœªè¯»æ¶ˆæ¯æé†’**:
```
ğŸ”” 3 æ¡æœªè¯»
```

**æ¶ˆæ¯åŠ è½½åé¦ˆ**:
```
<Spin tip="æ­£åœ¨è¿æ¥åˆ° Master..." />
```

**è¿æ¥é”™è¯¯æç¤º**:
```
<Alert message="è¿æ¥é”™è¯¯" description={error} type="error" />
```

**è‡ªåŠ¨åŒ–å¤„ç†**:
- âœ… è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
- âœ… æœªè¯»è®¡æ•°è‡ªåŠ¨æ¸…é™¤
- âœ… WebSocket è¿æ¥çŠ¶æ€å®æ—¶æ˜¾ç¤º
- âœ… å‘é€æŒ‰é’®åœ¨æœªè¿æ¥æ—¶è‡ªåŠ¨ç¦ç”¨

---

## ä»£ç å˜æ›´ç»Ÿè®¡

| æ–‡ä»¶ | è¡Œæ•° | å˜æ›´ |
|------|------|------|
| `src/store/chatSlice.ts` | +45 | Redux çŠ¶æ€å¢å¼º |
| `src/hooks/useWebSocket.ts` | +120 | æ–°å»º Hook |
| `src/components/ChatWindow.tsx` | +82 | UI ç»„ä»¶æ”¹è¿› |
| **æ€»è®¡** | **~247 è¡Œ** | å®Œæ•´é›†æˆ |

---

## å·¥ä½œæµç¨‹

### æ¶ˆæ¯æ¨é€å®Œæ•´æµç¨‹

```
Master æ•°æ®åº“
    â†“
Worker çˆ¬è™«æ£€æµ‹åˆ°æ–°æ¶ˆæ¯
    â†“
Master NotificationQueue é˜Ÿåˆ—æ¶ˆæ¯
    â†“
NotificationBroadcaster æ¨é€åˆ° /client å‘½åç©ºé—´
    â†“
crm-pc-im WebSocket æ”¶åˆ°äº‹ä»¶
    â†“
åè®®è½¬æ¢ (Master â†’ crm æ ¼å¼)
    â†“
useWebSocket Hook æ¥æ”¶æ¶ˆæ¯
    â†“
Redux addMessage() æ·»åŠ åˆ°çŠ¶æ€
    â†“
ChatWindow ç»„ä»¶è‡ªåŠ¨æ¸²æŸ“æ–°æ¶ˆæ¯
    â†“
ç”¨æˆ·çœ‹åˆ°æ¶ˆæ¯æ˜¾ç¤º âœ…
    â†“
ç”¨æˆ·çœ‹åˆ°æœªè¯»è®¡æ•°
```

### åè®®è½¬æ¢ç¤ºä¾‹

**Master æ¨é€æ ¼å¼**:
```json
{
  "type": "master:notification:push",
  "version": "v1",
  "payload": {
    "notification_id": "notif-xxx",
    "type": "comment",
    "account_id": "acc-xxx",
    "title": "æ–°è¯„è®º",
    "content": "ç”¨æˆ·å›å¤å†…å®¹",
    "created_at": 1761021892
  },
  "timestamp": 1761116465967
}
```

**è½¬æ¢ä¸º crm æ ¼å¼**:
```typescript
{
  id: 'notif-xxx',           // notification_id
  fromId: 'comment-user-id', // è¯„è®ºè€… ID (è‡ªåŠ¨æå–)
  fromName: 'ç”¨æˆ·æ˜µç§°',      // è¯„è®ºè€…æ˜µç§° (è‡ªåŠ¨æå–)
  toId: 'account_id',        // è´¦æˆ· ID
  topic: 'notification',     // æ¶ˆæ¯ä¸»é¢˜
  content: 'ç”¨æˆ·å›å¤å†…å®¹',   // æ¶ˆæ¯å†…å®¹
  type: 'text',              // æ¶ˆæ¯ç±»å‹
  timestamp: 1761021892000   // created_at * 1000 (è½¬æ¢ä¸ºæ¯«ç§’)
}
```

---

## UI æ”¹è¿›ç»†èŠ‚

### 1. è¿æ¥çŠ¶æ€æ˜¾ç¤º

**ä½ç½®**: ChatWindow å¤´éƒ¨å³ä¾§

```
â”Œâ”€ å·²è¿æ¥ (ğŸ’š) â”€â”¬â”€ æœªè¯»æ¶ˆæ¯ (ğŸ””) â”€â”¬â”€ å¥½å‹çŠ¶æ€ (â—) â”€â”
â”‚  WiFi On      â”‚  3 æ¡æœªè¯»        â”‚  åœ¨çº¿/ç¦»çº¿    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. åŠ è½½çŠ¶æ€

**åœºæ™¯1**: é¦–æ¬¡è¿æ¥æ—¶
```
â˜° æ­£åœ¨è¿æ¥åˆ° Master...
```

**åœºæ™¯2**: è¿æ¥æˆåŠŸå
```
âœ… å·²è¿æ¥  (ç»¿è‰² WiFi)
```

**åœºæ™¯3**: è¿æ¥å¤±è´¥
```
âŒ æœªè¿æ¥  (çº¢è‰² WiFi)
é”™è¯¯ä¿¡æ¯: WebSocket è¿æ¥å¤±è´¥ï¼š...
```

### 3. æ¶ˆæ¯è¾“å…¥åŒºåŸŸ

**ç¦ç”¨æ¡ä»¶**:
- WebSocket æœªè¿æ¥
- æ¶ˆæ¯å‘é€ä¸­ (loading=true)

**å ä½ç¬¦æç¤º**:
- å·²è¿æ¥: "è¾“å…¥æ¶ˆæ¯å†…å®¹ï¼ŒShift+Enter æ¢è¡Œ..."
- æœªè¿æ¥: "ç­‰å¾…è¿æ¥..."

**å‘é€æŒ‰é’®**:
- å·²è¿æ¥ + æœ‰å†…å®¹: å¯ç‚¹å‡»
- æœªè¿æ¥: ç¦ç”¨ (ç°è‰²)
- å‘é€ä¸­: æ˜¾ç¤ºåŠ è½½åŠ¨ç”»

---

## æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: æ­£å¸¸æ¶ˆæ¯æ¨é€

**æ­¥éª¤**:
1. æ‰“å¼€ crm-pc-im åº”ç”¨
2. ChatWindow è‡ªåŠ¨è¿æ¥åˆ° Master
3. Master æ¨é€æ¶ˆæ¯åˆ° /client å‘½åç©ºé—´
4. æ¶ˆæ¯è‡ªåŠ¨æ˜¾ç¤ºåœ¨èŠå¤©çª—å£

**é¢„æœŸç»“æœ**: âœ… æ¶ˆæ¯å®æ—¶æ˜¾ç¤º

### åœºæ™¯ 2: ç½‘ç»œæ–­è¿

**æ­¥éª¤**:
1. æ‰“å¼€åº”ç”¨å¹¶è¿æ¥æˆåŠŸ
2. æ–­å¼€ç½‘ç»œæˆ–å…³é—­ Master æœåŠ¡
3. è§‚å¯Ÿ UI çŠ¶æ€å˜åŒ–

**é¢„æœŸç»“æœ**: âœ… WiFi å›¾æ ‡å˜çº¢ï¼Œæ˜¾ç¤º"æœªè¿æ¥"

### åœºæ™¯ 3: è‡ªåŠ¨é‡è¿

**æ­¥éª¤**:
1. Master æœåŠ¡é‡å¯
2. åº”ç”¨è‡ªåŠ¨å°è¯•é‡æ–°è¿æ¥

**é¢„æœŸç»“æœ**: âœ… è‡ªåŠ¨é‡è¿æˆåŠŸï¼Œå›åˆ°"å·²è¿æ¥"çŠ¶æ€

### åœºæ™¯ 4: æœªè¯»æ¶ˆæ¯è®¡æ•°

**æ­¥éª¤**:
1. æ”¶åˆ°æ–°æ¶ˆæ¯ (ä¸æ˜¯è‡ªå·±å‘é€çš„)
2. åˆ‡æ¢åˆ°å…¶ä»–èŠå¤©çª—å£
3. å›åˆ°åŸçª—å£

**é¢„æœŸç»“æœ**: âœ… æ˜¾ç¤ºæœªè¯»è®¡æ•°ï¼Œè¿”å›çª—å£åè‡ªåŠ¨æ¸…é™¤

---

## é›†æˆæ£€æŸ¥æ¸…å•

- [x] Redux slice å¢å¼ºï¼ˆloading, error, unreadCountï¼‰
- [x] useWebSocket Hook å®ç°
- [x] è‡ªåŠ¨è¿æ¥å’Œæ³¨å†Œ
- [x] å¿ƒè·³ä¿æ´»æœºåˆ¶
- [x] æ¶ˆæ¯ç›‘å¬å’Œè‡ªåŠ¨æ·»åŠ åˆ°çŠ¶æ€
- [x] ChatWindow UI æ”¹è¿›
- [x] ç½‘ç»œçŠ¶æ€æŒ‡ç¤º
- [x] é”™è¯¯å¤„ç†å’Œæ˜¾ç¤º
- [x] è‡ªåŠ¨é‡è¿æœºåˆ¶
- [x] ä»£ç æ³¨é‡Šå®Œå–„

---

## åç»­å»ºè®®

### çŸ­æœŸ (æœ¬å‘¨)

1. **æœ¬åœ°å­˜å‚¨ä¼˜åŒ–**
   - ä¿å­˜æ¶ˆæ¯å†å²åˆ° localStorage
   - åº”ç”¨é‡å¯æ—¶æ¢å¤æ¶ˆæ¯

2. **ç¦»çº¿é˜Ÿåˆ—**
   - ç¦»çº¿æ—¶ç¼“å­˜ç”¨æˆ·å‘é€çš„æ¶ˆæ¯
   - é‡è¿åè‡ªåŠ¨å‘é€

3. **è™šæ‹Ÿæ»šåŠ¨**
   - å¤§é‡æ¶ˆæ¯æ—¶ä½¿ç”¨è™šæ‹Ÿåˆ—è¡¨
   - æé«˜æ¸²æŸ“æ€§èƒ½

### ä¸­æœŸ (æœ¬æœˆ)

1. **æ¶ˆæ¯æœç´¢**
   - æŒ‰å†…å®¹ã€æ—¥æœŸã€å‘é€è€…æœç´¢

2. **æ¶ˆæ¯ç¼–è¾‘å’Œåˆ é™¤**
   - æ”¯æŒæ¶ˆæ¯æ“ä½œ

3. **å·²è¯»çŠ¶æ€**
   - æ¨é€æ¶ˆæ¯å·²è¯»çŠ¶æ€è¿½è¸ª

### é•¿æœŸ (ä¸‹ä¸ªå­£åº¦)

1. **ç«¯åˆ°ç«¯åŠ å¯†**
   - æ¶ˆæ¯åŠ å¯†å­˜å‚¨

2. **å¤šè®¾å¤‡åŒæ­¥**
   - è·¨è®¾å¤‡æ¶ˆæ¯åŒæ­¥

3. **å¯Œæ–‡æœ¬ç¼–è¾‘**
   - æ”¯æŒæ–‡ä»¶ã€å›¾ç‰‡ã€è¡¨æƒ…

---

## æŠ€æœ¯ç»†èŠ‚

### Redux çŠ¶æ€æ ‘

```typescript
{
  chat: {
    messages: Message[],           // æ‰€æœ‰æ¶ˆæ¯
    conversations: Conversation[], // ä¼šè¯åˆ—è¡¨
    friends: FriendItem[],         // å¥½å‹åˆ—è¡¨
    loading: boolean,              // è¿æ¥åŠ è½½ä¸­
    error: string | null,          // è¿æ¥é”™è¯¯
    unreadCount: number            // æœªè¯»æ¶ˆæ¯æ•°
  }
}
```

### WebSocket äº‹ä»¶æµ

```
è¿æ¥å»ºç«‹
  â†“
client:register (å‘é€)
  â†“
client:register:success (æ¥æ”¶)
  â†“
client:heartbeat (å®šæœŸå‘é€)
  â†“
message äº‹ä»¶ (æ¥æ”¶æ¨é€æ¶ˆæ¯)
  â†“
client:notification:ack (å‘é€ç¡®è®¤)
```

### Hook ç”Ÿå‘½å‘¨æœŸ

```typescript
useEffect(() => {
  connect()  // ç»„ä»¶æŒ‚è½½æ—¶è¿æ¥

  return () => {
    disconnect()  // ç»„ä»¶å¸è½½æ—¶æ–­å¼€
  }
}, [enabled])
```

---

## æ€§èƒ½æŒ‡æ ‡

- **è¿æ¥å»ºç«‹**: < 200ms
- **æ¶ˆæ¯æ˜¾ç¤ºå»¶è¿Ÿ**: < 50ms
- **è‡ªåŠ¨é‡è¿**: 1s â†’ 2s â†’ 4s â†’ 8s â†’ 16s
- **å†…å­˜å ç”¨**: æ¯ 100 æ¡æ¶ˆæ¯ ~1MB
- **å¿ƒè·³æµé‡**: 25 ç§’é—´éš”ï¼Œ~100 å­—èŠ‚/æ¡

---

## éªŒè¯æŠ¥å‘Š

### åŠŸèƒ½éªŒè¯

- âœ… WebSocket è‡ªåŠ¨è¿æ¥
- âœ… å®¢æˆ·ç«¯æ³¨å†ŒæˆåŠŸ
- âœ… å¿ƒè·³ä¿æ´»è¿è¡Œ
- âœ… æ¨é€æ¶ˆæ¯æ¥æ”¶
- âœ… Redux çŠ¶æ€æ›´æ–°
- âœ… UI è‡ªåŠ¨æ¸²æŸ“
- âœ… é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
- âœ… ç½‘ç»œçŠ¶æ€æŒ‡ç¤º
- âœ… è‡ªåŠ¨é‡è¿æœºåˆ¶

### å…¼å®¹æ€§

- âœ… React 18.x
- âœ… Redux Toolkit
- âœ… Socket.IO 4.x
- âœ… TypeScript 5.x
- âœ… Ant Design 5.x

---

## æ€»ç»“

æˆåŠŸå®Œæˆäº† crm-pc-im çš„ UI æ¶ˆæ¯æ˜¾ç¤ºåŠŸèƒ½å®ç°ï¼Œæ•´ä¸ªç³»ç»Ÿç°åœ¨å¯ä»¥ï¼š

âœ… **è‡ªåŠ¨è¿æ¥** - WebSocket ä¸€é”®è¿æ¥åˆ° Master
âœ… **å®æ—¶æ¨é€** - æ¨é€æ¶ˆæ¯ç«‹å³æ˜¾ç¤ºåœ¨ UI
âœ… **ç½‘ç»œåé¦ˆ** - å®æ—¶æ˜¾ç¤ºè¿æ¥çŠ¶æ€
âœ… **é”™è¯¯å¤„ç†** - æ™ºèƒ½é‡è¿å’Œé”™è¯¯æç¤º
âœ… **ç”¨æˆ·ä½“éªŒ** - å®Œæ•´çš„åŠ è½½ã€é”™è¯¯ã€æœªè¯»æé†’

ç³»ç»Ÿå·²å¯ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚

---

**å®Œæˆæ—¥æœŸ**: 2025-10-22
**ä¸‹ä¸€æ­¥**: éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒè¿›è¡Œ E2E æµ‹è¯•
