# 消息数据为零问题修复报告

**日期**: 2025-10-29
**问题**: DataManager 快照显示消息 (Messages) 为 0，但爬虫日志显示已抓取消息
**状态**: ✅ 已修复

---

## 问题描述

### 现象

在 DataManager 数据快照中观察到：

- ✅ 会话 (Conversations): 28 条 - 正常
- ✅ 评论 (Comments): 3 条 - 正常
- ❌ 消息 (Messages): **0 条** - 异常
- ❌ 视频/作品 (Contents): 0 条 - 待修复

### 爬虫日志证据

爬虫日志 `crawl-direct-messages-v2.log` 显示消息确实被抓取：

```json
{"level":"info","message":"[Phase 8] Conversation 派爱你: 2 messages","service":"crawl-direct-messages-v2","timestamp":"2025-10-29 14:21:26.384"}
{"level":"info","message":"[Phase 8] Conversation 时光对话: 2 messages","service":"crawl-direct-messages-v2","timestamp":"2025-10-29 14:21:33.599"}
{"level":"info","message":"[Phase 8] Conversation Tommy: 2 messages","service":"crawl-direct-messages-v2","timestamp":"2025-10-29 14:21:40.778"}
```

但 API 拦截日志只显示会话被发送到 DataManager：

```json
{"level":"info","message":"✅ [API] 会话列表 -> DataManager: 7 个会话","service":"crawl-direct-messages-v2","timestamp":"2025-10-29 14:21:30.542"}
{"level":"info","message":"✅ [API] 会话列表 -> DataManager: 20 个会话","service":"crawl-direct-messages-v2","timestamp":"2025-10-29 14:21:30.592"}
```

---

## 根本原因

### 代码分析

通过分析 `packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js` 发现：

#### 1. 消息来源：DOM 提取

消息通过 `crawlCompleteMessageHistory()` 函数从虚拟列表的 DOM/React Fiber 中提取：

```javascript
// 第 177 行
const messages = await crawlCompleteMessageHistory(page, conversation, account, apiData);

// 第 179 行
directMessages.push(...messages);

// 第 181 行
logger.info(`[Phase 8] Conversation ${conversation.platform_user_name}: ${messages.length} messages`);
```

#### 2. 关键问题：未发送到 DataManager

消息被抓取并存储在 `directMessages` 数组中，但是**从未调用 DataManager 的 `batchUpsertMessages()` 方法**将它们发送到 DataManager！

对比：
- ✅ 会话：通过 API 拦截回调 `onConversationListAPI()` 自动发送到 DataManager
- ✅ 评论：通过 API 拦截回调自动发送到 DataManager
- ❌ 消息：仅存储在本地数组，未调用 DataManager API

### 数据流对比

**正确流程（会话）**：
```
API 拦截 → onConversationListAPI() → dataManager.batchUpsertConversations() → 存储到 DataManager → 快照显示
```

**错误流程（消息）**：
```
DOM 提取 → directMessages.push() → 仅存储在局部变量 → ❌ 未发送到 DataManager → 快照显示 0
```

---

## 修复方案

### 修改位置

文件：`packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js`
位置：第 183-203 行（在消息抓取后）

### 修复前代码

```javascript
// 加载完整消息历史 (分页加载)
const messages = await crawlCompleteMessageHistory(page, conversation, account, apiData);

directMessages.push(...messages);

logger.info(`[Phase 8] Conversation ${conversation.platform_user_name}: ${messages.length} messages`);

// 返回会话列表 - 改进的返回逻辑
await returnToConversationList(page);
```

### 修复后代码

```javascript
// 加载完整消息历史 (分页加载)
const messages = await crawlCompleteMessageHistory(page, conversation, account, apiData);

directMessages.push(...messages);

logger.info(`[Phase 8] Conversation ${conversation.platform_user_name}: ${messages.length} messages`);

// ✅ 将 DOM 提取的消息发送到 DataManager
if (dataManager && messages.length > 0) {
  try {
    // 转换 DOM 格式到 DataManager 期望的格式
    const formattedMessages = messages.map(msg => ({
      message_id: msg.platform_message_id,
      conversation_id: msg.conversation_id,
      sender_id: msg.platform_sender_id || 'unknown',
      sender_name: 'Unknown', // DOM 不包含发送者名称
      content: msg.content,
      type: msg.message_type || 'text',
      direction: msg.direction || 'incoming',
      created_at: msg.timestamp,
    }));

    const upsertedMessages = dataManager.batchUpsertMessages(formattedMessages, DataSource.DOM);
    logger.info(`✅ [DOM] 会话消息 -> DataManager: ${upsertedMessages.length} 条 (会话: ${conversation.platform_user_name})`);
  } catch (error) {
    logger.error(`[DOM] 消息入库失败 (会话: ${conversation.platform_user_name}):`, error);
  }
}

// 返回会话列表 - 改进的返回逻辑
await returnToConversationList(page);
```

### 核心改进

1. **添加 DataManager 调用**：在每个会话的消息抓取完成后，立即调用 `dataManager.batchUpsertMessages()`
2. **数据格式转换**：DOM 提取的字段名（`platform_message_id`）转换为 DataManager 期望的字段名（`message_id`）
3. **错误处理**：添加 try-catch 防止单个会话失败影响整体流程
4. **详细日志**：记录每个会话的消息入库情况

---

## 验证结果

### 修复前

```
消息 (Messages): 总计 0 条
```

### 修复后

```
消息 (Messages): 总计 42 条
```

### 日志验证

修复后的爬虫日志显示消息成功入库：

```json
{"level":"info","message":"✅ [DOM] 会话消息 -> DataManager: 2 条 (会话: 派爱你)","service":"crawl-direct-messages-v2","timestamp":"2025-10-29 14:36:43.721"}
{"level":"info","message":"✅ [DOM] 会话消息 -> DataManager: 2 条 (会话: 时光对话)","service":"crawl-direct-messages-v2","timestamp":"2025-10-29 14:36:50.881"}
{"level":"info","message":"✅ [DOM] 会话消息 -> DataManager: 2 条 (会话: Tommy)","service":"crawl-direct-messages-v2","timestamp":"2025-10-29 14:36:58.048"}
{"level":"info","message":"✅ [DOM] 会话消息 -> DataManager: 3 条 (会话: 巨贾)","service":"crawl-direct-messages-v2","timestamp":"2025-10-29 14:37:12.431"}
```

### 消息内容验证

DataManager 快照显示真实消息内容：

```
💌 最近消息:
  1. ➡️ Unknown: 我们已互相关注，可以开始聊天了
  2. ➡️ Unknown: 在哪里呀，怎么样费
  3. ➡️ Unknown: 您好，您是想了解临终关怀吗？可以给您详细介绍下，留个方式我+您
  4. ➡️ Unknown: 13009802922
  5. ➡️ Unknown: 加微信吧
  6. ➡️ Unknown: 好的，稍后加您
  7. ➡️ Unknown: 亲，加了吗
```

---

## 技术要点

### 1. 数据来源差异

| 数据类型 | 来源方式 | 发送方式 |
|---------|---------|---------|
| 会话 | API 拦截 | 自动 (onConversationListAPI) |
| 评论 | API 拦截 | 自动 (onCommentListAPI) |
| 消息 | DOM 提取 | **手动** (需显式调用) |
| 视频/作品 | API 拦截 | 自动 (onContentListAPI) |

### 2. DOM 数据格式映射

DOM 提取的字段需要映射到 DataManager 期望的格式：

| DOM 字段 | DataManager 字段 | 说明 |
|---------|-----------------|------|
| `platform_message_id` | `message_id` | 消息唯一标识 |
| `conversation_id` | `conversation_id` | 会话 ID |
| `platform_sender_id` | `sender_id` | 发送者 ID |
| `content` | `content` | 消息内容 |
| `message_type` | `type` | 消息类型 |
| `timestamp` | `created_at` | 创建时间 |

### 3. DataManager 映射逻辑

DouyinDataManager 的 `mapMessageData()` 方法处理数据映射：

```javascript
mapMessageData(douyinData) {
  return {
    messageId: String(douyinData.message_id || douyinData.msg_id || `msg_${Date.now()}`),
    conversationId: String(douyinData.conversation_id),
    senderId: String(douyinData.sender_id || douyinData.from_user_id),
    senderName: douyinData.sender_name || douyinData.from_nickname || 'Unknown',
    content: douyinData.content || douyinData.text || '',
    type: this.mapMessageType(douyinData.type || douyinData.msg_type),
    direction: douyinData.direction || 'incoming',
    createdAt: douyinData.created_at || douyinData.create_time || Date.now(),
    // ...
  };
}
```

---

## 未来改进

### 1. 视频/作品数据

目前 Contents 仍然为 0，需要检查类似的问题：
- 是否有视频抓取逻辑？
- 是否调用了 DataManager 的 `batchUpsertContents()`？

### 2. 统一数据流

建议将所有数据类型（包括 DOM 提取的）统一通过回调机制发送到 DataManager，避免遗漏：

```javascript
// 建议架构
class DataCollector {
  onConversation(data) { this.dataManager.batchUpsertConversations(data); }
  onMessage(data) { this.dataManager.batchUpsertMessages(data); }
  onComment(data) { this.dataManager.batchUpsertComments(data); }
  onContent(data) { this.dataManager.batchUpsertContents(data); }
}
```

### 3. 数据完整性验证

添加爬虫结束时的数据一致性检查：

```javascript
// 验证抓取的数据是否都入库
const scraped = { conversations: 28, messages: 42, comments: 3 };
const stored = dataManager.getStats().collections;

if (scraped.messages !== stored.messages.total) {
  logger.warn(`消息数量不一致: 抓取 ${scraped.messages}, 入库 ${stored.messages.total}`);
}
```

---

## 相关文档

- [DataManager 数据快照功能完整指南](./DataManager数据快照功能完整指南.md)
- [DataManager 数据快照-快速参考](./DataManager数据快照-快速参考.md)
- [05-DOUYIN-平台实现技术细节](./05-DOUYIN-平台实现技术细节.md)
- [06-WORKER-爬虫调试指南](./06-WORKER-爬虫调试指南.md)

---

## 总结

这次修复揭示了一个关键的架构问题：

**API 拦截的数据自动入库，但 DOM 提取的数据需要手动调用 DataManager API**

修复方法：
1. 识别所有 DOM 提取的数据源
2. 在数据抓取完成后立即调用 DataManager 的对应方法
3. 添加格式转换和错误处理

修复效果：
- ✅ 消息数据从 0 增加到 42 条
- ✅ 真实消息内容正确显示
- ✅ 中文、表情符号编码正确
- ✅ 每个会话的消息入库日志完整

---

**维护者**: Claude Code
**版本**: v1.0
**最后更新**: 2025-10-29
