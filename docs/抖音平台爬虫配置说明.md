# 抖音平台爬虫配置说明

**配置文件**: `packages/worker/src/platforms/douyin/config.json`

## 概述

配置文件集中管理抖音平台的所有爬虫任务配置，包括评论爬虫、私信爬虫和API爬虫。通过调整配置可以灵活控制各个爬虫的行为。

## 配置结构

### 1. 平台基础信息

```json
{
  "platform": "douyin",
  "displayName": "抖音",
  "version": "1.0.0"
}
```

- **platform**: 平台标识符
- **displayName**: 平台显示名称
- **version**: 配置文件版本

### 2. 爬虫配置 (`crawlers`)

#### 2.1 评论爬虫 (`commentCrawler`)

**说明**: 通过浏览器自动化抓取评论数据

```json
{
  "commentCrawler": {
    "enabled": true,
    "description": "评论爬虫 - 通过浏览器自动化抓取评论数据",
    "interval": {
      "min": 15,
      "max": 30,
      "unit": "seconds"
    }
  }
}
```

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `enabled` | boolean | true | 是否启用评论爬虫 |
| `interval.min` | number | 15 | 随机间隔最小值（秒） |
| `interval.max` | number | 30 | 随机间隔最大值（秒） |

**工作原理**:
- 打开浏览器访问评论管理页面
- 使用 React Fiber 技术提取评论数据
- 随机间隔执行，避免平台检测

#### 2.2 私信爬虫 (`dmCrawler`)

**说明**: 通过浏览器自动化抓取私信数据

```json
{
  "dmCrawler": {
    "enabled": true,
    "description": "私信爬虫 - 通过浏览器自动化抓取私信数据",
    "interval": {
      "min": 15,
      "max": 30,
      "unit": "seconds"
    }
  }
}
```

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `enabled` | boolean | true | 是否启用私信爬虫 |
| `interval.min` | number | 15 | 随机间隔最小值（秒） |
| `interval.max` | number | 30 | 随机间隔最大值（秒） |

**工作原理**:
- 打开浏览器访问私信管理页面
- 使用 React Fiber 技术提取私信数据
- 支持虚拟列表滚动加载

#### 2.3 API爬虫 (`apiCrawler`)

**说明**: 定时自动抓取作品、评论和二级评论，无需打开浏览器窗口

```json
{
  "apiCrawler": {
    "enabled": true,
    "autoStart": true,
    "interval": 30,
    "description": "API爬虫 - 定时自动抓取作品、评论和二级评论，无需打开浏览器窗口"
  }
}
```

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `enabled` | boolean | true | 是否启用 API 爬虫 |
| `autoStart` | boolean | true | 是否自动启动 |
| `interval` | number | 30 | 执行间隔（秒），测试环境30秒，生产环境建议300秒 |

##### 2.3.1 作品抓取配置 (`works`)

```json
{
  "works": {
    "pageSize": 50,
    "maxPages": 9999,
    "description": "作品抓取配置：9999表示不限制，抓取所有"
  }
}
```

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `pageSize` | number | 50 | 每页作品数量 |
| `maxPages` | number | 9999 | 最多抓取页数（9999 = 不限制） |

##### 2.3.2 评论抓取配置 (`comments`)

```json
{
  "comments": {
    "enabled": true,
    "pageSize": 20,
    "maxPages": 9999,
    "maxComments": 999999,
    "description": "评论抓取配置：9999表示不限制，抓取所有"
  }
}
```

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `enabled` | boolean | true | 是否抓取评论 |
| `pageSize` | number | 20 | 每页评论数量 |
| `maxPages` | number | 9999 | 每个作品最多抓取页数（9999 = 不限制） |
| `maxComments` | number | 999999 | 每个作品最多抓取评论数（999999 = 不限制） |

##### 2.3.3 二级评论抓取配置 (`replies`)

```json
{
  "replies": {
    "enabled": true,
    "pageSize": 20,
    "maxPages": 9999,
    "maxReplies": 999999,
    "description": "二级评论抓取配置：9999表示不限制，抓取所有"
  }
}
```

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `enabled` | boolean | true | 是否抓取二级评论 |
| `pageSize` | number | 20 | 每页二级评论数量 |
| `maxPages` | number | 9999 | 每个一级评论最多抓取页数（9999 = 不限制） |
| `maxReplies` | number | 999999 | 每个一级评论最多抓取数量（999999 = 不限制） |

##### 2.3.4 延迟配置 (`delays`)

```json
{
  "delays": {
    "betweenWorks": 500,
    "betweenCommentPages": 300,
    "betweenReplies": 200,
    "unit": "milliseconds",
    "description": "延迟配置（防止触发限流）：测试环境用较小值，生产环境建议增加"
  }
}
```

| 参数 | 类型 | 默认值 | 生产环境建议值 | 说明 |
|------|------|--------|--------------|------|
| `betweenWorks` | number | 500 | 2000 | 作品之间的延迟（毫秒） |
| `betweenCommentPages` | number | 300 | 1000 | 评论分页之间的延迟（毫秒） |
| `betweenReplies` | number | 200 | 500 | 二级评论之间的延迟（毫秒） |

## 使用场景

### 场景1: 仅使用API爬虫（推荐）

最高效的方式，无需打开浏览器窗口：

```json
{
  "crawlers": {
    "commentCrawler": { "enabled": false },
    "dmCrawler": { "enabled": false },
    "apiCrawler": { "enabled": true, "autoStart": true }
  }
}
```

### 场景2: 仅使用浏览器爬虫

适合需要验证界面显示的场景：

```json
{
  "crawlers": {
    "commentCrawler": { "enabled": true },
    "dmCrawler": { "enabled": true },
    "apiCrawler": { "enabled": false }
  }
}
```

### 场景3: 混合模式

API爬虫负责作品和评论，浏览器爬虫负责私信：

```json
{
  "crawlers": {
    "commentCrawler": { "enabled": false },
    "dmCrawler": { "enabled": true },
    "apiCrawler": {
      "enabled": true,
      "comments": { "enabled": true },
      "replies": { "enabled": true }
    }
  }
}
```

### 场景4: 生产环境配置

增加延迟，减少触发限流风险：

```json
{
  "crawlers": {
    "apiCrawler": {
      "enabled": true,
      "interval": 300,
      "delays": {
        "betweenWorks": 2000,
        "betweenCommentPages": 1000,
        "betweenReplies": 500
      }
    }
  }
}
```

### 场景5: 测试环境快速验证

使用小范围抓取和短间隔：

```json
{
  "crawlers": {
    "apiCrawler": {
      "enabled": true,
      "interval": 30,
      "works": { "maxPages": 1 },
      "comments": { "maxPages": 2, "maxComments": 20 },
      "replies": { "maxPages": 1, "maxReplies": 5 }
    }
  }
}
```

## 配置加载方式

代码中读取配置：

```javascript
const config = require('./config.json');

// 检查 API 爬虫是否启用
if (config.crawlers.apiCrawler.enabled) {
  const interval = config.crawlers.apiCrawler.interval;
  const pageSize = config.crawlers.apiCrawler.works.pageSize;
  // ...
}

// 检查评论爬虫是否启用
if (config.crawlers.commentCrawler.enabled) {
  const minInterval = config.crawlers.commentCrawler.interval.min;
  const maxInterval = config.crawlers.commentCrawler.interval.max;
  // ...
}
```

## 注意事项

### 1. 防止触发限流

- **测试环境**: 使用较小的延迟值进行快速验证
- **生产环境**: 必须增加延迟值（建议值见上表）
- **监控**: 定期检查日志，如果出现429错误或验证码，立即增加延迟

### 2. 资源消耗

- **API爬虫**: 几乎不消耗资源，推荐优先使用
- **浏览器爬虫**: 每个账户约消耗 200MB 内存，限制并发数量

### 3. 数据完整性

- `maxPages` 和 `maxComments` 设置为 9999 可以抓取所有数据
- 如果只需要最新数据，可以设置较小的值（如 `maxPages: 1`）

### 4. 配置优先级

配置文件 > 环境变量 > 默认值

如果需要临时覆盖配置，可以使用环境变量（兼容旧版）：
```bash
export API_CRAWLER_ENABLED=false
export API_CRAWLER_INTERVAL=60
```

## 迁移说明

### 从环境变量迁移到配置文件

**旧方式** (`.env` 文件):
```bash
API_CRAWLER_ENABLED=true
API_CRAWLER_INTERVAL=30
API_CRAWLER_WORKS_PAGE_SIZE=50
```

**新方式** (`config.json`):
```json
{
  "crawlers": {
    "apiCrawler": {
      "enabled": true,
      "interval": 30,
      "works": { "pageSize": 50 }
    }
  }
}
```

**优点**:
- ✅ 结构化配置，更易维护
- ✅ 支持嵌套配置和注释
- ✅ 类型安全（JSON Schema 验证）
- ✅ 可以为不同平台定制配置

## 相关文档

- [API爬虫使用指南](./API爬虫使用指南.md)
- [API爬虫完整实现总结](./API爬虫完整实现总结.md)
- [抖音平台实现技术细节](./05-DOUYIN-平台实现技术细节.md)
