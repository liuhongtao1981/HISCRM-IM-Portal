# 301 重定向和 API 数据结构问题 - 最终修复报告

**日期**: 2025-10-30
**问题**: 评论 API 拦截失败，导致 comments 数据始终为 0

## 问题根因分析

### 问题 1: 301 重定向导致 API 拦截失败

**症状**:
- API 拦截器日志显示拦截器已启用
- 但评论 API 从未被捕获
- `crawl-comments.log` 显示 "No API response found"

**根本原因**:
旧的 `APIInterceptorManager` 使用 `page.route()` + `route.fetch()` 进行拦截。当抖音服务器返回 301/302 重定向时：

```javascript
// 旧实现（有问题）
await this.page.route(pattern, async (route) => {
  const response = await route.fetch(); // 只能拦截第一个请求
  // 如果是 301，重定向后的请求不会被拦截
});
```

**抖音 API 的重定向行为**:
```
请求: /aweme/v1/creator/item/list?cursor=
响应: 301 Redirect
Location: /aweme/v1/creator/item/list/?cursor=  (末尾多了斜杠)
```

Playwright 的 `route` 拦截器只匹配初始请求，重定向后的请求不会再次触发拦截器。

### 问题 2: API 数据结构不匹配

**发现过程**:
用户提供的 HAR 抓包文件（`tests/creator.douyin.com.har`）揭示了真实的 API 数据结构。

**旧代码（错误）**:
```javascript
if (!body || !body.comment_info_list || !Array.isArray(body.comment_info_list)) {
  return;
}
```

**真实 API 数据结构**:
```json
{
  "status_code": 0,
  "comments": [
    {
      "cid": "7559344688533521203",
      "text": "互关思",
      "aweme_id": "7559103030453407030",
      "create_time": 1760047094,
      "user": { ... }
    }
  ],
  "cursor": 10,
  "has_more": true,
  "total": 22
}
```

**关键差异**:
- 字段名是 `comments`，不是 `comment_info_list`
- 评论 ID 字段是 `cid`，不是 `comment_id`

### 问题 3: API 回调函数签名不匹配

**根本原因**:
新的 `APIInterceptorManager` 使用 `page.on('response')` 事件，回调函数签名从 `(body, route)` 变为 `(body, response)`。

**旧代码（错误）**:
```javascript
async function onCommentsListAPI(body, route) {
  const url = route.request().url(); // ❌ response 对象没有 request() 方法
}
```

**新代码（正确）**:
```javascript
async function onCommentsListAPI(body, response) {
  const url = response.url(); // ✅ 直接调用 url()
}
```

## 修复方案

### 修复 1: 重写 API 拦截器架构

**文件**: `packages/worker/src/platforms/base/api-interceptor-manager.js`

**核心改进**:

1. **使用 `page.on('response')` 代替 `page.route()`**
   - 能捕获所有响应，包括重定向后的响应
   - 不干扰请求流程，避免 `route.fulfill()` 的性能问题

2. **添加重定向追踪**
   ```javascript
   // 记录重定向
   if (status === 301 || status === 302) {
     const location = response.headers()['location'];
     this.redirectTracker.set(url, (this.redirectTracker.get(url) || 0) + 1);
     logger.info(`🔄 [301/302] ${url} -> ${location}`);
     return; // 不处理重定向本身，只处理最终响应
   }
   ```

3. **使用 minimatch 进行 glob 模式匹配**
   ```javascript
   const minimatch = require('minimatch');

   for (const [pattern, handlers] of this.handlers.entries()) {
     if (minimatch(url, pattern)) {
       // 处理匹配的响应
     }
   }
   ```

**完整实现**:
```javascript
class APIInterceptorManager {
  async enable() {
    this.responseListener = async (response) => {
      try {
        const url = response.url();
        const status = response.status();

        // 记录重定向
        if (status === 301 || status === 302) {
          const location = response.headers()['location'];
          this.redirectTracker.set(url, (this.redirectTracker.get(url) || 0) + 1);
          logger.info(`🔄 [301/302] ${url} -> ${location}`);
          return; // 不处理重定向本身，只处理最终响应
        }

        // 检查是否匹配任何注册的模式
        for (const [pattern, handlers] of this.handlers.entries()) {
          if (minimatch(url, pattern)) {
            logger.info(`✅ [MATCH] ${pattern} -> ${url.substring(0, 100)}...`);

            const body = await this.parseJSON(response);

            // 调用所有注册的处理器
            for (const handler of handlers) {
              try {
                await handler(body, response);
              } catch (error) {
                logger.error(`Handler failed for ${pattern}:`, error);
              }
            }
          }
        }
      } catch (error) {
        logger.error(`Response listener error:`, error);
      }
    };

    this.page.on('response', this.responseListener);
    logger.info(`Enabled ${this.handlers.size} API patterns (using response event)`);
  }
}
```

### 修复 2: 更新 API 数据结构处理

**文件**: `packages/worker/src/platforms/douyin/crawl-comments.js`

**修复 1 - 评论列表 API**:
```javascript
async function onCommentsListAPI(body, response) {
  // ✅ 修正：检查 comments 字段（真实 API 数据结构）
  if (!body || !body.comments || !Array.isArray(body.comments)) {
    logger.warn(`⚠️  [API] 评论列表响应无效（无 comments 字段），body keys: ${body ? Object.keys(body).join(', ') : 'null'}`);
    return;
  }

  const url = response.url();
  logger.info(`🎯 [API] 评论列表 API 触发：${body.comments.length} 条评论`);

  // ✅ 使用 DataManager（新架构）
  if (globalContext.dataManager && body.comments.length > 0) {
    const comments = globalContext.dataManager.batchUpsertComments(
      body.comments,  // 不是 comment_info_list
      DataSource.API
    );
    logger.info(`✅ [API] 评论列表 -> DataManager: ${comments.length} 条评论`);
  }
}
```

**修复 2 - 回复列表 API**:
```javascript
async function onDiscussionsListAPI(body, response) {
  // ✅ 修正：检查 comments 字段（真实 API 数据结构）
  if (!body || !body.comments || !Array.isArray(body.comments)) {
    logger.warn(`⚠️  [API] 讨论列表响应无效（无 comments 字段），body keys: ${body ? Object.keys(body).join(', ') : 'null'}`);
    return;
  }

  const url = response.url();
  logger.info(`🎯 [API] 讨论列表 API 触发：${body.comments.length} 条讨论`);

  // ✅ 使用 DataManager（新架构）
  if (globalContext.dataManager && body.comments.length > 0) {
    const discussions = globalContext.dataManager.batchUpsertComments(
      body.comments,
      DataSource.API
    );
    logger.info(`✅ [API] 讨论列表 -> DataManager: ${discussions.length} 条讨论`);
  }
}
```

### 修复 3: 更新回调函数签名

**文件**: `packages/worker/src/platforms/douyin/crawl-contents.js`

```javascript
// 旧签名（错误）
async function onWorksListAPI(body, route) {
  const url = route.request().url();
}

// 新签名（正确）
async function onWorksListAPI(body, response) {
  const url = response.url();
}
```

## 验证结果

### 成功捕获 301 重定向

**日志证据** (`packages/worker/logs/api-interceptor.log`):
```json
{"level":"info","message":"🔄 [301/302] https://creator.douyin.com/aweme/v1/creator/item/list?cursor=... -> /aweme/v1/creator/item/list/?cursor=..."}
```

### 成功拦截评论 API

**日志证据**:
```json
{"level":"info","message":"✅ [MATCH] **/comment/list/select/** -> https://creator.douyin.com/web/api/third_party/aweme/api/comment/read/aweme/v1/web/comment/list/sele..."}
```

总共拦截了 **5 次评论 API 请求**。

### 成功拦截作品 API

**日志证据** (`packages/worker/logs/crawl-contents.log`):
```json
{"level":"info","message":"🎯 [API] 作品列表 API 被触发！URL: https://creator.douyin.com/aweme/v1/creator/item/list/?cursor=..."}
{"level":"info","message":"📦 [API] 作品列表包含 20 个作品"}
{"level":"info","message":"✅ [API] 作品列表 -> DataManager: 20 个作品"}
```

## 技术总结

### API 拦截的三种方法对比

| 方法 | 优点 | 缺点 | 是否支持重定向 |
|------|------|------|----------------|
| `page.route()` | 可修改请求/响应 | 性能开销大，不捕获重定向后的响应 | ❌ |
| `page.on('request')` | 轻量级 | 无法获取响应体 | ❌ |
| `page.on('response')` ✅ | 轻量级，捕获所有响应，包括重定向后的 | 无法修改响应（但我们不需要） | ✅ |

### 抖音 API 特性

1. **301 重定向**
   - 所有 API 都有 301 重定向
   - 重定向是为了规范化 URL（添加末尾斜杠）

2. **数据结构**
   - 字段名：`comments` (不是 `comment_info_list`)
   - 评论 ID：`cid` (不是 `comment_id`)
   - 嵌套结构：`user` 对象包含完整的用户信息

3. **API 端点模式**
   ```
   评论列表: /web/api/third_party/aweme/api/comment/read/aweme/v1/web/comment/list/select/
   回复列表: /web/api/third_party/aweme/api/comment/read/aweme/v1/web/comment/list/reply/
   作品列表: /aweme/v1/creator/item/list/
   ```

## 相关文件

- ✅ `packages/worker/src/platforms/base/api-interceptor-manager.js` - 重写
- ✅ `packages/worker/src/platforms/douyin/crawl-comments.js` - 修复数据结构和签名
- ✅ `packages/worker/src/platforms/douyin/crawl-contents.js` - 修复签名
- ✅ `tests/测试301重定向拦截.js` - 新增测试脚本

## 下一步验证

1. 停止当前 Worker 进程
2. 清理日志文件
3. 重启 Master 和 Worker
4. 等待 60 秒让爬虫运行
5. 检查 `data-manager.log` 确认评论数据成功入库

**预期结果**:
```
✅ comments: 22+
✅ discussions: 10+
✅ contents: 20
```
