# 301 é‡å®šå‘å’Œ API æ•°æ®ç»“æ„é—®é¢˜ - æœ€ç»ˆä¿®å¤æŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-30
**é—®é¢˜**: è¯„è®º API æ‹¦æˆªå¤±è´¥ï¼Œå¯¼è‡´ comments æ•°æ®å§‹ç»ˆä¸º 0

## é—®é¢˜æ ¹å› åˆ†æ

### é—®é¢˜ 1: 301 é‡å®šå‘å¯¼è‡´ API æ‹¦æˆªå¤±è´¥

**ç—‡çŠ¶**:
- API æ‹¦æˆªå™¨æ—¥å¿—æ˜¾ç¤ºæ‹¦æˆªå™¨å·²å¯ç”¨
- ä½†è¯„è®º API ä»æœªè¢«æ•è·
- `crawl-comments.log` æ˜¾ç¤º "No API response found"

**æ ¹æœ¬åŸå› **:
æ—§çš„ `APIInterceptorManager` ä½¿ç”¨ `page.route()` + `route.fetch()` è¿›è¡Œæ‹¦æˆªã€‚å½“æŠ–éŸ³æœåŠ¡å™¨è¿”å› 301/302 é‡å®šå‘æ—¶ï¼š

```javascript
// æ—§å®ç°ï¼ˆæœ‰é—®é¢˜ï¼‰
await this.page.route(pattern, async (route) => {
  const response = await route.fetch(); // åªèƒ½æ‹¦æˆªç¬¬ä¸€ä¸ªè¯·æ±‚
  // å¦‚æœæ˜¯ 301ï¼Œé‡å®šå‘åçš„è¯·æ±‚ä¸ä¼šè¢«æ‹¦æˆª
});
```

**æŠ–éŸ³ API çš„é‡å®šå‘è¡Œä¸º**:
```
è¯·æ±‚: /aweme/v1/creator/item/list?cursor=
å“åº”: 301 Redirect
Location: /aweme/v1/creator/item/list/?cursor=  (æœ«å°¾å¤šäº†æ–œæ )
```

Playwright çš„ `route` æ‹¦æˆªå™¨åªåŒ¹é…åˆå§‹è¯·æ±‚ï¼Œé‡å®šå‘åçš„è¯·æ±‚ä¸ä¼šå†æ¬¡è§¦å‘æ‹¦æˆªå™¨ã€‚

### é—®é¢˜ 2: API æ•°æ®ç»“æ„ä¸åŒ¹é…

**å‘ç°è¿‡ç¨‹**:
ç”¨æˆ·æä¾›çš„ HAR æŠ“åŒ…æ–‡ä»¶ï¼ˆ`tests/creator.douyin.com.har`ï¼‰æ­ç¤ºäº†çœŸå®çš„ API æ•°æ®ç»“æ„ã€‚

**æ—§ä»£ç ï¼ˆé”™è¯¯ï¼‰**:
```javascript
if (!body || !body.comment_info_list || !Array.isArray(body.comment_info_list)) {
  return;
}
```

**çœŸå® API æ•°æ®ç»“æ„**:
```json
{
  "status_code": 0,
  "comments": [
    {
      "cid": "7559344688533521203",
      "text": "äº’å…³æ€",
      "aweme_id": "7559103030453407030",
      "create_time": 1760047094,
      "user": { ... }
    }
  ],
  "cursor": 10,
  "has_more": true,
  "total": 22
}
```

**å…³é”®å·®å¼‚**:
- å­—æ®µåæ˜¯ `comments`ï¼Œä¸æ˜¯ `comment_info_list`
- è¯„è®º ID å­—æ®µæ˜¯ `cid`ï¼Œä¸æ˜¯ `comment_id`

### é—®é¢˜ 3: API å›è°ƒå‡½æ•°ç­¾åä¸åŒ¹é…

**æ ¹æœ¬åŸå› **:
æ–°çš„ `APIInterceptorManager` ä½¿ç”¨ `page.on('response')` äº‹ä»¶ï¼Œå›è°ƒå‡½æ•°ç­¾åä» `(body, route)` å˜ä¸º `(body, response)`ã€‚

**æ—§ä»£ç ï¼ˆé”™è¯¯ï¼‰**:
```javascript
async function onCommentsListAPI(body, route) {
  const url = route.request().url(); // âŒ response å¯¹è±¡æ²¡æœ‰ request() æ–¹æ³•
}
```

**æ–°ä»£ç ï¼ˆæ­£ç¡®ï¼‰**:
```javascript
async function onCommentsListAPI(body, response) {
  const url = response.url(); // âœ… ç›´æ¥è°ƒç”¨ url()
}
```

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1: é‡å†™ API æ‹¦æˆªå™¨æ¶æ„

**æ–‡ä»¶**: `packages/worker/src/platforms/base/api-interceptor-manager.js`

**æ ¸å¿ƒæ”¹è¿›**:

1. **ä½¿ç”¨ `page.on('response')` ä»£æ›¿ `page.route()`**
   - èƒ½æ•è·æ‰€æœ‰å“åº”ï¼ŒåŒ…æ‹¬é‡å®šå‘åçš„å“åº”
   - ä¸å¹²æ‰°è¯·æ±‚æµç¨‹ï¼Œé¿å… `route.fulfill()` çš„æ€§èƒ½é—®é¢˜

2. **æ·»åŠ é‡å®šå‘è¿½è¸ª**
   ```javascript
   // è®°å½•é‡å®šå‘
   if (status === 301 || status === 302) {
     const location = response.headers()['location'];
     this.redirectTracker.set(url, (this.redirectTracker.get(url) || 0) + 1);
     logger.info(`ğŸ”„ [301/302] ${url} -> ${location}`);
     return; // ä¸å¤„ç†é‡å®šå‘æœ¬èº«ï¼Œåªå¤„ç†æœ€ç»ˆå“åº”
   }
   ```

3. **ä½¿ç”¨ minimatch è¿›è¡Œ glob æ¨¡å¼åŒ¹é…**
   ```javascript
   const minimatch = require('minimatch');

   for (const [pattern, handlers] of this.handlers.entries()) {
     if (minimatch(url, pattern)) {
       // å¤„ç†åŒ¹é…çš„å“åº”
     }
   }
   ```

**å®Œæ•´å®ç°**:
```javascript
class APIInterceptorManager {
  async enable() {
    this.responseListener = async (response) => {
      try {
        const url = response.url();
        const status = response.status();

        // è®°å½•é‡å®šå‘
        if (status === 301 || status === 302) {
          const location = response.headers()['location'];
          this.redirectTracker.set(url, (this.redirectTracker.get(url) || 0) + 1);
          logger.info(`ğŸ”„ [301/302] ${url} -> ${location}`);
          return; // ä¸å¤„ç†é‡å®šå‘æœ¬èº«ï¼Œåªå¤„ç†æœ€ç»ˆå“åº”
        }

        // æ£€æŸ¥æ˜¯å¦åŒ¹é…ä»»ä½•æ³¨å†Œçš„æ¨¡å¼
        for (const [pattern, handlers] of this.handlers.entries()) {
          if (minimatch(url, pattern)) {
            logger.info(`âœ… [MATCH] ${pattern} -> ${url.substring(0, 100)}...`);

            const body = await this.parseJSON(response);

            // è°ƒç”¨æ‰€æœ‰æ³¨å†Œçš„å¤„ç†å™¨
            for (const handler of handlers) {
              try {
                await handler(body, response);
              } catch (error) {
                logger.error(`Handler failed for ${pattern}:`, error);
              }
            }
          }
        }
      } catch (error) {
        logger.error(`Response listener error:`, error);
      }
    };

    this.page.on('response', this.responseListener);
    logger.info(`Enabled ${this.handlers.size} API patterns (using response event)`);
  }
}
```

### ä¿®å¤ 2: æ›´æ–° API æ•°æ®ç»“æ„å¤„ç†

**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/crawl-comments.js`

**ä¿®å¤ 1 - è¯„è®ºåˆ—è¡¨ API**:
```javascript
async function onCommentsListAPI(body, response) {
  // âœ… ä¿®æ­£ï¼šæ£€æŸ¥ comments å­—æ®µï¼ˆçœŸå® API æ•°æ®ç»“æ„ï¼‰
  if (!body || !body.comments || !Array.isArray(body.comments)) {
    logger.warn(`âš ï¸  [API] è¯„è®ºåˆ—è¡¨å“åº”æ— æ•ˆï¼ˆæ—  comments å­—æ®µï¼‰ï¼Œbody keys: ${body ? Object.keys(body).join(', ') : 'null'}`);
    return;
  }

  const url = response.url();
  logger.info(`ğŸ¯ [API] è¯„è®ºåˆ—è¡¨ API è§¦å‘ï¼š${body.comments.length} æ¡è¯„è®º`);

  // âœ… ä½¿ç”¨ DataManagerï¼ˆæ–°æ¶æ„ï¼‰
  if (globalContext.dataManager && body.comments.length > 0) {
    const comments = globalContext.dataManager.batchUpsertComments(
      body.comments,  // ä¸æ˜¯ comment_info_list
      DataSource.API
    );
    logger.info(`âœ… [API] è¯„è®ºåˆ—è¡¨ -> DataManager: ${comments.length} æ¡è¯„è®º`);
  }
}
```

**ä¿®å¤ 2 - å›å¤åˆ—è¡¨ API**:
```javascript
async function onDiscussionsListAPI(body, response) {
  // âœ… ä¿®æ­£ï¼šæ£€æŸ¥ comments å­—æ®µï¼ˆçœŸå® API æ•°æ®ç»“æ„ï¼‰
  if (!body || !body.comments || !Array.isArray(body.comments)) {
    logger.warn(`âš ï¸  [API] è®¨è®ºåˆ—è¡¨å“åº”æ— æ•ˆï¼ˆæ—  comments å­—æ®µï¼‰ï¼Œbody keys: ${body ? Object.keys(body).join(', ') : 'null'}`);
    return;
  }

  const url = response.url();
  logger.info(`ğŸ¯ [API] è®¨è®ºåˆ—è¡¨ API è§¦å‘ï¼š${body.comments.length} æ¡è®¨è®º`);

  // âœ… ä½¿ç”¨ DataManagerï¼ˆæ–°æ¶æ„ï¼‰
  if (globalContext.dataManager && body.comments.length > 0) {
    const discussions = globalContext.dataManager.batchUpsertComments(
      body.comments,
      DataSource.API
    );
    logger.info(`âœ… [API] è®¨è®ºåˆ—è¡¨ -> DataManager: ${discussions.length} æ¡è®¨è®º`);
  }
}
```

### ä¿®å¤ 3: æ›´æ–°å›è°ƒå‡½æ•°ç­¾å

**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/crawl-contents.js`

```javascript
// æ—§ç­¾åï¼ˆé”™è¯¯ï¼‰
async function onWorksListAPI(body, route) {
  const url = route.request().url();
}

// æ–°ç­¾åï¼ˆæ­£ç¡®ï¼‰
async function onWorksListAPI(body, response) {
  const url = response.url();
}
```

## éªŒè¯ç»“æœ

### æˆåŠŸæ•è· 301 é‡å®šå‘

**æ—¥å¿—è¯æ®** (`packages/worker/logs/api-interceptor.log`):
```json
{"level":"info","message":"ğŸ”„ [301/302] https://creator.douyin.com/aweme/v1/creator/item/list?cursor=... -> /aweme/v1/creator/item/list/?cursor=..."}
```

### æˆåŠŸæ‹¦æˆªè¯„è®º API

**æ—¥å¿—è¯æ®**:
```json
{"level":"info","message":"âœ… [MATCH] **/comment/list/select/** -> https://creator.douyin.com/web/api/third_party/aweme/api/comment/read/aweme/v1/web/comment/list/sele..."}
```

æ€»å…±æ‹¦æˆªäº† **5 æ¬¡è¯„è®º API è¯·æ±‚**ã€‚

### æˆåŠŸæ‹¦æˆªä½œå“ API

**æ—¥å¿—è¯æ®** (`packages/worker/logs/crawl-contents.log`):
```json
{"level":"info","message":"ğŸ¯ [API] ä½œå“åˆ—è¡¨ API è¢«è§¦å‘ï¼URL: https://creator.douyin.com/aweme/v1/creator/item/list/?cursor=..."}
{"level":"info","message":"ğŸ“¦ [API] ä½œå“åˆ—è¡¨åŒ…å« 20 ä¸ªä½œå“"}
{"level":"info","message":"âœ… [API] ä½œå“åˆ—è¡¨ -> DataManager: 20 ä¸ªä½œå“"}
```

## æŠ€æœ¯æ€»ç»“

### API æ‹¦æˆªçš„ä¸‰ç§æ–¹æ³•å¯¹æ¯”

| æ–¹æ³• | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ˜¯å¦æ”¯æŒé‡å®šå‘ |
|------|------|------|----------------|
| `page.route()` | å¯ä¿®æ”¹è¯·æ±‚/å“åº” | æ€§èƒ½å¼€é”€å¤§ï¼Œä¸æ•è·é‡å®šå‘åçš„å“åº” | âŒ |
| `page.on('request')` | è½»é‡çº§ | æ— æ³•è·å–å“åº”ä½“ | âŒ |
| `page.on('response')` âœ… | è½»é‡çº§ï¼Œæ•è·æ‰€æœ‰å“åº”ï¼ŒåŒ…æ‹¬é‡å®šå‘åçš„ | æ— æ³•ä¿®æ”¹å“åº”ï¼ˆä½†æˆ‘ä»¬ä¸éœ€è¦ï¼‰ | âœ… |

### æŠ–éŸ³ API ç‰¹æ€§

1. **301 é‡å®šå‘**
   - æ‰€æœ‰ API éƒ½æœ‰ 301 é‡å®šå‘
   - é‡å®šå‘æ˜¯ä¸ºäº†è§„èŒƒåŒ– URLï¼ˆæ·»åŠ æœ«å°¾æ–œæ ï¼‰

2. **æ•°æ®ç»“æ„**
   - å­—æ®µåï¼š`comments` (ä¸æ˜¯ `comment_info_list`)
   - è¯„è®º IDï¼š`cid` (ä¸æ˜¯ `comment_id`)
   - åµŒå¥—ç»“æ„ï¼š`user` å¯¹è±¡åŒ…å«å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯

3. **API ç«¯ç‚¹æ¨¡å¼**
   ```
   è¯„è®ºåˆ—è¡¨: /web/api/third_party/aweme/api/comment/read/aweme/v1/web/comment/list/select/
   å›å¤åˆ—è¡¨: /web/api/third_party/aweme/api/comment/read/aweme/v1/web/comment/list/reply/
   ä½œå“åˆ—è¡¨: /aweme/v1/creator/item/list/
   ```

## ç›¸å…³æ–‡ä»¶

- âœ… `packages/worker/src/platforms/base/api-interceptor-manager.js` - é‡å†™
- âœ… `packages/worker/src/platforms/douyin/crawl-comments.js` - ä¿®å¤æ•°æ®ç»“æ„å’Œç­¾å
- âœ… `packages/worker/src/platforms/douyin/crawl-contents.js` - ä¿®å¤ç­¾å
- âœ… `tests/æµ‹è¯•301é‡å®šå‘æ‹¦æˆª.js` - æ–°å¢æµ‹è¯•è„šæœ¬

## ä¸‹ä¸€æ­¥éªŒè¯

1. åœæ­¢å½“å‰ Worker è¿›ç¨‹
2. æ¸…ç†æ—¥å¿—æ–‡ä»¶
3. é‡å¯ Master å’Œ Worker
4. ç­‰å¾… 60 ç§’è®©çˆ¬è™«è¿è¡Œ
5. æ£€æŸ¥ `data-manager.log` ç¡®è®¤è¯„è®ºæ•°æ®æˆåŠŸå…¥åº“

**é¢„æœŸç»“æœ**:
```
âœ… comments: 22+
âœ… discussions: 10+
âœ… contents: 20
```
