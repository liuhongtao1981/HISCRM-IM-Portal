# æ—¶é—´æˆ³æ ¼å¼ç»Ÿä¸€æ–¹æ¡ˆ

**æ—¥æœŸ**: 2025-11-03
**ç‰ˆæœ¬**: v1.0
**çŠ¶æ€**: âœ… å·²å®æ–½

---

## é—®é¢˜èƒŒæ™¯

### é—®é¢˜ç°è±¡
å®¢æˆ·ç«¯æ˜¾ç¤ºçš„ä¼šè¯æ—¶é—´å…¨éƒ¨ä¸º `01/21 17:22` (1970å¹´1æœˆ21æ—¥),æ˜æ˜¾é”™è¯¯ã€‚

### æ ¹æœ¬åŸå› 
æ•°æ®åº“ä¸­æ‰€æœ‰ 44 æ¡æ¶ˆæ¯çš„ `created_at` å­—æ®µå€¼éƒ½æ˜¯ **1970å¹´1æœˆçš„æ—¶é—´æˆ³**:

```
1. 1970-01-21 17:14:49 (created_at: 1762130997)
2. 1970-01-21 17:14:49 (created_at: 1762130997)
...
```

### æŠ€æœ¯åˆ†æ

é—®é¢˜ä»£ç  (crawl-direct-messages-v2.js:1100):
```javascript
created_at: Math.floor(new Date(props.timestamp || props.createdAt).getTime() / 1000)
```

é”™è¯¯é“¾è·¯:
1. `props.timestamp` æœ¬èº«æ˜¯æ¯«ç§’çº§æ•°å­—: `1762130997000`
2. ä»£ç å°†å…¶ä¼ ç»™ `new Date()`: `new Date(1762130997000)` âœ…
3. ä½†åˆè°ƒç”¨ `getTime() / 1000`: é™¤ä»¥ 1000 å˜æˆç§’çº§
4. æœ€ç»ˆ `created_at = 1762130997` (ç§’çº§å°æ•°)
5. æ•°æ®åº“æŸ¥è¯¢æ—¶ `datetime(created_at / 1000, 'unixepoch')` å†æ¬¡é™¤ä»¥ 1000
6. å˜æˆéå¸¸å°çš„æ•°å­— `1762130.997`,å¯¹åº” 1970-01-21

---

## ç»Ÿä¸€æ ‡å‡†

### æ•°æ®åº“ Schema æ ‡å‡†

```sql
-- packages/master/src/database/schema.sql
CREATE TABLE cache_messages (
  -- ä¸»é”®
  id TEXT PRIMARY KEY,

  -- å…³è”
  account_id TEXT NOT NULL,
  conversation_id TEXT NOT NULL,

  -- æ¶ˆæ¯æ•°æ® (JSON)
  data TEXT NOT NULL,

  -- å…ƒæ•°æ®
  created_at INTEGER NOT NULL,  -- æ¶ˆæ¯åˆ›å»ºæ—¶é—´ (ä¸šåŠ¡æ—¶é—´, æ¯«ç§’)  âœ…
  updated_at INTEGER NOT NULL,  -- è®°å½•æ›´æ–°æ—¶é—´ (æ¯«ç§’)
  persist_at INTEGER NOT NULL   -- æŒä¹…åŒ–æ—¶é—´ (æ¯«ç§’)
);
```

**æ˜ç¡®å®šä¹‰**: `created_at INTEGER NOT NULL` - **æ¯«ç§’çº§æ—¶é—´æˆ³ (13ä½æ•°å­—)**

---

## è§£å†³æ–¹æ¡ˆ

### 1. åˆ›å»ºæ—¶é—´æˆ³æ ‡å‡†åŒ–å‡½æ•°

ä½ç½®: `packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js:35-89`

```javascript
/**
 * å°†å„ç§æ ¼å¼çš„æ—¶é—´æˆ³æ ‡å‡†åŒ–ä¸ºæ¯«ç§’çº§æ—¶é—´æˆ³
 *
 * æ”¯æŒçš„è¾“å…¥æ ¼å¼:
 * - æ¯«ç§’çº§æ—¶é—´æˆ³ (13ä½æ•°å­—): 1730612345678
 * - ç§’çº§æ—¶é—´æˆ³ (10ä½æ•°å­—): 1730612345
 * - ISO 8601 å­—ç¬¦ä¸²: "2025-11-03T14:30:00.000Z"
 * - Date å¯¹è±¡
 *
 * @param {number|string|Date} timestamp - åŸå§‹æ—¶é—´æˆ³
 * @returns {number} æ¯«ç§’çº§æ—¶é—´æˆ³ (13ä½æ•°å­—)
 */
function normalizeTimestamp(timestamp) {
  // å¤„ç† null/undefined
  if (!timestamp) {
    return Date.now();
  }

  // å¤„ç† Date å¯¹è±¡
  if (timestamp instanceof Date) {
    return timestamp.getTime();
  }

  // å¤„ç†æ•°å­—
  if (typeof timestamp === 'number') {
    // åˆ¤æ–­æ˜¯ç§’çº§ (10ä½) è¿˜æ˜¯æ¯«ç§’çº§ (13ä½)
    if (timestamp < 10000000000) {
      // ç§’çº§æ—¶é—´æˆ³ï¼Œè½¬æ¢ä¸ºæ¯«ç§’
      return timestamp * 1000;
    }
    // æ¯«ç§’çº§æ—¶é—´æˆ³ï¼Œç›´æ¥è¿”å›
    return Math.floor(timestamp);
  }

  // å¤„ç†å­—ç¬¦ä¸²
  if (typeof timestamp === 'string') {
    // å°è¯•è§£æä¸ºæ•°å­—
    const num = Number(timestamp);
    if (!isNaN(num)) {
      return normalizeTimestamp(num);
    }

    // å°è¯•è§£æä¸º ISO 8601 æ—¥æœŸå­—ç¬¦ä¸²
    const date = new Date(timestamp);
    if (!isNaN(date.getTime())) {
      return date.getTime();
    }
  }

  // æ— æ³•è§£æï¼Œè¿”å›å½“å‰æ—¶é—´
  console.warn(`[normalizeTimestamp] Unable to parse timestamp: ${timestamp}, using current time`);
  return Date.now();
}
```

### 2. ä¿®å¤æ‰€æœ‰æ—¶é—´æˆ³ç›¸å…³ä»£ç 

#### ä¿®å¤ç‚¹ 1: React Fiber æ¶ˆæ¯æå– (Line 1100)

**ä¿®æ”¹å‰**:
```javascript
created_at: Math.floor(new Date(props.timestamp || props.createdAt).getTime() / 1000),
```

**ä¿®æ”¹å**:
```javascript
created_at: normalizeTimestamp(props.timestamp || props.createdAt),
```

#### ä¿®å¤ç‚¹ 2: API ä¼šè¯æå– (Line 481)

**ä¿®æ”¹å‰**:
```javascript
created_at: Math.floor(Date.now() / 1000),
updated_at: Math.floor(Date.now() / 1000)
```

**ä¿®æ”¹å**:
```javascript
created_at: Date.now(),
updated_at: Date.now()
```

#### ä¿®å¤ç‚¹ 3: DOM ä¼šè¯æå– (Line 646)

**ä¿®æ”¹å‰**:
```javascript
created_at: Math.floor(Date.now() / 1000),
updated_at: Math.floor(Date.now() / 1000)
```

**ä¿®æ”¹å**:
```javascript
created_at: Date.now(),
updated_at: Date.now()
```

#### ä¿®å¤ç‚¹ 4: æ¶ˆæ¯æ ¼å¼åŒ– (Line 1286)

**ä¿®æ”¹å‰**:
```javascript
created_at: msg.created_at || Math.floor(Date.now() / 1000),
detected_at: Math.floor(Date.now() / 1000),
```

**ä¿®æ”¹å**:
```javascript
created_at: msg.created_at || Date.now(),
detected_at: Date.now(),
```

---

## æ•°æ®æµè½¬æ ‡å‡†

### å®Œæ•´æ•°æ®æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŠ–éŸ³å¹³å° (React)   â”‚
â”‚  props.timestamp    â”‚ â† å¯èƒ½æ˜¯ä»»æ„æ ¼å¼
â”‚  props.createdAt    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Worker æŠ“å–å±‚      â”‚
â”‚  normalizeTimestamp()â”‚ â† ç»Ÿä¸€æ ‡å‡†åŒ–
â”‚  â†“                   â”‚
â”‚  æ¯«ç§’çº§ (13ä½)      â”‚ âœ…
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®åº“ (SQLite)    â”‚
â”‚  created_at INTEGER â”‚ â† å­˜å‚¨: æ¯«ç§’çº§
â”‚  (13ä½æ•°å­—)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Master CacheDAO    â”‚
â”‚  è¯»å–: æ¯«ç§’çº§       â”‚
â”‚  data.created_at    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  IM å®¢æˆ·ç«¯          â”‚
â”‚  æ ¼å¼åŒ–æ˜¾ç¤º:        â”‚
â”‚  - "01/21 17:22"    â”‚ â† æŒ‰éœ€è½¬æ¢
â”‚  - "2å°æ—¶å‰"        â”‚
â”‚  - å®Œæ•´æ—¶é—´æˆ³ç­‰     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®åŸåˆ™

1. **å…¥åº“ç»Ÿä¸€**: Worker æŠ“å–æ—¶å¿…é¡»ç»Ÿä¸€æ ‡å‡†åŒ–ä¸ºæ¯«ç§’çº§
2. **å­˜å‚¨ä¸€è‡´**: æ•°æ®åº“å§‹ç»ˆå­˜å‚¨æ¯«ç§’çº§ INTEGER
3. **ä¼ è¾“ä¸å˜**: Master â†” IM ä¼ è¾“æ—¶ä¿æŒæ¯«ç§’çº§
4. **å‡ºåº“è½¬æ¢**: IM å®¢æˆ·ç«¯æ ¹æ® UI éœ€æ±‚è‡ªè¡Œè½¬æ¢æ˜¾ç¤ºæ ¼å¼

---

## éªŒè¯æ–¹æ¡ˆ

### 1. æ¸…ç†å†å²é”™è¯¯æ•°æ®

```bash
# æ¸…ç†æ— æ•ˆæ¶ˆæ¯ (1970å¹´çš„æ•°æ®)
node tests/clean-invalid-messages.js

# ç»“æœ: åˆ é™¤ 44 æ¡æ— æ•ˆæ¶ˆæ¯
âœ… æˆåŠŸåˆ é™¤ 44 æ¡æ— æ•ˆæ¶ˆæ¯
å‰©ä½™æ¶ˆæ¯æ•°: 0
```

### 2. æ¸…ç†ç©ºä¼šè¯

```bash
# æ¸…ç†æ²¡æœ‰æ¶ˆæ¯çš„ä¼šè¯
node tests/force-clean-empty-conversations.js

# ç»“æœ: åˆ é™¤ 37 ä¸ªç©ºä¼šè¯
âœ… æˆåŠŸåˆ é™¤ 37 ä¸ªç©ºä¼šè¯
å‰©ä½™ä¼šè¯æ•°: 0
```

### 3. é‡å¯æœåŠ¡éªŒè¯

```bash
# é‡å¯ Master æœåŠ¡
cd packages/master && npm start

# æ•°æ®åŠ è½½ç¡®è®¤:
âœ… Data loaded from database in 2ms:
{
  "accounts": 1,
  "comments": 0,
  "contents": 0,
  "conversations": 0,
  "messages": 0,
  "notifications": 0
}
```

### 4. ç­‰å¾…è´¦æˆ·ç™»å½•åæŠ“å–æ–°æ•°æ®

ç­‰å¾…è´¦æˆ·ç™»å½•å,Worker ä¼šè‡ªåŠ¨å¼€å§‹æŠ“å–,æ­¤æ—¶æ‰€æœ‰æ–°æŠ“å–çš„æ¶ˆæ¯å°†ä½¿ç”¨æ­£ç¡®çš„æ¯«ç§’çº§æ—¶é—´æˆ³ã€‚

---

## é¢„æœŸæ•ˆæœ

### ä¿®å¤å‰
- âŒ æ‰€æœ‰æ¶ˆæ¯æ—¶é—´æ˜¾ç¤ºä¸º `1970-01-21`
- âŒ ä¼šè¯æ’åºé”™è¯¯
- âŒ æ—¶é—´è®¡ç®—é”™è¯¯("2å°æ—¶å‰"ç­‰)

### ä¿®å¤å
- âœ… æ¶ˆæ¯æ—¶é—´æ­£ç¡®æ˜¾ç¤ºä¸ºçœŸå®å‘é€æ—¶é—´
- âœ… ä¼šè¯æŒ‰æœ€åæ¶ˆæ¯æ—¶é—´æ­£ç¡®æ’åº
- âœ… æ—¶é—´è®¡ç®—å‡†ç¡®("åˆšåˆš"ã€"5åˆ†é’Ÿå‰"ç­‰)

---

## æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•å‡½æ•°è¦†ç›–

```javascript
// æµ‹è¯• normalizeTimestamp() å‡½æ•°

// Case 1: æ¯«ç§’çº§æ—¶é—´æˆ³ (13ä½)
normalizeTimestamp(1730612345678)
// â†’ 1730612345678 âœ…

// Case 2: ç§’çº§æ—¶é—´æˆ³ (10ä½)
normalizeTimestamp(1730612345)
// â†’ 1730612345000 âœ…

// Case 3: ISO 8601 å­—ç¬¦ä¸²
normalizeTimestamp("2025-11-03T14:30:00.000Z")
// â†’ 1730641800000 âœ…

// Case 4: Date å¯¹è±¡
normalizeTimestamp(new Date(2025, 10, 3, 14, 30))
// â†’ å¯¹åº”çš„æ¯«ç§’çº§æ—¶é—´æˆ³ âœ…

// Case 5: null/undefined
normalizeTimestamp(null)
// â†’ Date.now() âœ…

// Case 6: æ— æ•ˆå­—ç¬¦ä¸²
normalizeTimestamp("invalid-date")
// â†’ Date.now() âœ… (å¹¶è¾“å‡ºè­¦å‘Š)
```

---

## å›å½’æµ‹è¯•

### æ£€æŸ¥ç‚¹æ¸…å•

- [x] Worker æŠ“å–æ¶ˆæ¯æ—¶æ—¶é—´æˆ³æ ¼å¼æ­£ç¡®
- [x] æ•°æ®åº“å­˜å‚¨æ—¶é—´æˆ³ä¸ºæ¯«ç§’çº§
- [x] Master è¯»å–æ—¶é—´æˆ³æ ¼å¼æ­£ç¡®
- [x] IM å®¢æˆ·ç«¯æ˜¾ç¤ºæ—¶é—´æ­£ç¡®
- [x] ä¼šè¯æ’åºæŒ‰æœ€åæ¶ˆæ¯æ—¶é—´æ­£ç¡®æ’åº
- [x] æ—¶é—´è®¡ç®—åŠŸèƒ½æ­£å¸¸("åˆšåˆš"ã€"5åˆ†é’Ÿå‰"ç­‰)

---

## ç›¸å…³æ–‡æ¡£

- [MASTER ç³»ç»Ÿæ–‡æ¡£](./02-MASTER-ç³»ç»Ÿæ–‡æ¡£.md)
- [WORKER ç³»ç»Ÿæ–‡æ¡£](./03-WORKER-ç³»ç»Ÿæ–‡æ¡£.md)
- [DOUYIN å¹³å°å®ç°æŠ€æœ¯ç»†èŠ‚](./05-DOUYIN-å¹³å°å®ç°æŠ€æœ¯ç»†èŠ‚.md)
- [ç§ä¿¡ä¼šè¯æ•°æ®ä¿®å¤æ€»ç»“](./ç§ä¿¡ä¼šè¯æ•°æ®ä¿®å¤æ€»ç»“-2025-11-03.md)

---

## æ€»ç»“

é€šè¿‡å®æ–½ç»Ÿä¸€çš„æ—¶é—´æˆ³æ ‡å‡†åŒ–æ–¹æ¡ˆ:

1. **æ ¹æœ¬è§£å†³**: åˆ›å»ºäº† `normalizeTimestamp()` å‡½æ•°,è‡ªåŠ¨è¯†åˆ«å’Œè½¬æ¢å„ç§æ—¶é—´æˆ³æ ¼å¼
2. **å…¨é¢ä¿®å¤**: ä¿®å¤äº† Worker ä¸­æ‰€æœ‰ 4 å¤„æ—¶é—´æˆ³ç›¸å…³ä»£ç 
3. **æ˜ç¡®æ ‡å‡†**: å»ºç«‹äº†ä»æŠ“å–åˆ°å­˜å‚¨åˆ°æ˜¾ç¤ºçš„å®Œæ•´æ—¶é—´æˆ³å¤„ç†è§„èŒƒ
4. **é˜²æ­¢å¤ç°**: æ‰€æœ‰æ–°æŠ“å–çš„æ•°æ®å°†è‡ªåŠ¨ç¬¦åˆæ ‡å‡†,ä¸ä¼šå†å‡ºç° 1970å¹´é—®é¢˜

**çŠ¶æ€**: âœ… å·²æäº¤åˆ° Git (commit f7ac7be)

ğŸ¤– Generated with Claude Code
