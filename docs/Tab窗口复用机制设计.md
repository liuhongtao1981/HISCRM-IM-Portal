# Tab çª—å£å¤ç”¨æœºåˆ¶è®¾è®¡

## ç”¨æˆ·éœ€æ±‚

> "æˆ‘çš„tabï¼Œç§ä¿¡+ä¼šè¯ çš„èœ˜è››ï¼Œè¯„è®º+è®¨è®º+è§†é¢‘çš„èœ˜è››ï¼Œç™»å½•ï¼Œç™»å½•çŠ¶æ€æ£€æµ‹ï¼Œå‘é€å›å¤æˆ–è€…è¯„è®ºï¼Œè¿™å‡ ç§ï¼Œåº”è¯¥æœ‰ä¸€æ¡å¤ç”¨æœºåˆ¶"

## ä»»åŠ¡åˆ†ç±»

æ ¹æ®ç”¨æˆ·éœ€æ±‚ï¼Œå°†æ‰€æœ‰ä»»åŠ¡åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š

| ä»»åŠ¡ç±»åˆ« | åŒ…å«ä»»åŠ¡ | é¡µé¢ç±»å‹ | å¤ç”¨ç­–ç•¥ |
|---------|---------|---------|---------|
| **IM ç±»** | ç§ä¿¡çˆ¬å–ã€ä¼šè¯çˆ¬å– | IM é¡µé¢ | å¤ç”¨åŒä¸€ä¸ª Tab |
| **å†…å®¹ç±»** | è¯„è®ºçˆ¬å–ã€è®¨è®ºçˆ¬å–ã€è§†é¢‘çˆ¬å– | ä½œå“åˆ—è¡¨/è¯¦æƒ…é¡µ | å¤ç”¨åŒä¸€ä¸ª Tab |
| **ç™»å½•ç±»** | ç™»å½•çŠ¶æ€æ£€æµ‹ã€äºŒç»´ç ç™»å½• | åˆ›ä½œä¸­å¿ƒé¦–é¡µ | å¤ç”¨ Tab 1ï¼Œå®Œæˆåè½¬æ¢ |
| **æ“ä½œç±»** | å‘é€å›å¤ã€å‘é€è¯„è®ºã€å‘é€ç§ä¿¡ | ç‰¹å®šé¡µé¢ | ä¸´æ—¶åˆ›å»ºï¼Œå®Œæˆåå…³é—­ |

## Tab å¤ç”¨è§„åˆ™

### è§„åˆ™ 1ï¼šTab 1 çš„ç”Ÿå‘½å‘¨æœŸï¼ˆåŠ¨æ€è½¬æ¢ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tab 1 ç”Ÿå‘½å‘¨æœŸï¼ˆç™»å½• â†’ IMï¼‰                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æµè§ˆå™¨å¯åŠ¨
   â†“
Tab 1 åˆ›å»ºï¼ˆé»˜è®¤é¡µé¢ï¼‰
çŠ¶æ€: INITIALIZATION
   â†“
Worker å¯åŠ¨æ£€æµ‹
   â†“
Tab 1 ç”¨äºç™»å½•çŠ¶æ€æ£€æµ‹
çŠ¶æ€: LOGIN_CHECK
é¡µé¢: creator.douyin.com
   â†“
   â”œâ”€ æœªç™»å½• âŒ
   â”‚  â†“
   â”‚  Tab 1 ç­‰å¾…ç™»å½•
   â”‚  çŠ¶æ€: WAITING_LOGIN
   â”‚  â†“
   â”‚  ç”¨æˆ·ç‚¹å‡»ç™»å½•
   â”‚  â†“
   â”‚  Tab 1 æ˜¾ç¤ºäºŒç»´ç 
   â”‚  çŠ¶æ€: QR_CODE_LOGIN
   â”‚  â†“
   â”‚  ç™»å½•æˆåŠŸ
   â”‚  â†“
   â”œâ”€ å·²ç™»å½• âœ…
   â”‚
   â””â”€â”€â”€â†’ Tab 1 è½¬æ¢ä¸º IM èœ˜è››
        çŠ¶æ€: SPIDER_IM
        é¡µé¢: creator.douyin.com/im
        ä»»åŠ¡: ç§ä¿¡çˆ¬å–ã€ä¼šè¯çˆ¬å–
        â†“
        é•¿æœŸè¿è¡Œï¼Œä¸å…³é—­
```

### è§„åˆ™ 2ï¼šTab 2 çš„ä¸“ç”¨ä»»åŠ¡ï¼ˆå†…å®¹ç±»ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tab 2 ç”Ÿå‘½å‘¨æœŸï¼ˆå†…å®¹ç±»ï¼‰                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é¦–æ¬¡éœ€è¦å†…å®¹çˆ¬å–
   â†“
Tab 2 åˆ›å»º
çŠ¶æ€: SPIDER_CONTENT
é¡µé¢: creator.douyin.com/creator-micro/home
ä»»åŠ¡: è¯„è®ºçˆ¬å–ã€è®¨è®ºçˆ¬å–ã€è§†é¢‘çˆ¬å–
   â†“
â­ å¤ç”¨æœºåˆ¶ï¼š
   - è¯„è®ºçˆ¬å– â†’ Tab 2 è®¿é—®ä½œå“åˆ—è¡¨ â†’ ç‚¹å‡»ä½œå“ â†’ çˆ¬å–è¯„è®º
   - è®¨è®ºçˆ¬å– â†’ Tab 2 è®¿é—®ä½œå“åˆ—è¡¨ â†’ ç‚¹å‡»ä½œå“ â†’ çˆ¬å–è®¨è®º
   - è§†é¢‘çˆ¬å– â†’ Tab 2 è®¿é—®ä½œå“åˆ—è¡¨ â†’ æå–è§†é¢‘ä¿¡æ¯
   â†“
é•¿æœŸè¿è¡Œï¼Œä¸å…³é—­
```

### è§„åˆ™ 3ï¼šTab 3+ çš„ä¸´æ—¶ä»»åŠ¡ï¼ˆæ“ä½œç±»ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tab 3+ ç”Ÿå‘½å‘¨æœŸï¼ˆæ“ä½œç±»ï¼‰                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

éœ€è¦æ‰§è¡Œæ“ä½œï¼ˆå›å¤ã€è¯„è®ºã€ç§ä¿¡ï¼‰
   â†“
Tab 3 åˆ›å»ºï¼ˆä¸´æ—¶ï¼‰
çŠ¶æ€: TEMPORARY_ACTION
ä»»åŠ¡: å‘é€å›å¤/è¯„è®º/ç§ä¿¡
   â†“
â­ å¤ç”¨æœºåˆ¶ï¼š
   - å‘é€å›å¤è¯„è®º â†’ Tab 3 è®¿é—®è¯„è®ºé¡µé¢ â†’ æäº¤å›å¤ â†’ å…³é—­
   - å‘é€è¯„è®º â†’ Tab 3 è®¿é—®ä½œå“é¡µé¢ â†’ æäº¤è¯„è®º â†’ å…³é—­
   - å‘é€ç§ä¿¡ â†’ Tab 3 è®¿é—® IM é¡µé¢ â†’ å‘é€æ¶ˆæ¯ â†’ å…³é—­
   â†“
ä»»åŠ¡å®Œæˆ
   â†“
â­ ç«‹å³å…³é—­ Tab 3ï¼Œé‡Šæ”¾èµ„æº
```

## è¯¦ç»†è®¾è®¡

### ä»»åŠ¡åˆ° Tab çš„æ˜ å°„

```javascript
// Tab ç±»å‹æšä¸¾
const TabType = {
  SPIDER_IM: 'spider_im',           // IM èœ˜è›› (Tab 1)
  SPIDER_CONTENT: 'spider_content', // å†…å®¹èœ˜è›› (Tab 2)
  TEMPORARY_ACTION: 'temporary',    // ä¸´æ—¶æ“ä½œ (Tab 3+)
};

// ä»»åŠ¡åˆ° Tab ç±»å‹çš„æ˜ å°„
const TaskToTabMapping = {
  // IM ç±» â†’ Tab 1
  'crawl_direct_messages': TabType.SPIDER_IM,
  'crawl_conversations': TabType.SPIDER_IM,

  // å†…å®¹ç±» â†’ Tab 2
  'crawl_comments': TabType.SPIDER_CONTENT,
  'crawl_discussions': TabType.SPIDER_CONTENT,
  'crawl_videos': TabType.SPIDER_CONTENT,

  // æ“ä½œç±» â†’ Tab 3+ (ä¸´æ—¶)
  'send_reply': TabType.TEMPORARY_ACTION,
  'send_comment': TabType.TEMPORARY_ACTION,
  'send_direct_message': TabType.TEMPORARY_ACTION,

  // ç™»å½•ç±» â†’ Tab 1 (è½¬æ¢å‰)
  'login_check': 'tab1_login_check',
  'qr_code_login': 'tab1_qr_code_login',
};
```

### Tab çŠ¶æ€å®šä¹‰

```javascript
const TabState = {
  // Tab 1 çš„çŠ¶æ€ï¼ˆç™»å½•ç›¸å…³ + IM èœ˜è››ï¼‰
  INITIALIZATION: 'initialization',      // åˆå§‹åŒ–
  LOGIN_CHECK: 'login_check',           // ç™»å½•æ£€æµ‹ä¸­
  WAITING_LOGIN: 'waiting_login',       // ç­‰å¾…ç™»å½•
  QR_CODE_LOGIN: 'qr_code_login',       // äºŒç»´ç ç™»å½•ä¸­
  SPIDER_IM: 'spider_im',               // IM èœ˜è››ï¼ˆç§ä¿¡+ä¼šè¯ï¼‰

  // Tab 2 çš„çŠ¶æ€ï¼ˆå†…å®¹èœ˜è››ï¼‰
  SPIDER_CONTENT: 'spider_content',     // å†…å®¹èœ˜è››ï¼ˆè¯„è®º+è®¨è®º+è§†é¢‘ï¼‰

  // Tab 3+ çš„çŠ¶æ€ï¼ˆä¸´æ—¶æ“ä½œï¼‰
  TEMPORARY_ACTION: 'temporary_action', // ä¸´æ—¶æ“ä½œ

  // é€šç”¨çŠ¶æ€
  CLOSED: 'closed',                     // å·²å…³é—­
};
```

## ä»£ç å®ç°

### æ”¹è¿› BrowserManager

```javascript
class BrowserManager {
  constructor(config = {}) {
    // ... ç°æœ‰ä»£ç  ...

    // â­ Tab ç®¡ç†
    this.tabStateManager = new TabStateManager();

    // â­ Tab æ± ï¼šæŒ‰ç±»å‹ç®¡ç†
    this.tabPools = new Map(); // { accountId -> { im: page, content: page } }
  }

  /**
   * â­ æ ¹æ®ä»»åŠ¡ç±»å‹è·å–é¡µé¢ï¼ˆæ ¸å¿ƒå¤ç”¨é€»è¾‘ï¼‰
   *
   * @param {string} accountId - è´¦æˆ·ID
   * @param {string} taskType - ä»»åŠ¡ç±»å‹
   * @returns {Page} é¡µé¢å¯¹è±¡
   */
  async getPageForTask(accountId, taskType) {
    // 1. ç¡®å®š Tab ç±»å‹
    const tabType = this.getTabTypeForTask(taskType);

    // 2. æ ¹æ® Tab ç±»å‹è·å–æˆ–åˆ›å»ºé¡µé¢
    switch (tabType) {
      case TabType.SPIDER_IM:
        return await this.getIMSpiderPage(accountId);

      case TabType.SPIDER_CONTENT:
        return await this.getContentSpiderPage(accountId);

      case TabType.TEMPORARY_ACTION:
        return await this.createTemporaryActionPage(accountId, taskType);

      default:
        throw new Error(`Unknown tab type: ${tabType} for task: ${taskType}`);
    }
  }

  /**
   * â­ è·å– IM èœ˜è››é¡µé¢ï¼ˆTab 1ï¼‰
   *
   * å¤ç”¨è§„åˆ™ï¼š
   * - ç§ä¿¡çˆ¬å–ã€ä¼šè¯çˆ¬å–å…±ç”¨æ­¤é¡µé¢
   * - é¡µé¢å›ºå®šåœ¨ IM é¡µé¢ (creator.douyin.com/im)
   * - é•¿æœŸè¿è¡Œï¼Œä¸å…³é—­
   */
  async getIMSpiderPage(accountId) {
    let pool = this.tabPools.get(accountId);
    if (!pool) {
      pool = {};
      this.tabPools.set(accountId, pool);
    }

    // æ£€æŸ¥æ˜¯å¦å·²æœ‰ IM èœ˜è››é¡µé¢
    if (pool.im && !pool.im.isClosed()) {
      logger.debug(`â™»ï¸  Reusing IM spider page (Tab 1) for account ${accountId}`);
      return pool.im;
    }

    // è·å– Tab 1
    const tab1 = this.tabStateManager.getTabByState(accountId, TabState.SPIDER_IM);
    if (!tab1) {
      throw new Error(`Tab 1 not in SPIDER_IM state for account ${accountId} - may not be logged in`);
    }

    pool.im = tab1.page;

    // â­ ç¡®ä¿é¡µé¢åœ¨ IM é¡µé¢
    const currentUrl = pool.im.url();
    if (!currentUrl.includes('creator.douyin.com/im')) {
      logger.info(`ğŸ“ Navigating IM spider page to IM page for ${accountId}...`);
      await pool.im.goto('https://creator.douyin.com/im', {
        waitUntil: 'domcontentloaded',
        timeout: 30000
      });
      await pool.im.waitForTimeout(2000);
    }

    logger.info(`ğŸ•·ï¸  IM spider page (Tab 1) ready for account ${accountId}`);
    return pool.im;
  }

  /**
   * â­ è·å–å†…å®¹èœ˜è››é¡µé¢ï¼ˆTab 2ï¼‰
   *
   * å¤ç”¨è§„åˆ™ï¼š
   * - è¯„è®ºçˆ¬å–ã€è®¨è®ºçˆ¬å–ã€è§†é¢‘çˆ¬å–å…±ç”¨æ­¤é¡µé¢
   * - é¡µé¢åœ¨ä½œå“åˆ—è¡¨é¡µé¢ (creator.douyin.com/creator-micro/home)
   * - æ ¹æ®ä»»åŠ¡éœ€è¦ï¼Œå¯¼èˆªåˆ°ä¸åŒçš„ä½œå“é¡µé¢
   * - é•¿æœŸè¿è¡Œï¼Œä¸å…³é—­
   */
  async getContentSpiderPage(accountId) {
    let pool = this.tabPools.get(accountId);
    if (!pool) {
      pool = {};
      this.tabPools.set(accountId, pool);
    }

    // æ£€æŸ¥æ˜¯å¦å·²æœ‰å†…å®¹èœ˜è››é¡µé¢
    if (pool.content && !pool.content.isClosed()) {
      logger.debug(`â™»ï¸  Reusing content spider page (Tab 2) for account ${accountId}`);
      return pool.content;
    }

    // æ£€æŸ¥ Tab 2 æ˜¯å¦å·²åˆ›å»º
    let tab2 = this.tabStateManager.getTabByState(accountId, TabState.SPIDER_CONTENT);

    if (!tab2) {
      // åˆ›å»º Tab 2
      const context = this.contexts.get(accountId);
      if (!context) {
        throw new Error(`Context not found for account ${accountId}`);
      }

      const page = await context.newPage();

      // æ³¨å†Œ Tab 2
      this.tabStateManager.registerTab(
        accountId,
        'tab2',
        page,
        TabState.SPIDER_CONTENT,
        'Content spider (comments + discussions + videos)'
      );

      pool.content = page;

      logger.info(`ğŸ•·ï¸  Created content spider page (Tab 2) for account ${accountId}`);
    } else {
      pool.content = tab2.page;
    }

    // â­ ç¡®ä¿é¡µé¢åœ¨ä½œå“åˆ—è¡¨é¡µ
    const currentUrl = pool.content.url();
    if (!currentUrl.includes('creator.douyin.com/creator-micro/home')) {
      logger.info(`ğŸ“ Navigating content spider page to home for ${accountId}...`);
      await pool.content.goto('https://creator.douyin.com/creator-micro/home', {
        waitUntil: 'domcontentloaded',
        timeout: 30000
      });
      await pool.content.waitForTimeout(2000);
    }

    logger.info(`ğŸ•·ï¸  Content spider page (Tab 2) ready for account ${accountId}`);
    return pool.content;
  }

  /**
   * â­ åˆ›å»ºä¸´æ—¶æ“ä½œé¡µé¢ï¼ˆTab 3+ï¼‰
   *
   * å¤ç”¨è§„åˆ™ï¼š
   * - ä¸´æ—¶åˆ›å»ºï¼Œä»»åŠ¡å®Œæˆåç«‹å³å…³é—­
   * - æ¯ä¸ªæ“ä½œç‹¬ç«‹ä½¿ç”¨ä¸€ä¸ª Tab
   * - é‡Šæ”¾èµ„æºï¼Œé¿å… Tab æ•°é‡æ— é™å¢é•¿
   */
  async createTemporaryActionPage(accountId, taskType) {
    try {
      // æ£€æŸ¥ Tab æ•°é‡é™åˆ¶
      const tabCount = this.tabStateManager.getTabCount(accountId);
      if (tabCount >= 3) {
        logger.warn(`Account ${accountId} already has ${tabCount} tabs, waiting for cleanup...`);
        await this.waitForTabRelease(accountId, 10000);
      }

      const context = this.contexts.get(accountId);
      if (!context) {
        throw new Error(`Context not found for account ${accountId}`);
      }

      const page = await context.newPage();
      const tabId = `temp-${Date.now()}`;

      // æ³¨å†Œä¸´æ—¶ Tab
      this.tabStateManager.registerTab(
        accountId,
        tabId,
        page,
        TabState.TEMPORARY_ACTION,
        `Temporary: ${taskType}`
      );

      logger.info(`âœ¨ Created temporary action page (${tabId}) for ${accountId}: ${taskType}`);

      return { tabId, page };

    } catch (error) {
      logger.error(`Failed to create temporary action page for ${accountId}:`, error);
      throw error;
    }
  }

  /**
   * â­ å…³é—­ä¸´æ—¶æ“ä½œé¡µé¢
   *
   * @param {string} accountId - è´¦æˆ·ID
   * @param {string} tabId - Tab ID
   */
  async closeTemporaryActionPage(accountId, tabId) {
    try {
      const tab = this.tabStateManager.getTab(accountId, tabId);
      if (!tab) {
        logger.warn(`Tab ${tabId} not found for account ${accountId}`);
        return;
      }

      if (tab.state !== TabState.TEMPORARY_ACTION) {
        logger.error(`Tab ${tabId} is not a temporary action tab (state: ${tab.state})`);
        return;
      }

      // å…³é—­é¡µé¢
      if (!tab.page.isClosed()) {
        await tab.page.close();
        logger.info(`ğŸ—‘ï¸  Closed temporary action page (${tabId}) for ${accountId}`);
      }

      // ç§»é™¤è®°å½•
      this.tabStateManager.removeTab(accountId, tabId);

    } catch (error) {
      logger.error(`Failed to close temporary action page ${tabId} for ${accountId}:`, error);
    }
  }

  /**
   * â­ Tab 1 ä»ç™»å½•æ£€æµ‹è½¬æ¢ä¸º IM èœ˜è››
   */
  async convertTab1ToIMSpider(accountId) {
    const tab = this.tabStateManager.getTabByState(accountId, TabState.LOGIN_CHECK);
    if (!tab) {
      logger.warn(`Tab 1 not in LOGIN_CHECK state for account ${accountId}`);
      return null;
    }

    // è½¬æ¢çŠ¶æ€
    this.tabStateManager.transitionTab(
      accountId,
      'tab1',
      TabState.SPIDER_IM,
      'IM spider (direct messages + conversations)'
    );

    // å¯¼èˆªåˆ° IM é¡µé¢
    await tab.page.goto('https://creator.douyin.com/im', {
      waitUntil: 'domcontentloaded',
      timeout: 30000
    });
    await tab.page.waitForTimeout(2000);

    logger.info(`âœ… Tab 1 converted to IM spider for account ${accountId}`);

    // ä¿å­˜åˆ° Tab æ± 
    let pool = this.tabPools.get(accountId);
    if (!pool) {
      pool = {};
      this.tabPools.set(accountId, pool);
    }
    pool.im = tab.page;

    return tab.page;
  }

  /**
   * æ ¹æ®ä»»åŠ¡ç±»å‹ç¡®å®š Tab ç±»å‹
   */
  getTabTypeForTask(taskType) {
    const mapping = {
      // IM ç±»
      'crawl_direct_messages': TabType.SPIDER_IM,
      'crawl_conversations': TabType.SPIDER_IM,

      // å†…å®¹ç±»
      'crawl_comments': TabType.SPIDER_CONTENT,
      'crawl_discussions': TabType.SPIDER_CONTENT,
      'crawl_videos': TabType.SPIDER_CONTENT,

      // æ“ä½œç±»
      'send_reply': TabType.TEMPORARY_ACTION,
      'send_comment': TabType.TEMPORARY_ACTION,
      'send_direct_message': TabType.TEMPORARY_ACTION,
    };

    return mapping[taskType] || TabType.TEMPORARY_ACTION;
  }

  /**
   * ç­‰å¾… Tab é‡Šæ”¾
   */
  async waitForTabRelease(accountId, timeout = 10000) {
    const startTime = Date.now();
    while (Date.now() - startTime < timeout) {
      const tabCount = this.tabStateManager.getTabCount(accountId);
      if (tabCount < 3) {
        return true;
      }
      await new Promise(resolve => setTimeout(resolve, 500));
    }
    logger.warn(`Timeout waiting for tab release for account ${accountId}`);
    return false;
  }
}

// Tab ç±»å‹æšä¸¾
const TabType = {
  SPIDER_IM: 'spider_im',
  SPIDER_CONTENT: 'spider_content',
  TEMPORARY_ACTION: 'temporary',
};

module.exports = BrowserManager;
```

## ä½¿ç”¨ç¤ºä¾‹

### ç§ä¿¡çˆ¬å–ï¼ˆä½¿ç”¨ IM èœ˜è››ï¼ŒTab 1ï¼‰

```javascript
// packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js

async crawl() {
  try {
    // â­ è·å– IM èœ˜è››é¡µé¢ï¼ˆTab 1ï¼‰
    const page = await this.browserManager.getPageForTask(this.account.id, 'crawl_direct_messages');

    // é¡µé¢å·²ç»åœ¨ IM é¡µé¢ä¸Šäº†ï¼Œç›´æ¥çˆ¬å–
    const messages = await this.extractMessages(page);

    return messages;
  } catch (error) {
    logger.error('Failed to crawl direct messages:', error);
    throw error;
  }
}
```

### ä¼šè¯çˆ¬å–ï¼ˆå¤ç”¨ IM èœ˜è››ï¼ŒTab 1ï¼‰

```javascript
// packages/worker/src/platforms/douyin/crawl-conversations.js

async crawl() {
  try {
    // â­ å¤ç”¨åŒä¸€ä¸ª IM èœ˜è››é¡µé¢ï¼ˆTab 1ï¼‰
    const page = await this.browserManager.getPageForTask(this.account.id, 'crawl_conversations');

    // é¡µé¢å·²ç»åœ¨ IM é¡µé¢ä¸Šï¼Œç›´æ¥çˆ¬å–ä¼šè¯åˆ—è¡¨
    const conversations = await this.extractConversations(page);

    return conversations;
  } catch (error) {
    logger.error('Failed to crawl conversations:', error);
    throw error;
  }
}
```

### è¯„è®ºçˆ¬å–ï¼ˆä½¿ç”¨å†…å®¹èœ˜è››ï¼ŒTab 2ï¼‰

```javascript
// packages/worker/src/platforms/douyin/crawl-comments.js

async crawl() {
  try {
    // â­ è·å–å†…å®¹èœ˜è››é¡µé¢ï¼ˆTab 2ï¼‰
    const page = await this.browserManager.getPageForTask(this.account.id, 'crawl_comments');

    // é¡µé¢åœ¨ä½œå“åˆ—è¡¨é¡µï¼Œç‚¹å‡»è¿›å…¥ä½œå“è¯¦æƒ…
    await page.click('.work-item:first-child');
    await page.waitForTimeout(2000);

    // çˆ¬å–è¯„è®º
    const comments = await this.extractComments(page);

    return comments;
  } catch (error) {
    logger.error('Failed to crawl comments:', error);
    throw error;
  }
}
```

### è®¨è®ºçˆ¬å–ï¼ˆå¤ç”¨å†…å®¹èœ˜è››ï¼ŒTab 2ï¼‰

```javascript
// packages/worker/src/platforms/douyin/crawl-discussions.js

async crawl() {
  try {
    // â­ å¤ç”¨åŒä¸€ä¸ªå†…å®¹èœ˜è››é¡µé¢ï¼ˆTab 2ï¼‰
    const page = await this.browserManager.getPageForTask(this.account.id, 'crawl_discussions');

    // é¡µé¢åœ¨ä½œå“åˆ—è¡¨é¡µï¼Œç‚¹å‡»è¿›å…¥ä½œå“è¯¦æƒ…
    await page.click('.work-item:nth-child(2)');
    await page.waitForTimeout(2000);

    // çˆ¬å–è®¨è®º
    const discussions = await this.extractDiscussions(page);

    return discussions;
  } catch (error) {
    logger.error('Failed to crawl discussions:', error);
    throw error;
  }
}
```

### å‘é€å›å¤ï¼ˆä¸´æ—¶ Tab 3ï¼Œå®Œæˆåå…³é—­ï¼‰

```javascript
// packages/worker/src/platforms/douyin/send-reply.js

async sendReply(commentId, replyText) {
  let tempTab = null;

  try {
    // â­ åˆ›å»ºä¸´æ—¶æ“ä½œé¡µé¢ï¼ˆTab 3ï¼‰
    tempTab = await this.browserManager.getPageForTask(this.account.id, 'send_reply');

    const { tabId, page } = tempTab;

    // å¯¼èˆªåˆ°è¯„è®ºé¡µé¢
    await page.goto(`https://creator.douyin.com/comment/${commentId}`);

    // å‘é€å›å¤
    await page.fill('textarea', replyText);
    await page.click('button[type="submit"]');

    logger.info(`âœ… Reply sent successfully`);

    return { success: true };

  } catch (error) {
    logger.error('Failed to send reply:', error);
    return { success: false, error: error.message };

  } finally {
    // â­ å…³é—­ä¸´æ—¶ Tabï¼ˆæ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼‰
    if (tempTab && tempTab.tabId) {
      await this.browserManager.closeTemporaryActionPage(this.account.id, tempTab.tabId);
      logger.info(`ğŸ—‘ï¸  Temporary tab closed after reply task`);
    }
  }
}
```

## ä¼˜åŠ¿æ€»ç»“

### 1. èµ„æºæœ€ä¼˜ âœ…
- æ¯ä¸ªè´¦æˆ·å›ºå®š 2 ä¸ªé•¿æœŸ Tabï¼ˆIM + å†…å®¹ï¼‰
- ä¸´æ—¶æ“ä½œå®Œæˆåç«‹å³é‡Šæ”¾
- é¿å… Tab æ•°é‡æ— é™å¢é•¿

### 2. å¤ç”¨é«˜æ•ˆ âœ…
- ç§ä¿¡ + ä¼šè¯ å…±ç”¨ Tab 1
- è¯„è®º + è®¨è®º + è§†é¢‘ å…±ç”¨ Tab 2
- å‡å°‘é¡µé¢åˆ›å»ºå’Œé”€æ¯çš„å¼€é”€

### 3. èŒè´£æ¸…æ™° âœ…
- Tab 1: IM ç±»ä»»åŠ¡
- Tab 2: å†…å®¹ç±»ä»»åŠ¡
- Tab 3+: ä¸´æ—¶æ“ä½œ

### 4. ä»£ç ç®€æ´ âœ…
```javascript
// ç»Ÿä¸€æ¥å£ï¼Œè‡ªåŠ¨å¤ç”¨
const page = await browserManager.getPageForTask(accountId, taskType);
```

---

**æ–‡æ¡£æ—¶é—´**ï¼š2025-10-24 19:35
**æ–‡æ¡£ä½œè€…**ï¼šClaude Code
**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0
