# Worker-Master æ¶æ„ä¼˜åŒ– - èŒè´£åˆ†ç¦»å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ ä¼˜åŒ–èƒŒæ™¯

**é—®é¢˜å‘ç°**: PC IM ä¸­ä½œå“è¯„è®ºåªæ˜¾ç¤º 2 ä¸ªï¼Œä½†å®é™…æœ‰ 8 ä¸ªä½œå“æœ‰è¯„è®ºã€‚

**æ ¹æœ¬åŸå› **: Worker åœ¨ `is_new` å­—æ®µè®¾ç½®æ—¶æ··å…¥äº†ä¸šåŠ¡é€»è¾‘ï¼ˆ24å°æ—¶æ—¶æ•ˆæ€§åˆ¤æ–­ï¼‰ï¼Œå¯¼è‡´ï¼š
- Worker æ‰¿æ‹…äº†ä¸åº”è¯¥æ‰¿æ‹…çš„ä¸šåŠ¡èŒè´£
- Master æ— æ³•æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡éœ€æ±‚çµæ´»å¤„ç†æ•°æ®
- è¿åäº†**æ•°æ®å±‚**å’Œ**ä¸šåŠ¡å±‚**çš„èŒè´£åˆ†ç¦»åŸåˆ™

## ğŸ¯ æ¶æ„è®¾è®¡åŸåˆ™

### Worker å±‚èŒè´£
```
âœ… æ•°æ®æŠ“å–çš„å®Œæ•´æ€§
âœ… æ•°æ®å…³è”çš„æ­£ç¡®æ€§
âœ… åŸå§‹æ•°æ®çš„ä¼ è¾“
âŒ ä¸šåŠ¡é€»è¾‘åˆ¤æ–­ï¼ˆå·²è¯»/æœªè¯»ã€æ—¶æ•ˆæ€§ç­‰ï¼‰
```

### Master å±‚èŒè´£
```
âœ… ä¸šåŠ¡é€»è¾‘å¤„ç†
âœ… æ•°æ®è½¬æ¢å’Œæ˜ å°„
âœ… æ—¶æ•ˆæ€§åˆ¤æ–­
âœ… å·²è¯»/æœªè¯»çŠ¶æ€ç®¡ç†
```

## ğŸ”§ å®æ–½çš„ä¿®æ”¹

### ä¿®æ”¹ 1: Worker è¯„è®ºå¤„ç† (platform.js)

**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/platform.js`

**ä¿®æ”¹å‰** (Line 1168-1181):
```javascript
// âŒ é—®é¢˜ä»£ç 
const createIsNewFlag = (createdAt) => {
  const now = Math.floor(Date.now() / 1000);
  const ageSeconds = now - createdAt;
  const oneDaySeconds = 24 * 60 * 60;  // 86400
  return ageSeconds < oneDaySeconds;  // Worker åˆ¤æ–­æ—¶æ•ˆæ€§
};

const commentsWithIds = newComments.map((comment) => ({
  id: comment.platform_comment_id,
  account_id: account.id,
  is_new: createIsNewFlag(comment.create_time),  // åŸºäºæ—¶é—´åˆ¤æ–­
  push_count: 0,
  ...comment,
}));
```

**ä¿®æ”¹å** (Line 1168-1178):
```javascript
// âœ… ä¼˜åŒ–ä»£ç 
// is_new è¡¨ç¤º"é¦–æ¬¡æŠ“å–"ï¼Œè€Œä¸æ˜¯åŸºäºæ—¶é—´åˆ¤æ–­
// Worker åªè´Ÿè´£æ•°æ®å®Œæ•´æ€§ï¼Œä¸å…³å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆæ—¶æ•ˆæ€§ç”± Master å¤„ç†ï¼‰
// ç”±äº newComments å·²ç»æ˜¯é€šè¿‡ cacheManager.filterNewComments() è¿‡æ»¤çš„é¦–æ¬¡æŠ“å–æ•°æ®
// æ‰€ä»¥è¿™é‡Œçš„ is_new åº”è¯¥å…¨éƒ¨ä¸º true
const commentsWithIds = newComments.map((comment) => ({
  id: comment.platform_comment_id,
  account_id: account.id,
  is_new: true,  // âœ… é¦–æ¬¡æŠ“å–çš„è¯„è®º is_new = true
  push_count: 0,
  ...comment,
}));
```

**è¯­ä¹‰å˜åŒ–**:
- **æ—§è¯­ä¹‰**: `is_new` = "24å°æ—¶å†…åˆ›å»ºçš„è¯„è®º"
- **æ–°è¯­ä¹‰**: `is_new` = "é¦–æ¬¡æŠ“å–åˆ°çš„è¯„è®º"

### ä¿®æ”¹ 2: Worker ç§ä¿¡å¤„ç† (crawl-direct-messages-v2.js)

**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js`

**ä¿®æ”¹å‰** (Line 1122):
```javascript
is_new: (Date.now() - msg.created_at * 1000) < 24 * 60 * 60 * 1000,  // âŒ æ—¶é—´åˆ¤æ–­
```

**ä¿®æ”¹å** (Line 1122):
```javascript
is_new: true,  // âœ… é¦–æ¬¡æŠ“å–çš„æ¶ˆæ¯ is_new = trueï¼ˆæ—¶æ•ˆæ€§ç”± Master åˆ¤æ–­ï¼‰
```

### ä¿®æ”¹ 3: Worker ç§ä¿¡å¤„ç† (platform.js - crawlDirectMessages)

**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/platform.js`

**ä¿®æ”¹å‰** (Line 941-961):
```javascript
const createIsNewFlag = (createdAt) => {
  const now = Math.floor(Date.now() / 1000);
  const ageSeconds = now - createdAt;
  const oneDaySeconds = 24 * 60 * 60;
  return ageSeconds < oneDaySeconds;
};

const directMessages = rawDirectMessages.map((msg) => {
  // ...
  return {
    ...msg,
    account_id: account.id,
    is_read: false,
    created_at: createdAt,
    is_new: createIsNewFlag(createdAt),  // âŒ æ—¶é—´åˆ¤æ–­
    push_count: 0,
  };
});
```

**ä¿®æ”¹å** (Line 941-956):
```javascript
// âœ… ä¼˜åŒ–: is_new è¡¨ç¤º"é¦–æ¬¡æŠ“å–"ï¼Œè€Œä¸æ˜¯åŸºäºæ—¶é—´åˆ¤æ–­
// Worker åªè´Ÿè´£æ•°æ®å®Œæ•´æ€§ï¼Œä¸å…³å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆæ—¶æ•ˆæ€§ç”± Master å¤„ç†ï¼‰
const directMessages = rawDirectMessages.map((msg) => {
  // ...
  return {
    ...msg,
    account_id: account.id,
    is_read: false,
    created_at: createdAt,
    is_new: true,  // âœ… é¦–æ¬¡æŠ“å–çš„ç§ä¿¡ is_new = true
    push_count: 0,
  };
});
```

### ä¿®æ”¹ 4: Master ä¸šåŠ¡é€»è¾‘è°ƒæ•´ (im-websocket-server.js)

**æ–‡ä»¶**: `packages/master/src/communication/im-websocket-server.js`

**ä¿®æ”¹å‰** (Line 318):
```javascript
unreadCount: contentComments.filter(c => c.isNew).length,  // âŒ åŸºäº isNewï¼ˆå¯èƒ½ä¸º falseï¼‰
```

**ä¿®æ”¹å** (Line 318):
```javascript
unreadCount: contentComments.filter(c => c.isHandled === undefined || !c.isHandled).length,  // âœ… åŸºäº isHandled
```

**ä¿®æ”¹å‰** (Line 464):
```javascript
unreadCount += commentsList.filter(c => c.isNew).length;  // âŒ åŸºäº isNew
```

**ä¿®æ”¹å** (Line 464):
```javascript
unreadCount += commentsList.filter(c => c.isHandled === undefined || !c.isHandled).length;  // âœ… åŸºäº isHandled
```

## ğŸ“Š ä¼˜åŒ–æ•ˆæœ

### Worker ç«¯
- âœ… **èŒè´£æ¸…æ™°**: åªè´Ÿè´£æ•°æ®æŠ“å–ï¼Œä¸å…³å¿ƒä¸šåŠ¡é€»è¾‘
- âœ… **è¯­ä¹‰æ˜ç¡®**: `is_new` è¡¨ç¤º"é¦–æ¬¡æŠ“å–"ï¼Œè€Œä¸æ˜¯"æ—¶æ•ˆæ€§"
- âœ… **ä»£ç ç®€åŒ–**: ç§»é™¤äº† 3 å¤„ `createIsNewFlag()` å‡½æ•°å’Œæ—¶é—´åˆ¤æ–­é€»è¾‘

### Master ç«¯
- âœ… **ä¸šåŠ¡æ§åˆ¶**: å®Œå…¨æŒæ§"æœªè¯»"çš„å®šä¹‰ï¼ˆå¯ä»¥åŸºäº `isHandled` æˆ–æ—¶é—´ï¼‰
- âœ… **çµæ´»æ‰©å±•**: æœªæ¥å¯ä»¥æ ¹æ®éœ€æ±‚è°ƒæ•´æœªè¯»é€»è¾‘ï¼Œæ— éœ€ä¿®æ”¹ Worker
- âœ… **æ•°æ®å®Œæ•´**: æ‰€æœ‰æŠ“å–åˆ°çš„æ•°æ®éƒ½èƒ½æ­£å¸¸æ˜¾ç¤ºï¼ˆä» 2/8 â†’ 8/8ï¼‰

### PC IM ç«¯
- âœ… **æ˜¾ç¤ºæ­£ç¡®**: æ‰€æœ‰æœ‰è¯„è®ºçš„ä½œå“éƒ½èƒ½æ­£ç¡®æ˜¾ç¤º
- âœ… **ä½“éªŒä¼˜åŒ–**: ç”¨æˆ·å¯ä»¥çœ‹åˆ°æ‰€æœ‰è¯„è®ºæ•°æ®ï¼Œä¸å†å— 24 å°æ—¶é™åˆ¶

## ğŸ—ï¸ æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Worker å±‚ï¼ˆæ•°æ®å±‚ï¼‰                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ èŒè´£ï¼š                                                        â”‚
â”‚ â€¢ æŠ“å–åŸå§‹æ•°æ®ï¼ˆè¯„è®ºã€ç§ä¿¡ã€ä½œå“ï¼‰                              â”‚
â”‚ â€¢ æ•°æ®å®Œæ•´æ€§éªŒè¯                                              â”‚
â”‚ â€¢ æ•°æ®å…³è”æ­£ç¡®æ€§                                              â”‚
â”‚ â€¢ é¦–æ¬¡æŠ“å–æ ‡è®° (is_new = true)                                â”‚
â”‚                                                               â”‚
â”‚ ä¸è´Ÿè´£ï¼š                                                      â”‚
â”‚ âŒ ä¸šåŠ¡é€»è¾‘ï¼ˆå·²è¯»/æœªè¯»ã€æ—¶æ•ˆæ€§ï¼‰                               â”‚
â”‚ âŒ æ•°æ®è¿‡æ»¤ï¼ˆåŸºäºä¸šåŠ¡è§„åˆ™ï¼‰                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                    å®Œæ•´çš„åŸå§‹æ•°æ®
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Master å±‚ï¼ˆä¸šåŠ¡å±‚ï¼‰                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ èŒè´£ï¼š                                                        â”‚
â”‚ â€¢ æ¥æ”¶ Worker æ•°æ®å¹¶å­˜å…¥ DataStore                            â”‚
â”‚ â€¢ ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼š                                              â”‚
â”‚   - å·²è¯»/æœªè¯»åˆ¤æ–­ (isHandled)                                â”‚
â”‚   - æ—¶æ•ˆæ€§è¿‡æ»¤ï¼ˆå¦‚éœ€è¦ï¼‰                                       â”‚
â”‚   - unreadCount è®¡ç®—                                         â”‚
â”‚ â€¢ æ•°æ®è½¬æ¢å’Œæ˜ å°„                                              â”‚
â”‚ â€¢ ä¸º PC IM æä¾›ä¸šåŠ¡æ•°æ®                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                    ä¸šåŠ¡å¤„ç†åçš„æ•°æ®
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PC IM å±‚ï¼ˆå±•ç¤ºå±‚ï¼‰                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ˜¾ç¤ºæ‰€æœ‰æœ‰è¯„è®ºçš„ä½œå“                                         â”‚
â”‚ â€¢ æ˜¾ç¤ºæœªè¯»æ•°é‡                                                â”‚
â”‚ â€¢ æä¾›ç”¨æˆ·äº¤äº’                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ è®¾è®¡åŸåˆ™æ€»ç»“

### 1. èŒè´£å•ä¸€åŸåˆ™ (SRP)
æ¯ä¸€å±‚åªè´Ÿè´£è‡ªå·±çš„èŒè´£ï¼š
- Worker: æ•°æ®æŠ“å–
- Master: ä¸šåŠ¡é€»è¾‘
- PC IM: æ•°æ®å±•ç¤º

### 2. å…³æ³¨ç‚¹åˆ†ç¦» (SoC)
- æ•°æ®å±‚ä¸å…³å¿ƒä¸šåŠ¡é€»è¾‘
- ä¸šåŠ¡å±‚ä¸å…³å¿ƒæ•°æ®æ¥æº
- å±•ç¤ºå±‚ä¸å…³å¿ƒä¸šåŠ¡å®ç°

### 3. å¼€é—­åŸåˆ™ (OCP)
- Master å¯ä»¥éšæ—¶è°ƒæ•´ä¸šåŠ¡é€»è¾‘ï¼Œæ— éœ€ä¿®æ”¹ Worker
- Worker å¯ä»¥æ‰©å±•æ–°çš„æ•°æ®å­—æ®µï¼Œæ— éœ€ä¿®æ”¹ Masterï¼ˆåªè¦ä¿æŒå…¼å®¹ï¼‰

## ğŸ“ æœªæ¥æ‰©å±•å»ºè®®

### é€‰é¡¹ 1: Master ç«¯å®ç°æ—¶æ•ˆæ€§åˆ¤æ–­ï¼ˆå¦‚éœ€è¦ï¼‰

å¦‚æœæœªæ¥éœ€è¦åŒºåˆ†"æœ€è¿‘ 24 å°æ—¶çš„è¯„è®º"ï¼Œå¯ä»¥åœ¨ Master çš„ IM æœåŠ¡å™¨ä¸­æ·»åŠ ï¼š

```javascript
// packages/master/src/communication/im-websocket-server.js
const isRecent = (createdAt) => {
  const now = Math.floor(Date.now() / 1000);
  const ageSeconds = now - createdAt;
  const oneDaySeconds = 24 * 60 * 60;
  return ageSeconds < oneDaySeconds;
};

// åœ¨ getTopicsFromDataStore ä¸­ä½¿ç”¨
const topic = {
  // ...
  unreadCount: contentComments.filter(c =>
    (!c.isHandled || c.isHandled === undefined) &&
    isRecent(c.createdAt)  // å¯é€‰çš„æ—¶æ•ˆæ€§è¿‡æ»¤
  ).length,
};
```

### é€‰é¡¹ 2: æä¾›å¤šç§è¿‡æ»¤æ¨¡å¼

Master å¯ä»¥æ ¹æ® PC IM çš„è¯·æ±‚å‚æ•°ï¼Œæä¾›ä¸åŒçš„è¿‡æ»¤æ¨¡å¼ï¼š
- `mode=all`: æ˜¾ç¤ºæ‰€æœ‰è¯„è®º
- `mode=recent`: åªæ˜¾ç¤ºæœ€è¿‘ 24 å°æ—¶
- `mode=unhandled`: åªæ˜¾ç¤ºæœªå¤„ç†çš„

## âœ… éªŒè¯æ¸…å•

- [x] Worker ç«¯ç§»é™¤æ‰€æœ‰æ—¶é—´åˆ¤æ–­é€»è¾‘
- [x] Worker çš„ `is_new` æ”¹ä¸ºè¡¨ç¤º"é¦–æ¬¡æŠ“å–"
- [x] Master ç«¯è°ƒæ•´ `unreadCount` è®¡ç®—é€»è¾‘
- [x] æ‰€æœ‰æœ‰è¯„è®ºçš„ä½œå“éƒ½èƒ½åœ¨ PC IM ä¸­æ˜¾ç¤º
- [x] æ¶æ„èŒè´£åˆ†ç¦»æ¸…æ™°
- [x] ä»£ç æ³¨é‡Šå®Œæ•´

## ğŸ“… å®Œæˆæ—¶é—´

**ä¼˜åŒ–æ—¥æœŸ**: 2025-10-31
**ä¿®æ”¹æ–‡ä»¶**: 3 ä¸ª
**ä»£ç è¡Œæ•°**: ~30 è¡Œ
**å½±å“èŒƒå›´**: Worker â†’ Master â†’ PC IM å…¨é“¾è·¯

---

**æŠ¥å‘Šäºº**: Claude Code
**çŠ¶æ€**: âœ… å·²å®Œæˆ
