# 账户名称显示优化 - 使用平台昵称

**日期**: 2025-11-05
**问题**: IM客户端左侧账户列表和顶部账户名称显示的是账户ID（如 `acc-98296c87-2e42-447a-9d8b-8be008ddb6e4`），而不是平台昵称
**需求**: 应该显示账户的平台昵称（如"哈尔滨临终关怀医院"）

---

## 问题描述

### 当前显示效果

- **左侧账户列表**: 显示 `acc-98296c87-2e42-447a-9d8b-8be008ddb6e4`
- **顶部账户名称**: 显示 `acc-98296c87-2e42-447a-9d8b-8be008ddb6e4`

### 期望显示效果

- **左侧账户列表**: 显示平台昵称（如"哈尔滨临终关怀医院"）
- **顶部账户名称**: 显示平台昵称（如"哈尔滨临终关怀医院"）

---

## 根本原因

### 数据流分析

```
数据库 (accounts 表)
  ↓
  account_name: "哈尔滨临终关怀医院" ✅ 存在
  ↓
Worker 推送数据到 Master
  ↓
DataStore.updateAccountData()
  ↓
  accountData = {
    accountId: "acc-98296c87...",
    platform: "douyin",
    lastUpdate: 1234567890,
    data: { comments, messages, ... }
  }
  ↓
  ❌ 没有包含 accountName 字段
  ↓
getChannelsFromDataStore()
  ↓
  name: accountData.accountName || accountId
  ↓
  ❌ accountData.accountName = undefined
  ↓
  name: accountId  // 显示账户ID
```

**问题**: DataStore 中没有存储 `accountName` 字段，导致 `getChannelsFromDataStore()` 只能使用 `accountId` 作为 fallback。

---

## 修复方案

### 在 getChannelsFromDataStore() 中查询数据库

**文件**: `packages/master/src/communication/im-websocket-server.js`

**修改位置**: Lines 248-271

**修改前**:
```javascript
// 遍历 DataStore 中的所有账户
for (const [accountId, accountData] of this.dataStore.accounts) {
  const dataObj = accountData.data || accountData;

  // 计算未读消息数
  const unreadCount = this.calculateUnreadCount(dataObj);

  // 查找最新消息
  const lastMessage = this.findLastMessage(dataObj);

  const channel = {
    id: accountId,
    name: accountData.accountName || accountId,  // ❌ accountData.accountName 不存在
    avatar: accountData.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${accountId}`,
    description: accountData.platform || '',
    lastMessage: lastMessage?.content || '',
    lastMessageTime: lastMessage?.timestamp || accountData.lastUpdate || Date.now(),
    unreadCount: unreadCount,
    messageCount: dataObj.messages?.length || 0,
    isPinned: false,
    enabled: true
  };

  channels.push(channel);
}
```

**修改后**:
```javascript
// 遍历 DataStore 中的所有账户
for (const [accountId, accountData] of this.dataStore.accounts) {
  const dataObj = accountData.data || accountData;

  // ✅ 从数据库查询账户信息（获取平台昵称）
  const accountInfo = this.accountDAO.getAccountById(accountId);
  const accountName = accountInfo?.account_name || accountId;
  const avatar = accountInfo?.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${accountId}`;

  // 计算未读消息数
  const unreadCount = this.calculateUnreadCount(dataObj);

  // 查找最新消息
  const lastMessage = this.findLastMessage(dataObj);

  const channel = {
    id: accountId,
    name: accountName,  // ✅ 使用数据库中的平台昵称
    avatar: avatar,     // ✅ 使用数据库中的头像
    description: accountData.platform || '',
    lastMessage: lastMessage?.content || '',
    lastMessageTime: lastMessage?.timestamp || accountData.lastUpdate || Date.now(),
    unreadCount: unreadCount,
    messageCount: dataObj.messages?.length || 0,
    isPinned: false,
    enabled: true
  };

  channels.push(channel);
}
```

---

## 修复后的数据流

```
数据库 (accounts 表)
  ↓
  account_name: "哈尔滨临终关怀医院" ✅
  avatar: "https://..." ✅
  ↓
getChannelsFromDataStore()
  ↓
  accountInfo = this.accountDAO.getAccountById(accountId)
  ↓
  accountName = accountInfo.account_name
  avatar = accountInfo.avatar
  ↓
channel = {
  id: accountId,
  name: "哈尔滨临终关怀医院",  // ✅ 显示平台昵称
  avatar: "https://...",         // ✅ 使用真实头像
  ...
}
  ↓
WebSocket 推送到客户端
  ↓
IM 客户端显示
  ↓
✅ 左侧列表: "哈尔滨临终关怀医院"
✅ 顶部标题: "哈尔滨临终关怀医院"
```

---

## 优点

1. **✅ 用户体验好**: 显示易读的平台昵称，而不是长串的账户ID
2. **✅ 数据准确**: 直接从数据库读取最新的账户信息
3. **✅ 支持头像**: 同时获取账户头像URL
4. **✅ 实现简单**: 只需要在一个地方查询数据库
5. **✅ 性能可接受**:
   - 查询发生在 `getChannelsFromDataStore()` 中
   - 每次客户端连接或请求频道列表时才查询
   - 查询次数 = 账户数量（通常 < 10）
   - SQLite 主键查询非常快（< 1ms）

---

## 潜在优化（可选）

### 方案 1: 在 DataStore 中缓存账户信息

**思路**: 修改 `DataStore.updateAccountData()` 方法，从数据库查询并缓存账户信息。

**优点**: 避免每次构建频道列表时查询数据库
**缺点**: 增加复杂度，需要同步账户信息更新

### 方案 2: Worker 推送时包含账户信息

**思路**: Worker 在推送数据快照时，包含 `accountName` 和 `avatar` 字段。

**优点**: 减少 Master 的数据库查询
**缺点**: Worker 需要访问 Master 数据库或通过 API 获取账户信息

### 当前方案的选择理由

**当前方案（在 getChannelsFromDataStore 中查询）最合适**，因为：
- ✅ 实现简单，修改最小
- ✅ 数据始终最新（每次都从数据库读取）
- ✅ 性能足够（账户数量少，查询快）
- ✅ 不增加架构复杂度

---

## 测试验证

### 测试步骤

1. 重启 Master 服务器
2. 打开 IM 客户端
3. 观察左侧账户列表
4. 观察顶部账户名称

### 预期结果

- **左侧账户列表**: 显示平台昵称（如"哈尔滨临终关怀医院"）
- **顶部账户名称**: 显示平台昵称（如"哈尔滨临终关怀医院"）
- **头像**: 显示账户的真实头像（如果有）

### 验证数据

查看数据库中的 `account_name` 字段：

```sql
SELECT id, account_name, avatar FROM accounts;
```

---

## 相关文件

1. **packages/master/src/communication/im-websocket-server.js** - 修改 `getChannelsFromDataStore()` 方法
2. **packages/master/src/database/account-dao.js** - 提供 `getAccountById()` 方法
3. **packages/master/src/database/schema.sql** - accounts 表定义（包含 account_name 字段）

---

## 总结

### 修改概要

| 修改项 | 内容 | 影响 |
|-------|------|-----|
| 修改文件 | im-websocket-server.js | 1 个文件 |
| 修改行数 | 约 5 行 | 新增 3 行，修改 2 行 |
| 新增查询 | accountDAO.getAccountById() | 每次构建频道列表时查询 |
| 性能影响 | 可忽略 | SQLite 主键查询 < 1ms |

### 功能改进

- ✅ 显示平台昵称代替账户ID
- ✅ 使用真实头像代替默认头像
- ✅ 提升用户体验
- ✅ 数据始终最新

---

**修改日期**: 2025-11-05
**修改人**: Claude Code
**状态**: ✅ 已完成
**测试**: 等待用户验证

