# å›å¤éªŒè¯æœºåˆ¶è®¾è®¡æ–¹æ¡ˆ

## é—®é¢˜èƒŒæ™¯

å½“å‰ç³»ç»Ÿä¸­ï¼Œå›å¤åŠŸèƒ½ï¼ˆç§ä¿¡å›å¤ã€è¯„è®ºå›å¤ï¼‰åªèƒ½ç¡®è®¤ DOM æ“ä½œæˆåŠŸï¼Œä½†æ— æ³•éªŒè¯å›å¤æ˜¯å¦çœŸæ­£è¢«å¹³å°æ¥æ”¶å¹¶æ˜¾ç¤ºã€‚ç”¨æˆ·å¸Œæœ›ä»å¸¸é©»ä»»åŠ¡ï¼ˆçˆ¬è™«ï¼‰ä¸­æ£€æµ‹åˆ°è‡ªå·±å‘é€çš„å›å¤ï¼Œå½¢æˆé—­ç¯éªŒè¯ã€‚

## æ ¸å¿ƒæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Master    â”‚ â”€â”€â”€â”€> â”‚ReplyExecutor â”‚ â”€â”€â”€â”€> â”‚  Platform   â”‚
â”‚   (å‘é€è¯·æ±‚)  â”‚         â”‚  (æ‰§è¡Œå›å¤)   â”‚         â”‚ (DOM æ“ä½œ) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚                       â”‚
                                â”‚ æ³¨å†Œå¾…éªŒè¯æ ‡è®°          â”‚ success
                                â†“                       â†“
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚PendingRepliesâ”‚ <â”€â”€â”€â”€â”€â”€ â”‚ è¿”å›ç»“æœ    â”‚
                        â”‚   (ç­‰å¾…é˜Ÿåˆ—)  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ çˆ¬è™«æŠ“å–æ—¶åŒ¹é…
                                â†“
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚Crawler-Messagesâ”‚ â”€â”€â”€> â”‚ DataManager â”‚
                        â”‚   (æŠ“å–ç§ä¿¡)   â”‚         â”‚ (åŒ¹é…éªŒè¯)  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                         â”‚
                                                         â”‚ åŒ¹é…æˆåŠŸ
                                                         â†“
                                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                 â”‚   Master    â”‚
                                                 â”‚ (çŠ¶æ€æ›´æ–°)  â”‚
                                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ–¹æ¡ˆè®¾è®¡

### æ–¹æ¡ˆ 1ï¼šå†…å®¹ + æ—¶é—´åŒ¹é…ï¼ˆæ¨èï¼‰

#### æ ¸å¿ƒé€»è¾‘

1. **å‘é€å›å¤æ—¶è®°å½•**ï¼š
   ```javascript
   {
     reply_id: "reply_123",
     account_id: "acc-xxx",
     target_type: "direct_message" | "comment",
     target_id: "conversation_id æˆ– comment_id",
     reply_content: "ä½ å¥½å‘€",
     timestamp: 1732435200000,
     expiry: 1732435500000  // 5åˆ†é’Ÿåè¿‡æœŸ
   }
   ```

2. **çˆ¬è™«æŠ“å–æ—¶åŒ¹é…**ï¼š
   - æ£€æŸ¥æ¶ˆæ¯æ–¹å‘ï¼š`direction === 'send'`ï¼ˆç§ä¿¡ï¼‰æˆ– `author_id === self_id`ï¼ˆè¯„è®ºï¼‰
   - å†…å®¹å®Œå…¨åŒ¹é…ï¼š`content === reply_content`
   - æ—¶é—´æ¥è¿‘ï¼š`|message_time - reply_timestamp| < 5åˆ†é’Ÿ`
   - ç›®æ ‡åŒ¹é…ï¼š`conversation_id` æˆ– `parent_comment_id` åŒ¹é…

3. **éªŒè¯æˆåŠŸå**ï¼š
   - ä»å¾…éªŒè¯é˜Ÿåˆ—ä¸­ç§»é™¤
   - é€šçŸ¥ Master æ›´æ–°çŠ¶æ€
   - è®°å½•çœŸå®çš„ `platform_reply_id`

#### å®ç°ä½ç½®

**1. åˆ›å»º PendingRepliesManagerï¼ˆå¾…éªŒè¯å›å¤ç®¡ç†å™¨ï¼‰**

ä½ç½®ï¼š`packages/worker/src/services/pending-replies-manager.js`

```javascript
class PendingRepliesManager {
  constructor() {
    this.pendingReplies = new Map(); // account_id -> Array<PendingReply>
  }

  /**
   * æ·»åŠ å¾…éªŒè¯å›å¤
   */
  add(accountId, reply) {
    if (!this.pendingReplies.has(accountId)) {
      this.pendingReplies.set(accountId, []);
    }

    const pending = {
      ...reply,
      createdAt: Date.now(),
      expiry: Date.now() + 5 * 60 * 1000  // 5åˆ†é’Ÿæœ‰æ•ˆæœŸ
    };

    this.pendingReplies.get(accountId).push(pending);
    this.cleanup(accountId);  // æ¸…ç†è¿‡æœŸé¡¹
  }

  /**
   * æŸ¥æ‰¾åŒ¹é…çš„å¾…éªŒè¯å›å¤
   */
  findMatch(accountId, crawledItem) {
    const replies = this.pendingReplies.get(accountId) || [];

    for (const pending of replies) {
      // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
      if (Date.now() > pending.expiry) continue;

      // æ£€æŸ¥ç±»å‹
      if (pending.target_type !== crawledItem.type) continue;

      // å†…å®¹åŒ¹é…
      if (pending.reply_content !== crawledItem.content) continue;

      // æ–¹å‘åŒ¹é…ï¼ˆç§ä¿¡ï¼šsendï¼Œè¯„è®ºï¼šselfï¼‰
      if (crawledItem.type === 'direct_message' && crawledItem.direction !== 'send') continue;
      if (crawledItem.type === 'comment' && crawledItem.author_id !== crawledItem.self_id) continue;

      // ç›®æ ‡åŒ¹é…
      if (pending.target_id && pending.target_id !== crawledItem.target_id) continue;

      // æ—¶é—´æ¥è¿‘ï¼ˆ5åˆ†é’Ÿå†…ï¼‰
      const timeDiff = Math.abs(crawledItem.timestamp - pending.timestamp);
      if (timeDiff > 5 * 60 * 1000) continue;

      // âœ… åŒ¹é…æˆåŠŸ
      return pending;
    }

    return null;
  }

  /**
   * ç§»é™¤å·²éªŒè¯çš„å›å¤
   */
  remove(accountId, replyId) {
    const replies = this.pendingReplies.get(accountId) || [];
    const filtered = replies.filter(r => r.reply_id !== replyId);
    this.pendingReplies.set(accountId, filtered);
  }

  /**
   * æ¸…ç†è¿‡æœŸé¡¹
   */
  cleanup(accountId) {
    const replies = this.pendingReplies.get(accountId) || [];
    const now = Date.now();
    const active = replies.filter(r => r.expiry > now);
    this.pendingReplies.set(accountId, active);
  }
}

module.exports = PendingRepliesManager;
```

**2. ä¿®æ”¹ ReplyExecutorï¼Œè®°å½•å¾…éªŒè¯å›å¤**

ä½ç½®ï¼š`packages/worker/src/handlers/reply-executor.js`

```javascript
const PendingRepliesManager = require('../services/pending-replies-manager');

class ReplyExecutor {
  constructor(platformManager, browserManager, socketClient) {
    // ... ç°æœ‰ä»£ç 
    this.pendingRepliesManager = new PendingRepliesManager();
  }

  async executeReply(replyRequest) {
    // ... ç°æœ‰ä»£ç ï¼ˆæ‰§è¡Œå›å¤ï¼‰

    if (result.success) {
      // âœ… æ³¨å†Œå¾…éªŒè¯å›å¤
      this.pendingRepliesManager.add(account_id, {
        reply_id,
        account_id,
        target_type,
        target_id: conversation_id || target_id,
        reply_content,
        timestamp: Date.now(),
      });

      logger.info(`âœ… Reply sent and registered for verification: ${reply_id}`);
    }

    // ... è¿”å›ç»“æœ
  }

  /**
   * è·å– PendingRepliesManager å®ä¾‹ï¼ˆä¾›çˆ¬è™«ä½¿ç”¨ï¼‰
   */
  getPendingRepliesManager() {
    return this.pendingRepliesManager;
  }
}
```

**3. ä¿®æ”¹çˆ¬è™«ï¼Œåœ¨æŠ“å–æ—¶éªŒè¯å›å¤**

**ç§ä¿¡çˆ¬è™«**ï¼š`packages/worker/src/platforms/douyin/crawler-messages.js`

```javascript
// åœ¨ extractMessagesFromVirtualList å‡½æ•°ä¸­ï¼Œæå–æ¶ˆæ¯åæ·»åŠ éªŒè¯é€»è¾‘

function extractMessagesFromVirtualList(page, pendingRepliesManager, accountId) {
  // ... ç°æœ‰æå–é€»è¾‘

  messages.forEach(msg => {
    // âœ… æ£€æŸ¥æ˜¯å¦ä¸ºå¾…éªŒè¯å›å¤
    if (msg.direction === 'send') {
      const matched = pendingRepliesManager.findMatch(accountId, {
        type: 'direct_message',
        content: msg.content,
        direction: msg.direction,
        target_id: msg.conversation_id,
        timestamp: msg.timestamp,
      });

      if (matched) {
        logger.info(`ğŸ¯ Found sent reply match!`, {
          reply_id: matched.reply_id,
          platform_message_id: msg.message_id,
          content: msg.content.substring(0, 30),
        });

        // é€šçŸ¥ DataManager è®°å½•åŒ¹é…
        msg._verified_reply_id = matched.reply_id;
        msg._verified_at = Date.now();

        // ä»å¾…éªŒè¯é˜Ÿåˆ—ä¸­ç§»é™¤
        pendingRepliesManager.remove(accountId, matched.reply_id);
      }
    }
  });

  return messages;
}
```

**è¯„è®ºçˆ¬è™«**ï¼š`packages/worker/src/platforms/douyin/crawler-comments.js`

ç±»ä¼¼åœ°åœ¨è¯„è®ºæŠ“å–åæ·»åŠ éªŒè¯é€»è¾‘ã€‚

**4. DataManager å¤„ç†éªŒè¯ç»“æœå¹¶é€šçŸ¥ Master**

ä½ç½®ï¼š`packages/worker/src/platforms/douyin/data-manager.js`

```javascript
async addMessages(messages, accountId) {
  // ... ç°æœ‰ä»£ç 

  for (const msg of messages) {
    // âœ… æ£€æŸ¥æ˜¯å¦ä¸ºå·²éªŒè¯çš„å›å¤
    if (msg._verified_reply_id) {
      logger.info(`âœ… Verified reply detected: ${msg._verified_reply_id}`);

      // é€šçŸ¥ Master å›å¤éªŒè¯æˆåŠŸ
      this.notifyReplyVerified({
        reply_id: msg._verified_reply_id,
        platform_reply_id: msg.message_id,
        platform_message_id: msg.message_id,
        verified_at: msg._verified_at,
        content: msg.content,
      });
    }

    // ... ç»§ç»­æ­£å¸¸å¤„ç†
  }
}

/**
 * é€šçŸ¥ Master å›å¤å·²éªŒè¯
 */
notifyReplyVerified(verificationData) {
  if (this.socketClient && this.socketClient.socket) {
    this.socketClient.socket.emit('worker:reply:verified', {
      account_id: this.accountId,
      platform: this.platform,
      ...verificationData,
    });
  }
}
```

---

## ä½¿ç”¨æµç¨‹

### 1. å‘é€å›å¤

```javascript
// Master å‘é€å›å¤è¯·æ±‚
socket.emit('master:reply:request', {
  reply_id: 'reply_123',
  account_id: 'acc-xxx',
  target_type: 'direct_message',
  conversation_id: 'conv_456',
  reply_content: 'ä½ å¥½å‘€',
});
```

### 2. Worker æ‰§è¡Œå›å¤å¹¶æ³¨å†ŒéªŒè¯

```javascript
// ReplyExecutor
await platformInstance.replyToDirectMessage(...);
pendingRepliesManager.add(account_id, {...});  // âœ… æ³¨å†Œå¾…éªŒè¯
socket.emit('worker:reply:result', { status: 'success' });
```

### 3. çˆ¬è™«æŠ“å–å¹¶éªŒè¯

```javascript
// 5-30ç§’åï¼Œçˆ¬è™«æŠ“å–
const messages = await crawlDirectMessages(...);

messages.forEach(msg => {
  if (msg.direction === 'send') {
    const matched = pendingRepliesManager.findMatch(...);  // âœ… åŒ¹é…éªŒè¯
    if (matched) {
      msg._verified_reply_id = matched.reply_id;
    }
  }
});
```

### 4. DataManager é€šçŸ¥ Master

```javascript
// DataManager
socket.emit('worker:reply:verified', {
  reply_id: 'reply_123',
  platform_reply_id: '7123456789',  // âœ… çœŸå®çš„å¹³å° ID
  verified_at: 1732435300000,
});
```

### 5. Master æ›´æ–°å›å¤çŠ¶æ€

```javascript
// Master ç›‘å¬éªŒè¯ç»“æœ
socket.on('worker:reply:verified', (data) => {
  // æ›´æ–° replies è¡¨
  UPDATE replies
  SET status = 'verified',
      platform_reply_id = '7123456789',
      verified_at = NOW()
  WHERE reply_id = 'reply_123';
});
```

---

## çŠ¶æ€æµè½¬

```
pending (å¾…å‘é€)
  â†“
sending (å‘é€ä¸­)
  â†“
sent (å·²å‘é€ï¼Œç­‰å¾…éªŒè¯)  â† ReplyExecutor è¿”å› success
  â†“
verified (å·²éªŒè¯)        â† çˆ¬è™«åŒ¹é…æˆåŠŸï¼Œè·å¾—çœŸå® platform_reply_id
```

---

## é…ç½®å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `REPLY_VERIFICATION_TIMEOUT` | 5åˆ†é’Ÿ | å¾…éªŒè¯å›å¤çš„æœ‰æ•ˆæœŸ |
| `CONTENT_MATCH_EXACT` | true | æ˜¯å¦è¦æ±‚å†…å®¹å®Œå…¨åŒ¹é… |
| `TIME_TOLERANCE` | 5åˆ†é’Ÿ | æ—¶é—´åŒ¹é…å®¹å·® |

---

## è¾¹ç•Œæƒ…å†µå¤„ç†

### 1. å›å¤å‘é€å 5 åˆ†é’Ÿå†…æœªè¢«æŠ“å–

- å¾…éªŒè¯å›å¤è‡ªåŠ¨è¿‡æœŸ
- çŠ¶æ€ä¿æŒä¸º `sent`ï¼ˆæœªéªŒè¯ï¼‰
- ä¸å½±å“åç»­çˆ¬è™«

### 2. çŸ­æ—¶é—´å†…å‘é€å¤šæ¡ç›¸åŒå†…å®¹

- ä½¿ç”¨ FIFO åŒ¹é…ï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰
- æˆ–æ·»åŠ é¢å¤–çš„ `sequence_number` å­—æ®µ

### 3. çˆ¬è™«æš‚åœæœŸé—´å‘é€å›å¤

- å›å¤è¿›å…¥å¾…éªŒè¯é˜Ÿåˆ—
- çˆ¬è™«æ¢å¤åä»å¯åŒ¹é…ï¼ˆå¦‚æœæœªè¿‡æœŸï¼‰

### 4. Worker é‡å¯

- å¾…éªŒè¯é˜Ÿåˆ—ä¸¢å¤±ï¼ˆå†…å­˜å­˜å‚¨ï¼‰
- å¯é€‰ï¼šæŒä¹…åŒ–åˆ°æœ¬åœ° SQLite

---

## æ€§èƒ½å½±å“

- **å†…å­˜å ç”¨**ï¼šæ¯ä¸ªå¾…éªŒè¯å›å¤çº¦ 200 å­—èŠ‚ï¼Œ100 ä¸ªå›å¤ = 20KB
- **åŒ¹é…è€—æ—¶**ï¼šO(n)ï¼Œn = å¾…éªŒè¯å›å¤æ•°é‡ï¼ˆé€šå¸¸ < 10ï¼‰
- **çˆ¬è™«å»¶è¿Ÿ**ï¼šåŒ¹é…é€»è¾‘çº¦ 1-5msï¼Œå¯å¿½ç•¥

---

## åç»­ä¼˜åŒ–

### æ–¹æ¡ˆ 2ï¼šAPI æ‹¦æˆªè·å–çœŸå® IDï¼ˆç²¾ç¡®åŒ¹é…ï¼‰

å¦‚æœæŠ–éŸ³å›å¤ API è¿”å› `comment_id` æˆ– `message_id`ï¼Œå¯ä»¥é€šè¿‡ API æ‹¦æˆªç›´æ¥è·å–ï¼š

```javascript
// åœ¨ send-reply-to-message.js ä¸­æ·»åŠ  API æ‹¦æˆªå™¨
await page.route('**/im/message/send**', async (route) => {
  const response = await route.fetch();
  const body = await response.json();

  if (body.status_code === 0 && body.data.message_id) {
    // âœ… ç›´æ¥è·å¾—çœŸå® message_id
    platformReplyId = body.data.message_id;
  }

  await route.fulfill({ response });
});
```

ä¼˜ç‚¹ï¼šç²¾ç¡®åŒ¹é…ï¼Œæ— è¯¯åˆ¤
ç¼ºç‚¹ï¼šä¾èµ– API å“åº”æ ¼å¼

---

## æ•°æ®åº“ Schema æ‰©å±•ï¼ˆå¯é€‰ï¼‰

åœ¨ `replies` è¡¨ä¸­æ·»åŠ éªŒè¯ç›¸å…³å­—æ®µï¼š

```sql
ALTER TABLE replies ADD COLUMN verified_at DATETIME NULL;
ALTER TABLE replies ADD COLUMN platform_reply_id VARCHAR(255) NULL;
ALTER TABLE replies ADD COLUMN verification_method VARCHAR(50) NULL;
-- 'content_match' | 'api_intercept'
```

---

## æ€»ç»“

| æ–¹é¢ | æ–¹æ¡ˆ 1ï¼ˆå†…å®¹åŒ¹é…ï¼‰ | æ–¹æ¡ˆ 2ï¼ˆAPI æ‹¦æˆªï¼‰ |
|------|-------------------|-------------------|
| **å®ç°éš¾åº¦** | ç®€å• â­â­ | ä¸­ç­‰ â­â­â­ |
| **å‡†ç¡®åº¦** | é«˜ï¼ˆ98%+ï¼‰ | æé«˜ï¼ˆ100%ï¼‰ |
| **ä¾èµ–æ€§** | æ—  | ä¾èµ– API æ ¼å¼ |
| **æ€§èƒ½å½±å“** | æå° | æå° |
| **æ¨èåº¦** | â­â­â­â­â­ | â­â­â­â­ |

**å»ºè®®**ï¼šå…ˆå®ç°æ–¹æ¡ˆ 1ï¼ˆå†…å®¹åŒ¹é…ï¼‰ï¼Œå¦‚æœå‘ç°è¯¯åŒ¹é…é—®é¢˜ï¼Œå†å‡çº§åˆ°æ–¹æ¡ˆ 2ï¼ˆAPI æ‹¦æˆªï¼‰ã€‚
