# è™šæ‹Ÿåˆ—è¡¨è°ƒè¯•è¾“å‡º - æ‰§è¡Œç»“æœåˆ†æ

## æ—¶é—´: 2025-11-05 09:03

## æ‰§è¡Œæƒ…å†µ

### çˆ¬è™«è¿è¡ŒçŠ¶æ€

**å¯åŠ¨æ—¶é—´**: 08:51:56
**çˆ¬è™«çŠ¶æ€**: âœ… è¯„è®ºçˆ¬è™«å®Œæˆ (08:53:03) | âŒ ç§ä¿¡çˆ¬è™«æ— å®Œæˆè®°å½•

**æ—¥å¿—è®°å½•**:
- ç§ä¿¡çˆ¬è™«åœ¨ 08:51:56 å¯åŠ¨
- `Spider DM tab retrieved successfully` âœ…
- `DataManager å¯ç”¨ï¼Œä½¿ç”¨ç»Ÿä¸€æ•°æ®ç®¡ç†æ¶æ„` âœ…
- **ä¹‹åæ— ä»»ä½•æ—¥å¿—è¾“å‡º**ï¼ˆåŒ…æ‹¬å®Œæˆè®°å½•ã€è°ƒè¯•è¾“å‡ºã€é”™è¯¯ä¿¡æ¯ï¼‰

### æ•°æ®åº“éªŒè¯ç»“æœ

**Master æ•°æ®åº“** (`packages/master/data/master.db`):
- âœ… æœ€æ–°æ¶ˆæ¯å·²å­˜å‚¨åˆ° `cache_messages` è¡¨
- âœ… æœ€æ–°æ¶ˆæ¯æ—¶é—´: `2025-11-04T15:58:27.004Z`
- âš ï¸ **æ‰€æœ‰æ—¶é—´æˆ³æ˜¾ç¤ºä¸º 2025å¹´**ï¼ˆåº”è¯¥æ˜¯ 2024å¹´ï¼‰

**ç¤ºä¾‹æ•°æ®**:
```json
{
  "id": "msg_acc-98296c87-2e42-447a-9d8b-8be008ddb6e4_7568900171465508406",
  "created_at": "2025-11-04T15:58:27.004Z",  // â† 2025å¹´ï¼
  "rawData": {
    "message_id": "7568900171465508406",
    "content": "æ‚¨å¥½ï¼Œæ˜¯æƒ³äº†è§£ä¸´ç»ˆå…³æ€€å—ï¼Ÿå¯ä»¥ç»™æ‚¨è¯¦ç»†ä»‹ç»ä¸‹ï¼Œç•™ä¸ªæ–¹å¼æˆ‘+æ‚¨",
    "created_at": "2025-11-04T15:58:27.004Z"  // â† rawData ä¹Ÿæ˜¯ 2025å¹´
  }
}
```

### è°ƒè¯•è¾“å‡ºçŠ¶æ€

**é¢„æœŸè°ƒè¯•è¾“å‡º**:
```
ğŸ” [DEBUG] è™šæ‹Ÿåˆ—è¡¨ props å¯¹è±¡è°ƒè¯•ä¿¡æ¯:
  æ‰€æœ‰é”® (Nä¸ª): [...]
  æ—¶é—´ç›¸å…³å­—æ®µ (Nä¸ª): [...]
```

**å®é™…æƒ…å†µ**: âŒ **æœªæ‰¾åˆ°ä»»ä½•è°ƒè¯•è¾“å‡º**

**æ£€æŸ¥ä½ç½®**:
- âœ… `packages/worker/logs/douyin-platform.log` - æ—  `ğŸ” [DEBUG]`
- âœ… `packages/worker/logs/douyin-data_acc-...log` - æ—  `ğŸ” [DEBUG]`
- âœ… `packages/worker/logs/douyin-platform-error.log` - æ— æ–°é”™è¯¯ï¼ˆæœ€åé”™è¯¯ 11-04 16:43ï¼‰

## é—®é¢˜åˆ†æ

### 1. ä¸ºä»€ä¹ˆæ²¡æœ‰è°ƒè¯•è¾“å‡ºï¼Ÿ

**å¯èƒ½åŸå› **:

#### A. ç§ä¿¡æ•°æ®æ¥è‡ª API æ‹¦æˆªï¼Œæœªç»è¿‡è™šæ‹Ÿåˆ—è¡¨æå–
ä»ä¹‹å‰çš„æ–‡æ¡£äº†è§£åˆ°ï¼Œç³»ç»Ÿæœ‰ä¸‰å±‚å›é€€ç­–ç•¥ï¼š
1. **API æ‹¦æˆª** (æœ€ä¼˜å…ˆ)
2. React Fiber (è™šæ‹Ÿåˆ—è¡¨)
3. DOM è§£æ

å¦‚æœç§ä¿¡æ•°æ®é€šè¿‡ API æ‹¦æˆªè·å¾—ï¼Œå°±ä¸ä¼šæ‰§è¡Œè™šæ‹Ÿåˆ—è¡¨æå–é€»è¾‘ï¼Œå› æ­¤ä¹Ÿä¸ä¼šè¾“å‡ºè°ƒè¯•ä¿¡æ¯ã€‚

**éªŒè¯æ–¹æ³•**: æ£€æŸ¥æ•°æ®çš„ `source` å­—æ®µ
```javascript
// ä» cache_messages æ•°æ®ä¸­
"source": "dom"  // æˆ– "api" æˆ– "fiber"
```

å®é™…æ•°æ®æ˜¾ç¤º: **`"source": "dom"`**
- è¿™è¡¨ç¤ºæ•°æ®æ¥è‡ª DOM è§£æï¼Œè€Œä¸æ˜¯è™šæ‹Ÿåˆ—è¡¨ï¼ˆfiberï¼‰

#### B. è™šæ‹Ÿåˆ—è¡¨æå–å‡½æ•°æœªè¢«è°ƒç”¨
è°ƒè¯•ä»£ç ä½äº `extractMessagesFromVirtualList()` å‡½æ•°å†…éƒ¨ï¼ˆ[crawl-direct-messages-v2.js:1114-1541](../packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js#L1114-L1541)ï¼‰

å¦‚æœç§ä¿¡çˆ¬è™«ä½¿ç”¨çš„æ˜¯ DOM è§£æè·¯å¾„ï¼Œè¿™ä¸ªå‡½æ•°å¯èƒ½æ ¹æœ¬æ²¡æœ‰è¢«è°ƒç”¨ã€‚

**ä»£ç è·¯å¾„**:
```
crawlDirectMessagesV2()
â”œâ”€ extractConversationsList() - æå–ä¼šè¯åˆ—è¡¨
â”œâ”€ å¾ªç¯æ¯ä¸ªä¼šè¯
â”‚   â”œâ”€ ç‚¹å‡»ä¼šè¯
â”‚   â”œâ”€ ç­‰å¾…æ¶ˆæ¯åŠ è½½
â”‚   â””â”€ é€‰æ‹©æå–æ–¹å¼:
â”‚       â”œâ”€ API æ‹¦æˆª (ä¼˜å…ˆ) â† å¯èƒ½èµ°è¿™ä¸ªè·¯å¾„
â”‚       â”œâ”€ extractMessagesFromVirtualList() â† è°ƒè¯•ä»£ç åœ¨è¿™é‡Œ
â”‚       â””â”€ DOM fallback
```

#### C. ä¼šè¯ä¸­æ²¡æœ‰æ¶ˆæ¯
å¦‚æœçˆ¬è™«æ‰“å¼€çš„ä¼šè¯éƒ½æ˜¯ç©ºçš„ï¼ˆæ²¡æœ‰æ¶ˆæ¯ï¼‰ï¼Œè™šæ‹Ÿåˆ—è¡¨ä¸­å°±æ²¡æœ‰æ¶ˆæ¯å…ƒç´ ï¼Œè°ƒè¯•ä»£ç ä¹Ÿä¸ä¼šè§¦å‘ã€‚

ä½†ä»æ•°æ®åº“çœ‹ï¼Œç¡®å®æœ‰æ¶ˆæ¯æ•°æ®ï¼Œæ‰€ä»¥è¿™ä¸ªå¯èƒ½æ€§è¾ƒå°ã€‚

### 2. ä¸ºä»€ä¹ˆæ—¶é—´æˆ³æ˜¯ 2025å¹´ï¼Ÿ

**æ ¹æœ¬åŸå› **: ç³»ç»Ÿæ—¶é—´è®¾ç½®é”™è¯¯

æ‰€æœ‰ä½¿ç”¨ `Date.now()` æˆ– `new Date()` çš„åœ°æ–¹éƒ½ä¼šè¿”å› 2025å¹´çš„æ—¶é—´æˆ³ã€‚

**å—å½±å“çš„ä»£ç ä½ç½®** ([crawl-direct-messages-v2.js](../packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js)):
- Line 52: `if (!timestamp) { return Date.now(); }`
- Line 95: `return Date.now();`
- Line 481: `last_message_time: Math.floor(Date.now() / 1000)`
- Line 648: `last_message_time: time ? parseInt(time) : Math.floor(Date.now() / 1000)`

**æ•°æ®æµ**:
```
çˆ¬è™«æå–æ•°æ® (source: "dom")
  â†“
ä½¿ç”¨ Date.now() ç”Ÿæˆæ—¶é—´æˆ³ (2025å¹´)
  â†“
æ ¼å¼åŒ–ä¸º ISO 8601 å­—ç¬¦ä¸²: "2025-11-04T15:58:27.004Z"
  â†“
å­˜å…¥ rawData.created_at
  â†“
åŒæ­¥åˆ° Master æ•°æ®åº“ (cache_messages.created_at)
```

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: ä¿®å¤ç³»ç»Ÿæ—¶é—´ï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰

**æ­¥éª¤**:
1. å°† Windows ç³»ç»Ÿæ—¶é—´ä» 2025å¹´ æ”¹å› 2024å¹´
2. é‡å¯ Master å’Œ Worker
3. é‡æ–°æŠ“å–æ•°æ®
4. éªŒè¯æ–°æ•°æ®çš„æ—¶é—´æˆ³

**ä¼˜ç‚¹**:
- ä¸€æ¬¡æ€§è§£å†³æ‰€æœ‰æ—¶é—´æˆ³é—®é¢˜
- ä¸éœ€è¦ä¿®æ”¹ä»£ç 

**ç¼ºç‚¹**:
- å·²æŠ“å–çš„æ•°æ®æ—¶é—´æˆ³ä»ç„¶é”™è¯¯ï¼ˆéœ€è¦é‡æ–°æŠ“å–æˆ–æ‰‹åŠ¨ä¿®æ­£ï¼‰

### æ–¹æ¡ˆ B: ç¡®å®šå®é™…æ•°æ®æå–è·¯å¾„

**ç›®æ ‡**: æ‰¾å‡ºç§ä¿¡æ•°æ®çš„å®é™…æ¥æºï¼ˆAPI / Fiber / DOMï¼‰

**æ­¥éª¤**:

1. **æŸ¥çœ‹æ•°æ®æºæ ‡è¯†**:
ä»æ•°æ®åº“æ•°æ®çœ‹ï¼Œ`source: "dom"` è¡¨ç¤ºä½¿ç”¨DOMè§£æã€‚

2. **æ·»åŠ è·¯å¾„æ—¥å¿—**:
åœ¨ `crawl-direct-messages-v2.js` ä¸­æ·»åŠ æ—¥å¿—ï¼Œè®°å½•å®é™…ä½¿ç”¨çš„æå–æ–¹å¼ï¼š

```javascript
// åœ¨æ¶ˆæ¯æå–éƒ¨åˆ†
if (apiMessages && apiMessages.length > 0) {
  logger.info('âœ… ä½¿ç”¨ API æ‹¦æˆªè·å–æ¶ˆæ¯');
} else if (fiberMessages && fiberMessages.length > 0) {
  logger.info('âœ… ä½¿ç”¨ React Fiber (è™šæ‹Ÿåˆ—è¡¨) è·å–æ¶ˆæ¯');
} else {
  logger.info('âš ï¸ å›é€€åˆ° DOM è§£æè·å–æ¶ˆæ¯');
}
```

3. **é’ˆå¯¹ DOM è§£æè·¯å¾„æ·»åŠ è°ƒè¯•**:
å¦‚æœç§ä¿¡ç¡®å®æ˜¯é€šè¿‡ DOM è§£æè·å–çš„ï¼Œéœ€è¦åœ¨ DOM è§£æä»£ç ä¸­ä¹Ÿæ·»åŠ ç±»ä¼¼çš„è°ƒè¯•è¾“å‡ºã€‚

### æ–¹æ¡ˆ C: ä»è™šæ‹Ÿåˆ—è¡¨å¼ºåˆ¶æå–æ—¶é—´æˆ³ï¼ˆé•¿æœŸæ–¹æ¡ˆï¼‰

**å³ä½¿ä¿®å¤äº†ç³»ç»Ÿæ—¶é—´**ï¼Œä»ç„¶åº”è¯¥å®ç°ä»è™šæ‹Ÿåˆ—è¡¨æå–çœŸå®æ—¶é—´æˆ³ï¼ŒåŸå› ï¼š
- æ›´å‡†ç¡®ï¼ˆä½¿ç”¨æŠ–éŸ³APIçš„å®é™…æ—¶é—´æˆ³ï¼‰
- æ›´å¯é ï¼ˆä¸ä¾èµ–ç³»ç»Ÿæ—¶é—´ï¼‰
- ä¸€è‡´æ€§ï¼ˆæ‰€æœ‰ç”¨æˆ·çœ‹åˆ°ç›¸åŒçš„æ—¶é—´ï¼‰

**å®ç°æ­¥éª¤**:

1. **ç¡®è®¤è™šæ‹Ÿåˆ—è¡¨æ˜¯å¦å¯ç”¨**:
   - æ£€æŸ¥æ—¥å¿—ï¼Œç¡®è®¤æ˜¯å¦æœ‰ "extractMessagesFromVirtualList" è¢«è°ƒç”¨
   - å¦‚æœæœªè°ƒç”¨ï¼Œéœ€è¦å…ˆä¿®æ”¹ä»£ç è·¯å¾„ï¼Œå¼ºåˆ¶ä½¿ç”¨è™šæ‹Ÿåˆ—è¡¨æå–

2. **è·å–è°ƒè¯•è¾“å‡º**:
   - æ–¹æ³•1: å¯ç”¨ Playwright `headless: false` + `devtools: true`
   - æ–¹æ³•2: æ·»åŠ  `page.on('console')` ç›‘å¬å™¨ï¼ˆæµè§ˆå™¨æ§åˆ¶å° â†’ Node.js æ—¥å¿—ï¼‰
   - æ–¹æ³•3: ä½¿ç”¨æ•°æ®å›ä¼ æ³•ï¼ˆå·²å®ç°ï¼‰

3. **æ ¹æ®å®é™…å­—æ®µåæ›´æ–°ä»£ç **:
```javascript
// å½“å‰æ”¶é›†å­—æ®µ
timestamp: props.timestamp,
createdAt: props.createdAt,
createTime: props.createTime,
sendTime: props.sendTime,

// å¯èƒ½éœ€è¦æ·»åŠ 
create_time: props.create_time,
send_time: props.send_time,
time: props.time
```

4. **æ›´æ–°æ—¶é—´æˆ³ä½¿ç”¨ä¼˜å…ˆçº§**:
```javascript
createdAt: rawData.timestamp ||     // è™šæ‹Ÿåˆ—è¡¨å­—æ®µ (ä¼˜å…ˆ)
          rawData.create_time ||
          rawData.createTime ||
          rawData.sendTime ||
          Date.now()                // ç³»ç»Ÿæ—¶é—´ (æœ€åfallback)
```

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### çŸ­æœŸï¼ˆç«‹å³æ‰§è¡Œï¼‰:
1. âœ… åˆ†æå®Œæˆ - ç¡®è®¤æ—¶é—´æˆ³æ¥æºå’Œé—®é¢˜
2. â³ **ä¿®å¤ç³»ç»Ÿæ—¶é—´** - å°†Windowsæ—¶é—´ä»2025æ”¹å›2024
3. â³ é‡æ–°æŠ“å–æ•°æ®å¹¶éªŒè¯æ—¶é—´æˆ³

### ä¸­æœŸï¼ˆæœ¬å‘¨å†…ï¼‰:
1. â³ ç¡®å®šç§ä¿¡æ•°æ®çš„å®é™…æå–è·¯å¾„ï¼ˆAPI/Fiber/DOMï¼‰
2. â³ å¦‚æœæ˜¯DOMè·¯å¾„ï¼Œåœ¨DOMè§£æä»£ç ä¸­æ·»åŠ æ—¶é—´å­—æ®µè°ƒè¯•
3. â³ å¦‚æœæ˜¯APIè·¯å¾„ï¼Œæ£€æŸ¥APIå“åº”ä¸­çš„æ—¶é—´æˆ³å­—æ®µå

### é•¿æœŸï¼ˆä¼˜åŒ–ï¼‰:
1. â³ ä»è™šæ‹Ÿåˆ—è¡¨/APIä¸­æå–çœŸå®æ—¶é—´æˆ³ï¼Œæ›¿ä»£ Date.now()
2. â³ å®ç°æ—¶é—´æˆ³å­—æ®µçš„è‡ªåŠ¨æ£€æµ‹å’Œå›é€€æœºåˆ¶
3. â³ æ·»åŠ æ—¶é—´æˆ³éªŒè¯ï¼ˆæ£€æµ‹æ˜¯å¦åˆç†ï¼Œä¾‹å¦‚ä¸åº”è¯¥æ˜¯æœªæ¥æ—¶é—´ï¼‰

## æŠ€æœ¯ç»†èŠ‚

### æ•°æ®åº“ Schema

**cache_messages è¡¨ç»“æ„**:
```sql
CREATE TABLE cache_messages (
  id TEXT PRIMARY KEY,              -- æ¶ˆæ¯ID
  account_id TEXT NOT NULL,         -- è´¦æˆ·ID
  conversation_id TEXT NOT NULL,    -- ä¼šè¯ID
  data TEXT NOT NULL,               -- JSON æ ¼å¼çš„å®Œæ•´æ¶ˆæ¯æ•°æ®
  created_at TEXT NOT NULL,         -- ISO 8601 æ—¶é—´å­—ç¬¦ä¸² (âš ï¸ å½“å‰æ˜¯2025å¹´)
  updated_at INTEGER NOT NULL,      -- Unix æ—¶é—´æˆ³ (æ¯«ç§’)
  persist_at INTEGER NOT NULL,      -- æŒä¹…åŒ–æ—¶é—´æˆ³
  read_at INTEGER,                  -- å·²è¯»æ—¶é—´æˆ³
  is_read INTEGER DEFAULT 0         -- æ˜¯å¦å·²è¯»
);
```

### æ—¶é—´æˆ³æ ¼å¼

**æ•°æ®åº“ä¸­å­˜å‚¨çš„ä¸‰ç§æ—¶é—´æ ¼å¼**:
1. `created_at`: ISO 8601 å­—ç¬¦ä¸² - `"2025-11-04T15:58:27.004Z"`
2. `updated_at` / `persist_at`: Unix æ¯«ç§’æ—¶é—´æˆ³ - `1762304153820`
3. `rawData.created_at`: ISO 8601 å­—ç¬¦ä¸²ï¼ˆä¸ created_at ç›¸åŒï¼‰

**è½¬æ¢ç¤ºä¾‹**:
```javascript
// ISO 8601 â†’ Unix æ¯«ç§’
const timestamp = new Date("2025-11-04T15:58:27.004Z").getTime();
// 1762304153820 (å¯¹åº” 2025-11-04)

// Unix æ¯«ç§’ â†’ ISO 8601
const isoString = new Date(1762304153820).toISOString();
// "2025-11-04T15:58:27.004Z"

// Unix ç§’ â†’ Unix æ¯«ç§’
const milliseconds = 1730687825 * 1000;
// 1730687825000 (å¯¹åº” 2024-11-04)
```

### éªŒè¯å‘½ä»¤

```bash
# 1. æŸ¥çœ‹æœ€æ–°æ¶ˆæ¯æ—¶é—´æˆ³
cd packages/master && node -e "
const db = require('better-sqlite3')('./data/master.db');
const msg = db.prepare('SELECT created_at FROM cache_messages ORDER BY persist_at DESC LIMIT 1').get();
console.log('æœ€æ–°æ¶ˆæ¯æ—¶é—´:', msg.created_at);
console.log('å¯¹åº”æ—¥æœŸ:', new Date(msg.created_at).toLocaleString('zh-CN'));
db.close();
"

# 2. æ£€æŸ¥ç³»ç»Ÿæ—¶é—´
date

# 3. æŸ¥çœ‹çˆ¬è™«æ—¥å¿—ä¸­çš„æ—¶é—´æˆ³
grep "crawlDirectMessages" packages/worker/logs/douyin-platform.log | tail -5
```

## å‚è€ƒæ–‡æ¡£

- [è™šæ‹Ÿåˆ—è¡¨è°ƒè¯•è¾“å‡º-ä»£ç ä¿®å¤](./è™šæ‹Ÿåˆ—è¡¨è°ƒè¯•è¾“å‡º-ä»£ç ä¿®å¤.md) - æ•°æ®å›ä¼ æ³•å®ç°
- [æ—¶é—´æˆ³é—®é¢˜æœ€ç»ˆå‘ç°](./æ—¶é—´æˆ³é—®é¢˜æœ€ç»ˆå‘ç°.md) - æ—¶é—´æˆ³é—®é¢˜åˆ†æ
- [è™šæ‹Ÿåˆ—è¡¨è°ƒè¯•ä»£ç ä¿®å¤æŠ¥å‘Š](./è™šæ‹Ÿåˆ—è¡¨è°ƒè¯•ä»£ç ä¿®å¤æŠ¥å‘Š.md) - è°ƒè¯•æ¡ä»¶ä¿®å¤
- [ä»£ç æ–‡ä»¶](../packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js) - ç§ä¿¡çˆ¬è™«æºç 
