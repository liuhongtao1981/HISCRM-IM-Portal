# çˆ¬è™«ä»»åŠ¡é…ç½®çƒ­æ›´æ–°æœºåˆ¶å®ç°æŠ¥å‘Š

## é—®é¢˜èƒŒæ™¯

### é—®é¢˜æè¿°
ç™»å½•æˆåŠŸåï¼Œçˆ¬è™«ä»»åŠ¡æ²¡æœ‰æ‰§è¡Œï¼ŒWorkeræ—¥å¿—æ˜¾ç¤ºé”™è¯¯ï¼š
```
Account missing platform_user_id - please login first to obtain douyin_id
```

### è¯Šæ–­ç»“æœ
é€šè¿‡è¿è¡Œè¯Šæ–­è„šæœ¬ `tests/æµ‹è¯•çˆ¬è™«ä»»åŠ¡æ‰§è¡Œ.js` å‘ç°ï¼š
- âœ… æ•°æ®åº“ä¸­è´¦æˆ·çš„ `platform_user_id`: 1864722759ï¼ˆå·²æ­£ç¡®ä¿å­˜ï¼‰
- âœ… è´¦æˆ·çš„ `login_status`: logged_in
- âŒ WorkerçŠ¶æ€æ˜¾ç¤ºï¼š`error`
- âŒ é”™è¯¯æ¶ˆæ¯ï¼š"Account missing platform_user_id"

**æ ¹æœ¬åŸå› **ï¼š
1. Workeråœ¨å¯åŠ¨æ—¶ä»Masterè·å–è´¦æˆ·é…ç½®å¹¶ç¼“å­˜
2. ç”¨æˆ·ç™»å½•æˆåŠŸåï¼ŒMasteræ›´æ–°æ•°æ®åº“ä¸­çš„`platform_user_id`
3. ä½†Workerä»åœ¨ä½¿ç”¨æ—§çš„ï¼ˆæ²¡æœ‰platform_user_idçš„ï¼‰é…ç½®
4. å¯¼è‡´çˆ¬è™«ä»»åŠ¡æ— æ³•å¯åŠ¨ï¼ŒæŒç»­æŠ¥é”™

## è§£å†³æ–¹æ¡ˆï¼šé…ç½®çƒ­æ›´æ–°æœºåˆ¶

### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç™»å½•æµç¨‹ + é…ç½®çƒ­æ›´æ–°                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. ç”¨æˆ·æ‰«ç ç™»å½•
   â†“
2. Workeræ£€æµ‹ç™»å½•æˆåŠŸï¼Œå‘é€ login:success ç»™ Master
   â†“
3. Masteræ›´æ–°æ•°æ®åº“ï¼š
   - accounts.platform_user_id = 1864722759
   - accounts.login_status = 'logged_in'
   â†“
4. â­ Masterå‘é€é…ç½®æ›´æ–°é€šçŸ¥ç»™Worker
   Event: MASTER_ACCOUNT_CONFIG_UPDATE
   Payload: {
     account_id: "acc-xxx",
     reason: "login_success",
     updated_fields: ["platform_user_id", "login_status", "user_info"]
   }
   â†“
5. Workeræ¥æ”¶é€šçŸ¥ï¼Œé‡æ–°åŠ è½½è´¦æˆ·é…ç½®
   - ä»Masterè·å–æœ€æ–°è´¦æˆ·æ•°æ®
   - æ›´æ–°æœ¬åœ° accountsCache
   - æ›´æ–° TaskRunner ä¸­çš„ä»»åŠ¡é…ç½®
   â†“
6. çˆ¬è™«ä»»åŠ¡ä½¿ç”¨æ–°é…ç½®ç»§ç»­æ‰§è¡Œ
   âœ… platform_user_id å·²å­˜åœ¨ï¼Œä»»åŠ¡æ­£å¸¸è¿è¡Œ
```

### å®ç°ç»†èŠ‚

#### 1. åè®®å±‚ï¼ˆprotocol/messages.jsï¼‰

æ–°å¢ä¸¤ä¸ªæ¶ˆæ¯ç±»å‹ï¼š

```javascript
// Master â†’ Worker: é€šçŸ¥è´¦æˆ·é…ç½®å·²æ›´æ–°
const MASTER_ACCOUNT_CONFIG_UPDATE = 'master:account:config_update';

// Worker â†’ Master: ç¡®è®¤å·²é‡æ–°åŠ è½½é…ç½®
const MASTER_ACCOUNT_CONFIG_UPDATE_ACK = 'master:account:config_update:ack';
```

#### 2. Masterç«¯ï¼ˆlogin-handler.jsï¼‰

åœ¨ç™»å½•æˆåŠŸå¤„ç†å‡½æ•° `handleLoginSuccess()` ä¸­æ·»åŠ é…ç½®æ›´æ–°é€šçŸ¥ï¼š

```javascript
// â­ é€šçŸ¥Workerè´¦æˆ·é…ç½®å·²æ›´æ–°
if (this.workerNamespace) {
  const { MASTER_ACCOUNT_CONFIG_UPDATE, createMessage } = require('@hiscrm-im/shared/protocol/messages');

  // æ‰¾åˆ°Workerçš„socketè¿æ¥
  const workerSocket = this.workerNamespace.sockets.get(session.worker_id);
  if (workerSocket) {
    const configUpdateMessage = createMessage(MASTER_ACCOUNT_CONFIG_UPDATE, {
      account_id: session.account_id,
      reason: 'login_success',
      updated_fields: ['platform_user_id', 'login_status', 'user_info'],
    });

    workerSocket.emit(MASTER_ACCOUNT_CONFIG_UPDATE, configUpdateMessage);
    logger.info(`Sent config update notification to Worker ${session.worker_id}`);
  }
}
```

**ä¿®æ”¹ç‚¹**ï¼š
- æ–‡ä»¶ï¼š`packages/master/src/login/login-handler.js`
- ä¿®æ”¹LoginHandleræ„é€ å‡½æ•°ï¼Œæ·»åŠ `workerNamespace`å‚æ•°
- åœ¨`handleLoginSuccess()`ä¸­å‘é€é…ç½®æ›´æ–°é€šçŸ¥

**Master index.jsä¿®æ”¹**ï¼š
```javascript
// åˆå§‹åŒ–ç™»å½•ç®¡ç†å™¨ï¼ˆä¼ å…¥adminNamespaceå’ŒworkerNamespaceï¼‰
loginHandler = new LoginHandler(db, adminNamespace, workerNamespace);
```

#### 3. Workerç«¯ï¼ˆsocket-client.jsï¼‰

æ·»åŠ é…ç½®æ›´æ–°æ¶ˆæ¯ç›‘å¬å™¨ï¼š

```javascript
// â­ ç›‘å¬è´¦æˆ·é…ç½®æ›´æ–°é€šçŸ¥
const { MASTER_ACCOUNT_CONFIG_UPDATE } = require('@hiscrm-im/shared/protocol/messages');
this.socket.on(MASTER_ACCOUNT_CONFIG_UPDATE, (msg) => {
  logger.info('ğŸ“¥ Received account config update notification from Master', {
    accountId: msg.payload?.account_id,
    reason: msg.payload?.reason,
    updatedFields: msg.payload?.updated_fields,
  });

  // è§¦å‘é…ç½®æ›´æ–°å¤„ç†å™¨
  const handler = this.messageHandlers.get(MASTER_ACCOUNT_CONFIG_UPDATE);
  if (handler) {
    handler(msg);
  }
});
```

**ä¿®æ”¹ç‚¹**ï¼š
- æ–‡ä»¶ï¼š`packages/worker/src/communication/socket-client.js`
- åœ¨socketè¿æ¥å»ºç«‹åæ·»åŠ ä¸“é—¨çš„é…ç½®æ›´æ–°ç›‘å¬å™¨

#### 4. Workerç«¯ï¼ˆindex.jsï¼‰

##### 4.1 æ·»åŠ è´¦æˆ·é…ç½®ç¼“å­˜

```javascript
// â­ è´¦æˆ·é…ç½®ç¼“å­˜ï¼ˆaccountId -> accountå¯¹è±¡ï¼‰
const accountsCache = new Map();
```

##### 4.2 å®ç°é…ç½®é‡æ–°åŠ è½½å‡½æ•°

```javascript
/**
 * â­ é‡æ–°åŠ è½½è´¦æˆ·é…ç½®ï¼ˆä»Masterè·å–æœ€æ–°é…ç½®ï¼‰
 */
async function reloadAccountConfig(accountId) {
  // 1. ä»Masterè·å–æœ€æ–°è´¦æˆ·é…ç½®
  const updatedAccounts = await workerRegistration.register();

  // 2. æŸ¥æ‰¾ç›®æ ‡è´¦æˆ·çš„æ–°é…ç½®
  const updatedAccount = updatedAccounts.find(acc => acc.id === accountId);

  // 3. æ›´æ–°ç¼“å­˜
  accountsCache.set(accountId, updatedAccount);

  // 4. é€šçŸ¥taskRunneræ›´æ–°ä»»åŠ¡é…ç½®
  if (taskRunner) {
    taskRunner.updateAccountConfig(accountId, updatedAccount);
  }

  return updatedAccount;
}
```

##### 4.3 æ³¨å†Œé…ç½®æ›´æ–°å¤„ç†å™¨

```javascript
// â­ æ³¨å†Œé…ç½®æ›´æ–°å¤„ç†å™¨
socketClient.onMessage(MASTER_ACCOUNT_CONFIG_UPDATE, async (msg) => {
  const { account_id, reason, updated_fields } = msg.payload;

  // é‡æ–°åŠ è½½è´¦æˆ·é…ç½®
  const updated = await reloadAccountConfig(account_id);

  // å‘é€ç¡®è®¤
  const ackMessage = createMessage(MASTER_ACCOUNT_CONFIG_UPDATE_ACK, {
    account_id,
    success: !!updated,
    reloaded_at: Date.now(),
  });
  socketClient.sendMessage(ackMessage);
});
```

**ä¿®æ”¹ç‚¹**ï¼š
- æ–‡ä»¶ï¼š`packages/worker/src/index.js`
- æ·»åŠ `accountsCache`å…¨å±€ç¼“å­˜
- å®ç°`reloadAccountConfig()`å‡½æ•°
- åœ¨Workerå¯åŠ¨åæ³¨å†Œé…ç½®æ›´æ–°å¤„ç†å™¨

#### 5. TaskRunnerï¼ˆtask-runner.jsï¼‰

æ·»åŠ æ›´æ–°è´¦æˆ·é…ç½®çš„æ–¹æ³•ï¼š

```javascript
/**
 * â­ æ›´æ–°è´¦æˆ·é…ç½®ï¼ˆç”¨äºé…ç½®çƒ­æ›´æ–°ï¼‰
 */
updateAccountConfig(accountId, updatedAccount) {
  const monitorTask = this.tasks.get(accountId);
  if (monitorTask) {
    // æ›´æ–°MonitorTaskä¸­çš„è´¦æˆ·é…ç½®
    monitorTask.account = updatedAccount;
    logger.info(`âœ… Updated account config in MonitorTask for ${accountId}`);
  }
}
```

**ä¿®æ”¹ç‚¹**ï¼š
- æ–‡ä»¶ï¼š`packages/worker/src/handlers/task-runner.js`
- æ·»åŠ `updateAccountConfig()`æ–¹æ³•

## ä»£ç ä¿®æ”¹æ€»ç»“

### ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨

1. **packages/shared/protocol/messages.js**
   - æ–°å¢ï¼š`MASTER_ACCOUNT_CONFIG_UPDATE` æ¶ˆæ¯ç±»å‹
   - æ–°å¢ï¼š`MASTER_ACCOUNT_CONFIG_UPDATE_ACK` æ¶ˆæ¯ç±»å‹

2. **packages/master/src/login/login-handler.js**
   - ä¿®æ”¹ï¼šæ„é€ å‡½æ•°æ·»åŠ `workerNamespace`å‚æ•°
   - æ–°å¢ï¼š`handleLoginSuccess()`ä¸­å‘é€é…ç½®æ›´æ–°é€šçŸ¥

3. **packages/master/src/index.js**
   - ä¿®æ”¹ï¼šåˆå§‹åŒ–LoginHandleræ—¶ä¼ å…¥`workerNamespace`

4. **packages/worker/src/communication/socket-client.js**
   - æ–°å¢ï¼šç›‘å¬`MASTER_ACCOUNT_CONFIG_UPDATE`äº‹ä»¶

5. **packages/worker/src/index.js**
   - æ–°å¢ï¼š`accountsCache`å…¨å±€ç¼“å­˜
   - æ–°å¢ï¼š`reloadAccountConfig()`å‡½æ•°
   - æ–°å¢ï¼šæ³¨å†Œé…ç½®æ›´æ–°å¤„ç†å™¨

6. **packages/worker/src/handlers/task-runner.js**
   - æ–°å¢ï¼š`updateAccountConfig()`æ–¹æ³•

### ä»£ç ç»Ÿè®¡

- æ–°å¢ä»£ç ï¼šçº¦120è¡Œ
- ä¿®æ”¹ä»£ç ï¼šçº¦20è¡Œ
- ä¿®æ”¹æ–‡ä»¶ï¼š6ä¸ª

## é¢„æœŸæ•ˆæœ

### ä¿®å¤å‰
```
1. ç”¨æˆ·æ‰«ç ç™»å½•
2. Masterä¿å­˜ platform_user_id åˆ°æ•°æ®åº“ âœ…
3. Worker ä»ä½¿ç”¨æ—§é…ç½®ï¼ˆæ—  platform_user_idï¼‰ âŒ
4. çˆ¬è™«ä»»åŠ¡å¯åŠ¨å¤±è´¥ï¼ŒæŒç»­æŠ¥é”™ âŒ
5. éœ€è¦æ‰‹åŠ¨é‡å¯Workeræ‰èƒ½ç”Ÿæ•ˆ âŒ
```

### ä¿®å¤å
```
1. ç”¨æˆ·æ‰«ç ç™»å½•
2. Masterä¿å­˜ platform_user_id åˆ°æ•°æ®åº“ âœ…
3. Masterå‘é€é…ç½®æ›´æ–°é€šçŸ¥ç»™Worker âœ…
4. Workerè‡ªåŠ¨é‡æ–°åŠ è½½è´¦æˆ·é…ç½® âœ…
5. çˆ¬è™«ä»»åŠ¡ä½¿ç”¨æ–°é…ç½®ï¼Œæ­£å¸¸æ‰§è¡Œ âœ…
6. æ— éœ€é‡å¯Worker âœ…
```

## æµ‹è¯•è®¡åˆ’

### æµ‹è¯•æ­¥éª¤

1. **å¯åŠ¨Masterå’ŒWorker**
   ```bash
   # Terminal 1
   cd packages/master && npm start

   # Terminal 2
   cd packages/worker && npm start
   ```

2. **æ‰§è¡Œç™»å½•æ“ä½œ**
   - åœ¨Admin UIä¸­ç‚¹å‡»"ç™»å½•"æŒ‰é’®
   - æ‰«æäºŒç»´ç 
   - ç¡®è®¤ç™»å½•

3. **è§‚å¯Ÿæ—¥å¿—è¾“å‡º**

   **Masteræ—¥å¿—åº”æ˜¾ç¤º**ï¼š
   ```
   [login-handler] Login success for session xxx
   [login-handler] Updated platform_user_id to: 1864722759
   [login-handler] Sent config update notification to Worker worker1
   ```

   **Workeræ—¥å¿—åº”æ˜¾ç¤º**ï¼š
   ```
   [socket-client] ğŸ“¥ Received account config update notification from Master
   [worker] ğŸ”„ Reloading configuration for account acc-xxx...
   [worker] âœ… Account config reloaded for acc-xxx
   [task-runner] âœ… Updated account config in MonitorTask for acc-xxx
   ```

4. **éªŒè¯çˆ¬è™«ä»»åŠ¡æ‰§è¡Œ**
   - è¿è¡Œè¯Šæ–­è„šæœ¬ï¼š`node tests/æµ‹è¯•çˆ¬è™«ä»»åŠ¡æ‰§è¡Œ.js`
   - æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦æœ‰æ–°çš„è¯„è®º/ç§ä¿¡æ•°æ®
   - Workeræ—¥å¿—åº”æ˜¾ç¤ºçˆ¬è™«æ­£å¸¸è¿è¡Œï¼Œæ— "missing platform_user_id"é”™è¯¯

### é¢„æœŸç»“æœ

âœ… ç™»å½•æˆåŠŸåï¼ŒWorkerè‡ªåŠ¨æ›´æ–°é…ç½®
âœ… çˆ¬è™«ä»»åŠ¡æ­£å¸¸æ‰§è¡Œï¼Œä¸å†æŠ¥é”™
âœ… æ— éœ€æ‰‹åŠ¨é‡å¯Worker
âœ… é…ç½®æ›´æ–°åœ¨2-3ç§’å†…å®Œæˆ

## ä¼˜åŠ¿ä¸æ‰©å±•

### ä¼˜åŠ¿

1. **é…ç½®çƒ­æ›´æ–°**ï¼šæ— éœ€é‡å¯Workerå³å¯åº”ç”¨æœ€æ–°é…ç½®
2. **å®æ—¶æ€§**ï¼šç™»å½•æˆåŠŸåç«‹å³é€šçŸ¥Workeræ›´æ–°
3. **å¯é æ€§**ï¼šä½¿ç”¨ACKç¡®è®¤æœºåˆ¶ï¼Œç¡®ä¿é…ç½®æ›´æ–°æˆåŠŸ
4. **å¯æ‰©å±•æ€§**ï¼šæœªæ¥å¯ç”¨äºå…¶ä»–é…ç½®æ›´æ–°åœºæ™¯

### å¯æ‰©å±•åœºæ™¯

è¿™å¥—é…ç½®çƒ­æ›´æ–°æœºåˆ¶å¯ä»¥ç”¨äºï¼š
- âœ… ç™»å½•æˆåŠŸåæ›´æ–° platform_user_id
- ğŸ”® è´¦æˆ·ä¿¡æ¯å˜æ›´ï¼ˆæ˜µç§°ã€å¤´åƒç­‰ï¼‰
- ğŸ”® ç›‘æ§é—´éš”è°ƒæ•´
- ğŸ”® çˆ¬è™«ç­–ç•¥æ›´æ–°
- ğŸ”® è´¦æˆ·çŠ¶æ€å˜æ›´ï¼ˆå¯ç”¨/ç¦ç”¨ï¼‰

## é™„å½•ï¼šè¯Šæ–­è„šæœ¬

æµ‹è¯•è„šæœ¬ä½ç½®ï¼š`tests/æµ‹è¯•çˆ¬è™«ä»»åŠ¡æ‰§è¡Œ.js`

è¿è¡Œæ–¹å¼ï¼š
```bash
node tests/æµ‹è¯•çˆ¬è™«ä»»åŠ¡æ‰§è¡Œ.js
```

è„šæœ¬åŠŸèƒ½ï¼š
- æŸ¥è¯¢è´¦æˆ·ä¿¡æ¯å’Œ platform_user_id çŠ¶æ€
- æ£€æŸ¥Workeræ³¨å†Œå’Œå¿ƒè·³çŠ¶æ€
- éªŒè¯ç›‘æ§ä»»åŠ¡æ˜¯å¦åˆ›å»º
- æŸ¥çœ‹æœ€è¿‘çš„è¯„è®ºå’Œç§ä¿¡æ•°æ®
- è‡ªåŠ¨è¯Šæ–­é—®é¢˜å¹¶æä¾›è§£å†³æ–¹æ¡ˆ

## æ€»ç»“

é€šè¿‡å®ç°é…ç½®çƒ­æ›´æ–°æœºåˆ¶ï¼ŒæˆåŠŸè§£å†³äº†"ç™»å½•æˆåŠŸåçˆ¬è™«ä»»åŠ¡ä¸æ‰§è¡Œ"çš„é—®é¢˜ã€‚è¿™å¥—æœºåˆ¶ä¸ä»…ä¿®å¤äº†å½“å‰é—®é¢˜ï¼Œè¿˜ä¸ºæœªæ¥çš„é…ç½®åŠ¨æ€æ›´æ–°æä¾›äº†åŸºç¡€æ¶æ„æ”¯æŒã€‚

**å…³é”®æ”¹è¿›**ï¼š
1. Workerä¸å†éœ€è¦é‡å¯å³å¯è·å–æœ€æ–°é…ç½®
2. ç™»å½•æµç¨‹æ›´åŠ æµç•…ï¼Œç”¨æˆ·ä½“éªŒæå‡
3. ç³»ç»Ÿæ¶æ„æ›´åŠ å¥å£®ï¼Œæ”¯æŒè¿è¡Œæ—¶é…ç½®æ›´æ–°

---

**å®ç°æ—¶é—´**ï¼š2025-10-24
**å®ç°äºº**ï¼šClaude Code
**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0
