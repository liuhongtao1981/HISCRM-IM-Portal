# Worker æ•°æ®æ¨é€åŠŸèƒ½å®ç°çŠ¶æ€å’Œä¸‹ä¸€æ­¥è®¡åˆ’

**æ›´æ–°æ—¶é—´**: 2025-10-30 16:02
**å½“å‰çŠ¶æ€**: âš ï¸ **éƒ¨åˆ†å®Œæˆ** - ä»£ç å®ç°å®Œæˆï¼Œä½†é›†æˆæµ‹è¯•å—é˜»

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. MessageTypes å¯¼å‡ºé—®é¢˜ä¿®å¤

**é—®é¢˜**: `const { MessageTypes } = require(...)` è§£æ„å‡º `undefined`

**ä¿®å¤**: `packages/shared/protocol/messages.js` (ç¬¬176è¡Œ)
```javascript
const MessageTypes = module.exports;
module.exports.MessageTypes = MessageTypes;  // âœ¨ æ·»åŠ è¿™ä¸€è¡Œ
```

**éªŒè¯**: âœ… å•å…ƒæµ‹è¯•é€šè¿‡
- `tests/æµ‹è¯•MessageTypes.js` - MessageTypes æ­£ç¡®å¯¼å‡º
- `tests/æµ‹è¯•DataManageråŒæ­¥.js` - syncToMaster() æˆåŠŸæ¨é€æ¶ˆæ¯

### 2. è°ƒè¯•æ—¥å¿—æ·»åŠ 

åœ¨å…³é”®ç»„ä»¶ä¸­æ·»åŠ äº†è¯¦ç»†çš„ console.log è°ƒè¯•æ—¥å¿—ï¼š

**æ–‡ä»¶**:
- `packages/worker/src/platforms/base/account-data-manager.js`
  - æ„é€ å‡½æ•°ï¼šéªŒè¯ dataPusher ä¼ é€’
  - startDataSnapshot()ï¼šéªŒè¯å®šæ—¶å™¨å¯åŠ¨
  - syncToMaster()ï¼šè¿½è¸ªæ¯æ¬¡åŒæ­¥è°ƒç”¨å’Œæ•°æ®å¿«ç…§

- `packages/worker/src/platforms/douyin/douyin-data-manager.js`
  - æ„é€ å‡½æ•°ï¼šéªŒè¯ dataPusher å‚æ•°

### 3. æµ‹è¯•è„šæœ¬åˆ›å»º

**æ–‡ä»¶**:
1. `tests/æµ‹è¯•MessageTypes.js` - éªŒè¯ MessageTypes å¯¼å‡º
2. `tests/æµ‹è¯•DataManageråŒæ­¥.js` - éªŒè¯æ•°æ®åŒæ­¥æµç¨‹
3. `tests/æ‰‹åŠ¨è§¦å‘æ•°æ®åŒæ­¥.js` - æ£€æŸ¥ Master DataStore çŠ¶æ€
4. `tests/æŸ¥è¯¢è´¦æˆ·çŠ¶æ€.js` - æŸ¥è¯¢è´¦æˆ·ç™»å½•çŠ¶æ€

### 4. å®Œæ•´çš„å®ç°ä»£ç 

å·²å®ç°çš„æ ¸å¿ƒç»„ä»¶ï¼ˆä¹‹å‰ä¼šè¯å®Œæˆï¼‰ï¼š
- âœ… DataStore (465è¡Œ) - å†…å­˜æ•°æ®å­˜å‚¨
- âœ… DataSyncReceiver (117è¡Œ) - Master ç«¯æ¥æ”¶å™¨
- âœ… Master é›†æˆ - æ³¨å†Œ WORKER_DATA_SYNC å¤„ç†å™¨
- âœ… Worker DataPusher - æ¨é€æ•°æ®åˆ° Master
- âœ… Worker syncToMaster() - æ•°æ®åŒæ­¥é€»è¾‘
- âœ… IM æ¥å£æ”¹é€  - 5ä¸ªæ–‡ä»¶ï¼Œ10ä¸ªè·¯ç”±

---

## âŒ å½“å‰é—®é¢˜

### é—®é¢˜ç—‡çŠ¶

Worker æ²¡æœ‰æ¨é€æ•°æ®åˆ° Masterï¼š

```
DataStore çŠ¶æ€ï¼š
  æ€»è´¦æˆ·æ•°: 0
  æ€»è¯„è®ºæ•°: 0
  æ€»ä½œå“æ•°: 0
  æ€»ä¼šè¯æ•°: 0
  æ€»ç§ä¿¡æ•°: 0

DataSync çŠ¶æ€ï¼š
  æ€»æ¥æ”¶æ¬¡æ•°: 0
  æœ€åæ¥æ”¶æ—¶é—´: N/A
```

### æ ¹æœ¬åŸå› 

Worker åœ¨åˆå§‹åŒ–è´¦æˆ·æ—¶é‡åˆ°é”™è¯¯ï¼Œå¯¼è‡´çˆ¬è™«æ²¡æœ‰æˆåŠŸå¯åŠ¨ï¼š

```
è´¦æˆ·çŠ¶æ€:
  ç™»å½•çŠ¶æ€: logged_in  âœ…
  WorkerçŠ¶æ€: offline    âŒ
  æœ€åé”™è¯¯: "setContentsGlobalContext is not a function"
```

**åˆ†æ**:
1. Worker è¿›ç¨‹æ­£å¸¸è¿è¡Œ
2. Worker è¿æ¥åˆ° Master æˆåŠŸ
3. è´¦æˆ·åˆ†é…ç»™ Worker æˆåŠŸ
4. **ä½†æ˜¯è´¦æˆ·åˆå§‹åŒ–å¤±è´¥** - é‡åˆ° "setContentsGlobalContext is not a function" é”™è¯¯
5. å› æ­¤æ²¡æœ‰åˆ›å»º DouyinDataManager
6. å› æ­¤æ²¡æœ‰å¯åŠ¨æ•°æ®åŒæ­¥å®šæ—¶å™¨
7. å› æ­¤æ²¡æœ‰æ¨é€æ•°æ®åˆ° Master

### é—®é¢˜å®šä½

é”™è¯¯ "setContentsGlobalContext is not a function" æ¥è‡ªå“ªé‡Œï¼Ÿ

è®©æˆ‘ä»¬æ£€æŸ¥ä»£ç ï¼š

```bash
# åœ¨ packages/worker ä¸­æœç´¢
grep -r "setContentsGlobalContext" packages/worker/
```

**é¢„æœŸç»“æœ**: æ‰¾åˆ°è°ƒç”¨ `setContentsGlobalContext` çš„ä»£ç ä½ç½®

**é—®é¢˜**: è¿™ä¸ªå‡½æ•°å¯èƒ½ï¼š
1. ä¸å­˜åœ¨ï¼ˆæ‹¼å†™é”™è¯¯ï¼‰
2. åœ¨æŸä¸ªæ¨¡å—ä¸­æœªæ­£ç¡®å¯¼å‡º
3. åœ¨é‡æ„è¿‡ç¨‹ä¸­è¢«åˆ é™¤ä½†ä»æœ‰è°ƒç”¨

---

## ğŸ“‹ ä¸‹ä¸€æ­¥è¡ŒåŠ¨è®¡åˆ’

### ç«‹å³è¡ŒåŠ¨ï¼ˆå¿…éœ€ï¼‰

#### æ­¥éª¤ 1: å®šä½é”™è¯¯æº

```bash
# æœç´¢ setContentsGlobalContext
grep -rn "setContentsGlobalContext" packages/worker/

# æœç´¢ setGlobalContext (å¯èƒ½çš„æ­£ç¡®å‡½æ•°å)
grep -rn "setGlobalContext" packages/worker/

# æœç´¢ setContents (å¯èƒ½çš„å‡½æ•°å‰ç¼€)
grep -rn "setContents" packages/worker/ | grep -v node_modules
```

#### æ­¥éª¤ 2: ä¿®å¤å‡½æ•°è°ƒç”¨é”™è¯¯

æ ¹æ®æ­¥éª¤1çš„ç»“æœï¼š
- å¦‚æœæ˜¯æ‹¼å†™é”™è¯¯ï¼Œä¿®æ­£å‡½æ•°å
- å¦‚æœå‡½æ•°ä¸å­˜åœ¨ï¼Œå®ç°å‡½æ•°æˆ–åˆ é™¤è°ƒç”¨
- å¦‚æœå‡½æ•°æœªå¯¼å‡ºï¼Œæ·»åŠ å¯¼å‡ºè¯­å¥

#### æ­¥éª¤ 3: é‡å¯ Worker éªŒè¯ä¿®å¤

```bash
# åœæ­¢ Worker
taskkill /F /PID <worker-pid>

# Master ä¼šè‡ªåŠ¨é‡å¯ Workerï¼ˆç­‰å¾…10ç§’ï¼‰

# ç­‰å¾…45ç§’è®© Worker åˆå§‹åŒ–å¹¶æ‰§è¡Œé¦–æ¬¡åŒæ­¥

# æ£€æŸ¥ DataStore çŠ¶æ€
node tests/æ‰‹åŠ¨è§¦å‘æ•°æ®åŒæ­¥.js

# æ£€æŸ¥è´¦æˆ·çŠ¶æ€
node tests/æŸ¥è¯¢è´¦æˆ·çŠ¶æ€.js
```

**æˆåŠŸæ ‡å¿—**:
```
è´¦æˆ·çŠ¶æ€:
  WorkerçŠ¶æ€: online  âœ…
  æœ€åé”™è¯¯: null

DataStore çŠ¶æ€ï¼š
  æ€»è´¦æˆ·æ•°: 1  âœ…
  æ€»ä¼šè¯æ•°: > 0
  æœ€åæ›´æ–°: <æ—¶é—´æˆ³>

DataSync çŠ¶æ€ï¼š
  æ€»æ¥æ”¶æ¬¡æ•°: > 0  âœ…
```

### åç»­éªŒè¯ï¼ˆæ¨èï¼‰

#### 1. ç«¯åˆ°ç«¯æµ‹è¯•

```bash
# æµ‹è¯• IM API æ˜¯å¦è¿”å›æ•°æ®
curl http://localhost:3000/api/im/conversations?account_id=acc-98296c87-2e42-447a-9d8b-8be008ddb6e4

# æµ‹è¯•ç»Ÿä¸€æ¶ˆæ¯ API
curl http://localhost:3000/api/im/unified-messages?account_id=acc-98296c87-2e42-447a-9d8b-8be008ddb6e4
```

#### 2. æ€§èƒ½æµ‹è¯•

```bash
# åˆ›å»ºæ€§èƒ½æµ‹è¯•è„šæœ¬
node tests/æµ‹è¯•APIæ€§èƒ½.js
```

æœŸæœ›ç»“æœï¼š
- å“åº”æ—¶é—´ < 5msï¼ˆvs æ•°æ®åº“æŸ¥è¯¢ 10-50msï¼‰
- å¹¶å‘1000è¯·æ±‚æ— å‹åŠ›

---

## ğŸ“Š å®ç°è¿›åº¦

### ä»£ç å®Œæˆåº¦: 100%

- âœ… ä¿®å¤ MessageTypes å¯¼å‡ºï¼ˆ1è¡Œä»£ç ï¼‰
- âœ… æ·»åŠ è°ƒè¯•æ—¥å¿—ï¼ˆ50+ è¡Œï¼‰
- âœ… DataStore å®ç°ï¼ˆ465è¡Œï¼‰
- âœ… DataSyncReceiver å®ç°ï¼ˆ117è¡Œï¼‰
- âœ… Master é›†æˆï¼ˆæ³¨å†Œå¤„ç†å™¨ï¼‰
- âœ… Worker æ•°æ®æ¨é€ï¼ˆDataPusher + syncToMasterï¼‰
- âœ… IM æ¥å£æ”¹é€ ï¼ˆ5ä¸ªæ–‡ä»¶ï¼Œ10ä¸ªè·¯ç”±ï¼‰
- âœ… å•å…ƒæµ‹è¯•è„šæœ¬ï¼ˆ4ä¸ªæ–‡ä»¶ï¼‰

### æµ‹è¯•å®Œæˆåº¦: 50%

- âœ… MessageTypes å¯¼å‡ºæµ‹è¯• - é€šè¿‡
- âœ… DataManager åŒæ­¥å•å…ƒæµ‹è¯• - é€šè¿‡
- âŒ Worker å®é™…æ•°æ®æ¨é€é›†æˆæµ‹è¯• - å—é˜»ï¼ˆè´¦æˆ·åˆå§‹åŒ–é”™è¯¯ï¼‰
- â³ IM API ç«¯åˆ°ç«¯æµ‹è¯• - å¾…æ‰§è¡Œ
- â³ æ€§èƒ½å‹æµ‹ - å¾…æ‰§è¡Œ

### æ€»ä½“è¿›åº¦: 90%

**é˜»å¡å› ç´ **: Worker è´¦æˆ·åˆå§‹åŒ–é”™è¯¯ "setContentsGlobalContext is not a function"

**è§£é™¤é˜»å¡æ‰€éœ€æ—¶é—´**: é¢„è®¡ 10-20 åˆ†é’Ÿ
- 5åˆ†é’Ÿï¼šå®šä½é”™è¯¯æº
- 5åˆ†é’Ÿï¼šä¿®å¤é”™è¯¯
- 10åˆ†é’Ÿï¼šé‡å¯ Worker å¹¶éªŒè¯

---

## ğŸ¯ æˆåŠŸæ ‡å‡†

### æœ€å°å¯è¡Œäº§å“ (MVP)

- [x] MessageTypes æ­£ç¡®å¯¼å‡º
- [x] å•å…ƒæµ‹è¯•é€šè¿‡ï¼ˆMessageTypes + DataManagerï¼‰
- [ ] Worker æˆåŠŸæ¨é€æ•°æ®åˆ° Master
- [ ] Master DataStore æ¥æ”¶å¹¶å­˜å‚¨æ•°æ®
- [ ] IM API è¿”å› DataStore ä¸­çš„æ•°æ®
- [ ] å“åº”æ—¶é—´ < 10ms

### å®Œæ•´åŠŸèƒ½

- [ ] å¤šè´¦æˆ·æ”¯æŒ
- [ ] å¹¶å‘å¤„ç†ï¼ˆ1000 req/sï¼‰
- [ ] æ€§èƒ½ç›‘æ§æŒ‡æ ‡
- [ ] é”™è¯¯æ¢å¤æœºåˆ¶
- [ ] æ—¥å¿—å®Œæ•´æ€§

---

## ğŸ“ ç»éªŒæ•™è®­

### æŠ€æœ¯å±‚é¢

1. **æ¨¡å—å¯¼å‡ºé™·é˜±**
   - CommonJS çš„ `module.exports =` éœ€è¦ä¸è§£æ„ `{ key }` åŒ¹é…
   - è§£å†³ï¼šæ˜¾å¼æ·»åŠ  `module.exports.MessageTypes = MessageTypes`

2. **æ—¥å¿—å¯è§æ€§**
   - Worker çš„ console.log è¢« Master æ•è·
   - è§£å†³ï¼šæ·»åŠ æ˜æ˜¾çš„å‰ç¼€å’Œemojiæ ‡è®°

3. **å•å…ƒæµ‹è¯•çš„ä»·å€¼**
   - ç›´æ¥æµ‹è¯•å¯¼å‡ºå¯ä»¥å¿«é€Ÿå®šä½é—®é¢˜
   - æ¯”ç«¯åˆ°ç«¯è°ƒè¯•å¿«10å€

4. **é”™è¯¯å¤„ç†çš„é‡è¦æ€§**
   - è´¦æˆ·åˆå§‹åŒ–é”™è¯¯ä¼šé˜»å¡æ•´ä¸ªæ•°æ®æµ
   - éœ€è¦å¥å£®çš„é”™è¯¯æ¢å¤æœºåˆ¶

### æµç¨‹å±‚é¢

1. **é€æ­¥éªŒè¯**
   - å…ˆéªŒè¯æœ€åº•å±‚ï¼ˆMessageTypesï¼‰
   - å†éªŒè¯ä¸­é—´å±‚ï¼ˆDataPusherï¼‰
   - æœ€åéªŒè¯é¡¶å±‚ï¼ˆWorkeræ•´ä½“ï¼‰

2. **æ—¥å¿—é©±åŠ¨è°ƒè¯•**
   - åœ¨å…³é”®ä½ç½®æ·»åŠ æ—¥å¿—
   - ä½¿ç”¨ console.log ç¡®ä¿å¯è§
   - åŒ…å«æ—¶é—´æˆ³ã€ç»„ä»¶åã€æ•°æ®

3. **é—®é¢˜éš”ç¦»**
   - åˆ›å»ºç‹¬ç«‹çš„æµ‹è¯•è„šæœ¬
   - æ¨¡æ‹Ÿä¾èµ–ï¼ˆmockBridgeï¼‰
   - éªŒè¯å•ä¸ªç»„ä»¶è¡Œä¸º

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Workeræ•°æ®æ¨é€é—®é¢˜ä¿®å¤æ€»ç»“.md](Workeræ•°æ®æ¨é€é—®é¢˜ä¿®å¤æ€»ç»“.md) - ç®€æ˜ä¿®å¤æ€»ç»“
- [æ•°æ®åŒæ­¥é—®é¢˜è°ƒè¯•æœ€ç»ˆæŠ¥å‘Š.md](æ•°æ®åŒæ­¥é—®é¢˜è°ƒè¯•æœ€ç»ˆæŠ¥å‘Š.md) - è¯¦ç»†è°ƒè¯•è¿‡ç¨‹
- [Workeråˆ°Masteræ•°æ®æ¨é€æµ‹è¯•æŠ¥å‘Š.md](Workeråˆ°Masteræ•°æ®æ¨é€æµ‹è¯•æŠ¥å‘Š.md) - åŸå§‹æµ‹è¯•æŠ¥å‘Š
- [IMæ¥å£DataStoreé›†æˆå®ŒæˆæŠ¥å‘Š.md](IMæ¥å£DataStoreé›†æˆå®ŒæˆæŠ¥å‘Š.md) - IMæ¥å£é›†æˆæ–‡æ¡£
- [Masteré›†æˆå®ŒæˆæŠ¥å‘Š.md](Masteré›†æˆå®ŒæˆæŠ¥å‘Š.md) - Masteré›†æˆæ–‡æ¡£

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-30 16:02
**æŠ¥å‘Šç”Ÿæˆè€…**: Claude (Anthropic)
**çŠ¶æ€**: âš ï¸ ç­‰å¾…ä¿®å¤è´¦æˆ·åˆå§‹åŒ–é”™è¯¯
