# 评论回复测试脚本使用指南

## 概述

`tests/replyToCommentById.js` 是一个用于测试抖音评论自动回复功能的脚本。它可以通过 Chrome DevTools Protocol (CDP) 连接到正在运行的浏览器，模拟用户回复评论的操作。

## 核心修复

### 问题描述
之前的版本使用 `page.evaluate()` 内部的 `element.click()` 来点击发送按钮，这种方式**无法正确触发 React 的合成事件系统**，导致消息无法真正发送。

### 解决方案
改用 **Playwright 原生的 `click()` 方法**：

```javascript
// ❌ 错误的方式（无法触发 React 事件）
await page.evaluate((btn) => {
  btn.click();
  btn.dispatchEvent(new MouseEvent('click', { bubbles: true }));
}, buttonElement);

// ✅ 正确的方式（触发所有事件）
await buttonElement.scrollIntoViewIfNeeded();
await buttonElement.click({ force: false });
```

## 使用方法

### 1. 启动带调试端口的 Chrome

运行启动脚本：
```bash
.\tests\start-chrome-debug.bat
```

或手动启动：
```bash
"C:\Program Files\Google\Chrome\Application\chrome.exe" --remote-debugging-port=9222 --user-data-dir="E:\HISCRM-IM-main\test-browser-data-manual" --no-first-run --no-default-browser-check --disable-blink-features=AutomationControlled
```

### 2. 在浏览器中登录

1. 在打开的 Chrome 中访问：`https://creator.douyin.com/creator-micro/interactive/comment`
2. 使用抖音账号登录
3. 确保能看到评论管理页面

### 3. 运行测试脚本

#### 顶级回复（回复作品）

```bash
node tests/replyToCommentById.js --port 9222 --url "https://creator.douyin.com/creator-micro/interactive/comment" --text "这是一条测试回复"
```

#### 回复特定评论

```bash
node tests/replyToCommentById.js --port 9222 --url "https://creator.douyin.com/creator-micro/interactive/comment" --commentId=7445842877768090406 --text "回复特定评论的内容"
```

#### Dry-Run 模式（验证但不实际发送）

```bash
node tests/replyToCommentById.js --port 9222 --url "https://creator.douyin.com/creator-micro/interactive/comment" --text "dry-run 测试" --dry-run
```

## 参数说明

| 参数 | 必需 | 说明 |
|------|------|------|
| `--port` | 否 | Chrome 调试端口，默认 9222 |
| `--url` | 否 | 评论管理页面 URL |
| `--commentId` | 否 | 要回复的评论 ID。省略则回复作品（顶级回复） |
| `--text` | 否 | 回复内容，默认为"自动化回复 - 请忽略" |
| `--dry-run` | 否 | 仅验证流程，不实际发送（会捕获网络请求） |

## 输出结果

脚本会输出 JSON 格式的结果：

```json
{
  "target": "work",
  "sent": true,
  "screenshotPath": "e:\\HISCRM-IM-main\\tests\\reply-by-id-1762919847223.png"
}
```

- `target`: 回复目标（`work` = 作品回复，或具体的 `commentId`）
- `sent`: 是否成功发送（`true`/`false`）
- `screenshotPath`: 执行后的截图路径
- `error`: 如果失败，包含错误信息
- `dryRunCaptured`: dry-run 模式下捕获的网络请求信息

## 工作原理

### 1. 查找评论容器

脚本使用两种策略查找评论：

**策略 A：DOM 属性查找**
```javascript
const selectors = ['[data-comment-id]', '[data-id]', '[data-cid]'];
```

**策略 B：React Fiber 查找**
```javascript
const fiber = element.__reactFiber$xxx;
const props = fiber.memoizedProps;
if (props.commentId === targetId) { /* 找到了 */ }
```

### 2. 点击回复按钮

```javascript
// 在评论操作区找到"回复"按钮
const btn = container.querySelector('.operations-WFV7Am').querySelector('回复');
await btn.click();
```

### 3. 输入文本

```javascript
const input = container.querySelector('div[contenteditable="true"]');
await input.focus();
await page.keyboard.type(text, { delay: 40 });
```

### 4. 点击发送按钮

优先查找抖音平台特定的按钮：
```javascript
const btn = container.querySelector('button.douyin-creator-interactive-button');
if (btn.innerText === '发送' && !btn.disabled) {
  await btn.scrollIntoViewIfNeeded();
  await btn.click({ force: false });
}
```

## 调试技巧

### 1. 检查发送按钮状态

运行调试脚本：
```bash
node tests/debug-send-button.js
```

这会显示页面上所有"发送"按钮的详细信息：
- 标签名、类名
- 是否禁用（`disabled`, `aria-disabled`）
- 是否有 React Fiber
- 位置坐标

### 2. 验证浏览器连接

```bash
curl http://localhost:9222/json/version
```

应该返回 Chrome 版本信息和 WebSocket URL。

### 3. 查看截图

每次运行都会在 `tests/` 目录生成截图，文件名格式：
```
reply-by-id-{timestamp}.png
```

## 常见问题

### Q: 提示 "connect EACCES ::1:9222"
**A:** Chrome 浏览器未启动或端口不是 9222。请先运行 `.\tests\start-chrome-debug.bat`。

### Q: 返回 `"sent": true` 但消息未发送
**A:** 这通常是点击事件未正确触发。确保使用的是修复后的脚本版本（使用 Playwright 原生 `click()`）。

### Q: 找不到评论 ID
**A:**
1. 检查 `--commentId` 参数是否正确（需要是字符串形式的大整数）
2. 确保评论在当前页面可见（可能需要滚动）
3. 使用 `debug-send-button.js` 检查页面 DOM 结构

### Q: Dry-run 模式没有捕获到请求
**A:**
1. 确保页面已完全加载
2. 检查网络请求是否被浏览器扩展拦截
3. 可能抖音使用了不同的 API 端点（检查脚本第 389 行的正则表达式）

## 集成到 Worker

这个测试脚本的核心逻辑已经集成到 Worker 的抖音平台实现中：

- **发送回复**: `packages/worker/src/platforms/douyin/send-reply-to-comment-v2.js`
- **私信回复**: `packages/worker/src/platforms/douyin/send-reply-to-dm.js`

Worker 使用相同的技术：
- React Fiber 数据提取
- Playwright 原生点击事件
- 多层后备策略

## 相关文档

- [05-DOUYIN-平台实现技术细节.md](./05-DOUYIN-平台实现技术细节.md) - 抖音平台技术详解
- [06-WORKER-爬虫调试指南.md](./06-WORKER-爬虫调试指南.md) - 爬虫调试方法
- [07-DOUYIN-消息回复功能技术总结.md](./07-DOUYIN-消息回复功能技术总结.md) - 回复功能实现

## 更新日志

### 2025-01-12
- ✅ 修复发送按钮点击问题：改用 Playwright 原生 `click()` 方法
- ✅ 修复顶级回复功能（回复作品）
- ✅ 修复评论回复功能（回复特定评论）
- ✅ 添加发送按钮调试脚本 `debug-send-button.js`
- ✅ 优化按钮查找逻辑：优先查找 `button.douyin-creator-interactive-button`
