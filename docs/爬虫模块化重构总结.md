# çˆ¬è™«æ¨¡å—åŒ–é‡æ„æ€»ç»“

**æ—¥æœŸ**: 2025-10-24
**çŠ¶æ€**: ğŸ”„ è¿›è¡Œä¸­ï¼ˆè¯„è®ºçˆ¬è™«å·²å®Œæˆï¼Œplatform.js é›†æˆå¾…å®Œæˆï¼‰

---

## ğŸ“‹ é‡æ„ç›®æ ‡

ç”¨æˆ·æå‡ºäº†ä¸€ä¸ªé‡è¦çš„æ¶æ„æ”¹è¿›å»ºè®®ï¼š

> "æ—¢ç„¶ä½ æ‹†å¼€äº† crawl-works.jsã€crawl-discussions.jsã€crawl-direct-messages-v2.js 3ä¸ªæ–‡ä»¶ï¼Œåˆ†åˆ«æŠ“å–ä½œå“ï¼Œè¯„è®ºï¼Œç§ä¿¡ï¼Œé‚£ä¹ˆåŸæœ‰åœ¨ platform.js è¯„è®ºç§ä¿¡æŠ“å–å’Œapi æ‹¦æˆªå®ç°ï¼Œä¹Ÿå¯¹åº”æŠ½ç¦»åˆ°å¯¹åº”çš„jsé‡Œï¼Œè¿™æ ·æ–¹ä¾¿ç»Ÿä¸€ç®¡ç†å’Œä¿®æ”¹"

### æ ¸å¿ƒè®¾è®¡ç†å¿µ

**è¯„è®ºå’Œè®¨è®ºæ˜¯ä¸€ä½“çš„ï¼Œå°±åƒç§ä¿¡å’Œä¼šè¯ä¸€æ ·**ï¼š

```
ç§ä¿¡çˆ¬è™« (crawl-direct-messages-v2.js)
  â”œâ”€ ç§ä¿¡ (direct_messages)  - æ¶ˆæ¯å†…å®¹
  â””â”€ ä¼šè¯ (conversations)    - ä¼šè¯å…ƒæ•°æ®

è¯„è®ºçˆ¬è™« (crawl-comments.js)  â† æ–°è®¾è®¡
  â”œâ”€ è¯„è®º (comments)         - ä¸€çº§è¯„è®º
  â””â”€ è®¨è®º (discussions)      - äºŒçº§/ä¸‰çº§å›å¤
```

---

## âœ… å·²å®Œæˆå·¥ä½œ

### 1. åˆ›å»ºç»Ÿä¸€çš„è¯„è®ºçˆ¬è™«æ¨¡å—

**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/crawl-comments.js`

**åŠŸèƒ½**:
- ä¸€æ¬¡çˆ¬å–åŒæ—¶è¿”å›è¯„è®ºå’Œè®¨è®ºï¼ˆäºŒçº§/ä¸‰çº§å›å¤ï¼‰
- API æ‹¦æˆªï¼šç›‘å¬ `/comment.*list/` å’Œ `/comment.*reply/` ä¸¤ç§ API
- ç‚¹å‡»+æ‹¦æˆªç­–ç•¥ï¼šæ‰¹é‡ç‚¹å‡»è§†é¢‘è§¦å‘ API è¯·æ±‚
- åˆ†é¡µå¤„ç†ï¼šè‡ªåŠ¨æ»šåŠ¨åŠ è½½ `has_more` ä¸º true çš„è§†é¢‘è¯„è®º
- æ•°æ®å»é‡ï¼šé€šè¿‡ `platform_comment_id` / `platform_discussion_id` å»é‡

**è¿”å›ç»“æ„**:
```javascript
{
  comments: Array,      // ä¸€çº§è¯„è®ºåˆ—è¡¨
  discussions: Array,   // äºŒçº§/ä¸‰çº§å›å¤åˆ—è¡¨
  works: Array,         // ä½œå“å…ƒæ•°æ®åˆ—è¡¨
  stats: Object         // ç»Ÿè®¡ä¿¡æ¯
}
```

**æ ¸å¿ƒæ–¹æ³•**:
- `crawlComments(page, account, options)` - ä¸»çˆ¬è™«å‡½æ•°
- `navigateToCommentManage(page)` - å¯¼èˆªåˆ°è¯„è®ºç®¡ç†é¡µé¢
- `extractItemId(url)` - ä» URL æå– item_id
- `extractCursor(url)` - ä» URL æå– cursor
- `extractCommentId(url)` - ä» URL æå– comment_idï¼ˆçˆ¶è¯„è®º IDï¼‰
- `groupResponsesByItemId(responses)` - æŒ‰ä½œå“ ID åˆ†ç»„
- `groupDiscussionsByCommentId(responses)` - æŒ‰è¯„è®º ID åˆ†ç»„

### 2. åˆ é™¤é‡å¤æ¨¡å—

**å·²åˆ é™¤**: `packages/worker/src/platforms/douyin/crawl-discussions.js`

**åŸå› **: è®¨è®ºæ•°æ®ç°åœ¨ç”± `crawl-comments.js` ç»Ÿä¸€å¤„ç†ï¼Œæ— éœ€ç‹¬ç«‹æ–‡ä»¶

### 3. æ›´æ–°å¯¼å…¥è¯­å¥

**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/platform.js`

```javascript
const { crawlDirectMessagesV2 } = require('./crawl-direct-messages-v2');
const { crawlWorks } = require('./crawl-works');
const { crawlComments: crawlCommentsV2 } = require('./crawl-comments');  // âœ… æ–°å¢
```

---

## ğŸ”§ å¾…å®Œæˆå·¥ä½œ

### 1. é‡æ„ platform.js ä¸­çš„ crawlComments æ–¹æ³•

**å½“å‰é—®é¢˜**:
- `platform.js` çš„ `crawlComments` æ–¹æ³•è¿˜åŒ…å«å¤§é‡çˆ¬è™«é€»è¾‘ï¼ˆçº¦ 400 è¡Œï¼‰
- éœ€è¦ç®€åŒ–ä¸ºè°ƒç”¨ `crawlCommentsV2` å¹¶å¤„ç†è¿”å›æ•°æ®

**ç›®æ ‡å®ç°**:
```javascript
async crawlComments(account, options = {}) {
  try {
    logger.info(`[crawlComments] Starting comments+discussions crawl for account ${account.id}`);

    // 1. è·å–æˆ–åˆ›å»ºé¡µé¢
    const page = await this.getOrCreatePage(account.id, 'spider2');

    // 2. æ‰§è¡Œè¯„è®ºå’Œè®¨è®ºçˆ¬è™«
    const crawlResult = await crawlCommentsV2(page, account, options);
    const { comments, discussions, works, stats: crawlStats } = crawlResult;

    // 3. å‘é€è¯„è®ºæ•°æ®åˆ° Master
    await this.sendCommentsToMaster(account, comments, works);

    // 4. å‘é€è®¨è®ºæ•°æ®åˆ° Master
    await this.sendDiscussionsToMaster(account, discussions);

    // 5. è¿”å›ç»“æœ
    return {
      comments,
      discussions,
      works,
      stats: { ...crawlStats, crawl_time: Math.floor(Date.now() / 1000) },
    };
  } catch (error) {
    logger.error(`[crawlComments] âŒ FATAL ERROR:`, error);
    throw error;
  }
}
```

### 2. åˆ é™¤ platform.js ä¸­çš„å†—ä½™æ–¹æ³•

ä»¥ä¸‹æ–¹æ³•å·²è¿ç§»åˆ° `crawl-comments.js`ï¼Œå¯æ ‡è®°ä¸º `@deprecated`ï¼š

- `extractItemId(url)`
- `extractCursor(url)`
- `groupResponsesByItemId(responses)`
- `navigateToCommentManage(page)`
- `getVideoListFromCommentPage(page)`
- `clickVideoInCommentPage(page, video, index)`
- `scrollCommentList(page)`
- `extractComments(page)`
- `parseCommentsFromAPI(apiResponses)`

### 3. åˆ é™¤ crawlDiscussionsData æ–¹æ³•

**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/platform.js`

**åŸå› **: è®¨è®ºæ•°æ®ç°åœ¨ç”± `crawlComments` ç»Ÿä¸€è¿”å›ï¼Œä¸éœ€è¦ç‹¬ç«‹æ–¹æ³•

**éœ€åˆ é™¤**:
- `crawlDiscussionsData(account, comments, options)` æ–¹æ³•
- `sendDiscussionsToMaster(account, discussions)` æ–¹æ³•

---

## ğŸ“ æ–‡ä»¶ç»“æ„å¯¹æ¯”

### é‡æ„å‰

```
packages/worker/src/platforms/douyin/
â”œâ”€ platform.js                    (3800 è¡Œ, åŒ…å«å¤§é‡çˆ¬è™«é€»è¾‘)
â”‚   â”œâ”€ crawlComments()            (400 è¡Œçˆ¬è™«ä»£ç )
â”‚   â”œâ”€ crawlDirectMessages()      (è°ƒç”¨ crawl-direct-messages-v2.js)
â”‚   â”œâ”€ crawlWorksData()           (è°ƒç”¨ crawl-works.js)
â”‚   â””â”€ crawlDiscussionsData()     (è°ƒç”¨ crawl-discussions.js)
â”‚
â”œâ”€ crawl-direct-messages-v2.js    (å®Œæ•´ç‹¬ç«‹æ¨¡å—)
â”œâ”€ crawl-works.js                 (å®Œæ•´ç‹¬ç«‹æ¨¡å—)
â””â”€ crawl-discussions.js           (å®Œæ•´ç‹¬ç«‹æ¨¡å—)
```

### é‡æ„å

```
packages/worker/src/platforms/douyin/
â”œâ”€ platform.js                    (ç®€åŒ–åçº¦ 3000 è¡Œ)
â”‚   â”œâ”€ crawlComments()            (50 è¡Œåè°ƒä»£ç ) âœ…
â”‚   â”œâ”€ crawlDirectMessages()      (50 è¡Œåè°ƒä»£ç )
â”‚   â””â”€ crawlWorksData()           (50 è¡Œåè°ƒä»£ç )
â”‚
â”œâ”€ crawl-comments.js              (è¯„è®º+è®¨è®ºä¸€ä½“åŒ–) âœ… æ–°å¢
â”œâ”€ crawl-direct-messages-v2.js    (ç§ä¿¡+ä¼šè¯ä¸€ä½“åŒ–)
â””â”€ crawl-works.js                 (ä½œå“çˆ¬å–)
```

---

## ğŸ¯ è®¾è®¡åŸåˆ™

### 1. æ¨¡å—åŒ–åŸåˆ™

æ¯ä¸ªçˆ¬è™«æ¨¡å—åº”è¯¥æ˜¯å®Œæ•´ç‹¬ç«‹çš„ï¼š
- âœ… åŒ…å«å®Œæ•´çš„çˆ¬è™«é€»è¾‘
- âœ… åŒ…å« API æ‹¦æˆªå™¨è®¾ç½®
- âœ… åŒ…å«æ•°æ®æå–å’Œè½¬æ¢
- âœ… æš´éœ²æ¸…æ™°çš„æ¥å£

### 2. å…³è”æ•°æ®ä¸€ä½“åŒ–åŸåˆ™

å…³è”ç´§å¯†çš„æ•°æ®åº”è¯¥ä¸€èµ·çˆ¬å–ï¼š
- âœ… ç§ä¿¡ + ä¼šè¯ (direct_messages + conversations)
- âœ… è¯„è®º + è®¨è®º (comments + discussions)
- âœ… ä½œå“ + å…ƒæ•°æ® (works + metadata)

### 3. Platform åè°ƒå±‚åŸåˆ™

`platform.js` ä½œä¸ºå¹³å°åè°ƒå±‚ï¼Œåº”è¯¥ï¼š
- âœ… ç®¡ç†æµè§ˆå™¨é¡µé¢ç”Ÿå‘½å‘¨æœŸ
- âœ… è°ƒç”¨ä¸“ç”¨çˆ¬è™«æ¨¡å—
- âœ… å¤„ç†æ•°æ®ä¸ŠæŠ¥åˆ° Master
- âŒ ä¸åŒ…å«å…·ä½“çš„çˆ¬è™«å®ç°é€»è¾‘

---

## ğŸ”„ API æ‹¦æˆªç­–ç•¥

### è¯„è®ºçˆ¬è™« API æ‹¦æˆª

```javascript
// ä¸€çº§è¯„è®º API
const commentApiPattern = /comment.*list/i;

// äºŒçº§/ä¸‰çº§å›å¤ APIï¼ˆè®¨è®ºï¼‰
const discussionApiPattern = /comment.*reply/i;

// æ‹¦æˆªå™¨åŒæ—¶ç›‘å¬ä¸¤ç§ API
page.on('response', async (response) => {
  // å¤„ç†ä¸€çº§è¯„è®º
  if (commentApiPattern.test(url) && json.comment_info_list) {
    apiResponses.comments.push(json);
  }

  // å¤„ç†äºŒçº§/ä¸‰çº§å›å¤
  if (discussionApiPattern.test(url) && json.reply_list) {
    apiResponses.discussions.push(json);
  }
});
```

### ç§ä¿¡çˆ¬è™« API æ‹¦æˆª

```javascript
// ä¼šè¯åˆ—è¡¨ API
const conversationApiPattern = /webcast\/im\/conversation\/list/;

// ç§ä¿¡å†…å®¹ API
const messageApiPattern = /webcast\/im\/conversation\/detail/;
```

---

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„å¯¹åº”

### Commentsï¼ˆä¸€çº§è¯„è®ºï¼‰

```sql
CREATE TABLE comments (
  id TEXT PRIMARY KEY,
  platform_comment_id TEXT NOT NULL,
  content TEXT,
  author_name TEXT,
  author_id TEXT,
  author_avatar TEXT,
  create_time INTEGER,
  like_count INTEGER DEFAULT 0,
  reply_count INTEGER DEFAULT 0,
  detected_at INTEGER,
  post_title TEXT,
  post_id TEXT,
  UNIQUE(account_id, platform, platform_user_id, platform_comment_id)
);
```

### Discussionsï¼ˆäºŒçº§/ä¸‰çº§å›å¤ï¼‰

```sql
CREATE TABLE discussions (
  id TEXT PRIMARY KEY,
  platform_discussion_id TEXT NOT NULL,
  parent_comment_id TEXT,           -- çˆ¶è¯„è®º ID
  work_id TEXT,                      -- ä½œå“ ID
  content TEXT,
  author_name TEXT,
  create_time INTEGER,
  like_count INTEGER DEFAULT 0,
  reply_count INTEGER DEFAULT 0,
  FOREIGN KEY (parent_comment_id) REFERENCES comments(id),
  FOREIGN KEY (work_id) REFERENCES works(id),
  UNIQUE(account_id, platform, platform_user_id, platform_discussion_id)
);
```

---

## ğŸš€ ä¸‹ä¸€æ­¥å·¥ä½œ

### ç«‹å³ä»»åŠ¡

1. **å®Œæˆ platform.js çš„ crawlComments æ–¹æ³•é‡æ„**
   - åˆ é™¤æ—§çš„çˆ¬è™«é€»è¾‘ï¼ˆçº¦ 400 è¡Œï¼‰
   - è°ƒç”¨ `crawlCommentsV2`
   - å¤„ç†è¿”å›çš„è¯„è®ºå’Œè®¨è®ºæ•°æ®

2. **åˆ é™¤å†—ä½™æ–¹æ³•**
   - æ ‡è®°ä¸º `@deprecated` æˆ–ç›´æ¥åˆ é™¤
   - æ›´æ–°æ‰€æœ‰å¼•ç”¨è¿™äº›æ–¹æ³•çš„ä»£ç 

3. **æµ‹è¯•éªŒè¯**
   - æµ‹è¯•è¯„è®ºçˆ¬å–åŠŸèƒ½
   - æµ‹è¯•è®¨è®ºçˆ¬å–åŠŸèƒ½
   - éªŒè¯æ•°æ®æ­£ç¡®ä¸ŠæŠ¥åˆ° Master

### æœªæ¥æ”¹è¿›

1. **å®šä¹‰ç»Ÿä¸€çš„çˆ¬è™«æ¥å£è§„èŒƒ**ï¼ˆç”¨æˆ·å»ºè®®ï¼‰
   - åœ¨ `platform-base.js` ä¸­å®šä¹‰æ ‡å‡†è¿”å›ç»“æ„
   - æ¯ä¸ªå¹³å°æŒ‰ç…§ç»Ÿä¸€æ¥å£å®ç°
   - æ¶ˆé™¤è·¨å¹³å°å·®å¼‚

2. **è¿›ä¸€æ­¥æ¨¡å—åŒ–**
   - æå–å…±ç”¨çš„ API æ‹¦æˆªé€»è¾‘
   - æå–å…±ç”¨çš„æ•°æ®è½¬æ¢é€»è¾‘
   - åˆ›å»ºçˆ¬è™«åŸºç±»

3. **é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶**
   - ç»Ÿä¸€çš„é”™è¯¯å¤„ç†ç­–ç•¥
   - è‡ªåŠ¨é‡è¯•æœºåˆ¶
   - é™çº§æ–¹æ¡ˆï¼ˆAPI â†’ React Fiber â†’ DOMï¼‰

---

## ğŸ“ é‡è¦æç¤º

### âš ï¸ å…¼å®¹æ€§æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**
   - ä¿ç•™ `extractItemId`ã€`extractCursor` ç­‰æ–¹æ³•ä»¥ä¿æŒå…¼å®¹æ€§
   - æ ‡è®°ä¸º `@deprecated` è€Œä¸æ˜¯ç›´æ¥åˆ é™¤
   - é€æ­¥è¿ç§»åˆ°æ–°çš„æ¨¡å—åŒ–æ¶æ„

2. **æ•°æ®æ ¼å¼**
   - ç¡®ä¿è¿”å›çš„æ•°æ®ç»“æ„ä¸ Master æœŸæœ›çš„æ ¼å¼ä¸€è‡´
   - ä¿æŒå­—æ®µå‘½åçš„ä¸€è‡´æ€§
   - æ–‡æ¡£åŒ–æ‰€æœ‰æ•°æ®æ ¼å¼å˜æ›´

3. **æµ‹è¯•è¦†ç›–**
   - åœ¨é‡æ„è¿‡ç¨‹ä¸­ä¿æŒåŠŸèƒ½æµ‹è¯•é€šè¿‡
   - æ·»åŠ å•å…ƒæµ‹è¯•è¦†ç›–æ–°æ¨¡å—
   - é›†æˆæµ‹è¯•éªŒè¯ç«¯åˆ°ç«¯æµç¨‹

---

## ğŸ‰ é‡æ„æ”¶ç›Š

### ä»£ç è´¨é‡

- âœ… ä»£ç è¡Œæ•°å‡å°‘çº¦ 800 è¡Œ
- âœ… å•ä¸€èŒè´£åŸåˆ™ï¼šæ¯ä¸ªæ¨¡å—ä¸“æ³¨äºä¸€ä¸ªçˆ¬è™«ä»»åŠ¡
- âœ… ä»£ç å¤ç”¨ï¼šå…±ç”¨é€»è¾‘ç»Ÿä¸€ç®¡ç†
- âœ… å¯ç»´æŠ¤æ€§ï¼šä¿®æ”¹åªéœ€åœ¨ä¸€ä¸ªåœ°æ–¹è¿›è¡Œ

### åŠŸèƒ½å®Œæ•´æ€§

- âœ… è¯„è®ºå’Œè®¨è®ºä¸€èµ·çˆ¬å–ï¼Œæ•°æ®æ›´å®Œæ•´
- âœ… API æ‹¦æˆªæ›´å…¨é¢ï¼ˆç›‘å¬å¤šç§ APIï¼‰
- âœ… é”™è¯¯å¤„ç†æ›´ç»Ÿä¸€

### å¼€å‘æ•ˆç‡

- âœ… æ–°å¹³å°æ¥å…¥æ›´ç®€å•
- âœ… Bug ä¿®å¤æ›´å¿«é€Ÿ
- âœ… åŠŸèƒ½æ‰©å±•æ›´å®¹æ˜“

---

**é‡æ„è¿›åº¦**: 70% å®Œæˆ
**é¢„è®¡å®Œæˆæ—¶é—´**: ä¸‹æ¬¡ä¼šè¯
**è´Ÿè´£äºº**: Claude Code Assistant
