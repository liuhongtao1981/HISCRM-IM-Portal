# æµè§ˆå™¨æ§åˆ¶å°ç§ä¿¡æ•°æ®æå–è„šæœ¬ï¼ˆç®€åŒ–ç‰ˆï¼‰

**ç”¨é€”**: åœ¨æŠ–éŸ³ç§ä¿¡é¡µé¢çš„æµè§ˆå™¨æ§åˆ¶å°ç›´æ¥è¿è¡Œï¼Œæå–æ¶ˆæ¯å’Œä¼šè¯çš„IDæ•°æ®

---

## ğŸ¯ æ ¸å¿ƒå‘ç°

### âœ… åˆ›ä½œè€…ä¸­å¿ƒé¡µé¢æ¯æ¡æ¶ˆæ¯éƒ½æœ‰ `secSender` åŠ å¯†IDï¼

ä»"è918"ä¼šè¯æå–åˆ°çš„6æ¡æ¶ˆæ¯ï¼š
- **100%** åŒ…å« `secSender` å­—æ®µï¼ˆBase64åŠ å¯†IDï¼Œæ ¼å¼ï¼š`MS4wLjABAAAA...`ï¼‰
- **100%** åŒ…å« `sender` å­—æ®µï¼ˆçº¯æ•°å­—IDï¼‰
- **100%** åŒ…å« `conversationId` å­—æ®µï¼ˆå¤åˆæ ¼å¼ï¼š`0:1:user1:user2`ï¼‰

---

## ğŸ“Š æ•°æ®ç¤ºä¾‹

### conversationId å¤åˆæ ¼å¼

```
0:1:2270953921061816:4031246151199119
â”‚ â”‚ â”‚                 â””â”€ ç”¨æˆ·Bæ•°å­—ID (è918)
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç”¨æˆ·Aæ•°å­—ID (å®é™è‡´è¿œ)
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ä¸šåŠ¡ç±»å‹ (1 = æ™®é€šç§ä¿¡)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç±»å‹æ ‡è¯† (0)
```

### æ¶ˆæ¯æ•°æ®ç»“æ„

```json
{
  "message_id": "7568671057889380395",
  "conversationId": "0:1:2270953921061816:4031246151199119",
  "sender": "2270953921061816",
  "secSender": "MS4wLjABAAAA96ua757Uwv0ST9oZV8PdQp4i92BEfRGMCfQGJD0B7VZ-kI9DT5IZ4gkzOBXu98xA",
  "conversationShortId": "7568670955065606698"
}
```

### ä¸¤ä¸ªç”¨æˆ·çš„IDå¯¹åº”å…³ç³»

| ç”¨æˆ· | sender (æ•°å­—ID) | secSender (åŠ å¯†ID) |
|------|----------------|-------------------|
| å®é™è‡´è¿œ | `2270953921061816` | `MS4wLjABAAAA96ua757Uwv0ST9oZV8PdQp4i92BEfRGMCfQGJD0B7VZ-kI9DT5IZ4gkzOBXu98xA` |
| è918 | `4031246151199119` | `MS4wLjABAAAAcFGiBQe30yh1CY5GCOxXoZlw_3Toii_-MNBaC4CEFvceIXWh8paOxDgAD54mc1qO` |

---

## ğŸ” ä¸æ•°æ®åº“æ•°æ®å¯¹æ¯”

### åˆ›ä½œè€…ä¸­å¿ƒ vs Workerçˆ¬å–æ•°æ®

| å¯¹æ¯”é¡¹ | åˆ›ä½œè€…ä¸­å¿ƒé¡µé¢ | Workerçˆ¬å–çš„æ•°æ®åº“ |
|--------|-------------|------------------|
| conversationIdæ ¼å¼ | å¤åˆID (`0:1:user1:user2`) | æ··åˆ (46.5%åŠ å¯† + 53.5%çº¯æ•°å­—) |
| æ˜¯å¦æœ‰åŠ å¯†ID | âœ… **100%** (åœ¨`secSender`å­—æ®µ) | âš ï¸ **46.5%** |
| senderæ ¼å¼ | çº¯æ•°å­—ID | å¯èƒ½ç¼ºå¤± |
| æ•°æ®æ¥æº | React Fiber (DOM) | React Fiber (DOM) |

---

## ğŸ’¡ å…³é”®ç»“è®º

### 1. **åˆ›ä½œè€…ä¸­å¿ƒç¡®å®æœ‰å®Œæ•´çš„åŠ å¯†ID**

è™½ç„¶ `conversationId` ä½¿ç”¨å¤åˆæ ¼å¼ï¼Œä½† `secSender` å­—æ®µä¿å­˜äº†å®Œæ•´çš„Base64åŠ å¯†IDã€‚

### 2. **Workerçˆ¬è™«å¯èƒ½é—æ¼äº† `secSender` å­—æ®µ**

æ•°æ®åº“ä¸­53.5%çš„æ¶ˆæ¯ç¼ºå°‘åŠ å¯†IDï¼Œå¯èƒ½æ˜¯å› ä¸ºï¼š
- Workerçˆ¬å–æ—¶æœªæå– `secSender` å­—æ®µ
- æˆ–è€…Workerçˆ¬å–çš„åŸå§‹ç§ä¿¡é¡µé¢ (`/falcon/webcast_openpc/pages/im/`) æ•°æ®ç»“æ„ä¸åŒ

### 3. **conversationId æ ¼å¼å·®å¼‚**

- **åˆ›ä½œè€…ä¸­å¿ƒ**: `0:1:2270953921061816:4031246151199119` (å¤åˆ)
- **æ•°æ®åº“**:
  - 46.5%: `MS4wLjABAAAA...` (åŠ å¯†)
  - 53.5%: `71206683390` (çº¯æ•°å­—)

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: ä¿®æ”¹Workerçˆ¬è™« - æå– `secSender`

ä¿®æ”¹ [crawl-direct-messages-v2.js](../packages/worker/src/platforms/douyin/crawl-direct-messages-v2.js):

```javascript
// å½“å‰æå–é€»è¾‘ï¼ˆå¯èƒ½ç¼ºå°‘ secSenderï¼‰
const messageData = {
  message_id: props.serverId,
  conversation_id: props.conversationId,
  sender_id: props.sender,
  content: props.content
};

// ğŸ‘‡ å¢å¼ºåçš„æå–é€»è¾‘
const messageData = {
  message_id: props.serverId,
  conversation_id: props.conversationId,
  sender_id: props.sender,
  sec_sender: props.secSender,  // â­ æ–°å¢ï¼šæå–åŠ å¯†ID
  conversation_short_id: props.conversationShortId,
  content: props.content,

  // è§£æå¤åˆconversationId
  parsed_conv_id: parseConversationId(props.conversationId)
};

function parseConversationId(convId) {
  if (typeof convId === 'string' && convId.includes(':')) {
    const parts = convId.split(':');
    return {
      type: parts[0],
      bizType: parts[1],
      user1_numeric: parts[2],
      user2_numeric: parts[3]
    };
  }
  return null;
}
```

### æ–¹æ¡ˆ2: å»ºç«‹IDæ˜ å°„è¡¨

åˆ©ç”¨ `secSender` å»ºç«‹æ•°å­—IDåˆ°åŠ å¯†IDçš„æ˜ å°„ï¼š

```sql
-- æ–°å»ºæ˜ å°„è¡¨
CREATE TABLE user_id_mapping (
  numeric_id TEXT PRIMARY KEY,
  encrypted_id TEXT NOT NULL,
  nickname TEXT,
  platform TEXT DEFAULT 'douyin',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- ä»æ¶ˆæ¯ä¸­æå–æ˜ å°„
INSERT OR IGNORE INTO user_id_mapping (numeric_id, encrypted_id)
SELECT
  json_extract(data, '$.rawData.sender') as numeric_id,
  json_extract(data, '$.rawData.secSender') as encrypted_id
FROM cache_messages
WHERE json_extract(data, '$.rawData.secSender') IS NOT NULL;
```

### æ–¹æ¡ˆ3: ä¿®æ”¹IMå®¢æˆ·ç«¯æŸ¥è¯¢

æ”¯æŒé€šè¿‡ `secSender` åŒ¹é…ä¼šè¯ï¼š

```javascript
// packages/crm-im-server/src/websocket-server.js
const msgs = messagesList.filter(m => {
  const rawData = m.rawData || m.data?.rawData || {};

  return m.conversationId === topicId ||
         rawData.secSender === topicId ||  // â­ æ–°å¢
         m.senderId === topicId ||
         parseConversationId(m.conversationId)?.includes(topicId);
});
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³è¡ŒåŠ¨

1. âœ… **å·²å®Œæˆ**: éªŒè¯åˆ›ä½œè€…ä¸­å¿ƒé¡µé¢æœ‰ `secSender` å­—æ®µ
2. ğŸ” **å¾…éªŒè¯**: Workerå®é™…çˆ¬å–çš„é¡µé¢ (`/falcon/webcast_openpc/pages/im/`) æ˜¯å¦ä¹Ÿæœ‰æ­¤å­—æ®µ
3. ğŸ”§ **å¾…ä¿®æ”¹**: Workerçˆ¬è™«æå–é€»è¾‘ï¼Œå¢åŠ  `secSender` å­—æ®µ
4. ğŸ”„ **å¾…é‡çˆ¬**: é‡æ–°çˆ¬å–æ•°æ®ï¼Œè¡¥å……ç¼ºå¤±çš„åŠ å¯†ID

### éªŒè¯æ­¥éª¤

ç”±äºWorkerçˆ¬å–çš„åŸå§‹ç§ä¿¡é¡µé¢è¿”å›404ï¼Œå»ºè®®ï¼š

**é€‰é¡¹A**: ä½¿ç”¨æµ‹è¯•è„šæœ¬æ‰‹åŠ¨æ‰“å¼€Workerçš„æµè§ˆå™¨
```bash
cd E:\HISCRM-IM-main\tests
node open-browser-for-manual-analysis.js
```

**é€‰é¡¹B**: ä¿®æ”¹Workerçˆ¬è™«ä»£ç ï¼Œè¾“å‡º `secSender` å­—æ®µåˆ°æ—¥å¿—
```javascript
// åœ¨ crawl-direct-messages-v2.js ä¸­æ·»åŠ 
console.log('æå–çš„æ¶ˆæ¯æ•°æ®:', {
  message_id: props.serverId,
  has_secSender: !!props.secSender,
  secSender: props.secSender?.substring(0, 20) + '...'
});
```

---

## ğŸ“ æ€»ç»“

### å›ç­”åŸå§‹é—®é¢˜

**"åŠ å¯†çš„id æ˜¯ä¸æ˜¯æ¯æ¡æ•°æ®éƒ½æœ‰"**

- âœ… **åˆ›ä½œè€…ä¸­å¿ƒé¡µé¢**: **æ˜¯çš„**ï¼Œ100%çš„æ¶ˆæ¯éƒ½æœ‰ `secSender` (åŠ å¯†ID)
- âš ï¸ **æ•°æ®åº“å­˜å‚¨**: **éƒ¨åˆ†æœ‰**ï¼Œ46.5%çš„æ¶ˆæ¯æœ‰åŠ å¯†conversation_id
- â“ **Workerçˆ¬å–é¡µé¢**: **å¾…éªŒè¯**ï¼Œéœ€è¦æ£€æŸ¥åŸå§‹ç§ä¿¡é¡µé¢çš„æ•°æ®ç»“æ„

### æ•°æ®å®Œæ•´æ€§çŠ¶æ€

| æ•°æ®ç±»å‹ | æ€»æ•° | æœ‰åŠ å¯†ID | æ¯”ä¾‹ | çŠ¶æ€ |
|---------|------|---------|------|------|
| ä¼šè¯ (conversations) | 38 | 38 | 100% | âœ… å®Œç¾ |
| æ¶ˆæ¯ (conversationId) | 43 | 20 | 46.5% | âš ï¸ éƒ¨åˆ†ç¼ºå¤± |
| æ¶ˆæ¯ (rawDataå®Œæ•´æ€§) | 43 | 43 | 100% | âœ… å®Œç¾ |
| **åˆ›ä½œè€…ä¸­å¿ƒ (secSender)** | **6** | **6** | **100%** | **âœ… å®Œç¾** |

**ç»“è®º**: åŸå§‹æ•°æ®æ˜¯å®Œæ•´çš„ï¼ˆé€šè¿‡ `secSender` å­—æ®µï¼‰ï¼Œä½†Workerçˆ¬è™«å¯èƒ½æœªæ­£ç¡®æå–æ­¤å­—æ®µï¼Œå¯¼è‡´æ•°æ®åº“ä¸­éƒ¨åˆ†æ¶ˆæ¯çš„åŠ å¯†IDç¼ºå¤±ã€‚
