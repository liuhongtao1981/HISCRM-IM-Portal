# ç§ä¿¡å›å¤è°ƒè¯•å‘ç°æ€»ç»“

## ğŸ¯ æ ¸å¿ƒå‘ç°

### é—®é¢˜é™ˆè¿°
ç”¨æˆ·æŠ¥å‘Šï¼š"å›å¤ç§ä¿¡è²Œä¼¼ä¸å¥½ä½¿" - ç§ä¿¡å›å¤åŠŸèƒ½ä¸å·¥ä½œ

### âœ… å·²éªŒè¯çš„å·¥ä½œéƒ¨åˆ†

1. **Masterç³»ç»Ÿ**
   - âœ… æ­£å¸¸è¿è¡Œåœ¨ port 3000
   - âœ… DEBUGæ¨¡å¼æ­£å¸¸å¯ç”¨
   - âœ… æ¥æ”¶å›å¤è¯·æ±‚å¹¶è½¬å‘ç»™Worker
   - âœ… æä¾›å›å¤çŠ¶æ€æŸ¥è¯¢API

2. **Workerç³»ç»Ÿ**
   - âœ… worker1 åœ¨çº¿å¹¶è¿æ¥æ­£å¸¸
   - âœ… å¿ƒè·³ä¿¡å·æ­£å¸¸ï¼ˆæ¯5ç§’æ›´æ–°ä¸€æ¬¡ï¼‰
   - âœ… è´¦æˆ·åˆ†é…æ­£ç¡® (acc-35199aa6-967b-4a99-af89-c122bf1f5c52)
   - âœ… èƒ½æ¥æ”¶å›å¤ä»»åŠ¡

3. **æ•°æ®åº“**
   - âœ… ç§ä¿¡æ­£ç¡®å­˜å‚¨ (æ‰¾åˆ°5æ¡å…¥ç«™æ¶ˆæ¯)
   - âœ… å›å¤è®°å½•åˆ›å»ºæˆåŠŸ
   - âœ… å›å¤çŠ¶æ€è¿½è¸ªåŠŸèƒ½æ­£å¸¸

4. **APIç«¯ç‚¹**
   - âœ… POST /api/v1/replies - æ¥å—å›å¤è¯·æ±‚
   - âœ… GET /api/v1/replies/:replyId - æŸ¥è¯¢å›å¤çŠ¶æ€
   - âœ… GET /api/v1/direct-messages - è·å–ç§ä¿¡åˆ—è¡¨

### â³ å‘ç°çš„é—®é¢˜

**å…³é”®å‘ç°ï¼šæ‰€æœ‰å›å¤éƒ½å¡åœ¨ "executing" çŠ¶æ€**

æµ‹è¯•ç»“æœæ˜¾ç¤ºï¼š
- æ•°æ®åº“ä¸­æœ‰9æ¡å¾…æ‰§è¡Œçš„å›å¤
- æœ€æ—©çš„å›å¤ä» 2025-10-21 10:57 å°±å¼€å§‹æ‰§è¡Œ
- æ–°å»ºçš„æµ‹è¯•å›å¤ä¹Ÿç«‹å³è¿›å…¥ "executing" çŠ¶æ€

æ—¥å¿—è¯æ®ï¼š
```
[2025-10-21 11:15:00.363] [replies-api] âœ… Forwarded reply to worker: worker1
```
MasteræˆåŠŸå°†å›å¤è½¬å‘ç»™Workerï¼Œä½†Workerç«¯æœªèƒ½å®Œæˆæ‰§è¡Œã€‚

### ğŸ” é—®é¢˜æ ¹æºåˆ†æ

é—®é¢˜å¯èƒ½å‡ºåœ¨Workerç«¯çš„Douyin Platformå®ç°ä¸­ã€‚å½“Masterå°†å›å¤ä»»åŠ¡è½¬å‘ç»™Workeråï¼š

1. Workeræ”¶åˆ°ä»»åŠ¡ âœ…
2. Workeréœ€è¦å¯åŠ¨æµè§ˆå™¨ â³
3. Workeréœ€è¦å¯¼èˆªåˆ°æŠ–éŸ³ç§ä¿¡é¡µé¢ â³
4. Workeréœ€è¦å®šä½ç§ä¿¡å¯¹è¯ â³
5. Workeréœ€è¦è¾“å…¥å›å¤å†…å®¹ â³
6. Workeréœ€è¦ç‚¹å‡»å‘é€æŒ‰é’® â³
7. Workeréœ€è¦ç­‰å¾…ç¡®è®¤å¹¶è¿”å›ç»“æœ â³

**æœ€å¯èƒ½çš„æ•…éšœç‚¹ï¼š**
- CSSé€‰æ‹©å™¨ä¸åŒ¹é…ï¼ˆæŠ–éŸ³ç½‘ç«™UIå˜åŒ–ï¼‰
- Playwrightç­‰å¾…è¶…æ—¶ï¼ˆåŠ è½½æ…¢æˆ–å…ƒç´ ä¸å‡ºç°ï¼‰
- åçˆ¬è™«æœºåˆ¶é˜»æ­¢ï¼ˆéªŒè¯ç ã€é¢‘ç‡é™åˆ¶ç­‰ï¼‰
- ç½‘ç»œè¿æ¥é—®é¢˜

## ğŸ› ï¸ è°ƒè¯•æ–¹æ¡ˆ

### 1. ç›´æ¥æŸ¥çœ‹Workerä¾§çš„é”™è¯¯
```bash
# æŸ¥çœ‹Workerçš„æ—¥å¿—
tail -f packages/worker/logs/worker.log
```

### 2. ä½¿ç”¨Anthropic MCPè°ƒè¯•æµè§ˆå™¨
```
è¿æ¥åœ°å€: http://localhost:9222 (Chrome DevTools Protocol)

è¿™å°†å…è®¸Claudeå®æ—¶çœ‹åˆ°æµè§ˆå™¨åœ¨åšä»€ä¹ˆï¼ŒåŒ…æ‹¬ï¼š
- å½“å‰é¡µé¢åŠ è½½çŠ¶æ€
- DOMå…ƒç´ å’Œé€‰æ‹©å™¨
- JavaScriptæ‰§è¡Œç»“æœ
- ç½‘ç»œé”™è¯¯
```

### 3. æ£€æŸ¥Douyin Platformå®ç°
æ£€æŸ¥æ–‡ä»¶: [packages/worker/src/platforms/douyin/platform.js](packages/worker/src/platforms/douyin/platform.js)

éœ€è¦éªŒè¯çš„å†…å®¹ï¼š
- `reply()` æ–¹æ³•æ˜¯å¦å­˜åœ¨
- CSSé€‰æ‹©å™¨æ˜¯å¦æ­£ç¡®ï¼ˆ`.dm-input`, `.send-btn` ç­‰ï¼‰
- æ˜¯å¦æ­£ç¡®å¤„ç†äº†å›å¤æ“ä½œ

### 4. è¿è¡ŒDEBUG APIæŸ¥è¯¢ç³»ç»ŸçŠ¶æ€

```bash
# è·å–å½“å‰WorkerçŠ¶æ€
curl http://127.0.0.1:3000/api/debug/workers

# è·å–è´¦æˆ·æµè§ˆå™¨çŠ¶æ€
curl http://127.0.0.1:3000/api/debug/browser-status

# è·å–æŸä¸ªç§ä¿¡çš„è¯¦æƒ…ï¼ˆéœ€è¦ä¿®å¤accountsæŸ¥è¯¢ï¼‰
curl http://127.0.0.1:3000/api/debug/accounts/acc-35199aa6-967b-4a99-af89-c122bf1f5c52
```

## ğŸ“Š ç³»ç»Ÿç»„ä»¶äº¤äº’æµç¨‹

```
ç”¨æˆ·
  â†“
POST /api/v1/replies (å›å¤è¯·æ±‚)
  â†“
Master API Server âœ…
  â†“
[reply-dao] - åˆ›å»ºå›å¤è®°å½• âœ…
  â†“
[replies-api] - è½¬å‘ç»™Worker âœ…
  â†“
Socket.IO /worker å‘½åç©ºé—´ âœ…
  â†“
Worker è¿›ç¨‹
  â†“
Douyin Platform.reply() â³ â† é—®é¢˜åœ¨è¿™é‡Œ
  â†“
Browser (Playwright) â³ â† å¯èƒ½çš„å…·ä½“é—®é¢˜
  â†“
æŠ–éŸ³ç½‘ç«™ UI äº¤äº’
  â†“
å›å¤å‘é€ â³
  â†“
Worker è¿”å›ç»“æœ
  â†“
Master æ›´æ–°å›å¤çŠ¶æ€
  â†“
ç”¨æˆ·æŸ¥è¯¢ GET /api/v1/replies/:replyId âœ…
```

## ğŸš€ å»ºè®®è¡ŒåŠ¨æ­¥éª¤

### ç«‹å³å¯é‡‡å–çš„è¡ŒåŠ¨

1. **æ£€æŸ¥Workerçš„Douyinå¹³å°å®ç°**
   ```bash
   cat packages/worker/src/platforms/douyin/platform.js | grep -A 50 "reply"
   ```

2. **æŸ¥çœ‹recent Workeræ—¥å¿—**
   ```bash
   tail -100 packages/worker/logs/worker.log
   ```

3. **å¯ç”¨æ›´è¯¦ç»†çš„DEBUGè¾“å‡º**
   åœ¨ packages/master/.env.debug ä¸­æ·»åŠ ï¼š
   ```
   DEBUG_LOG_LEVEL=debug
   DEBUG_VERBOSE=true
   ```

4. **æµ‹è¯•å•ä¸ªå…ƒç´ é€‰æ‹©å™¨**
   åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œï¼ŒæŸ¥çœ‹æŠ–éŸ³ç§ä¿¡é¡µé¢çš„å®é™…ç»“æ„ï¼š
   ```javascript
   // æŸ¥æ‰¾ç§ä¿¡è¾“å…¥æ¡†
   document.querySelectorAll('[class*="input"]')
   document.querySelectorAll('[class*="message"]')
   document.querySelectorAll('[class*="send"]')
   ```

### æ·±åº¦è¯Šæ–­

1. **è¿æ¥Anthropic MCPæŸ¥çœ‹å®æ—¶æ‰§è¡Œ**
   - å¯åŠ¨Chrome DevTools: `http://localhost:9222`
   - æŸ¥çœ‹æµè§ˆå™¨åœ¨å›å¤æ—¶çš„å…·ä½“è¡Œä¸º

2. **æ·»åŠ Screenshotè®°å½•**
   åœ¨Workerä¸­æ·»åŠ ä»£ç åœ¨å›å¤å‰åæˆªå›¾ï¼š
   ```javascript
   await page.screenshot({ path: 'before-reply.png' });
   // ... reply logic ...
   await page.screenshot({ path: 'after-reply.png' });
   ```

3. **å¢åŠ é”™è¯¯å¤„ç†æ—¥å¿—**
   ç¡®ä¿æ‰€æœ‰Playwrightæ“ä½œéƒ½æœ‰try-catchå’Œè¯¦ç»†çš„é”™è¯¯æ¶ˆæ¯

## ğŸ“ ç³»ç»Ÿä¼˜åŒ–å»ºè®®

ä¸ºäº†æ›´å®¹æ˜“åœ°è°ƒè¯•å’Œç›‘æ§å›å¤åŠŸèƒ½ï¼Œå»ºè®®ï¼š

1. **å¢å¼ºDEBUG API**
   - ä¿®å¤ GET /api/debug/workers/:workerId ä¸­çš„ worker_id æŸ¥è¯¢é—®é¢˜
   - æ·»åŠ  GET /api/debug/replies ç«¯ç‚¹æ˜¾ç¤ºæœ€è¿‘çš„å›å¤ä»»åŠ¡

2. **æ”¹è¿›é”™è¯¯æŠ¥å‘Š**
   - å½“å›å¤å¤±è´¥æ—¶ï¼Œcapture é”™è¯¯å †æ ˆå’Œæˆªå›¾
   - å­˜å‚¨æ‰§è¡Œæ—¥å¿—å’Œç½‘ç»œé”™è¯¯ä¿¡æ¯

3. **æ·»åŠ ç›‘æ§å‘Šè­¦**
   - å½“å›å¤å¡åœ¨ "executing" çŠ¶æ€è¶…è¿‡Nç§’æ—¶å‘å‡ºè­¦å‘Š
   - è‡ªåŠ¨é‡è¯•å¤±è´¥çš„å›å¤

4. **ä¼˜åŒ–è¶…æ—¶è®¾ç½®**
   - å¢åŠ Playwrightçš„ç­‰å¾…æ—¶é—´
   - æ·»åŠ å¯é…ç½®çš„è¶…æ—¶å‚æ•°

## æµ‹è¯•å‘½ä»¤å‚è€ƒ

```bash
# å¯åŠ¨Masterå’ŒWorkerï¼ˆDEBUGæ¨¡å¼ï¼‰
cd packages/master && npm start

# æŸ¥çœ‹å›å¤çŠ¶æ€ï¼ˆé€šè¿‡DEBUG APIï¼‰
curl http://127.0.0.1:3000/api/debug/browser-status

# å‘é€æµ‹è¯•å›å¤
curl -X POST http://127.0.0.1:3000/api/v1/replies \
  -H "Content-Type: application/json" \
  -d '{
    "request_id": "test-123",
    "account_id": "acc-35199aa6-967b-4a99-af89-c122bf1f5c52",
    "target_type": "direct_message",
    "target_id": "7437896255660017187",
    "reply_content": "æµ‹è¯•å›å¤"
  }'

# æ£€æŸ¥å›å¤ç»“æœï¼ˆéœ€è¦è·å–reply_idï¼‰
curl http://127.0.0.1:3000/api/v1/replies/reply-95eaf423-ab5c-44bc-85e2-da002311027a
```

## ç»“è®º

ç³»ç»Ÿæ¶æ„è®¾è®¡æ­£ç¡®ï¼ŒMaster-Workeré€šä¿¡æ­£å¸¸ã€‚é—®é¢˜å¾ˆå¯èƒ½åœ¨äºï¼š
1. Douyinå¹³å°çš„reply()æ–¹æ³•å®ç°æœ‰é—®é¢˜
2. CSSé€‰æ‹©å™¨å·²è¿‡æ—¶ï¼ˆæŠ–éŸ³UIæ›´æ–°äº†ï¼‰
3. åçˆ¬è™«ä¿æŠ¤æœºåˆ¶

ä½¿ç”¨Anthropic MCPè¿›è¡Œå®æ—¶æµè§ˆå™¨è°ƒè¯•æ˜¯æœ€å¿«çš„è¯Šæ–­æ–¹å¼ã€‚
