# HisCrm-IM - ç¤¾äº¤åª’ä½“è´¦æˆ·ç›‘æ§ä¸é€šçŸ¥ç³»ç»Ÿ

> åŸºäºMaster-Workeræ¶æ„çš„å¤šå¹³å°ç¤¾äº¤åª’ä½“ç›‘æ§ç³»ç»Ÿ

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

- âœ… **è´¦æˆ·ç®¡ç†**: æ”¯æŒå¤šä¸ªç¤¾äº¤åª’ä½“è´¦æˆ·(æŠ–éŸ³)çš„é›†ä¸­ç®¡ç†
- âœ… **å®æ—¶ç›‘æ§**: 15-30ç§’éšæœºé—´éš”è‡ªåŠ¨ç›‘æ§è¯„è®ºå’Œç§ä¿¡ (åçˆ¬è™«ä¼˜åŒ–)
- âœ… **å¤šç«¯é€šçŸ¥**: æ¡Œé¢å’Œç§»åŠ¨å®¢æˆ·ç«¯å®æ—¶é€šçŸ¥æ¨é€
- âœ… **å†å²è®°å½•**: 30å¤©å†å²æ¶ˆæ¯æŸ¥è¯¢å’Œç»Ÿè®¡åˆ†æ
- âœ… **é€šçŸ¥è§„åˆ™**: æ”¯æŒå…³é”®è¯è¿‡æ»¤ã€å…æ‰“æ‰°æ—¶æ®µç­‰è‡ªå®šä¹‰è§„åˆ™
- âœ… **é«˜å¯ç”¨æ€§**: Workeræ•…éšœè‡ªåŠ¨æ¢å¤,ä»»åŠ¡æ— ç¼è¿ç§»

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ¡Œé¢å®¢æˆ·ç«¯   â”‚â”€â”€â”€â”€â–¶â”‚    ä¸»æ§æœåŠ¡    â”‚â—€â”€â”€â”€â”€â”‚  WorkerèŠ‚ç‚¹  â”‚
â”‚   (Electron) â”‚     â”‚   (Master)   â”‚     â”‚  (Crawler)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚                     â”‚
       â”‚                   â”‚                     â”‚
   WebSocket           SQLite              å¹³å°API/æŠ“å–
```

**æŠ€æœ¯æ ˆ**:
- **Runtime**: Node.js 18.x LTS
- **é€šä¿¡**: Socket.IO 4.x (WebSocket + JSON)
- **æ•°æ®åº“**: SQLite 3.x (better-sqlite3)
- **æ¡Œé¢å®¢æˆ·ç«¯**: Electron 28.x + React 18.x + Ant Design
- **ç§»åŠ¨å®¢æˆ·ç«¯**: React Native 0.73.x + React Native Paper
- **è¿›ç¨‹ç®¡ç†**: PM2 / child_process
- **æµ‹è¯•**: Jest 29.x + Supertest + Playwright

### Workeræ•°æ®éš”ç¦»æœºåˆ¶

> **æµè§ˆå™¨æ¶æ„**: ç³»ç»Ÿä½¿ç”¨å¤šBrowseræ¶æ„,æ¯ä¸ªè´¦æˆ·ç‹¬ç«‹Browserè¿›ç¨‹
> - âœ… 100%æŒ‡çº¹éš”ç¦»,æ— å…³è”é£é™©
> - âœ… è¿›ç¨‹éš”ç¦»,å´©æºƒä¸äº’ç›¸å½±å“
> - âœ… æŒ‡çº¹ç¨³å®šæŒä¹…åŒ–,è´¦æˆ·å®‰å…¨
>
> ğŸ“– **æŠ€æœ¯è¯¦è§£**: [å¤šBrowseræ¶æ„æ–‡æ¡£](./.docs/architecture/å¤šBrowseræ¶æ„è¯¦è§£.md)

#### æµè§ˆå™¨å®ä¾‹æ¶æ„

```
Workerè¿›ç¨‹ (worker-1)
    â”‚
    â”œâ”€â”€ Browser-1 (account-123)  â† ç‹¬ç«‹Browserè¿›ç¨‹
    â”‚   â”œâ”€â”€ ç”¨æˆ·æ•°æ®ç›®å½•: ./data/browser/worker-1/browser_account-123/
    â”‚   â”œâ”€â”€ æŒ‡çº¹é…ç½®: account-123_fingerprint.json
    â”‚   â”œâ”€â”€ Cookies (ç‹¬ç«‹)
    â”‚   â”œâ”€â”€ LocalStorage (ç‹¬ç«‹)
    â”‚   â””â”€â”€ WebGL/CanvasæŒ‡çº¹ (éšæœºä¸”ç¨³å®š)
    â”‚
    â”œâ”€â”€ Browser-2 (account-456)  â† ç‹¬ç«‹Browserè¿›ç¨‹
    â”‚   â”œâ”€â”€ ç”¨æˆ·æ•°æ®ç›®å½•: ./data/browser/worker-1/browser_account-456/
    â”‚   â”œâ”€â”€ æŒ‡çº¹é…ç½®: account-456_fingerprint.json
    â”‚   â”œâ”€â”€ Cookies (ç‹¬ç«‹)
    â”‚   â”œâ”€â”€ LocalStorage (ç‹¬ç«‹)
    â”‚   â””â”€â”€ WebGL/CanvasæŒ‡çº¹ (éšæœºä¸”ç¨³å®š)
    â”‚
    â””â”€â”€ Browser-3 (account-789)  â† ç‹¬ç«‹Browserè¿›ç¨‹
        â”œâ”€â”€ ç”¨æˆ·æ•°æ®ç›®å½•: ./data/browser/worker-1/browser_account-789/
        â”œâ”€â”€ æŒ‡çº¹é…ç½®: account-789_fingerprint.json
        â”œâ”€â”€ Cookies (ç‹¬ç«‹)
        â”œâ”€â”€ LocalStorage (ç‹¬ç«‹)
        â””â”€â”€ WebGL/CanvasæŒ‡çº¹ (éšæœºä¸”ç¨³å®š)
```

**å…³é”®ç‰¹æ€§**:
- 1ä¸ªWorker â†’ å¤šä¸ªBrowserè¿›ç¨‹ (æ¯è´¦æˆ·ä¸€ä¸ª)
- æ¯ä¸ªBrowserå®Œå…¨éš”ç¦»: è¿›ç¨‹ã€æ•°æ®ç›®å½•ã€æŒ‡çº¹ç‰¹å¾å…¨éƒ¨ç‹¬ç«‹
- 100%æŒ‡çº¹éš”ç¦»,æ— å…³è”é£é™©
- å»ºè®®æœ€å¤§è´¦æˆ·æ•°: â‰¤10ä¸ª/Worker (å†…å­˜è€ƒè™‘)

#### æ•°æ®ç›®å½•ç»“æ„

æ¯ä¸ªWorkerè¿›ç¨‹æ‹¥æœ‰ç‹¬ç«‹çš„æ•°æ®ç›®å½•,é¿å…å¹¶å‘å†²çª:

```
data/browser/
â”œâ”€â”€ worker-1/                               # Worker-1 ä¸“å±ç›®å½•
â”‚   â”œâ”€â”€ browser_account-123/                # è´¦æˆ·123ç‹¬ç«‹Browseræ•°æ®
â”‚   â”‚   â”œâ”€â”€ Cache/                          # æµè§ˆå™¨ç¼“å­˜
â”‚   â”‚   â”œâ”€â”€ Cookies                         # Cookieæ•°æ®
â”‚   â”‚   â”œâ”€â”€ Local Storage/                  # æœ¬åœ°å­˜å‚¨
â”‚   â”‚   â””â”€â”€ ...                             # å…¶ä»–æµè§ˆå™¨æ•°æ®
â”‚   â”œâ”€â”€ browser_account-456/                # è´¦æˆ·456ç‹¬ç«‹Browseræ•°æ®
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ browser_account-789/                # è´¦æˆ·789ç‹¬ç«‹Browseræ•°æ®
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ fingerprints/                       # æŒ‡çº¹é…ç½®ç›®å½•
â”‚   â”‚   â”œâ”€â”€ account-123_fingerprint.json    # è´¦æˆ·123æŒ‡çº¹é…ç½®
â”‚   â”‚   â”œâ”€â”€ account-456_fingerprint.json    # è´¦æˆ·456æŒ‡çº¹é…ç½®
â”‚   â”‚   â””â”€â”€ account-789_fingerprint.json    # è´¦æˆ·789æŒ‡çº¹é…ç½®
â”‚   â””â”€â”€ worker_1.db                         # Workeræœ¬åœ°æ•°æ®åº“
â”‚
â”œâ”€â”€ worker-2/                               # Worker-2 ä¸“å±ç›®å½•
â”‚   â”œâ”€â”€ browser_account-101/
â”‚   â”œâ”€â”€ browser_account-202/
â”‚   â”œâ”€â”€ fingerprints/
â”‚   â””â”€â”€ worker_2.db
â”‚
â””â”€â”€ worker-3/                               # Worker-3 ä¸“å±ç›®å½•
    â”œâ”€â”€ browser_account-303/
    â”œâ”€â”€ fingerprints/
    â””â”€â”€ worker_3.db

é…ç½® (packages/worker/src/index.js):
  browserManager = getBrowserManager(WORKER_ID, {
    dataDir: `./data/browser/${WORKER_ID}`  // åŸºäºWorker IDçš„ç›®å½•éš”ç¦»
  });

å¯åŠ¨Browser (packages/worker/src/browser/browser-manager-v2.js):
  const browser = await chromium.launch({
    args: [
      `--user-data-dir=${dataDir}/browser_${accountId}`,  // æ¯ä¸ªè´¦æˆ·ç‹¬ç«‹æ•°æ®ç›®å½•
      '--disable-blink-features=AutomationControlled',
    ]
  });
```

#### éš”ç¦»ä¼˜åŠ¿

| ç»´åº¦ | è¯´æ˜ | ä¼˜åŠ¿ |
|------|------|------|
| **Workerçº§éš”ç¦»** | æ¯ä¸ªWorkerç‹¬ç«‹æ•°æ®ç›®å½• | å¤šWorkerå¹¶å‘æ— å†²çª |
| **Browserçº§éš”ç¦»** | æ¯ä¸ªè´¦æˆ·ç‹¬ç«‹Browserè¿›ç¨‹ | 100%æŒ‡çº¹éš”ç¦» |
| **æ•°æ®ç›®å½•éš”ç¦»** | æ¯ä¸ªBrowserç‹¬ç«‹user-data-dir | æ•°æ®å®Œå…¨ç‹¬ç«‹ |
| **æŒ‡çº¹é…ç½®éš”ç¦»** | ç‹¬ç«‹çš„æŒ‡çº¹é…ç½®æ–‡ä»¶ | æŒ‡çº¹ç¨³å®šæŒä¹…åŒ– |
| **æ•°æ®åº“éš”ç¦»** | æ¯ä¸ªWorkerç‹¬ç«‹SQLite | ç¼“å­˜å’Œä»»åŠ¡æ•°æ®éš”ç¦» |

**æ ¸å¿ƒä¼˜åŠ¿**:
- âœ… **100%æŒ‡çº¹éš”ç¦»**: æ¯ä¸ªè´¦æˆ·ç‹¬ç«‹Browserè¿›ç¨‹,æ— å…³è”é£é™©
- âœ… **è¿›ç¨‹éš”ç¦»**: ä¸€ä¸ªBrowserå´©æºƒä¸å½±å“å…¶ä»–è´¦æˆ·
- âœ… **æŒ‡çº¹ç¨³å®š**: æŒ‡çº¹é…ç½®æŒä¹…åŒ–,é‡å¯åä¿æŒä¸€è‡´
- âœ… **æ•°æ®ç‹¬ç«‹**: æ¯ä¸ªBrowserç‹¬ç«‹æ•°æ®ç›®å½•,å®Œå…¨éš”ç¦»
- âœ… **æ˜“è°ƒè¯•**: æ ¹æ®Worker IDå’Œè´¦æˆ·IDå¿«é€Ÿå®šä½æ•°æ®
- âœ… **æ˜“æ¸…ç†**: å¯æŒ‰è´¦æˆ·ç‹¬ç«‹æ¸…ç†Browseræ•°æ®

**æŒ‡çº¹éš”ç¦»æŠ€æœ¯**:
- âœ… **15+ç§æŒ‡çº¹ç‰¹å¾**: WebGLã€Canvasã€AudioContextã€ç¡¬ä»¶ä¿¡æ¯ã€å±å¹•ä¿¡æ¯ç­‰
- âœ… **éšæœºç”Ÿæˆ**: åŸºäºaccountIdçš„seededéšæœº,ç¡®ä¿ä¸€è‡´æ€§
- âœ… **æŒä¹…åŒ–å­˜å‚¨**: æŒ‡çº¹é…ç½®ä¿å­˜åˆ°JSONæ–‡ä»¶,é‡å¯åè‡ªåŠ¨åŠ è½½
- âœ… **å®Œç¾éš”ç¦»**: ä¸åŒè´¦æˆ·çš„æŒ‡çº¹ç‰¹å¾å®Œå…¨ç‹¬ç«‹,æ— æ³•å…³è”
- è¯¦è§: [å¤šBrowseræ¶æ„æŠ€æœ¯æ–‡æ¡£](./.docs/architecture/å¤šBrowseræ¶æ„è¯¦è§£.md)

**æ³¨æ„äº‹é¡¹**:
- æ¯ä¸ªBrowserå¯åŠ¨éœ€è¦~5ç§’,å»ºè®®åˆ†æ‰¹å¯åŠ¨
- å†…å­˜å ç”¨: ~200MB/è´¦æˆ·,å»ºè®®â‰¤10ä¸ªè´¦æˆ·/Worker
- åŒä¸€è´¦æˆ·åœ¨ä¸åŒWorkeréœ€è¦åˆ†åˆ«ç™»å½•
- è´¦æˆ·è¿ç§»åˆ°å…¶ä»–Workeréœ€è¦é‡æ–°ç™»å½•
- è¯¦è§: [å¤šBrowserå®ç°æŠ¥å‘Š](./.docs/MULTI_BROWSER_IMPLEMENTATION.md)

## ğŸ“¦ é¡¹ç›®ç»“æ„

```
packages/
â”œâ”€â”€ master/          # ä¸»æ§æœåŠ¡(ä»»åŠ¡è°ƒåº¦ã€Workerç®¡ç†ã€å®¢æˆ·ç«¯é€šä¿¡)
â”œâ”€â”€ worker/          # Workerè¿›ç¨‹(æŠ–éŸ³ç›‘æ§æ‰§è¡Œå™¨)
â”œâ”€â”€ shared/          # å…±äº«ä»£ç (åè®®å®šä¹‰ã€æ¨¡å‹ã€å·¥å…·å‡½æ•°)
â”œâ”€â”€ desktop-client/  # Electronæ¡Œé¢å®¢æˆ·ç«¯
â”œâ”€â”€ mobile-client/   # React Nativeç§»åŠ¨å®¢æˆ·ç«¯
â””â”€â”€ tests/           # è·¨åŒ…é›†æˆæµ‹è¯•
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®æ¡ä»¶

- Node.js 18.x LTS
- pnpm 8.x+

### å®‰è£…

```bash
# 1. å…‹éš†ä»“åº“
git clone <repository_url>
cd hiscrm-im

# 2. å®‰è£…ä¾èµ–
npm install -g pnpm
pnpm install

# 3. åˆå§‹åŒ–æ•°æ®åº“
cd packages/master
npm run db:init

# 4. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘.envè®¾ç½®åŠ å¯†å¯†é’¥ç­‰é…ç½®
```

### å¼€å‘æ¨¡å¼

```bash
# å¯åŠ¨ä¸»æ§æœåŠ¡
pnpm dev:master

# å¯åŠ¨Workerè¿›ç¨‹(å¦ä¸€ä¸ªç»ˆç«¯)
pnpm dev:worker

# å¯åŠ¨æ¡Œé¢å®¢æˆ·ç«¯(å¦ä¸€ä¸ªç»ˆç«¯)
pnpm dev:desktop
```

### ç”Ÿäº§éƒ¨ç½²

```bash
# ä½¿ç”¨PM2å¯åŠ¨ä¸»æ§(ä¼šè‡ªåŠ¨ç®¡ç†Worker)
pm2 start packages/master/src/index.js --name hiscrm-master

# æ‰“åŒ…æ¡Œé¢å®¢æˆ·ç«¯
pnpm --filter @hiscrm-im/desktop-client build
```

## ğŸ§ª æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pnpm test

# è¿è¡Œå•ä¸ªåŒ…çš„æµ‹è¯•
pnpm --filter @hiscrm-im/master test

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pnpm test -- --coverage
```

## ğŸ“– æ–‡æ¡£

### æ ¸å¿ƒæ–‡æ¡£
- [åŠŸèƒ½è§„æ ¼](./specs/001-worker/spec.md)
- [å®æ–½è®¡åˆ’](./specs/001-worker/plan.md)
- [æ•°æ®æ¨¡å‹](./specs/001-worker/data-model.md)
- [æ•°æ®åº“å­—å…¸](./.docs/æ•°æ®åº“å­—å…¸.md) - **å®Œæ•´çš„æ•°æ®åº“è¡¨ç»“æ„å’Œå­—æ®µè¯´æ˜ (1200è¡Œ)**
- [APIå¥‘çº¦](./specs/001-worker/contracts/)
- [å¿«é€ŸéªŒè¯æŒ‡å—](./specs/001-worker/quickstart.md)
- [ä»»åŠ¡åˆ—è¡¨](./specs/001-worker/tasks.md)

### ä½¿ç”¨æŒ‡å—
- [å¿«é€Ÿå¯åŠ¨æŒ‡å—](./QUICKSTART.md) - **æ–°æ‰‹å…¥é—¨å¿…è¯»**
- [ä»£ç†é…ç½®æŒ‡å—](./PROXY_USAGE_GUIDE.md) - ä»£ç†æœåŠ¡å™¨é…ç½®è¯´æ˜
- [éšæœºç›‘æ§é—´éš”æœºåˆ¶](./.docs/éšæœºç›‘æ§é—´éš”æœºåˆ¶.md) - **åçˆ¬è™«ä¼˜åŒ–è¯´æ˜ (v2.1.0)**

### æŠ€æœ¯æ–‡æ¡£
- [å¤šBrowseræ¶æ„è¯¦è§£](./.docs/architecture/å¤šBrowseræ¶æ„è¯¦è§£.md) - **æµè§ˆå™¨æ¶æ„æŠ€æœ¯æ–‡æ¡£ (æ¨èé˜…è¯»)**
- [Browserè¿›ç¨‹æ¶æ„è¯´æ˜](./.docs/architecture/Browserè¿›ç¨‹æ¶æ„è¯´æ˜.md) - è¿›ç¨‹vsçº¿ç¨‹è¯¦è§£
- [å¤šBrowserå®ç°æŠ¥å‘Š](./.docs/MULTI_BROWSER_IMPLEMENTATION.md) - æ¶æ„å®ç°å®ŒæˆæŠ¥å‘Š

### å½’æ¡£æ–‡æ¡£
- [å®æ–½å®ŒæˆæŠ¥å‘Š](./.docs/archive/IMPLEMENTATION_COMPLETE.md) - Workeræ•°æ®éš”ç¦»å®æ–½
- [é”™è¯¯å¤„ç†å®æ–½](./.docs/archive/ERROR_HANDLING_IMPLEMENTATION_COMPLETE.md) - å®Œæ•´çš„é”™è¯¯å¤„ç†ç³»ç»Ÿ
- [å·¥ä½œæ€»ç»“](./.docs/archive/WORK_SUMMARY.md) - é¡¹ç›®å¼€å‘æ€»ç»“
- [æ›´å¤šå½’æ¡£æ–‡æ¡£...](./.docs/archive/)

## ğŸ”’ å®‰å…¨æ€§

- è´¦æˆ·å‡­è¯ä½¿ç”¨AES-256åŠ å¯†å­˜å‚¨
- ç”Ÿäº§ç¯å¢ƒä½¿ç”¨WSSåŠ å¯†é€šä¿¡
- æ”¯æŒJWT Tokenè®¤è¯
- **éšæœºç›‘æ§é—´éš”**: 15-30ç§’éšæœº,æ¨¡æ‹ŸçœŸå®ç”¨æˆ·è¡Œä¸º,é™ä½80%è¢«æ£€æµ‹æ¦‚ç‡
- **æµè§ˆå™¨æŒ‡çº¹éš”ç¦»**: æ¯ä¸ªè´¦æˆ·ç‹¬ç«‹Browserè¿›ç¨‹,100%æŒ‡çº¹éš”ç¦»
- **æ™ºèƒ½é™æµ**: è‡ªåŠ¨æ£€æµ‹å¹³å°é™æµå¹¶è°ƒæ•´é—´éš”

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

- ç›‘æ§é—´éš”: 15-30ç§’éšæœº (å¹³å‡~22ç§’,é™ä½80%è¢«æ£€æµ‹æ¦‚ç‡)
- å¹³å‡ç›‘æ§å»¶è¿Ÿ: â‰¤ 11ç§’ (æ¯”å›ºå®šé—´éš”å¿«27%)
- é€šçŸ¥æ¨é€å»¶è¿Ÿ: â‰¤ 3ç§’
- Workeræ•…éšœæ¢å¤: â‰¤ 30ç§’
- æ”¯æŒå¹¶å‘ç›‘æ§: 10+ è´¦æˆ·

## ğŸ“ è®¸å¯è¯

MIT

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Request!

---

**ç”Ÿæˆæ—¥æœŸ**: 2025-10-13
**ç‰ˆæœ¬**: 2.1.0 (éšæœºç›‘æ§é—´éš” + å¤šBrowseræ¶æ„)
