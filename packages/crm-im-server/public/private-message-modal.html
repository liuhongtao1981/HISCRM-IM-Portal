<!-- 私信对话弹窗 - 插入到admin.html中评论弹窗之后 -->
<div id="privateMessageModal" class="modal">
  <div class="modal-content" style="max-width: 800px; max-height: 90vh; padding: 0; overflow: hidden; display: flex; flex-direction: column;">
    <!-- 顶部 - 显示当前用户信息 -->
    <div style="background: linear-gradient(135deg, #52c41a 0%, #389e0d 100%); padding: 20px; color: white;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div style="flex: 1;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div id="privateUserAvatar" style="width: 48px; height: 48px; border-radius: 50%; background: rgba(255,255,255,0.3);
                        color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px;
                        border: 2px solid rgba(255,255,255,0.5);"></div>
            <div>
              <h2 style="color: white; margin: 0; font-size: 20px;">💬 私信对话: <span id="privateUserNameDisplay"></span></h2>
              <p style="margin: 4px 0 0 0; font-size: 13px; opacity: 0.9;">一对一私信交流</p>
            </div>
          </div>
        </div>
        <button onclick="closePrivateMessage()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 24px; transition: all 0.3s; flex-shrink: 0; margin-left: 20px;">&times;</button>
      </div>
    </div>

    <!-- 消息列表区域 -->
    <div id="privateMessageList" style="flex: 1; overflow-y: auto; padding: 20px 20px 180px 20px; background: #f5f5f5; min-height: 400px;">
      <p style="text-align: center; color: #999; padding: 40px 20px;">加载中...</p>
    </div>

    <!-- 发送消息输入框 - 固定在底部 -->
    <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 16px; background: linear-gradient(180deg, #fafafa 0%, #f5f5f5 100%); border-top: 2px solid #e0e0e0; box-shadow: 0 -4px 12px rgba(0,0,0,0.08); z-index: 10;">
      <div style="margin-bottom: 10px; padding: 8px 12px; background: white; border-radius: 6px; border-left: 3px solid #52c41a;">
        <div style="font-size: 13px; font-weight: 600; color: #333; margin-bottom: 2px;">
          💬 发送私信
        </div>
        <div style="font-size: 11px; color: #999;">
          发送给: <span id="privateUserName" style="color: #52c41a; font-weight: 500;"></span>
        </div>
      </div>
      <textarea id="privateMessageInput" rows="3" style="width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 13px; font-family: inherit; resize: none; box-sizing: border-box;" placeholder="输入私信内容... (Ctrl+Enter 发送)"></textarea>
      <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
        <span style="font-size: 11px; color: #999;">💡 一对一私信对话</span>
        <button class="btn btn-primary btn-small" onclick="submitPrivateMessage()">
          📤 发送私信
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// ============ 私信对话弹窗相关函数 ============
let currentPrivateUser = null; // 当前私信用户
let allPrivateMessages = []; // 存储所有私信消息

// 打开私信对话弹窗
async function openPrivateMessage(user) {
  currentPrivateUser = user;

  // 设置当前用户信息
  document.getElementById('privateUserNameDisplay').textContent = user.name;
  document.getElementById('privateUserAvatar').textContent = user.name.substring(0, 1);
  document.getElementById('privateUserName').textContent = user.name;

  // 清空输入框
  document.getElementById('privateMessageInput').value = '';

  // 显示弹窗
  document.getElementById('privateMessageModal').style.display = 'flex';

  // 加载历史私信消息
  await loadPrivateMessages(user.id);
}

// 加载私信历史消息
async function loadPrivateMessages(userId) {
  const listContainer = document.getElementById('privateMessageList');
  listContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 20px;">加载中...</p>';

  try {
    // 私信使用特殊的channelId和topicId
    const channelId = 'private_messages';
    const topicId = `private_${userId}`;

    console.log('[私信历史] 正在加载:', { channelId, topicId, userId });
    const url = `/api/messages?channelId=${channelId}&topicId=${topicId}`;
    console.log('[私信历史] 请求URL:', url);

    const response = await fetch(url);
    console.log('[私信历史] 响应状态:', response.status);

    if (!response.ok) {
      throw new Error(`HTTP错误! 状态: ${response.status}`);
    }

    const data = await response.json();
    console.log('[私信历史] 收到数据:', data);

    const messages = data.messages || [];
    console.log('[私信历史] 消息数量:', messages.length);

    // 存储所有消息
    allPrivateMessages = messages.map((msg, index) => ({
      id: msg.id || `msg_${index}_${msg.timestamp}`,
      content: msg.content,
      fromName: msg.fromName || '匿名用户',
      fromId: msg.fromId || 'unknown',
      timestamp: msg.timestamp,
      type: msg.type || 'text'
    }));

    // 按时间升序排列
    allPrivateMessages.sort((a, b) => a.timestamp - b.timestamp);

    if (allPrivateMessages.length === 0) {
      listContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 20px;">暂无私信记录</p>';
      return;
    }

    // 渲染私信消息列表(微信样式对话框)
    const messagesHtml = allPrivateMessages.map(msg => {
      const time = formatCommentTime(msg.timestamp);
      const isFromUser = msg.fromId === userId; // 是否来自用户
      const isFromMonitor = msg.fromId === 'monitor_client'; // 是否来自客服

      // 确定消息方向
      if (isFromUser) {
        // 用户消息 - 显示在左侧(白色气泡)
        return `
          <div style="display: flex; justify-content: flex-start; margin-bottom: 16px; gap: 10px;">
            <div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; flex-shrink: 0;">
              ${msg.fromName.substring(0, 1)}
            </div>
            <div style="max-width: 70%;">
              <div style="font-size: 12px; color: #999; margin-bottom: 4px;">${msg.fromName} ${time}</div>
              <div style="background: white; padding: 10px 14px; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); word-wrap: break-word; line-height: 1.5; font-size: 14px; color: #191919;">
                ${msg.content}
              </div>
            </div>
          </div>
        `;
      } else if (isFromMonitor) {
        // 客服消息 - 显示在右侧(绿色气泡)
        return `
          <div style="display: flex; justify-content: flex-end; margin-bottom: 16px; gap: 10px;">
            <div style="max-width: 70%; text-align: right;">
              <div style="font-size: 12px; color: #999; margin-bottom: 4px;">${time} 客服</div>
              <div style="background: #95ec69; padding: 10px 14px; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); word-wrap: break-word; line-height: 1.5; font-size: 14px; color: #191919; text-align: left;">
                ${msg.content}
              </div>
            </div>
            <div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #52c41a 0%, #389e0d 100%);
                        color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; flex-shrink: 0;">
              客
            </div>
          </div>
        `;
      } else {
        // 其他用户消息
        return `
          <div style="display: flex; justify-content: flex-start; margin-bottom: 16px; gap: 10px;">
            <div style="width: 36px; height: 36px; border-radius: 50%; background: #faad14;
                        color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; flex-shrink: 0;">
              ${msg.fromName.substring(0, 1)}
            </div>
            <div style="max-width: 70%;">
              <div style="font-size: 12px; color: #999; margin-bottom: 4px;">${msg.fromName} ${time}</div>
              <div style="background: white; padding: 10px 14px; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); word-wrap: break-word; line-height: 1.5; font-size: 14px; color: #191919;">
                ${msg.content}
              </div>
            </div>
          </div>
        `;
      }
    }).join('');

    listContainer.innerHTML = messagesHtml;
    console.log('[私信历史] 渲染完成');

    // 滚动到底部
    listContainer.scrollTop = listContainer.scrollHeight;

  } catch (error) {
    console.error('[私信历史] 加载失败:', error);
    listContainer.innerHTML = `<p style="text-align: center; color: #ff4d4f; padding: 40px 20px;">加载失败: ${error.message}<br/>请打开浏览器控制台查看详细错误</p>`;
  }
}

// 关闭私信对话弹窗
function closePrivateMessage() {
  document.getElementById('privateMessageModal').style.display = 'none';
  currentPrivateUser = null;
  allPrivateMessages = [];
}

// 提交私信消息
async function submitPrivateMessage() {
  const content = document.getElementById('privateMessageInput').value.trim();

  if (!content) {
    showToast('请输入私信内容', 'warning');
    return;
  }

  if (!currentPrivateUser) {
    showToast('用户信息不完整', 'error');
    return;
  }

  try {
    // 私信使用特殊的channelId和topicId
    const channelId = 'private_messages';
    const topicId = `private_${currentPrivateUser.id}`;

    // 构建消息数据
    const messageData = {
      channelId: channelId,
      topicId: topicId,
      content: content,
      fromUserId: currentPrivateUser.id,
      fromUserName: currentPrivateUser.name,
      messageType: 'private' // 标记为私信类型
    };

    // 发送消息
    const messageRes = await fetch('/api/send-test-message', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(messageData)
    });

    const result = await messageRes.json();

    if (result.success) {
      showToast(`✓ 私信发送成功`, 'success');

      // 清空输入框
      document.getElementById('privateMessageInput').value = '';

      // 重新加载私信历史
      await loadPrivateMessages(currentPrivateUser.id);

      // 在日志中记录
      addMessageLog(channelId, topicId, content, currentPrivateUser.name + ' (私信)', false);

    } else {
      showToast('发送失败: ' + (result.error || '未知错误'), 'error');
    }

  } catch (error) {
    console.error('提交私信失败:', error);
    showToast('提交私信失败: ' + error.message, 'error');
  }
}

// 添加事件监听器(在DOMContentLoaded中添加)
document.addEventListener('DOMContentLoaded', () => {
  // 私信输入框 Ctrl+Enter 快捷键
  const privateInput = document.getElementById('privateMessageInput');
  if (privateInput) {
    privateInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.ctrlKey) {
        e.preventDefault();
        submitPrivateMessage();
      }
    });
  }

  // 点击私信弹窗外部关闭
  const privateModal = document.getElementById('privateMessageModal');
  if (privateModal) {
    privateModal.addEventListener('click', (e) => {
      if (e.target.id === 'privateMessageModal') {
        closePrivateMessage();
      }
    });
  }
});
</script>
