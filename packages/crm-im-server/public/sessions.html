<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM IM - ä¼šè¯ç®¡ç†</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header h1 {
      color: #333;
      margin-bottom: 8px;
    }

    .header p {
      color: #666;
      font-size: 14px;
    }

    .main-content {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 20px;
      height: calc(100vh - 180px);
    }

    .sessions-panel, .conversation-panel {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }

    .panel-header {
      padding: 16px 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-header h2 {
      font-size: 18px;
      color: #333;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #1890ff;
      color: white;
    }

    .btn-primary:hover {
      background: #40a9ff;
    }

    .btn-success {
      background: #52c41a;
      color: white;
    }

    .btn-success:hover {
      background: #73d13d;
    }

    .sessions-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .session-item {
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      border-left: 3px solid #1890ff;
      background: #f9f9f9;
      cursor: pointer;
      transition: all 0.2s;
    }

    .session-item:hover {
      background: #f0f0f0;
      transform: translateX(2px);
    }

    .session-item.active {
      background: #e6f7ff;
      border-left-color: #1890ff;
    }

    .session-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .session-user {
      font-weight: bold;
      color: #333;
    }

    .session-time {
      font-size: 12px;
      color: #999;
    }

    .session-preview {
      font-size: 13px;
      color: #666;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      margin-left: 8px;
    }

    .badge-active {
      background: #d4f4dd;
      color: #237804;
    }

    .badge-closed {
      background: #ffd8bf;
      color: #ad4e00;
    }

    .conversation-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #fafafa;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #999;
    }

    .message-item {
      margin-bottom: 16px;
      display: flex;
      flex-direction: column;
    }

    .message-item.session-msg {
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid #faad14;
    }

    .message-item.reply-msg {
      background: #e6f7ff;
      padding: 12px 16px 12px 32px;
      border-radius: 6px;
      margin-left: 20px;
      border-left: 3px solid #1890ff;
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .message-author {
      font-weight: bold;
      color: #333;
    }

    .message-time {
      font-size: 12px;
      color: #999;
    }

    .message-content {
      color: #333;
      line-height: 1.6;
    }

    .reply-form {
      padding: 16px 20px;
      border-top: 1px solid #eee;
      background: white;
    }

    .reply-form textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      resize: none;
      font-family: inherit;
      font-size: 14px;
      margin-bottom: 12px;
    }

    .reply-form textarea:focus {
      outline: none;
      border-color: #1890ff;
    }

    .reply-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .reply-tip {
      font-size: 12px;
      color: #999;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
    }

    .modal-header {
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid #eee;
    }

    .modal-header h3 {
      font-size: 18px;
      color: #333;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      color: #333;
      font-size: 14px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      font-size: 14px;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
      font-family: inherit;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 20px;
    }

    .btn-secondary {
      background: #8c8c8c;
      color: white;
    }

    .btn-secondary:hover {
      background: #a0a0a0;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #999;
    }
  </style>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ’¬ ä¼šè¯ç®¡ç†ç³»ç»Ÿ</h1>
      <p>ç®¡ç†å®¢æˆ·ä¼šè¯å’Œå›å¤ - æ ‘çŠ¶ç»“æ„</p>
    </div>

    <div class="main-content">
      <!-- å·¦ä¾§: ä¼šè¯åˆ—è¡¨ -->
      <div class="sessions-panel">
        <div class="panel-header">
          <h2>ä¼šè¯åˆ—è¡¨</h2>
          <button class="btn btn-success" onclick="showCreateSessionModal()">
            â• æ–°å»ºä¼šè¯
          </button>
        </div>
        <div class="sessions-list" id="sessionsList">
          <div class="empty-state">
            <p>æš‚æ— ä¼šè¯</p>
          </div>
        </div>
      </div>

      <!-- å³ä¾§: ä¼šè¯è¯¦æƒ…å’Œå›å¤ -->
      <div class="conversation-panel">
        <div class="panel-header">
          <h2 id="conversationTitle">é€‰æ‹©ä¸€ä¸ªä¼šè¯</h2>
        </div>
        <div class="conversation-content" id="conversationContent">
          <div class="empty-state">
            <p style="font-size: 48px;">ğŸ’¬</p>
            <p>è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªä¼šè¯</p>
          </div>
        </div>
        <div class="reply-form" id="replyForm" style="display: none;">
          <textarea
            id="replyContent"
            rows="3"
            placeholder="è¾“å…¥å›å¤å†…å®¹... (Ctrl+Enter å‘é€)"
          ></textarea>
          <div class="reply-actions">
            <span class="reply-tip">Ctrl+Enter å¿«é€Ÿå‘é€</span>
            <button class="btn btn-primary" onclick="sendReply()">å‘é€å›å¤</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- åˆ›å»ºä¼šè¯æ¨¡æ€æ¡† -->
  <div class="modal" id="createSessionModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>æ–°å»ºä¼šè¯</h3>
      </div>
      <form onsubmit="createSession(event)">
        <div class="form-group">
          <label>ç”¨æˆ·ID *</label>
          <input type="text" id="userId" required placeholder="ä¾‹: 10001">
        </div>
        <div class="form-group">
          <label>ç”¨æˆ·åç§° *</label>
          <input type="text" id="userName" required placeholder="ä¾‹: å¼ ä¸‰">
        </div>
        <div class="form-group">
          <label>ç›®æ ‡é¢‘é“ *</label>
          <select id="sessionChannel" required></select>
        </div>
        <div class="form-group">
          <label>ç›®æ ‡ä¸»é¢˜ *</label>
          <select id="sessionTopic" required>
            <option value="">è¯·å…ˆé€‰æ‹©é¢‘é“</option>
          </select>
        </div>
        <div class="form-group">
          <label>é¦–æ¡æ¶ˆæ¯ *</label>
          <textarea id="firstMessage" required placeholder="å®¢æˆ·å‘èµ·çš„é¦–æ¡æ¶ˆæ¯..."></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeCreateSessionModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">åˆ›å»ºä¼šè¯</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let socket = null;
    let currentSessionId = null;
    let sessions = [];
    let replies = {};

    // åˆå§‹åŒ–Socket.IO
    function initSocket() {
      socket = io();

      socket.on('connect', () => {
        console.log('[ä¼šè¯ç®¡ç†] Socket.IO å·²è¿æ¥');
        socket.emit('admin:register');
      });

      socket.on('session:new', (session) => {
        console.log('[ä¼šè¯ç®¡ç†] æ–°ä¼šè¯:', session);
        loadSessions();
      });

      socket.on('session:reply', (reply) => {
        console.log('[ä¼šè¯ç®¡ç†] æ–°å›å¤:', reply);
        if (currentSessionId === reply.sessionId) {
          loadConversation(currentSessionId);
        }
        loadSessions(); // æ›´æ–°ä¼šè¯åˆ—è¡¨(æ›´æ–°lastReplyTime)
      });
    }

    // åŠ è½½ä¼šè¯åˆ—è¡¨
    async function loadSessions() {
      try {
        const response = await fetch('/api/sessions');
        const data = await response.json();
        sessions = data.sessions || [];

        const listEl = document.getElementById('sessionsList');

        if (sessions.length === 0) {
          listEl.innerHTML = '<div class="empty-state"><p>æš‚æ— ä¼šè¯</p></div>';
          return;
        }

        // æŒ‰æœ€åå›å¤æ—¶é—´æ’åº
        sessions.sort((a, b) => (b.lastReplyTime || b.createdTime) - (a.lastReplyTime || a.createdTime));

        listEl.innerHTML = sessions.map(session => `
          <div class="session-item ${currentSessionId === session.id ? 'active' : ''}"
               onclick="selectSession('${session.id}')">
            <div class="session-header">
              <div>
                <span class="session-user">${session.userName} (ID: ${session.userId})</span>
                <span class="session-badge badge-${session.status || 'active'}">
                  ${session.status === 'closed' ? 'å·²å…³é—­' : 'è¿›è¡Œä¸­'}
                </span>
              </div>
              <span class="session-time">${formatTime(session.lastReplyTime || session.createdTime)}</span>
            </div>
            <div class="session-preview">
              ${session.firstMessage}
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('[ä¼šè¯ç®¡ç†] åŠ è½½ä¼šè¯å¤±è´¥:', error);
      }
    }

    // é€‰æ‹©ä¼šè¯
    async function selectSession(sessionId) {
      currentSessionId = sessionId;
      await loadConversation(sessionId);
      loadSessions(); // æ›´æ–°åˆ—è¡¨é«˜äº®
    }

    // åŠ è½½ä¼šè¯è¯¦æƒ…
    async function loadConversation(sessionId) {
      try {
        const session = sessions.find(s => s.id === sessionId);
        if (!session) return;

        // æ›´æ–°æ ‡é¢˜
        document.getElementById('conversationTitle').textContent =
          `${session.userName} (ID: ${session.userId})`;

        // åŠ è½½å›å¤
        const response = await fetch(`/api/sessions/${sessionId}/replies`);
        const data = await response.json();
        const sessionReplies = data.replies || [];

        // æ¸²æŸ“ä¼šè¯
        const contentEl = document.getElementById('conversationContent');
        contentEl.innerHTML = `
          <div class="message-item session-msg">
            <div class="message-header">
              <span class="message-author">ğŸ‘¤ ${session.userName} (å®¢æˆ·)</span>
              <span class="message-time">${formatFullTime(session.createdTime)}</span>
            </div>
            <div class="message-content">${session.firstMessage}</div>
          </div>
          ${sessionReplies.map(reply => `
            <div class="message-item reply-msg">
              <div class="message-header">
                <span class="message-author">ğŸ‘¨â€ğŸ’¼ ${reply.fromName} (å®¢æœ)</span>
                <span class="message-time">${formatFullTime(reply.timestamp)}</span>
              </div>
              <div class="message-content">${reply.content}</div>
            </div>
          `).join('')}
        `;

        // æ˜¾ç¤ºå›å¤è¡¨å•
        document.getElementById('replyForm').style.display = 'block';

        // æ»šåŠ¨åˆ°åº•éƒ¨
        setTimeout(() => {
          contentEl.scrollTop = contentEl.scrollHeight;
        }, 100);

      } catch (error) {
        console.error('[ä¼šè¯ç®¡ç†] åŠ è½½ä¼šè¯è¯¦æƒ…å¤±è´¥:', error);
      }
    }

    // å‘é€å›å¤
    async function sendReply() {
      const content = document.getElementById('replyContent').value.trim();

      if (!content) {
        alert('è¯·è¾“å…¥å›å¤å†…å®¹');
        return;
      }

      if (!currentSessionId) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä¼šè¯');
        return;
      }

      try {
        const response = await fetch('/api/sessions/reply', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionId: currentSessionId,
            content: content,
            fromName: 'å®¢æœ' + Math.floor(Math.random() * 10), // ä¸´æ—¶ä½¿ç”¨éšæœºå®¢æœå
            fromId: 'staff_' + Date.now()
          })
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById('replyContent').value = '';
          await loadConversation(currentSessionId);
        } else {
          alert('å‘é€å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (error) {
        alert('å‘é€å¤±è´¥: ' + error.message);
      }
    }

    // æ˜¾ç¤ºåˆ›å»ºä¼šè¯å¯¹è¯æ¡†
    async function showCreateSessionModal() {
      // åŠ è½½é¢‘é“åˆ—è¡¨
      try {
        const response = await fetch('/api/channels');
        const data = await response.json();
        const channelSelect = document.getElementById('sessionChannel');
        channelSelect.innerHTML = '<option value="">è¯·é€‰æ‹©é¢‘é“</option>' +
          data.channels.filter(ch => ch.enabled).map(ch =>
            `<option value="${ch.id}">${ch.name} (${ch.id})</option>`
          ).join('');
      } catch (error) {
        console.error('åŠ è½½é¢‘é“å¤±è´¥:', error);
      }

      document.getElementById('createSessionModal').classList.add('show');
    }

    // å…³é—­åˆ›å»ºä¼šè¯å¯¹è¯æ¡†
    function closeCreateSessionModal() {
      document.getElementById('createSessionModal').classList.remove('show');
    }

    // åŠ è½½é¢‘é“çš„ä¸»é¢˜
    async function loadSessionTopics() {
      const channelId = document.getElementById('sessionChannel').value;
      const topicSelect = document.getElementById('sessionTopic');

      if (!channelId) {
        topicSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©é¢‘é“</option>';
        return;
      }

      try {
        const response = await fetch(`/api/channels/${channelId}/topics`);
        const data = await response.json();
        topicSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ä¸»é¢˜</option>' +
          (data.topics || []).map(t =>
            `<option value="${t.id}">${t.title}</option>`
          ).join('');
      } catch (error) {
        console.error('åŠ è½½ä¸»é¢˜å¤±è´¥:', error);
        topicSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
      }
    }

    // åˆ›å»ºä¼šè¯
    async function createSession(event) {
      event.preventDefault();

      const sessionData = {
        userId: document.getElementById('userId').value.trim(),
        userName: document.getElementById('userName').value.trim(),
        channelId: document.getElementById('sessionChannel').value,
        topicId: document.getElementById('sessionTopic').value,
        firstMessage: document.getElementById('firstMessage').value.trim()
      };

      try {
        const response = await fetch('/api/sessions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(sessionData)
        });

        const data = await response.json();

        if (data.success) {
          closeCreateSessionModal();
          await loadSessions();
          selectSession(data.session.id);
        } else {
          alert('åˆ›å»ºå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (error) {
        alert('åˆ›å»ºå¤±è´¥: ' + error.message);
      }
    }

    // æ—¶é—´æ ¼å¼åŒ–
    function formatTime(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 1) return 'åˆšåˆš';
      if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
      if (hours < 24) return `${hours}å°æ—¶å‰`;
      if (days < 7) return `${days}å¤©å‰`;
      return new Date(timestamp).toLocaleDateString('zh-CN');
    }

    function formatFullTime(timestamp) {
      return new Date(timestamp).toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    // è‡ªåŠ¨åˆ›å»ºä¼šè¯(ä»URLå‚æ•°)
    async function autoCreateSession() {
      const params = new URLSearchParams(window.location.search);
      const auto = params.get('auto');

      if (auto !== 'true') {
        return; // ä¸æ˜¯è‡ªåŠ¨æ¨¡å¼
      }

      const userId = params.get('userId');
      const userName = params.get('userName');
      const channelId = params.get('channelId');
      const channelName = params.get('channelName');
      const topicId = params.get('topicId');
      const topicTitle = params.get('topicTitle');

      if (!userId || !userName || !channelId || !topicId) {
        console.error('[è‡ªåŠ¨ä¼šè¯] ç¼ºå°‘å¿…è¦å‚æ•°');
        return;
      }

      try {
        // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒçš„ä¼šè¯
        const existingSession = sessions.find(s =>
          s.userId === userId && s.topicId === topicId && s.status === 'active'
        );

        if (existingSession) {
          console.log('[è‡ªåŠ¨ä¼šè¯] å·²å­˜åœ¨æ´»è·ƒä¼šè¯,ç›´æ¥æ‰“å¼€');
          selectSession(existingSession.id);
          return;
        }

        // åˆ›å»ºæ–°ä¼šè¯
        const firstMessage = `ä½ å¥½,æˆ‘æ˜¯${userName},æƒ³å’¨è¯¢å…³äº"${topicTitle}"çš„é—®é¢˜`;

        const response = await fetch('/api/sessions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId,
            userName,
            channelId,
            topicId,
            firstMessage
          })
        });

        const data = await response.json();

        if (data.success) {
          console.log('[è‡ªåŠ¨ä¼šè¯] åˆ›å»ºæˆåŠŸ:', data.session);
          // é‡æ–°åŠ è½½ä¼šè¯åˆ—è¡¨
          await loadSessions();
          // é€‰æ‹©æ–°åˆ›å»ºçš„ä¼šè¯
          selectSession(data.session.id);

          // æ›´æ–°æµè§ˆå™¨æ ‡é¢˜
          document.title = `ä¼šè¯: ${userName} - ${topicTitle}`;
        } else {
          alert('åˆ›å»ºä¼šè¯å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (error) {
        console.error('[è‡ªåŠ¨ä¼šè¯] åˆ›å»ºå¤±è´¥:', error);
        alert('åˆ›å»ºä¼šè¯å¤±è´¥: ' + error.message);
      }
    }

    // åˆå§‹åŒ–
    window.addEventListener('load', async () => {
      initSocket();
      await loadSessions();
      await autoCreateSession(); // æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨åˆ›å»ºä¼šè¯

      // é¢‘é“å˜æ›´æ—¶åŠ è½½ä¸»é¢˜
      document.getElementById('sessionChannel').addEventListener('change', loadSessionTopics);

      // Ctrl+Enter å‘é€å›å¤
      document.getElementById('replyContent').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.ctrlKey) {
          e.preventDefault();
          sendReply();
        }
      });

      // ESC å…³é—­æ¨¡æ€æ¡†
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeCreateSessionModal();
        }
      });

      // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
      document.getElementById('createSessionModal').addEventListener('click', (e) => {
        if (e.target.id === 'createSessionModal') {
          closeCreateSessionModal();
        }
      });
    });
  </script>
</body>
</html>
