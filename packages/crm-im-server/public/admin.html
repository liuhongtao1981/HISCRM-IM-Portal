<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM IM æœåŠ¡å™¨ç®¡ç†é¢æ¿</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      color: #333;
      font-size: 28px;
      margin-bottom: 8px;
    }

    .header .subtitle {
      color: #666;
      font-size: 14px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .stat-card .label {
      color: #666;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .stat-card .value {
      color: #333;
      font-size: 32px;
      font-weight: bold;
    }

    .stat-card.success .value {
      color: #52c41a;
    }

    .stat-card.primary .value {
      color: #1890ff;
    }

    .stat-card.warning .value {
      color: #faad14;
    }

    .main-content {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
    }

    .panel {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f0f0f0;
    }

    .panel h2 {
      color: #333;
      font-size: 20px;
      margin: 0;
    }

    .channel-list {
      max-height: 600px;
      overflow-y: auto;
    }

    .channel-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      margin-bottom: 12px;
      background: #f9f9f9;
      border-radius: 8px;
      border-left: 4px solid #1890ff;
      transition: all 0.3s;
    }

    .channel-item:hover {
      background: #f0f0f0;
      transform: translateX(4px);
    }

    .channel-item.pinned {
      border-left-color: #faad14;
    }

    .channel-item.disabled {
      opacity: 0.5;
      border-left-color: #d9d9d9;
    }

    .channel-info {
      flex: 1;
      margin-right: 12px;
    }

    .channel-name {
      font-weight: bold;
      color: #333;
      margin-bottom: 4px;
    }

    .channel-desc {
      font-size: 12px;
      color: #999;
    }

    .channel-actions {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
      font-weight: 500;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-primary {
      background: #1890ff;
      color: white;
    }

    .btn-success {
      background: #52c41a;
      color: white;
    }

    .btn-warning {
      background: #faad14;
      color: white;
    }

    .btn-danger {
      background: #ff4d4f;
      color: white;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }

    .btn-secondary {
      background: #8c8c8c;
      color: white;
    }

    .topics-list {
      margin-top: 20px;
    }

    .topic-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      margin-bottom: 10px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .topic-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .topic-info h4 {
      margin: 0 0 8px 0;
      color: #333;
    }

    .topic-info p {
      margin: 0 0 8px 0;
      color: #666;
    }

    .topic-info small {
      color: #999;
    }

    .topic-actions {
      display: flex;
      gap: 8px;
    }

    .form-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      justify-content: flex-end;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      color: #333;
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .form-group select,
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d9d9d9;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.3s;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }

    .form-group select:focus,
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #1890ff;
      box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .checkbox-group label {
      margin: 0;
      cursor: pointer;
      user-select: none;
    }

    .message-log {
      max-height: 400px;
      overflow-y: auto;
      background: #f9f9f9;
      padding: 16px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .log-entry {
      padding: 8px;
      margin-bottom: 8px;
      background: white;
      border-radius: 4px;
      border-left: 3px solid #52c41a;
    }

    .log-entry .time {
      color: #999;
      font-size: 11px;
    }

    .log-entry .channel {
      color: #1890ff;
      font-weight: bold;
    }

    .log-entry .content {
      color: #333;
      margin-top: 4px;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge-success {
      background: #f6ffed;
      color: #52c41a;
      border: 1px solid #b7eb8f;
    }

    .badge-warning {
      background: #fffbe6;
      color: #faad14;
      border: 1px solid #ffe58f;
    }

    .badge-error {
      background: #fff2f0;
      color: #ff4d4f;
      border: 1px solid #ffccc7;
    }

    .badge-info {
      background: #e6f7ff;
      color: #1890ff;
      border: 1px solid #91d5ff;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f0f0f0;
    }

    .modal-header h3 {
      margin: 0;
      color: #333;
      font-size: 20px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
      padding: 0;
      width: 32px;
      height: 32px;
      line-height: 32px;
      text-align: center;
      border-radius: 50%;
      transition: all 0.3s;
    }

    .modal-close:hover {
      background: #f0f0f0;
      color: #333;
    }

    .modal-footer {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      justify-content: flex-end;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: none;
      animation: slideIn 0.3s ease;
      z-index: 2000;
    }

    .toast.show {
      display: block;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInFromLeft {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @media (max-width: 1024px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }

    /* æµ‹è¯•ç”¨æˆ·å¡ç‰‡æ ·å¼ */
    .test-user-card {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      background: #f9f9f9;
      border-radius: 8px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.3s;
    }

    .test-user-card:hover {
      background: #e6f7ff;
      border-color: #1890ff;
      transform: translateX(4px);
    }

    .test-user-card.selected {
      background: #e6f7ff;
      border-color: #1890ff;
    }

    .test-user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 12px;
      background: #1890ff;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 16px;
    }

    .test-user-info {
      flex: 1;
    }

    .test-user-name {
      font-weight: bold;
      color: #333;
      margin-bottom: 4px;
    }

    .test-user-details {
      font-size: 12px;
      color: #999;
    }

    .test-user-action {
      margin-left: 12px;
    }

    /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ - é€‚ç”¨äºè¯„è®ºå’Œè®¨è®ºåŒºåŸŸ */
    #commentHistoryList::-webkit-scrollbar,
    #selectedCommentArea::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    #commentHistoryList::-webkit-scrollbar-track,
    #selectedCommentArea::-webkit-scrollbar-track {
      background: #f5f5f5;
      border-radius: 4px;
    }

    #commentHistoryList::-webkit-scrollbar-thumb,
    #selectedCommentArea::-webkit-scrollbar-thumb {
      background: #bfbfbf;
      border-radius: 4px;
      transition: background 0.3s;
    }

    #commentHistoryList::-webkit-scrollbar-thumb:hover,
    #selectedCommentArea::-webkit-scrollbar-thumb:hover {
      background: #999;
    }

    /* Firefox æ»šåŠ¨æ¡æ ·å¼ */
    #commentHistoryList,
    #selectedCommentArea {
      scrollbar-width: thin;
      scrollbar-color: #bfbfbf #f5f5f5;
    }

    /* ç¡®ä¿è¯„è®ºå’Œè®¨è®ºåŒºåŸŸä¸è¶…è¿‡å¯ç”¨ç©ºé—´ */
    #commentHistoryList {
      min-height: 0;  /* å…è®¸flexæ”¶ç¼© */
      overflow-y: auto;
      overflow-x: hidden;
    }

    #selectedCommentArea {
      min-height: 0;  /* å…è®¸flexæ”¶ç¼© */
      overflow-y: auto;
      overflow-x: hidden;
    }
  </style>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>ğŸš€ æ–°åª’ä½“è´¦æˆ·ç®¡ç†é¢æ¿</h1>
      <p class="subtitle">ç®¡ç†æ–°åª’ä½“è´¦æˆ·(æŠ–éŸ³ã€å¿«æ‰‹ã€å°çº¢ä¹¦ã€å¤´æ¡ã€è§†é¢‘å·ç­‰)çš„ä½œå“ä¸è¯„è®º</p>
    </div>

    <!-- Stats -->
    <div class="stats">
      <div class="stat-card success">
        <div class="label">åœ¨çº¿ç›‘æ§å®¢æˆ·ç«¯</div>
        <div class="value" id="monitorCount">0</div>
      </div>
      <div class="stat-card primary">
        <div class="label">æ–°åª’ä½“è´¦æˆ·æ•°</div>
        <div class="value" id="channelCount">0</div>
      </div>
      <div class="stat-card warning">
        <div class="label">å·²å‘é€æ¶ˆæ¯</div>
        <div class="value" id="messageCount">0</div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Channel Management -->
      <div class="panel">
        <div class="panel-header">
          <h2>ğŸ“± æ–°åª’ä½“è´¦æˆ·ç®¡ç†</h2>
          <button class="btn btn-success btn-small" onclick="showCreateModal()">
            â• æ–°å»ºè´¦æˆ·
          </button>
        </div>

        <!-- å½“å‰é€‰ä¸­çš„è´¦æˆ·å’Œä½œå“ -->
        <div id="selectedInfo" style="display: none; padding: 12px 20px; background: #e6f7ff; border-left: 4px solid #1890ff; margin: 0 20px 16px 20px; border-radius: 4px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: bold; color: #1890ff; margin-bottom: 4px;">
                ğŸ“ å½“å‰é€‰ä¸­
              </div>
              <div id="selectedChannel" style="color: #333; font-size: 14px; margin-bottom: 2px;">
                è´¦æˆ·: <span id="selectedChannelName"></span>
              </div>
              <div id="selectedTopic" style="color: #666; font-size: 13px;">
                ä½œå“: <span id="selectedTopicName"></span>
              </div>
            </div>
            <button class="btn btn-small" onclick="clearSelection()" style="background: #ff4d4f; color: white;">
              âœ• æ¸…é™¤
            </button>
          </div>
        </div>

        <div class="channel-list" id="channelList">
          <p style="text-align: center; color: #999;">åŠ è½½ä¸­...</p>
        </div>
      </div>

      <!-- Test User Selector -->
      <div class="panel">
        <h2 style="margin-bottom: 20px;">ğŸ‘¥ å¿«é€Ÿæµ‹è¯•è¯„è®º</h2>
        <p style="color: #666; font-size: 13px; margin-bottom: 16px;">
          é€‰æ‹©ä¸€ä¸ªæµ‹è¯•ç”¨æˆ·,åœ¨é€‰å®šçš„ä½œå“ä¸‹å‘è¡¨è¯„è®ºæˆ–å‘é€ç§ä¿¡
        </p>
        <div id="testUsers" style="display: flex; flex-direction: column; gap: 12px;">
          <!-- æµ‹è¯•ç”¨æˆ·åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>

      <!-- Message Sender -->
      <div class="panel" style="margin-top: 20px;">
        <h2 style="margin-bottom: 20px;">âœ‰ï¸ å‘é€æµ‹è¯•æ¶ˆæ¯</h2>
        <div class="form-group">
          <label>ç›®æ ‡è´¦æˆ· *</label>
          <select id="targetChannel" onchange="loadChannelTopics()">
            <option value="">è¯·é€‰æ‹©è´¦æˆ·...</option>
          </select>
        </div>
        <div class="form-group">
          <label>ç›®æ ‡ä½œå“ *</label>
          <select id="targetTopic">
            <option value="">è¯·å…ˆé€‰æ‹©è´¦æˆ·</option>
          </select>
        </div>
        <div class="form-group">
          <label>æ¶ˆæ¯å†…å®¹</label>
          <textarea id="messageContent" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹... (Ctrl+Enter å‘é€)"></textarea>
        </div>
        <button class="btn btn-primary" onclick="sendMessage()" style="width: 100%;">
          ğŸ“¤ å‘é€æ¶ˆæ¯
        </button>

        <h2 style="margin-top: 32px; margin-bottom: 16px;">ğŸ“ æ¶ˆæ¯æ—¥å¿—</h2>
        <div class="message-log" id="messageLog">
          <p style="text-align: center; color: #999;">æš‚æ— æ¶ˆæ¯</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Create/Edit Channel Modal -->
  <div class="modal" id="channelModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">æ–°å»ºæ–°åª’ä½“è´¦æˆ·</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>

      <form id="channelForm" onsubmit="saveChannel(event)">
        <div class="form-group">
          <label>è´¦æˆ· ID *</label>
          <input type="text" id="channelId" required placeholder="ä¾‹: douyin_001" pattern="[a-zA-Z0-9_]+" title="åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿">
        </div>

        <div class="form-group">
          <label>è´¦æˆ·åç§° *</label>
          <input type="text" id="channelName" required placeholder="ä¾‹: æŠ–éŸ³-ç¾é£Ÿåšä¸»">
        </div>

        <div class="form-group">
          <label>å¤´åƒ URL</label>
          <input type="url" id="channelAvatar" placeholder="ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆ">
        </div>

        <div class="form-group">
          <label>æè¿°</label>
          <textarea id="channelDescription" placeholder="è´¦æˆ·æè¿°,å¦‚:æŠ–éŸ³å¹³å°ç¾é£Ÿåˆ†äº«è´¦å· (å¯é€‰)" style="min-height: 60px;"></textarea>
        </div>

        <div class="checkbox-group">
          <input type="checkbox" id="channelPinned">
          <label for="channelPinned">ç½®é¡¶è´¦æˆ·</label>
        </div>

        <div class="checkbox-group">
          <input type="checkbox" id="channelEnabled" checked>
          <label for="channelEnabled">å¯ç”¨è´¦æˆ·</label>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn" onclick="closeModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <!-- ä½œå“é€‰æ‹©æ¨¡æ€æ¡†(ç”¨äºé€‰æ‹©è´¦æˆ·åé€‰ä½œå“) -->
  <div id="topicSelectorModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>é€‰æ‹©ä½œå“ - <span id="topicSelectorChannelName"></span></h2>
        <span class="close" onclick="closeTopicSelector()">&times;</span>
      </div>
      <div class="modal-body">
        <div id="topicSelectorList" class="topics-list" style="max-height: 400px; overflow-y: auto;">
          <p style="text-align: center; color: #999;">åŠ è½½ä¸­...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- è¯„è®ºå¼¹å‡ºå±‚ - ä¸‰æ å¸ƒå±€ -->
  <div id="commentHistoryModal" class="modal">
    <div class="modal-content" style="max-width: 95%; max-height: 90vh; width: 1400px; padding: 0; overflow: hidden; display: flex; flex-direction: column;">
      <!-- é¡¶éƒ¨ - æ˜¾ç¤ºå½“å‰ç”¨æˆ·ã€è´¦æˆ·å’Œä½œå“ä¿¡æ¯ -->
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; color: white;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
          <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div id="currentUserAvatar" style="width: 48px; height: 48px; border-radius: 50%; background: rgba(255,255,255,0.3);
                          color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px;
                          border: 2px solid rgba(255,255,255,0.5);"></div>
              <div>
                <h2 style="color: white; margin: 0; font-size: 20px;">å½“å‰ç”¨æˆ·: <span id="commentUserNameDisplay"></span></h2>
                <p style="margin: 4px 0 0 0; font-size: 13px; opacity: 0.9;">æ­£åœ¨å‚ä¸ä½œå“è¯„è®ºäº’åŠ¨</p>
              </div>
            </div>
            <div style="padding: 12px 16px; background: rgba(255,255,255,0.15); border-radius: 8px; backdrop-filter: blur(10px);">
              <div style="font-size: 14px; opacity: 0.95; margin-bottom: 4px;">
                <span style="opacity: 0.8;">ğŸ“± æ–°åª’ä½“è´¦æˆ·:</span>
                <strong id="commentHistoryChannel" style="margin-left: 8px; font-size: 15px;"></strong>
              </div>
              <div style="font-size: 14px; opacity: 0.95;">
                <span style="opacity: 0.8;">ğŸ¬ ä½œå“:</span>
                <strong id="commentHistoryTopic" style="margin-left: 8px; font-size: 15px;"></strong>
              </div>
            </div>
          </div>
          <button onclick="closeCommentHistory()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 24px; transition: all 0.3s; flex-shrink: 0; margin-left: 20px;">&times;</button>
        </div>
      </div>

      <!-- ä¸»ä½“ - å·¦å³ä¸¤æ  -->
      <div style="display: grid; grid-template-columns: 450px 1fr; gap: 0; flex: 1; overflow: hidden; background: #f5f5f5;">

        <!-- å·¦ä¾§ - 1çº§è¯„è®ºåˆ—è¡¨å’Œæ–°å¢è¯„è®º -->
        <div style="background: white; border-right: 1px solid #e0e0e0; position: relative; height: 100%; display: flex; flex-direction: column;">
          <!-- æ ‡é¢˜åŒºåŸŸ -->
          <div style="padding: 16px; border-bottom: 2px solid #f0f0f0; background: #fafafa; flex-shrink: 0;">
            <h3 style="margin: 0; color: #333; font-size: 16px;">
              ğŸ’¬ ä½œå“è¯„è®ºåˆ—è¡¨
              <span id="commentCount" style="color: #999; font-size: 14px; font-weight: normal;">(0)</span>
            </h3>
            <p style="margin: 6px 0 0 0; font-size: 12px; color: #999;">
              <span style="display: inline-block; padding: 2px 8px; background: #e6f7ff; color: #1890ff; border-radius: 4px; margin-right: 6px;">1çº§è¯„è®º</span>
              ç‚¹å‡»æŸ¥çœ‹è¯¥è¯„è®ºçš„è®¨è®º
            </p>
          </div>

          <!-- è¯„è®ºåˆ—è¡¨ - ç•™å‡ºåº•éƒ¨è¾“å…¥æ¡†ç©ºé—´ -->
          <div id="commentHistoryList" style="flex: 1; overflow-y: auto; padding: 12px 12px 200px 12px; min-height: 0;">
            <p style="text-align: center; color: #999; padding: 40px 20px;">åŠ è½½ä¸­...</p>
          </div>

          <!-- æ–°å¢1çº§è¯„è®ºåŒºåŸŸ - å›ºå®šåœ¨åº•éƒ¨ -->
          <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 16px; background: linear-gradient(180deg, #fafafa 0%, #f5f5f5 100%); border-top: 2px solid #e0e0e0; box-shadow: 0 -4px 12px rgba(0,0,0,0.08); z-index: 10;">
            <div style="margin-bottom: 10px; padding: 8px 12px; background: white; border-radius: 6px; border-left: 3px solid #1890ff;">
              <div style="font-size: 13px; font-weight: 600; color: #333; margin-bottom: 2px;">
                ğŸ’­ å‘è¡¨ä½œå“è¯„è®º
              </div>
              <div style="font-size: 11px; color: #999;">
                å½“å‰ç”¨æˆ·: <span id="commentUserName" style="color: #1890ff; font-weight: 500;"></span>
              </div>
            </div>
            <textarea id="newCommentInput" rows="3" style="width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 13px; font-family: inherit; resize: none; box-sizing: border-box;" placeholder="å¯¹è¿™ä¸ªä½œå“å‘è¡¨ä½ çš„çœ‹æ³•... (Ctrl+Enter å‘é€)"></textarea>
            <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
              <span style="font-size: 11px; color: #999;">ğŸ’¡ å‘è¡¨åå°†ä½œä¸º1çº§è¯„è®º</span>
              <button class="btn btn-primary btn-small" onclick="submitNewComment()">
                ğŸ“¤ å‘è¡¨è¯„è®º
              </button>
            </div>
          </div>
        </div>

        <!-- å³ä¾§ - é€‰ä¸­è¯„è®ºçš„è®¨è®ºåŒº -->
        <div style="position: relative; background: white; height: 100%; display: flex; flex-direction: column;">
          <!-- é¡¶éƒ¨æ ‡é¢˜ -->
          <div style="padding: 16px; border-bottom: 2px solid #f0f0f0; background: #fafafa; flex-shrink: 0;">
            <h3 style="margin: 0; color: #333; font-size: 16px;">
              ğŸ—¨ï¸ è¯„è®ºè®¨è®ºåŒº
            </h3>
            <p id="discussionHint" style="margin: 6px 0 0 0; font-size: 12px; color: #999;">
              <span style="display: inline-block; padding: 2px 8px; background: #f6ffed; color: #52c41a; border-radius: 4px; margin-right: 6px;">2çº§è®¨è®º</span>
              ç‚¹å‡»å·¦ä¾§è¯„è®ºæŸ¥çœ‹è¯¥è¯„è®ºçš„è®¨è®ºå†…å®¹
            </p>
          </div>

          <!-- è®¨è®ºå†…å®¹åŒºåŸŸ(åŒ…å«è¯„è®ºå’Œè®¨è®ºåˆ—è¡¨) - ç•™å‡ºåº•éƒ¨è¾“å…¥æ¡†ç©ºé—´ -->
          <div id="selectedCommentArea" style="flex: 1; overflow-y: auto; padding: 20px 20px 220px 20px; background: #f9f9f9; min-height: 0;">
            <div style="text-align: center; padding: 60px 20px; color: #999;">
              <p style="font-size: 48px; margin: 0;">ğŸ’­</p>
              <p style="margin: 12px 0 0 0;">ç‚¹å‡»å·¦ä¾§è¯„è®ºæŸ¥çœ‹è®¨è®ºå†…å®¹</p>
            </div>
          </div>

          <!-- è®¨è®ºå›å¤è¾“å…¥æ¡† - å›ºå®šåœ¨åº•éƒ¨ -->
          <div id="discussionReplyArea" style="display: none; position: absolute; bottom: 0; left: 0; right: 0; padding: 16px; background: linear-gradient(180deg, #fafafa 0%, #f5f5f5 100%); border-top: 2px solid #e0e0e0; box-shadow: 0 -4px 12px rgba(0,0,0,0.08); z-index: 10;">
            <div style="margin-bottom: 10px; padding: 8px 12px; background: white; border-radius: 6px; border-left: 3px solid #52c41a;">
              <div style="font-size: 13px; font-weight: 600; color: #333; margin-bottom: 6px;">
                ğŸ—¨ï¸ å‚ä¸è®¨è®º
              </div>
              <div style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: #999;">
                <span>é€‰æ‹©å‘è¨€ç”¨æˆ·:</span>
                <select id="discussionUserSelect" style="padding: 5px 10px; border: 1px solid #d9d9d9; border-radius: 4px; font-size: 12px; outline: none; cursor: pointer; background: white;">
                  <option value="">é€‰æ‹©å‘è¨€ç”¨æˆ·...</option>
                </select>
              </div>
            </div>
            <textarea id="discussionInput" rows="3" style="width: 100%; padding: 10px 12px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 13px; font-family: inherit; resize: none; outline: none; box-sizing: border-box;" placeholder="å¯¹è¿™æ¡è¯„è®ºå‘è¡¨ä½ çš„è®¨è®º... (Ctrl+Enter å‘é€)"></textarea>
            <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
              <span style="font-size: 11px; color: #999;">ğŸ’¡ å‘è¡¨åå°†ä½œä¸º2çº§è®¨è®º</span>
              <button class="btn btn-primary btn-small" onclick="submitDiscussion()">
                ğŸ’¬ å‘é€è®¨è®º
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- ä½œå“ç®¡ç†æ¨¡æ€æ¡† -->
  <div id="topicsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ä½œå“ç®¡ç† - <span id="topicChannelName"></span></h2>
        <span class="close" onclick="closeTopicsModal()">&times;</span>
      </div>
      <div class="modal-body">
        <button class="btn btn-primary" onclick="openCreateTopicModal()">+ æ–°å»ºä½œå“</button>
        <div id="topicsList" class="topics-list"></div>
      </div>
    </div>
  </div>

  <!-- åˆ›å»º/ç¼–è¾‘ä½œå“æ¨¡æ€æ¡† -->
  <div id="topicFormModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="topicFormTitle">æ–°å»ºä½œå“</h2>
        <span class="close" onclick="closeTopicFormModal()">&times;</span>
      </div>
      <div class="modal-body">
        <form id="topicForm" onsubmit="saveTopic(event)">
          <input type="hidden" id="topicChannelId">
          <input type="hidden" id="topicEditId">

          <div class="form-group">
            <label>ä½œå“ID *</label>
            <input type="text" id="topicId" required placeholder="ä¾‹: video_001">
          </div>

          <div class="form-group">
            <label>ä½œå“æ ‡é¢˜ *</label>
            <input type="text" id="topicTitle" required placeholder="ä¾‹: å¦‚ä½•åšä¸€é“ç¾å‘³çš„çº¢çƒ§è‚‰">
          </div>

          <div class="form-group">
            <label>ä½œå“æè¿°</label>
            <textarea id="topicDescription" rows="3" placeholder="ä½œå“çš„è¯¦ç»†æè¿°,å¦‚:è§†é¢‘å†…å®¹ç®€ä»‹ã€å‘å¸ƒæ—¶é—´ç­‰"></textarea>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="topicIsPinned">
              ç½®é¡¶æ­¤ä½œå“
            </label>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeTopicFormModal()">å–æ¶ˆ</button>
            <button type="submit" class="btn btn-primary">ä¿å­˜</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    let messageCount = 0;
    let editingChannelId = null;
    let currentChannelForTopics = null;
    let socket = null;

    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast show badge-${type}`;
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // åŠ è½½é¢‘é“åˆ—è¡¨
    async function loadChannels() {
      try {
        const response = await fetch('/api/channels?all=true');
        const data = await response.json();

        document.getElementById('channelCount').textContent = data.channels.length;

        // æ¸²æŸ“é¢‘é“åˆ—è¡¨
        const channelListHtml = data.channels.map(channel => `
          <div class="channel-item ${channel.isPinned ? 'pinned' : ''} ${!channel.enabled ? 'disabled' : ''}">
            <div class="channel-info">
              <div class="channel-name">
                ${channel.name}
                ${channel.isPinned ? '<span class="badge badge-warning">ğŸ“Œ ç½®é¡¶</span>' : ''}
                ${!channel.enabled ? '<span class="badge badge-error">ğŸš« å·²ç¦ç”¨</span>' : '<span class="badge badge-success">âœ“ å·²å¯ç”¨</span>'}
              </div>
              <div class="channel-desc">
                ID: ${channel.id} | ${channel.description || 'æš‚æ— æè¿°'}
              </div>
            </div>
            <div class="channel-actions">
              <button class="btn btn-primary btn-small" onclick="selectChannelForTopic('${channel.id}', '${channel.name.replace(/'/g, "\\'")}')">
                é€‰æ‹©
              </button>
              <button class="btn btn-success btn-small" onclick="openTopicsModal('${channel.id}', '${channel.name.replace(/'/g, "\\'")}')">
                ç®¡ç†ä½œå“
              </button>
              <button class="btn btn-warning btn-small" onclick="editChannel('${channel.id}')">
                ç¼–è¾‘
              </button>
              <button class="btn btn-danger btn-small" onclick="deleteChannel('${channel.id}', '${channel.name.replace(/'/g, "\\'")}')">
                åˆ é™¤
              </button>
            </div>
          </div>
        `).join('');

        document.getElementById('channelList').innerHTML = channelListHtml || '<p style="text-align: center; color: #999;">æš‚æ— é¢‘é“</p>';

        // æ›´æ–°é¢‘é“ä¸‹æ‹‰åˆ—è¡¨
        const selectHtml = '<option value="">è¯·é€‰æ‹©é¢‘é“...</option>' +
          data.channels
            .filter(ch => ch.enabled)
            .map(ch => `<option value="${ch.id}">${ch.name} (${ch.id})</option>`)
            .join('');

        document.getElementById('targetChannel').innerHTML = selectHtml;

      } catch (error) {
        showToast('åŠ è½½é¢‘é“å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æ˜¾ç¤ºåˆ›å»ºè´¦æˆ·å¯¹è¯æ¡†
    function showCreateModal() {
      editingChannelId = null;
      document.getElementById('modalTitle').textContent = 'æ–°å»ºæ–°åª’ä½“è´¦æˆ·';
      document.getElementById('channelForm').reset();
      document.getElementById('channelId').disabled = false;
      document.getElementById('channelEnabled').checked = true;
      document.getElementById('channelModal').classList.add('show');
    }

    // ç¼–è¾‘è´¦æˆ·
    async function editChannel(id) {
      try {
        const response = await fetch(`/api/channels/${id}`);
        const data = await response.json();
        const channel = data.channel;

        editingChannelId = id;
        document.getElementById('modalTitle').textContent = 'ç¼–è¾‘æ–°åª’ä½“è´¦æˆ·';
        document.getElementById('channelId').value = channel.id;
        document.getElementById('channelId').disabled = true;
        document.getElementById('channelName').value = channel.name;
        document.getElementById('channelAvatar').value = channel.avatar || '';
        document.getElementById('channelDescription').value = channel.description || '';
        document.getElementById('channelPinned').checked = channel.isPinned;
        document.getElementById('channelEnabled').checked = channel.enabled;
        document.getElementById('channelModal').classList.add('show');

      } catch (error) {
        showToast('åŠ è½½è´¦æˆ·ä¿¡æ¯å¤±è´¥: ' + error.message, 'error');
      }
    }

    // ä¿å­˜é¢‘é“
    async function saveChannel(event) {
      event.preventDefault();

      const channelData = {
        id: document.getElementById('channelId').value.trim(),
        name: document.getElementById('channelName').value.trim(),
        avatar: document.getElementById('channelAvatar').value.trim(),
        description: document.getElementById('channelDescription').value.trim(),
        isPinned: document.getElementById('channelPinned').checked,
        enabled: document.getElementById('channelEnabled').checked
      };

      try {
        let response;
        if (editingChannelId) {
          // æ›´æ–°é¢‘é“
          response = await fetch(`/api/channels/${editingChannelId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(channelData)
          });
        } else {
          // åˆ›å»ºé¢‘é“
          response = await fetch('/api/channels', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(channelData)
          });
        }

        const data = await response.json();

        if (data.success) {
          showToast(editingChannelId ? 'é¢‘é“æ›´æ–°æˆåŠŸï¼' : 'é¢‘é“åˆ›å»ºæˆåŠŸï¼', 'success');
          closeModal();
          loadChannels();
        } else {
          showToast(data.error || 'æ“ä½œå¤±è´¥', 'error');
        }
      } catch (error) {
        showToast('æ“ä½œå¤±è´¥: ' + error.message, 'error');
      }
    }

    // åˆ é™¤é¢‘é“
    async function deleteChannel(id, name) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤é¢‘é“ "${name}" å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
        return;
      }

      try {
        const response = await fetch(`/api/channels/${id}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
          showToast('é¢‘é“å·²åˆ é™¤', 'success');
          loadChannels();
        } else {
          showToast(data.error || 'åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
      }
    }

    // å…³é—­å¯¹è¯æ¡†
    function closeModal() {
      document.getElementById('channelModal').classList.remove('show');
    }

    // æ‰“å¼€ä¸»é¢˜ç®¡ç†æ¨¡æ€æ¡†
    async function openTopicsModal(channelId, channelName) {
      currentChannelForTopics = channelId;
      document.getElementById('topicChannelName').textContent = channelName;
      document.getElementById('topicsModal').style.display = 'block';
      await loadTopics(channelId);
    }

    // å…³é—­ä¸»é¢˜ç®¡ç†æ¨¡æ€æ¡†
    function closeTopicsModal() {
      document.getElementById('topicsModal').style.display = 'none';
      currentChannelForTopics = null;
    }

    // åŠ è½½ä¸»é¢˜åˆ—è¡¨
    async function loadTopics(channelId) {
      try {
        const response = await fetch(`/api/channels/${channelId}/topics`);
        const data = await response.json();
        const topics = data.topics || [];

        const topicsList = document.getElementById('topicsList');
        if (topics.length === 0) {
          topicsList.innerHTML = '<p style="text-align: center; color: #999;">æš‚æ— ä¸»é¢˜</p>';
          return;
        }

        topicsList.innerHTML = topics.map(topic => `
          <div class="topic-item">
            <div class="topic-info">
              <h4>${topic.isPinned ? 'ğŸ“Œ ' : ''}${topic.title}</h4>
              <p>${topic.description || 'æš‚æ— æè¿°'}</p>
              <small>è¯„è®ºæ•°: ${topic.messageCount || 0} | å‘å¸ƒæ—¶é—´: ${new Date(topic.createdTime).toLocaleString('zh-CN')}</small>
            </div>
            <div class="topic-actions">
              <button class="btn btn-small btn-secondary" onclick='editTopic(${JSON.stringify(topic)})'>ç¼–è¾‘</button>
              <button class="btn btn-small btn-danger" onclick="deleteTopic('${topic.id}', '${topic.title}')">åˆ é™¤</button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('åŠ è½½ä¸»é¢˜å¤±è´¥:', error);
        showToast('åŠ è½½ä¸»é¢˜åˆ—è¡¨å¤±è´¥', 'error');
      }
    }

    // æ‰“å¼€åˆ›å»ºä½œå“æ¨¡æ€æ¡†
    function openCreateTopicModal() {
      document.getElementById('topicFormTitle').textContent = 'æ–°å»ºä½œå“';
      document.getElementById('topicForm').reset();
      document.getElementById('topicChannelId').value = currentChannelForTopics;
      document.getElementById('topicEditId').value = '';
      document.getElementById('topicId').disabled = false;
      document.getElementById('topicFormModal').style.display = 'block';
    }

    // ç¼–è¾‘ä½œå“
    function editTopic(topic) {
      document.getElementById('topicFormTitle').textContent = 'ç¼–è¾‘ä½œå“';
      document.getElementById('topicChannelId').value = topic.channelId;
      document.getElementById('topicEditId').value = topic.id;
      document.getElementById('topicId').value = topic.id;
      document.getElementById('topicId').disabled = true;
      document.getElementById('topicTitle').value = topic.title;
      document.getElementById('topicDescription').value = topic.description || '';
      document.getElementById('topicIsPinned').checked = topic.isPinned || false;
      document.getElementById('topicFormModal').style.display = 'block';
    }

    // å…³é—­ä¸»é¢˜è¡¨å•æ¨¡æ€æ¡†
    function closeTopicFormModal() {
      document.getElementById('topicFormModal').style.display = 'none';
    }

    // ä¿å­˜ä¸»é¢˜
    async function saveTopic(event) {
      event.preventDefault();

      const topicData = {
        id: document.getElementById('topicId').value,
        channelId: document.getElementById('topicChannelId').value,
        title: document.getElementById('topicTitle').value,
        description: document.getElementById('topicDescription').value,
        isPinned: document.getElementById('topicIsPinned').checked
      };

      const editId = document.getElementById('topicEditId').value;
      const url = editId ? `/api/topics/${editId}` : '/api/topics';
      const method = editId ? 'PUT' : 'POST';

      try {
        const response = await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(topicData)
        });

        const result = await response.json();
        if (result.success) {
          showToast(editId ? 'ä½œå“æ›´æ–°æˆåŠŸ' : 'ä½œå“åˆ›å»ºæˆåŠŸ', 'success');
          closeTopicFormModal();
          await loadTopics(currentChannelForTopics);
        } else {
          showToast('æ“ä½œå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (error) {
        console.error('ä¿å­˜ä½œå“å¤±è´¥:', error);
        showToast('ä¿å­˜ä½œå“å¤±è´¥', 'error');
      }
    }

    // åˆ é™¤ä½œå“
    async function deleteTopic(topicId, topicTitle) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤ä½œå“"${topicTitle}"å—ï¼Ÿ`)) {
        return;
      }

      try {
        const response = await fetch(`/api/topics/${topicId}`, { method: 'DELETE' });
        const result = await response.json();

        if (result.success) {
          showToast('ä½œå“åˆ é™¤æˆåŠŸ', 'success');
          await loadTopics(currentChannelForTopics);
        } else {
          showToast('åˆ é™¤å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (error) {
        console.error('åˆ é™¤ä½œå“å¤±è´¥:', error);
        showToast('åˆ é™¤ä½œå“å¤±è´¥', 'error');
      }
    }

    // å½“å‰é€‰ä¸­çš„é¢‘é“å’Œä¸»é¢˜
    let currentSelectedChannel = null;
    let currentSelectedTopic = null;

    // é€‰æ‹©è´¦æˆ·(æ—§åŠŸèƒ½ä¿ç•™,ç”¨äºæµ‹è¯•æ¶ˆæ¯)
    function selectChannel(id, name) {
      document.getElementById('targetChannel').value = id;
      loadChannelTopics(); // é€‰æ‹©è´¦æˆ·åè‡ªåŠ¨åŠ è½½ä½œå“
      showToast(`å·²é€‰æ‹©è´¦æˆ·: ${name}`, 'info');
    }

    // é€‰æ‹©è´¦æˆ·å¹¶å¼¹å‡ºä½œå“é€‰æ‹©
    async function selectChannelForTopic(channelId, channelName) {
      currentSelectedChannel = { id: channelId, name: channelName };

      // æ‰“å¼€ä½œå“é€‰æ‹©æ¨¡æ€æ¡†
      document.getElementById('topicSelectorChannelName').textContent = channelName;
      document.getElementById('topicSelectorModal').style.display = 'block';

      // åŠ è½½è¯¥è´¦æˆ·çš„ä½œå“åˆ—è¡¨
      try {
        const response = await fetch(`/api/channels/${channelId}/topics`);
        const data = await response.json();
        const topics = data.topics || [];

        const listEl = document.getElementById('topicSelectorList');

        if (topics.length === 0) {
          listEl.innerHTML = '<p style="text-align: center; color: #999;">è¯¥è´¦æˆ·æš‚æ— ä½œå“</p>';
          return;
        }

        listEl.innerHTML = topics.map(topic => `
          <div class="topic-item" onclick="selectTopicFromList('${topic.id}', '${topic.title.replace(/'/g, "\\'")}')">
            <div class="topic-info">
              <h4 style="cursor: pointer;">${topic.isPinned ? 'ğŸ“Œ ' : ''}${topic.title}</h4>
              <p>${topic.description || 'æš‚æ— æè¿°'}</p>
              <small>è¯„è®ºæ•°: ${topic.messageCount || 0} | å‘å¸ƒæ—¶é—´: ${new Date(topic.createdTime).toLocaleString('zh-CN')}</small>
            </div>
          </div>
        `).join('');

      } catch (error) {
        console.error('åŠ è½½ä½œå“å¤±è´¥:', error);
        showToast('åŠ è½½ä½œå“åˆ—è¡¨å¤±è´¥', 'error');
      }
    }

    // ä»åˆ—è¡¨ä¸­é€‰æ‹©ä½œå“
    function selectTopicFromList(topicId, topicTitle) {
      currentSelectedTopic = { id: topicId, title: topicTitle };

      // æ›´æ–°æ˜¾ç¤ºåŒºåŸŸ
      document.getElementById('selectedChannelName').textContent = currentSelectedChannel.name;
      document.getElementById('selectedTopicName').textContent = topicTitle;
      document.getElementById('selectedInfo').style.display = 'block';

      // å…³é—­æ¨¡æ€æ¡†
      closeTopicSelector();

      showToast(`å·²é€‰æ‹©: ${currentSelectedChannel.name} / ${topicTitle}`, 'success');
    }

    // å…³é—­ä¸»é¢˜é€‰æ‹©å™¨
    function closeTopicSelector() {
      document.getElementById('topicSelectorModal').style.display = 'none';
    }

    // æ¸…é™¤é€‰æ‹©
    function clearSelection() {
      currentSelectedChannel = null;
      currentSelectedTopic = null;
      document.getElementById('selectedInfo').style.display = 'none';
      showToast('å·²æ¸…é™¤é€‰æ‹©', 'info');
    }

    // ============ è¯„è®ºå†å²å¼¹çª—ç›¸å…³å‡½æ•° ============
    let currentCommentUser = null;
    let allComments = []; // å­˜å‚¨æ‰€æœ‰è¯„è®ºæ•°æ®
    let selectedCommentId = null; // å½“å‰é€‰ä¸­çš„1çº§è¯„è®ºID
    let discussionUsers = []; // å¯å‚ä¸è®¨è®ºçš„ç”¨æˆ·åˆ—è¡¨

    // æ‰“å¼€è¯„è®ºå†å²å¼¹çª—
    async function openCommentHistory(user, channelId, channelName, topicId, topicTitle) {
      currentCommentUser = user;
      selectedCommentId = null;

      // è®¾ç½®å½“å‰ç”¨æˆ·ä¿¡æ¯
      document.getElementById('commentUserNameDisplay').textContent = user.name;
      document.getElementById('currentUserAvatar').textContent = user.name.substring(0, 1);

      // è®¾ç½®è´¦æˆ·å’Œä½œå“ä¿¡æ¯
      document.getElementById('commentHistoryChannel').textContent = channelName;
      document.getElementById('commentHistoryTopic').textContent = topicTitle;
      document.getElementById('commentUserName').textContent = user.name;

      // æ¸…ç©ºè¾“å…¥æ¡†
      document.getElementById('newCommentInput').value = '';
      document.getElementById('discussionInput').value = '';
      document.getElementById('discussionReplyArea').style.display = 'none';

      // é‡ç½®å³ä¾§è®¨è®ºåŒº
      document.getElementById('selectedCommentArea').innerHTML = `
        <div style="text-align: center; padding: 60px 20px; color: #999;">
          <p style="font-size: 48px; margin: 0;">ğŸ’­</p>
          <p style="margin: 12px 0 0 0;">ç‚¹å‡»å·¦ä¾§è¯„è®ºæŸ¥çœ‹è®¨è®ºå†…å®¹</p>
        </div>
      `;

      // åˆå§‹åŒ–è®¨è®ºç”¨æˆ·åˆ—è¡¨
      initDiscussionUsers();

      // æ˜¾ç¤ºå¼¹çª—
      document.getElementById('commentHistoryModal').style.display = 'flex';

      // åŠ è½½å†å²è¯„è®º
      await loadCommentHistory(channelId, topicId);
    }

    // åˆå§‹åŒ–å¯å‚ä¸è®¨è®ºçš„ç”¨æˆ·åˆ—è¡¨
    function initDiscussionUsers() {
      discussionUsers = [
        currentCommentUser, // å½“å‰é€‰ä¸­çš„ç”¨æˆ·
        ...testUsers.filter(u => u.id !== currentCommentUser.id) // å…¶ä»–æµ‹è¯•ç”¨æˆ·
      ];

      const select = document.getElementById('discussionUserSelect');
      select.innerHTML = '<option value="">é€‰æ‹©å‘è¨€ç”¨æˆ·...</option>' +
        discussionUsers.map((u, index) =>
          `<option value="${index}" ${index === 0 ? 'selected' : ''}>${u.name}${index === 0 ? ' (å½“å‰ç”¨æˆ·)' : ''}</option>`
        ).join('');
    }

    // åŠ è½½å†å²è¯„è®º
    async function loadCommentHistory(channelId, topicId) {
      const listContainer = document.getElementById('commentHistoryList');
      listContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 20px;">åŠ è½½ä¸­...</p>';

      try {
        // è·å–è¯¥ä¸»é¢˜çš„æ‰€æœ‰æ¶ˆæ¯
        console.log('[è¯„è®ºå†å²] æ­£åœ¨åŠ è½½:', { channelId, topicId });
        const url = `/api/messages?channelId=${channelId}&topicId=${topicId}`;
        console.log('[è¯„è®ºå†å²] è¯·æ±‚URL:', url);

        const response = await fetch(url);
        console.log('[è¯„è®ºå†å²] å“åº”çŠ¶æ€:', response.status);

        if (!response.ok) {
          throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
        }

        const data = await response.json();
        console.log('[è¯„è®ºå†å²] æ”¶åˆ°æ•°æ®:', data);

        const messages = data.messages || [];
        console.log('[è¯„è®ºå†å²] æ¶ˆæ¯æ•°é‡:', messages.length);

        // æ„å»ºè¯„è®ºæ ‘ç»“æ„
        allComments = messages.map((msg, index) => ({
          id: msg.id || `msg_${index}_${msg.timestamp}`,
          content: msg.content,
          fromName: msg.fromName || 'åŒ¿åç”¨æˆ·',
          fromId: msg.fromId || 'unknown',
          timestamp: msg.timestamp,
          parentId: msg.parentId || null, // çˆ¶è¯„è®ºID,å¦‚æœä¸ºnullåˆ™æ˜¯1çº§è¯„è®º
          replies: [] // 2çº§è¯„è®ºåˆ—è¡¨
        }));

        // æŒ‰æ—¶é—´å‡åºæ’åˆ—
        allComments.sort((a, b) => a.timestamp - b.timestamp);

        // åˆ†ç¦»1çº§è¯„è®ºå’Œ2çº§è¯„è®º
        const level1Comments = allComments.filter(c => !c.parentId);
        const level2Comments = allComments.filter(c => c.parentId);

        // å°†2çº§è¯„è®ºå…³è”åˆ°1çº§è¯„è®º
        level2Comments.forEach(reply => {
          const parent = level1Comments.find(c => c.id === reply.parentId);
          if (parent) {
            parent.replies.push(reply);
          }
        });

        // æ›´æ–°è¯„è®ºè®¡æ•°
        document.getElementById('commentCount').textContent = `(${level1Comments.length})`;

        if (level1Comments.length === 0) {
          listContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 40px 20px;">æš‚æ— è¯„è®º</p>';
          return;
        }

        // æ¸²æŸ“1çº§è¯„è®ºåˆ—è¡¨
        const commentsHtml = level1Comments.map(comment => {
          const time = formatCommentTime(comment.timestamp);
          const discussionCount = comment.replies.length;
          const isSelected = selectedCommentId === comment.id;

          return `
            <div class="comment-list-item ${isSelected ? 'selected' : ''}"
                 data-comment-id="${comment.id}"
                 onclick="selectComment('${comment.id}')"
                 style="padding: 14px; margin-bottom: 10px; border-radius: 8px; background: ${isSelected ? '#e6f7ff' : '#f9f9f9'};
                        border: 2px solid ${isSelected ? '#1890ff' : '#e0e0e0'}; cursor: pointer; transition: all 0.2s;
                        box-shadow: ${isSelected ? '0 2px 8px rgba(24,144,255,0.2)' : '0 1px 3px rgba(0,0,0,0.05)'};">
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                              color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;">
                    ${comment.fromName.substring(0, 1)}
                  </div>
                  <span style="font-weight: bold; color: #333; font-size: 14px;">${comment.fromName}</span>
                </div>
                <span style="font-size: 11px; color: #999;">${time}</span>
              </div>
              <div style="color: #555; line-height: 1.6; font-size: 14px; margin-bottom: 10px; padding-left: 40px;">${comment.content}</div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding-left: 40px;">
                <span style="font-size: 12px; color: ${discussionCount > 0 ? '#1890ff' : '#999'}; font-weight: 500;">
                  ${discussionCount > 0 ? `ğŸ—¨ï¸ ${discussionCount} æ¡è®¨è®º` : 'ğŸ’­ æš‚æ— è®¨è®º'}
                </span>
                ${isSelected ? '<span style="font-size: 11px; color: #1890ff;">â— å·²é€‰ä¸­</span>' : ''}
              </div>
            </div>
          `;
        }).join('');

        listContainer.innerHTML = commentsHtml;
        console.log('[è¯„è®ºå†å²] æ¸²æŸ“å®Œæˆ');

      } catch (error) {
        console.error('[è¯„è®ºå†å²] åŠ è½½å¤±è´¥:', error);
        listContainer.innerHTML = `<p style="text-align: center; color: #ff4d4f; padding: 40px 20px;">åŠ è½½å¤±è´¥: ${error.message}<br/>è¯·æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯</p>`;
      }
    }

    // æ ¼å¼åŒ–è¯„è®ºæ—¶é—´
    function formatCommentTime(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 1) return 'åˆšåˆš';
      if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
      if (hours < 24) return `${hours}å°æ—¶å‰`;
      if (days < 7) return `${days}å¤©å‰`;

      const date = new Date(timestamp);
      return `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
    }

    // é€‰æ‹©è¯„è®º - åœ¨å³ä¾§æ˜¾ç¤ºè¯„è®ºå’Œè®¨è®ºåˆ—è¡¨
    function selectComment(commentId) {
      selectedCommentId = commentId;
      const comment = allComments.find(c => c.id === commentId);

      if (!comment) return;

      // é‡æ–°æ¸²æŸ“è¯„è®ºåˆ—è¡¨ä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€
      loadCommentHistory(currentSelectedChannel.id, currentSelectedTopic.id);

      // æ›´æ–°è®¨è®ºåŒºæ ‡é¢˜
      const hintText = comment.replies.length > 0
        ? `æ­£åœ¨æŸ¥çœ‹"${comment.fromName}"çš„è¯„è®º Â· ${comment.replies.length}æ¡è®¨è®º`
        : `æ­£åœ¨æŸ¥çœ‹"${comment.fromName}"çš„è¯„è®º Â· æš‚æ— è®¨è®º`;
      document.getElementById('discussionHint').innerHTML = `
        <span style="display: inline-block; padding: 2px 8px; background: #f6ffed; color: #52c41a; border-radius: 4px; margin-right: 6px;">2çº§è®¨è®º</span>
        ${hintText}
      `;

      // åœ¨å³ä¾§æ˜¾ç¤ºå†…å®¹
      const selectedArea = document.getElementById('selectedCommentArea');

      // è·å–1çº§è¯„è®ºçš„å‘è¡¨æ—¶é—´
      const commentTime = new Date(comment.timestamp).toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });

      // æ¸²æŸ“2çº§è®¨è®ºåˆ—è¡¨(æŒ‰æ—¶é—´å‡åº)
      const discussionsHtml = comment.replies.map((reply, index) => {
        const fullTime = new Date(reply.timestamp).toLocaleString('zh-CN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false
        });

        return `
          <div style="padding: 14px 20px; background: white; border-bottom: 1px solid #f0f0f0; transition: background 0.2s;"
               onmouseover="this.style.background='#f9f9f9'" onmouseout="this.style.background='white'">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <div style="width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%);
                          color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 13px;">
                ${reply.fromName.substring(0, 1)}
              </div>
              <span style="font-weight: 600; color: #333; font-size: 13px;">${reply.fromName}</span>
              <span style="font-size: 11px; color: #bbb;">Â·</span>
              <span style="font-size: 11px; color: #999;">${fullTime}</span>
            </div>
            <div style="color: #555; line-height: 1.7; font-size: 14px; padding-left: 36px;">${reply.content}</div>
          </div>
        `;
      }).join('');

      selectedArea.innerHTML = `
        <!-- é€‰ä¸­çš„è¯„è®º -->
        <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.08);">
          <!-- 1çº§è¯„è®º -->
          <div style="padding: 20px; background: linear-gradient(135deg, #e6f7ff 0%, #f0f8ff 100%); border-left: 4px solid #1890ff;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
              <div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #1890ff 0%, #40a9ff 100%);
                          color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px;">
                ${comment.fromName.substring(0, 1)}
              </div>
              <div>
                <div style="font-weight: 600; color: #333; font-size: 14px;">${comment.fromName}</div>
                <div style="font-size: 11px; color: #999;">${commentTime}</div>
              </div>
            </div>
            <div style="color: #333; line-height: 1.8; font-size: 15px; padding-left: 46px;">
              <strong style="color: #1890ff; font-size: 13px;">è¯„è®º:</strong>
              <div style="margin-top: 6px;">${comment.content}</div>
            </div>
          </div>

          ${comment.replies.length > 0 ? `
            <!-- è®¨è®ºåˆ—è¡¨ -->
            <div style="background: #fafafa;">
              <div style="padding: 12px 20px; background: #f5f5f5; border-top: 2px solid #e0e0e0; border-bottom: 1px solid #e0e0e0;">
                <div style="font-weight: 600; color: #52c41a; font-size: 14px;">
                  ğŸ’¬ è®¨è®ºåˆ—è¡¨ (${comment.replies.length})
                </div>
              </div>
              ${discussionsHtml}
            </div>
          ` : `
            <div style="padding: 40px 20px; text-align: center; background: #fafafa; border-top: 2px solid #e0e0e0; color: #999;">
              <p style="font-size: 36px; margin: 0 0 12px 0;">ğŸ’­</p>
              <p style="font-size: 13px; margin: 0; color: #999;">æš‚æ— è®¨è®º</p>
              <p style="font-size: 12px; margin: 8px 0 0 0; color: #bbb;">åœ¨ä¸‹æ–¹è¾“å…¥æ¡†å‘è¡¨ç¬¬ä¸€æ¡è®¨è®º</p>
            </div>
          `}
        </div>
      `;

      // æ˜¾ç¤ºè®¨è®ºå›å¤åŒºåŸŸ
      document.getElementById('discussionReplyArea').style.display = 'block';

      // æ»šåŠ¨åˆ°é¡¶éƒ¨
      selectedArea.scrollTop = 0;
    }

    // å…³é—­è¯„è®ºå†å²å¼¹çª—
    function closeCommentHistory() {
      document.getElementById('commentHistoryModal').style.display = 'none';
      currentCommentUser = null;
      selectedCommentId = null;
      allComments = [];
      discussionUsers = [];
    }

    // æäº¤æ–°çš„1çº§è¯„è®º
    async function submitNewComment() {
      const content = document.getElementById('newCommentInput').value.trim();

      if (!content) {
        showToast('è¯·è¾“å…¥è¯„è®ºå†…å®¹', 'warning');
        return;
      }

      if (!currentCommentUser || !currentSelectedChannel || !currentSelectedTopic) {
        showToast('ä¼šè¯ä¿¡æ¯ä¸å®Œæ•´', 'error');
        return;
      }

      try {
        // æ„å»ºæ¶ˆæ¯æ•°æ®(1çº§è¯„è®º,æ— parentId)
        const messageData = {
          channelId: currentSelectedChannel.id,
          topicId: currentSelectedTopic.id,
          content: content,
          fromUserId: currentCommentUser.id,
          fromUserName: currentCommentUser.name,
          messageType: 'comment',
          parentId: null // 1çº§è¯„è®º
        };

        // å‘é€æ¶ˆæ¯
        const messageRes = await fetch('/api/send-test-message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(messageData)
        });

        const result = await messageRes.json();

        if (result.success) {
          showToast(`âœ“ è¯„è®ºå‘è¡¨æˆåŠŸ`, 'success');

          // æ¸…ç©ºè¾“å…¥æ¡†
          document.getElementById('newCommentInput').value = '';

          // é‡æ–°åŠ è½½è¯„è®ºå†å²
          await loadCommentHistory(currentSelectedChannel.id, currentSelectedTopic.id);

          // åœ¨æ—¥å¿—ä¸­è®°å½•
          addMessageLog(currentSelectedChannel.id, currentSelectedTopic.id, content, currentCommentUser.name + ' (æ–°è¯„è®º)', false);

        } else {
          showToast('å‘é€å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }

      } catch (error) {
        console.error('æäº¤è¯„è®ºå¤±è´¥:', error);
        showToast('æäº¤è¯„è®ºå¤±è´¥: ' + error.message, 'error');
      }
    }

    // æäº¤è®¨è®º(2çº§è¯„è®º)
    async function submitDiscussion() {
      const content = document.getElementById('discussionInput').value.trim();
      const userIndex = document.getElementById('discussionUserSelect').value;

      if (!content) {
        showToast('è¯·è¾“å…¥è®¨è®ºå†…å®¹', 'warning');
        return;
      }

      if (userIndex === '') {
        showToast('è¯·é€‰æ‹©å‘è¨€ç”¨æˆ·', 'warning');
        return;
      }

      if (!selectedCommentId) {
        showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¯„è®º', 'error');
        return;
      }

      if (!currentSelectedChannel || !currentSelectedTopic) {
        showToast('ä¼šè¯ä¿¡æ¯ä¸å®Œæ•´', 'error');
        return;
      }

      try {
        const user = discussionUsers[parseInt(userIndex)];

        // æ„å»ºæ¶ˆæ¯æ•°æ®(2çº§è¯„è®º,æœ‰parentId)
        const messageData = {
          channelId: currentSelectedChannel.id,
          topicId: currentSelectedTopic.id,
          content: content,
          fromUserId: user.id,
          fromUserName: user.name,
          messageType: 'comment',
          parentId: selectedCommentId // 2çº§è¯„è®º,å…³è”åˆ°é€‰ä¸­çš„1çº§è¯„è®º
        };

        // å‘é€æ¶ˆæ¯
        const messageRes = await fetch('/api/send-test-message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(messageData)
        });

        const result = await messageRes.json();

        if (result.success) {
          showToast(`âœ“ ${user.name} çš„è®¨è®ºå‘é€æˆåŠŸ`, 'success');

          // æ¸…ç©ºè¾“å…¥æ¡†
          document.getElementById('discussionInput').value = '';

          // é‡æ–°åŠ è½½è¯„è®ºå†å²
          await loadCommentHistory(currentSelectedChannel.id, currentSelectedTopic.id);

          // é‡æ–°é€‰ä¸­å½“å‰è¯„è®ºä»¥åˆ·æ–°å³ä¾§æ˜¾ç¤º
          setTimeout(() => {
            selectComment(selectedCommentId);
          }, 100);

          // åœ¨æ—¥å¿—ä¸­è®°å½•
          addMessageLog(currentSelectedChannel.id, currentSelectedTopic.id, content, user.name + ' (è®¨è®º)', false);

        } else {
          showToast('å‘é€å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }

      } catch (error) {
        console.error('æäº¤è®¨è®ºå¤±è´¥:', error);
        showToast('æäº¤è®¨è®ºå¤±è´¥: ' + error.message, 'error');
      }
    }

    // åŠ è½½è´¦æˆ·çš„ä½œå“åˆ°ä¸‹æ‹‰æ¡†
    async function loadChannelTopics() {
      const channelSelect = document.getElementById('targetChannel');
      const topicSelect = document.getElementById('targetTopic');
      const channelId = channelSelect.value;

      topicSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ä½œå“</option>';

      if (!channelId) {
        topicSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©è´¦æˆ·</option>';
        return;
      }

      try {
        const response = await fetch(`/api/channels/${channelId}/topics`);
        const data = await response.json();
        const topics = data.topics || [];

        if (topics.length === 0) {
          topicSelect.innerHTML = '<option value="">è¯¥è´¦æˆ·æš‚æ— ä½œå“</option>';
          return;
        }

        topicSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ä½œå“</option>' +
          topics.map(t => `<option value="${t.id}">${t.title}</option>`).join('');
      } catch (error) {
        console.error('åŠ è½½ä½œå“å¤±è´¥:', error);
        topicSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
      }
    }

    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
      const channelId = document.getElementById('targetChannel').value;
      const topicId = document.getElementById('targetTopic').value;
      const content = document.getElementById('messageContent').value.trim();

      if (!channelId) {
        showToast('è¯·é€‰æ‹©è´¦æˆ·', 'error');
        return;
      }

      if (!topicId) {
        showToast('è¯·é€‰æ‹©ä½œå“', 'error');
        return;
      }

      if (!content) {
        showToast('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'error');
        return;
      }

      try {
        const response = await fetch('/api/send-test-message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ channelId, topicId, content })
        });

        const data = await response.json();

        if (data.success) {
          messageCount++;
          document.getElementById('messageCount').textContent = messageCount;
          document.getElementById('messageContent').value = '';
          addMessageLog(channelId, topicId, content);
          showToast('æ¶ˆæ¯å‘é€æˆåŠŸï¼', 'success');
        } else {
          showToast('æ¶ˆæ¯å‘é€å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (error) {
        showToast('å‘é€å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æ·»åŠ æ¶ˆæ¯æ—¥å¿—
    function addMessageLog(channelId, topicId, content, fromName = null, isReply = false) {
      const logContainer = document.getElementById('messageLog');

      if (logContainer.querySelector('p')) {
        logContainer.innerHTML = '';
      }

      const time = new Date().toLocaleTimeString('zh-CN');
      const channelName = document.querySelector(`#targetChannel option[value="${channelId}"]`)?.textContent || channelId;
      const topicName = document.querySelector(`#targetTopic option[value="${topicId}"]`)?.textContent || topicId;

      const logEntry = document.createElement('div');
      logEntry.className = 'log-entry';
      const typeLabel = isReply ? 'ğŸ“¨ å›å¤æ¶ˆæ¯' : 'ğŸ“¤ å‘é€æ¶ˆæ¯';
      const fromLabel = fromName ? ` (æ¥è‡ª: ${fromName})` : '';
      logEntry.innerHTML = `
        <div class="time">${time} ${typeLabel}${fromLabel}</div>
        <div class="channel">é¢‘é“: ${channelName} / ä¸»é¢˜: ${topicName}</div>
        <div class="content">${content}</div>
      `;

      logContainer.insertBefore(logEntry, logContainer.firstChild);

      const entries = logContainer.querySelectorAll('.log-entry');
      if (entries.length > 20) {
        entries[entries.length - 1].remove();
      }
    }

    // åŠ è½½æœåŠ¡å™¨ç»Ÿè®¡ä¿¡æ¯
    async function loadStats() {
      try {
        const response = await fetch('/api/stats');
        const stats = await response.json();

        document.getElementById('monitorCount').textContent = stats.monitorClients;
        // channelCount å·²åœ¨ loadChannels ä¸­æ›´æ–°
      } catch (error) {
        console.error('[ç»Ÿè®¡] åŠ è½½å¤±è´¥:', error);
      }
    }

    // æµ‹è¯•ç”¨æˆ·æ•°æ®
    const testUsers = [
      { id: '10001', name: 'å¼ ä¸‰', ip: '192.168.1.100', avatar: 'å¼ ' },
      { id: '10002', name: 'æå››', ip: '192.168.1.101', avatar: 'æ' },
      { id: '10003', name: 'ç‹äº”', ip: '192.168.1.102', avatar: 'ç‹' },
      { id: '10004', name: 'èµµå…­', ip: '192.168.1.103', avatar: 'èµµ' },
      { id: '10005', name: 'é’±ä¸ƒ', ip: '192.168.1.104', avatar: 'é’±' }
    ];

    let selectedTestUser = null;

    // åˆå§‹åŒ–æµ‹è¯•ç”¨æˆ·åˆ—è¡¨
    function initTestUsers() {
      const container = document.getElementById('testUsers');
      container.innerHTML = testUsers.map((user, index) => `
        <div class="test-user-card" data-index="${index}" onclick="selectTestUser(${index})">
          <div class="test-user-avatar" style="background: ${getAvatarColor(index)};">
            ${user.avatar}
          </div>
          <div class="test-user-info">
            <div class="test-user-name">${user.name}</div>
            <div class="test-user-details">ID: ${user.id} | IP: ${user.ip}</div>
          </div>
          <div class="test-user-action" style="display: flex; gap: 6px;">
            <button class="btn btn-primary btn-small" onclick="startTestSession(${index}, event, 'comment')" title="åœ¨é€‰å®šçš„ä¸»é¢˜ä¸‹å‘è¡¨è¯„è®º">
              å¼€å§‹è¯„è®º
            </button>
            <button class="btn btn-success btn-small" onclick="startTestSession(${index}, event, 'private')" title="å‘é€ç§ä¿¡ç»™å®¢æœ">
              å¼€å§‹ç§ä¿¡
            </button>
          </div>
        </div>
      `).join('');
    }

    // è·å–å¤´åƒé¢œè‰²
    function getAvatarColor(index) {
      const colors = ['#1890ff', '#52c41a', '#faad14', '#f5222d', '#722ed1'];
      return colors[index % colors.length];
    }

    // é€‰æ‹©æµ‹è¯•ç”¨æˆ·
    function selectTestUser(index) {
      selectedTestUser = index;
      document.querySelectorAll('.test-user-card').forEach((card, i) => {
        card.classList.toggle('selected', i === index);
      });
    }

    // å¼€å§‹æµ‹è¯•ä¼šè¯
    async function startTestSession(userIndex, event, type = 'comment') {
      event.stopPropagation(); // é˜²æ­¢è§¦å‘å¡ç‰‡ç‚¹å‡»

      const user = testUsers[userIndex];

      // æ ¹æ®ç±»å‹æ˜¾ç¤ºä¸åŒçš„æç¤ºå’Œé»˜è®¤æ¶ˆæ¯
      let promptTitle, defaultMessage, channelId, topicId;

      if (type === 'comment') {
        // è¯„è®ºç±»å‹:éœ€è¦é€‰ä¸­è´¦æˆ·å’Œä½œå“
        if (!currentSelectedChannel || !currentSelectedTopic) {
          showToast('è¯·å…ˆåœ¨è´¦æˆ·åˆ—è¡¨ä¸­ç‚¹å‡»"é€‰æ‹©"æŒ‰é’®,é€‰æ‹©è´¦æˆ·å’Œä½œå“', 'warning');
          return;
        }

        // æ‰“å¼€è¯„è®ºå†å²å¼¹çª—
        await openCommentHistory(
          user,
          currentSelectedChannel.id,
          currentSelectedChannel.name,
          currentSelectedTopic.id,
          currentSelectedTopic.title
        );
        return;

      } else if (type === 'private') {
        // ç§ä¿¡ç±»å‹:ä¸éœ€è¦ä½œå“,ä½¿ç”¨ç‰¹æ®Šçš„ç§ä¿¡é¢‘é“
        channelId = 'private_messages';
        topicId = `private_${user.id}`;
        promptTitle = `${user.name} å‘é€ç§ä¿¡:\n\nè¯·è¾“å…¥ç§ä¿¡å†…å®¹:`;
        defaultMessage = `ä½ å¥½,æˆ‘æ˜¯${user.name},æœ‰äº‹æƒ…æƒ³ç§ä¸‹å’¨è¯¢`;
      }

      // å¼¹å‡ºè¾“å…¥æ¡†è·å–æ¶ˆæ¯å†…å®¹
      const message = prompt(promptTitle, defaultMessage);

      if (!message || message.trim() === '') {
        showToast('å·²å–æ¶ˆå‘é€', 'info');
        return;
      }

      try {
        // 1. åˆ›å»ºä¼šè¯
        const sessionRes = await fetch('/api/sessions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: user.id,
            userName: user.name,
            channelId: channelId,
            topicId: topicId,
            firstMessage: message.trim(),
            sessionType: type
          })
        });

        const sessionData = await sessionRes.json();

        if (!sessionData.success) {
          showToast('åˆ›å»ºä¼šè¯å¤±è´¥: ' + (sessionData.error || 'æœªçŸ¥é”™è¯¯'), 'error');
          return;
        }

        // 2. å‘é€æ¶ˆæ¯åˆ°å®¢æˆ·ç«¯
        const messageRes = await fetch('/api/send-test-message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            channelId: channelId,
            topicId: topicId,
            content: message.trim(),
            fromUserId: user.id,
            fromUserName: user.name,
            messageType: type
          })
        });

        const messageData = await messageRes.json();

        if (messageData.success) {
          const typeLabel = type === 'comment' ? 'è¯„è®º' : 'ç§ä¿¡';
          showToast(`âœ“ å·²ä¸º ${user.name} åˆ›å»º${typeLabel}ä¼šè¯å¹¶å‘é€æ¶ˆæ¯`, 'success');

          // åœ¨æ—¥å¿—ä¸­è®°å½•
          addMessageLog(channelId, topicId, message.trim(), user.name, false);

          // å¯é€‰:æ‰“å¼€ä¼šè¯çª—å£
          const params = new URLSearchParams({
            sessionId: sessionData.session.id,
            userId: user.id,
            userName: user.name,
            channelId: channelId,
            topicId: topicId,
            sessionType: type
          });

          if (type === 'comment') {
            params.append('channelName', currentSelectedChannel.name);
            params.append('topicTitle', currentSelectedTopic.title);
          } else {
            params.append('channelName', 'ç§ä¿¡');
            params.append('topicTitle', `ä¸${user.name}çš„ç§ä¿¡`);
          }

          window.open(`/sessions.html?${params.toString()}`, '_blank');
        } else {
          showToast('å‘é€æ¶ˆæ¯å¤±è´¥: ' + (messageData.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }

      } catch (error) {
        console.error('[æµ‹è¯•ä¼šè¯] å¤±è´¥:', error);
        showToast('åˆ›å»ºæµ‹è¯•ä¼šè¯å¤±è´¥: ' + error.message, 'error');
      }
    }

    // åˆå§‹åŒ–Socket.IOè¿æ¥
    function initSocketIO() {
      socket = io();

      socket.on('connect', () => {
        console.log('[Admin] Socket.IO å·²è¿æ¥');
        // æ³¨å†Œä¸ºç›‘æ§å®¢æˆ·ç«¯,ä»¥æ¥æ”¶æ‰€æœ‰æ¶ˆæ¯
        socket.emit('monitor:register', { clientType: 'admin' });
        // ç«‹å³åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        loadStats();
      });

      socket.on('disconnect', () => {
        console.log('[Admin] Socket.IO å·²æ–­å¼€');
      });

      // ç›‘å¬é¢‘é“æ¶ˆæ¯(åŒ…æ‹¬å›å¤æ¶ˆæ¯)
      socket.on('channel:message', (message) => {
        console.log('[Admin] æ”¶åˆ°æ¶ˆæ¯:', message);
        const isReply = message.fromId === 'monitor_client';
        addMessageLog(
          message.channelId,
          message.topicId,
          message.content,
          message.fromName,
          isReply
        );
      });
    }

    // åˆå§‹åŒ–
    window.addEventListener('load', () => {
      loadChannels();
      initTestUsers(); // åˆå§‹åŒ–æµ‹è¯•ç”¨æˆ·åˆ—è¡¨
      setInterval(loadChannels, 30000); // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
      initSocketIO(); // åˆå§‹åŒ–Socket.IOè¿æ¥
      setInterval(loadStats, 5000); // æ¯5ç§’åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯
    });

    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('DOMContentLoaded', () => {
      // Ctrl+Enter å‘é€æ¶ˆæ¯
      document.getElementById('messageContent').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.ctrlKey) {
          sendMessage();
        }
      });

      // ESC å…³é—­å¯¹è¯æ¡†
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeModal();
          closeTopicsModal();
          closeTopicFormModal();
        }
      });

      // ç‚¹å‡»å¯¹è¯æ¡†å¤–éƒ¨å…³é—­
      document.getElementById('channelModal').addEventListener('click', (e) => {
        if (e.target.id === 'channelModal') {
          closeModal();
        }
      });

      // ç‚¹å‡»ä¸»é¢˜ç®¡ç†æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
      document.getElementById('topicsModal').addEventListener('click', (e) => {
        if (e.target.id === 'topicsModal') {
          closeTopicsModal();
        }
      });

      // ç‚¹å‡»ä¸»é¢˜è¡¨å•æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
      document.getElementById('topicFormModal').addEventListener('click', (e) => {
        if (e.target.id === 'topicFormModal') {
          closeTopicFormModal();
        }
      });

      // æ–°è¯„è®ºè¾“å…¥æ¡† Ctrl+Enter å¿«æ·é”®
      document.getElementById('newCommentInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.ctrlKey) {
          e.preventDefault();
          submitNewComment();
        }
      });

      // è®¨è®ºè¾“å…¥æ¡† Ctrl+Enter å¿«æ·é”®
      document.getElementById('discussionInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.ctrlKey) {
          e.preventDefault();
          submitDiscussion();
        }
      });

      // ç‚¹å‡»è¯„è®ºå¼¹çª—å¤–éƒ¨å…³é—­
      document.getElementById('commentHistoryModal').addEventListener('click', (e) => {
        if (e.target.id === 'commentHistoryModal') {
          closeCommentHistory();
        }
      });
    });
  </script>
</body>
</html>
