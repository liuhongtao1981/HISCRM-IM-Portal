# CRM PC IM æ‰“åŒ…è¯´æ˜

## é—®é¢˜è¯Šæ–­

å¦‚æœæ‰“åŒ…åçš„åº”ç”¨æ— æ³•è¿æ¥åˆ°æœåŠ¡ç«¯ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ’æŸ¥ï¼š

### 1. é‡æ–°æ„å»ºåº”ç”¨

```bash
cd packages/crm-pc-im

# æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶
rm -rf dist dist-electron release

# é‡æ–°æ„å»ºï¼ˆWindows ä½¿ç”¨ PowerShellï¼‰
npm run build
npm run build:electron
npm run electron:build
```

### 2. æ£€æŸ¥é…ç½®æ–‡ä»¶

ç¡®è®¤ `config.json` å·²è¢«å¤åˆ¶åˆ° `dist/` ç›®å½•ï¼š

```bash
# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls dist/config.json

# æŸ¥çœ‹å†…å®¹
cat dist/config.json
```

åº”è¯¥çœ‹åˆ°ï¼š
```json
{
  "websocket": {
    "url": "http://localhost:3000",
    ...
  }
}
```

### 3. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—

æ‰“åŒ…åçš„åº”ç”¨ä¼šåœ¨å¯åŠ¨æ—¶è¾“å‡ºè¯¦ç»†çš„è¿æ¥æ—¥å¿—ï¼š

```
[WebSocket] é…ç½®ä¿¡æ¯: {
  connectionUrl: "http://localhost:3000",
  fullUrl: "http://localhost:3000/client",
  config: { url: "http://localhost:3000", ... }
}
[WebSocket] âœ… å·²æˆåŠŸè¿æ¥åˆ°æœåŠ¡å™¨: http://localhost:3000/client
```

å¦‚æœçœ‹åˆ°è¿æ¥é”™è¯¯ï¼š
```
[WebSocket] âŒ è¿æ¥é”™è¯¯: connect ECONNREFUSED 127.0.0.1:3000
```

è¯´æ˜ Master æœåŠ¡å™¨æœªå¯åŠ¨æˆ–ç«¯å£ä¸æ­£ç¡®ã€‚

### 4. ç¡®è®¤æœåŠ¡å™¨è¿è¡Œ

æ‰“åŒ…åçš„åº”ç”¨éœ€è¦è¿æ¥åˆ° Master æœåŠ¡å™¨ï¼š

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•å¯åŠ¨ Master æœåŠ¡å™¨
npm run start:master

# æˆ–åŒæ—¶å¯åŠ¨æ‰€æœ‰æœåŠ¡
npm run dev
```

ç¡®è®¤ Master æœåŠ¡å™¨åœ¨ç«¯å£ 3000 è¿è¡Œï¼š
```
ğŸš€ Master Server started on port 3000
```

### 5. ç½‘ç»œé…ç½®

å¦‚æœéœ€è¦è¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨ï¼Œä¿®æ”¹ `config.json`ï¼š

```json
{
  "websocket": {
    "url": "http://your-server-ip:3000",
    ...
  }
}
```

ç„¶åé‡æ–°æ„å»ºã€‚

## å¼€å‘ç¯å¢ƒ vs ç”Ÿäº§ç¯å¢ƒ

### å¼€å‘ç¯å¢ƒï¼ˆ`npm run electron:dev`ï¼‰

- Vite å¼€å‘æœåŠ¡å™¨è¿è¡Œåœ¨ `http://localhost:5173`
- Electron åŠ è½½å¼€å‘æœåŠ¡å™¨
- çƒ­é‡è½½æ”¯æŒ
- è‡ªåŠ¨æ‰“å¼€å¼€å‘è€…å·¥å…·

### ç”Ÿäº§ç¯å¢ƒï¼ˆæ‰“åŒ…åçš„ .exeï¼‰

- åŠ è½½ `dist/` ç›®å½•çš„é™æ€æ–‡ä»¶
- éœ€è¦æ‰‹åŠ¨å¯åŠ¨ Master æœåŠ¡å™¨
- æ— çƒ­é‡è½½
- éœ€è¦æŒ‰ `F12` æˆ–åœ¨èœå•ä¸­æ‰“å¼€å¼€å‘è€…å·¥å…·

## å¸¸è§é—®é¢˜

### Q1: æ‰“åŒ…åç™½å±

**åŸå› **ï¼š`dist/` ç›®å½•ä¸å­˜åœ¨æˆ–å†…å®¹ä¸å®Œæ•´

**è§£å†³**ï¼š
```bash
npm run build  # ç¡®ä¿å…ˆæ„å»ºå‰ç«¯
npm run electron:build  # å†æ„å»º Electron
```

### Q2: è¿æ¥å¤±è´¥

**åŸå› **ï¼š
1. Master æœåŠ¡å™¨æœªè¿è¡Œ
2. `config.json` æœªè¢«å¤åˆ¶åˆ° `dist/`
3. é˜²ç«å¢™é˜»æ­¢è¿æ¥

**è§£å†³**ï¼š
1. å¯åŠ¨ Master: `npm run start:master`
2. æ£€æŸ¥ `dist/config.json` æ˜¯å¦å­˜åœ¨
3. å…³é—­é˜²ç«å¢™æµ‹è¯•æˆ–æ·»åŠ ä¾‹å¤–

### Q3: æ— æ³•è¯»å– config.json

**åŸå› **ï¼šæ„å»ºæ—¶ config.json æœªè¢«å¤åˆ¶

**è§£å†³**ï¼šæ£€æŸ¥ `vite.config.ts` ä¸­çš„ `copyConfigPlugin` æ’ä»¶æ˜¯å¦æ­£ç¡®é…ç½®

### Q4: å¼€å‘ç‰ˆå¯ä»¥è¿æ¥ï¼Œæ‰“åŒ…ç‰ˆä¸è¡Œ

**åŸå› **ï¼šå¼€å‘ç‰ˆä½¿ç”¨çš„æ˜¯ç¡¬ç¼–ç çš„ `localhost:3000`ï¼Œæ‰“åŒ…ç‰ˆä¾èµ– `config.json`

**è§£å†³**ï¼š
1. ç¡®ä¿ `config.json` åœ¨ `dist/` ç›®å½•
2. æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ä¸­çš„é…ç½®ä¿¡æ¯
3. ä½¿ç”¨ç›¸åŒçš„é…ç½®é‡æ–°æ‰“åŒ…

## è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹åº”ç”¨æ—¥å¿—

Windows:
- æŒ‰ `F12` æ‰“å¼€å¼€å‘è€…å·¥å…·
- æŸ¥çœ‹ Console é€‰é¡¹å¡

### 2. æ£€æŸ¥ç½‘ç»œè¿æ¥

åœ¨å¼€å‘è€…å·¥å…·çš„ Network é€‰é¡¹å¡ä¸­ï¼š
- æŸ¥æ‰¾ `socket.io` è¯·æ±‚
- æ£€æŸ¥çŠ¶æ€ç ï¼ˆåº”è¯¥æ˜¯ 101 Switching Protocolsï¼‰

### 3. éªŒè¯ Master ç«¯ç‚¹

ä½¿ç”¨æµè§ˆå™¨è®¿é—®ï¼š
```
http://localhost:3000/socket.io/socket.io.js
```

åº”è¯¥è¿”å› JavaScript æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ 404ã€‚

## æ„å»ºæ¸…å•

æ‰“åŒ…å‰ç¡®è®¤ï¼š

- [ ] `config.json` å­˜åœ¨ä¸”é…ç½®æ­£ç¡®
- [ ] `npm run build` æˆåŠŸï¼Œ`dist/` ç›®å½•åŒ…å«å®Œæ•´æ–‡ä»¶
- [ ] `npm run build:electron` æˆåŠŸï¼Œ`dist-electron/` åŒ…å« main.js
- [ ] `dist/config.json` å­˜åœ¨
- [ ] Master æœåŠ¡å™¨å¯è®¿é—®
- [ ] é˜²ç«å¢™å…è®¸ç«¯å£ 3000

## æ¶æ„è¯´æ˜

```
CRM PC IM (Electron)
    â†“ WebSocket (æ ¹å‘½åç©ºé—´)
http://localhost:3000
    â†“
Master æœåŠ¡å™¨ (IM WebSocket Server)
    ç›‘å¬äº‹ä»¶: monitor:register, monitor:channels, monitor:topics ç­‰
    â†“
Worker è¿›ç¨‹ (æŠ–éŸ³çˆ¬è™«ç­‰)
```

**é‡è¦**ï¼šMaster æœåŠ¡å™¨æœ‰ä¸¤ä¸ª WebSocket ç³»ç»Ÿï¼š
1. **IM WebSocket Server**ï¼ˆæ ¹å‘½åç©ºé—´ï¼‰- ç”¨äº PC/ç§»åŠ¨ç«¯å®¢æˆ·ç«¯
2. **Socket.IO Namespaces**ï¼ˆ/admin, /worker, /clientï¼‰- ç”¨äº Admin Web å’Œ Worker è¿›ç¨‹

CRM PC IM å®¢æˆ·ç«¯è¿æ¥åˆ° **IM WebSocket Server**ï¼ˆæ ¹å‘½åç©ºé—´ï¼‰ï¼Œä¸æ˜¯ `/client` namespaceã€‚

é…ç½®æ–‡ä»¶ä½ç½®ï¼š
- æºæ–‡ä»¶ï¼š`packages/crm-pc-im/config.json`
- å¼€å‘ç¯å¢ƒï¼šç›´æ¥ä½¿ç”¨æºæ–‡ä»¶
- ç”Ÿäº§ç¯å¢ƒï¼šå¤åˆ¶åˆ° `dist/config.json`ï¼ˆç”± Vite æ’ä»¶è‡ªåŠ¨å®Œæˆï¼‰

---

**æœ€åæ›´æ–°**: 2025-11-17
