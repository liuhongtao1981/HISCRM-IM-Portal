# 浏览器控制台测试消息提取

**目的**: 在浏览器控制台直接测试消息提取逻辑，绕过 Playwright

---

## 步骤 1: 打开抖音私信页面

1. 打开浏览器（使用登录的账户）
2. 导航到: https://creator.douyin.com/creator-micro/data/following/chat
3. 点击任意一个会话

---

## 步骤 2: 打开开发者工具

按 F12 打开开发者工具，切换到 Console 面板

---

## 步骤 3: 粘贴并运行测试代码

```javascript
// 测试 1: 检查选择器匹配的元素
console.log('=== 测试 1: 检查选择器 ===');
const allElements = document.querySelectorAll('[class*="message"], [class*="item"], [role*="article"]');
console.log('匹配元素数量:', allElements.length);

// 测试 2: 检查有 React Fiber 的元素
console.log('\n=== 测试 2: 检查 React Fiber ===');
let elementsWithFiber = 0;
allElements.forEach((el, i) => {
  const hasFiber = Object.keys(el).some(key => key.startsWith('__react'));
  if (hasFiber) elementsWithFiber++;
});
console.log('有 Fiber 的元素:', elementsWithFiber);

// 测试 3: 尝试提取消息
console.log('\n=== 测试 3: 尝试提取消息 ===');
const messages = [];

allElements.forEach((element, index) => {
  const fiberKey = Object.keys(element).find(key => key.startsWith('__react'));
  if (!fiberKey) return;

  let current = element[fiberKey];
  let depth = 0;
  let found = false;

  // 向上遍历
  while (current && depth < 20 && !found) {
    if (current.memoizedProps) {
      const props = current.memoizedProps;

      if (props.conversationId || props.serverId || props.content || props.message) {
        const msgContent = props.content || {};
        const textContent = msgContent.text || '';

        if (textContent || props.messageId || props.serverId) {
          console.log(`元素 ${index}, 深度 ${depth}:`, {
            conversationId: props.conversationId,
            serverId: props.serverId,
            text: textContent.substring(0, 50)
          });

          messages.push({
            serverId: props.serverId,
            text: textContent,
            isFromMe: props.isFromMe
          });

          found = true;
        }
      }
    }

    current = current.return;
    depth++;
  }
});

console.log('\n=== 最终结果 ===');
console.log('提取消息数:', messages.length);
console.log('前 5 条消息:', messages.slice(0, 5));
```

---

## 预期结果

### 如果成功

```
匹配元素数量: 30+
有 Fiber 的元素: 30+
元素 0, 深度 2: { conversationId: "...", serverId: "...", text: "..." }
...
提取消息数: 4+
```

### 如果失败

如果提取消息数为 0，检查：
1. 是否找到了元素？
2. 元素是否有 React Fiber？
3. Fiber 树的哪个深度有数据？

---

## 调试变种

### 如果向上遍历没找到，尝试向下遍历

```javascript
// 改用 current.child
while (current && depth < 20 && !found) {
  // ... 同样的检查逻辑
  current = current.child;  // ← 改成向下遍历
  depth++;
}
```

### 如果仍然没找到，尝试扩大搜索范围

```javascript
// 向上和向下都搜索
while (current && depth < 20) {
  if (current.memoizedProps) {
    const props = current.memoizedProps;
    console.log(`深度 ${depth}:`, Object.keys(props));  // 打印所有 props 键
  }

  current = current.return;
  depth++;
}
```

---

## 根据结果的下一步

| 情况 | 下一步 |
|------|--------|
| 成功提取到消息 | 检查 Playwright 代码为什么没有提取到 |
| 元素数量为 0 | 检查选择器或页面状态 |
| 有元素但无 Fiber | 检查页面是否是 React 应用 |
| 有 Fiber 但无数据 | 调整遍历方向或深度 |
