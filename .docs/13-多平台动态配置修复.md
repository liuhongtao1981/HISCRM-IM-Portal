# 多平台动态配置修复

## 🔧 问题发现

下拉列表只显示抖音，不显示小红书，即使小红书的目录和文件都已存在。

## ✅ 原因分析

Master 的 `/api/v1/platforms` 端点查找平台的优先级有问题：

**修改前**:
1. 查询数据库中的账户 (可能为空)
2. 查询 Worker 注册信息 (Worker 可能还未启动)
3. 返回硬编码的默认列表 (只有两个平台)

**问题**: 如果数据库为空且 Worker 未启动，API 无法发现文件系统中已存在的平台！

## ✨ 解决方案

添加**文件系统扫描**作为第三个数据源，确保已创建的平台目录总是被发现。

**修改后的优先级**:
1. ✅ 查询数据库中的账户
2. ✅ 查询 Worker 注册信息
3. ✅ **扫描文件系统中的平台目录** (新增)
4. ✅ 返回默认列表

### 具体改进

**新增函数**: `scanAvailablePlatforms()`

```javascript
/**
 * 从文件系统扫描所有可用的平台
 * 扫描 packages/worker/src/platforms 目录
 * 查找每个平台的 config.json 文件
 * 用于在数据库为空时的备选方案
 */
function scanAvailablePlatforms() {
  // 1. 遍历 platforms 目录
  // 2. 跳过 base 目录
  // 3. 读取每个平台的 config.json
  // 4. 返回已发现的平台列表
}
```

**调用位置**: GET `/api/v1/platforms` 路由处理器

```javascript
// 1. 先查询数据库
const accountPlatforms = db.prepare(`...`).all();

// 2. 再查询 Worker
const workers = getWorkerRegistry().getAll();

// 3. 扫描文件系统 (新增)
const fsPlatforms = scanAvailablePlatforms();

// 4. 合并结果 (如果有重复，优先使用前面来源的数据)
```

## 📊 效果对比

### 修改前

| 场景 | 结果 |
|------|------|
| 首次运行，DB为空，Worker未启动 | ❌ 只显示硬编码的2个平台 |
| 只有小红书有账户 | ✅ 显示小红书 |
| 新增平台但还未创建账户 | ❌ 新平台不显示 |

### 修改后

| 场景 | 结果 |
|------|------|
| 首次运行，DB为空，Worker未启动 | ✅ 显示所有已创建的平台 |
| 只有小红书有账户 | ✅ 显示小红书 |
| 新增平台但还未创建账户 | ✅ 新平台显示 (来自文件系统扫描) |

## 🚀 测试验证

### 1. 重启 Master 服务

```bash
cd packages/master
npm start
```

### 2. 测试 API 端点

```bash
# 应该显示抖音 + 小红书
curl http://localhost:3000/api/v1/platforms

# 响应应该包含：
{
  "data": [
    { "value": "douyin", "label": "抖音", ... },
    { "value": "xiaohongshu", "label": "小红书", ... }
  ]
}
```

### 3. 刷新 Admin Web

打开 http://localhost:3001/accounts，平台下拉框应该显示：
- ✅ 抖音
- ✅ 小红书

## 📝 修改文件清单

| 文件 | 改动 |
|------|------|
| `packages/master/src/api/routes/platforms.js` | +60 行 (新增文件系统扫描) |

## 🎯 关键改进点

1. **更智能的平台发现**
   - 不再依赖硬编码的默认列表
   - 动态扫描实际存在的平台

2. **更好的容错能力**
   - DB 为空也能发现平台
   - Worker 未启动也能发现平台
   - 多个备选数据源

3. **完全向后兼容**
   - 现有逻辑不变
   - 只是增加了额外的发现渠道

4. **性能不受影响**
   - 文件系统扫描只在需要时执行
   - 有三个数据源时提前返回

## 💡 其他改进建议 (可选)

1. **缓存扫描结果**
   - 避免每次请求都扫描文件系统
   - 在 Worker 启动时初始化缓存

2. **实时监听**
   - 监听文件系统变化
   - 新增平台自动更新

3. **配置验证**
   - 检查 config.json 格式
   - 验证必要字段

---

**修复日期**: 2025-10-20
**问题**: 小红书平台未在下拉列表中显示
**状态**: ✅ 已修复

下次启动 Master 时，下拉列表会正确显示所有已创建的平台！
