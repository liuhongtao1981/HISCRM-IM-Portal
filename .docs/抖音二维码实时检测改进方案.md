# æŠ–éŸ³äºŒç»´ç å®æ—¶æ£€æµ‹æ”¹è¿›æ–¹æ¡ˆ

**çŠ¶æ€**: è®¾è®¡æ–¹æ¡ˆ
**ä¼˜å…ˆçº§**: é«˜
**ç›®æ ‡**: ä»è¢«åŠ¨ç­‰å¾…æ—¶é—´ â†’ ä¸»åŠ¨æ£€æµ‹äºŒç»´ç å˜åŒ–

---

## é—®é¢˜åˆ†æ

### å½“å‰å®ç°çš„ç¼ºé™·

**æœºåˆ¶**: è¢«åŠ¨ç­‰å¾…æ—¶é—´
```
äºŒç»´ç ç”Ÿæˆ â†’ ç­‰å¾…150ç§’ â†’ åˆ¤æ–­è¿‡æœŸ â†’ åˆ·æ–°äºŒç»´ç 
```

**é—®é¢˜**:
1. âŒ å½“æŠ–éŸ³æ”¹å˜åˆ·æ–°ç­–ç•¥æ—¶ï¼Œç³»ç»Ÿæ— æ³•é€‚åº”
2. âŒ å³ä½¿äºŒç»´ç å·²ç»å˜åŒ–ï¼Œç³»ç»Ÿä»ç­‰å¾…150ç§’æ‰åˆ·æ–°
3. âŒ ç”¨æˆ·å¯èƒ½çœ‹åˆ°å·²è¿‡æœŸçš„äºŒç»´ç ï¼Œæ— æ³•æ‰«æ
4. âŒ æµªè´¹150ç§’çš„å®è´µç™»å½•æ—¶é—´

### ç†æƒ³å®ç°

**æœºåˆ¶**: ä¸»åŠ¨æ£€æµ‹å˜åŒ–
```
äºŒç»´ç ç”Ÿæˆ â†’ ç›‘å¬DOMå˜åŒ– â†’ æ£€æµ‹åˆ°å˜åŒ– â†’ ç«‹å³å‘é€åˆ°å®¢æˆ·ç«¯
```

**ä¼˜åŠ¿**:
1. âœ… å®æ—¶å“åº”æŠ–éŸ³äºŒç»´ç å˜åŒ–
2. âœ… ä¸ä¾èµ–ç¡¬ç¼–ç çš„æ—¶é—´é—´éš”
3. âœ… å®¢æˆ·ç«¯å§‹ç»ˆè·å¾—æœ€æ–°çš„äºŒç»´ç 
4. âœ… é€‚åº”æŠ–éŸ³ä»»ä½•åˆ·æ–°ç­–ç•¥çš„æ”¹å˜

---

## æ”¹è¿›æ–¹æ¡ˆè®¾è®¡

### æ–¹æ¡ˆ1: MutationObserver ç›‘å¬DOMå˜åŒ–ï¼ˆæ¨èï¼‰

#### æ ¸å¿ƒæ€è·¯
åœ¨é¡µé¢åŠ è½½åç«‹å³å¯åŠ¨ `MutationObserver`ï¼Œç›‘å¬äºŒç»´ç å…ƒç´ çš„å˜åŒ–ï¼š
- å±æ€§å˜åŒ–ï¼ˆ`src`ã€`data` ç­‰ï¼‰
- DOMæ ‘å˜åŒ–ï¼ˆå…ƒç´ è¢«æ›¿æ¢ï¼‰
- æ ·å¼å˜åŒ–

#### å®ç°ä»£ç 

**æ–‡ä»¶**: `packages/worker/src/browser/douyin-login-handler.js`

```javascript
/**
 * å¯åŠ¨äºŒç»´ç å˜åŒ–ç›‘å¬å™¨ï¼ˆå®æ—¶æ£€æµ‹ï¼‰
 * æ›¿ä»£ä¹‹å‰çš„æ—¶é—´é—´éš”æ£€æµ‹
 */
async setupQRCodeChangeListener(page, accountId, sessionId) {
  try {
    logger.info(`Setting up QR code change listener for session ${sessionId}`);

    // åœ¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­å¯åŠ¨ç›‘å¬
    await page.evaluateHandle(({ accountId, sessionId }) => {
      // è·å–äºŒç»´ç å…ƒç´ 
      const getQRElement = () => {
        const selectors = [
          'img[alt="äºŒç»´ç "]',
          'img[aria-label="äºŒç»´ç "]',
          'img[src^="data:image/png"]',
          '.qrcode',
          'canvas[class*="qr"]',
          'img[class*="qr"]',
        ];

        for (const selector of selectors) {
          const el = document.querySelector(selector);
          if (el) return el;
        }
        return null;
      };

      const qrElement = getQRElement();
      if (!qrElement) {
        console.error('QR code element not found for monitoring');
        return;
      }

      // è®°å½•åˆå§‹äºŒç»´ç çš„hashå€¼ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦çœŸçš„å˜åŒ–äº†ï¼‰
      let lastQRHash = null;

      // ç”ŸæˆäºŒç»´ç å›¾ç‰‡çš„hashå€¼ï¼ˆç®€å•æ–¹æ³•ï¼‰
      const getQRHash = async (element) => {
        if (element.tagName === 'IMG') {
          // å¯¹äºimgæ ‡ç­¾ï¼Œä½¿ç”¨srcä½œä¸ºæ ‡è¯†
          return element.src;
        } else if (element.tagName === 'CANVAS') {
          // å¯¹äºcanvasï¼Œæå–å›¾ç‰‡æ•°æ®
          const canvas = element;
          return canvas.toDataURL().substring(0, 100); // å–å‰100å­—ç¬¦ä½œä¸ºç®€å•hash
        }
        return null;
      };

      // ç›‘å¬äºŒç»´ç å…ƒç´ å±æ€§å˜åŒ–
      const qrObserver = new MutationObserver(async (mutations) => {
        let qrChanged = false;

        for (const mutation of mutations) {
          // æ£€æŸ¥æ˜¯å¦æ˜¯äºŒç»´ç å…ƒç´ æœ¬èº«çš„å˜åŒ–
          if (mutation.target === qrElement) {
            if (mutation.type === 'attributes') {
              const attrName = mutation.attributeName;
              // å…³é”®å±æ€§å˜åŒ–ï¼šsrc, data, styleç­‰
              if (['src', 'data', 'style'].includes(attrName)) {
                const currentHash = await getQRHash(qrElement);
                if (currentHash && currentHash !== lastQRHash) {
                  qrChanged = true;
                  lastQRHash = currentHash;
                  console.log(`âœ… QR Code Changed! New hash: ${currentHash?.substring(0, 50)}...`);
                  break;
                }
              }
            }
          }

          // æ£€æŸ¥æ˜¯å¦æ˜¯å…ƒç´ è¢«æ›¿æ¢
          if (mutation.type === 'childList') {
            for (const addedNode of mutation.addedNodes) {
              if (addedNode === qrElement || addedNode.contains?.(qrElement)) {
                qrChanged = true;
                console.log('âœ… QR Code Element Replaced!');
                break;
              }
            }
          }
        }

        // äºŒç»´ç å˜åŒ–æ—¶ï¼Œå‘é€ä¿¡å·ç»™Worker
        if (qrChanged) {
          // å‘é€è‡ªå®šä¹‰äº‹ä»¶åˆ°windowå¯¹è±¡
          window.dispatchEvent(new CustomEvent('qrCodeChanged', {
            detail: {
              timestamp: Date.now(),
              accountId,
              sessionId,
            }
          }));
        }
      });

      // å¯åŠ¨ç›‘å¬ï¼ˆç›‘å¬æ•´ä¸ªloginå®¹å™¨åŠå…¶æ‰€æœ‰å­èŠ‚ç‚¹ï¼‰
      const container = document.querySelector('[class*="login"]') || document.body;
      qrObserver.observe(container, {
        attributes: true,           // ç›‘å¬å±æ€§å˜åŒ–
        attributeFilter: ['src', 'data', 'style', 'class'],
        childList: true,            // ç›‘å¬DOMæ ‘å˜åŒ–
        subtree: true,              // ç›‘å¬å­èŠ‚ç‚¹
        characterData: false,
        attributeOldValue: true,
      });

      console.log('âœ… QR Code change listener started');

      // ä¿å­˜observeråˆ°windowå¯¹è±¡ä»¥ä¾¿åç»­æ¸…ç†
      window._qrObserver = qrObserver;

    }, { accountId, sessionId });

    // åœ¨Workerä¸­ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶
    page.on('console', async (msg) => {
      const text = msg.text();
      if (text.includes('QR Code Changed')) {
        logger.info(`ğŸ”„ QR Code change detected! Refreshing for session ${sessionId}`);

        // ç«‹å³æå–æ–°äºŒç»´ç 
        try {
          const newQRCode = await this.extractQRCode(page, accountId, sessionId);
          logger.info(`âœ… New QR code extracted and sent to client`);
        } catch (error) {
          logger.error('Failed to extract new QR code:', error);
        }
      }
    });

  } catch (error) {
    logger.error('Failed to setup QR code change listener:', error);
  }
}

/**
 * æ¸…ç†äºŒç»´ç ç›‘å¬å™¨
 */
async cleanupQRCodeListener(page) {
  try {
    await page.evaluate(() => {
      if (window._qrObserver) {
        window._qrObserver.disconnect();
        console.log('QR code observer cleaned up');
      }
    });
  } catch (error) {
    logger.warn('Failed to cleanup QR observer:', error);
  }
}
```

### ä½¿ç”¨æ–¹å¼

ä¿®æ”¹ `startLogin()` æ–¹æ³•ï¼š

```javascript
// åœ¨æå–QRç åç«‹å³å¯åŠ¨ç›‘å¬
const qrCodeData = await this.retryStrategies.elementSearch.retry(
  async () => await this.extractQRCode(page, accountId, sessionId),
  { context: 'QR code extraction' }
);

// æ–°å¢ï¼šå¯åŠ¨å®æ—¶ç›‘å¬å™¨
await this.setupQRCodeChangeListener(page, accountId, sessionId);

// ä¸å†ä¾èµ–å›ºå®šçš„150ç§’æ—¶é—´é—´éš”
session.status = 'scanning';
```

---

## æ–¹æ¡ˆ2: Polling è½®è¯¢ + Hashæ¯”å¯¹ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰

å¦‚æœMutationObserveråœ¨æŸäº›æƒ…å†µä¸‹ä¸å¯é ï¼Œå¯ä»¥ä½¿ç”¨é«˜é¢‘è½®è¯¢ï¼š

```javascript
/**
 * ä½¿ç”¨è½®è¯¢æ£€æµ‹äºŒç»´ç å˜åŒ–ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰
 * æ£€æµ‹é¢‘ç‡ï¼šæ¯1ç§’æ£€æŸ¥ä¸€æ¬¡ï¼ˆè€Œé150ç§’ï¼‰
 */
async setupQRCodePolling(page, accountId, sessionId) {
  const pollInterval = setInterval(async () => {
    try {
      const currentQR = await page.evaluate(() => {
        const img = document.querySelector('img[alt="äºŒç»´ç "]');
        return img?.src || img?.getAttribute('data-src') || null;
      });

      if (currentQR && currentQR !== this.lastQRCode) {
        logger.info(`ğŸ”„ QR Code changed via polling`);
        this.lastQRCode = currentQR;

        // ç«‹å³æå–æ–°äºŒç»´ç 
        const newQRCode = await this.extractQRCode(page, accountId, sessionId);

        // æ›´æ–°æ—¶é—´æˆ³ï¼Œä¸å†ä¾èµ–å›ºå®šé—´éš”
        const session = this.loginSessions.get(accountId);
        if (session) {
          session.qrCodeGeneratedAt = Date.now();
          session.qrCodeRefreshCount++;
        }
      }
    } catch (error) {
      logger.error('Error in QR code polling:', error);
    }
  }, 1000); // æ¯1ç§’æ£€æŸ¥ä¸€æ¬¡

  const session = this.loginSessions.get(accountId);
  if (session) {
    session.qrCodePollInterval = pollInterval;
  }
}
```

---

## æ–¹æ¡ˆ3: ç½‘ç»œè¯·æ±‚æ‹¦æˆªï¼ˆé«˜çº§æ–¹æ¡ˆï¼‰

ç›‘å¬æŠ–éŸ³APIè¯·æ±‚ï¼Œæ£€æµ‹ä½•æ—¶å‘å‡ºæ–°çš„äºŒç»´ç ï¼š

```javascript
/**
 * æ‹¦æˆªäºŒç»´ç APIè¯·æ±‚
 */
async setupQRCodeAPIInterception(page, accountId, sessionId) {
  page.on('response', async (response) => {
    const url = response.url();

    // ç›‘å¬äºŒç»´ç ç›¸å…³çš„API
    if (url.includes('/qrcode') || url.includes('/login/qr')) {
      try {
        const text = await response.text();
        if (text.includes('qrcode_key') || text.includes('qr_code')) {
          logger.info(`ğŸ”„ New QR code from API: ${url}`);

          // æå–æ–°äºŒç»´ç 
          const newQRCode = await this.extractQRCode(page, accountId, sessionId);
          logger.info('âœ… New QR code sent to client');
        }
      } catch (error) {
        logger.debug('Error parsing API response:', error);
      }
    }
  });
}
```

---

## è¿ç§»è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šå®æ–½æ–¹æ¡ˆ1ï¼ˆMutationObserverï¼‰
- âœ… ä¿®æ”¹ `douyin-login-handler.js`
- âœ… æ·»åŠ  `setupQRCodeChangeListener()` æ–¹æ³•
- âœ… æ·»åŠ  `cleanupQRCodeListener()` æ–¹æ³•
- âœ… ä¿®æ”¹ `startLoginStatusPolling()` ç§»é™¤ç¡¬ç¼–ç çš„150ç§’
- âœ… æµ‹è¯•ç™»å½•æµç¨‹

### ç¬¬äºŒé˜¶æ®µï¼šæ€§èƒ½ä¼˜åŒ–
- æ·»åŠ æœ€å¤§åˆ·æ–°æ¬¡æ•°é™åˆ¶ï¼ˆé˜²æ­¢æ— é™åˆ·æ–°ï¼‰
- æ·»åŠ æ—¥å¿—è®°å½•æ¯æ¬¡äºŒç»´ç åˆ·æ–°çš„æ—¶é—´é—´éš”
- æ”¶é›†çœŸå®æ•°æ®éªŒè¯åˆ·æ–°å‘¨æœŸ

### ç¬¬ä¸‰é˜¶æ®µï¼šå›é€€æ–¹æ¡ˆ
- å¦‚æœMutationObserverä¸å¯é ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°æ–¹æ¡ˆ2ï¼ˆPollingï¼‰
- ä¿ç•™åŸæœ‰çš„150ç§’è¶…æ—¶æœºåˆ¶ä½œä¸ºæœ€åæ‰‹æ®µ

---

## æŠ€æœ¯å¯¹æ¯”è¡¨

| æ–¹æ¡ˆ | å®æ—¶æ€§ | CPUå ç”¨ | å¯é æ€§ | é€‚åº”æ€§ | å¤æ‚åº¦ |
|------|--------|---------|--------|--------|--------|
| **MutationObserver** | â­â­â­â­â­ | ä½ | é«˜ | é«˜ | ä¸­ |
| **Polling (1s)** | â­â­â­â­ | ä¸­ | ä¸­ | ä¸­ | ä½ |
| **APIæ‹¦æˆª** | â­â­â­â­â­ | ä½ | ä¸­ | é«˜ | é«˜ |
| **æ—¶é—´ç­‰å¾… (150s)** | â­ | æä½ | ä½ | ä½ | æä½ |

---

## é¢„æœŸæ”¶ç›Š

| æŒ‡æ ‡ | å½“å‰ | æ”¹è¿›å | æå‡ |
|------|------|--------|------|
| **äºŒç»´ç åˆ·æ–°å»¶è¿Ÿ** | 150ç§’ | <1ç§’ | 150å€ |
| **é€‚åº”æŠ–éŸ³å˜åŒ–** | éœ€ä¿®æ”¹ä»£ç  | è‡ªåŠ¨é€‚åº” | æ— ç¼ |
| **ç”¨æˆ·ä½“éªŒ** | å¯èƒ½çœ‹åˆ°è¿‡æœŸç  | å§‹ç»ˆæœ€æ–° | æ˜¾è‘— |
| **ç™»å½•æˆåŠŸç‡** | åŸºç¡€ | å¤§å¹…æå‡ | é¢„è®¡+30% |

---

## ä»£ç é›†æˆæ£€æŸ¥è¡¨

- [ ] åœ¨ `startLogin()` ä¸­è°ƒç”¨ `setupQRCodeChangeListener()`
- [ ] åœ¨ä¼šè¯æ¸…ç†ä¸­è°ƒç”¨ `cleanupQRCodeListener()`
- [ ] ç§»é™¤æˆ–æ”¹è¿› `startLoginStatusPolling()` ä¸­çš„150ç§’ç¡¬ç¼–ç 
- [ ] ä¿ç•™æœ€å¤§åˆ·æ–°æ¬¡æ•°é™åˆ¶ï¼ˆé˜²æ­¢æ¶æ„å¾ªç¯ï¼‰
- [ ] æ·»åŠ æ—¥å¿—è®°å½•æ¯æ¬¡åˆ·æ–°çš„æ—¶é—´é—´éš”
- [ ] æ·»åŠ åŠŸèƒ½å¼€å…³ï¼ˆæ”¯æŒæ–°æ—§æ–¹æ¡ˆåˆ‡æ¢ï¼‰
- [ ] è¿›è¡Œç™»å½•æµ‹è¯•éªŒè¯
- [ ] ç›‘æ§å®é™…åˆ·æ–°å‘¨æœŸæ•°æ®

---

## å‚è€ƒèµ„æº

- [MDN: MutationObserver](https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver)
- [Playwright: Page Events](https://playwright.dev/docs/api/class-page#page-event-response)
- [æŠ–éŸ³ç™»å½•é¡µé¢åˆ†æ](./æŠ–éŸ³äºŒç»´ç åˆ·æ–°å‘¨æœŸåˆ†æ.md)

