# 增量抓取实现指南

## 概述

增量抓取系统用于追踪新评论，实现智能通知。通过对比历史数据，只对新评论进行通知，避免重复推送。

## 核心功能

1. **作品追踪** - 记录每个作品的评论历史
2. **增量检测** - 区分新旧评论
3. **智能通知** - 只推送新评论
4. **统计分析** - 评论数量、点赞数等统计

## 数据库设计

### 1. 作品表 (douyin_videos)

**Migration**: `006_add_douyin_videos_table.sql`

```sql
CREATE TABLE douyin_videos (
  id INTEGER PRIMARY KEY AUTOINCREMENT,

  -- 账户和作品信息
  account_id TEXT NOT NULL,
  aweme_id TEXT NOT NULL UNIQUE,  -- 作品ID（唯一）
  title TEXT,
  cover TEXT,
  publish_time TEXT,

  -- 统计信息
  total_comment_count INTEGER DEFAULT 0,
  new_comment_count INTEGER DEFAULT 0,
  like_count INTEGER DEFAULT 0,

  -- 爬取状态
  last_crawl_time INTEGER,
  crawl_status TEXT DEFAULT 'pending',

  -- 时间戳
  created_at INTEGER,
  updated_at INTEGER
);
```

### 2. 评论表扩展 (comments)

**Migration**: `007_add_comment_tracking_fields.sql`

新增字段：
- `is_new` - 是否新评论（用于标记未查看的评论）
- `first_detected_at` - 首次发现时间
- `post_cover` - 作品封面（方便展示）
- `like_count` - 点赞数
- `reply_to_comment_id` - 回复的评论ID
- `ip_label` - IP属地

## DAO 层实现

### DouyinVideoDAO

**文件**: `packages/master/src/database/douyin-video-dao.js`

主要方法：

```javascript
// 创建或更新作品
upsertVideo(video)

// 根据作品ID获取
getVideoByAwemeId(awemeId)

// 获取账户的所有作品
getVideosByAccountId(accountId)

// 更新爬取状态
updateCrawlStatus(awemeId, status, error)

// 更新评论数
updateCommentCount(awemeId, newCommentCount)

// 获取需要爬取的作品
getVideosToCrawl(intervalSeconds)

// 获取统计信息
getVideoStats(accountId)
```

### CommentsDAO 扩展

**文件**: `packages/master/src/database/comments-dao.js`

新增方法：

```javascript
// 获取作品的所有评论ID（用于增量对比）
getCommentIdsByPostId(postId)

// 批量插入评论
bulkInsert(comments)

// 标记新评论为已查看
markNewAsViewed(accountId, postId)

// 统计新评论数量
countNew(accountId, postId)

// 根据作品ID查找评论
findByPostId(postId, options)
```

## 增量抓取服务

**文件**: `packages/worker/src/services/incremental-crawl-service.js`

### 核心方法

#### 1. processCommentsIncremental()

处理评论增量抓取的核心逻辑：

```javascript
const { newComments, allComments, stats } =
  await IncrementalCrawlService.processCommentsIncremental(
    rawComments,      // 从API获取的原始评论
    video,            // 作品对象
    accountId,        // 账户ID
    getExistingCommentIds  // 获取历史评论ID的函数
  );
```

**流程**：
1. 获取该作品的所有历史评论ID
2. 对比原始评论，标记 `is_new` 字段
3. 返回新评论、所有评论和统计信息

#### 2. generateCommentNotifications()

生成新评论通知：

```javascript
const notifications = IncrementalCrawlService.generateCommentNotifications(
  newComments,  // 新评论列表
  video,        // 作品对象
  accountId     // 账户ID
);
```

**策略**：
- 新评论 > 5条：生成汇总通知
- 新评论 ≤ 5条：为每条生成单独通知

## 爬虫集成

### 评论爬虫流程

在 `packages/worker/src/platforms/douyin/platform.js` 的 `crawlComments()` 方法中：

```javascript
async crawlComments(account, options = {}) {
  const { maxVideos = 5 } = options;

  // 1. 导航到评论管理页面
  await this.navigateToCommentManage(page);

  // 2. 获取作品列表
  const videos = await this.getVideoListFromCommentPage(page);

  // 3. 逐个作品爬取
  for (let i = 0; i < maxVideos; i++) {
    const video = videos[i];

    // 3.1 拦截API
    await page.route('**/comment/list/select/**', handler);

    // 3.2 点击作品
    await this.clickVideoInCommentPage(page, video, i);

    // 3.3 解析评论
    const rawComments = this.parseCommentsFromAPI(apiResponses);

    // 3.4 【增量处理】
    const { newComments, allComments, stats } =
      await IncrementalCrawlService.processCommentsIncremental(
        rawComments,
        video,
        account.id,
        (awemeId) => this.bridge.getCommentIdsByPostId(awemeId)
      );

    // 3.5 保存到数据库
    await this.bridge.bulkInsertComments(allComments);

    // 3.6 更新作品统计
    await this.bridge.upsertVideo({
      account_id: account.id,
      aweme_id: video.aweme_id,
      title: video.title,
      cover: video.cover,
      total_comment_count: allComments.length,
    });

    // 3.7 生成通知
    if (newComments.length > 0) {
      const notifications = IncrementalCrawlService.generateCommentNotifications(
        newComments,
        video,
        account.id
      );

      // 推送通知
      for (const notif of notifications) {
        await this.pushNotification(notif);
      }
    }
  }

  return { comments: allComments, videos, stats };
}
```

## Worker-Master 通信

### Worker 需要的接口

在 `WorkerBridge` 中添加以下方法：

```javascript
// 获取作品的历史评论ID
async getCommentIdsByPostId(postId) {
  return new Promise((resolve) => {
    this.socket.emit('worker:get_comment_ids', { postId }, (response) => {
      resolve(response.commentIds || []);
    });
  });
}

// 批量插入评论
async bulkInsertComments(comments) {
  return new Promise((resolve) => {
    this.socket.emit('worker:bulk_insert_comments', { comments }, (response) => {
      resolve(response);
    });
  });
}

// 创建或更新作品
async upsertVideo(video) {
  return new Promise((resolve) => {
    this.socket.emit('worker:upsert_video', { video }, (response) => {
      resolve(response);
    });
  });
}
```

### Master 需要的事件处理

在 `packages/master/src/communication/socket-server.js` 中添加：

```javascript
// 获取评论ID列表
socket.on('worker:get_comment_ids', async (data, callback) => {
  try {
    const commentIds = commentsDAO.getCommentIdsByPostId(data.postId);
    callback({ success: true, commentIds });
  } catch (error) {
    callback({ success: false, error: error.message });
  }
});

// 批量插入评论
socket.on('worker:bulk_insert_comments', async (data, callback) => {
  try {
    const result = commentsDAO.bulkInsert(data.comments);
    callback({ success: true, ...result });
  } catch (error) {
    callback({ success: false, error: error.message });
  }
});

// 创建或更新作品
socket.on('worker:upsert_video', async (data, callback) => {
  try {
    const video = douyinVideoDAO.upsertVideo(data.video);
    callback({ success: true, video });
  } catch (error) {
    callback({ success: false, error: error.message });
  }
});
```

## 使用示例

### 查询新评论

```javascript
// 获取账户的所有新评论
const newComments = commentsDAO.findAll({
  account_id: 'account-123',
  is_new: 1,
  limit: 50
});

// 获取特定作品的新评论
const newCommentsForVideo = commentsDAO.findByPostId('aweme-123', {
  is_new: 1
});

// 统计新评论数量
const newCount = commentsDAO.countNew('account-123');
```

### 标记已查看

```javascript
// 标记某个账户的所有新评论为已查看
commentsDAO.markNewAsViewed('account-123');

// 标记某个作品的新评论为已查看
commentsDAO.markNewAsViewed('account-123', 'aweme-123');
```

### 获取作品统计

```javascript
// 获取账户的作品统计
const stats = douyinVideoDAO.getVideoStats('account-123');
// {
//   total_videos: 10,
//   total_comments: 500,
//   new_comments: 20,
//   total_likes: 1000,
//   total_plays: 50000
// }
```

## 优势

1. **精确追踪** - 每个作品独立追踪，不会遗漏
2. **去重保证** - `INSERT OR IGNORE` 确保不重复插入
3. **性能优化** - 批量插入 + 事务，单次可处理数百条评论
4. **实时通知** - 新评论立即推送通知
5. **统计完善** - 作品级、账户级多维度统计

## 注意事项

1. **唯一性约束** - `platform_comment_id` 必须保证唯一
2. **事务处理** - 批量操作使用事务确保原子性
3. **索引优化** - `aweme_id`、`platform_comment_id`、`is_new` 都已建索引
4. **通知策略** - 大量新评论时使用汇总通知，避免通知轰炸

## 相关文件

- 数据库迁移:
  - `packages/master/src/database/migrations/006_add_douyin_videos_table.sql`
  - `packages/master/src/database/migrations/007_add_comment_tracking_fields.sql`

- DAO层:
  - `packages/master/src/database/douyin-video-dao.js`
  - `packages/master/src/database/comments-dao.js`

- 服务层:
  - `packages/worker/src/services/incremental-crawl-service.js`

- 爬虫:
  - `packages/worker/src/platforms/douyin/platform.js`

## 测试建议

1. 使用真实账号测试第一次爬取（所有评论应标记为新）
2. 再次爬取同一作品（应无新评论）
3. 在抖音添加新评论后爬取（应只有新评论被标记）
4. 测试通知推送功能
5. 验证数据库统计信息准确性
