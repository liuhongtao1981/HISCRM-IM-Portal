# 💬 消息管理模块

## 📌 概述

消息管理模块提供了一个完整的消息查询、展示和管理系统，用户可以在一个统一的界面中查看所有的评论和私信消息。

### 主要特性
- 📊 **实时统计**: 显示总消息数和今日消息数
- 🎨 **今日标记**: 用红色背景自动标记今天的消息
- 🔄 **自动刷新**: 支持 10/30/60 秒自动刷新或手动刷新
- 🔍 **灵活筛选**: 按消息类型、账号、内容搜索
- 📋 **详细展示**: 评论和私信表格展示完整信息
- ⚡ **高性能**: 基于 SQLite 数据库，查询速度快

## 🚀 快速开始

### 访问页面
1. 打开管理平台 Web UI
2. 左侧菜单 → 💬 **消息管理**
3. 选择自动刷新间隔
4. 查看评论或私信

### 完整文档
- 📖 [快速参考指南](消息管理快速参考.md)
- 📖 [完整设计文档](消息管理页面设计.md)
- 📖 [实现总结](消息管理实现总结.md)

## 📦 实现文件

### 前端
```
packages/admin-web/
├── src/
│   ├── pages/
│   │   └── MessageManagementPage.js    ← 消息管理页面（新建）
│   ├── services/
│   │   └── api.js                     ← API 服务（已更新）
│   └── App.js                         ← 应用主文件（已更新）
```

### 后端
```
packages/master/
└── src/
    └── api/
        └── routes/
            └── messages.js             ← 消息路由（已扩展）
```

### 测试
```
tests/
└── test-message-management.js         ← API 测试脚本（新建）
```

## 🔌 API 端点

### 1. 获取评论列表
```
GET /api/v1/comments
```

**查询参数**:
- `account_id` (可选): 账户 ID
- `sort` (可选, 默认='created_at'): 排序字段
- `order` (可选, 默认='desc'): asc 或 desc
- `created_at_start` (可选): 开始时间戳
- `created_at_end` (可选): 结束时间戳
- `limit` (可选, 默认=100): 返回数量

**响应**:
```json
{
  "success": true,
  "data": [
    {
      "id": "comment-xxx",
      "account_id": "acc-xxx",
      "content": "评论内容",
      "creator_name": "用户名",
      "video_id": "video-xxx",
      "platform": "douyin",
      "created_at": 1634567890
    }
  ],
  "count": 1
}
```

### 2. 获取私信列表
```
GET /api/v1/direct-messages
```

**查询参数**:
- `account_id` (可选): 账户 ID
- `direction` (可选): inbound 或 outbound
- `sort` (可选, 默认='created_at'): 排序字段
- `order` (可选, 默认='desc'): asc 或 desc
- `created_at_start` (可选): 开始时间戳
- `created_at_end` (可选): 结束时间戳
- `limit` (可选, 默认=100): 返回数量

**响应**:
```json
{
  "success": true,
  "data": [
    {
      "id": "dm-xxx",
      "account_id": "acc-xxx",
      "content": "私信内容",
      "sender_name": "发送者",
      "direction": "inbound",
      "platform": "douyin",
      "created_at": 1634567890
    }
  ],
  "count": 1
}
```

## 🧪 测试

### 运行测试脚本
```bash
cd /path/to/project
node tests/test-message-management.js
```

### 测试内容
- ✅ 获取全部评论
- ✅ 按时间倒序排序
- ✅ 获取今日评论
- ✅ 按账号筛选
- ✅ 获取全部私信
- ✅ 按方向筛选（入站/出站）
- ✅ API 响应格式验证

## 📊 页面功能

### 统计卡片
| 卡片 | 说明 |
|------|------|
| 总评论数 | 全部评论计数 |
| 今日评论 | 今天新增评论 |
| 总私信数 | 全部私信计数 |
| 今日私信 | 今天新增私信 |

### 表格列

#### 评论表格
| 列 | 说明 |
|---|------|
| 时间 | 消息时间（今日红色标记） |
| 账号 | 蓝色标签，账户 ID |
| 评论内容 | 💬 评论正文内容 |
| 发布者 | 评论者用户名 |
| 视频ID | 关联视频 ID |
| 来源 | 平台标识（抖音等） |

#### 私信表格
| 列 | 说明 |
|---|------|
| 时间 | 消息时间（今日红色标记） |
| 账号 | 绿色标签，账户 ID |
| 私信内容 | 📩 私信正文内容 |
| 发送者 | 发送者用户名 |
| 方向 | 入站/出站 |
| 来源 | 平台标识（抖音等） |

### 自动刷新选项
```
- 每10秒刷新  (最实时)
- 每30秒刷新  (推荐)
- 每60秒刷新  (低频)
- 不自动刷新  (手动)
```

## 🎨 设计特点

### 今日消息识别
- ✅ 自动检测当天消息
- ✅ 红色背景 (#fff2f0)
- ✅ 红色文字 (#ff4d4f)
- ✅ 【今日】标签标记
- ✅ 加粗显示

**示例**:
```
【今日】10-18 14:35:22  ← 红色背景和文字
10-17 09:15:30          ← 正常显示
```

### 颜色方案
| 元素 | 颜色 | 代码 |
|------|------|------|
| 评论账号 | 蓝色 | #1890ff |
| 私信账号 | 绿色 | #52c41a |
| 今日背景 | 浅红 | #fff2f0 |
| 今日文字 | 红色 | #ff4d4f |
| 入站方向 | 青色 | #13c2c2 |
| 出站方向 | 橙色 | #fa8c16 |

## 💻 使用示例

### 查看今日评论
```javascript
// 前端调用
const params = {
  created_at_start: dayjs().startOf('day').unix(),
  sort: 'created_at',
  order: 'desc',
  limit: 100
};
const response = await api.get('/api/v1/comments', { params });
```

### 查看特定账号的入站私信
```javascript
// 前端调用
const params = {
  account_id: 'acc-59112c67-ff87-44e3-9176-44313ce2b0b6',
  direction: 'inbound',
  sort: 'created_at',
  order: 'desc',
  limit: 50
};
const response = await api.get('/api/v1/direct-messages', { params });
```

## 🔗 相关模块

### 已集成的功能
- ✅ 通知系统：新消息通过实时通知推送
- ✅ 账号管理：可按账号筛选消息
- ✅ 时间处理：使用 dayjs 进行时间管理

### 未来扩展
- [ ] 全文搜索
- [ ] 消息导出
- [ ] 批量操作
- [ ] 消息详情
- [ ] WebSocket 实时推送

## 🛠️ 开发指南

### 添加新的表格列
1. 在 `commentColumns` 或 `messageColumns` 中添加列配置
2. 确保数据源中有对应的字段
3. 使用 `render` 函数自定义显示

### 修改刷新间隔选项
1. 编辑 `MessageManagementPage.js` 中的 `Select` 组件
2. 添加新的 `Option` 选项
3. 修改 `refreshInterval` 状态管理

### 添加新的筛选条件
1. 在 `filters` 状态中添加新字段
2. 在 API 查询参数中传递新筛选条件
3. 在筛选卡片中添加对应的输入控件

## 📚 文档索引

| 文档 | 内容 | 对象 |
|------|------|------|
| [快速参考](消息管理快速参考.md) | 功能说明、快捷操作 | 终端用户 |
| [设计文档](消息管理页面设计.md) | 完整设计、技术实现 | 开发者 |
| [实现总结](消息管理实现总结.md) | 完成情况、测试说明 | 维护者 |

## ⚡ 性能优化

### 已优化的地方
- ✅ 数据库查询限制 (默认 100 条)
- ✅ 前端分页 (每页 20 条)
- ✅ 表格虚拟化 (需要时可启用)
- ✅ 防抖刷新 (避免频繁请求)

### 优化建议
- 大数据量时使用搜索框缩小范围
- 避免同时打开多个自动刷新页面
- 移动设备推荐使用手动刷新

## 🐛 故障排除

### 表格无数据
- [ ] 检查网络连接
- [ ] 查看浏览器控制台错误
- [ ] 确认账号已有消息
- [ ] 点击"立即刷新"按钮

### 今日消息没有红色标记
- [ ] 检查系统时间是否正确
- [ ] 验证消息时间戳是否准确
- [ ] 刷新页面重试

### 自动刷新不工作
- [ ] 检查是否选择了"不自动刷新"
- [ ] 查看控制台错误信息
- [ ] 检查网络连接状态

## 📞 需要帮助？

1. **快速问题** → 查看 [快速参考](消息管理快速参考.md)
2. **技术问题** → 查看 [设计文档](消息管理页面设计.md)
3. **API 问题** → 运行 [测试脚本](../tests/test-message-management.js)
4. **其他问题** → 查看 [实现总结](消息管理实现总结.md)

---

**版本**: 1.0.0
**更新时间**: 2025-10-18
**状态**: ✅ 已完成
