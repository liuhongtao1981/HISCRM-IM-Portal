# æ¶ˆæ¯ç®¡ç†é¡µé¢è®¾è®¡æ–‡æ¡£

## æ¦‚è¿°

æ¶ˆæ¯ç®¡ç†é¡µé¢æ˜¯ä¸€ä¸ªç”¨äºæŸ¥è¯¢å’Œç®¡ç†æ¶ˆæ¯ï¼ˆè¯„è®ºå’Œç§ä¿¡ï¼‰çš„åŠŸèƒ½æ¨¡å—ã€‚ç”¨æˆ·å¯ä»¥ï¼š
- æŸ¥çœ‹å…¨éƒ¨è¯„è®ºå’Œç§ä¿¡
- æŒ‰è´¦å·ç­›é€‰
- æŸ¥çœ‹ä»Šæ—¥æ¶ˆæ¯ï¼ˆæœ‰ç‰¹æ®Šé¢œè‰²åŒºåˆ†ï¼‰
- è®¾ç½®è‡ªåŠ¨åˆ·æ–°é—´éš”

## å®ç°æ–‡ä»¶

### å‰ç«¯

#### 1. [packages/admin-web/src/pages/MessageManagementPage.js](../packages/admin-web/src/pages/MessageManagementPage.js)
- **ä½œç”¨**: æ¶ˆæ¯ç®¡ç†ä¸»é¡µé¢ç»„ä»¶
- **åŠŸèƒ½**:
  - æ˜¾ç¤ºè¯„è®ºå’Œç§ä¿¡ç»Ÿè®¡å¡ç‰‡
  - æ ‡ç­¾é¡µåˆ‡æ¢ï¼ˆè¯„è®º/ç§ä¿¡ï¼‰
  - æ—¶é—´è¿‡æ»¤å’Œæœç´¢
  - è‡ªåŠ¨åˆ·æ–°æ§åˆ¶ï¼ˆ10/30/60ç§’å¯é€‰ï¼‰
  - ä»Šæ—¥æ¶ˆæ¯é«˜äº®æ˜¾ç¤ºï¼ˆçº¢è‰²èƒŒæ™¯ï¼‰
  - å®šæ—¶åˆ·æ–°åŠŸèƒ½

#### 2. [packages/admin-web/src/services/api.js](../packages/admin-web/src/services/api.js)ï¼ˆå·²æ›´æ–°ï¼‰
- **æ–°å¢ API**:
  - `messagesAPI.getComments(params)` - è·å–è¯„è®ºåˆ—è¡¨
  - `messagesAPI.getDirectMessages(params)` - è·å–ç§ä¿¡åˆ—è¡¨
  - `messagesAPI.getMessageStats()` - è·å–æ¶ˆæ¯ç»Ÿè®¡

#### 3. [packages/admin-web/src/App.js](../packages/admin-web/src/App.js)ï¼ˆå·²æ›´æ–°ï¼‰
- **æ–°å¢èœå•é¡¹**: "ğŸ’¬ æ¶ˆæ¯ç®¡ç†" â†’ `/messages`
- **æ–°å¢è·¯ç”±**: `<Route path="/messages" element={<MessageManagementPage />} />`

### åç«¯

#### [packages/master/src/api/routes/messages.js](../packages/master/src/api/routes/messages.js)ï¼ˆå·²æ‰©å±•ï¼‰

**æ–°å¢ä¸¤ä¸ª GET ç«¯ç‚¹**:

##### 1. `/api/v1/comments`
æŸ¥è¯¢è¯„è®ºåˆ—è¡¨

**æŸ¥è¯¢å‚æ•°**:
- `account_id` (å¯é€‰): è´¦æˆ·IDç­›é€‰
- `sort` (å¯é€‰, é»˜è®¤='created_at'): æ’åºå­—æ®µ
  - `created_at`: æŒ‰åˆ›å»ºæ—¶é—´
  - `detected_at`: æŒ‰æ£€æµ‹æ—¶é—´
- `order` (å¯é€‰, é»˜è®¤='desc'): æ’åºé¡ºåº
  - `asc`: å‡åº
  - `desc`: é™åº
- `created_at_start` (å¯é€‰): å¼€å§‹æ—¶é—´æˆ³ï¼ˆUnixï¼‰
- `created_at_end` (å¯é€‰): ç»“æŸæ—¶é—´æˆ³ï¼ˆUnixï¼‰
- `limit` (å¯é€‰, é»˜è®¤=100): è¿”å›æ•°é‡

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": [
    {
      "id": "comment-xxx",
      "account_id": "acc-xxx",
      "content": "è¿™æ˜¯ä¸€æ¡è¯„è®º",
      "creator_name": "ç”¨æˆ·å",
      "video_id": "video-xxx",
      "platform": "douyin",
      "created_at": 1634567890,
      "detected_at": 1634567895
    }
  ],
  "count": 1
}
```

##### 2. `/api/v1/direct-messages`
æŸ¥è¯¢ç§ä¿¡åˆ—è¡¨

**æŸ¥è¯¢å‚æ•°**:
- `account_id` (å¯é€‰): è´¦æˆ·IDç­›é€‰
- `direction` (å¯é€‰): æ–¹å‘ç­›é€‰
  - `inbound`: å…¥ç«™ï¼ˆæ¥æ”¶ï¼‰
  - `outbound`: å‡ºç«™ï¼ˆå‘é€ï¼‰
- `sort` (å¯é€‰, é»˜è®¤='created_at'): æ’åºå­—æ®µ
- `order` (å¯é€‰, é»˜è®¤='desc'): æ’åºé¡ºåº
- `created_at_start` (å¯é€‰): å¼€å§‹æ—¶é—´æˆ³ï¼ˆUnixï¼‰
- `created_at_end` (å¯é€‰): ç»“æŸæ—¶é—´æˆ³ï¼ˆUnixï¼‰
- `limit` (å¯é€‰, é»˜è®¤=100): è¿”å›æ•°é‡

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": [
    {
      "id": "dm-xxx",
      "account_id": "acc-xxx",
      "content": "è¿™æ˜¯ä¸€æ¡ç§ä¿¡",
      "sender_name": "å‘é€è€…",
      "direction": "inbound",
      "platform": "douyin",
      "created_at": 1634567890,
      "detected_at": 1634567895
    }
  ],
  "count": 1
}
```

## å‰ç«¯å®ç°ç»†èŠ‚

### é¡µé¢ç»“æ„

```
æ¶ˆæ¯ç®¡ç†é¡µé¢
â”œâ”€â”€ é¡µé¢æ ‡é¢˜ + åˆ·æ–°é—´éš”é€‰æ‹©
â”œâ”€â”€ ç»Ÿè®¡å¡ç‰‡è¡Œ
â”‚   â”œâ”€â”€ æ€»è¯„è®ºæ•°
â”‚   â”œâ”€â”€ ä»Šæ—¥è¯„è®ºæ•°
â”‚   â”œâ”€â”€ æ€»ç§ä¿¡æ•°
â”‚   â””â”€â”€ ä»Šæ—¥ç§ä¿¡æ•°
â”œâ”€â”€ ç­›é€‰å¡ç‰‡
â”‚   â”œâ”€â”€ æ¶ˆæ¯ç±»å‹ï¼ˆå…¨éƒ¨/ä»Šæ—¥ï¼‰
â”‚   â””â”€â”€ æœç´¢æ¡†
â””â”€â”€ æ ‡ç­¾é¡µ
    â”œâ”€â”€ è¯„è®ºè¡¨æ ¼
    â”‚   â”œâ”€â”€ æ—¶é—´ï¼ˆä»Šæ—¥é«˜äº®çº¢è‰²ï¼‰
    â”‚   â”œâ”€â”€ è´¦å·
    â”‚   â”œâ”€â”€ è¯„è®ºå†…å®¹
    â”‚   â”œâ”€â”€ å‘å¸ƒè€…
    â”‚   â”œâ”€â”€ è§†é¢‘ID
    â”‚   â””â”€â”€ æ¥æº
    â””â”€â”€ ç§ä¿¡è¡¨æ ¼
        â”œâ”€â”€ æ—¶é—´ï¼ˆä»Šæ—¥é«˜äº®çº¢è‰²ï¼‰
        â”œâ”€â”€ è´¦å·
        â”œâ”€â”€ ç§ä¿¡å†…å®¹
        â”œâ”€â”€ å‘é€è€…
        â”œâ”€â”€ æ–¹å‘
        â””â”€â”€ æ¥æº
```

### ä»Šæ—¥æ¶ˆæ¯è¯†åˆ«

```javascript
// åˆ¤æ–­æ˜¯å¦ä¸ºä»Šæ—¥æ¶ˆæ¯
const isToday = (timestamp) => {
  const date = dayjs.unix(timestamp);
  return date.isSame(dayjs(), 'day');
};

// æ—¶é—´å•å…ƒæ ¼æ¸²æŸ“ï¼ˆçº¢è‰²æ ‡è®°ï¼‰
<span style={{
  color: today ? '#ff4d4f' : undefined,
  fontWeight: today ? 'bold' : 'normal',
  backgroundColor: today ? '#fff2f0' : 'transparent',
  padding: '2px 6px',
  borderRadius: '4px'
}}>
  {today ? 'ã€ä»Šæ—¥ã€‘' : ''}{date.format('MM-DD HH:mm:ss')}
</span>
```

### è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½

```javascript
// åˆ·æ–°é—´éš”é€‰æ‹©
<Select
  style={{ width: 120 }}
  value={refreshInterval}
  onChange={setRefreshInterval}
>
  <Option value={10}>æ¯10ç§’åˆ·æ–°</Option>
  <Option value={30}>æ¯30ç§’åˆ·æ–°</Option>
  <Option value={60}>æ¯60ç§’åˆ·æ–°</Option>
  <Option value={999999}>ä¸è‡ªåŠ¨åˆ·æ–°</Option>
</Select>

// å®šæ—¶å™¨å®ç°
useEffect(() => {
  const interval = setInterval(() => {
    if (activeTab === 'comments') {
      fetchComments();
    } else {
      fetchDirectMessages();
    }
  }, refreshInterval * 1000);

  return () => clearInterval(interval);
}, [activeTab, filters, refreshInterval]);
```

## æµ‹è¯•è„šæœ¬

**ä½ç½®**: [tests/test-message-management.js](../tests/test-message-management.js)

**æµ‹è¯•é¡¹ç›®**:
1. è·å–å…¨éƒ¨è¯„è®º
2. æŒ‰æ—¶é—´å€’åºæ’åº
3. è·å–ä»Šæ—¥è¯„è®º
4. æŒ‰è´¦å·ç­›é€‰è¯„è®º
5. è·å–å…¨éƒ¨ç§ä¿¡
6. æŒ‰æ–¹å‘ç­›é€‰ç§ä¿¡ï¼ˆå…¥ç«™/å‡ºç«™ï¼‰
7. éªŒè¯ API å“åº”æ ¼å¼

**è¿è¡Œæ–¹å¼**:
```bash
node tests/test-message-management.js
```

## ä½¿ç”¨ç¤ºä¾‹

### è·å–ä»Šæ—¥è¯„è®ºï¼ˆæŒ‰æœ€æ–°ä¼˜å…ˆæ’åºï¼‰

```javascript
const params = {
  created_at_start: dayjs().startOf('day').unix(),
  sort: 'created_at',
  order: 'desc',
  limit: 100
};
const response = await api.get('/api/v1/comments', { params });
```

### è·å–ç‰¹å®šè´¦å·çš„ç§ä¿¡ï¼ˆå…¥ç«™ï¼Œæœ€æ–°ä¼˜å…ˆï¼‰

```javascript
const params = {
  account_id: 'acc-59112c67-ff87-44e3-9176-44313ce2b0b6',
  direction: 'inbound',
  sort: 'created_at',
  order: 'desc',
  limit: 50
};
const response = await api.get('/api/v1/direct-messages', { params });
```

## é¢œè‰²æ–¹æ¡ˆ

| å…ƒç´  | é¢œè‰² | è¯´æ˜ |
|------|------|------|
| è¯„è®ºè´¦å· Tag | Blue (#1890ff) | è¯„è®ºæ¥æºæ ‡è¯† |
| ç§ä¿¡è´¦å· Tag | Green (#52c41a) | ç§ä¿¡æ¥æºæ ‡è¯† |
| ä»Šæ—¥æ¶ˆæ¯èƒŒæ™¯ | Red (#ff2f0) | æµ…çº¢è‰²èƒŒæ™¯ |
| ä»Šæ—¥æ¶ˆæ¯æ–‡å­— | Red (#ff4d4f) | çº¢è‰²æ–‡å­— |
| å…¥ç«™æ–¹å‘ Tag | Cyan | æ¥æ”¶æ¶ˆæ¯ |
| å‡ºç«™æ–¹å‘ Tag | Orange | å‘é€æ¶ˆæ¯ |

## æ•°æ®åº“è¡¨å­—æ®µæ˜ å°„

### comments è¡¨
```
- id: è¯„è®ºID
- account_id: è´¦æˆ·ID
- content: è¯„è®ºå†…å®¹
- creator_name: å‘å¸ƒè€…åç§°
- video_id: è§†é¢‘ID
- platform: å¹³å°ï¼ˆdouyinç­‰ï¼‰
- created_at: åˆ›å»ºæ—¶é—´æˆ³
- detected_at: æ£€æµ‹æ—¶é—´æˆ³
```

### direct_messages è¡¨
```
- id: ç§ä¿¡ID
- account_id: è´¦æˆ·ID
- content: ç§ä¿¡å†…å®¹
- sender_name: å‘é€è€…åç§°
- direction: æ–¹å‘ï¼ˆinbound/outboundï¼‰
- platform: å¹³å°ï¼ˆdouyinç­‰ï¼‰
- created_at: åˆ›å»ºæ—¶é—´æˆ³
- detected_at: æ£€æµ‹æ—¶é—´æˆ³
```

## æœªæ¥æ”¹è¿›

1. **æ¶ˆæ¯æœç´¢**: å®ç°å…¨æ–‡æœç´¢åŠŸèƒ½
2. **æ¶ˆæ¯æ ‡è®°**: æ”¯æŒæ ‡è®°é‡è¦æ¶ˆæ¯
3. **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ‰¹é‡åˆ é™¤/å¯¼å‡º
4. **æ¶ˆæ¯è¯¦æƒ…**: ç‚¹å‡»æŸ¥çœ‹å®Œæ•´æ¶ˆæ¯è¯¦æƒ…
5. **é€šçŸ¥é›†æˆ**: ä¸é€šçŸ¥ç³»ç»Ÿè”åŠ¨æ˜¾ç¤ºæ–°æ¶ˆæ¯
6. **æ•°æ®å¯¼å‡º**: æ”¯æŒå¯¼å‡ºä¸º CSV/Excel
7. **é«˜çº§ç­›é€‰**: æ”¯æŒæ›´å¤šç­›é€‰æ¡ä»¶ç»„åˆ
