# 账号状态监控功能实现指南

## 📋 功能概述

将原"登录管理"页面重构为"账号状态监控面板"，实时显示所有在线 Worker 中账号的运行状态，包括：
- 账号是否在线
- 最后爬虫时间
- 登录时间
- 评论数、作品数等统计信息

## ✅ 已完成的工作

### 1. 数据库迁移
**文件**: `packages/master/src/database/migrations/005_add_account_runtime_stats.sql`

已添加以下字段到 `accounts` 表：
```sql
-- 爬虫统计信息
total_comments INTEGER DEFAULT 0        -- 总评论数
total_works INTEGER DEFAULT 0            -- 总作品数
total_followers INTEGER DEFAULT 0        -- 总粉丝数
total_following INTEGER DEFAULT 0        -- 总关注数

-- 最近爬取统计
recent_comments_count INTEGER DEFAULT 0  -- 最近一次爬取的评论数
recent_works_count INTEGER DEFAULT 0     -- 最近一次爬取的作品数

-- 运行时状态
worker_status TEXT DEFAULT 'offline'     -- Worker 状态: online/offline/error
last_crawl_time INTEGER                  -- 最后一次爬取时间
last_heartbeat_time INTEGER              -- 最后一次心跳时间
error_count INTEGER DEFAULT 0            -- 错误计数
last_error_message TEXT                  -- 最后的错误信息
```

### 2. 消息协议扩展
**文件**: `packages/shared/protocol/messages.js`

添加了账号状态上报消息类型：
```javascript
const WORKER_ACCOUNT_STATUS = 'worker:account:status';          // Worker上报账号状态
const WORKER_ACCOUNT_STATUS_ACK = 'worker:account:status:ack';  // Master确认收到
```

### 3. 账号状态更新器
**文件**: `packages/master/src/worker_manager/account-status-updater.js`

创建了 `AccountStatusUpdater` 类，提供以下方法：
- `updateAccountStatus(accountId, status)` - 更新单个账号状态
- `batchUpdateAccountStatuses(accountStatuses)` - 批量更新账号状态
- `setAccountOnline(accountId)` - 设置账号为在线
- `setAccountOffline(accountId)` - 设置账号为离线
- `setAccountError(accountId, errorMessage)` - 设置账号为错误状态

### 4. 统一配置文件
**文件**: `packages/master/src/config/index.js`

将所有可配置参数集中管理，包括：
- **Worker 管理配置**: 心跳超时、状态上报间隔、任务分配等
- **爬虫配置**: 监控间隔、重试策略、超时设置、反爬虫设置
- **浏览器配置**: headless 模式、资源限制等
- **登录配置**: 二维码刷新、会话管理、Cookie 管理
- **通知配置**: 队列处理、优先级等
- **日志配置**: 日志级别、目录、文件管理
- **性能监控配置**: 指标采集、告警阈值

**关键配置参数**：
```javascript
worker: {
  accountStatus: {
    reportInterval: 60000,  // 账号状态上报间隔(ms) - 1分钟
    batchSize: 50,          // 批量上报最大账号数
  },
},

crawler: {
  monitorInterval: {
    min: 15000,   // 最小监控间隔(ms) - 15秒
    max: 30000,   // 最大监控间隔(ms) - 30秒
    default: 30000,  // 默认监控间隔(ms)
  },
},
```

### 5. 环境变量配置
**文件**: `packages/master/.env.example`

更新了完整的环境变量配置示例，包含所有可调参数。

## 🚧 待完成的工作

### 1. Master 端集成账号状态接收

需要在 `packages/master/src/index.js` 中完成以下集成：

#### Step 1: 初始化 AccountStatusUpdater
```javascript
// 在 start() 函数中添加
const config = require('./config');
accountStatusUpdater = new AccountStatusUpdater(db);
logger.info('Account status updater initialized');
```

#### Step 2: 添加账号状态消息处理函数
```javascript
/**
 * 处理 Worker 上报的账号状态
 */
function handleAccountStatus(socket, message) {
  const { worker_id, account_statuses } = message.payload;

  try {
    logger.debug(`Received account status from worker ${worker_id}`, {
      accountCount: account_statuses?.length,
    });

    if (!Array.isArray(account_statuses)) {
      throw new Error('account_statuses must be an array');
    }

    // 批量更新账号状态
    const result = accountStatusUpdater.batchUpdateAccountStatuses(
      account_statuses.map(item => ({
        account_id: item.account_id,
        status: item.status,
      }))
    );

    // 发送确认消息
    const ackMessage = createMessage(WORKER_ACCOUNT_STATUS_ACK, {
      success: true,
      updated: result.successCount,
      failed: result.failureCount,
    });

    sendMessage(socket, ackMessage);

    logger.info(`Updated ${result.successCount} account statuses from worker ${worker_id}`);
  } catch (error) {
    logger.error(`Failed to handle account status from worker ${worker_id}:`, error);

    const errorMessage = createMessage(WORKER_ACCOUNT_STATUS_ACK, {
      success: false,
      error: error.message,
    });

    sendMessage(socket, errorMessage);
  }
}
```

#### Step 3: 注册 Socket 事件监听器
在 `start()` 函数中注册事件：
```javascript
// Worker 命名空间事件监听
workerNamespace.on('connection', (socket) => {
  logger.info(`Worker attempting connection: ${socket.id}`);

  // 现有事件...
  socket.on(WORKER_REGISTER, (message) => workerRegistry.handleRegistration(socket, message));
  socket.on(WORKER_HEARTBEAT, (message) => heartbeatMonitor.handleHeartbeat(socket, message));
  socket.on(WORKER_MESSAGE_DETECTED, (message) => messageReceiver.handleMessage(socket, message));

  // 新增：账号状态上报
  socket.on(WORKER_ACCOUNT_STATUS, (message) => handleAccountStatus(socket, message));

  // ...其他事件
});
```

### 2. Worker 端实现状态上报

需要在 Worker 端创建账号状态上报器：

#### 创建文件: `packages/worker/src/handlers/account-status-reporter.js`
```javascript
const { createLogger } = require('@hiscrm-im/shared/utils/logger');
const { createMessage, sendMessage, WORKER_ACCOUNT_STATUS } = require('@hiscrm-im/shared/protocol/messages');

const logger = createLogger('account-status-reporter');

class AccountStatusReporter {
  constructor(socket, config) {
    this.socket = socket;
    this.reportInterval = config.worker.accountStatus.reportInterval || 60000;  // 1分钟
    this.batchSize = config.worker.accountStatus.batchSize || 50;
    this.accountStatuses = new Map();  // accountId -> status
    this.reportTimer = null;
  }

  /**
   * 启动定期上报
   */
  start() {
    if (this.reportTimer) {
      return;
    }

    logger.info(`Starting account status reporter (interval: ${this.reportInterval}ms)`);

    this.reportTimer = setInterval(() => {
      this.reportStatuses();
    }, this.reportInterval);
  }

  /**
   * 停止上报
   */
  stop() {
    if (this.reportTimer) {
      clearInterval(this.reportTimer);
      this.reportTimer = null;
      logger.info('Account status reporter stopped');
    }
  }

  /**
   * 更新账号状态（本地缓存）
   */
  updateAccountStatus(accountId, status) {
    this.accountStatuses.set(accountId, {
      account_id: accountId,
      status: {
        ...status,
        last_heartbeat_time: Math.floor(Date.now() / 1000),
      },
      timestamp: Date.now(),
    });
  }

  /**
   * 上报所有账号状态到 Master
   */
  async reportStatuses() {
    if (this.accountStatuses.size === 0) {
      logger.debug('No account statuses to report');
      return;
    }

    const statusArray = Array.from(this.accountStatuses.values());

    // 分批上报
    for (let i = 0; i < statusArray.length; i += this.batchSize) {
      const batch = statusArray.slice(i, i + this.batchSize);

      const message = createMessage(WORKER_ACCOUNT_STATUS, {
        worker_id: this.socket.workerId,
        account_statuses: batch,
      });

      try {
        sendMessage(this.socket, message);
        logger.debug(`Reported ${batch.length} account statuses to Master`);
      } catch (error) {
        logger.error('Failed to report account statuses:', error);
      }
    }
  }

  /**
   * 记录爬虫完成事件
   */
  recordCrawlComplete(accountId, stats) {
    this.updateAccountStatus(accountId, {
      worker_status: 'online',
      total_comments: stats.total_comments,
      total_works: stats.total_works,
      total_followers: stats.total_followers,
      total_following: stats.total_following,
      recent_comments_count: stats.recent_comments_count,
      recent_works_count: stats.recent_works_count,
      last_crawl_time: Math.floor(Date.now() / 1000),
    });
  }

  /**
   * 记录错误事件
   */
  recordError(accountId, errorMessage) {
    const currentStatus = this.accountStatuses.get(accountId);
    const errorCount = (currentStatus?.status?.error_count || 0) + 1;

    this.updateAccountStatus(accountId, {
      worker_status: 'error',
      error_count: errorCount,
      last_error_message: errorMessage,
    });
  }

  /**
   * 设置账号在线
   */
  setAccountOnline(accountId) {
    this.updateAccountStatus(accountId, {
      worker_status: 'online',
    });
  }

  /**
   * 设置账号离线
   */
  setAccountOffline(accountId) {
    this.updateAccountStatus(accountId, {
      worker_status: 'offline',
    });
  }
}

module.exports = AccountStatusReporter;
```

#### 在 Worker 主程序中集成
`packages/worker/src/index.js`:
```javascript
const AccountStatusReporter = require('./handlers/account-status-reporter');
const config = require('../../master/src/config');  // 使用统一配置

let accountStatusReporter;

async function start() {
  // ... 现有初始化代码

  // 初始化账号状态上报器
  accountStatusReporter = new AccountStatusReporter(socket, config);
  accountStatusReporter.start();
  logger.info('✓ Account status reporter started');

  // ... 其他代码
}

// 在任务执行完成后记录状态
// 例如在 monitor-task.js 中：
async function executeTask() {
  try {
    const result = await crawl(account);

    // 记录成功的爬虫统计
    accountStatusReporter.recordCrawlComplete(account.id, {
      total_comments: result.total_comments,
      total_works: result.total_works,
      // ...
    });
  } catch (error) {
    // 记录错误
    accountStatusReporter.recordError(account.id, error.message);
  }
}
```

### 3. API 端点实现

在 `packages/master/src/api/routes/accounts.js` 中添加：

```javascript
// 获取账号状态（用于前端监控面板）
router.get('/status', (req, res) => {
  try {
    const accounts = db.prepare(`
      SELECT
        a.id,
        a.account_name,
        a.platform,
        a.assigned_worker_id,
        a.worker_status,
        a.login_status,
        a.total_comments,
        a.total_works,
        a.total_followers,
        a.total_following,
        a.last_crawl_time,
        a.last_login_time,
        a.last_heartbeat_time,
        a.error_count,
        a.last_error_message,
        w.status as worker_online_status
      FROM accounts a
      LEFT JOIN workers w ON a.assigned_worker_id = w.id
      WHERE a.status = 'active'
      ORDER BY a.last_heartbeat_time DESC
    `).all();

    res.json({ success: true, data: accounts });
  } catch (error) {
    logger.error('Failed to get account statuses:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});
```

## 🧪 测试步骤

1. **启动 Master 服务**:
   ```bash
   cd packages/master
   npm start
   ```

2. **启动 Worker 服务**:
   ```bash
   cd packages/worker
   npm start
   ```

3. **观察日志**:
   - Master 日志应该显示: "Account status updater initialized"
   - Worker 日志应该显示: "Account status reporter started"
   - 每 1 分钟，Worker 应该上报账号状态
   - Master 应该记录: "Updated X account statuses from worker XXX"

4. **验证数据库**:
   ```bash
   sqlite3 packages/master/data/master.db
   SELECT id, account_name, worker_status, last_crawl_time, total_comments FROM accounts;
   ```

5. **测试 API**:
   ```bash
   curl http://localhost:3000/api/v1/accounts/status
   ```

## 📝 配置调整

可通过 `.env` 文件调整关键参数：

```bash
# 账号状态上报间隔（毫秒）
ACCOUNT_STATUS_REPORT_INTERVAL=60000

# 爬虫监控间隔范围（毫秒）
MONITOR_INTERVAL_MIN=15000
MONITOR_INTERVAL_MAX=30000
```

## 🔄 后续 UI 重构（待完成）

将 `packages/admin-web/src/pages/LoginManagementPage.js` 重构为账号监控面板：

### 新的列结构
| 列名 | 数据字段 | 说明 |
|------|---------|------|
| 账号名称 | account_name | - |
| 平台 | platform | douyin/weibo/xiaohongshu |
| Worker | assigned_worker_id | 显示分配的 Worker ID |
| 在线状态 | worker_status | 🟢 online / 🔴 offline / ⚠️ error |
| 登录状态 | login_status | 已登录/未登录 |
| 最后爬虫时间 | last_crawl_time | 格式: "2分钟前" |
| 最后登录时间 | last_login_time | 格式: "1小时前" |
| 评论数 | total_comments | 累计总数 |
| 作品数 | total_works | 累计总数 |
| 粉丝数 | total_followers | 格式化显示(如 10.2K) |
| 操作 | - | 查看详情按钮 |

### 数据获取
```javascript
// 使用新的 API 端点
const response = await axios.get('/api/v1/accounts/status');
```

## 📚 相关文档

- [数据库字典](./.docs/数据库字典.md)
- [系统使用指南](./.docs/系统使用指南.md)
- [Worker通用平台脚本系统设计方案](./.docs/worker-通用平台脚本系统设计方案.md)
