# è´¦å·çŠ¶æ€ç›‘æ§åŠŸèƒ½å®ç°æŒ‡å—

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å°†åŸ"ç™»å½•ç®¡ç†"é¡µé¢é‡æ„ä¸º"è´¦å·çŠ¶æ€ç›‘æ§é¢æ¿"ï¼Œå®æ—¶æ˜¾ç¤ºæ‰€æœ‰åœ¨çº¿ Worker ä¸­è´¦å·çš„è¿è¡ŒçŠ¶æ€ï¼ŒåŒ…æ‹¬ï¼š
- è´¦å·æ˜¯å¦åœ¨çº¿
- æœ€åçˆ¬è™«æ—¶é—´
- ç™»å½•æ—¶é—´
- è¯„è®ºæ•°ã€ä½œå“æ•°ç­‰ç»Ÿè®¡ä¿¡æ¯

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®åº“è¿ç§»
**æ–‡ä»¶**: `packages/master/src/database/migrations/005_add_account_runtime_stats.sql`

å·²æ·»åŠ ä»¥ä¸‹å­—æ®µåˆ° `accounts` è¡¨ï¼š
```sql
-- çˆ¬è™«ç»Ÿè®¡ä¿¡æ¯
total_comments INTEGER DEFAULT 0        -- æ€»è¯„è®ºæ•°
total_works INTEGER DEFAULT 0            -- æ€»ä½œå“æ•°
total_followers INTEGER DEFAULT 0        -- æ€»ç²‰ä¸æ•°
total_following INTEGER DEFAULT 0        -- æ€»å…³æ³¨æ•°

-- æœ€è¿‘çˆ¬å–ç»Ÿè®¡
recent_comments_count INTEGER DEFAULT 0  -- æœ€è¿‘ä¸€æ¬¡çˆ¬å–çš„è¯„è®ºæ•°
recent_works_count INTEGER DEFAULT 0     -- æœ€è¿‘ä¸€æ¬¡çˆ¬å–çš„ä½œå“æ•°

-- è¿è¡Œæ—¶çŠ¶æ€
worker_status TEXT DEFAULT 'offline'     -- Worker çŠ¶æ€: online/offline/error
last_crawl_time INTEGER                  -- æœ€åä¸€æ¬¡çˆ¬å–æ—¶é—´
last_heartbeat_time INTEGER              -- æœ€åä¸€æ¬¡å¿ƒè·³æ—¶é—´
error_count INTEGER DEFAULT 0            -- é”™è¯¯è®¡æ•°
last_error_message TEXT                  -- æœ€åçš„é”™è¯¯ä¿¡æ¯
```

### 2. æ¶ˆæ¯åè®®æ‰©å±•
**æ–‡ä»¶**: `packages/shared/protocol/messages.js`

æ·»åŠ äº†è´¦å·çŠ¶æ€ä¸ŠæŠ¥æ¶ˆæ¯ç±»å‹ï¼š
```javascript
const WORKER_ACCOUNT_STATUS = 'worker:account:status';          // Workerä¸ŠæŠ¥è´¦å·çŠ¶æ€
const WORKER_ACCOUNT_STATUS_ACK = 'worker:account:status:ack';  // Masterç¡®è®¤æ”¶åˆ°
```

### 3. è´¦å·çŠ¶æ€æ›´æ–°å™¨
**æ–‡ä»¶**: `packages/master/src/worker_manager/account-status-updater.js`

åˆ›å»ºäº† `AccountStatusUpdater` ç±»ï¼Œæä¾›ä»¥ä¸‹æ–¹æ³•ï¼š
- `updateAccountStatus(accountId, status)` - æ›´æ–°å•ä¸ªè´¦å·çŠ¶æ€
- `batchUpdateAccountStatuses(accountStatuses)` - æ‰¹é‡æ›´æ–°è´¦å·çŠ¶æ€
- `setAccountOnline(accountId)` - è®¾ç½®è´¦å·ä¸ºåœ¨çº¿
- `setAccountOffline(accountId)` - è®¾ç½®è´¦å·ä¸ºç¦»çº¿
- `setAccountError(accountId, errorMessage)` - è®¾ç½®è´¦å·ä¸ºé”™è¯¯çŠ¶æ€

### 4. ç»Ÿä¸€é…ç½®æ–‡ä»¶
**æ–‡ä»¶**: `packages/master/src/config/index.js`

å°†æ‰€æœ‰å¯é…ç½®å‚æ•°é›†ä¸­ç®¡ç†ï¼ŒåŒ…æ‹¬ï¼š
- **Worker ç®¡ç†é…ç½®**: å¿ƒè·³è¶…æ—¶ã€çŠ¶æ€ä¸ŠæŠ¥é—´éš”ã€ä»»åŠ¡åˆ†é…ç­‰
- **çˆ¬è™«é…ç½®**: ç›‘æ§é—´éš”ã€é‡è¯•ç­–ç•¥ã€è¶…æ—¶è®¾ç½®ã€åçˆ¬è™«è®¾ç½®
- **æµè§ˆå™¨é…ç½®**: headless æ¨¡å¼ã€èµ„æºé™åˆ¶ç­‰
- **ç™»å½•é…ç½®**: äºŒç»´ç åˆ·æ–°ã€ä¼šè¯ç®¡ç†ã€Cookie ç®¡ç†
- **é€šçŸ¥é…ç½®**: é˜Ÿåˆ—å¤„ç†ã€ä¼˜å…ˆçº§ç­‰
- **æ—¥å¿—é…ç½®**: æ—¥å¿—çº§åˆ«ã€ç›®å½•ã€æ–‡ä»¶ç®¡ç†
- **æ€§èƒ½ç›‘æ§é…ç½®**: æŒ‡æ ‡é‡‡é›†ã€å‘Šè­¦é˜ˆå€¼

**å…³é”®é…ç½®å‚æ•°**ï¼š
```javascript
worker: {
  accountStatus: {
    reportInterval: 60000,  // è´¦å·çŠ¶æ€ä¸ŠæŠ¥é—´éš”(ms) - 1åˆ†é’Ÿ
    batchSize: 50,          // æ‰¹é‡ä¸ŠæŠ¥æœ€å¤§è´¦å·æ•°
  },
},

crawler: {
  monitorInterval: {
    min: 15000,   // æœ€å°ç›‘æ§é—´éš”(ms) - 15ç§’
    max: 30000,   // æœ€å¤§ç›‘æ§é—´éš”(ms) - 30ç§’
    default: 30000,  // é»˜è®¤ç›‘æ§é—´éš”(ms)
  },
},
```

### 5. ç¯å¢ƒå˜é‡é…ç½®
**æ–‡ä»¶**: `packages/master/.env.example`

æ›´æ–°äº†å®Œæ•´çš„ç¯å¢ƒå˜é‡é…ç½®ç¤ºä¾‹ï¼ŒåŒ…å«æ‰€æœ‰å¯è°ƒå‚æ•°ã€‚

## ğŸš§ å¾…å®Œæˆçš„å·¥ä½œ

### 1. Master ç«¯é›†æˆè´¦å·çŠ¶æ€æ¥æ”¶

éœ€è¦åœ¨ `packages/master/src/index.js` ä¸­å®Œæˆä»¥ä¸‹é›†æˆï¼š

#### Step 1: åˆå§‹åŒ– AccountStatusUpdater
```javascript
// åœ¨ start() å‡½æ•°ä¸­æ·»åŠ 
const config = require('./config');
accountStatusUpdater = new AccountStatusUpdater(db);
logger.info('Account status updater initialized');
```

#### Step 2: æ·»åŠ è´¦å·çŠ¶æ€æ¶ˆæ¯å¤„ç†å‡½æ•°
```javascript
/**
 * å¤„ç† Worker ä¸ŠæŠ¥çš„è´¦å·çŠ¶æ€
 */
function handleAccountStatus(socket, message) {
  const { worker_id, account_statuses } = message.payload;

  try {
    logger.debug(`Received account status from worker ${worker_id}`, {
      accountCount: account_statuses?.length,
    });

    if (!Array.isArray(account_statuses)) {
      throw new Error('account_statuses must be an array');
    }

    // æ‰¹é‡æ›´æ–°è´¦å·çŠ¶æ€
    const result = accountStatusUpdater.batchUpdateAccountStatuses(
      account_statuses.map(item => ({
        account_id: item.account_id,
        status: item.status,
      }))
    );

    // å‘é€ç¡®è®¤æ¶ˆæ¯
    const ackMessage = createMessage(WORKER_ACCOUNT_STATUS_ACK, {
      success: true,
      updated: result.successCount,
      failed: result.failureCount,
    });

    sendMessage(socket, ackMessage);

    logger.info(`Updated ${result.successCount} account statuses from worker ${worker_id}`);
  } catch (error) {
    logger.error(`Failed to handle account status from worker ${worker_id}:`, error);

    const errorMessage = createMessage(WORKER_ACCOUNT_STATUS_ACK, {
      success: false,
      error: error.message,
    });

    sendMessage(socket, errorMessage);
  }
}
```

#### Step 3: æ³¨å†Œ Socket äº‹ä»¶ç›‘å¬å™¨
åœ¨ `start()` å‡½æ•°ä¸­æ³¨å†Œäº‹ä»¶ï¼š
```javascript
// Worker å‘½åç©ºé—´äº‹ä»¶ç›‘å¬
workerNamespace.on('connection', (socket) => {
  logger.info(`Worker attempting connection: ${socket.id}`);

  // ç°æœ‰äº‹ä»¶...
  socket.on(WORKER_REGISTER, (message) => workerRegistry.handleRegistration(socket, message));
  socket.on(WORKER_HEARTBEAT, (message) => heartbeatMonitor.handleHeartbeat(socket, message));
  socket.on(WORKER_MESSAGE_DETECTED, (message) => messageReceiver.handleMessage(socket, message));

  // æ–°å¢ï¼šè´¦å·çŠ¶æ€ä¸ŠæŠ¥
  socket.on(WORKER_ACCOUNT_STATUS, (message) => handleAccountStatus(socket, message));

  // ...å…¶ä»–äº‹ä»¶
});
```

### 2. Worker ç«¯å®ç°çŠ¶æ€ä¸ŠæŠ¥

éœ€è¦åœ¨ Worker ç«¯åˆ›å»ºè´¦å·çŠ¶æ€ä¸ŠæŠ¥å™¨ï¼š

#### åˆ›å»ºæ–‡ä»¶: `packages/worker/src/handlers/account-status-reporter.js`
```javascript
const { createLogger } = require('@hiscrm-im/shared/utils/logger');
const { createMessage, sendMessage, WORKER_ACCOUNT_STATUS } = require('@hiscrm-im/shared/protocol/messages');

const logger = createLogger('account-status-reporter');

class AccountStatusReporter {
  constructor(socket, config) {
    this.socket = socket;
    this.reportInterval = config.worker.accountStatus.reportInterval || 60000;  // 1åˆ†é’Ÿ
    this.batchSize = config.worker.accountStatus.batchSize || 50;
    this.accountStatuses = new Map();  // accountId -> status
    this.reportTimer = null;
  }

  /**
   * å¯åŠ¨å®šæœŸä¸ŠæŠ¥
   */
  start() {
    if (this.reportTimer) {
      return;
    }

    logger.info(`Starting account status reporter (interval: ${this.reportInterval}ms)`);

    this.reportTimer = setInterval(() => {
      this.reportStatuses();
    }, this.reportInterval);
  }

  /**
   * åœæ­¢ä¸ŠæŠ¥
   */
  stop() {
    if (this.reportTimer) {
      clearInterval(this.reportTimer);
      this.reportTimer = null;
      logger.info('Account status reporter stopped');
    }
  }

  /**
   * æ›´æ–°è´¦å·çŠ¶æ€ï¼ˆæœ¬åœ°ç¼“å­˜ï¼‰
   */
  updateAccountStatus(accountId, status) {
    this.accountStatuses.set(accountId, {
      account_id: accountId,
      status: {
        ...status,
        last_heartbeat_time: Math.floor(Date.now() / 1000),
      },
      timestamp: Date.now(),
    });
  }

  /**
   * ä¸ŠæŠ¥æ‰€æœ‰è´¦å·çŠ¶æ€åˆ° Master
   */
  async reportStatuses() {
    if (this.accountStatuses.size === 0) {
      logger.debug('No account statuses to report');
      return;
    }

    const statusArray = Array.from(this.accountStatuses.values());

    // åˆ†æ‰¹ä¸ŠæŠ¥
    for (let i = 0; i < statusArray.length; i += this.batchSize) {
      const batch = statusArray.slice(i, i + this.batchSize);

      const message = createMessage(WORKER_ACCOUNT_STATUS, {
        worker_id: this.socket.workerId,
        account_statuses: batch,
      });

      try {
        sendMessage(this.socket, message);
        logger.debug(`Reported ${batch.length} account statuses to Master`);
      } catch (error) {
        logger.error('Failed to report account statuses:', error);
      }
    }
  }

  /**
   * è®°å½•çˆ¬è™«å®Œæˆäº‹ä»¶
   */
  recordCrawlComplete(accountId, stats) {
    this.updateAccountStatus(accountId, {
      worker_status: 'online',
      total_comments: stats.total_comments,
      total_works: stats.total_works,
      total_followers: stats.total_followers,
      total_following: stats.total_following,
      recent_comments_count: stats.recent_comments_count,
      recent_works_count: stats.recent_works_count,
      last_crawl_time: Math.floor(Date.now() / 1000),
    });
  }

  /**
   * è®°å½•é”™è¯¯äº‹ä»¶
   */
  recordError(accountId, errorMessage) {
    const currentStatus = this.accountStatuses.get(accountId);
    const errorCount = (currentStatus?.status?.error_count || 0) + 1;

    this.updateAccountStatus(accountId, {
      worker_status: 'error',
      error_count: errorCount,
      last_error_message: errorMessage,
    });
  }

  /**
   * è®¾ç½®è´¦å·åœ¨çº¿
   */
  setAccountOnline(accountId) {
    this.updateAccountStatus(accountId, {
      worker_status: 'online',
    });
  }

  /**
   * è®¾ç½®è´¦å·ç¦»çº¿
   */
  setAccountOffline(accountId) {
    this.updateAccountStatus(accountId, {
      worker_status: 'offline',
    });
  }
}

module.exports = AccountStatusReporter;
```

#### åœ¨ Worker ä¸»ç¨‹åºä¸­é›†æˆ
`packages/worker/src/index.js`:
```javascript
const AccountStatusReporter = require('./handlers/account-status-reporter');
const config = require('../../master/src/config');  // ä½¿ç”¨ç»Ÿä¸€é…ç½®

let accountStatusReporter;

async function start() {
  // ... ç°æœ‰åˆå§‹åŒ–ä»£ç 

  // åˆå§‹åŒ–è´¦å·çŠ¶æ€ä¸ŠæŠ¥å™¨
  accountStatusReporter = new AccountStatusReporter(socket, config);
  accountStatusReporter.start();
  logger.info('âœ“ Account status reporter started');

  // ... å…¶ä»–ä»£ç 
}

// åœ¨ä»»åŠ¡æ‰§è¡Œå®Œæˆåè®°å½•çŠ¶æ€
// ä¾‹å¦‚åœ¨ monitor-task.js ä¸­ï¼š
async function executeTask() {
  try {
    const result = await crawl(account);

    // è®°å½•æˆåŠŸçš„çˆ¬è™«ç»Ÿè®¡
    accountStatusReporter.recordCrawlComplete(account.id, {
      total_comments: result.total_comments,
      total_works: result.total_works,
      // ...
    });
  } catch (error) {
    // è®°å½•é”™è¯¯
    accountStatusReporter.recordError(account.id, error.message);
  }
}
```

### 3. API ç«¯ç‚¹å®ç°

åœ¨ `packages/master/src/api/routes/accounts.js` ä¸­æ·»åŠ ï¼š

```javascript
// è·å–è´¦å·çŠ¶æ€ï¼ˆç”¨äºå‰ç«¯ç›‘æ§é¢æ¿ï¼‰
router.get('/status', (req, res) => {
  try {
    const accounts = db.prepare(`
      SELECT
        a.id,
        a.account_name,
        a.platform,
        a.assigned_worker_id,
        a.worker_status,
        a.login_status,
        a.total_comments,
        a.total_works,
        a.total_followers,
        a.total_following,
        a.last_crawl_time,
        a.last_login_time,
        a.last_heartbeat_time,
        a.error_count,
        a.last_error_message,
        w.status as worker_online_status
      FROM accounts a
      LEFT JOIN workers w ON a.assigned_worker_id = w.id
      WHERE a.status = 'active'
      ORDER BY a.last_heartbeat_time DESC
    `).all();

    res.json({ success: true, data: accounts });
  } catch (error) {
    logger.error('Failed to get account statuses:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});
```

## ğŸ§ª æµ‹è¯•æ­¥éª¤

1. **å¯åŠ¨ Master æœåŠ¡**:
   ```bash
   cd packages/master
   npm start
   ```

2. **å¯åŠ¨ Worker æœåŠ¡**:
   ```bash
   cd packages/worker
   npm start
   ```

3. **è§‚å¯Ÿæ—¥å¿—**:
   - Master æ—¥å¿—åº”è¯¥æ˜¾ç¤º: "Account status updater initialized"
   - Worker æ—¥å¿—åº”è¯¥æ˜¾ç¤º: "Account status reporter started"
   - æ¯ 1 åˆ†é’Ÿï¼ŒWorker åº”è¯¥ä¸ŠæŠ¥è´¦å·çŠ¶æ€
   - Master åº”è¯¥è®°å½•: "Updated X account statuses from worker XXX"

4. **éªŒè¯æ•°æ®åº“**:
   ```bash
   sqlite3 packages/master/data/master.db
   SELECT id, account_name, worker_status, last_crawl_time, total_comments FROM accounts;
   ```

5. **æµ‹è¯• API**:
   ```bash
   curl http://localhost:3000/api/v1/accounts/status
   ```

## ğŸ“ é…ç½®è°ƒæ•´

å¯é€šè¿‡ `.env` æ–‡ä»¶è°ƒæ•´å…³é”®å‚æ•°ï¼š

```bash
# è´¦å·çŠ¶æ€ä¸ŠæŠ¥é—´éš”ï¼ˆæ¯«ç§’ï¼‰
ACCOUNT_STATUS_REPORT_INTERVAL=60000

# çˆ¬è™«ç›‘æ§é—´éš”èŒƒå›´ï¼ˆæ¯«ç§’ï¼‰
MONITOR_INTERVAL_MIN=15000
MONITOR_INTERVAL_MAX=30000
```

## ğŸ”„ åç»­ UI é‡æ„ï¼ˆå¾…å®Œæˆï¼‰

å°† `packages/admin-web/src/pages/LoginManagementPage.js` é‡æ„ä¸ºè´¦å·ç›‘æ§é¢æ¿ï¼š

### æ–°çš„åˆ—ç»“æ„
| åˆ—å | æ•°æ®å­—æ®µ | è¯´æ˜ |
|------|---------|------|
| è´¦å·åç§° | account_name | - |
| å¹³å° | platform | douyin/weibo/xiaohongshu |
| Worker | assigned_worker_id | æ˜¾ç¤ºåˆ†é…çš„ Worker ID |
| åœ¨çº¿çŠ¶æ€ | worker_status | ğŸŸ¢ online / ğŸ”´ offline / âš ï¸ error |
| ç™»å½•çŠ¶æ€ | login_status | å·²ç™»å½•/æœªç™»å½• |
| æœ€åçˆ¬è™«æ—¶é—´ | last_crawl_time | æ ¼å¼: "2åˆ†é’Ÿå‰" |
| æœ€åç™»å½•æ—¶é—´ | last_login_time | æ ¼å¼: "1å°æ—¶å‰" |
| è¯„è®ºæ•° | total_comments | ç´¯è®¡æ€»æ•° |
| ä½œå“æ•° | total_works | ç´¯è®¡æ€»æ•° |
| ç²‰ä¸æ•° | total_followers | æ ¼å¼åŒ–æ˜¾ç¤º(å¦‚ 10.2K) |
| æ“ä½œ | - | æŸ¥çœ‹è¯¦æƒ…æŒ‰é’® |

### æ•°æ®è·å–
```javascript
// ä½¿ç”¨æ–°çš„ API ç«¯ç‚¹
const response = await axios.get('/api/v1/accounts/status');
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“å­—å…¸](./.docs/æ•°æ®åº“å­—å…¸.md)
- [ç³»ç»Ÿä½¿ç”¨æŒ‡å—](./.docs/ç³»ç»Ÿä½¿ç”¨æŒ‡å—.md)
- [Workeré€šç”¨å¹³å°è„šæœ¬ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ](./.docs/worker-é€šç”¨å¹³å°è„šæœ¬ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ.md)
