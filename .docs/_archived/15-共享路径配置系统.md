# å…±äº«è·¯å¾„é…ç½®ç³»ç»Ÿ

## ğŸ¯ æ¦‚è¿°

ä¸ºäº†è§£å†³è·¯å¾„é…ç½®çš„åˆ†æ•£é—®é¢˜ï¼Œç³»ç»Ÿå®ç°äº†ç»Ÿä¸€çš„å…±äº«è·¯å¾„é…ç½®æ¨¡å—ï¼Œç¡®ä¿ Master å’Œ Worker éƒ½èƒ½é€šè¿‡åŒä¸€ä¸ªé…ç½®æºè·å–å…³é”®è·¯å¾„ä¿¡æ¯ï¼Œé¿å…è·¯å¾„ç¡¬ç¼–ç å¸¦æ¥çš„ç»´æŠ¤å›°éš¾ã€‚

---

## ğŸ“¦ æ ¸å¿ƒæ–‡ä»¶

### 1. å…±äº«é…ç½®æ¨¡å—
**æ–‡ä»¶**: `packages/shared/config/paths.js`

```javascript
/**
 * æ‰€æœ‰è·¯å¾„é…ç½®ï¼ˆç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•ï¼‰
 */
const PATHS = {
  // é¡¹ç›®æ ¹ç›®å½•
  project_root: PROJECT_ROOT,

  // Master ç›¸å…³
  master: {
    src: path.join(PROJECT_ROOT, 'packages/master/src'),
    data: path.join(PROJECT_ROOT, 'packages/master/data'),
    logs: path.join(PROJECT_ROOT, 'packages/master/logs'),
    database: path.join(PROJECT_ROOT, 'packages/master/data/master.db'),
  },

  // Worker ç›¸å…³
  worker: {
    src: path.join(PROJECT_ROOT, 'packages/worker/src'),
    data: path.join(PROJECT_ROOT, 'packages/worker/data'),
    logs: path.join(PROJECT_ROOT, 'packages/worker/logs'),
    // â­ å…³é”®ï¼šå¹³å°ç›®å½•çš„ç»Ÿä¸€é…ç½®
    platforms: path.join(PROJECT_ROOT, 'packages/worker/src/platforms'),
  },

  // å…¶ä»–ç›¸å…³
  admin: { /* ... */ },
  shared: { /* ... */ },
  docs: { /* ... */ },
};
```

**ç‰¹ç‚¹**:
- âœ… æ‰€æœ‰è·¯å¾„éƒ½ç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•è®¡ç®—
- âœ… è‡ªåŠ¨è®¡ç®— `PROJECT_ROOT` (ä» packages/shared/config å‘ä¸Š4å±‚)
- âœ… åŒ…å«è¾…åŠ©å‡½æ•°: `validatePath()`, `getRelativePath()`
- âœ… ä¸€å¤„å®šä¹‰ï¼Œå…¨å±€ä½¿ç”¨

---

## ğŸ”Œ é›†æˆç‚¹

### Master ç«¯ - å¹³å° API è·¯ç”±
**æ–‡ä»¶**: `packages/master/src/api/routes/platforms.js`

```javascript
// âœ… å¯¼å…¥å…±äº«é…ç½®
const { PATHS } = require('@hiscrm-im/shared/config/paths');

/**
 * ä»æ–‡ä»¶ç³»ç»Ÿæ‰«ææ‰€æœ‰å¯ç”¨çš„å¹³å°
 */
function scanAvailablePlatforms() {
  const platformsSet = new Map();

  try {
    // âœ… ä½¿ç”¨å…±äº«é…ç½®ä¸­çš„å¹³å°è·¯å¾„
    const platformsDir = PATHS.worker.platforms;

    logger.debug(`Scanning platforms directory: ${platformsDir}`);

    if (!fs.existsSync(platformsDir)) {
      logger.warn(`Worker platforms directory not found at: ${platformsDir}`);
      return platformsSet;
    }

    // ... æ‰«æç›®å½•å’ŒåŠ è½½ config.json
  }
}
```

**æ”¹è¿›**:
- ä¹‹å‰: ä½¿ç”¨ç›¸å¯¹è·¯å¾„ `path.join(__dirname, '../../../../../...')`
- ç°åœ¨: ä½¿ç”¨å…±äº«é…ç½® `PATHS.worker.platforms`
- ä¼˜åŠ¿: è·¯å¾„è®¡ç®—ç»Ÿä¸€ã€ç»´æŠ¤æ›´å®¹æ˜“ã€ä¸æ˜“å‡ºé”™

---

### Worker ç«¯ - å¹³å°ç®¡ç†å™¨
**æ–‡ä»¶**: `packages/worker/src/platform-manager.js`

```javascript
// âœ… å¯¼å…¥å…±äº«é…ç½®
const { PATHS } = require('@hiscrm-im/shared/config/paths');

class PlatformManager {
  /**
   * è‡ªåŠ¨æ‰«æå¹¶åŠ è½½å¹³å°è„šæœ¬
   * ä½¿ç”¨å…±äº«çš„è·¯å¾„é…ç½®ç¡®ä¿ Master å’Œ Worker ä½¿ç”¨ç›¸åŒçš„å¹³å°ç›®å½•
   */
  async loadPlatforms() {
    // âœ… ä½¿ç”¨å…±äº«é…ç½®è€Œä¸æ˜¯ç¡¬ç¼–ç 
    const platformsDir = PATHS.worker.platforms;

    try {
      const entries = fs.readdirSync(platformsDir, { withFileTypes: true });

      for (const entry of entries) {
        // ... åŠ è½½å¹³å°
      }
    }
  }
}
```

**æ”¹è¿›**:
- ä¹‹å‰: `const platformsDir = path.join(__dirname, 'platforms');`
- ç°åœ¨: `const platformsDir = PATHS.worker.platforms;`
- ä¼˜åŠ¿: ä¸ Master ä½¿ç”¨å®Œå…¨ç›¸åŒçš„è·¯å¾„é…ç½®

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Shared Path Configuration          â”‚
â”‚  packages/shared/config/paths.js        â”‚
â”‚                                         â”‚
â”‚  const PATHS = {                        â”‚
â”‚    worker: {                            â”‚
â”‚      platforms: '/full/path/...'        â”‚
â”‚    }                                    â”‚
â”‚  }                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â–²                â–²
              â”‚                â”‚
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
              â”‚                â”‚
              â”‚                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Master        â”‚   â”‚   Worker     â”‚
    â”‚                 â”‚   â”‚              â”‚
    â”‚ platforms.js    â”‚   â”‚ platform-    â”‚
    â”‚ æ‰«æå¹³å°        â”‚   â”‚ manager.js   â”‚
    â”‚                 â”‚   â”‚ åŠ è½½å¹³å°     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š æ”¹è¿›å¯¹æ¯”

### ä¿®æ”¹å‰ - åˆ†æ•£çš„è·¯å¾„é…ç½®

| ç»„ä»¶ | è·¯å¾„å®šä¹‰æ–¹å¼ | é—®é¢˜ |
|------|-----------|------|
| Master platforms.js | å¤æ‚ç›¸å¯¹è·¯å¾„è®¡ç®— | âŒ å®¹æ˜“å‡ºé”™ï¼Œéš¾ä»¥ç»´æŠ¤ |
| Worker platform-manager.js | ç®€å•ç›¸å¯¹è·¯å¾„ | âŒ ä¸ Master ä¸ä¸€è‡´ |
| Admin Web | ç¡¬ç¼–ç  API åœ°å€ | âŒ æ— æ³•å…±äº«é…ç½® |

### ä¿®æ”¹å - ç»Ÿä¸€çš„å…±äº«é…ç½®

| ç»„ä»¶ | è·¯å¾„å®šä¹‰æ–¹å¼ | ä¼˜ç‚¹ |
|------|-----------|------|
| Master platforms.js | å…±äº«é…ç½® `PATHS.worker.platforms` | âœ… ç»Ÿä¸€ã€æ¸…æ™°ã€æ˜“ç»´æŠ¤ |
| Worker platform-manager.js | å…±äº«é…ç½® `PATHS.worker.platforms` | âœ… å®Œå…¨ä¸€è‡´ |
| Admin Web | é€šè¿‡ Master API åŠ¨æ€è·å– | âœ… æ— éœ€å…³å¿ƒè·¯å¾„ |

---

## ğŸ¯ å…³é”®æ”¹è¿›ç‚¹

### 1. å•ä¸€æ•°æ®æº (Single Source of Truth)
```javascript
// âŒ ä¿®æ”¹å‰ï¼šæ¯ä¸ªåœ°æ–¹éƒ½éœ€è¦å®šä¹‰è·¯å¾„
// Master: path.join(__dirname, '../../../../../...')
// Worker: path.join(__dirname, 'platforms')

// âœ… ä¿®æ”¹åï¼šç»Ÿä¸€ä½¿ç”¨å…±äº«é…ç½®
// Master: PATHS.worker.platforms
// Worker: PATHS.worker.platforms
```

### 2. è·¯å¾„è®¡ç®—é›†ä¸­åŒ–
```javascript
// âœ… packages/shared/config/paths.js
function getProjectRoot() {
  // è‡ªåŠ¨è®¡ç®—é¡¹ç›®æ ¹ç›®å½•
  return path.resolve(__dirname, '../../../');
}

const PROJECT_ROOT = getProjectRoot();

const PATHS = {
  worker: {
    platforms: path.join(PROJECT_ROOT, 'packages/worker/src/platforms'),
  }
};
```

### 3. å¯æ‰©å±•çš„é…ç½®ç»“æ„
```javascript
// âœ… å·²æ”¯æŒçš„è·¯å¾„
PATHS.master.database
PATHS.master.logs
PATHS.worker.platforms
PATHS.worker.data
PATHS.shared.utils

// âœ… æœªæ¥å¯æ·»åŠ 
PATHS.worker.cache
PATHS.worker.screenshots
PATHS.admin.uploads
```

---

## ğŸš€ å¦‚ä½•ä½¿ç”¨

### åœ¨ä»»ä½•æ¨¡å—ä¸­å¯¼å…¥å…±äº«é…ç½®

```javascript
// âœ… å¯¼å…¥
const { PATHS, getProjectRoot, validatePath } =
  require('@hiscrm-im/shared/config/paths');

// âœ… ä½¿ç”¨å¹³å°ç›®å½•
const platformsDir = PATHS.worker.platforms;

// âœ… ä½¿ç”¨æ•°æ®åº“è·¯å¾„
const dbPath = PATHS.master.database;

// âœ… éªŒè¯è·¯å¾„æ˜¯å¦å­˜åœ¨
validatePath('platforms', PATHS.worker.platforms);

// âœ… è·å–é¡¹ç›®æ ¹ç›®å½•
const rootDir = getProjectRoot();

// âœ… è·å–ç›¸å¯¹è·¯å¾„
const relativePath = getRelativePath(PATHS.worker.platforms);
```

---

## ğŸ“ ä¿®æ”¹æ¸…å•

| æ–‡ä»¶ | æ”¹åŠ¨ | ç›®çš„ |
|------|------|------|
| `packages/shared/config/paths.js` | æ–°å»º | ç»Ÿä¸€è·¯å¾„é…ç½® |
| `packages/master/src/api/routes/platforms.js` | å¯¼å…¥ PATHSï¼Œæ›´æ–° scanAvailablePlatforms() | ä½¿ç”¨å…±äº«é…ç½® |
| `packages/worker/src/platform-manager.js` | å¯¼å…¥ PATHSï¼Œæ›´æ–° loadPlatforms() | ä½¿ç”¨å…±äº«é…ç½® |

---

## âœ¨ åç»­æ‰©å±•å»ºè®®

### 1. ç¯å¢ƒç‰¹å®šé…ç½®
```javascript
// å¯åœ¨å…±äº«é…ç½®ä¸­æ·»åŠ ç¯å¢ƒæ„ŸçŸ¥
const PATHS = {
  isDevelopment: process.env.NODE_ENV !== 'production',
  isProduction: process.env.NODE_ENV === 'production',

  // æ ¹æ®ç¯å¢ƒä½¿ç”¨ä¸åŒçš„é…ç½®
  database: process.env.NODE_ENV === 'production'
    ? '/var/data/master.db'
    : path.join(PROJECT_ROOT, 'packages/master/data/master.db'),
};
```

### 2. é…ç½®éªŒè¯
```javascript
// å¯åŠ¨æ—¶éªŒè¯æ‰€æœ‰å…³é”®è·¯å¾„
function validateAllPaths() {
  const criticalPaths = [
    PATHS.worker.platforms,
    PATHS.master.database,
  ];

  criticalPaths.forEach(p => validatePath(p));
}
```

### 3. åŠ¨æ€è·¯å¾„æ³¨å†Œ
```javascript
// å…è®¸è¿è¡Œæ—¶æ³¨å†Œæ–°è·¯å¾„
PATHS.register('cache', path.join(PROJECT_ROOT, '.cache'));
```

---

## ğŸ”„ æµ‹è¯•éªŒè¯

### 1. éªŒè¯ Master èƒ½æ­£ç¡®æ‰«æå¹³å°

```bash
# å¯åŠ¨ Master
cd packages/master
npm start

# æŸ¥çœ‹æ—¥å¿—
# åº”è¯¥çœ‹åˆ°ç±»ä¼¼çš„è¾“å‡ºï¼š
# Scanning platforms directory: /full/path/to/packages/worker/src/platforms
# Found 2 entries in platforms directory
# Found platform: douyin (æŠ–éŸ³)
# Found platform: xiaohongshu (å°çº¢ä¹¦)
```

### 2. éªŒè¯ Worker èƒ½æ­£ç¡®åŠ è½½å¹³å°

```bash
# å¯åŠ¨ Worker
cd packages/worker
npm start

# æŸ¥çœ‹æ—¥å¿—
# åº”è¯¥çœ‹åˆ°ç±»ä¼¼çš„è¾“å‡ºï¼š
# âœ“ Loaded platform: æŠ–éŸ³ (douyin) v1.0.0
# âœ“ Loaded platform: å°çº¢ä¹¦ (xiaohongshu) v1.0.0
# Platform manager initialized with 2 platforms
```

### 3. éªŒè¯ Admin Web æ˜¾ç¤ºæ­£ç¡®çš„å¹³å°åˆ—è¡¨

```bash
# å¯åŠ¨ Admin Web
cd packages/admin-web
npm start

# æ‰“å¼€ http://localhost:3001/accounts
# ç‚¹å‡»"æ–°å»ºè´¦æˆ·"
# éªŒè¯å¹³å°ä¸‹æ‹‰æ¡†æ˜¾ç¤ºï¼š
# - æŠ–éŸ³
# - å°çº¢ä¹¦
# éƒ½åº”è¯¥å‡ºç°ï¼
```

---

## ğŸ’¡ æŠ€æœ¯ç»†èŠ‚

### è·¯å¾„è®¡ç®—è¿‡ç¨‹

```
packages/shared/config/paths.js çš„ä½ç½®:
e:\HISCRM-IM-main\packages\shared\config\paths.js

__dirname = e:\HISCRM-IM-main\packages\shared\config

path.resolve(__dirname, '../../../') è®¡ç®—:
  ../config â†’ e:\HISCRM-IM-main\packages\shared
  ../shared â†’ e:\HISCRM-IM-main\packages
  ../packages â†’ e:\HISCRM-IM-main

PROJECT_ROOT = e:\HISCRM-IM-main

PATHS.worker.platforms =
  path.join(PROJECT_ROOT, 'packages/worker/src/platforms')
  = e:\HISCRM-IM-main\packages\worker\src\platforms
```

### ä¸ºä»€ä¹ˆéœ€è¦å…±äº«é…ç½®ï¼Ÿ

1. **ä¸€è‡´æ€§**: Master å’Œ Worker å¿…é¡»è®¿é—®ç›¸åŒçš„å¹³å°ç›®å½•
2. **å¯ç»´æŠ¤æ€§**: å¦‚æœç›®å½•ç»“æ„æ”¹å˜ï¼Œåªéœ€ä¿®æ”¹ä¸€å¤„
3. **å¯æµ‹è¯•æ€§**: æ˜“äºåœ¨æµ‹è¯•æ—¶æ›¿æ¢è·¯å¾„
4. **å¯æ‰©å±•æ€§**: æœªæ¥å¯æ·»åŠ æ›´å¤šé…ç½®é€‰é¡¹

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [12-å¤šå¹³å°åŠ¨æ€é…ç½®å®ç°.md](./12-å¤šå¹³å°åŠ¨æ€é…ç½®å®ç°.md) - åŠ¨æ€å¹³å°åŠ è½½æ–¹æ¡ˆ
- [13-å¤šå¹³å°åŠ¨æ€é…ç½®ä¿®å¤.md](./13-å¤šå¹³å°åŠ¨æ€é…ç½®ä¿®å¤.md) - æ–‡ä»¶ç³»ç»Ÿæ‰«æä¿®å¤

---

## âœ… å®Œæˆæ¸…å•

- âœ… åˆ›å»ºå…±äº«è·¯å¾„é…ç½®æ¨¡å— (`packages/shared/config/paths.js`)
- âœ… æ›´æ–° Master å¹³å° API ä½¿ç”¨å…±äº«é…ç½®
- âœ… æ›´æ–° Worker å¹³å°ç®¡ç†å™¨ä½¿ç”¨å…±äº«é…ç½®
- âœ… éªŒè¯ Master å’Œ Worker ä½¿ç”¨ä¸€è‡´çš„è·¯å¾„
- âœ… åˆ›å»ºæ­¤æ–‡æ¡£è¯´æ˜æ¶æ„æ”¹è¿›

---

**å®Œæˆæ—¥æœŸ**: 2025-10-20
**æ–¹æ¡ˆ**: å…±äº«è·¯å¾„é…ç½®ç³»ç»Ÿ
**çŠ¶æ€**: âœ… å®ç°å®Œæˆ

ç³»ç»Ÿç°åœ¨é€šè¿‡å•ä¸€çš„å…±äº«è·¯å¾„é…ç½®ï¼Œç¡®ä¿ Master å’Œ Worker éƒ½èƒ½æ­£ç¡®å‘ç°å’ŒåŠ è½½å¹³å°ï¼Œè·¯å¾„ä¸å†åˆ†æ•£ï¼Œç»´æŠ¤æ›´åŠ ç®€å•ï¼
