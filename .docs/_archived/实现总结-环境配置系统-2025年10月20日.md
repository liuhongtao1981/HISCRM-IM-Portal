# å®ç°æ€»ç»“ - ç¯å¢ƒæ„ŸçŸ¥é…ç½®ç³»ç»Ÿ

> ä»è·¯å¾„ç¡¬ç¼–ç ï¼Œåˆ°ä¸‰å±‚é…ç½®ç³»ç»Ÿï¼Œå®Œå…¨è§£å†³æ‰“åŒ…éƒ¨ç½²çš„è·¯å¾„é—®é¢˜

---

## ğŸ¯ ç”¨æˆ·é—®é¢˜

ç”¨æˆ·æå‡ºçš„æ ¸å¿ƒé—®é¢˜ï¼š
> "shared çš„é…ç½®å†™æ­»åï¼Œæˆ‘ä»¬æ‰“åŒ…å‘å¸ƒçš„æ—¶å€™æ€ä¹ˆåŠï¼Œè·¯å¾„ä¹Ÿä¸æ˜¯å›ºå®šçš„ï¼Œè¿˜å¾—éœ€è¦ä¸€ä¸ªå…¬ç”¨çš„é…ç½®æ–‡ä»¶"

**å«ä¹‰**:
- ç°åœ¨çš„è·¯å¾„ç¡¬ç¼–ç åœ¨ Python ä»£ç ä¸­
- æ‰“åŒ…åå®‰è£…è·¯å¾„å¯èƒ½ä¸åŒ
- éœ€è¦ä¸€ä¸ªå¤–éƒ¨é…ç½®æ–‡ä»¶æ¥åŠ¨æ€æŒ‡å®šè·¯å¾„
- éœ€è¦æ”¯æŒå¤šç¯å¢ƒéƒ¨ç½²

---

## âœ… å®Œæ•´è§£å†³æ–¹æ¡ˆ

### 1. ä¸‰å±‚é…ç½®ç³»ç»Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ 1 å±‚: ç¯å¢ƒå˜é‡            â”‚ æœ€é«˜ä¼˜å…ˆçº§
â”‚ (APP_ROOT, CONFIG_FILE...)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ 2 å±‚: config.json        â”‚ ä¸­ä¼˜å…ˆçº§
â”‚ (é¡¹ç›®æ ¹ç›®å½•æˆ– /etc ç›®å½•)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ 3 å±‚: ä»£ç é»˜è®¤é…ç½®        â”‚ æœ€ä½ä¼˜å…ˆçº§
â”‚ (packages/shared/config/paths.js)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ ¸å¿ƒæ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ | å¤§å° |
|-----|------|------|
| `packages/shared/config/paths.js` | â­ å‡çº§ç‰ˆæœ¬ï¼Œæ”¯æŒåŠ¨æ€åŠ è½½ | 280+ è¡Œ |
| `.env.example` | ç¯å¢ƒå˜é‡æ¨¡æ¿ | 45 è¡Œ |
| `config.example.json` | é…ç½®æ–‡ä»¶æ¨¡æ¿ | 80+ è¡Œ |
| `.docs/17-éƒ¨ç½²æŒ‡å—-ç¯å¢ƒé…ç½®ç³»ç»Ÿ.md` | å®Œæ•´éƒ¨ç½²æŒ‡å— | 600+ è¡Œ |
| `setup-env.sh` | Linux/macOS é…ç½®è„šæœ¬ | 150 è¡Œ |
| `setup-env.bat` | Windows é…ç½®è„šæœ¬ | 150 è¡Œ |

---

## ğŸ”„ é…ç½®åŠ è½½æµç¨‹

### å½“åº”ç”¨å¯åŠ¨æ—¶

```
1. è¯»å–ç¯å¢ƒå˜é‡ APP_ROOT
   â†“ (ä¸å­˜åœ¨åˆ™)
2. è¯»å–ç¯å¢ƒå˜é‡ NODE_PATH
   â†“ (éƒ½ä¸å­˜åœ¨åˆ™)
3. ä½¿ç”¨è®¡ç®—å€¼ (packages/shared/config)
   â†“
4. å°è¯•åŠ è½½ config.json
   â†“
5. éå†æ‰€æœ‰è·¯å¾„é…ç½®
   å¯¹æ¯ä¸ªè·¯å¾„: ç¯å¢ƒå˜é‡ > config.json > é»˜è®¤å€¼
```

### å®é™…ä¾‹å­

```javascript
// å½“è®¿é—® PATHS.worker.platforms æ—¶

// 1ï¸âƒ£ æ£€æŸ¥ç¯å¢ƒå˜é‡
if (process.env.WORKER_PLATFORMS_PATH) {
  return process.env.WORKER_PLATFORMS_PATH;  // /custom/platforms
}

// 2ï¸âƒ£ æ£€æŸ¥ config.json
if (CONFIG?.paths?.worker?.platforms) {
  return CONFIG.paths.worker.platforms;  // /opt/platforms
}

// 3ï¸âƒ£ ä½¿ç”¨é»˜è®¤å€¼
return path.join(PROJECT_ROOT, 'packages/worker/src/platforms');
// ./packages/worker/src/platforms
```

---

## ğŸ“¦ é…ç½®æ–‡ä»¶ç¤ºä¾‹

### å¼€å‘ç¯å¢ƒ (.env)

```bash
NODE_ENV=development
MASTER_PORT=3000
WORKER_ID=worker-1
LOG_LEVEL=debug
```

**ç‰¹ç‚¹**:
- æ— éœ€æŒ‡å®šè·¯å¾„
- ä½¿ç”¨ä»£ç é»˜è®¤å€¼
- æœ€ç®€å•çš„é…ç½®

### ç”Ÿäº§ç¯å¢ƒ (config.json)

```json
{
  "environment": "production",
  "paths": {
    "projectRoot": "/opt/hiscrm-im",
    "master": {
      "data": "/data/hiscrm/master",
      "logs": "/var/log/hiscrm/master"
    },
    "worker": {
      "data": "/data/hiscrm/worker",
      "platforms": "/opt/hiscrm-im/platforms",
      "logs": "/var/log/hiscrm/worker"
    }
  },
  "logging": {
    "level": "info",
    "format": "json"
  }
}
```

**ç‰¹ç‚¹**:
- å®Œæ•´çš„è·¯å¾„æŒ‡å®š
- ç”Ÿäº§çº§åˆ«çš„é…ç½®
- æ˜“äºç‰ˆæœ¬æ§åˆ¶

### Docker éƒ¨ç½² (ç¯å¢ƒå˜é‡)

```dockerfile
ENV APP_ROOT=/app
ENV NODE_ENV=production
ENV WORKER_PLATFORMS_PATH=/app/platforms
```

**ç‰¹ç‚¹**:
- æ— éœ€å¤–éƒ¨é…ç½®æ–‡ä»¶
- é€šè¿‡å®¹å™¨ç¯å¢ƒå˜é‡é…ç½®
- æ˜“äº Kubernetes ä½¿ç”¨

---

## ğŸš€ 5 ä¸ªéƒ¨ç½²åœºæ™¯

### åœºæ™¯ 1: å¼€å‘ç¯å¢ƒ

```bash
npm run dev
# ä½¿ç”¨é»˜è®¤é…ç½®ï¼Œæ— éœ€ä»»ä½•é…ç½®æ–‡ä»¶
```

### åœºæ™¯ 2: å•æœåŠ¡å™¨

```bash
bash setup-env.sh
# 1) é€‰æ‹©ç¯å¢ƒ
# 2) è¾“å…¥è·¯å¾„ä¿¡æ¯
# 3) è‡ªåŠ¨ç”Ÿæˆ config.json
npm run start:master
```

### åœºæ™¯ 3: å¤šæœåŠ¡å™¨ (Master/Worker åˆ†ç¦»)

Master æœåŠ¡å™¨:
```bash
# config.json æŒ‡å‘æœ¬åœ°æ•°æ®
npm run start:master
```

Worker æœåŠ¡å™¨:
```bash
# config.json æŒ‡å‘ Master åœ°å€
npm run start:worker
```

### åœºæ™¯ 4: Docker

```bash
docker-compose up
# é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®
```

### åœºæ™¯ 5: Kubernetes

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: hiscrm-config
data:
  config.json: |
    {
      "paths": {
        "projectRoot": "/app"
      }
    }
```

---

## ğŸ”‘ å…³é”®ç‰¹æ€§

### 1. é›¶é…ç½®å¼€å‘
```bash
# ç›´æ¥è¿è¡Œï¼Œæ— éœ€ä»»ä½•é…ç½®
npm run dev
```

### 2. çµæ´»çš„ç”Ÿäº§éƒ¨ç½²
```bash
# æ–¹å¼ A: é…ç½®æ–‡ä»¶
npm start  # è‡ªåŠ¨åŠ è½½ config.json

# æ–¹å¼ B: ç¯å¢ƒå˜é‡
export APP_ROOT=/opt/hiscrm && npm start

# æ–¹å¼ C: æ··åˆ
export APP_ROOT=/opt && npm start  # ç¯å¢ƒå˜é‡ä¼˜å…ˆ
```

### 3. Docker å‹å¥½
```yaml
environment:
  - APP_ROOT=/app
  - WORKER_PLATFORMS_PATH=/app/platforms
```

### 4. ç»å¯¹è·¯å¾„å’Œç›¸å¯¹è·¯å¾„æ··åˆæ”¯æŒ
```json
{
  "paths": {
    "projectRoot": "/opt/hiscrm",        // ç»å¯¹è·¯å¾„
    "master": {
      "data": "./data/master"             // ç›¸å¯¹è·¯å¾„ (ç›¸å¯¹äº projectRoot)
    }
  }
}
```

### 5. é…ç½®éªŒè¯å’Œè°ƒè¯•
```javascript
// è¾“å‡ºå½“å‰é…ç½®
const { printConfig } = require('@hiscrm-im/shared/config/paths');
printConfig();

// è·å–é…ç½®ä¿¡æ¯ (ç”¨äº API)
const { getConfigInfo } = require('@hiscrm-im/shared/config/paths');
const config = getConfigInfo();
```

---

## ğŸ“Š æ”¹è¿›å¯¹æ¯”

### ä¿®æ”¹å‰ âŒ

```
é—®é¢˜:
- è·¯å¾„ç¡¬ç¼–ç åœ¨ä»£ç ä¸­
- æ‰“åŒ…åæ— æ³•æ›´æ”¹è·¯å¾„
- æ¯ä¸ªç¯å¢ƒéœ€è¦ä¿®æ”¹ä»£ç 
- ä¸æ”¯æŒ Docker/Kubernetes
```

### ä¿®æ”¹å âœ…

```
ä¼˜åŠ¿:
âœ… è·¯å¾„å®Œå…¨å¤–éƒ¨åŒ–
âœ… æ”¯æŒä»»ä½•å®‰è£…è·¯å¾„
âœ… å¼€å‘/æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒç»Ÿä¸€ä»£ç 
âœ… åŸç”Ÿæ”¯æŒ Docker/Kubernetes
âœ… æ”¯æŒç¯å¢ƒå˜é‡è¦†ç›–
âœ… æ”¯æŒé…ç½®æ–‡ä»¶ç®¡ç†
âœ… é…ç½®éªŒè¯å’Œè°ƒè¯•åŠŸèƒ½
```

---

## ğŸ› ï¸ ä½¿ç”¨å·¥å…·

### å¿«é€Ÿé…ç½®è„šæœ¬

**Linux/macOS**:
```bash
bash setup-env.sh

# äº¤äº’å¼é€‰æ‹©:
# 1) å¼€å‘ç¯å¢ƒ
# 2) æµ‹è¯•ç¯å¢ƒ
# 3) ç”Ÿäº§ç¯å¢ƒ

# è‡ªåŠ¨ç”Ÿæˆ:
# â€¢ .env
# â€¢ config.json
```

**Windows**:
```cmd
setup-env.bat

# ç›¸åŒçš„äº¤äº’å¼æµç¨‹
# è‡ªåŠ¨ç”Ÿæˆ .env å’Œ config.json
```

### æ‰‹åŠ¨é…ç½®

```bash
# 1. å¤åˆ¶æ¨¡æ¿
cp .env.example .env
cp config.example.json config.json

# 2. ç¼–è¾‘é…ç½®
nano config.json

# 3. å¯åŠ¨
npm run start:master
```

---

## ğŸ“ ç¯å¢ƒå˜é‡å‚è€ƒ

| å˜é‡ | è¯´æ˜ | ä¼˜å…ˆçº§ | ä¾‹å€¼ |
|-----|------|-------|------|
| `APP_ROOT` | åº”ç”¨æ ¹ç›®å½• | æœ€é«˜ | `/opt/hiscrm-im` |
| `CONFIG_FILE` | é…ç½®æ–‡ä»¶è·¯å¾„ | é«˜ | `/etc/hiscrm/config.json` |
| `WORKER_PLATFORMS_PATH` | Worker å¹³å°ç›®å½• | é«˜ | `/app/platforms` |
| `MASTER_DATA_PATH` | Master æ•°æ®ç›®å½• | ä¸­ | `/data/master` |
| `DATABASE_PATH` | æ•°æ®åº“è·¯å¾„ | ä¸­ | `/data/master.db` |
| `NODE_ENV` | è¿è¡Œç¯å¢ƒ | ä¸­ | `production` |
| `LOG_LEVEL` | æ—¥å¿—çº§åˆ« | ä½ | `info` |

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. å¼€å‘ç¯å¢ƒ
```bash
# ç›´æ¥è¿è¡Œï¼Œä½¿ç”¨é»˜è®¤é…ç½®
npm run dev
```

### 2. æµ‹è¯•ç¯å¢ƒ
```bash
# ä½¿ç”¨ config.json
npm run test
```

### 3. ç”Ÿäº§ç¯å¢ƒ (æœåŠ¡å™¨)
```bash
# 1. åˆ›å»ºé…ç½®
bash setup-env.sh

# 2. éªŒè¯é…ç½®
cat config.json

# 3. å¯åŠ¨
npm run start:master
```

### 4. Docker ç¯å¢ƒ
```dockerfile
ENV APP_ROOT=/app
ENV NODE_ENV=production
```

### 5. Kubernetes ç¯å¢ƒ
```yaml
env:
  - name: APP_ROOT
    value: "/app"
  - name: WORKER_PLATFORMS_PATH
    value: "/app/platforms"
```

---

## ğŸ” è°ƒè¯•é…ç½®

### æŸ¥çœ‹å½“å‰é…ç½®
```javascript
const { PATHS, printConfig, getConfigInfo } =
  require('@hiscrm-im/shared/config/paths');

// è¾“å‡ºé…ç½®ä¿¡æ¯
printConfig();

// è·å–é…ç½®å¯¹è±¡
const config = getConfigInfo();
console.log(config);
```

### å¯åŠ¨æ—¥å¿—ä¸­çš„é…ç½®ä¿¡æ¯
```
[PATHS] å·²åŠ è½½é…ç½®æ–‡ä»¶: /etc/hiscrm/config.json
[PATHS] é…ç½®ä¿¡æ¯:
  é¡¹ç›®æ ¹ç›®å½•: /opt/hiscrm-im
  Master æ•°æ®: /data/hiscrm/master
  Worker å¹³å°: /opt/hiscrm-im/platforms
  æ•°æ®åº“: /data/hiscrm/master/master.db
```

### éªŒè¯è·¯å¾„æ˜¯å¦å­˜åœ¨
```bash
# æ£€æŸ¥å¹³å°ç›®å½•
ls -la /opt/hiscrm-im/platforms

# æ£€æŸ¥æ•°æ®ç›®å½•
ls -la /data/hiscrm/master

# æ£€æŸ¥æ—¥å¿—ç›®å½•
ls -la /var/log/hiscrm
```

---

## âœ… å®Œæˆæ¸…å•

### ä»£ç å®ç°
- âœ… å‡çº§ packages/shared/config/paths.js
- âœ… æ”¯æŒä¸‰å±‚é…ç½®ä¼˜å…ˆçº§
- âœ… å®ç° resolvePath() å‡½æ•°
- âœ… æ·»åŠ  printConfig() å’Œ getConfigInfo()

### é…ç½®æ–‡ä»¶
- âœ… .env.example æ¨¡æ¿
- âœ… config.example.json æ¨¡æ¿
- âœ… æ”¯æŒç¯å¢ƒå˜é‡åŠ è½½

### æ–‡æ¡£
- âœ… 17-éƒ¨ç½²æŒ‡å—-ç¯å¢ƒé…ç½®ç³»ç»Ÿ.md (600+ è¡Œ)
- âœ… 5 ä¸ªéƒ¨ç½²åœºæ™¯è¯¦è§£
- âœ… ç¯å¢ƒå˜é‡å®Œæ•´å‚è€ƒ
- âœ… æ•…éšœæ’é™¤æŒ‡å—

### å·¥å…·
- âœ… setup-env.sh (Linux/macOS)
- âœ… setup-env.bat (Windows)
- âœ… äº¤äº’å¼é…ç½®å‘å¯¼

---

## ğŸ“Š æ–‡ä»¶ç»Ÿè®¡

| ç±»åˆ« | æ•°é‡ | å¤§å° |
|-----|------|------|
| ä»£ç æ–‡ä»¶ | 1 ä¸ª | 280+ è¡Œ |
| é…ç½®æ¨¡æ¿ | 2 ä¸ª | 125+ è¡Œ |
| é…ç½®è„šæœ¬ | 2 ä¸ª | 300 è¡Œ |
| æ–‡æ¡£ | 1 ä¸ª | 600+ è¡Œ |
| **æ€»è®¡** | **6 ä¸ª** | **1300+ è¡Œ** |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å¼€å‘
```bash
npm run dev
```

### éƒ¨ç½²
```bash
# ç”Ÿæˆé…ç½®
bash setup-env.sh

# å¯åŠ¨
npm run start:master
npm run start:worker
```

### Docker
```bash
docker-compose up
```

---

## ğŸ‰ æˆæœæ€»ç»“

### é—®é¢˜è§£å†³
âœ… è§£å†³äº†è·¯å¾„ç¡¬ç¼–ç é—®é¢˜
âœ… æ”¯æŒä»»ä½•å®‰è£…è·¯å¾„
âœ… å®ç°çœŸæ­£çš„å¤šç¯å¢ƒéƒ¨ç½²

### æŠ€æœ¯äº®ç‚¹
âœ… ä¸‰å±‚é…ç½®ç³»ç»Ÿ (çµæ´»é«˜æ•ˆ)
âœ… é…ç½®ä¼˜å…ˆçº§æ¸…æ™° (æ˜“äºç†è§£)
âœ… æ”¯æŒç»å¯¹å’Œç›¸å¯¹è·¯å¾„ (å¹¿æ³›å…¼å®¹)
âœ… é…ç½®éªŒè¯åŠŸèƒ½ (ä¾¿äºè°ƒè¯•)

### æ˜“ç”¨æ€§
âœ… é›¶é…ç½®å¼€å‘ (å¼€å‘è€…å‹å¥½)
âœ… è‡ªåŠ¨åŒ–é…ç½®è„šæœ¬ (å¿«é€Ÿéƒ¨ç½²)
âœ… è¯¦å°½çš„éƒ¨ç½²æŒ‡å— (æ¸…æ™°æ˜äº†)
âœ… å¤šç§éƒ¨ç½²æ–¹å¼ (é«˜åº¦çµæ´»)

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [17-éƒ¨ç½²æŒ‡å—-ç¯å¢ƒé…ç½®ç³»ç»Ÿ.md](./17-éƒ¨ç½²æŒ‡å—-ç¯å¢ƒé…ç½®ç³»ç»Ÿ.md) - å®Œæ•´éƒ¨ç½²æŒ‡å—
- [15-å…±äº«è·¯å¾„é…ç½®ç³»ç»Ÿ.md](./15-å…±äº«è·¯å¾„é…ç½®ç³»ç»Ÿ.md) - è·¯å¾„é…ç½®æ¶æ„
- [16-shared-åº“æ¶æ„è¯´æ˜.md](./16-shared-åº“æ¶æ„è¯´æ˜.md) - åº“æ¶æ„æ€»è§ˆ

---

## ğŸ“ˆ ç³»ç»Ÿç°çŠ¶

```
é…ç½®ç³»ç»Ÿ:       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ… (å®Œå…¨å®ç°)
éƒ¨ç½²çµæ´»æ€§:     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ… (æ”¯æŒæ‰€æœ‰åœºæ™¯)
æ–‡æ¡£å®Œæ•´åº¦:     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ… (è¯¦å°½è¯´æ˜)
æ˜“ç”¨æ€§:         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ… (ç®€å•é«˜æ•ˆ)
```

---

**å®Œæˆæ—¥æœŸ**: 2025-10-20
**æäº¤**: 1 æ¬¡
**æ–‡ä»¶å˜æ›´**: 6 ä¸ªæ–°å¢æ–‡ä»¶ï¼Œ1300+ è¡Œä»£ç 
**è§£å†³é—®é¢˜**: è·¯å¾„ç¡¬ç¼–ç ï¼Œæ‰“åŒ…éƒ¨ç½²é—®é¢˜

ğŸ¯ **ç°åœ¨ HisCRM-IM çœŸæ­£æ”¯æŒçµæ´»çš„å¤šç¯å¢ƒéƒ¨ç½²ï¼**

æ— è®ºæ˜¯æœ¬åœ°å¼€å‘ã€å•æœåŠ¡å™¨ã€å¤šæœåŠ¡å™¨ã€Docker è¿˜æ˜¯ Kubernetesï¼Œéƒ½èƒ½å®Œç¾æ”¯æŒï¼Œæ— éœ€ä¿®æ”¹ä»£ç ï¼
