# 抖音爬虫系统测试指南

## 测试环境准备

### 1. 启动服务

```bash
# 终端 1: 启动 Master 服务器
cd packages/master
npm start

# 终端 2: 启动 Admin Web UI
cd packages/admin-web
npm start
```

### 2. 访问 Admin Web UI

打开浏览器访问：http://localhost:3001

---

## 测试场景

### 场景 1：账号登录（获取 platform_user_id）

**目的**：登录抖音创作者中心，获取 `platform_user_id` (抖音号)

**步骤**：

1. 在 Admin Web UI 中，进入"账号管理"页面
2. 选择一个账号，点击"登录"按钮
3. 扫描二维码完成登录
4. 登录成功后，系统会自动提取并保存 `platform_user_id`

**验证**：

查看数据库：
```bash
sqlite3 packages/master/data/master.db
SELECT id, platform, platform_user_id, platform_username FROM accounts;
```

应该看到账号的 `platform_user_id` 和 `platform_username` 已填充。

---

### 场景 2：手动测试爬虫功能

**目的**：使用测试脚本测试评论和私信爬取

**步骤**：

1. 确保账号已登录（场景 1）
2. 修改测试脚本中的账号信息：

```javascript
// packages/worker/test-douyin-crawler.js
const testAccount = {
  id: 'acc-your-account-id',  // 替换为真实账号ID
  platform: 'douyin',
  platform_user_id: 'your-douyin-id',  // 替换为真实抖音号
  status: 'active',
  login_status: 'logged_in',
};
```

3. 运行测试脚本：

```bash
cd packages/worker
node test-douyin-crawler.js
```

**预期输出**：

```
[test-douyin-crawler] info: ============================================================
[test-douyin-crawler] info: 抖音爬虫功能测试
[test-douyin-crawler] info: ============================================================

[test-douyin-crawler] info: 步骤 1: 初始化组件
[test-douyin-crawler] info: ✓ Browser Manager 初始化成功
[test-douyin-crawler] info: ✓ Worker Bridge 连接成功
[test-douyin-crawler] info: ✓ Platform Manager 初始化成功

[test-douyin-crawler] info: 步骤 2: 获取抖音平台
[test-douyin-crawler] info: ✓ 抖音平台获取成功

[test-douyin-crawler] info: 步骤 3: 准备测试账号
[test-douyin-crawler] info: ✓ 测试账号: test-account-1 (platform_user_id: douyin-test-12345)

[test-douyin-crawler] info: 步骤 4: 测试评论爬取
[test-douyin-crawler] info: 评论爬取结果：
[test-douyin-crawler] info: - 总视频数: 2
[test-douyin-crawler] info: - 总评论数: 10
[test-douyin-crawler] info: - 新评论数: 3
[test-douyin-crawler] info: ✓ 评论爬取测试通过

[test-douyin-crawler] info: 步骤 5: 测试私信爬取
[test-douyin-crawler] info: 私信爬取结果：
[test-douyin-crawler] info: - 私信数量: 5
[test-douyin-crawler] info: ✓ 私信爬取测试通过

[test-douyin-crawler] info: ============================================================
[test-douyin-crawler] info: 测试完成！
[test-douyin-crawler] info: ============================================================
```

**验证数据库**：

```bash
sqlite3 packages/master/data/master.db

# 查看视频表
SELECT * FROM douyin_videos LIMIT 5;

# 查看评论表（新评论）
SELECT id, platform_user_id, content, is_new, post_title FROM comments WHERE is_new = 1 LIMIT 5;

# 查看私信表
SELECT * FROM direct_messages LIMIT 5;

# 查看通知表
SELECT * FROM notifications ORDER BY created_at DESC LIMIT 5;
```

---

### 场景 3：测试增量爬取

**目的**：验证系统能正确识别新旧评论

**步骤**：

1. 第一次爬取：运行测试脚本
   ```bash
   node test-douyin-crawler.js
   ```
   记录结果：新评论数 = N

2. 等待 5 分钟（不要添加新评论）

3. 第二次爬取：再次运行测试脚本
   ```bash
   node test-douyin-crawler.js
   ```

**预期结果**：

- 第一次爬取：所有评论都是新的 (`is_new = true`)
- 第二次爬取：新评论数 = 0（因为没有新增评论）

**验证**：

```sql
-- 查看评论的 is_new 状态
SELECT
  post_title,
  COUNT(*) as total,
  SUM(CASE WHEN is_new = 1 THEN 1 ELSE 0 END) as new_count
FROM comments
GROUP BY post_title;
```

---

### 场景 4：测试 platform_user_id 数据隔离

**目的**：验证不同抖音账号的数据是否正确隔离

**步骤**：

1. 使用第一个抖音账号登录并爬取
   - platform_user_id = 'douyin-user-1'
   - 爬取评论

2. 登出，使用第二个抖音账号登录并爬取
   - platform_user_id = 'douyin-user-2'
   - 爬取评论

3. 查询数据库验证数据隔离

**验证查询**：

```sql
-- 查看不同平台用户的数据
SELECT
  platform_user_id,
  COUNT(*) as comment_count
FROM comments
GROUP BY platform_user_id;

-- 查看特定平台用户的评论
SELECT * FROM comments WHERE platform_user_id = 'douyin-user-1';
SELECT * FROM comments WHERE platform_user_id = 'douyin-user-2';

-- 验证视频表的数据隔离
SELECT
  platform_user_id,
  COUNT(*) as video_count
FROM douyin_videos
GROUP BY platform_user_id;
```

**预期结果**：

- 两个账号的数据完全分离
- 查询时指定 `platform_user_id` 只返回对应账号的数据

---

### 场景 5：测试通知推送

**目的**：验证新评论通知是否正确生成和推送

**步骤**：

1. 打开 Admin Web UI (http://localhost:3001)
2. 确保有新评论（可以手动在抖音上发布评论）
3. 运行爬虫
4. 观察 Admin Web UI 的通知

**预期行为**：

- 新评论生成通知
- 通知实时推送到 Web UI
- 右下角显示 toast 提示
- 通知列表中显示新通知

**验证数据库**：

```sql
-- 查看最近的通知
SELECT
  type,
  title,
  content,
  platform_user_id,
  is_sent,
  created_at
FROM notifications
ORDER BY created_at DESC
LIMIT 10;
```

---

## 性能测试

### 测试 1：时间优化效果

**目的**：验证增量爬取的时间优化

**步骤**：

1. 创建一个有大量历史评论的视频（如10万条）
2. 设置 `last_crawl_time` 为 1 小时前
3. 运行爬虫并测量性能

**对比**：

| 优化方式 | 查询评论ID数量 | 查询时间 |
|---------|--------------|----------|
| 无优化 | 100,000 | ~500ms |
| 时间优化 | ~300 | ~5ms |

**测试代码**：

```javascript
// 测试性能
console.time('getCommentIds-optimized');
const ids1 = commentsDAO.getCommentIdsByPostId('video-123', {
  since_time: Date.now() / 1000 - 3600  // 1小时前
});
console.timeEnd('getCommentIds-optimized');

console.time('getCommentIds-full');
const ids2 = commentsDAO.getCommentIdsByPostId('video-123');
console.timeEnd('getCommentIds-full');
```

---

## 常见问题排查

### 问题 1：爬虫报错 "Account missing platform_user_id"

**原因**：账号未登录或登录后未正确提取 platform_user_id

**解决**：
1. 在 Admin Web UI 中重新登录账号
2. 确认登录成功后，检查数据库：
   ```sql
   SELECT id, platform_user_id FROM accounts WHERE id = 'your-account-id';
   ```

### 问题 2：爬取不到评论

**可能原因**：
1. 账号未登录或登录过期
2. 抖音页面结构变化（选择器失效）
3. 网络问题

**调试**：
1. 查看 Worker 日志：`packages/worker/logs/worker.log`
2. 查看截图：`packages/worker/data/browser/worker-1/screenshots/`
3. 检查浏览器状态：Worker 会保存登录页面截图

### 问题 3：通知未推送

**检查项**：
1. Master 服务是否运行
2. Socket.IO 连接是否正常
3. NotificationQueue 是否运行

**验证**：
```bash
# 检查通知队列
curl http://localhost:3000/api/v1/status

# 查看通知表
sqlite3 packages/master/data/master.db "SELECT COUNT(*) FROM notifications WHERE is_sent = 0;"
```

---

## 自动化测试

### Jest 测试（待实现）

```bash
# 运行所有测试
npm test

# 运行 Worker 测试
cd packages/worker
npm test

# 运行 Master 测试
cd packages/master
npm test
```

### 集成测试（待实现）

测试完整的端到端流程：
1. 登录 → 获取 platform_user_id
2. 爬取评论 → 验证数据存储
3. 增量爬取 → 验证新旧评论识别
4. 通知生成 → 验证通知推送

---

## 测试清单

### 功能测试
- [ ] 账号登录功能
- [ ] 获取 platform_user_id
- [ ] 评论爬取
- [ ] 私信爬取
- [ ] 增量爬取（新旧评论识别）
- [ ] platform_user_id 数据隔离
- [ ] 通知生成
- [ ] 通知推送（Web UI）

### 性能测试
- [ ] 大量评论场景（10万+）
- [ ] 时间优化效果
- [ ] 并发爬取多个账号
- [ ] 内存占用测试

### 稳定性测试
- [ ] 长时间运行（24小时）
- [ ] 网络中断恢复
- [ ] 登录过期处理
- [ ] 异常错误处理

### 兼容性测试
- [ ] Windows 环境
- [ ] Linux 环境
- [ ] macOS 环境

---

## 总结

完成以上测试场景后，系统的核心功能应该都得到验证。如遇到问题，请查看：

- **Master 日志**: `packages/master/logs/master.log`
- **Worker 日志**: `packages/worker/logs/worker.log`
- **浏览器截图**: `packages/worker/data/browser/*/screenshots/`
- **数据库**: `packages/master/data/master.db`

如需帮助，请参考：
- [抖音爬虫完整实现总结.md](./抖音爬虫完整实现总结.md)
- [增量抓取实现指南.md](./增量抓取实现指南.md)
- [DAO层platform_user_id支持总结.md](./DAO层platform_user_id支持总结.md)
