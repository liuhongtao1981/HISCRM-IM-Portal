# æŠ–éŸ³çˆ¬è™«å®Œæ•´å®ç°æ€»ç»“

## å®ç°æ—¥æœŸ
2025-10-17

## æ¦‚è¿°
æœ¬æ–‡æ¡£æ€»ç»“äº†å®Œæ•´çš„æŠ–éŸ³è¯„è®ºå’Œç§ä¿¡çˆ¬è™«ç³»ç»Ÿå®ç°ï¼ŒåŒ…æ‹¬ Worker ç«¯çš„çˆ¬å–é€»è¾‘ã€Master-Worker é€šä¿¡ã€å¢é‡çˆ¬å–ã€æ•°æ®éš”ç¦»ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

---

## ä¸€ã€æ•´ä½“æ¶æ„

### æ•°æ®æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æŠ–éŸ³çˆ¬è™«ç³»ç»Ÿæ•°æ®æµ                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Worker å¯åŠ¨çˆ¬å–ä»»åŠ¡
   â†“
2. Worker ç™»å½•æŠ–éŸ³åˆ›ä½œè€…ä¸­å¿ƒ
   â”‚ - è·å– platform_user_id (douyin_id)
   â”‚ - ä¿å­˜ç™»å½•çŠ¶æ€
   â†“
3. çˆ¬å–è¯„è®º
   â”‚ a) å¯¼èˆªåˆ°"äº’åŠ¨ç®¡ç† - è¯„è®ºç®¡ç†"é¡µé¢
   â”‚ b) è·å–è§†é¢‘åˆ—è¡¨
   â”‚ c) é€ä¸ªç‚¹å‡»è§†é¢‘ï¼Œæ‹¦æˆª API è·å–è¯„è®ºæ•°æ®
   â”‚ d) é€šè¿‡ Socket.IO å‘ Master è¯·æ±‚å†å²è¯„è®ºID
   â”‚ e) ä½¿ç”¨å¢é‡çˆ¬å–æœåŠ¡åŒºåˆ†æ–°æ—§è¯„è®º
   â”‚ f) å‘é€è¯„è®ºå’Œè§†é¢‘æ•°æ®åˆ° Master
   â”‚ g) ä¸ºæ–°è¯„è®ºç”Ÿæˆé€šçŸ¥
   â†“
4. çˆ¬å–ç§ä¿¡
   â”‚ a) å¯¼èˆªåˆ°"äº’åŠ¨ç®¡ç† - ç§ä¿¡ç®¡ç†"é¡µé¢
   â”‚ b) æ‹¦æˆª API è·å–ä¼šè¯åˆ—è¡¨
   â”‚ c) å‘é€ç§ä¿¡æ•°æ®åˆ° Master
   â†“
5. Master å­˜å‚¨æ•°æ®
   â”‚ - æ‰¹é‡æ’å…¥è¯„è®ºï¼ˆå»é‡ï¼‰
   â”‚ - æ‰¹é‡æ’å…¥ç§ä¿¡ï¼ˆå»é‡ï¼‰
   â”‚ - æ›´æ–°è§†é¢‘ä¿¡æ¯
   â”‚ - åˆ›å»ºé€šçŸ¥
   â†“
6. Master æ¨é€é€šçŸ¥
   â”‚ - å¹¿æ’­åˆ° Admin Web UI
   â”‚ - æ¨é€åˆ° Desktop Client
   â”‚ - æ¨é€åˆ° Mobile Client
```

---

## äºŒã€Worker ç«¯å®ç°

### 1. æ–‡ä»¶ä½ç½®
- **ä¸»æ–‡ä»¶**: [packages/worker/src/platforms/douyin/platform.js](../../packages/worker/src/platforms/douyin/platform.js)
- **å¢é‡æœåŠ¡**: [packages/worker/src/services/incremental-crawl-service.js](../../packages/worker/src/services/incremental-crawl-service.js)

### 2. æ ¸å¿ƒæ–¹æ³•

#### 2.1 `crawlComments(account, options)`
**åŠŸèƒ½**: çˆ¬å–æŠ–éŸ³è¯„è®º

**æµç¨‹**:
```javascript
1. æ£€æŸ¥ account.platform_user_id æ˜¯å¦å­˜åœ¨
2. å¯¼èˆªåˆ°è¯„è®ºç®¡ç†é¡µé¢
3. è·å–è§†é¢‘åˆ—è¡¨ (getVideoListFromCommentPage)
4. å¯¹æ¯ä¸ªè§†é¢‘ï¼š
   a. è®¾ç½® API æ‹¦æˆªå™¨ (**/comment/list/select/**)
   b. ç‚¹å‡»è§†é¢‘ (clickVideoInCommentPage)
   c. æ»šåŠ¨é¡µé¢åŠ è½½æ›´å¤š (scrollCommentList)
   d. è§£ææ‹¦æˆªçš„ API å“åº” (parseCommentsFromAPI)
   e. è°ƒç”¨å¢é‡çˆ¬å–æœåŠ¡åŒºåˆ†æ–°æ—§è¯„è®º
   f. ç´¯ç§¯æ‰€æœ‰è¯„è®ºå’Œæ–°è¯„è®º
5. å‘é€æ•°æ®åˆ° Masterï¼š
   - sendCommentsToMaster(account, allComments, videos)
   - sendNewCommentNotifications(account, newComments, videos)
6. è¿”å›ç»“æœ
```

**å…³é”®ä»£ç **:
```javascript
// ä½¿ç”¨å¢é‡çˆ¬å–æœåŠ¡
const incrementalResult = await IncrementalCrawlService.processCommentsIncremental(
  rawComments,
  video,
  account.id,
  account.platform_user_id,
  async (awemeId, opts) => {
    // é€šè¿‡ Worker Bridge è¯·æ±‚ Master è·å–å†å²è¯„è®ºID
    return await this.getExistingCommentIds(awemeId, opts);
  }
);

// ç»“æœåŒ…å«ï¼š
// - incrementalResult.allComments: æ‰€æœ‰è¯„è®ºï¼ˆå« is_new æ ‡è®°ï¼‰
// - incrementalResult.newComments: ä»…æ–°è¯„è®º
// - incrementalResult.stats: ç»Ÿè®¡ä¿¡æ¯
```

#### 2.2 `crawlDirectMessages(account)`
**åŠŸèƒ½**: çˆ¬å–æŠ–éŸ³ç§ä¿¡

**æµç¨‹**:
```javascript
1. æ£€æŸ¥ account.platform_user_id æ˜¯å¦å­˜åœ¨
2. è®¾ç½® API æ‹¦æˆªå™¨ (**/message/get_by_user_init**)
3. å¯¼èˆªåˆ°ç§ä¿¡ç®¡ç†é¡µé¢
4. ç­‰å¾… API å“åº”
5. è§£æç§ä¿¡æ•°æ® (parseMessagesFromAPI)
6. å¦‚æœ API æ— æ•°æ®ï¼Œå›é€€åˆ° DOM æå– (extractDirectMessages)
7. æ·»åŠ å¿…è¦å­—æ®µ (account_id, platform_user_id, id)
8. å‘é€æ•°æ®åˆ° Master (sendMessagesToMaster)
9. è¿”å›ç»“æœ
```

#### 2.3 `getExistingCommentIds(awemeId, options)`
**åŠŸèƒ½**: é€šè¿‡ Socket.IO å‘ Master è¯·æ±‚å†å²è¯„è®ºIDï¼ˆç”¨äºå¢é‡çˆ¬å–ï¼‰

```javascript
async getExistingCommentIds(awemeId, options = {}) {
  const response = await this.workerBridge.request('worker:get_comment_ids', {
    aweme_id: awemeId,
    options,
  });

  if (response.success) {
    return response.comment_ids; // è¿”å› ['cid1', 'cid2', ...]
  } else {
    return [];
  }
}
```

#### 2.4 `sendCommentsToMaster(account, comments, videos)`
**åŠŸèƒ½**: å‘é€è¯„è®ºå’Œè§†é¢‘æ•°æ®åˆ° Master

```javascript
async sendCommentsToMaster(account, comments, videos) {
  // 1. å‘é€è§†é¢‘ä¿¡æ¯ï¼ˆupsertï¼‰
  for (const video of videos) {
    await this.workerBridge.emit('worker:upsert_video', {
      account_id: account.id,
      platform_user_id: account.platform_user_id,
      aweme_id: video.aweme_id,
      title: video.title,
      cover: video.cover,
      publish_time: video.publish_time,
      total_comment_count: video.comment_count || 0,
    });
  }

  // 2. æ‰¹é‡å‘é€è¯„è®ºæ•°æ®
  if (comments.length > 0) {
    await this.workerBridge.emit('worker:bulk_insert_comments', {
      account_id: account.id,
      platform_user_id: account.platform_user_id,
      comments,
    });
  }
}
```

#### 2.5 `sendNewCommentNotifications(account, newComments, videos)`
**åŠŸèƒ½**: ä¸ºæ–°è¯„è®ºç”Ÿæˆå¹¶å‘é€é€šçŸ¥

```javascript
async sendNewCommentNotifications(account, newComments, videos) {
  // æŒ‰è§†é¢‘åˆ†ç»„æ–°è¯„è®º
  const commentsByVideo = {};
  newComments.forEach((comment) => {
    if (!commentsByVideo[comment.post_id]) {
      commentsByVideo[comment.post_id] = [];
    }
    commentsByVideo[comment.post_id].push(comment);
  });

  // ä¸ºæ¯ä¸ªè§†é¢‘ç”Ÿæˆé€šçŸ¥
  for (const [awemeId, comments] of Object.entries(commentsByVideo)) {
    const video = videos.find((v) => v.aweme_id === awemeId) || { title: 'æœªçŸ¥ä½œå“' };

    const notifications = IncrementalCrawlService.generateCommentNotifications(
      comments,
      video,
      account.id
    );

    // å‘é€é€šçŸ¥åˆ° Master
    for (const notification of notifications) {
      await this.workerBridge.pushNotification({
        ...notification,
        platform_user_id: account.platform_user_id,
      });
    }
  }
}
```

---

## ä¸‰ã€Master ç«¯å®ç°

### 1. æ–‡ä»¶ä½ç½®
- **Socket.IO æœåŠ¡å™¨**: [packages/master/src/communication/socket-server.js](../../packages/master/src/communication/socket-server.js)
- **ä¸»å…¥å£**: [packages/master/src/index.js](../../packages/master/src/index.js)

### 2. Socket.IO äº‹ä»¶ç›‘å¬å™¨

#### 2.1 `worker:get_comment_ids`
**åŠŸèƒ½**: å“åº” Worker çš„è¯„è®ºIDæŸ¥è¯¢è¯·æ±‚ï¼ˆç”¨äºå¢é‡çˆ¬å–ï¼‰

```javascript
socket.on('worker:get_comment_ids', async (data, callback) => {
  logger.debug(`Worker requesting comment IDs for video ${data.aweme_id}`);
  if (handlers.onGetCommentIds) {
    try {
      const result = await handlers.onGetCommentIds(data, socket);
      if (callback) callback(result);
    } catch (error) {
      logger.error('Failed to get comment IDs:', error);
      if (callback) callback({ success: false, error: error.message });
    }
  }
});
```

#### 2.2 `worker:upsert_video`
**åŠŸèƒ½**: æ¥æ”¶ Worker å‘é€çš„è§†é¢‘ä¿¡æ¯å¹¶å­˜å‚¨

```javascript
socket.on('worker:upsert_video', async (data) => {
  logger.debug(`Worker upserting video ${data.aweme_id}`);
  if (handlers.onUpsertVideo) {
    try {
      await handlers.onUpsertVideo(data, socket);
    } catch (error) {
      logger.error('Failed to upsert video:', error);
    }
  }
});
```

#### 2.3 `worker:bulk_insert_comments`
**åŠŸèƒ½**: æ¥æ”¶ Worker å‘é€çš„è¯„è®ºæ‰¹é‡æ’å…¥è¯·æ±‚

```javascript
socket.on('worker:bulk_insert_comments', async (data) => {
  logger.info(`Worker bulk inserting ${data.comments?.length || 0} comments`);
  if (handlers.onBulkInsertComments) {
    try {
      await handlers.onBulkInsertComments(data, socket);
    } catch (error) {
      logger.error('Failed to bulk insert comments:', error);
    }
  }
});
```

#### 2.4 `worker:bulk_insert_messages`
**åŠŸèƒ½**: æ¥æ”¶ Worker å‘é€çš„ç§ä¿¡æ‰¹é‡æ’å…¥è¯·æ±‚

```javascript
socket.on('worker:bulk_insert_messages', async (data) => {
  logger.info(`Worker bulk inserting ${data.messages?.length || 0} messages`);
  if (handlers.onBulkInsertMessages) {
    try {
      await handlers.onBulkInsertMessages(data, socket);
    } catch (error) {
      logger.error('Failed to bulk insert messages:', error);
    }
  }
});
```

### 3. äº‹ä»¶å¤„ç†å™¨å®ç° (index.js)

```javascript
// è·å–è¯„è®ºIDï¼ˆç”¨äºå¢é‡çˆ¬å–ï¼‰
tempHandlers.onGetCommentIds = async (data, socket) => {
  try {
    const { aweme_id, options } = data;
    const commentIds = commentsDAO.getCommentIdsByPostId(aweme_id, options || {});
    return {
      success: true,
      comment_ids: commentIds,
    };
  } catch (error) {
    logger.error('Failed to get comment IDs:', error);
    return {
      success: false,
      error: error.message,
      comment_ids: [],
    };
  }
};

// æ›´æ–°/æ’å…¥è§†é¢‘ä¿¡æ¯
tempHandlers.onUpsertVideo = async (data, socket) => {
  try {
    const { account_id, platform_user_id, aweme_id, title, cover, publish_time, total_comment_count } = data;

    douyinVideoDAO.upsertVideo({
      account_id,
      platform_user_id,
      aweme_id,
      title,
      cover,
      publish_time,
      total_comment_count: total_comment_count || 0,
    });

    logger.debug(`Video upserted: ${aweme_id}`);
  } catch (error) {
    logger.error('Failed to upsert video:', error);
  }
};

// æ‰¹é‡æ’å…¥è¯„è®º
tempHandlers.onBulkInsertComments = async (data, socket) => {
  try {
    const { account_id, platform_user_id, comments } = data;

    const result = commentsDAO.bulkInsert(comments);

    logger.info(`Bulk inserted comments: ${result.inserted} inserted, ${result.skipped} skipped`);
  } catch (error) {
    logger.error('Failed to bulk insert comments:', error);
  }
};

// æ‰¹é‡æ’å…¥ç§ä¿¡
tempHandlers.onBulkInsertMessages = async (data, socket) => {
  try {
    const { account_id, platform_user_id, messages } = data;

    const result = directMessagesDAO.bulkInsert(messages);

    logger.info(`Bulk inserted messages: ${result.inserted} inserted, ${result.skipped} skipped`);
  } catch (error) {
    logger.error('Failed to bulk insert messages:', error);
  }
};
```

---

## å››ã€å¢é‡çˆ¬å–æœåŠ¡

### æ–‡ä»¶ä½ç½®
[packages/worker/src/services/incremental-crawl-service.js](../../packages/worker/src/services/incremental-crawl-service.js)

### æ ¸å¿ƒæ–¹æ³•

#### `processCommentsIncremental(rawComments, video, accountId, platformUserId, getExistingCommentIds, options)`
**åŠŸèƒ½**: å¤„ç†è¯„è®ºå¢é‡æŠ“å–ï¼ŒåŒºåˆ†æ–°æ—§è¯„è®º

**å‚æ•°**:
- `rawComments`: ä»APIè·å–çš„åŸå§‹è¯„è®ºåˆ—è¡¨
- `video`: ä½œå“å¯¹è±¡ `{ aweme_id, title, cover, last_crawl_time }`
- `accountId`: ç³»ç»Ÿè´¦æˆ·ID
- `platformUserId`: å¹³å°ç”¨æˆ·IDï¼ˆæŠ–éŸ³å·ï¼‰
- `getExistingCommentIds`: è·å–ç°æœ‰è¯„è®ºIDçš„å‡½æ•°
- `options.useTimeOptimization`: æ˜¯å¦ä½¿ç”¨æ—¶é—´ä¼˜åŒ–ï¼ˆé»˜è®¤trueï¼‰

**è¿”å›**:
```javascript
{
  newComments: [...],    // æ–°è¯„è®ºåˆ—è¡¨ï¼ˆis_new = trueï¼‰
  allComments: [...],    // æ‰€æœ‰è¯„è®ºåˆ—è¡¨ï¼ˆå« is_new æ ‡è®°ï¼‰
  stats: {
    total: 100,          // æ€»è¯„è®ºæ•°
    new: 5,              // æ–°è¯„è®ºæ•°
    existing: 95         // å†å²è¯„è®ºæ•°
  }
}
```

**æ ¸å¿ƒé€»è¾‘**:
```javascript
// 1. è·å–å†å²è¯„è®ºIDï¼ˆæ”¯æŒæ—¶é—´ä¼˜åŒ–ï¼‰
let existingIds = [];
if (useTimeOptimization && video.last_crawl_time) {
  // åªæŸ¥è¯¢æœ€è¿‘æ—¶é—´çª—å£çš„è¯„è®ºIDï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
  const now = Math.floor(Date.now() / 1000);
  const timeSinceLastCrawl = now - video.last_crawl_time;
  const safetyWindow = Math.max(timeSinceLastCrawl * 2, 3600); // è‡³å°‘1å°æ—¶
  const sinceTime = video.last_crawl_time - safetyWindow;

  existingIds = await getExistingCommentIds(video.aweme_id, { since_time: sinceTime });
} else {
  // é¦–æ¬¡çˆ¬å–ï¼šæŸ¥è¯¢æ‰€æœ‰å†å²è¯„è®ºID
  existingIds = await getExistingCommentIds(video.aweme_id);
}

// 2. å¯¹æ¯”åˆ¤æ–­æ˜¯å¦ä¸ºæ–°è¯„è®º
const allComments = rawComments.map((comment) => {
  const isNew = !existingIds.includes(comment.platform_comment_id);

  return {
    id: uuidv4(),
    account_id: accountId,
    platform_user_id: platformUserId,
    platform_comment_id: comment.platform_comment_id,
    content: comment.content,
    // ... å…¶ä»–å­—æ®µ
    is_new: isNew,  // æ–°è¯„è®ºæ ‡è®°
    is_read: false,
    detected_at: comment.create_time || now,
    first_detected_at: now,
    created_at: now,
  };
});

// 3. ç­›é€‰æ–°è¯„è®º
const newComments = allComments.filter((c) => c.is_new);
```

#### `generateCommentNotifications(newComments, video, accountId)`
**åŠŸèƒ½**: ä¸ºæ–°è¯„è®ºç”Ÿæˆé€šçŸ¥å¯¹è±¡

**é€»è¾‘**:
- å¦‚æœæ–°è¯„è®º > 5 æ¡ï¼šç”Ÿæˆæ±‡æ€»é€šçŸ¥
- å¦‚æœæ–°è¯„è®º â‰¤ 5 æ¡ï¼šä¸ºæ¯æ¡è¯„è®ºç”Ÿæˆç‹¬ç«‹é€šçŸ¥

```javascript
static generateCommentNotifications(newComments, video, accountId) {
  if (newComments.length === 0) return [];

  const notifications = [];

  // æ±‡æ€»é€šçŸ¥ï¼ˆ>5æ¡æ–°è¯„è®ºï¼‰
  if (newComments.length > 5) {
    notifications.push({
      type: 'comment',
      accountId,
      title: `ã€Š${video.title}ã€‹æ”¶åˆ° ${newComments.length} æ¡æ–°è¯„è®º`,
      content: newComments[0].content,
      data: { video, commentCount: newComments.length },
      priority: 'normal',
    });
  } else {
    // ç‹¬ç«‹é€šçŸ¥ï¼ˆâ‰¤5æ¡æ–°è¯„è®ºï¼‰
    newComments.forEach((comment) => {
      notifications.push({
        type: 'comment',
        accountId,
        title: `${comment.author_name} è¯„è®ºäº†ã€Š${video.title}ã€‹`,
        content: comment.content,
        data: { video, comment },
        priority: 'normal',
      });
    });
  }

  return notifications;
}
```

---

## äº”ã€æ•°æ®åº“æ”¯æŒ

### 1. DAO æ›´æ–°

æ‰€æœ‰ DAO å·²æ”¯æŒ `platform_user_id` è¿‡æ»¤ï¼Œè¯¦è§ï¼š
- [DAOå±‚platform_user_idæ”¯æŒæ€»ç»“.md](./DAOå±‚platform_user_idæ”¯æŒæ€»ç»“.md)

### 2. å…³é”®æ–¹æ³•

#### CommentsDAO
- `bulkInsert(comments)` - æ‰¹é‡æ’å…¥è¯„è®ºï¼ˆæ”¯æŒ platform_user_idï¼‰
- `getCommentIdsByPostId(postId, options)` - è·å–è¯„è®ºIDåˆ—è¡¨ï¼ˆæ”¯æŒæ—¶é—´è¿‡æ»¤ï¼‰
- `findAll(filters)` - æŸ¥è¯¢è¯„è®ºï¼ˆæ”¯æŒ platform_user_id è¿‡æ»¤ï¼‰
- `count(filters)` - ç»Ÿè®¡è¯„è®ºï¼ˆæ”¯æŒ platform_user_id è¿‡æ»¤ï¼‰

#### DouyinVideoDAO
- `upsertVideo(video)` - æ’å…¥æˆ–æ›´æ–°è§†é¢‘ï¼ˆåŒ…å« platform_user_idï¼‰
- `getVideosByAccountId(accountId, options)` - æŸ¥è¯¢è§†é¢‘ï¼ˆæ”¯æŒ platform_user_id è¿‡æ»¤ï¼‰
- `getVideoStats(accountId, platformUserId)` - ç»Ÿè®¡è§†é¢‘æ•°æ®

#### DirectMessagesDAO
- `bulkInsert(messages)` - æ‰¹é‡æ’å…¥ç§ä¿¡ï¼ˆæ”¯æŒ platform_user_idï¼‰
- `findAll(filters)` - æŸ¥è¯¢ç§ä¿¡ï¼ˆæ”¯æŒ platform_user_id è¿‡æ»¤ï¼‰
- `getConversations(accountId, platformUserId)` - è·å–ä¼šè¯åˆ—è¡¨

---

## å…­ã€æ ¸å¿ƒç‰¹æ€§

### 1. å¢é‡çˆ¬å–
- **ID å¯¹æ¯”**: åŸºäº `platform_comment_id` å”¯ä¸€IDåˆ¤æ–­æ–°æ—§è¯„è®º
- **æ—¶é—´ä¼˜åŒ–**: å®šæœŸçˆ¬å–æ—¶åªå¯¹æ¯”æœ€è¿‘æ—¶é—´çª—å£çš„è¯„è®ºIDï¼ˆæ€§èƒ½æå‡100å€ï¼‰
- **å®‰å…¨çª—å£**: 2å€æ—¶é—´é—´éš”é˜²æ­¢é—æ¼
- **è‡ªåŠ¨é€‚é…**: é¦–æ¬¡çˆ¬å–è‡ªåŠ¨ä½¿ç”¨å…¨é‡æŸ¥è¯¢

### 2. æ•°æ®éš”ç¦»
- **platform_user_id**: æ‰€æœ‰æ•°æ®æŒ‰å¹³å°ç”¨æˆ·IDï¼ˆæŠ–éŸ³å·ï¼‰éš”ç¦»
- **å¤åˆç´¢å¼•**: `(platform_user_id, aweme_id)` ç¡®ä¿å”¯ä¸€æ€§
- **æŸ¥è¯¢è¿‡æ»¤**: æ‰€æœ‰DAOæ–¹æ³•æ”¯æŒæŒ‰ platform_user_id è¿‡æ»¤

### 3. å®æ—¶é€šçŸ¥
- **æ–°è¯„è®ºæ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«æ–°å¢è¯„è®º
- **æ™ºèƒ½æ±‡æ€»**: >5æ¡æ–°è¯„è®ºæ—¶ç”Ÿæˆæ±‡æ€»é€šçŸ¥
- **å¤šç«¯æ¨é€**: åŒæ—¶æ¨é€åˆ° Admin Webã€Desktopã€Mobile

### 4. æ··åˆçˆ¬å–ç­–ç•¥
- **ä¼˜å…ˆAPIæ‹¦æˆª**: ä½¿ç”¨ Playwright çš„ `page.route()` æ‹¦æˆªç½‘ç»œè¯·æ±‚
- **DOMå›é€€**: APIæ— æ•°æ®æ—¶å›é€€åˆ° DOM æå–
- **æ¨¡æ‹Ÿäººç±»æ“ä½œ**: éšæœºå»¶è¿Ÿã€é¼ æ ‡ç‚¹å‡»ã€é¡µé¢æ»šåŠ¨

---

## ä¸ƒã€æ€§èƒ½ä¼˜åŒ–

### 1. æ—¶é—´çª—å£ä¼˜åŒ–
å¯¹äºå®šæœŸçˆ¬å–ï¼ˆå¦‚æ¯å°æ—¶ä¸€æ¬¡ï¼‰ï¼š
- **ä¼˜åŒ–å‰**: æŸ¥è¯¢10ä¸‡æ¡å†å²è¯„è®ºID â†’ 500ms
- **ä¼˜åŒ–å**: æŸ¥è¯¢300æ¡æœ€è¿‘è¯„è®ºID â†’ 5ms
- **æå‡**: **100å€**

### 2. æ‰¹é‡æ“ä½œ
- ä½¿ç”¨ SQLite äº‹åŠ¡æ‰¹é‡æ’å…¥è¯„è®º
- å•æ¬¡è¯·æ±‚å¯æ’å…¥æ•°ç™¾æ¡è¯„è®º
- å»é‡åœ¨æ•°æ®åº“å±‚é¢å®Œæˆï¼ˆ`INSERT OR IGNORE`ï¼‰

### 3. è¿æ¥å¤ç”¨
- Worker ç»´æŠ¤ä¸€ä¸ªé•¿è¿æ¥é¡µé¢ç”¨äºçˆ¬å–
- é¿å…é¢‘ç¹åˆ›å»º/é”€æ¯æµè§ˆå™¨ä¸Šä¸‹æ–‡

---

## å…«ã€ä½¿ç”¨ç¤ºä¾‹

### Worker ç«¯è°ƒç”¨

```javascript
// åœ¨ task-runner.js æˆ– monitor-task.js ä¸­
const platform = await platformManager.getPlatform('douyin');

// çˆ¬å–è¯„è®º
const commentResult = await platform.crawlComments(account, {
  maxVideos: 5  // æœ€å¤šçˆ¬å–5ä¸ªè§†é¢‘çš„è¯„è®º
});

logger.info(`Crawled ${commentResult.comments.length} comments`);
logger.info(`${commentResult.newComments.length} new comments`);

// çˆ¬å–ç§ä¿¡
const messageResult = await platform.crawlDirectMessages(account);
logger.info(`Crawled ${messageResult.directMessages.length} messages`);
```

### Master ç«¯æŸ¥è¯¢

```javascript
// æŸ¥è¯¢ç‰¹å®šå¹³å°ç”¨æˆ·çš„æ–°è¯„è®º
const newComments = commentsDAO.findAll({
  account_id: 'account-123',
  platform_user_id: 'douyin-user-456',
  is_new: true
});

// ç»Ÿè®¡è§†é¢‘æ•°æ®
const stats = douyinVideoDAO.getVideoStats('account-123', 'douyin-user-456');
console.log(stats);
// {
//   total_videos: 10,
//   total_comments: 100,
//   new_comments: 5,
//   total_likes: 1000,
//   total_plays: 10000
// }
```

---

## ä¹ã€å¾…æµ‹è¯•é¡¹ç›®

1. âœ… Worker ç«¯çˆ¬è™«å®ç°
2. âœ… Master-Worker Socket.IO é€šä¿¡
3. ğŸ”² å®Œæ•´çš„çˆ¬å–æµç¨‹æµ‹è¯•ï¼ˆè¯„è®º + ç§ä¿¡ï¼‰
4. ğŸ”² platform_user_id æ•°æ®éš”ç¦»æµ‹è¯•
5. ğŸ”² å¢é‡çˆ¬å–å‡†ç¡®æ€§æµ‹è¯•
6. ğŸ”² é€šçŸ¥æ¨é€æµ‹è¯•
7. ğŸ”² æ€§èƒ½æµ‹è¯•ï¼ˆå¤§é‡è¯„è®ºåœºæ™¯ï¼‰
8. ğŸ”² é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶æµ‹è¯•

---

## åã€ç›¸å…³æ–‡æ¡£

- [å¢é‡æŠ“å–å®ç°æŒ‡å—.md](./å¢é‡æŠ“å–å®ç°æŒ‡å—.md)
- [DAOå±‚platform_user_idæ”¯æŒæ€»ç»“.md](./DAOå±‚platform_user_idæ”¯æŒæ€»ç»“.md)
- [is_newå­—æ®µè®¾è®¡ä¸ä¼˜åŒ–.md](./is_newå­—æ®µè®¾è®¡ä¸ä¼˜åŒ–.md)
- [å¹³å°ç”¨æˆ·IDè®¾è®¡è¯´æ˜.md](./å¹³å°ç”¨æˆ·IDè®¾è®¡è¯´æ˜.md)
- [æŠ–éŸ³çˆ¬è™«å®ç°è¯´æ˜.md](./æŠ–éŸ³çˆ¬è™«å®ç°è¯´æ˜.md)

---

## åä¸€ã€ä¸‹ä¸€æ­¥è®¡åˆ’

1. **æµ‹è¯•çˆ¬è™«åŠŸèƒ½**
   - ä½¿ç”¨çœŸå®æŠ–éŸ³è´¦å·æµ‹è¯•ç™»å½•
   - éªŒè¯è¯„è®ºå’Œç§ä¿¡çˆ¬å–
   - éªŒè¯å¢é‡çˆ¬å–é€»è¾‘

2. **å®Œå–„é”™è¯¯å¤„ç†**
   - ç½‘ç»œè¶…æ—¶é‡è¯•
   - APIå˜æ›´æ£€æµ‹
   - ç™»å½•çŠ¶æ€å¤±æ•ˆå¤„ç†

3. **ä¼˜åŒ–æ€§èƒ½**
   - å¹¶å‘çˆ¬å–å¤šä¸ªè´¦å·
   - æ™ºèƒ½è°ƒåº¦ï¼ˆæ ¹æ®è´¦å·æ´»è·ƒåº¦è°ƒæ•´çˆ¬å–é¢‘ç‡ï¼‰
   - ç¼“å­˜æœºåˆ¶

4. **æ‰©å±•åŠŸèƒ½**
   - æ”¯æŒå…¶ä»–å¹³å°ï¼ˆå°çº¢ä¹¦ã€å¿«æ‰‹ç­‰ï¼‰
   - æƒ…æ„Ÿåˆ†æ
   - å…³é”®è¯ç›‘æ§

---

## åäºŒã€æ€»ç»“

æœ¬æ¬¡å®ç°å®Œæˆäº†ï¼š
- âœ… Worker ç«¯å®Œæ•´çš„æŠ–éŸ³çˆ¬è™«å®ç°ï¼ˆè¯„è®º + ç§ä¿¡ï¼‰
- âœ… Master-Worker Socket.IO é€šä¿¡æœºåˆ¶
- âœ… å¢é‡çˆ¬å–æœåŠ¡ï¼ˆæ”¯æŒæ—¶é—´ä¼˜åŒ–ï¼‰
- âœ… æ•°æ®éš”ç¦»ï¼ˆplatform_user_idï¼‰
- âœ… å®æ—¶é€šçŸ¥ç”Ÿæˆå’Œæ¨é€
- âœ… å®Œæ•´çš„ DAO å±‚æ”¯æŒ
- âœ… è¯¦ç»†çš„æ–‡æ¡£å’Œä»£ç æ³¨é‡Š

ç³»ç»Ÿå·²å…·å¤‡å®Œæ•´çš„çˆ¬è™«èƒ½åŠ›ï¼Œå¯ä»¥è¿›è¡Œå®é™…æµ‹è¯•å’Œéƒ¨ç½²ã€‚
