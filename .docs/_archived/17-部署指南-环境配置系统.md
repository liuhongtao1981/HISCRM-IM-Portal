# 部署指南 - 环境配置系统

## 🎯 概述

HisCRM-IM 支持三层配置系统，允许在任何环境中灵活部署，不需要修改代码。

### 三层配置优先级

```
┌─────────────────────────────────────────┐
│  第 1 层: 环境变量 (最高优先级)         │
│  ✅ 用于 Docker/Kubernetes/云部署      │
│  ✅ 用于快速临时配置                    │
└─────────────────────────────────────────┘
              ▼
┌─────────────────────────────────────────┐
│  第 2 层: config.json 配置文件          │
│  ✅ 用于标准部署                        │
│  ✅ 用于保存完整配置                    │
└─────────────────────────────────────────┘
              ▼
┌─────────────────────────────────────────┐
│  第 3 层: 代码中的默认配置              │
│  ✅ 用于开发环境                        │
│  ✅ 用于本地测试                        │
└─────────────────────────────────────────┘
```

---

## 📦 配置文件说明

### 1. 环境变量 (.env)

**用途**: 快速配置部署环境

**位置**: 项目根目录 `.env` 文件

**创建方式**:
```bash
cp .env.example .env
# 然后编辑 .env 文件根据实际环境修改值
```

**示例** (`.env`):
```ini
NODE_ENV=production

MASTER_HOST=0.0.0.0
MASTER_PORT=3000

WORKER_ID=worker-1
WORKER_MASTER_HOST=192.168.1.10
WORKER_MASTER_PORT=3000

# 关键：指定应用根目录
APP_ROOT=/opt/hiscrm-im

# 指定 Worker 平台目录 (可选)
WORKER_PLATFORMS_PATH=/opt/hiscrm-im/platforms
```

### 2. 配置文件 (config.json)

**用途**: 完整的配置管理

**位置**: 项目根目录 `config.json` 文件

**创建方式**:
```bash
cp config.example.json config.json
# 然后编辑 config.json 文件根据实际环境修改值
```

**示例** (生产环境 `config.json`):
```json
{
  "environment": "production",

  "paths": {
    "projectRoot": "/opt/hiscrm-im",

    "master": {
      "data": "/data/hiscrm-im/master"
    },

    "worker": {
      "data": "/data/hiscrm-im/worker",
      "platforms": "/opt/hiscrm-im/platforms"
    },

    "logs": {
      "master": "/var/log/hiscrm-im/master",
      "worker": "/var/log/hiscrm-im/worker"
    }
  },

  "server": {
    "master": {
      "port": 3000
    }
  }
}
```

---

## 🚀 部署场景

### 场景 1: 开发环境 (本地)

**特点**: 使用默认配置，无需修改任何配置文件

```bash
# 直接启动 (使用代码中的默认配置)
cd packages/master && npm start
cd packages/worker && npm start
```

**配置方式**: 不需要配置文件，直接运行

---

### 场景 2: 单服务器部署

**特点**: Master 和 Worker 在同一服务器，但路径可能不同

**步骤**:

1. **创建 config.json**:
   ```bash
   cp config.example.json config.json
   ```

2. **修改 config.json**:
   ```json
   {
     "paths": {
       "projectRoot": "/home/app/hiscrm-im",

       "master": {
         "data": "/data/hiscrm-im/master"
       },

       "worker": {
         "data": "/data/hiscrm-im/worker",
         "platforms": "/home/app/hiscrm-im/platforms"
       },

       "logs": {
         "master": "/var/log/hiscrm/master",
         "worker": "/var/log/hiscrm/worker"
       }
     }
   }
   ```

3. **启动服务**:
   ```bash
   # Master
   cd /home/app/hiscrm-im && npm run start:master

   # Worker
   cd /home/app/hiscrm-im && npm run start:worker
   ```

---

### 场景 3: 多服务器部署 (Master 和 Worker 分离)

**架构**:
```
┌──────────────────────┐         ┌──────────────────────┐
│  Master 服务器       │         │  Worker 服务器       │
│  192.168.1.10:3000   │◄──────►│  192.168.1.20:4001   │
│                      │ 网络   │                      │
│ /opt/hiscrm/master   │ 通信   │ /app/hiscrm/worker   │
└──────────────────────┘         └──────────────────────┘
```

**Master 端 config.json**:
```json
{
  "environment": "production",

  "paths": {
    "projectRoot": "/opt/hiscrm/master",
    "master": {
      "data": "/data/master"
    }
  },

  "server": {
    "master": {
      "host": "0.0.0.0",
      "port": 3000
    }
  }
}
```

**Worker 端 config.json**:
```json
{
  "environment": "production",

  "paths": {
    "projectRoot": "/app/hiscrm/worker",
    "worker": {
      "data": "/data/worker",
      "platforms": "/app/hiscrm/worker/platforms"
    }
  },

  "worker": {
    "id": "worker-1",
    "masterHost": "192.168.1.10",
    "masterPort": 3000
  }
}
```

**启动**:
```bash
# Master 端
export CONFIG_FILE=/opt/hiscrm/master/config.json
cd /opt/hiscrm/master && npm run start:master

# Worker 端
export CONFIG_FILE=/app/hiscrm/worker/config.json
cd /app/hiscrm/worker && npm run start:worker
```

---

### 场景 4: Docker 容器部署

**Dockerfile 示例**:
```dockerfile
FROM node:18-alpine

WORKDIR /app

# 复制应用
COPY . .

# 安装依赖
RUN npm install

# 设置环境变量
ENV APP_ROOT=/app
ENV NODE_ENV=production
ENV WORKER_PLATFORMS_PATH=/app/platforms

# 启动命令 (使用 CMD 传递参数)
CMD ["npm", "run", "start:master"]
```

**docker-compose.yml**:
```yaml
version: '3'

services:
  master:
    image: hiscrm-im:latest
    ports:
      - "3000:3000"
    environment:
      APP_ROOT: /app
      NODE_ENV: production
      WORKER_PLATFORMS_PATH: /app/platforms
    volumes:
      - master-data:/data/master
      - master-logs:/var/log/master

  worker:
    image: hiscrm-im:latest
    environment:
      APP_ROOT: /app
      NODE_ENV: production
      WORKER_ID: worker-1
      WORKER_PLATFORMS_PATH: /app/platforms
      WORKER_MASTER_HOST: master
      WORKER_MASTER_PORT: 3000
    volumes:
      - worker-data:/data/worker
      - worker-logs:/var/log/worker
    depends_on:
      - master

volumes:
  master-data:
  master-logs:
  worker-data:
  worker-logs:
```

**启动**:
```bash
docker-compose up -d
```

---

### 场景 5: Kubernetes 部署

**ConfigMap 配置**:
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: hiscrm-config
data:
  config.json: |
    {
      "paths": {
        "projectRoot": "/app",
        "worker": {
          "platforms": "/app/platforms"
        }
      }
    }
```

**Deployment 示例**:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hiscrm-master
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hiscrm-master
  template:
    metadata:
      labels:
        app: hiscrm-master
    spec:
      containers:
      - name: master
        image: hiscrm-im:latest
        ports:
        - containerPort: 3000
        env:
        - name: APP_ROOT
          value: "/app"
        - name: NODE_ENV
          value: "production"
        - name: CONFIG_FILE
          value: "/etc/hiscrm/config.json"
        volumeMounts:
        - name: config
          mountPath: /etc/hiscrm
        - name: data
          mountPath: /data
      volumes:
      - name: config
        configMap:
          name: hiscrm-config
      - name: data
        emptyDir: {}
```

---

## 🔧 环境变量参考

### 关键环境变量

| 变量 | 说明 | 例值 |
|-----|------|------|
| `APP_ROOT` | 应用根目录 (最重要) | `/opt/hiscrm-im` |
| `CONFIG_FILE` | 配置文件路径 | `/etc/hiscrm/config.json` |
| `NODE_ENV` | 运行环境 | `production` |
| `WORKER_PLATFORMS_PATH` | Worker 平台目录 | `/app/platforms` |
| `MASTER_DATA_PATH` | Master 数据目录 | `/data/master` |
| `WORKER_DATA_PATH` | Worker 数据目录 | `/data/worker` |
| `MASTER_LOGS_PATH` | Master 日志目录 | `/var/log/master` |
| `WORKER_LOGS_PATH` | Worker 日志目录 | `/var/log/worker` |
| `DATABASE_PATH` | 数据库文件路径 | `/data/master/master.db` |

### 完整的环境变量设置

```bash
# 基本配置
export NODE_ENV=production
export APP_ROOT=/opt/hiscrm-im

# 路径配置
export WORKER_PLATFORMS_PATH=/opt/hiscrm-im/platforms
export MASTER_DATA_PATH=/data/hiscrm/master
export WORKER_DATA_PATH=/data/hiscrm/worker
export MASTER_LOGS_PATH=/var/log/hiscrm/master
export WORKER_LOGS_PATH=/var/log/hiscrm/worker
export DATABASE_PATH=/data/hiscrm/master/master.db

# 服务器配置
export MASTER_HOST=0.0.0.0
export MASTER_PORT=3000

# Worker 配置
export WORKER_ID=worker-1
export WORKER_MASTER_HOST=192.168.1.10
export WORKER_MASTER_PORT=3000
export WORKER_MAX_ACCOUNTS=10

# 其他配置
export LOG_LEVEL=info
export CONFIG_FILE=/etc/hiscrm/config.json
```

---

## 📝 配置加载优先级

### 示例：确定 Worker 平台目录

```
1. 检查环境变量 WORKER_PLATFORMS_PATH
   ✓ 存在？返回该值
   ✗ 不存在→继续

2. 检查 config.json 中的 paths.worker.platforms
   ✓ 存在？返回该值
   ✗ 不存在→继续

3. 使用默认值
   返回: packages/worker/src/platforms
```

### 实际例子

```bash
# 方式 1: 环境变量 (最优先)
export WORKER_PLATFORMS_PATH=/custom/platforms
npm start
# 结果: 使用 /custom/platforms

# 方式 2: config.json
# 在 config.json 中设置 paths.worker.platforms: "/opt/platforms"
npm start
# 结果: 使用 /opt/platforms

# 方式 3: 默认值 (开发环境)
npm start
# 结果: 使用 packages/worker/src/platforms
```

---

## ✅ 部署检查清单

### 部署前检查

- ✅ 配置文件 (config.json) 是否正确创建?
- ✅ 环境变量是否已设置?
- ✅ 路径是否正确 (特别是 WORKER_PLATFORMS_PATH)?
- ✅ 数据目录是否存在并有写入权限?
- ✅ 日志目录是否存在?
- ✅ Master 和 Worker 网络是否连通?

### 验证配置

启动应用后，查看日志中的配置信息：

```bash
# 在日志中应该看到类似的输出：
[PATHS] 已加载配置文件: /opt/hiscrm/config.json
[PATHS] 配置信息:
  项目根目录: /opt/hiscrm-im
  Master 数据: /data/hiscrm/master
  Worker 平台: /opt/hiscrm-im/platforms
  数据库: /data/hiscrm/master/master.db
```

### 故障排除

| 问题 | 原因 | 解决方案 |
|-----|------|---------|
| "找不到平台目录" | WORKER_PLATFORMS_PATH 配置错误 | 检查 config.json 或环境变量 |
| "数据库文件找不到" | DATABASE_PATH 配置错误 | 确保目录存在，检查路径配置 |
| "日志无法写入" | 日志目录不存在或无权限 | 创建日志目录，检查权限 |
| "连接失败" | Master/Worker 网络配置错误 | 检查 WORKER_MASTER_HOST/PORT |

---

## 📊 配置示例对比

### 开发环境
```json
{
  "environment": "development",
  "paths": {
    "projectRoot": "./"
  }
}
```

### 测试环境
```json
{
  "environment": "staging",
  "paths": {
    "projectRoot": "/home/test/hiscrm-im",
    "master": { "data": "/data/test/master" },
    "worker": { "platforms": "/home/test/hiscrm-im/platforms" }
  }
}
```

### 生产环境
```json
{
  "environment": "production",
  "paths": {
    "projectRoot": "/opt/hiscrm-im",
    "master": { "data": "/data/prod/master" },
    "worker": { "platforms": "/opt/hiscrm-im/platforms" },
    "logs": {
      "master": "/var/log/hiscrm/master",
      "worker": "/var/log/hiscrm/worker"
    }
  },
  "logging": {
    "level": "info",
    "format": "json"
  }
}
```

---

## 🚀 快速开始

### 开发环境（推荐，最简单）

```bash
# 无需任何配置，直接运行
npm run dev
```

### 单服务器生产部署

```bash
# 1. 复制配置文件
cp config.example.json config.json

# 2. 编辑配置
nano config.json
# 修改 paths.projectRoot 和其他路径

# 3. 启动
npm run start:master &
npm run start:worker &
```

### Docker 部署（推荐）

```bash
# 1. 构建镜像
docker build -t hiscrm-im:latest .

# 2. 运行容器
docker run -d \
  -e APP_ROOT=/app \
  -e NODE_ENV=production \
  -e WORKER_PLATFORMS_PATH=/app/platforms \
  -p 3000:3000 \
  hiscrm-im:latest
```

---

## 💡 最佳实践

### 1. 始终使用环境变量指定 APP_ROOT
```bash
export APP_ROOT=/opt/hiscrm-im
npm start
```

### 2. 配置文件应该包含完整的路径信息
```json
{
  "paths": {
    "projectRoot": "/opt/hiscrm-im",
    "worker": {
      "platforms": "/opt/hiscrm-im/platforms"
    }
  }
}
```

### 3. 日志和数据目录分离
```json
{
  "paths": {
    "master": {
      "data": "/data/master",
      "logs": "/var/log/master"
    }
  }
}
```

### 4. Docker 中始终设置环境变量
```dockerfile
ENV APP_ROOT=/app
ENV NODE_ENV=production
ENV WORKER_PLATFORMS_PATH=/app/platforms
```

### 5. 生产环境使用绝对路径
```bash
# ✅ 推荐
export WORKER_PLATFORMS_PATH=/opt/hiscrm-im/platforms

# ❌ 不推荐
export WORKER_PLATFORMS_PATH=./packages/worker/src/platforms
```

---

## 📚 相关文档

- [15-共享路径配置系统.md](./15-共享路径配置系统.md) - 路径配置架构
- [DEPLOYMENT.md](../DEPLOYMENT.md) - 部署脚本

---

## ✅ 检查表

- ✅ 配置文件支持三层优先级 (环境变量 > config.json > 默认值)
- ✅ 支持绝对路径和相对路径混合
- ✅ 开发环境无需配置文件
- ✅ 生产环境支持完整配置
- ✅ Docker/Kubernetes 友好
- ✅ 配置验证和错误提示
- ✅ 配置信息输出便于调试

---

**完成日期**: 2025-10-20
**支持的部署环境**: 本地、单服务器、多服务器、Docker、Kubernetes
**配置方式**: 环境变量、config.json、代码默认值

🚀 **现在可以在任何环境中灵活部署，无需修改代码！**
