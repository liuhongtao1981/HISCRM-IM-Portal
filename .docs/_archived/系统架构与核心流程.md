# HisCrm-IM ç³»ç»Ÿæ¶æ„ä¸æ ¸å¿ƒæµç¨‹

**æ—¥æœŸ**: 2025-10-16
**ç‰ˆæœ¬**: 2.0.0

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
2. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
3. [å…³é”®æµç¨‹](#å…³é”®æµç¨‹)
4. [æ•°æ®æµè½¬](#æ•°æ®æµè½¬)
5. [é€šä¿¡æœºåˆ¶](#é€šä¿¡æœºåˆ¶)
6. [çŠ¶æ€ç®¡ç†](#çŠ¶æ€ç®¡ç†)

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         HisCrm-IM ç³»ç»Ÿ                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Admin Web   â”‚â—„â”€â”€â”€â”€Socket.IOâ”€â”€â”€â”€â”¤    Master    â”‚
â”‚  (React)     â”‚   /admin         â”‚   (Node.js)  â”‚
â”‚  ç«¯å£: 3001  â”‚                  â”‚   ç«¯å£: 3000 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â”‚ Socket.IO
                                         â”‚ /worker
                                         â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                      â”‚                      â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
           â”‚  Worker 1   â”‚        â”‚  Worker 2  â”‚       â”‚  Worker N   â”‚
           â”‚  (Node.js)  â”‚        â”‚  (Node.js) â”‚       â”‚  (Node.js)  â”‚
           â”‚  ç«¯å£: 4000 â”‚        â”‚ ç«¯å£: 4001 â”‚       â”‚ ç«¯å£: 400N â”‚
           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                     â”‚                      â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Browser (è´¦æˆ·A) â”‚   â”‚ Browser (è´¦æˆ·C) â”‚   â”‚ Browser (è´¦æˆ·E) â”‚
         â”‚ Browser (è´¦æˆ·B) â”‚   â”‚ Browser (è´¦æˆ·D) â”‚   â”‚ Browser (è´¦æˆ·F) â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                     â”‚                      â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â–¼
                            æŠ–éŸ³/å°çº¢ä¹¦ç­‰ç¤¾äº¤å¹³å°
```

### æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯ | è¯´æ˜ |
|------|------|------|
| **è¿è¡Œæ—¶** | Node.js 18.x LTS | ç»Ÿä¸€è¿è¡Œç¯å¢ƒ |
| **é€šä¿¡** | Socket.IO 4.x | WebSocket + JSON é€šä¿¡ |
| **æ•°æ®åº“** | SQLite 3.x (better-sqlite3) | Master æ•°æ®å­˜å‚¨ |
| **æµè§ˆå™¨è‡ªåŠ¨åŒ–** | Playwright | å¤š Browser æ¶æ„ |
| **å‰ç«¯** | React 18 + Ant Design | Admin Web UI |
| **è¿›ç¨‹ç®¡ç†** | PM2 / child_process | ç”Ÿäº§ç¯å¢ƒéƒ¨ç½² |

---

## ğŸ§© æ ¸å¿ƒç»„ä»¶

### 1. Master Server (ä¸»æ§æœåŠ¡å™¨)

**èŒè´£**: ä¸­å¤®åè°ƒå™¨ï¼Œç®¡ç†æ‰€æœ‰ Worker å’Œè´¦æˆ·

**æ ¸å¿ƒæ¨¡å—**:
```javascript
packages/master/src/
â”œâ”€â”€ index.js                      // å…¥å£ï¼Œåˆå§‹åŒ–æ‰€æœ‰æœåŠ¡
â”œâ”€â”€ database/                     // æ•°æ®åº“å±‚
â”‚   â”œâ”€â”€ init.js                   // æ•°æ®åº“åˆå§‹åŒ–
â”‚   â”œâ”€â”€ schema.sql                // æ•°æ®åº“è¡¨ç»“æ„
â”‚   â”œâ”€â”€ accounts-dao.js           // è´¦æˆ·æ•°æ®è®¿é—®
â”‚   â”œâ”€â”€ worker-config-dao.js      // Worker é…ç½®
â”‚   â””â”€â”€ worker-runtime-dao.js     // Worker è¿è¡Œæ—¶çŠ¶æ€
â”œâ”€â”€ communication/                // é€šä¿¡å±‚
â”‚   â”œâ”€â”€ socket-server.js          // Socket.IO æœåŠ¡å™¨
â”‚   â””â”€â”€ session-manager.js        // ä¼šè¯ç®¡ç†
â”œâ”€â”€ worker_manager/               // Worker ç®¡ç†å±‚
â”‚   â”œâ”€â”€ lifecycle-manager.js      // Worker ç”Ÿå‘½å‘¨æœŸ
â”‚   â”œâ”€â”€ account-assigner.js       // è´¦æˆ·åˆ†é…
â”‚   â””â”€â”€ local-process-manager.js  // æœ¬åœ° Worker è¿›ç¨‹ç®¡ç†
â”œâ”€â”€ scheduler/                    // è°ƒåº¦å±‚
â”‚   â””â”€â”€ task-scheduler.js         // ä»»åŠ¡è°ƒåº¦å™¨
â”œâ”€â”€ login/                        // ç™»å½•ç®¡ç†
â”‚   â””â”€â”€ login-handler.js          // ç™»å½•ä¼šè¯å¤„ç†
â””â”€â”€ socket/                       // Socket å‘½åç©ºé—´
    â””â”€â”€ admin-namespace.js        // Admin å‘½åç©ºé—´
```

**å…³é”®èŒè´£**:
- âœ… æ¥æ”¶ Worker æ³¨å†Œå’Œå¿ƒè·³
- âœ… åˆ†é…è´¦æˆ·åˆ°åˆé€‚çš„ Worker
- âœ… ç®¡ç†ç™»å½•ä¼šè¯ï¼ˆäºŒç»´ç ç™»å½•ï¼‰
- âœ… å­˜å‚¨è´¦æˆ·å‡­æ®ï¼ˆCookieã€ç”¨æˆ·ä¿¡æ¯ã€æŒ‡çº¹ï¼‰
- âœ… ä¸ Admin Web é€šä¿¡ï¼Œæ¨é€çŠ¶æ€æ›´æ–°
- âœ… æ¥æ”¶ç›‘æ§æ•°æ®ï¼ˆè¯„è®ºã€ç§ä¿¡ï¼‰

### 2. Worker (å·¥ä½œèŠ‚ç‚¹)

**èŒè´£**: æ‰§è¡Œå®é™…çš„æµè§ˆå™¨è‡ªåŠ¨åŒ–å’Œæ•°æ®æŠ“å–

**æ ¸å¿ƒæ¨¡å—**:
```javascript
packages/worker/src/
â”œâ”€â”€ index.js                      // å…¥å£ï¼Œè¿æ¥ Master
â”œâ”€â”€ platform-manager.js           // å¹³å°è„šæœ¬ç®¡ç†å™¨
â”œâ”€â”€ platforms/                    // å¹³å°è„šæœ¬
â”‚   â”œâ”€â”€ base/
â”‚   â”‚   â”œâ”€â”€ platform-base.js      // å¹³å°åŸºç±»
â”‚   â”‚   â””â”€â”€ worker-bridge.js      // Worker â†” Master é€šä¿¡æ¡¥æ¥
â”‚   â””â”€â”€ douyin/
â”‚       â”œâ”€â”€ platform.js           // æŠ–éŸ³å¹³å°å®ç°
â”‚       â””â”€â”€ config.json           // æŠ–éŸ³é…ç½®ï¼ˆURLã€é€‰æ‹©å™¨ç­‰ï¼‰
â”œâ”€â”€ browser/                      // æµè§ˆå™¨ç®¡ç†
â”‚   â””â”€â”€ browser-manager-v2.js     // å¤š Browser ç®¡ç†å™¨
â”œâ”€â”€ handlers/                     // ä»»åŠ¡å¤„ç†
â”‚   â”œâ”€â”€ task-runner.js            // ä»»åŠ¡æ‰§è¡Œå™¨
â”‚   â””â”€â”€ monitor-task.js           // ç›‘æ§ä»»åŠ¡
â””â”€â”€ communication/                // é€šä¿¡å±‚
    â”œâ”€â”€ socket-client.js          // Socket.IO å®¢æˆ·ç«¯
    â”œâ”€â”€ registration.js           // Worker æ³¨å†Œ
    â””â”€â”€ heartbeat.js              // å¿ƒè·³å‘é€
```

**å…³é”®èŒè´£**:
- âœ… æ³¨å†Œåˆ° Master å¹¶å‘é€å¿ƒè·³
- âœ… æ¥æ”¶ä»»åŠ¡åˆ†é…ï¼ˆè´¦æˆ·ç›‘æ§ã€ç™»å½•è¯·æ±‚ï¼‰
- âœ… ç®¡ç†å¤šä¸ª Browser å®ä¾‹ï¼ˆæ¯è´¦æˆ·ä¸€ä¸ªï¼‰
- âœ… æ‰§è¡Œç™»å½•æµç¨‹ï¼ˆæå–äºŒç»´ç ã€æ£€æµ‹ç™»å½•çŠ¶æ€ï¼‰
- âœ… æ‰§è¡Œç›‘æ§ä»»åŠ¡ï¼ˆçˆ¬å–è¯„è®ºã€ç§ä¿¡ï¼‰
- âœ… å‘é€æ•°æ®å› Masterï¼ˆCookieã€ç”¨æˆ·ä¿¡æ¯ã€ç›‘æ§æ•°æ®ï¼‰

### 3. Admin Web (ç®¡ç†åå°)

**èŒè´£**: å¯è§†åŒ–ç®¡ç†ç•Œé¢

**æ ¸å¿ƒé¡µé¢**:
```javascript
packages/admin-web/src/
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ AccountsPage.js           // è´¦æˆ·ç®¡ç†ï¼ˆæ·»åŠ ã€ç¼–è¾‘ã€ç™»å½•ï¼‰
â”‚   â”œâ”€â”€ WorkersPage.js            // Worker ç®¡ç†ï¼ˆæŸ¥çœ‹çŠ¶æ€ã€å¯åœï¼‰
â”‚   â””â”€â”€ LoginManagementPage.js    // ç™»å½•ç®¡ç†ï¼ˆæŸ¥çœ‹ç™»å½•ä¼šè¯ï¼‰
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ LoginModal.js             // ç™»å½•å¼¹çª—ï¼ˆæ˜¾ç¤ºäºŒç»´ç ï¼‰
â”‚   â””â”€â”€ QRCodeModal.js            // äºŒç»´ç æ˜¾ç¤ºç»„ä»¶
â””â”€â”€ services/
    â”œâ”€â”€ socketContext.js          // Socket.IO ä¸Šä¸‹æ–‡
    â””â”€â”€ api.js                    // HTTP API è°ƒç”¨
```

**å…³é”®åŠŸèƒ½**:
- âœ… è´¦æˆ· CRUDï¼ˆåˆ›å»ºã€æŸ¥çœ‹ã€ç¼–è¾‘ã€åˆ é™¤ï¼‰
- âœ… å‘èµ·ç™»å½•è¯·æ±‚ï¼Œæ˜¾ç¤ºäºŒç»´ç 
- âœ… å®æ—¶æŸ¥çœ‹ç™»å½•çŠ¶æ€å’Œç”¨æˆ·ä¿¡æ¯
- âœ… Worker çŠ¶æ€ç›‘æ§
- âœ… æŸ¥çœ‹ç™»å½•ä¼šè¯å†å²

### 4. Shared (å…±äº«æ¨¡å—)

**èŒè´£**: è·¨åŒ…å…±äº«ä»£ç 

```javascript
packages/shared/
â”œâ”€â”€ protocol/
â”‚   â”œâ”€â”€ messages.js               // æ¶ˆæ¯ç±»å‹å¸¸é‡
â”‚   â””â”€â”€ events.js                 // äº‹ä»¶ç±»å‹å¸¸é‡
â”œâ”€â”€ models/
â”‚   â””â”€â”€ Account.js                // è´¦æˆ·æ¨¡å‹
â””â”€â”€ utils/
    â”œâ”€â”€ logger.js                 // æ—¥å¿—å·¥å…·
    â””â”€â”€ validator.js              // æ•°æ®éªŒè¯
```

---

## ğŸ”„ å…³é”®æµç¨‹

### æµç¨‹ 1: Worker æ³¨å†Œæµç¨‹

```
Worker å¯åŠ¨
    â†“
1. è¿æ¥ Master Socket.IO (/worker å‘½åç©ºé—´)
    â†“
2. å‘é€ WORKER_REGISTER æ¶ˆæ¯
   {
     workerId: 'worker-123',
     capabilities: ['douyin', 'xiaohongshu'],  // æ”¯æŒçš„å¹³å°
     maxAccounts: 10,
     host: '127.0.0.1',
     port: 4000,
     version: '1.0.0'
   }
    â†“
3. Master éªŒè¯å¹¶å­˜å‚¨åˆ° workers è¡¨
    â†“
4. Master è¿”å› WORKER_REGISTERED
    â†“
5. Worker å¼€å§‹å‘é€å¿ƒè·³ (æ¯ 10 ç§’)
   WORKER_HEARTBEAT {
     workerId,
     stats: { activeAccounts, memoryUsage, cpuUsage }
   }
    â†“
6. Master æ›´æ–° workers.last_heartbeat
    â†“
7. Master åˆ†é…è´¦æˆ· (å¦‚æœæœ‰å¾…åˆ†é…çš„è´¦æˆ·)
   MASTER_TASK_ASSIGN {
     accounts: [{id, platform, ...}]
   }
    â†“
8. Worker æ¥æ”¶å¹¶å¯åŠ¨ç›‘æ§ä»»åŠ¡
```

**å…³é”®ä»£ç ä½ç½®**:
- Worker æ³¨å†Œ: [packages/worker/src/communication/registration.js](../packages/worker/src/communication/registration.js)
- Master å¤„ç†: [packages/master/src/communication/socket-server.js:51-63](../packages/master/src/communication/socket-server.js#L51-L63)

---

### æµç¨‹ 2: è´¦æˆ·ç™»å½•æµç¨‹ï¼ˆäºŒç»´ç ï¼‰

```
Admin Web ç‚¹å‡»"ç™»å½•"æŒ‰é’®
    â†“
1. Admin Web â†’ Master: admin:login:start
   {
     accountId: 'acc-xxx',
     workerId: 'worker-123'  (å¯é€‰ï¼Œè‡ªåŠ¨åˆ†é…)
   }
    â†“
2. Master åˆ›å»º login_sessions è®°å½•
   {
     id: 'session-xxx',
     account_id: 'acc-xxx',
     worker_id: 'worker-123',
     status: 'pending',
     expires_at: now + 300  // 5 åˆ†é’Ÿ
   }
    â†“
3. Master â†’ Worker: master:login:start
   {
     sessionId: 'session-xxx',
     accountId: 'acc-xxx',
     platform: 'douyin',
     proxy: {...}
   }
    â†“
4. Worker æ‰§è¡Œç™»å½•:
   - å¯åŠ¨ Browser (account-specific)
   - åŠ è½½æŒ‡çº¹é…ç½®
   - è®¿é—®ç™»å½•é¡µé¢
   - æ£€æµ‹ç™»å½•æ–¹å¼ (äºŒç»´ç /çŸ­ä¿¡)
    â†“
5. Worker æå–äºŒç»´ç 
   const qrElement = await page.$('#qrcode img');
   const qrImage = await qrElement.screenshot();
   const qrBase64 = qrImage.toString('base64');
    â†“
6. Worker â†’ Master: worker:login:qrcode
   {
     sessionId,
     qr_code_data: 'data:image/png;base64,...',
     qr_code_url: 'https://...'  (å¯é€‰)
   }
    â†“
7. Master æ›´æ–° login_sessions (qr_code_data, status='scanning')
    â†“
8. Master â†’ Admin Web: login:qrcode:ready
   {
     session_id,
     account_id,
     qr_code_data,
     expires_at
   }
    â†“
9. Admin Web æ˜¾ç¤ºäºŒç»´ç å¼¹çª—
    â†“
10. Worker è½®è¯¢ç™»å½•çŠ¶æ€ (æ¯ 2 ç§’)
    while (!loggedIn) {
      status = await checkLoginStatus(page);
      if (status.isLoggedIn) break;
      await sleep(2000);
    }
    â†“
11. ç”¨æˆ·æ‰«ç æˆåŠŸï¼ŒWorker æ£€æµ‹åˆ°ç™»å½•
    â†“
12. Worker æå–æ•°æ®:
    - cookies = await page.context().cookies();
    - userInfo = await extractUserInfo(page);  // æ˜µç§°ã€å¤´åƒã€æŠ–éŸ³å·
    - fingerprint = browserManager.getOrCreateFingerprintConfig(accountId);
    â†“
13. Worker ä¿å­˜åˆ°æœ¬åœ°:
    - data/browser/worker-1/{accountId}_storage.json  (Cookies + Storage)
    - data/browser/worker-1/fingerprints/{accountId}_fingerprint.json
    â†“
14. Worker â†’ Master: worker:login:status
    {
      sessionId,
      status: 'success',
      cookies: [{name, value, domain, ...}, ...],
      user_info: {nickname, avatar, douyin_id, uid, ...},
      fingerprint: {userAgent, viewport, webgl, ...},
      cookies_valid_until: now + 7å¤©
    }
    â†“
15. Master å¤„ç†ç™»å½•æˆåŠŸ:
    - æ›´æ–° login_sessions (status='success', logged_in_at=now)
    - æ›´æ–° accounts è¡¨:
      * login_status = 'logged_in'
      * credentials = JSON.stringify({cookies})
      * user_info = JSON.stringify(userInfo)
      * fingerprint = JSON.stringify(fingerprint)
      * last_login_time = now
      * cookies_valid_until = now + 7å¤©
      * account_id = userInfo.douyin_id (å¦‚æœæ˜¯ä¸´æ—¶ID)
    â†“
16. Master â†’ Admin Web: login:success
    {
      session_id,
      account_id,
      user_info,
      logged_in_at
    }
    â†“
17. Admin Web å…³é—­äºŒç»´ç å¼¹çª—ï¼Œæ˜¾ç¤ºæˆåŠŸæç¤º
    â†“
18. Admin Web åˆ·æ–°è´¦æˆ·åˆ—è¡¨ï¼Œæ˜¾ç¤º:
    - ç”¨æˆ·å¤´åƒ + æ˜µç§°
    - ç™»å½•çŠ¶æ€: "å·²ç™»å½•" (ç»¿è‰²)
    - Cookie çŠ¶æ€: "25 ä¸ª Cookie, æœ‰æ•ˆæœŸè‡³ 2025-10-23"
```

**å…³é”®ä»£ç ä½ç½®**:
- Admin å‘èµ·: [packages/admin-web/src/pages/AccountsPage.js:115-117](../packages/admin-web/src/pages/AccountsPage.js#L115-L117)
- Master åè°ƒ: [packages/master/src/login/login-handler.js](../packages/master/src/login/login-handler.js)
- Worker æ‰§è¡Œ: [packages/worker/src/platforms/douyin/platform.js:48-136](../packages/worker/src/platforms/douyin/platform.js#L48-L136)
- ç™»å½•æ£€æµ‹: [packages/worker/src/platforms/base/platform-base.js:68-186](../packages/worker/src/platforms/base/platform-base.js#L68-L186)

---

### æµç¨‹ 3: è´¦æˆ·ç›‘æ§æµç¨‹

```
Master å¯åŠ¨ä»»åŠ¡è°ƒåº¦å™¨
    â†“
1. TaskScheduler å®šæœŸæ£€æŸ¥ (æ¯ 30 ç§’)
   - æŸ¥è¯¢ accounts è¡¨ (login_status='logged_in' AND status='active')
   - ä¸ºæ¯ä¸ªè´¦æˆ·åˆ†é…åˆ°åˆé€‚çš„ Worker
    â†“
2. Master â†’ Worker: MASTER_TASK_ASSIGN
   {
     accounts: [
       {id, platform, account_id, monitor_interval, ...}
     ]
   }
    â†“
3. Worker æ¥æ”¶ä»»åŠ¡
   - ä¸ºæ¯ä¸ªè´¦æˆ·åˆ›å»º MonitorTask
   - è®¡ç®—éšæœºç›‘æ§é—´éš” (15-30 ç§’)
    â†“
4. MonitorTask æ‰§è¡Œç›‘æ§:
   setInterval(() => {
     // 4.1 è·å–æˆ–åˆ›å»º Browser Context
     const context = await browserManager.getAccountContext(accountId);

     // 4.2 è·å–å¹³å°å®ä¾‹
     const platform = platformManager.getPlatform('douyin');

     // 4.3 çˆ¬å–è¯„è®º
     const comments = await platform.crawlComments(account);

     // 4.4 çˆ¬å–ç§ä¿¡
     const dms = await platform.crawlDirectMessages(account);

     // 4.5 å‘é€æ•°æ®åˆ° Master
     workerBridge.sendMonitorData(accountId, comments, dms);

   }, randomInterval);
    â†“
5. Worker â†’ Master: worker:message:detected
   {
     type: 'comment',
     account_id: 'acc-xxx',
     messages: [
       {
         id, content, author_name, author_id,
         post_id, post_title, detected_at
       }
     ]
   }
    â†“
6. Master æ¥æ”¶å¹¶å­˜å‚¨:
   - æ’å…¥åˆ° comments è¡¨æˆ– direct_messages è¡¨
   - æ£€æŸ¥æ˜¯å¦éœ€è¦é€šçŸ¥ (é€šçŸ¥è§„åˆ™)
    â†“
7. å¦‚æœéœ€è¦é€šçŸ¥:
   Master â†’ Client (Desktop/Mobile): client:notification
   {
     type: 'new_comment',
     account_id,
     message: {...}
   }
    â†“
8. è®¡ç®—ä¸‹æ¬¡ç›‘æ§æ—¶é—´ (éšæœº 15-30 ç§’)
    â†“
9. å¾ªç¯æ‰§è¡Œ
```

**å…³é”®ä»£ç ä½ç½®**:
- ä»»åŠ¡è°ƒåº¦: [packages/master/src/scheduler/task-scheduler.js](../packages/master/src/scheduler/task-scheduler.js)
- Worker ä»»åŠ¡: [packages/worker/src/handlers/task-runner.js](../packages/worker/src/handlers/task-runner.js)
- ç›‘æ§æ‰§è¡Œ: [packages/worker/src/handlers/monitor-task.js](../packages/worker/src/handlers/monitor-task.js)
- å¹³å°çˆ¬è™«: [packages/worker/src/platforms/douyin/platform.js:551-584](../packages/worker/src/platforms/douyin/platform.js#L551-L584)

---

## ğŸ“Š æ•°æ®æµè½¬

### æ•°æ®æµå‘å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Admin Web  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. å‘èµ·æ“ä½œ (ç™»å½•ã€åˆ›å»ºè´¦æˆ·)
       â”‚ 2. æ¥æ”¶æ›´æ–° (çŠ¶æ€å˜åŒ–ã€é€šçŸ¥)
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Master    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ SQLite  â”‚ â”‚ â† 3. æŒä¹…åŒ–æ•°æ®
â”‚  â”‚  æ•°æ®åº“  â”‚ â”‚    - accounts è¡¨
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    - login_sessions è¡¨
â”‚              â”‚    - workers è¡¨
â”‚              â”‚    - comments/direct_messages è¡¨
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 4. åˆ†é…ä»»åŠ¡ (ç™»å½•ã€ç›‘æ§)
       â”‚ 5. æ¥æ”¶æ•°æ® (Cookieã€ç”¨æˆ·ä¿¡æ¯ã€ç›‘æ§æ•°æ®)
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Worker 1   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚Browser Aâ”‚ â”‚ â† 6. è´¦æˆ· A ä¸“å± Browser
â”‚  â”‚Browser Bâ”‚ â”‚ â† 7. è´¦æˆ· B ä¸“å± Browser
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚              â”‚
â”‚  æœ¬åœ°æ–‡ä»¶:   â”‚
â”‚  - {accountId}_storage.json     â† 8. Cookie + Storage State
â”‚  - {accountId}_fingerprint.json â† 9. æµè§ˆå™¨æŒ‡çº¹
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 10. æµè§ˆå™¨è‡ªåŠ¨åŒ–
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŠ–éŸ³å¹³å°    â”‚
â”‚  å°çº¢ä¹¦å¹³å°  â”‚
â”‚  å…¶ä»–å¹³å°... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æŒä¹…åŒ–ç­–ç•¥

| æ•°æ®ç±»å‹ | Worker æœ¬åœ° | Master æ•°æ®åº“ | è¯´æ˜ |
|---------|------------|--------------|------|
| **Cookie** | âœ… `{accountId}_storage.json` | âœ… `accounts.credentials` | åŒé‡ä¿å­˜ï¼ŒWorker é‡å¯åå¯å¿«é€Ÿæ¢å¤ |
| **ç”¨æˆ·ä¿¡æ¯** | âŒ | âœ… `accounts.user_info` | ä»… Master ä¿å­˜ï¼Œç”¨äºå±•ç¤º |
| **æµè§ˆå™¨æŒ‡çº¹** | âœ… `{accountId}_fingerprint.json` | âœ… `accounts.fingerprint` | Worker æœ¬åœ°ç”¨äºå¯åŠ¨ Browserï¼ŒMaster ç”¨äºå®¡è®¡ |
| **ç™»å½•ä¼šè¯** | âŒ | âœ… `login_sessions` è¡¨ | ä¸´æ—¶æ•°æ®ï¼Œç”¨äºè·Ÿè¸ªç™»å½•è¿‡ç¨‹ |
| **ç›‘æ§æ•°æ®** | âŒ | âœ… `comments/direct_messages` è¡¨ | ä»… Master ä¿å­˜ |
| **Worker çŠ¶æ€** | âŒ | âœ… `workers` è¡¨ | å®æ—¶çŠ¶æ€ |

---

## ğŸ”Œ é€šä¿¡æœºåˆ¶

### Socket.IO å‘½åç©ºé—´

```javascript
Master Server (ç«¯å£ 3000)
â”œâ”€â”€ /worker          â† Worker è¿æ¥
â”‚   â”œâ”€â”€ on('connection')
â”‚   â”œâ”€â”€ on('worker:register')
â”‚   â”œâ”€â”€ on('worker:heartbeat')
â”‚   â”œâ”€â”€ on('worker:login:qrcode')
â”‚   â”œâ”€â”€ on('worker:login:status')
â”‚   â”œâ”€â”€ on('worker:message:detected')
â”‚   â””â”€â”€ emit('master:login:start')
â”‚       emit('master:task:assign')
â”‚
â”œâ”€â”€ /admin           â† Admin Web è¿æ¥
â”‚   â”œâ”€â”€ on('connection')
â”‚   â”œâ”€â”€ on('admin:login:start')
â”‚   â”œâ”€â”€ on('admin:request:login-sessions')
â”‚   â””â”€â”€ emit('login:qrcode:ready')
â”‚       emit('login:success')
â”‚       emit('login:failed')
â”‚
â””â”€â”€ /client          â† Desktop/Mobile å®¢æˆ·ç«¯è¿æ¥ (æœªå®ç°)
    â”œâ”€â”€ on('connection')
    â””â”€â”€ emit('client:notification')
```

### æ¶ˆæ¯åè®®

**Worker â†’ Master**:
```javascript
// æ³¨å†Œ
WORKER_REGISTER = 'worker:register'

// å¿ƒè·³
WORKER_HEARTBEAT = 'worker:heartbeat'

// ç™»å½•ç›¸å…³
'worker:login:qrcode'   // å‘é€äºŒç»´ç 
'worker:login:status'   // ç™»å½•çŠ¶æ€æ›´æ–°

// ç›‘æ§æ•°æ®
'worker:message:detected'  // å‘ç°æ–°æ¶ˆæ¯
```

**Master â†’ Worker**:
```javascript
// ä»»åŠ¡åˆ†é…
MASTER_TASK_ASSIGN = 'master:task:assign'

// ä»»åŠ¡æ’¤é”€
MASTER_TASK_REVOKE = 'master:task:revoke'

// ç™»å½•è¯·æ±‚
'master:login:start'
```

**Admin Web â†” Master**:
```javascript
// Admin â†’ Master
'admin:login:start'              // å‘èµ·ç™»å½•
'admin:request:login-sessions'   // è¯·æ±‚ç™»å½•ä¼šè¯åˆ—è¡¨

// Master â†’ Admin
'login:qrcode:ready'     // äºŒç»´ç å°±ç»ª
'login:qrcode:refreshed' // äºŒç»´ç åˆ·æ–°
'login:success'          // ç™»å½•æˆåŠŸ
'login:failed'           // ç™»å½•å¤±è´¥
'login:qrcode:expired'   // äºŒç»´ç è¿‡æœŸ
```

---

## ğŸ“ˆ çŠ¶æ€ç®¡ç†

### Worker çŠ¶æ€æµè½¬

```
disconnected  â†’  connected  â†’  ready  â†’  busy  â†’  ready
     â†‘              â†“                      â†“         â†‘
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 (æ–­çº¿é‡è¿)            (ä»»åŠ¡å®Œæˆ)
```

**çŠ¶æ€è¯´æ˜**:
- `disconnected`: æœªè¿æ¥åˆ° Master
- `connected`: å·²è¿æ¥ï¼Œä½†æœªæ³¨å†Œ
- `ready`: å·²æ³¨å†Œï¼Œå¯æ¥æ”¶ä»»åŠ¡
- `busy`: æ‰§è¡Œä»»åŠ¡ä¸­
- `offline`: è¶…è¿‡ 30 ç§’æœªå‘é€å¿ƒè·³

### è´¦æˆ·ç™»å½•çŠ¶æ€æµè½¬

```
not_logged_in â†’ logging_in â†’ logged_in
      â†‘            â†“             â†“
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              (Cookie è¿‡æœŸ/ç™»å½•å¤±è´¥)
```

**çŠ¶æ€è¯´æ˜**:
- `not_logged_in`: æœªç™»å½•
- `logging_in`: ç™»å½•ä¸­ (æ˜¾ç¤ºäºŒç»´ç )
- `logged_in`: å·²ç™»å½• (æœ‰æœ‰æ•ˆ Cookie)
- `login_failed`: ç™»å½•å¤±è´¥

### ç™»å½•ä¼šè¯çŠ¶æ€æµè½¬

```
pending â†’ scanning â†’ success
   â†“         â†“
expired   failed
```

**çŠ¶æ€è¯´æ˜**:
- `pending`: å¾…æ‰«ç 
- `scanning`: æ‰«ç ä¸­
- `success`: ç™»å½•æˆåŠŸ
- `failed`: ç™»å½•å¤±è´¥
- `expired`: äºŒç»´ç è¿‡æœŸ (5 åˆ†é’Ÿ)

---

## ğŸ¯ å…³é”®è®¾è®¡åŸåˆ™

### 1. å¤š Browser æ¶æ„

**åŸåˆ™**: æ¯ä¸ªè´¦æˆ·ç‹¬ç«‹ Browser è¿›ç¨‹

**ä¼˜åŠ¿**:
- âœ… 100% æŒ‡çº¹éš”ç¦»ï¼Œæ— å…³è”é£é™©
- âœ… è¿›ç¨‹éš”ç¦»ï¼Œä¸€ä¸ªå´©æºƒä¸å½±å“å…¶ä»–
- âœ… æŒ‡çº¹ç¨³å®šï¼ŒæŒä¹…åŒ–åˆ°æ–‡ä»¶

**å®ç°**:
```javascript
// packages/worker/src/browser/browser-manager-v2.js
const context = await chromium.launchPersistentContext(
  `./data/browser/${workerId}/browser_${accountId}`,  // ç‹¬ç«‹æ•°æ®ç›®å½•
  {
    userAgent: fingerprint.userAgent,
    viewport: fingerprint.viewport,
    // ... 15+ ç§æŒ‡çº¹ç‰¹å¾
  }
);
```

### 2. å¹³å°æ’ä»¶åŒ–

**åŸåˆ™**: å¹³å°è„šæœ¬åŠ¨æ€åŠ è½½ï¼Œæ˜“æ‰©å±•

**å®ç°**:
```javascript
// packages/worker/src/platform-manager.js
class PlatformManager {
  async loadPlatforms() {
    const platformDirs = fs.readdirSync('./src/platforms');
    for (const dir of platformDirs) {
      if (dir === 'base') continue;
      const config = require(`./platforms/${dir}/config.json`);
      const Platform = require(`./platforms/${dir}/platform.js`);
      this.platforms.set(config.platform, new Platform(...));
    }
  }
}
```

**æ·»åŠ æ–°å¹³å°**:
1. åˆ›å»º `packages/worker/src/platforms/xiaohongshu/`
2. æ·»åŠ  `config.json` å’Œ `platform.js`
3. ç»§æ‰¿ `PlatformBase` ç±»
4. é‡å¯ Worker è‡ªåŠ¨åŠ è½½

### 3. é€šç”¨ç™»å½•æ¡†æ¶

**åŸåˆ™**: æ”¯æŒå¤šç§ç™»å½•æ–¹å¼ï¼ˆäºŒç»´ç ã€çŸ­ä¿¡ã€å¯†ç ï¼‰

**æ£€æµ‹é€»è¾‘**:
```javascript
// packages/worker/src/platforms/base/platform-base.js
async detectLoginMethod(page) {
  // 1. æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
  if (await page.$('.user-avatar')) {
    return { type: 'logged_in' };
  }

  // 2. æ£€æŸ¥äºŒç»´ç 
  if (await page.$('img[class*="qrcode"]')) {
    return { type: 'qrcode', selector: '...' };
  }

  // 3. æ£€æŸ¥çŸ­ä¿¡ç™»å½•
  if (await page.$('input[placeholder*="æ‰‹æœºå·"]')) {
    return { type: 'sms', phoneSelector: '...' };
  }
}
```

### 4. æ•°æ®åˆ†å±‚å­˜å‚¨

**åŸåˆ™**: ä¸´æ—¶æ•°æ®å’Œé•¿æœŸæ•°æ®åˆ†ç¦»

**å®ç°**:
- **ä¸´æ—¶æ•°æ®**: `login_sessions` è¡¨ï¼ˆç™»å½•è¿‡ç¨‹ï¼Œå¯å®šæœŸæ¸…ç†ï¼‰
- **é•¿æœŸæ•°æ®**: `accounts` è¡¨ï¼ˆç™»å½•å‡­æ®ï¼ŒæŒä¹…ä¿å­˜ï¼‰
- **æœ¬åœ°ç¼“å­˜**: Worker æ–‡ä»¶ç³»ç»Ÿï¼ˆå¿«é€Ÿæ¢å¤ï¼‰

---

## ğŸ” å®‰å…¨æ€§è€ƒè™‘

### 1. Cookie åŠ å¯†ï¼ˆå¾…å®ç°ï¼‰

```javascript
// å»ºè®®ä½¿ç”¨ AES-256 åŠ å¯†
const crypto = require('crypto');

function encryptCredentials(credentials) {
  const cipher = crypto.createCipheriv('aes-256-cbc', secretKey, iv);
  return cipher.update(JSON.stringify(credentials), 'utf8', 'hex') + cipher.final('hex');
}
```

### 2. æŒ‡çº¹éšæœºåŒ–

```javascript
// packages/worker/src/browser/browser-manager-v2.js
// åŸºäº accountId çš„ seeded randomï¼Œç¡®ä¿ç¨³å®šæ€§
const seed = this.hashString(accountId);
const random = this.seededRandom(seed);

const fingerprint = {
  userAgent: this.randomUserAgent(random),
  viewport: this.randomViewport(random),
  webgl: this.randomWebGL(random),
  // ... 15+ ç§ç‰¹å¾
};
```

### 3. æ•°æ®è®¿é—®æ§åˆ¶

- Admin Web éœ€è¦ Socket.IO è®¤è¯ï¼ˆå¾…å®ç°ï¼‰
- API ç«¯ç‚¹éœ€è¦éªŒè¯ç®¡ç†å‘˜æƒé™
- Worker åªèƒ½è®¿é—®åˆ†é…ç»™å®ƒçš„è´¦æˆ·æ•°æ®

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [CLAUDE.md](../CLAUDE.md) - å¼€å‘æŒ‡å—
- [ç™»å½•æ•°æ®ä¿å­˜åŠŸèƒ½å®ç°æŠ¥å‘Š](.docs/ç™»å½•æ•°æ®ä¿å­˜åŠŸèƒ½å®ç°æŠ¥å‘Š.md)
- [é€šç”¨å¹³å°è„šæœ¬ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ](.docs/worker-é€šç”¨å¹³å°è„šæœ¬ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ.md)
- [è´¦æˆ·çº§æµè§ˆå™¨éš”ç¦»ç™»å½•æµç¨‹è®¾è®¡](.docs/è´¦æˆ·çº§æµè§ˆå™¨éš”ç¦»ç™»å½•æµç¨‹è®¾è®¡.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0.0
**æœ€åæ›´æ–°**: 2025-10-16
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ
