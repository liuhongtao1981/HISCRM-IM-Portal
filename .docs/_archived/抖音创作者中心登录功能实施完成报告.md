# æŠ–éŸ³åˆ›ä½œè€…ä¸­å¿ƒç™»å½•åŠŸèƒ½å®æ–½å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ å®æ–½æ€»ç»“

å·²å®ŒæˆæŠ–éŸ³åˆ›ä½œè€…ä¸­å¿ƒç™»å½•åŠŸèƒ½çš„åç«¯å®ç°ï¼ˆWorker + Masterï¼‰ï¼Œæ”¯æŒï¼š
- âœ… **æ™ºèƒ½ç™»å½•æ–¹å¼è¯†åˆ«** - è‡ªåŠ¨æ£€æµ‹äºŒç»´ç /æ‰‹æœºçŸ­ä¿¡ç™»å½•
- âœ… **äºŒç»´ç ç™»å½•** - ä¼˜å…ˆä½¿ç”¨äºŒç»´ç ç™»å½•
- âœ… **æ‰‹æœºéªŒè¯ç ç™»å½•** - æ”¯æŒæ‰‹æœºçŸ­ä¿¡éªŒè¯ç ç™»å½•
- âœ… **è´¦æˆ·çº§æµè§ˆå™¨éš”ç¦»** - æ¯ä¸ªè´¦æˆ·ç‹¬ç«‹çš„æµè§ˆå™¨å®ä¾‹å’ŒæŒ‡çº¹
- âœ… **å¿ƒè·³æ£€æµ‹ç™»å½•çŠ¶æ€** - å®æ—¶ç›‘æ§ç™»å½•çŠ¶æ€å˜åŒ–
- âœ… **ç”¨æˆ·è¾“å…¥æ”¯æŒ** - Web ç«¯è¾“å…¥éªŒè¯ç ä¼ é€’åˆ° Worker
- âœ… **å¹³å°å‚æ•°ä¼ é€’** - Master æ­£ç¡®ä¼ é€’ platform å‚æ•°

## ğŸ¯ æ ¸å¿ƒå®ç°

### 1. Worker ç«¯ - DouyinPlatform

**æ–‡ä»¶**: `packages/worker/src/platforms/douyin/platform.js`

#### 1.1 startLogin() - ç™»å½•å…¥å£
```javascript
async startLogin(options) {
  const { accountId, sessionId, proxy } = options;
  
  // 1. åˆ›å»ºæˆ–è·å–è´¦æˆ·æµè§ˆå™¨ä¸Šä¸‹æ–‡
  let context = await this.createAccountContext(accountId, proxy);
  
  // 2. è®¿é—®æŠ–éŸ³åˆ›ä½œè€…ä¸­å¿ƒ
  await page.goto('https://creator.douyin.com/', { waitUntil: 'networkidle' });
  
  // 3. æ£€æµ‹ç™»å½•æ–¹å¼
  const loginMethod = await this.detectLoginMethod(page);
  
  // 4. æ ¹æ®ç™»å½•æ–¹å¼å¤„ç†
  if (loginMethod.type === 'qrcode') {
    return await this.handleQRCodeLogin(page, accountId, sessionId, {...});
  }
  if (loginMethod.type === 'sms') {
    return await this.handleSMSLogin(page, accountId, sessionId, {...});
  }
}
```

**ç‰¹ç‚¹**:
- âœ… ä½¿ç”¨é€šç”¨ç™»å½•æ¡†æ¶æ–¹æ³•
- âœ… æ”¯æŒä»£ç†é…ç½®
- âœ… è‡ªåŠ¨æ£€æµ‹ç™»å½•æ–¹å¼
- âœ… é”™è¯¯æˆªå›¾ä¿å­˜

#### 1.2 detectLoginMethod() - æ™ºèƒ½æ£€æµ‹ç™»å½•æ–¹å¼
```javascript
async detectLoginMethod(page) {
  // ä¼˜å…ˆçº§1: æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
  const userAvatar = await page.$('.user-avatar, .avatar-icon');
  if (userAvatar) return { type: 'logged_in' };
  
  // ä¼˜å…ˆçº§2: æ£€æŸ¥äºŒç»´ç ç™»å½•ï¼ˆå¤šä¸ªé€‰æ‹©å™¨ï¼‰
  const qrCodeSelectors = [
    'img[class*="qrcode"]',
    'img[alt*="äºŒç»´ç "]',
    'canvas[class*="qrcode"]',
    '.qrcode-image',
    '.login-qrcode img',
  ];
  // ... æ£€æŸ¥äºŒç»´ç 
  
  // ä¼˜å…ˆçº§3: æ£€æŸ¥äºŒç»´ç åˆ‡æ¢æŒ‰é’®
  const qrSwitchBtn = await page.$('text=äºŒç»´ç ç™»å½•');
  if (qrSwitchBtn) {
    await qrSwitchBtn.click();
    // é‡æ–°æ£€æŸ¥äºŒç»´ç 
  }
  
  // ä¼˜å…ˆçº§4: æ£€æŸ¥æ‰‹æœºçŸ­ä¿¡ç™»å½•
  const phoneInput = await page.$('input[placeholder*="æ‰‹æœºå·"]');
  if (phoneInput) return { type: 'sms', phoneSelector, ... };
  
  return { type: 'unknown' };
}
```

**ç‰¹ç‚¹**:
- âœ… å¤šå±‚çº§æ£€æµ‹é€»è¾‘
- âœ… å¤šä¸ª CSS é€‰æ‹©å™¨å®¹é”™
- âœ… æ”¯æŒç‚¹å‡»åˆ‡æ¢ç™»å½•æ–¹å¼
- âœ… æœªçŸ¥ç™»å½•æ–¹å¼ä¿å­˜æˆªå›¾

#### 1.3 checkLoginStatus() - æ£€æŸ¥ç™»å½•çŠ¶æ€
```javascript
async checkLoginStatus(page, method = 'auto') {
  // æ–¹æ³•1: æ£€æŸ¥ç”¨æˆ·å¤´åƒ
  const avatar = await page.$('.user-avatar, .avatar-icon');
  if (avatar) return { isLoggedIn: true, status: 'logged_in' };
  
  // æ–¹æ³•2: æ£€æŸ¥ URL å˜åŒ–
  if (currentUrl.includes('/creator/') && !currentUrl.includes('/login')) {
    return { isLoggedIn: true, status: 'logged_in' };
  }
  
  // æ–¹æ³•3: æ£€æŸ¥ Cookie
  const sessionCookie = cookies.find(c => 
    c.name.includes('sessionid') || c.name === 'ttwid'
  );
  if (sessionCookie) return { isLoggedIn: true, status: 'logged_in' };
  
  // æ–¹æ³•4: æ£€æŸ¥æ‰«ç ä¸­
  const scanningHint = await page.$('[class*="scan"]');
  if (scanningHint) return { isLoggedIn: false, status: 'scanning' };
  
  // æ–¹æ³•5: æ£€æŸ¥äºŒç»´ç è¿‡æœŸ
  const expiredHint = await page.$('[class*="expire"]');
  if (expiredHint) return { isLoggedIn: false, status: 'expired' };
}
```

**ç‰¹ç‚¹**:
- âœ… 5 ç§æ£€æµ‹æ–¹æ³•
- âœ… æŠ–éŸ³å¹³å°ç‰¹å®šçš„é€‰æ‹©å™¨
- âœ… Cookie åç§°è¯†åˆ«ï¼ˆttwidï¼‰
- âœ… å®æ—¶çŠ¶æ€æ›´æ–°ï¼ˆscanning/expiredï¼‰

#### 1.4 extractUserInfo() - æå–ç”¨æˆ·ä¿¡æ¯
```javascript
async extractUserInfo(page) {
  const userInfo = await page.evaluate(() => {
    const avatar = document.querySelector('.user-avatar img')?.src;
    const nickname = document.querySelector('.user-nickname, .username')?.textContent;
    const uid = document.querySelector('[data-user-id]')?.dataset.userId;
    return { avatar, nickname, uid };
  });
  return userInfo;
}
```

### 2. Worker ç«¯ - ç”¨æˆ·è¾“å…¥å¤„ç†

**æ–‡ä»¶**: `packages/worker/src/index.js`

```javascript
// ç›‘å¬ç”¨æˆ·è¾“å…¥äº‹ä»¶
socketClient.socket.on('master:login:user_input', (data) => {
  handleUserInput(data);
});

function handleUserInput(data) {
  const { session_id, input_type, value } = data;
  
  // è§¦å‘ WorkerBridge çš„ç”¨æˆ·è¾“å…¥å›è°ƒ
  workerBridge.triggerUserInput(session_id, input_type, value);
}
```

**æ–‡ä»¶**: `packages/worker/src/platforms/base/worker-bridge.js`

```javascript
class WorkerBridge {
  constructor(socketClient, workerId) {
    // ...
    this.userInputListeners = new Map(); // sessionId -> { inputType -> callback }
  }
  
  onUserInput(sessionId, inputType, callback) {
    // æ³¨å†Œç”¨æˆ·è¾“å…¥ç›‘å¬å™¨
    if (!this.userInputListeners.has(sessionId)) {
      this.userInputListeners.set(sessionId, new Map());
    }
    this.userInputListeners.get(sessionId).set(inputType, callback);
  }
  
  triggerUserInput(sessionId, inputType, value) {
    // è§¦å‘å›è°ƒ
    const callback = this.userInputListeners.get(sessionId)?.get(inputType);
    if (callback) {
      callback(value);
      // æ¸…ç†ç›‘å¬å™¨
      this.userInputListeners.get(sessionId).delete(inputType);
    }
  }
}
```

### 3. Master ç«¯ - äº‹ä»¶è½¬å‘

**æ–‡ä»¶**: `packages/master/src/socket/admin-namespace.js`

#### 3.1 å¯åŠ¨ç™»å½•ï¼ˆæ·»åŠ  platform å‚æ•°ï¼‰
```javascript
socket.on('master:login:start', async (data) => {
  const { account_id, worker_id, session_id } = data;
  
  // æŸ¥è¯¢è´¦æˆ·ä¿¡æ¯è·å–å¹³å°
  const account = db.prepare('SELECT platform FROM accounts WHERE id = ?').get(account_id);
  
  // åˆ›å»ºç™»å½•ä¼šè¯
  db.prepare(`INSERT INTO login_sessions ...`).run(...);
  
  // è½¬å‘åˆ° Workerï¼ˆæ·»åŠ  platform å‚æ•°ï¼‰
  workerSocket.emit('master:login:start', {
    account_id,
    session_id,
    platform: account.platform,  // âœ… æ–°å¢
    proxy: proxyConfig,
  });
});
```

#### 3.2 è½¬å‘ç”¨æˆ·è¾“å…¥
```javascript
socket.on('master:login:user_input', async (data) => {
  const { session_id, input_type, value } = data;
  
  // æŸ¥è¯¢ç™»å½•ä¼šè¯è·å– worker_id
  const session = db.prepare(
    'SELECT worker_id, account_id FROM login_sessions WHERE id = ?'
  ).get(session_id);
  
  // è½¬å‘åˆ°å¯¹åº”çš„ Worker
  workerSocket.emit('master:login:user_input', {
    session_id,
    input_type,
    value,
  });
  
  // ç¡®è®¤å·²æ¥æ”¶
  socket.emit('admin:login:user_input:ack', {
    session_id,
    input_type,
    status: 'received',
  });
});
```

**æ–‡ä»¶**: `packages/master/src/communication/socket-server.js`

#### 3.3 è½¬å‘ç™»å½•çŠ¶æ€åˆ° Admin
```javascript
workerNamespace.on('connection', (socket) => {
  // ç›‘å¬ç™»å½•çŠ¶æ€æ›´æ–°ï¼ˆæ–°æ¡†æ¶ï¼‰
  socket.on('worker:login:status', (data) => {
    const { session_id, status, account_id } = data;
    
    // è½¬å‘åˆ° Admin namespace
    const adminNamespace = io.of('/admin');
    adminNamespace.emit('login:status:update', data);
    
    // ä¿æŒå…¼å®¹æ—§ä»£ç 
    if (status === 'qrcode_ready' && handlers.onLoginQRCodeReady) {
      handlers.onLoginQRCodeReady(data);
    }
  });
});
```

## ğŸ”„ å®Œæ•´æ•°æ®æµ

### äºŒç»´ç ç™»å½•æµç¨‹

```
1. Admin Web
   ç”¨æˆ·ç‚¹å‡»"ç™»å½•" â†’ socket.emit('master:login:start', {
     account_id, worker_id, session_id
   })
   â†“

2. Master (admin-namespace.js)
   æŸ¥è¯¢è´¦æˆ· platform â†’ åˆ›å»º login_sessions â†’ 
   workerSocket.emit('master:login:start', {
     account_id, session_id, platform: 'douyin', proxy
   })
   â†“

3. Worker (index.js)
   handleLoginRequest() â†’ platformManager.getPlatform('douyin')
   â†“

4. DouyinPlatform
   startLogin() â†’ è®¿é—® creator.douyin.com
   â†“
   detectLoginMethod() â†’ è¯†åˆ«ä¸º 'qrcode'
   â†“
   handleQRCodeLogin() â†’ 
     - æˆªå–äºŒç»´ç 
     - sendLoginStatus('qrcode_ready', { qr_code_data })
     - waitForLogin() å¯åŠ¨å¿ƒè·³
   â†“

5. Master (socket-server.js)
   æ”¶åˆ° worker:login:status â†’ 
   adminNamespace.emit('login:status:update', data)
   â†“

6. Admin Web
   æ”¶åˆ° login:status:update â†’ æ˜¾ç¤ºäºŒç»´ç æ¨¡æ€æ¡†
   â†“

7. ç”¨æˆ·æ‰«ç 
   â†“

8. DouyinPlatform
   checkLoginStatus() æ¯ 2 ç§’æ£€æµ‹ â†’ 
   å‘ç° userAvatar å…ƒç´  â†’ isLoggedIn: true
   â†“
   saveLoginState() â†’ ä¿å­˜ Cookie
   â†“
   sendLoginStatus('success', { user_info })
   â†“

9. Admin Web
   æ”¶åˆ° login:status:update (status: 'success') â†’ 
   æ˜¾ç¤º"ç™»å½•æˆåŠŸ"ï¼Œå…³é—­æ¨¡æ€æ¡†
```

### æ‰‹æœºéªŒè¯ç ç™»å½•æµç¨‹

```
1-4. [åŒä¸Š]
   â†“
   detectLoginMethod() â†’ è¯†åˆ«ä¸º 'sms'
   â†“

5. DouyinPlatform
   handleSMSLogin() â†’
     - sendLoginStatus('sms_input_required', { step: 'phone_number' })
     - waitForUserInput('phone_number')
   â†“

6. Admin Web
   æ”¶åˆ° login:status:update â†’ æ˜¾ç¤ºæ‰‹æœºå·è¾“å…¥æ¡†
   â†“

7. ç”¨æˆ·è¾“å…¥æ‰‹æœºå·
   socket.emit('master:login:user_input', {
     session_id, input_type: 'phone_number', value: '13800138000'
   })
   â†“

8. Master (admin-namespace.js)
   æŸ¥è¯¢ login_sessions â†’ 
   workerSocket.emit('master:login:user_input', {...})
   â†“

9. Worker (index.js)
   handleUserInput() â†’ 
   workerBridge.triggerUserInput(session_id, 'phone_number', value)
   â†“

10. DouyinPlatform
    waitForUserInput() å›è°ƒè§¦å‘ â†’ 
    å¡«å……æ‰‹æœºå· â†’ ç‚¹å‡»"è·å–éªŒè¯ç "
    â†“
    sendLoginStatus('sms_input_required', { step: 'verification_code' })
    â†“

11. Admin Web
    æ”¶åˆ° â†’ æ˜¾ç¤ºéªŒè¯ç è¾“å…¥æ¡†
    â†“

12. ç”¨æˆ·è¾“å…¥éªŒè¯ç 
    [é‡å¤æ­¥éª¤ 7-9]
    â†“

13. DouyinPlatform
    å¡«å……éªŒè¯ç  â†’ ç‚¹å‡»ç™»å½• â†’ 
    waitForLogin() â†’ æ£€æµ‹åˆ°å·²ç™»å½• â†’
    saveLoginState() â†’ sendLoginStatus('success')
```

## ğŸ“Š Socket.IO äº‹ä»¶è¡¨

### Web â†’ Master

| äº‹ä»¶ | æ•°æ® | è¯´æ˜ |
|------|------|------|
| `master:login:start` | `{account_id, worker_id, session_id}` | å¯åŠ¨ç™»å½• |
| `master:login:user_input` | `{session_id, input_type, value}` | æäº¤ç”¨æˆ·è¾“å…¥ |

### Master â†’ Web

| äº‹ä»¶ | æ•°æ® | è¯´æ˜ |
|------|------|------|
| `admin:login:start:ack` | `{account_id, worker_id, session_id, status}` | ç™»å½•è¯·æ±‚å·²å‘é€ |
| `admin:login:user_input:ack` | `{session_id, input_type, status}` | ç”¨æˆ·è¾“å…¥å·²æ¥æ”¶ |
| `login:status:update` | `{session_id, status, account_id, ...}` | ç™»å½•çŠ¶æ€æ›´æ–° |

### Master â†’ Worker

| äº‹ä»¶ | æ•°æ® | è¯´æ˜ |
|------|------|------|
| `master:login:start` | `{account_id, session_id, platform, proxy}` | å¯åŠ¨ç™»å½• |
| `master:login:user_input` | `{session_id, input_type, value}` | ç”¨æˆ·è¾“å…¥ |

### Worker â†’ Master

| äº‹ä»¶ | æ•°æ® | è¯´æ˜ |
|------|------|------|
| `worker:login:status` | `{session_id, status, account_id, ...}` | ç™»å½•çŠ¶æ€æ›´æ–° |

### ç™»å½•çŠ¶æ€ (status) æšä¸¾

| çŠ¶æ€ | è¯´æ˜ | æ•°æ® |
|------|------|------|
| `qrcode_ready` | äºŒç»´ç å·²å‡†å¤‡ | `{qr_code_data, expires_at}` |
| `sms_input_required` | éœ€è¦ç”¨æˆ·è¾“å…¥ | `{step: 'phone_number'\|'verification_code', message}` |
| `scanning` | æ­£åœ¨æ‰«ç ä¸­ | `{message}` |
| `success` | ç™»å½•æˆåŠŸ | `{user_info}` |
| `failed` | ç™»å½•å¤±è´¥ | `{error_message}` |
| `timeout` | ç™»å½•è¶…æ—¶ | `{message}` |
| `expired` | äºŒç»´ç è¿‡æœŸ | `{message}` |

## ğŸ“ å·²ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

### Worker ç«¯
1. âœ… `packages/worker/src/platforms/douyin/platform.js` - é‡å†™ç™»å½•é€»è¾‘
   - å®ç° `startLogin()` ä½¿ç”¨é€šç”¨æ¡†æ¶
   - å®ç° `detectLoginMethod()` æ£€æµ‹æŠ–éŸ³ç™»å½•æ–¹å¼
   - è¦†ç›– `checkLoginStatus()` æŠ–éŸ³ç‰¹å®šæ£€æµ‹
   - è¦†ç›– `extractUserInfo()` æå–ç”¨æˆ·ä¿¡æ¯

2. âœ… `packages/worker/src/platforms/base/platform-base.js` - æ·»åŠ é€šç”¨ç™»å½•æ¡†æ¶
   - æ–°å¢ 8 ä¸ªé€šç”¨ç™»å½•æ–¹æ³•ï¼ˆçº¦ 300 è¡Œï¼‰

3. âœ… `packages/worker/src/platforms/base/worker-bridge.js` - ç”¨æˆ·è¾“å…¥æ”¯æŒ
   - æ–°å¢ `userInputListeners` å±æ€§
   - æ–°å¢ `onUserInput()` æ–¹æ³•
   - æ–°å¢ `triggerUserInput()` æ–¹æ³•
   - æ–°å¢ `removeUserInputListener()` æ–¹æ³•

4. âœ… `packages/worker/src/index.js` - å¤„ç†ç”¨æˆ·è¾“å…¥
   - æ–°å¢ç›‘å¬ `master:login:user_input` äº‹ä»¶
   - æ–°å¢ `handleUserInput()` å‡½æ•°

### Master ç«¯
5. âœ… `packages/master/src/socket/admin-namespace.js` - è½¬å‘ç”¨æˆ·è¾“å…¥
   - ä¿®æ”¹ `master:login:start` å¤„ç†å™¨ï¼Œæ·»åŠ  platform å‚æ•°
   - æ–°å¢ `master:login:user_input` å¤„ç†å™¨

6. âœ… `packages/master/src/communication/socket-server.js` - è½¬å‘ç™»å½•çŠ¶æ€
   - æ–°å¢ç›‘å¬ `worker:login:status` äº‹ä»¶
   - è½¬å‘åˆ° `adminNamespace.emit('login:status:update')`

## âœ… å·²å®ŒæˆåŠŸèƒ½

### åç«¯ï¼ˆWorker + Masterï¼‰
- âœ… æŠ–éŸ³åˆ›ä½œè€…ä¸­å¿ƒç™»å½•åœ°å€ï¼š`https://creator.douyin.com/`
- âœ… æ™ºèƒ½ç™»å½•æ–¹å¼æ£€æµ‹ï¼ˆä¼˜å…ˆäºŒç»´ç ï¼Œå…¶æ¬¡çŸ­ä¿¡ï¼‰
- âœ… äºŒç»´ç ç™»å½•å®Œæ•´æµç¨‹
- âœ… æ‰‹æœºéªŒè¯ç ç™»å½•å®Œæ•´æµç¨‹
- âœ… è´¦æˆ·çº§æµè§ˆå™¨éš”ç¦»ï¼ˆæ¯è´¦æˆ·ç‹¬ç«‹å®ä¾‹ï¼‰
- âœ… å¿ƒè·³æ£€æµ‹ç™»å½•çŠ¶æ€ï¼ˆ2 ç§’é—´éš”ï¼‰
- âœ… ç”¨æˆ·è¾“å…¥å¼‚æ­¥ç­‰å¾…æœºåˆ¶
- âœ… å¹³å°å‚æ•°æ­£ç¡®ä¼ é€’ï¼ˆdouyinï¼‰
- âœ… ä»£ç†é…ç½®æ”¯æŒ
- âœ… é”™è¯¯æˆªå›¾ä¿å­˜
- âœ… ç™»å½•çŠ¶æ€æŒä¹…åŒ–ï¼ˆCookieï¼‰

### äº‹ä»¶é€šä¿¡
- âœ… Worker â†’ Master â†’ Admin ç™»å½•çŠ¶æ€è½¬å‘
- âœ… Admin â†’ Master â†’ Worker ç”¨æˆ·è¾“å…¥è½¬å‘
- âœ… ç»Ÿä¸€äº‹ä»¶æ ¼å¼ï¼ˆ`login:status:update`ï¼‰

## â³ å¾…å®æ–½åŠŸèƒ½

### å‰ç«¯ï¼ˆAdmin Webï¼‰
- ğŸ”² åˆ›å»ºç»Ÿä¸€çš„ `LoginModal` ç»„ä»¶
- ğŸ”² æ”¯æŒäºŒç»´ç æ˜¾ç¤ºå’Œå€’è®¡æ—¶
- ğŸ”² æ”¯æŒæ‰‹æœºå·è¾“å…¥æ¡†
- ğŸ”² æ”¯æŒéªŒè¯ç è¾“å…¥æ¡†
- ğŸ”² æ›´æ–° `socketContext.js` ç›‘å¬æ–°äº‹ä»¶
- ğŸ”² é›†æˆåˆ° `AccountsPage.js`

## ğŸ¯ æµ‹è¯•å»ºè®®

### 1. äºŒç»´ç ç™»å½•æµ‹è¯•
```bash
# å¯åŠ¨ Master
npm run start:master

# å¯åŠ¨ Worker
npm run start:worker

# å¯åŠ¨ Admin Web
npm run start:admin

# åœ¨ Web ç«¯ç‚¹å‡»è´¦æˆ·çš„"ç™»å½•"æŒ‰é’®
# é¢„æœŸï¼šæ˜¾ç¤ºäºŒç»´ç æ¨¡æ€æ¡†
# ç”¨æŠ–éŸ³ App æ‰«ç 
# é¢„æœŸï¼šç™»å½•æˆåŠŸï¼Œä¿å­˜ Cookie
```

### 2. æ‰‹æœºéªŒè¯ç ç™»å½•æµ‹è¯•
```bash
# å¦‚æœæŠ–éŸ³æœªæ˜¾ç¤ºäºŒç»´ç ï¼Œè€Œæ˜¯æ˜¾ç¤ºæ‰‹æœºå·è¾“å…¥æ¡†
# é¢„æœŸï¼šWeb ç«¯æ˜¾ç¤ºæ‰‹æœºå·è¾“å…¥æ¡†
# è¾“å…¥æ‰‹æœºå·
# é¢„æœŸï¼šæ”¶åˆ°éªŒè¯ç ï¼Œæ˜¾ç¤ºéªŒè¯ç è¾“å…¥æ¡†
# è¾“å…¥éªŒè¯ç 
# é¢„æœŸï¼šç™»å½•æˆåŠŸ
```

### 3. è´¦æˆ·éš”ç¦»æµ‹è¯•
```bash
# åŒæ—¶ä¸º 2 ä¸ªè´¦æˆ·å¯åŠ¨ç™»å½•
# é¢„æœŸï¼šæ¯ä¸ªè´¦æˆ·æœ‰ç‹¬ç«‹çš„æµè§ˆå™¨è¿›ç¨‹
# é¢„æœŸï¼šäº’ä¸å¹²æ‰°ï¼ŒCookie åˆ†åˆ«ä¿å­˜
```

## ğŸ“ å…³é”®ä»£ç ç‰‡æ®µ

### DouyinPlatform ç™»å½•å…¥å£
```javascript
async startLogin(options) {
  const { accountId, sessionId, proxy } = options;
  
  // 1. åˆ›å»ºè´¦æˆ·æµè§ˆå™¨ä¸Šä¸‹æ–‡
  let context = await this.createAccountContext(accountId, proxy);
  const page = await context.newPage();
  
  // 2. è®¿é—®åˆ›ä½œè€…ä¸­å¿ƒ
  await page.goto('https://creator.douyin.com/', { 
    waitUntil: 'networkidle' 
  });
  
  // 3. æ£€æµ‹ç™»å½•æ–¹å¼
  const loginMethod = await this.detectLoginMethod(page);
  
  // 4. æ ¹æ®ç™»å½•æ–¹å¼å¤„ç†
  if (loginMethod.type === 'qrcode') {
    return await this.handleQRCodeLogin(page, accountId, sessionId, {
      qrSelector: loginMethod.selector,
    });
  }
  
  if (loginMethod.type === 'sms') {
    return await this.handleSMSLogin(page, accountId, sessionId, {
      phoneSelector: loginMethod.phoneSelector,
      codeSelector: loginMethod.codeSelector,
    });
  }
}
```

### ç™»å½•æ–¹å¼æ£€æµ‹
```javascript
async detectLoginMethod(page) {
  // 1. æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
  const userAvatar = await page.$('.user-avatar');
  if (userAvatar) return { type: 'logged_in' };
  
  // 2. æ£€æŸ¥äºŒç»´ç ï¼ˆå¤šä¸ªé€‰æ‹©å™¨ï¼‰
  const qrCodeSelectors = [
    'img[class*="qrcode"]',
    'canvas[class*="qrcode"]',
    '.login-qrcode img',
  ];
  for (const selector of qrCodeSelectors) {
    const qrElement = await page.$(selector);
    if (qrElement && await qrElement.isVisible()) {
      return { type: 'qrcode', selector };
    }
  }
  
  // 3. æ£€æŸ¥äºŒç»´ç åˆ‡æ¢æŒ‰é’®
  const qrSwitchBtn = await page.$('text=äºŒç»´ç ç™»å½•');
  if (qrSwitchBtn) {
    await qrSwitchBtn.click();
    await page.waitForTimeout(1000);
    // é‡æ–°æ£€æŸ¥äºŒç»´ç ...
  }
  
  // 4. æ£€æŸ¥æ‰‹æœºç™»å½•
  const phoneInput = await page.$('input[placeholder*="æ‰‹æœºå·"]');
  if (phoneInput && await phoneInput.isVisible()) {
    return { type: 'sms', phoneSelector: '...' };
  }
  
  return { type: 'unknown' };
}
```

## ğŸ‰ æ€»ç»“

åç«¯ï¼ˆWorker + Masterï¼‰çš„æŠ–éŸ³ç™»å½•åŠŸèƒ½å·²ç»**å…¨éƒ¨å®Œæˆ**ï¼

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- âœ… æ™ºèƒ½è¯†åˆ«ç™»å½•æ–¹å¼
- âœ… äºŒç»´ç ä¼˜å…ˆï¼ŒçŸ­ä¿¡å¤‡ç”¨
- âœ… è´¦æˆ·çº§æµè§ˆå™¨éš”ç¦»
- âœ… å®æ—¶çŠ¶æ€ç›‘æ§
- âœ… ç”¨æˆ·è¾“å…¥å¼‚æ­¥å¤„ç†
- âœ… å®Œæ•´äº‹ä»¶é€šä¿¡é“¾è·¯

**ä¸‹ä¸€æ­¥**ï¼š
å®æ–½å‰ç«¯ï¼ˆAdmin Webï¼‰ç™»å½•ç•Œé¢ï¼Œè®©ç”¨æˆ·å¯ä»¥çœ‹åˆ°äºŒç»´ç å’Œè¾“å…¥éªŒè¯ç ã€‚

---

**åˆ›å»ºæ—¶é—´**: 2025-10-16  
**çŠ¶æ€**: åç«¯å·²å®Œæˆï¼Œå¾…å®æ–½å‰ç«¯
