# HisCrm-IM 系统架构与核心流程

**日期**: 2025-10-16
**版本**: 2.0.0

---

## 📋 目录

1. [系统架构概览](#系统架构概览)
2. [核心组件](#核心组件)
3. [关键流程](#关键流程)
4. [数据流转](#数据流转)
5. [通信机制](#通信机制)
6. [状态管理](#状态管理)

---

## 🏗️ 系统架构概览

### 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         HisCrm-IM 系统                           │
└─────────────────────────────────────────────────────────────────┘

┌──────────────┐                  ┌──────────────┐
│  Admin Web   │◄────Socket.IO────┤    Master    │
│  (React)     │   /admin         │   (Node.js)  │
│  端口: 3001  │                  │   端口: 3000 │
└──────────────┘                  └──────┬───────┘
                                         │
                                         │ Socket.IO
                                         │ /worker
                                         │
                  ┌──────────────────────┼──────────────────────┐
                  │                      │                      │
           ┌──────▼──────┐        ┌─────▼──────┐       ┌──────▼──────┐
           │  Worker 1   │        │  Worker 2  │       │  Worker N   │
           │  (Node.js)  │        │  (Node.js) │       │  (Node.js)  │
           │  端口: 4000 │        │ 端口: 4001 │       │ 端口: 400N │
           └──────┬──────┘        └─────┬──────┘       └──────┬──────┘
                  │                     │                      │
         ┌────────┴────────┐   ┌────────┴────────┐   ┌────────┴────────┐
         │ Browser (账户A) │   │ Browser (账户C) │   │ Browser (账户E) │
         │ Browser (账户B) │   │ Browser (账户D) │   │ Browser (账户F) │
         └─────────────────┘   └─────────────────┘   └─────────────────┘
                  │                     │                      │
                  └─────────────────────┼──────────────────────┘
                                        ▼
                            抖音/小红书等社交平台
```

### 技术栈

| 层级 | 技术 | 说明 |
|------|------|------|
| **运行时** | Node.js 18.x LTS | 统一运行环境 |
| **通信** | Socket.IO 4.x | WebSocket + JSON 通信 |
| **数据库** | SQLite 3.x (better-sqlite3) | Master 数据存储 |
| **浏览器自动化** | Playwright | 多 Browser 架构 |
| **前端** | React 18 + Ant Design | Admin Web UI |
| **进程管理** | PM2 / child_process | 生产环境部署 |

---

## 🧩 核心组件

### 1. Master Server (主控服务器)

**职责**: 中央协调器，管理所有 Worker 和账户

**核心模块**:
```javascript
packages/master/src/
├── index.js                      // 入口，初始化所有服务
├── database/                     // 数据库层
│   ├── init.js                   // 数据库初始化
│   ├── schema.sql                // 数据库表结构
│   ├── accounts-dao.js           // 账户数据访问
│   ├── worker-config-dao.js      // Worker 配置
│   └── worker-runtime-dao.js     // Worker 运行时状态
├── communication/                // 通信层
│   ├── socket-server.js          // Socket.IO 服务器
│   └── session-manager.js        // 会话管理
├── worker_manager/               // Worker 管理层
│   ├── lifecycle-manager.js      // Worker 生命周期
│   ├── account-assigner.js       // 账户分配
│   └── local-process-manager.js  // 本地 Worker 进程管理
├── scheduler/                    // 调度层
│   └── task-scheduler.js         // 任务调度器
├── login/                        // 登录管理
│   └── login-handler.js          // 登录会话处理
└── socket/                       // Socket 命名空间
    └── admin-namespace.js        // Admin 命名空间
```

**关键职责**:
- ✅ 接收 Worker 注册和心跳
- ✅ 分配账户到合适的 Worker
- ✅ 管理登录会话（二维码登录）
- ✅ 存储账户凭据（Cookie、用户信息、指纹）
- ✅ 与 Admin Web 通信，推送状态更新
- ✅ 接收监控数据（评论、私信）

### 2. Worker (工作节点)

**职责**: 执行实际的浏览器自动化和数据抓取

**核心模块**:
```javascript
packages/worker/src/
├── index.js                      // 入口，连接 Master
├── platform-manager.js           // 平台脚本管理器
├── platforms/                    // 平台脚本
│   ├── base/
│   │   ├── platform-base.js      // 平台基类
│   │   └── worker-bridge.js      // Worker ↔ Master 通信桥接
│   └── douyin/
│       ├── platform.js           // 抖音平台实现
│       └── config.json           // 抖音配置（URL、选择器等）
├── browser/                      // 浏览器管理
│   └── browser-manager-v2.js     // 多 Browser 管理器
├── handlers/                     // 任务处理
│   ├── task-runner.js            // 任务执行器
│   └── monitor-task.js           // 监控任务
└── communication/                // 通信层
    ├── socket-client.js          // Socket.IO 客户端
    ├── registration.js           // Worker 注册
    └── heartbeat.js              // 心跳发送
```

**关键职责**:
- ✅ 注册到 Master 并发送心跳
- ✅ 接收任务分配（账户监控、登录请求）
- ✅ 管理多个 Browser 实例（每账户一个）
- ✅ 执行登录流程（提取二维码、检测登录状态）
- ✅ 执行监控任务（爬取评论、私信）
- ✅ 发送数据回 Master（Cookie、用户信息、监控数据）

### 3. Admin Web (管理后台)

**职责**: 可视化管理界面

**核心页面**:
```javascript
packages/admin-web/src/
├── pages/
│   ├── AccountsPage.js           // 账户管理（添加、编辑、登录）
│   ├── WorkersPage.js            // Worker 管理（查看状态、启停）
│   └── LoginManagementPage.js    // 登录管理（查看登录会话）
├── components/
│   ├── LoginModal.js             // 登录弹窗（显示二维码）
│   └── QRCodeModal.js            // 二维码显示组件
└── services/
    ├── socketContext.js          // Socket.IO 上下文
    └── api.js                    // HTTP API 调用
```

**关键功能**:
- ✅ 账户 CRUD（创建、查看、编辑、删除）
- ✅ 发起登录请求，显示二维码
- ✅ 实时查看登录状态和用户信息
- ✅ Worker 状态监控
- ✅ 查看登录会话历史

### 4. Shared (共享模块)

**职责**: 跨包共享代码

```javascript
packages/shared/
├── protocol/
│   ├── messages.js               // 消息类型常量
│   └── events.js                 // 事件类型常量
├── models/
│   └── Account.js                // 账户模型
└── utils/
    ├── logger.js                 // 日志工具
    └── validator.js              // 数据验证
```

---

## 🔄 关键流程

### 流程 1: Worker 注册流程

```
Worker 启动
    ↓
1. 连接 Master Socket.IO (/worker 命名空间)
    ↓
2. 发送 WORKER_REGISTER 消息
   {
     workerId: 'worker-123',
     capabilities: ['douyin', 'xiaohongshu'],  // 支持的平台
     maxAccounts: 10,
     host: '127.0.0.1',
     port: 4000,
     version: '1.0.0'
   }
    ↓
3. Master 验证并存储到 workers 表
    ↓
4. Master 返回 WORKER_REGISTERED
    ↓
5. Worker 开始发送心跳 (每 10 秒)
   WORKER_HEARTBEAT {
     workerId,
     stats: { activeAccounts, memoryUsage, cpuUsage }
   }
    ↓
6. Master 更新 workers.last_heartbeat
    ↓
7. Master 分配账户 (如果有待分配的账户)
   MASTER_TASK_ASSIGN {
     accounts: [{id, platform, ...}]
   }
    ↓
8. Worker 接收并启动监控任务
```

**关键代码位置**:
- Worker 注册: [packages/worker/src/communication/registration.js](../packages/worker/src/communication/registration.js)
- Master 处理: [packages/master/src/communication/socket-server.js:51-63](../packages/master/src/communication/socket-server.js#L51-L63)

---

### 流程 2: 账户登录流程（二维码）

```
Admin Web 点击"登录"按钮
    ↓
1. Admin Web → Master: admin:login:start
   {
     accountId: 'acc-xxx',
     workerId: 'worker-123'  (可选，自动分配)
   }
    ↓
2. Master 创建 login_sessions 记录
   {
     id: 'session-xxx',
     account_id: 'acc-xxx',
     worker_id: 'worker-123',
     status: 'pending',
     expires_at: now + 300  // 5 分钟
   }
    ↓
3. Master → Worker: master:login:start
   {
     sessionId: 'session-xxx',
     accountId: 'acc-xxx',
     platform: 'douyin',
     proxy: {...}
   }
    ↓
4. Worker 执行登录:
   - 启动 Browser (account-specific)
   - 加载指纹配置
   - 访问登录页面
   - 检测登录方式 (二维码/短信)
    ↓
5. Worker 提取二维码
   const qrElement = await page.$('#qrcode img');
   const qrImage = await qrElement.screenshot();
   const qrBase64 = qrImage.toString('base64');
    ↓
6. Worker → Master: worker:login:qrcode
   {
     sessionId,
     qr_code_data: 'data:image/png;base64,...',
     qr_code_url: 'https://...'  (可选)
   }
    ↓
7. Master 更新 login_sessions (qr_code_data, status='scanning')
    ↓
8. Master → Admin Web: login:qrcode:ready
   {
     session_id,
     account_id,
     qr_code_data,
     expires_at
   }
    ↓
9. Admin Web 显示二维码弹窗
    ↓
10. Worker 轮询登录状态 (每 2 秒)
    while (!loggedIn) {
      status = await checkLoginStatus(page);
      if (status.isLoggedIn) break;
      await sleep(2000);
    }
    ↓
11. 用户扫码成功，Worker 检测到登录
    ↓
12. Worker 提取数据:
    - cookies = await page.context().cookies();
    - userInfo = await extractUserInfo(page);  // 昵称、头像、抖音号
    - fingerprint = browserManager.getOrCreateFingerprintConfig(accountId);
    ↓
13. Worker 保存到本地:
    - data/browser/worker-1/{accountId}_storage.json  (Cookies + Storage)
    - data/browser/worker-1/fingerprints/{accountId}_fingerprint.json
    ↓
14. Worker → Master: worker:login:status
    {
      sessionId,
      status: 'success',
      cookies: [{name, value, domain, ...}, ...],
      user_info: {nickname, avatar, douyin_id, uid, ...},
      fingerprint: {userAgent, viewport, webgl, ...},
      cookies_valid_until: now + 7天
    }
    ↓
15. Master 处理登录成功:
    - 更新 login_sessions (status='success', logged_in_at=now)
    - 更新 accounts 表:
      * login_status = 'logged_in'
      * credentials = JSON.stringify({cookies})
      * user_info = JSON.stringify(userInfo)
      * fingerprint = JSON.stringify(fingerprint)
      * last_login_time = now
      * cookies_valid_until = now + 7天
      * account_id = userInfo.douyin_id (如果是临时ID)
    ↓
16. Master → Admin Web: login:success
    {
      session_id,
      account_id,
      user_info,
      logged_in_at
    }
    ↓
17. Admin Web 关闭二维码弹窗，显示成功提示
    ↓
18. Admin Web 刷新账户列表，显示:
    - 用户头像 + 昵称
    - 登录状态: "已登录" (绿色)
    - Cookie 状态: "25 个 Cookie, 有效期至 2025-10-23"
```

**关键代码位置**:
- Admin 发起: [packages/admin-web/src/pages/AccountsPage.js:115-117](../packages/admin-web/src/pages/AccountsPage.js#L115-L117)
- Master 协调: [packages/master/src/login/login-handler.js](../packages/master/src/login/login-handler.js)
- Worker 执行: [packages/worker/src/platforms/douyin/platform.js:48-136](../packages/worker/src/platforms/douyin/platform.js#L48-L136)
- 登录检测: [packages/worker/src/platforms/base/platform-base.js:68-186](../packages/worker/src/platforms/base/platform-base.js#L68-L186)

---

### 流程 3: 账户监控流程

```
Master 启动任务调度器
    ↓
1. TaskScheduler 定期检查 (每 30 秒)
   - 查询 accounts 表 (login_status='logged_in' AND status='active')
   - 为每个账户分配到合适的 Worker
    ↓
2. Master → Worker: MASTER_TASK_ASSIGN
   {
     accounts: [
       {id, platform, account_id, monitor_interval, ...}
     ]
   }
    ↓
3. Worker 接收任务
   - 为每个账户创建 MonitorTask
   - 计算随机监控间隔 (15-30 秒)
    ↓
4. MonitorTask 执行监控:
   setInterval(() => {
     // 4.1 获取或创建 Browser Context
     const context = await browserManager.getAccountContext(accountId);

     // 4.2 获取平台实例
     const platform = platformManager.getPlatform('douyin');

     // 4.3 爬取评论
     const comments = await platform.crawlComments(account);

     // 4.4 爬取私信
     const dms = await platform.crawlDirectMessages(account);

     // 4.5 发送数据到 Master
     workerBridge.sendMonitorData(accountId, comments, dms);

   }, randomInterval);
    ↓
5. Worker → Master: worker:message:detected
   {
     type: 'comment',
     account_id: 'acc-xxx',
     messages: [
       {
         id, content, author_name, author_id,
         post_id, post_title, detected_at
       }
     ]
   }
    ↓
6. Master 接收并存储:
   - 插入到 comments 表或 direct_messages 表
   - 检查是否需要通知 (通知规则)
    ↓
7. 如果需要通知:
   Master → Client (Desktop/Mobile): client:notification
   {
     type: 'new_comment',
     account_id,
     message: {...}
   }
    ↓
8. 计算下次监控时间 (随机 15-30 秒)
    ↓
9. 循环执行
```

**关键代码位置**:
- 任务调度: [packages/master/src/scheduler/task-scheduler.js](../packages/master/src/scheduler/task-scheduler.js)
- Worker 任务: [packages/worker/src/handlers/task-runner.js](../packages/worker/src/handlers/task-runner.js)
- 监控执行: [packages/worker/src/handlers/monitor-task.js](../packages/worker/src/handlers/monitor-task.js)
- 平台爬虫: [packages/worker/src/platforms/douyin/platform.js:551-584](../packages/worker/src/platforms/douyin/platform.js#L551-L584)

---

## 📊 数据流转

### 数据流向图

```
┌─────────────┐
│  Admin Web  │
└──────┬──────┘
       │
       │ 1. 发起操作 (登录、创建账户)
       │ 2. 接收更新 (状态变化、通知)
       ↓
┌──────────────┐
│    Master    │
│  ┌─────────┐ │
│  │ SQLite  │ │ ← 3. 持久化数据
│  │  数据库  │ │    - accounts 表
│  └─────────┘ │    - login_sessions 表
│              │    - workers 表
│              │    - comments/direct_messages 表
└──────┬───────┘
       │
       │ 4. 分配任务 (登录、监控)
       │ 5. 接收数据 (Cookie、用户信息、监控数据)
       ↓
┌──────────────┐
│   Worker 1   │
│  ┌─────────┐ │
│  │Browser A│ │ ← 6. 账户 A 专属 Browser
│  │Browser B│ │ ← 7. 账户 B 专属 Browser
│  └─────────┘ │
│              │
│  本地文件:   │
│  - {accountId}_storage.json     ← 8. Cookie + Storage State
│  - {accountId}_fingerprint.json ← 9. 浏览器指纹
└──────┬───────┘
       │
       │ 10. 浏览器自动化
       ↓
┌──────────────┐
│  抖音平台    │
│  小红书平台  │
│  其他平台... │
└──────────────┘
```

### 数据持久化策略

| 数据类型 | Worker 本地 | Master 数据库 | 说明 |
|---------|------------|--------------|------|
| **Cookie** | ✅ `{accountId}_storage.json` | ✅ `accounts.credentials` | 双重保存，Worker 重启后可快速恢复 |
| **用户信息** | ❌ | ✅ `accounts.user_info` | 仅 Master 保存，用于展示 |
| **浏览器指纹** | ✅ `{accountId}_fingerprint.json` | ✅ `accounts.fingerprint` | Worker 本地用于启动 Browser，Master 用于审计 |
| **登录会话** | ❌ | ✅ `login_sessions` 表 | 临时数据，用于跟踪登录过程 |
| **监控数据** | ❌ | ✅ `comments/direct_messages` 表 | 仅 Master 保存 |
| **Worker 状态** | ❌ | ✅ `workers` 表 | 实时状态 |

---

## 🔌 通信机制

### Socket.IO 命名空间

```javascript
Master Server (端口 3000)
├── /worker          ← Worker 连接
│   ├── on('connection')
│   ├── on('worker:register')
│   ├── on('worker:heartbeat')
│   ├── on('worker:login:qrcode')
│   ├── on('worker:login:status')
│   ├── on('worker:message:detected')
│   └── emit('master:login:start')
│       emit('master:task:assign')
│
├── /admin           ← Admin Web 连接
│   ├── on('connection')
│   ├── on('admin:login:start')
│   ├── on('admin:request:login-sessions')
│   └── emit('login:qrcode:ready')
│       emit('login:success')
│       emit('login:failed')
│
└── /client          ← Desktop/Mobile 客户端连接 (未实现)
    ├── on('connection')
    └── emit('client:notification')
```

### 消息协议

**Worker → Master**:
```javascript
// 注册
WORKER_REGISTER = 'worker:register'

// 心跳
WORKER_HEARTBEAT = 'worker:heartbeat'

// 登录相关
'worker:login:qrcode'   // 发送二维码
'worker:login:status'   // 登录状态更新

// 监控数据
'worker:message:detected'  // 发现新消息
```

**Master → Worker**:
```javascript
// 任务分配
MASTER_TASK_ASSIGN = 'master:task:assign'

// 任务撤销
MASTER_TASK_REVOKE = 'master:task:revoke'

// 登录请求
'master:login:start'
```

**Admin Web ↔ Master**:
```javascript
// Admin → Master
'admin:login:start'              // 发起登录
'admin:request:login-sessions'   // 请求登录会话列表

// Master → Admin
'login:qrcode:ready'     // 二维码就绪
'login:qrcode:refreshed' // 二维码刷新
'login:success'          // 登录成功
'login:failed'           // 登录失败
'login:qrcode:expired'   // 二维码过期
```

---

## 📈 状态管理

### Worker 状态流转

```
disconnected  →  connected  →  ready  →  busy  →  ready
     ↑              ↓                      ↓         ↑
     └──────────────┴──────────────────────┴─────────┘
                 (断线重连)            (任务完成)
```

**状态说明**:
- `disconnected`: 未连接到 Master
- `connected`: 已连接，但未注册
- `ready`: 已注册，可接收任务
- `busy`: 执行任务中
- `offline`: 超过 30 秒未发送心跳

### 账户登录状态流转

```
not_logged_in → logging_in → logged_in
      ↑            ↓             ↓
      └────────────┴─────────────┘
              (Cookie 过期/登录失败)
```

**状态说明**:
- `not_logged_in`: 未登录
- `logging_in`: 登录中 (显示二维码)
- `logged_in`: 已登录 (有有效 Cookie)
- `login_failed`: 登录失败

### 登录会话状态流转

```
pending → scanning → success
   ↓         ↓
expired   failed
```

**状态说明**:
- `pending`: 待扫码
- `scanning`: 扫码中
- `success`: 登录成功
- `failed`: 登录失败
- `expired`: 二维码过期 (5 分钟)

---

## 🎯 关键设计原则

### 1. 多 Browser 架构

**原则**: 每个账户独立 Browser 进程

**优势**:
- ✅ 100% 指纹隔离，无关联风险
- ✅ 进程隔离，一个崩溃不影响其他
- ✅ 指纹稳定，持久化到文件

**实现**:
```javascript
// packages/worker/src/browser/browser-manager-v2.js
const context = await chromium.launchPersistentContext(
  `./data/browser/${workerId}/browser_${accountId}`,  // 独立数据目录
  {
    userAgent: fingerprint.userAgent,
    viewport: fingerprint.viewport,
    // ... 15+ 种指纹特征
  }
);
```

### 2. 平台插件化

**原则**: 平台脚本动态加载，易扩展

**实现**:
```javascript
// packages/worker/src/platform-manager.js
class PlatformManager {
  async loadPlatforms() {
    const platformDirs = fs.readdirSync('./src/platforms');
    for (const dir of platformDirs) {
      if (dir === 'base') continue;
      const config = require(`./platforms/${dir}/config.json`);
      const Platform = require(`./platforms/${dir}/platform.js`);
      this.platforms.set(config.platform, new Platform(...));
    }
  }
}
```

**添加新平台**:
1. 创建 `packages/worker/src/platforms/xiaohongshu/`
2. 添加 `config.json` 和 `platform.js`
3. 继承 `PlatformBase` 类
4. 重启 Worker 自动加载

### 3. 通用登录框架

**原则**: 支持多种登录方式（二维码、短信、密码）

**检测逻辑**:
```javascript
// packages/worker/src/platforms/base/platform-base.js
async detectLoginMethod(page) {
  // 1. 检查是否已登录
  if (await page.$('.user-avatar')) {
    return { type: 'logged_in' };
  }

  // 2. 检查二维码
  if (await page.$('img[class*="qrcode"]')) {
    return { type: 'qrcode', selector: '...' };
  }

  // 3. 检查短信登录
  if (await page.$('input[placeholder*="手机号"]')) {
    return { type: 'sms', phoneSelector: '...' };
  }
}
```

### 4. 数据分层存储

**原则**: 临时数据和长期数据分离

**实现**:
- **临时数据**: `login_sessions` 表（登录过程，可定期清理）
- **长期数据**: `accounts` 表（登录凭据，持久保存）
- **本地缓存**: Worker 文件系统（快速恢复）

---

## 🔐 安全性考虑

### 1. Cookie 加密（待实现）

```javascript
// 建议使用 AES-256 加密
const crypto = require('crypto');

function encryptCredentials(credentials) {
  const cipher = crypto.createCipheriv('aes-256-cbc', secretKey, iv);
  return cipher.update(JSON.stringify(credentials), 'utf8', 'hex') + cipher.final('hex');
}
```

### 2. 指纹随机化

```javascript
// packages/worker/src/browser/browser-manager-v2.js
// 基于 accountId 的 seeded random，确保稳定性
const seed = this.hashString(accountId);
const random = this.seededRandom(seed);

const fingerprint = {
  userAgent: this.randomUserAgent(random),
  viewport: this.randomViewport(random),
  webgl: this.randomWebGL(random),
  // ... 15+ 种特征
};
```

### 3. 数据访问控制

- Admin Web 需要 Socket.IO 认证（待实现）
- API 端点需要验证管理员权限
- Worker 只能访问分配给它的账户数据

---

## 📚 相关文档

- [CLAUDE.md](../CLAUDE.md) - 开发指南
- [登录数据保存功能实现报告](.docs/登录数据保存功能实现报告.md)
- [通用平台脚本系统设计方案](.docs/worker-通用平台脚本系统设计方案.md)
- [账户级浏览器隔离登录流程设计](.docs/账户级浏览器隔离登录流程设计.md)

---

**文档版本**: 2.0.0
**最后更新**: 2025-10-16
**维护者**: 开发团队
