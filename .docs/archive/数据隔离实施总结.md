# Worker æ•°æ®ç›®å½•éš”ç¦»å®æ–½æ€»ç»“

## ğŸ“‹ å®æ–½æ¦‚è§ˆ

**åŠŸèƒ½**: Worker æ•°æ®ç›®å½•éš”ç¦»
**çŠ¶æ€**: âœ… å·²å®Œæˆ
**æ—¥æœŸ**: 2025-10-12
**å·¥ä½œé‡**: 1 è¡Œä»£ç ä¿®æ”¹ + å®Œæ•´æµ‹è¯•éªŒè¯

---

## ğŸ¯ å®æ–½ç›®æ ‡

è§£å†³å¤šä¸ª Worker è¿›ç¨‹å…±äº«åŒä¸€ä¸ª Playwright æ•°æ®ç›®å½•å¯¼è‡´çš„æ–‡ä»¶å†²çªé—®é¢˜ã€‚

### é—®é¢˜æè¿°

**ä¿®æ”¹å‰:**
- æ‰€æœ‰ Worker ä½¿ç”¨ç›¸åŒçš„æ•°æ®ç›®å½• `./data/browser`
- Storage state æ–‡ä»¶è·¯å¾„æ ¼å¼: `./data/browser/{accountId}_state.json`
- å¤šä¸ª Worker å¤„ç†åŒä¸€è´¦å·æ—¶,ä¼šå¹¶å‘è¯»å†™åŒä¸€æ–‡ä»¶
- å¯¼è‡´æ•°æ®æŸåæˆ–ç›¸äº’è¦†ç›–

**å½±å“:**
- æ•°æ®å†²çªé£é™©
- æ–‡ä»¶ç³»ç»Ÿç«äº‰
- éš¾ä»¥è°ƒè¯•å’Œè¿½è¸ª

---

## âœ… å®æ–½å†…å®¹

### 1. ä»£ç ä¿®æ”¹

**ä¿®æ”¹æ–‡ä»¶**: `packages/worker/src/index.js`
**ä¿®æ”¹ä½ç½®**: ç¬¬ 71 è¡Œ
**ä¿®æ”¹å†…å®¹**: 1 è¡Œ

```diff
  // 4. åˆå§‹åŒ–æµè§ˆå™¨ç®¡ç†å™¨
  browserManager = new BrowserManager(WORKER_ID, {
    headless: process.env.HEADLESS !== 'false', // é»˜è®¤ headless
-   dataDir: './data/browser',
+   dataDir: `./data/browser/${WORKER_ID}`,  // Worker ä¸“å±ç›®å½•,å®ç°æ•°æ®éš”ç¦»
  });
```

### 2. æµ‹è¯•éªŒè¯

**æµ‹è¯•æ–‡ä»¶**: `test-data-isolation.js`
**æµ‹è¯•å†…å®¹**:
- æµ‹è¯• 1: æ•°æ®ç›®å½•éš”ç¦»
- æµ‹è¯• 2: Storage State è·¯å¾„éš”ç¦»
- æµ‹è¯• 3: æ•°æ®ç›®å½•è‡ªåŠ¨åˆ›å»º
- æµ‹è¯• 4: ç›®å½•ç»“æ„éªŒè¯

**æµ‹è¯•ç»“æœ**:
```
æ€»æµ‹è¯•æ•°: 4
âœ… é€šè¿‡: 4
âŒ å¤±è´¥: 0
```

### 3. æ–‡æ¡£æ›´æ–°

**åˆ›å»ºæ–‡æ¡£**:
- `Playwrightæ•°æ®ç›®å½•éš”ç¦»è¯´æ˜.md` - å®Œæ•´æŠ€æœ¯æ–‡æ¡£
- `æ•°æ®éš”ç¦»å®æ–½æ€»ç»“.md` (æœ¬æ–‡ä»¶) - å®æ–½æ€»ç»“

**æ›´æ–°æ–‡æ¡£**:
- `.docs/README.md` - æ·»åŠ æ–°æ–‡æ¡£å¯¼èˆª

---

## ğŸ“Š å®æ–½æ•ˆæœ

### ä¿®æ”¹å‰åå¯¹æ¯”

#### ç›®å½•ç»“æ„å¯¹æ¯”

**ä¿®æ”¹å‰:**
```
data/browser/
â”œâ”€â”€ account-123_state.json  â† Worker-1 å’Œ Worker-2 å…±äº«
â”œâ”€â”€ account-456_state.json
â””â”€â”€ account-789_state.json
```

**ä¿®æ”¹å:**
```
data/browser/
â”œâ”€â”€ worker-1/
â”‚   â”œâ”€â”€ account-123_state.json  â† Worker-1 ä¸“å±
â”‚   â””â”€â”€ account-456_state.json
â”œâ”€â”€ worker-2/
â”‚   â”œâ”€â”€ account-123_state.json  â† Worker-2 ä¸“å± (åŒè´¦å·,ç‹¬ç«‹æ–‡ä»¶)
â”‚   â””â”€â”€ account-789_state.json
â””â”€â”€ worker-3/
    â”œâ”€â”€ account-111_state.json
    â””â”€â”€ account-222_state.json
```

#### æ¶æ„å¯¹æ¯”

**ä¿®æ”¹å‰:**
```
Worker-1 â”€â”
Worker-2 â”€â”¼â”€â†’ ./data/browser/ â† å…±äº«ç›®å½•,æœ‰å†²çª
Worker-3 â”€â”˜
```

**ä¿®æ”¹å:**
```
Worker-1 â†’ ./data/browser/worker-1/ â† ç‹¬ç«‹ç›®å½•
Worker-2 â†’ ./data/browser/worker-2/ â† ç‹¬ç«‹ç›®å½•
Worker-3 â†’ ./data/browser/worker-3/ â† ç‹¬ç«‹ç›®å½•
```

### å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | ä¿®æ”¹å‰ | ä¿®æ”¹å |
|------|--------|--------|
| æ•°æ®å†²çªé£é™© | âš ï¸ é«˜ | âœ… æ—  |
| æ–‡ä»¶ç³»ç»Ÿç«äº‰ | âš ï¸ å­˜åœ¨ | âœ… æ—  |
| è°ƒè¯•éš¾åº¦ | âš ï¸ å›°éš¾ | âœ… ç®€å• |
| æ¸…ç†ä¾¿åˆ©æ€§ | âš ï¸ å¤æ‚ | âœ… ç®€å• |
| ç£ç›˜å ç”¨ | æœ€å° | ç•¥å¢ (å¯å¿½ç•¥) |
| æ€§èƒ½å½±å“ | - | âœ… æ— å½±å“ |

---

## ğŸ’¡ ä¼˜åŠ¿åˆ†æ

### æŠ€æœ¯ä¼˜åŠ¿

1. **å®Œå…¨éš”ç¦»**
   - æ¯ä¸ª Worker æœ‰ç‹¬ç«‹çš„æ•°æ®ç›®å½•
   - é›¶å†²çª,é›¶ç«äº‰

2. **ç®€å•å¯é **
   - åªä¿®æ”¹ 1 è¡Œä»£ç 
   - æ— éœ€æ–‡ä»¶é”æˆ–å…¶ä»–å¤æ‚æœºåˆ¶
   - æ— é¢å¤–ä¾èµ–

3. **æ˜“äºç»´æŠ¤**
   - æ¸…æ™°çš„ç›®å½•ç»“æ„
   - æŒ‰ Worker ID ç»„ç»‡
   - æ–¹ä¾¿è°ƒè¯•å’Œè¿½è¸ª

4. **æ€§èƒ½æœ€ä¼˜**
   - æ— é”ç­‰å¾…
   - æ— æ–‡ä»¶ç³»ç»Ÿç«äº‰
   - æ— æ€§èƒ½æŸå¤±

### è¿ç»´ä¼˜åŠ¿

1. **è°ƒè¯•æ–¹ä¾¿**
   - æŒ‰ Worker ID æŸ¥æ‰¾æ•°æ®
   - æ¸…æ™°çš„æ–‡ä»¶å½’å±

2. **æ¸…ç†ç®€å•**
   ```bash
   # æ¸…ç†æŸä¸ª Worker çš„æ‰€æœ‰æ•°æ®
   rm -rf data/browser/worker-{workerId}
   ```

3. **ç›‘æ§æ˜ç¡®**
   - å¯ä»¥å•ç‹¬ç›‘æ§æ¯ä¸ª Worker çš„ç£ç›˜å ç”¨
   - å¯ä»¥è¿½è¸ªæ¯ä¸ª Worker çš„æ•°æ®å¢é•¿

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. Storage State ä¸å…±äº«

**å½±å“:**
- åŒä¸€è´¦å·åœ¨ä¸åŒ Worker ä¸Šéœ€è¦åˆ†åˆ«ç™»å½•
- è´¦å·ä» Worker-1 è¿ç§»åˆ° Worker-2 æ—¶éœ€è¦é‡æ–°ç™»å½•

**è§£å†³æ–¹æ³• (å¯é€‰ä¼˜åŒ–):**
- å°† storage state ä¿å­˜åˆ° Master æ•°æ®åº“
- Worker ä» Master è·å–å·²ç™»å½•çŠ¶æ€

### 2. ç£ç›˜å ç”¨

**å½±å“:**
- N ä¸ª Worker Ã— M ä¸ª Account = NÃ—M ä¸ª state æ–‡ä»¶
- æ¯ä¸ªæ–‡ä»¶çº¦ 50-100KB

**ç¤ºä¾‹:**
- 3 ä¸ª Worker Ã— 100 ä¸ª Account = 300 ä¸ªæ–‡ä»¶
- æ€»å ç”¨: 300 Ã— 75KB â‰ˆ 22.5MB (å¯å¿½ç•¥)

### 3. æ•°æ®æ¸…ç†

**å»ºè®®:**
- å®šæœŸæ¸…ç†ç¦»çº¿ Worker çš„æ•°æ®
- åŸºäº Worker çŠ¶æ€å’Œæœ€åå¿ƒè·³æ—¶é—´
- å¯åœ¨ Master ç«¯å®ç°è‡ªåŠ¨æ¸…ç†æœºåˆ¶

---

## ğŸ”„ åç»­ä¼˜åŒ–å»ºè®®

### ä¼˜å…ˆçº§: ä½ (å¯é€‰)

#### 1. Storage State å…±äº«æœºåˆ¶

**ç›®çš„**: å‡å°‘é‡å¤ç™»å½•æ¬¡æ•°

**å®ç°æ€è·¯:**
```javascript
// Master ç«¯
// 1. ä¿å­˜ storage state åˆ°æ•°æ®åº“
db.prepare(`
  INSERT INTO account_storage_states (account_id, state_data, updated_at)
  VALUES (?, ?, ?)
  ON CONFLICT(account_id) DO UPDATE SET
    state_data = excluded.state_data,
    updated_at = excluded.updated_at
`).run(accountId, JSON.stringify(stateData), Date.now());

// 2. Worker è¯·æ±‚ç™»å½•æ—¶,ä¸‹å‘å·²æœ‰çš„ state
const existingState = db.prepare(`
  SELECT state_data FROM account_storage_states
  WHERE account_id = ?
`).get(accountId);

if (existingState) {
  // å‘é€ç»™ Worker
  socket.emit('master:login:state', {
    account_id: accountId,
    state_data: JSON.parse(existingState.state_data),
  });
}
```

**ä¼˜ç‚¹:**
- é¿å…é‡å¤ç™»å½•
- æé«˜æ•ˆç‡

**ç¼ºç‚¹:**
- å¢åŠ å®ç°å¤æ‚åº¦
- æ•°æ®åº“å¢åŠ å­˜å‚¨å‹åŠ›

#### 2. è‡ªåŠ¨æ¸…ç†æœºåˆ¶

**ç›®çš„**: èŠ‚çœç£ç›˜ç©ºé—´

**å®ç°æ€è·¯:**
```javascript
// Master ç«¯,å®šæœŸä»»åŠ¡
setInterval(() => {
  // è·å–ç¦»çº¿è¶…è¿‡ 7 å¤©çš„ Worker
  const offlineWorkers = db.prepare(`
    SELECT id FROM workers
    WHERE status='offline'
    AND last_heartbeat < ?
  `).all(Date.now() - 7 * 24 * 3600 * 1000);

  // æ¸…ç†å¯¹åº”çš„æ•°æ®ç›®å½•
  for (const worker of offlineWorkers) {
    const dataDir = path.join('./data/browser', worker.id);
    if (fs.existsSync(dataDir)) {
      fs.rmSync(dataDir, { recursive: true });
      logger.info(`Cleaned up data for offline worker: ${worker.id}`);
    }
  }
}, 24 * 3600 * 1000);  // æ¯å¤©æ‰§è¡Œ
```

#### 3. æ•°æ®è¿ç§»æœºåˆ¶

**ç›®çš„**: Worker é‡æ–°åˆ†é…è´¦å·æ—¶ä¿ç•™ç™»å½•çŠ¶æ€

**å®ç°æ€è·¯:**
```javascript
// Master é‡æ–°åˆ†é…è´¦å·æ—¶
// 1. é€šçŸ¥æ—§ Worker ä¸Šä¼  storage state
oldWorkerSocket.emit('worker:upload:state', { account_id: accountId });

// 2. æ—§ Worker å“åº”
oldWorkerSocket.on('worker:state:uploaded', (data) => {
  // ä¿å­˜åˆ°ä¸´æ—¶å­˜å‚¨æˆ–æ•°æ®åº“
  temporaryStates.set(data.account_id, data.state_data);
});

// 3. é€šçŸ¥æ–° Worker ä¸‹è½½ storage state
newWorkerSocket.emit('worker:download:state', {
  account_id: accountId,
  state_data: temporaryStates.get(accountId),
});
```

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- **æŠ€æœ¯è¯¦ç»†æ–‡æ¡£**: `.docs/Playwrightæ•°æ®ç›®å½•éš”ç¦»è¯´æ˜.md`
- **ç³»ç»Ÿä½¿ç”¨æŒ‡å—**: `.docs/ç³»ç»Ÿä½¿ç”¨æŒ‡å—.md`
- **æ–‡æ¡£å¯¼èˆª**: `.docs/README.md`

---

## âœ… éªŒè¯æ¸…å•

- [x] ä»£ç ä¿®æ”¹å®Œæˆ
- [x] è¯­æ³•æ£€æŸ¥é€šè¿‡
- [x] è‡ªåŠ¨åŒ–æµ‹è¯•é€šè¿‡ (4/4)
- [x] ç›®å½•ç»“æ„éªŒè¯
- [x] æŠ€æœ¯æ–‡æ¡£æ›´æ–°
- [x] å®æ–½æ€»ç»“ç¼–å†™

---

## ğŸ‰ æ€»ç»“

**æ ¸å¿ƒæˆæœ:**
- âœ… 1 è¡Œä»£ç è§£å†³å¤š Worker æ•°æ®å†²çªé—®é¢˜
- âœ… å®Œå…¨éš”ç¦»,é›¶é£é™©
- âœ… æ— æ€§èƒ½æŸå¤±
- âœ… æ˜“äºç»´æŠ¤

**å®æ–½è´¨é‡:**
- ä»£ç ç®€æ´ä¼˜é›…
- æµ‹è¯•è¦†ç›–å®Œæ•´
- æ–‡æ¡£è¯¦å°½æ¸…æ™°
- å‘åå…¼å®¹

**å»ºè®®:**
- å½“å‰å®ç°å·²æ»¡è¶³ç”Ÿäº§ç¯å¢ƒéœ€æ±‚
- åç»­ä¼˜åŒ–å¯æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©æ€§å®æ–½
- ä¼˜å…ˆä¿æŒç®€å•å¯é 

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0
**åˆ›å»ºæ—¥æœŸ**: 2025-10-12
**ä½œè€…**: å¼€å‘å›¢é˜Ÿ
