# 二维码登录流程详解

## 📋 概述

本文档详细说明从 Admin Web 创建账户到扫码登录的完整流程。

## 🔄 完整流程图

```
┌─────────────┐         ┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│  Admin Web  │         │   Master    │         │   Worker    │         │  用户手机   │
└──────┬──────┘         └──────┬──────┘         └──────┬──────┘         └──────┬──────┘
       │                       │                       │                       │
       │ 1. 创建账户            │                       │                       │
       │ (填写基本信息)         │                       │                       │
       ├──────────────────────>│                       │                       │
       │                       │                       │                       │
       │                       │ 2. 保存账户到数据库     │                       │
       │                       │    分配 Worker        │                       │
       │                       │                       │                       │
       │ 3. 创建成功 ✓          │                       │                       │
       │<──────────────────────┤                       │                       │
       │                       │                       │                       │
       │ 4. 点击"登录"按钮      │                       │                       │
       │    startLogin()       │                       │                       │
       ├──────────────────────>│                       │                       │
       │                       │                       │                       │
       │                       │ 5. 创建 login_session │                       │
       │                       │    发送登录请求       │                       │
       │                       ├──────────────────────>│                       │
       │                       │                       │                       │
       │                       │                       │ 6. 打开浏览器         │
       │                       │                       │    导航到抖音登录页   │
       │                       │                       │    生成二维码         │
       │                       │                       │                       │
       │                       │ 7. QR码就绪事件       │                       │
       │                       │<──────────────────────┤                       │
       │                       │                       │                       │
       │ 8. 广播 QR 码数据      │                       │                       │
       │    (Base64 图片)      │                       │                       │
       │<──────────────────────┤                       │                       │
       │                       │                       │                       │
       │ 9. 显示 QR 码模态框    │                       │                       │
       │    (QRCodeModal)      │                       │                       │
       │                       │                       │                       │
       │                       │                       │                       │ 10. 用户扫码
       │                       │                       │<──────────────────────┤
       │                       │                       │                       │
       │                       │                       │ 11. 检测登录成功      │
       │                       │                       │     获取 cookies      │
       │                       │                       │                       │
       │                       │ 12. 登录成功事件      │                       │
       │                       │<──────────────────────┤                       │
       │                       │                       │                       │
       │                       │ 13. 更新账户状态      │                       │
       │                       │     保存 cookies      │                       │
       │                       │                       │                       │
       │ 14. 广播登录成功       │                       │                       │
       │     关闭 QR 模态框     │                       │                       │
       │<──────────────────────┤                       │                       │
       │                       │                       │                       │
       │ 15. 显示成功提示 ✓     │                       │                       │
       │                       │                       │                       │
```

## 🎯 详细步骤说明

### 步骤 1-3: 创建账户

**前端操作** ([AccountsPage.js:66-85](../packages/admin-web/src/pages/AccountsPage.js#L66-L85))

```javascript
// 1. 管理员填写表单
const values = {
  platform: 'douyin',      // 平台
  account_name: '测试账户', // 账户名称
  account_id: 'test_001',  // 账户ID
  credentials: '{}',       // 初始凭证（空对象）
  monitor_interval: 30,    // 监控间隔
  status: 'active'         // 状态
};

// 2. 提交到后端 API
await accountsAPI.createAccount(values);
```

**后端处理** ([accounts.js:83-129](../packages/master/src/api/routes/accounts.js#L83-L129))

```javascript
// Master 接收请求
router.post('/api/v1/accounts', async (req, res) => {
  // 验证必填字段
  if (!platform || !account_name || !account_id || !credentials) {
    return res.status(400).json({ error: 'Missing required fields' });
  }

  // 创建账户
  const account = new Account({ ...req.body });
  const createdAccount = accountsDAO.create(account);

  // 分配给 Worker
  accountAssigner.assignNewAccount(createdAccount);

  res.json({ success: true, data: createdAccount });
});
```

**数据库记录**:
```sql
INSERT INTO accounts (
  id, platform, account_name, account_id,
  credentials, status, login_status, assigned_worker_id
) VALUES (
  'uuid-xxx',
  'douyin',
  '测试账户',
  'test_001',
  '{}',  -- 初始为空
  'active',
  'not_logged_in',  -- 初始未登录
  'worker-1'  -- 已分配 Worker
);
```

### 步骤 4: 启动登录流程

**前端操作** ([AccountsPage.js:108-123](../packages/admin-web/src/pages/AccountsPage.js#L108-L123))

```javascript
// 管理员点击"登录"按钮
const handleStartLogin = (account) => {
  // 检查是否已分配 Worker
  if (!account.assigned_worker_id) {
    message.error('该账户尚未分配 Worker');
    return;
  }

  Modal.confirm({
    title: '启动登录流程',
    content: `确定要为账户 "${account.account_name}" 启动登录流程吗？`,
    onOk: () => {
      // 调用 Socket.IO 启动登录
      startLogin(account.id, account.assigned_worker_id);
    },
  });
};
```

**Socket.IO 通信** ([socketContext.js:135-151](../packages/admin-web/src/services/socketContext.js#L135-L151))

```javascript
const startLogin = (accountId, workerId) => {
  const sessionId = `session-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

  // 发送到 Master 的 admin namespace
  socket.emit('master:login:start', {
    account_id: accountId,
    worker_id: workerId,
    session_id: sessionId,
  });

  message.info('正在启动登录流程...');
};
```

### 步骤 5-6: Master 创建会话并通知 Worker

**Master 处理** ([admin-namespace.js](../packages/master/src/socket/admin-namespace.js))

```javascript
// 接收登录启动请求
socket.on('master:login:start', ({ account_id, worker_id, session_id }) => {
  // 1. 创建登录会话
  const session = loginHandler.createLoginSession(
    account_id,
    worker_id,
    'qrcode'  // 登录方法
  );

  // 2. 通过 worker namespace 发送给指定 Worker
  workerNamespace.to(worker_id).emit('worker:start_login', {
    account_id,
    session_id: session.id,
  });
});
```

**数据库记录**:
```sql
INSERT INTO login_sessions (
  id, account_id, worker_id, status,
  login_method, expires_at, created_at
) VALUES (
  'session-xxx',
  'account-id',
  'worker-1',
  'pending',
  'qrcode',
  unix_timestamp + 300,  -- 5分钟后过期
  unix_timestamp
);
```

**Worker 处理** ([douyin-login-handler.js:60-156](../packages/worker/src/browser/douyin-login-handler.js#L60-L156))

```javascript
async startLogin(accountId, sessionId) {
  // 1. 创建或获取 Browser Context
  const context = await this.browserManager.getOrCreateContext(accountId);

  // 2. 创建新页面
  const page = await context.newPage();

  // 3. 导航到抖音登录页
  await page.goto('https://www.douyin.com/');

  // 4. 点击登录按钮
  await this.clickLoginButton(page);

  // 5. 等待二维码出现
  await this.waitForQRCode(page);

  // 6. 截取二维码图片
  const qrElement = await page.locator('.qrcode-container').first();
  const screenshot = await qrElement.screenshot();
  const qrCodeData = `data:image/png;base64,${screenshot.toString('base64')}`;

  // 7. 通知 Master 二维码已就绪
  this.notifyQRCodeReady(accountId, sessionId, qrCodeData);

  // 8. 监听登录成功
  this.monitorLoginSuccess(page, accountId, sessionId);
}
```

### 步骤 7-8: Worker 发送 QR 码给 Master

**Worker 通知** ([douyin-login-handler.js:710-728](../packages/worker/src/browser/douyin-login-handler.js#L710-L728))

```javascript
notifyQRCodeReady(accountId, sessionId, qrCodeData, qrCodeUrl) {
  this.socketClient.emit('worker:qrcode:ready', {
    account_id: accountId,
    session_id: sessionId,
    qr_code_data: qrCodeData,  // Base64 编码的图片
    qr_code_url: qrCodeUrl,    // 可选的 URL
    timestamp: Date.now(),
  });
}
```

**Master 处理** ([login-handler.js:79-120](../packages/master/src/login/login-handler.js#L79-L120))

```javascript
handleQRCodeReady(sessionId, qrCodeData, qrCodeUrl) {
  // 1. 更新数据库
  this.db.prepare(`
    UPDATE login_sessions
    SET qr_code_data = ?, qr_code_url = ?, status = 'scanning'
    WHERE id = ?
  `).run(qrCodeData, qrCodeUrl, sessionId);

  // 2. 广播给所有管理员客户端
  this.adminNamespace.broadcastToAdmins('login:qrcode:ready', {
    session_id: sessionId,
    account_id: session.account_id,
    worker_id: session.worker_id,
    qr_code_data: qrCodeData,
    qr_code_url: qrCodeUrl,
    expires_at: session.expires_at,
    timestamp: Date.now(),
  });
}
```

### 步骤 9: 前端显示二维码

**Socket.IO 监听** ([socketContext.js:79-83](../packages/admin-web/src/services/socketContext.js#L79-L83))

```javascript
// 监听 QR 码就绪事件
socket.on('login:qrcode:ready', (data) => {
  console.log('QR code ready:', data);
  setQRCodeData(data);  // 保存到状态
  message.success(`账户 ${data.account_id} 的 QR 码已准备就绪`);
});
```

**模态框显示** ([QRCodeModal.js:60-141](../packages/admin-web/src/components/QRCodeModal.js#L60-L141))

```javascript
const QRCodeModal = ({ visible, onClose, qrCodeData }) => {
  return (
    <Modal
      title="扫描二维码登录"
      open={visible}
      onCancel={onClose}
    >
      {/* 显示 Base64 图片 */}
      <Image
        src={qrCodeData.qr_code_data}
        alt="QR Code"
        style={{ maxWidth: '300px' }}
      />

      {/* 显示倒计时 */}
      <Progress percent={progress} />
      <Text>剩余时间: {formatTime(timeLeft)}</Text>

      {/* 显示账户信息 */}
      <Text>账户 ID: {qrCodeData.account_id}</Text>
      <Text>Worker ID: {qrCodeData.worker_id}</Text>
      <Text>会话 ID: {qrCodeData.session_id}</Text>
    </Modal>
  );
};
```

### 步骤 10-11: 用户扫码登录

**Worker 监听登录成功** ([douyin-login-handler.js:465-614](../packages/worker/src/browser/douyin-login-handler.js#L465-L614))

```javascript
async monitorLoginSuccess(page, accountId, sessionId) {
  try {
    // 方法1: 监听 URL 变化
    await page.waitForURL(/user|profile/, { timeout: 300000 });

    // 方法2: 检测用户头像元素
    await page.waitForSelector('.user-avatar', { timeout: 5000 });

    // 方法3: 检查 localStorage
    const isLoggedIn = await page.evaluate(() => {
      return !!localStorage.getItem('user_info');
    });

    if (isLoggedIn) {
      await this.handleLoginSuccess(page, accountId, sessionId);
    }

  } catch (error) {
    logger.error('Login monitoring failed:', error);
    this.notifyLoginFailed(accountId, sessionId, error.message);
  }
}
```

**获取 Cookies** ([douyin-login-handler.js:585-604](../packages/worker/src/browser/douyin-login-handler.js#L585-L604))

```javascript
async handleLoginSuccess(page, accountId, sessionId) {
  // 1. 保存 storage state（包含 cookies 和 localStorage）
  await this.browserManager.saveStorageState(accountId);

  // 2. 获取 cookies 信息
  const cookies = await page.context().cookies();
  const cookiesValidUntil = this.calculateCookiesExpiry(cookies);

  // 3. 通知 Master 登录成功
  this.notifyLoginSuccess(accountId, sessionId, cookies, cookiesValidUntil);
}
```

### 步骤 12-13: Worker 通知 Master 登录成功

**Worker 通知** ([douyin-login-handler.js:640-654](../packages/worker/src/browser/douyin-login-handler.js#L640-L654))

```javascript
notifyLoginSuccess(accountId, sessionId, cookies, cookiesValidUntil) {
  this.socketClient.emit('worker:login:success', {
    account_id: accountId,
    session_id: sessionId,
    cookies: cookies,  // 完整的 cookies 数组
    cookies_valid_until: cookiesValidUntil,
    timestamp: Date.now(),
  });
}
```

**Master 处理** ([login-handler.js:128-179](../packages/master/src/login/login-handler.js#L128-L179))

```javascript
handleLoginSuccess(sessionId, cookies, cookiesValidUntil) {
  // 1. 更新登录会话状态
  this.db.prepare(`
    UPDATE login_sessions
    SET status = 'success', logged_in_at = ?
    WHERE id = ?
  `).run(now, sessionId);

  // 2. 更新账户登录状态和凭证
  this.db.prepare(`
    UPDATE accounts
    SET login_status = 'logged_in',
        last_login_time = ?,
        cookies_valid_until = ?,
        credentials = ?
    WHERE id = ?
  `).run(now, cookiesValidUntil, JSON.stringify({ cookies }), accountId);

  // 3. 广播给管理员
  this.adminNamespace.broadcastToAdmins('login:success', {
    session_id: sessionId,
    account_id: accountId,
    worker_id: workerId,
    logged_in_at: now,
  });
}
```

### 步骤 14-15: 前端显示成功

**Socket.IO 监听** ([socketContext.js:86-90](../packages/admin-web/src/services/socketContext.js#L86-L90))

```javascript
// 登录成功
socket.on('login:success', (data) => {
  console.log('Login success:', data);
  message.success(`账户 ${data.account_id} 登录成功`);
  setQRCodeData(null);  // 关闭模态框
});
```

## 🔍 关键数据结构

### 账户对象 (Account)

```javascript
{
  id: "uuid-xxx",
  platform: "douyin",
  account_name: "测试账户",
  account_id: "test_001",
  credentials: "{\"cookies\": [...]}",  // 登录成功后保存
  status: "active",
  login_status: "logged_in",  // not_logged_in | logged_in | login_failed
  monitor_interval: 30,
  last_check_time: 1697123456,
  last_login_time: 1697123456,
  cookies_valid_until: 1697209856,
  assigned_worker_id: "worker-1",
  created_at: 1697123456,
  updated_at: 1697123456
}
```

### 登录会话对象 (LoginSession)

```javascript
{
  id: "session-xxx",
  account_id: "account-id",
  worker_id: "worker-1",
  status: "scanning",  // pending | scanning | success | failed | expired
  login_method: "qrcode",
  qr_code_data: "data:image/png;base64,...",  // Base64 图片
  qr_code_url: "https://douyin.com/qr/xxx",  // 可选
  error_message: null,
  expires_at: 1697123756,  // 5分钟后
  logged_in_at: null,
  created_at: 1697123456
}
```

### QR 码数据 (前端)

```javascript
{
  session_id: "session-xxx",
  account_id: "account-id",
  worker_id: "worker-1",
  qr_code_data: "data:image/png;base64,...",
  qr_code_url: "https://douyin.com/qr/xxx",
  expires_at: 1697123756,
  timestamp: 1697123456789
}
```

## 📡 Socket.IO 事件列表

### Admin → Master

| 事件名 | 方向 | 参数 | 说明 |
|--------|------|------|------|
| `master:login:start` | Admin → Master | `{ account_id, worker_id, session_id }` | 启动登录流程 |
| `admin:status:request` | Admin → Master | - | 请求系统状态 |
| `admin:login_sessions:list` | Admin → Master | - | 请求登录会话列表 |

### Master → Admin

| 事件名 | 方向 | 参数 | 说明 |
|--------|------|------|------|
| `login:qrcode:ready` | Master → Admin | `{ session_id, qr_code_data, ... }` | 二维码已准备 |
| `login:success` | Master → Admin | `{ session_id, account_id, ... }` | 登录成功 |
| `login:failed` | Master → Admin | `{ session_id, error_message, ... }` | 登录失败 |
| `login:qrcode:expired` | Master → Admin | `{ session_id }` | 二维码过期 |
| `login:qrcode:refreshed` | Master → Admin | `{ session_id, qr_code_data, ... }` | 二维码刷新 |

### Master ↔ Worker

| 事件名 | 方向 | 参数 | 说明 |
|--------|------|------|------|
| `worker:start_login` | Master → Worker | `{ account_id, session_id }` | 通知 Worker 启动登录 |
| `worker:qrcode:ready` | Worker → Master | `{ account_id, session_id, qr_code_data }` | Worker 上报二维码 |
| `worker:login:success` | Worker → Master | `{ account_id, session_id, cookies, ... }` | Worker 上报登录成功 |
| `worker:login:failed` | Worker → Master | `{ account_id, session_id, error_message }` | Worker 上报登录失败 |

## ⚠️ 常见问题

### 1. 创建账户时 credentials 字段如何填写？

**方案A: 允许空对象**
```javascript
// 前端填写
credentials: '{}'  // 空 JSON 对象

// 后端修改验证逻辑,允许空对象
const credentials = req.body.credentials || '{}';
```

**方案B: 隐藏字段**
```javascript
// 前端不显示 credentials 字段
// 后端自动设置为空对象
credentials: credentials || '{}'
```

### 2. 二维码不显示怎么办？

检查步骤:
1. 确认账户已分配 Worker: `assigned_worker_id` 不为空
2. 确认 Worker 已连接: Master 日志中有 "Worker registered"
3. 确认 Socket.IO 事件正常: 浏览器控制台查看 WebSocket 连接
4. 确认 Worker 浏览器启动成功: Worker 日志中有 "Browser launched"
5. 检查 Worker 端的二维码截图逻辑

### 3. 登录成功后 credentials 为空？

这是因为当前实现中 Worker 没有将 cookies 发送给 Master。

**解决方法**: 修改代码将 cookies 上传

参见本文档 "步骤 12-13" 部分的实现。

### 4. 二维码过期怎么办？

自动处理:
- 二维码有效期: 5分钟
- Master 定时清理过期会话
- 前端显示过期提示
- 用户需要重新点击"登录"按钮

## 📝 开发建议

### 前端优化

1. **自动刷新二维码**: 快过期时自动请求刷新
2. **多窗口支持**: 允许同时为多个账户登录
3. **登录历史**: 显示账户的登录历史记录
4. **错误重试**: 登录失败后提供重试按钮

### 后端优化

1. **Cookies 同步**: Worker 登录成功后自动上传 cookies
2. **会话清理**: 定时清理过期的登录会话
3. **并发控制**: 限制同时登录的账户数量
4. **日志记录**: 详细记录登录流程的每个步骤

### Worker 优化

1. **二维码刷新**: 快过期时自动刷新二维码
2. **登录检测**: 更可靠的登录成功检测逻辑
3. **错误处理**: 详细的错误分类和处理
4. **资源清理**: 登录完成后及时清理页面资源

## 🔗 相关文件

- 前端页面: [AccountsPage.js](../packages/admin-web/src/pages/AccountsPage.js)
- Socket Context: [socketContext.js](../packages/admin-web/src/services/socketContext.js)
- QR 码组件: [QRCodeModal.js](../packages/admin-web/src/components/QRCodeModal.js)
- Master 登录处理: [login-handler.js](../packages/master/src/login/login-handler.js)
- Worker 登录处理: [douyin-login-handler.js](../packages/worker/src/browser/douyin-login-handler.js)
- Admin Namespace: [admin-namespace.js](../packages/master/src/socket/admin-namespace.js)
- 账户 API: [accounts.js](../packages/master/src/api/routes/accounts.js)

## 📚 延伸阅读

- [数据库字典](数据库字典.md)
- [多Browser架构详解](architecture/多Browser架构详解.md)
- [CLAUDE.md](../CLAUDE.md) - 项目开发指南
