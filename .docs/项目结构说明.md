# HisCRM-IM 项目结构说明

## 📁 完整的项目目录结构

```
HisCRM-IM/
│
├── packages/                           # 主应用模块
│   │
│   ├── shared/                         # 📦 共享库 (所有模块共用)
│   │   ├── config/
│   │   │   └── paths.js               # ⭐ 统一路径配置 (三层优先级)
│   │   ├── utils/
│   │   │   ├── logger.js              # Winston 日志工厂
│   │   │   ├── error-handler.js
│   │   │   ├── request-id.js
│   │   │   ├── validator.js
│   │   │   ├── retry-strategy.js
│   │   │   └── time-parser.js
│   │   ├── protocol/
│   │   │   ├── messages.js            # Socket.IO 消息定义
│   │   │   └── events.js              # Socket.IO 事件定义
│   │   ├── models/
│   │   │   ├── Account.js             # 账户模型
│   │   │   └── Worker.js              # Worker 模型
│   │   └── package.json
│   │
│   ├── master/                         # 🔧 Master 服务器 (Port 3000)
│   │   ├── src/
│   │   │   ├── index.js               # 入口点，初始化所有服务
│   │   │   ├── api/routes/
│   │   │   │   ├── platforms.js      # 平台 API (动态加载)
│   │   │   │   └── replies.js        # 回复 API
│   │   │   ├── communication/
│   │   │   │   └── socket-server.js  # Socket.IO 服务器
│   │   │   ├── database/
│   │   │   │   ├── init.js           # 数据库初始化
│   │   │   │   ├── migrations/
│   │   │   │   │   └── 015_add_replies_table.sql
│   │   │   │   ├── reply-dao.js      # 回复数据访问
│   │   │   │   └── ...
│   │   │   ├── worker_manager/       # Worker 生命周期管理
│   │   │   ├── scheduler/            # 任务调度
│   │   │   ├── monitor/              # 心跳监控
│   │   │   └── login/                # 登录协调
│   │   ├── data/
│   │   │   └── master.db            # SQLite 数据库
│   │   ├── logs/                     # 日志目录
│   │   └── package.json
│   │
│   ├── worker/                         # 🤖 Worker 爬虫 (Port 4001)
│   │   ├── src/
│   │   │   ├── index.js               # 入口点，连接到 Master
│   │   │   ├── platform-manager.js   # 平台管理器 (动态加载)
│   │   │   ├── browser/
│   │   │   │   └── browser-manager-v2.js # 多浏览器管理
│   │   │   ├── handlers/
│   │   │   │   ├── task-runner.js    # 任务执行
│   │   │   │   ├── monitor-task.js   # 监控任务
│   │   │   │   └── reply-executor.js # 回复执行
│   │   │   ├── communication/        # Socket 客户端
│   │   │   ├── platforms/            # 平台实现 (动态加载)
│   │   │   │   ├── base/
│   │   │   │   │   └── platform-base.js      # 基类
│   │   │   │   ├── douyin/
│   │   │   │   │   ├── config.json
│   │   │   │   │   └── platform.js
│   │   │   │   └── xiaohongshu/
│   │   │   │       ├── config.json
│   │   │   │       └── platform.js
│   │   │   └── ...
│   │   ├── data/browser/             # 浏览器数据 (per-worker)
│   │   ├── logs/                     # 日志目录
│   │   └── package.json
│   │
│   ├── admin-web/                      # 🎨 Admin Web (Port 3001)
│   │   ├── src/
│   │   │   ├── pages/
│   │   │   │   ├── AccountsPage.js    # 账户管理
│   │   │   │   ├── AccountStatusPage.js
│   │   │   │   ├── LoginPage.js
│   │   │   │   └── ...
│   │   │   ├── components/
│   │   │   └── services/
│   │   ├── public/
│   │   └── package.json
│   │
│   ├── desktop-client/                 # 🖥️ Desktop Client (Electron)
│   │   └── ...
│   │
│   ├── mobile-client/                  # 📱 Mobile Client (React Native)
│   │   └── ...
│   │
│   └── config/                         # ⚙️ 配置管理模块 (新增)
│       ├── package.json
│       ├── index.js                    # 配置加载函数
│       ├── .env.example               # 环境变量模板
│       ├── .gitignore
│       ├── README.md
│       ├── config/
│       │   ├── config.dev.json        # 开发配置
│       │   └── config.prod.json       # 生产配置
│       └── scripts/
│           └── setup.js               # 交互式配置脚本
│
├── .docs/                              # 📚 文档目录
│   ├── 00-系统文档总索引.md
│   ├── 01-ADMIN-WEB-系统文档.md
│   ├── 02-MASTER-系统文档.md
│   ├── 03-WORKER-系统文档-第一部分.md
│   ├── 04-WORKER-系统文档-第二部分.md
│   ├── 05-WORKER-平台扩展指南.md
│   ├── 06-DOUYIN-平台实现技术细节.md
│   ├── 07-WORKER-爬虫调试指南.md
│   ├── 08-REPLY-回复功能设计文档.md
│   ├── 09-REPLY-实现进展总结.md
│   ├── 10-REPLY-平台实现快速开始.md
│   ├── 11-REPLY-平台接口框架完成.md
│   ├── 12-多平台动态配置实现.md
│   ├── 13-多平台动态配置修复.md
│   ├── 14-平台加载调试指南.md
│   ├── 15-共享路径配置系统.md
│   ├── 16-shared-库架构说明.md
│   ├── 17-部署指南-环境配置系统.md
│   ├── 快速参考-系统文档.md
│   ├── README.md
│   └── _archived/                      # 历史文档 (46 个)
│
├── .env.example                        # ❌ 已移到 packages/config
├── config.example.json                 # ❌ 已移到 packages/config
├── setup-env.sh                        # ❌ 已移到 packages/config/scripts
├── setup-env.bat                       # ❌ 已移到 packages/config/scripts
│
├── DEPLOYMENT.md                       # 🚀 部署快速开始
├── CONFIG_SYSTEM_SUMMARY.md            # ⚙️ 配置系统总结
├── IMPLEMENTATION_SUMMARY.md           # 📋 实现总结
├── CLAUDE.md                           # 📖 项目指导
├── README.md                           # 📚 项目说明
├── package.json                        # npm 主配置
├── .gitignore
└── ...
```

---

## 🎯 关键模块说明

### 1. @hiscrm-im/shared (共享库)

**位置**: `packages/shared/`

**主要子模块**:
- `config/paths.js` - 统一路径配置 (三层优先级系统)
- `utils/` - 工具函数库
- `protocol/` - 通信协议定义
- `models/` - 数据模型

**用途**: Master、Worker 和所有客户端都使用的共享代码

---

### 2. @hiscrm-im/config (配置管理) ⭐ 新增

**位置**: `packages/config/`

**主要内容**:
- `scripts/setup.js` - 交互式配置生成脚本
- `config/*.json` - 环境配置示例
- `.env.example` - 环境变量模板

**用途**: 统一管理所有配置文件和生成工具

**使用**:
```bash
cd packages/config
node scripts/setup.js  # 一键生成配置
```

---

### 3. packages/master (后端服务)

**位置**: `packages/master/`

**主要功能**:
- Socket.IO 服务器 (协调 Master/Worker/Client 通信)
- HTTP API (提供给 Admin Web)
- 数据库管理 (SQLite)
- Worker 生命周期管理
- 登录流程协调
- 任务调度

**关键文件**:
- `api/routes/platforms.js` - 动态平台 API
- `database/reply-dao.js` - 回复数据访问
- `communication/socket-server.js` - Socket 服务

---

### 4. packages/worker (爬虫进程)

**位置**: `packages/worker/`

**主要功能**:
- 浏览器自动化 (Playwright)
- 平台脚本执行
- 账户监控
- 数据爬取和处理

**关键文件**:
- `platform-manager.js` - 平台动态加载
- `handlers/task-runner.js` - 任务执行
- `handlers/reply-executor.js` - 回复执行
- `platforms/*/platform.js` - 具体平台实现

**平台**:
- douyin/ (抖音)
- xiaohongshu/ (小红书)
- ... (可扩展)

---

### 5. packages/admin-web (前端管理)

**位置**: `packages/admin-web/`

**主要功能**:
- 账户管理界面
- Worker 管理界面
- 登录流程 UI
- 数据可视化

**关键页面**:
- AccountsPage.js - 账户列表 (从 Master API 动态加载平台)
- AccountStatusPage.js - 账户状态 (实时更新)
- LoginPage.js - 二维码登录

---

## 🔄 三层配置系统

### 配置来源

```
优先级 1️⃣ (最高): 环境变量
- APP_ROOT
- CONFIG_FILE
- WORKER_ID
- ...

优先级 2️⃣ (中): config.json 文件
- packages/config/config.json
- 或自定义位置

优先级 3️⃣ (最低): 代码默认值
- packages/shared/config/paths.js
```

### 路径解析流程

```
PATHS.worker.platforms
    ↓
检查环境变量 WORKER_PLATFORMS_PATH
    ↓ (不存在)
检查 config.json paths.worker.platforms
    ↓ (不存在)
使用默认值 packages/worker/src/platforms
```

---

## 📊 模块依赖关系

```
┌─────────────────────────────────────┐
│      @hiscrm-im/shared             │
│ (共享库：路径、日志、协议、模型)      │
└─────────────┬───────────────────────┘
              │
    ┌─────────┼─────────────┬─────────┐
    ▼         ▼             ▼         ▼
  Master   Worker      AdminWeb   Desktop
   (后端)   (爬虫)      (前端)    (桌面)
```

---

## 🚀 快速启动

### 开发环境

```bash
# 无需配置，直接开发
npm run dev

# 或分别启动
npm run start:master
npm run start:worker
npm run start:admin
```

### 生产环境

```bash
# 1. 生成配置
cd packages/config
npm run setup:prod

# 2. 启动应用
npm run start:master
npm run start:worker
```

### Docker 环境

```bash
docker-compose up -d
# 使用环境变量自动配置
```

---

## 📁 文件放置原则

### ✅ 应该放在 packages/ 下的

- **应用代码** - Master、Worker、Admin 等
- **共享代码** - shared 库
- **配置管理** - config 模块
- **独立工具** - 工具包

### ✅ 应该放在根目录的

- **项目配置** - package.json、.gitignore 等
- **文档** - README、部署指南等
- **CI/CD** - .github/workflows 等

### ❌ 不应该提交 git

- **配置文件** - .env、config.json (放 .gitignore)
- **数据目录** - data/、logs/
- **依赖包** - node_modules/
- **构建输出** - dist/、build/

---

## 🎓 学习路径

1. **理解总体架构**
   - 读: README.md
   - 读: CLAUDE.md
   - 读: .docs/00-系统文档总索引.md

2. **配置和部署**
   - 读: DEPLOYMENT.md
   - 读: .docs/17-部署指南-环境配置系统.md
   - 做: 运行 packages/config/scripts/setup.js

3. **深入各模块**
   - Master: .docs/02-MASTER-系统文档.md
   - Worker: .docs/03-WORKER-系统文档-第一部分.md
   - Admin: .docs/01-ADMIN-WEB-系统文档.md
   - Shared: .docs/16-shared-库架构说明.md

4. **学习新平台开发**
   - 读: .docs/05-WORKER-平台扩展指南.md
   - 参考: .docs/06-DOUYIN-平台实现技术细节.md

5. **理解特定功能**
   - 回复功能: .docs/08-REPLY-回复功能设计文档.md
   - 多平台: .docs/12-多平台动态配置实现.md
   - 调试: .docs/07-WORKER-爬虫调试指南.md

---

## ✨ 关键改进点

### 配置管理优化

```
修改前: 配置文件散落各处
  ├── 项目根目录: config.example.json
  ├── 项目根目录: .env.example
  └── packages/shared: paths.js (硬编码)

修改后: 统一在 packages/config
  ├── packages/config/.env.example
  ├── packages/config/config/*.json
  ├── packages/config/scripts/setup.js
  └── packages/shared/config/paths.js (三层优先级)
```

### 结构清晰性

✅ 所有 npm 包都在 packages/ 下
✅ 配置和脚本统一管理
✅ 文档集中在 .docs/ 下
✅ 根目录只有项目级配置

---

## 📚 相关文档

- [packages/config/README.md](packages/config/README.md) - 配置模块说明
- [DEPLOYMENT.md](DEPLOYMENT.md) - 部署快速开始
- [.docs/README.md](.docs/README.md) - 文档导航
- [CLAUDE.md](CLAUDE.md) - 项目指导

---

**完成日期**: 2025-10-20
**版本**: 2.5.0
**改进**: 统一配置管理，清晰的项目结构

🎯 **现在项目结构更加清晰、配置管理更加规范！**
