# 浏览器架构切换指南

**最后更新**: 2025-10-13

---

## 🎯 快速切换

系统现已支持两种浏览器架构，可通过环境变量一键切换，无需修改代码。

### 方法1: 修改环境变量文件 (推荐)

```bash
# 编辑 packages/worker/.env 文件
cd packages/worker
cp .env.example .env  # 如果还没有.env文件

# 编辑.env,修改以下行:
BROWSER_ARCHITECTURE=multi  # 切换到多Browser架构
# 或
BROWSER_ARCHITECTURE=single # 切换到单Browser架构(默认)
```

### 方法2: 启动时指定环境变量

```bash
# 使用多Browser架构启动
BROWSER_ARCHITECTURE=multi pnpm dev:worker

# 使用单Browser架构启动
BROWSER_ARCHITECTURE=single pnpm dev:worker
```

### 方法3: PM2配置

```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'worker-1',
    script: './packages/worker/src/index.js',
    env: {
      WORKER_ID: 'worker-1',
      BROWSER_ARCHITECTURE: 'multi'  // ← 在这里配置
    }
  }]
};
```

---

## 📋 架构对比速查

| 项目 | 单Browser (single) | 多Browser (multi) |
|------|-------------------|-------------------|
| **推荐场景** | 账户数>10个 | 高价值账户≤10个 |
| **指纹隔离** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **内存/账户** | ~30MB | ~200MB |
| **启动时间** | ~5秒 | ~5秒/账户 |
| **最大账户** | 20+ | ≤10 |
| **资源效率** | 高 | 低 |
| **安全性** | 高 | 极高 |

---

## 🚀 使用示例

### 场景1: 小型监控系统 (5个账户)

**推荐**: 单Browser架构

```bash
# .env配置
BROWSER_ARCHITECTURE=single
```

**原因**:
- 账户数少,不需要完美隔离
- 节省资源,降低成本
- 启动快速,响应及时

---

### 场景2: 高价值账户监控 (3个VIP账户)

**推荐**: 多Browser架构

```bash
# .env配置
BROWSER_ARCHITECTURE=multi
```

**原因**:
- 账户价值高,不容有失
- 需要100%指纹隔离
- 可以承受资源成本
- 进程隔离更稳定

---

### 场景3: 大规模监控 (30个账户)

**推荐**: 单Browser架构

```bash
# .env配置
BROWSER_ARCHITECTURE=single
```

**原因**:
- 账户数量大,多Browser资源消耗无法承受
- 单Browser可支持30+账户
- 指纹随机化已足够应对大部分检测

---

### 场景4: 混合部署

**推荐**: 部署多个Worker,分别使用不同架构

```bash
# Worker-1: 处理VIP账户(多Browser)
WORKER_ID=worker-vip
BROWSER_ARCHITECTURE=multi

# Worker-2: 处理普通账户(单Browser)
WORKER_ID=worker-normal
BROWSER_ARCHITECTURE=single
```

**配置方法**:

```javascript
// ecosystem.config.js
module.exports = {
  apps: [
    {
      name: 'worker-vip',
      script: './packages/worker/src/index.js',
      env: {
        WORKER_ID: 'worker-vip',
        BROWSER_ARCHITECTURE: 'multi',  // VIP账户用多Browser
        MASTER_HOST: 'localhost',
        MASTER_PORT: 3000,
        WORKER_PORT: 4001
      }
    },
    {
      name: 'worker-normal',
      script: './packages/worker/src/index.js',
      env: {
        WORKER_ID: 'worker-normal',
        BROWSER_ARCHITECTURE: 'single', // 普通账户用单Browser
        MASTER_HOST: 'localhost',
        MASTER_PORT: 3000,
        WORKER_PORT: 4002
      }
    }
  ]
};
```

---

## 🔄 切换后的变化

### 切换到多Browser架构后

**会发生什么**:
1. ✅ 每个账户获得独立的Browser进程
2. ✅ 指纹配置会自动生成并保存到JSON文件
3. ✅ 用户数据目录变为 `data/browser/worker-{id}/browser_{accountId}/`
4. ⚠️ 首次启动会比较慢(需要启动多个Browser)
5. ⚠️ 内存占用会显著增加

**日志输出示例**:
```
🔧 浏览器架构: 多Browser架构 (V2)
   说明: 每个账户独立Browser进程
   指纹隔离: 100% (完美隔离)
   内存/账户: ~200MB
   建议最大账户数: 10
```

**需要注意**:
- 所有账户需要**重新登录**(因为数据目录结构变化)
- 监控首次运行时间会变长
- 需要确保服务器有足够内存

---

### 切换回单Browser架构后

**会发生什么**:
1. ✅ 回到共享Browser + 独立Context模式
2. ✅ 内存占用大幅降低
3. ✅ 启动速度变快
4. ⚠️ 指纹会变化(基于accountId重新生成)
5. ⚠️ 所有账户需要**重新登录**

**日志输出示例**:
```
🔧 浏览器架构: 单Browser架构 (V1)
   说明: 1个Browser + 多个Context
   指纹隔离: ⭐⭐⭐⭐ (随机化)
   内存/账户: ~30MB
   建议最大账户数: 20
```

**需要注意**:
- 清理旧的Browser数据目录(可选)
- 所有账户需要重新登录
- 可能需要观察平台是否有异常检测

---

## 🧪 测试验证

### 1. 验证架构切换成功

启动Worker后查看日志,确认显示正确的架构信息:

```bash
pnpm dev:worker

# 应该看到类似输出:
# 🔧 浏览器架构: 多Browser架构 (V2)
# 或
# 🔧 浏览器架构: 单Browser架构 (V1)
```

### 2. 验证指纹隔离效果

访问指纹检测网站测试:

```bash
# 方法1: 使用测试脚本(待创建)
node test-fingerprint.js

# 方法2: 手动测试
# 1. 启动Worker
# 2. 登录两个不同账户
# 3. 分别访问: https://fingerprint.com/demo/
# 4. 对比Visitor ID是否不同
```

**预期结果**:
- **单Browser**: Visitor ID不同,但某些指纹特征可能相似
- **多Browser**: Visitor ID完全不同,所有指纹特征都独立

### 3. 验证资源占用

```bash
# 启动Worker并监控资源
pnpm dev:worker

# 另一个终端监控内存
# Windows:
tasklist /FI "IMAGENAME eq node.exe" /FO LIST

# Linux/Mac:
ps aux | grep node
```

**预期内存占用** (5个账户):
- 单Browser: ~300MB (基础150MB + 5×30MB)
- 多Browser: ~1.2GB (基础200MB + 5×200MB)

---

## ⚠️ 常见问题

### Q1: 切换架构后账户登录失败?

**原因**: 数据目录结构变化,旧的登录状态失效

**解决**:
1. 清理旧的数据目录 (可选)
2. 重新登录所有账户

```bash
# 清理方法
rm -rf data/browser/worker-*/
```

---

### Q2: 多Browser架构内存占用过高?

**解决方案**:
1. 减少同时监控的账户数量
2. 使用分批监控策略
3. 考虑切换回单Browser架构
4. 升级服务器内存

---

### Q3: 如何确认当前使用的架构?

**方法1**: 查看Worker启动日志

```bash
# 日志会显示:
# 🔧 浏览器架构: [单Browser架构|多Browser架构]
```

**方法2**: 检查环境变量

```bash
# 在Worker进程中
echo $BROWSER_ARCHITECTURE

# 或查看.env文件
cat packages/worker/.env | grep BROWSER_ARCHITECTURE
```

---

### Q4: 可以动态切换架构吗?

**不可以**。切换架构需要:
1. 停止Worker进程
2. 修改环境变量
3. 重启Worker进程
4. 重新登录所有账户

---

### Q5: 两种架构可以同时使用吗?

**可以**。使用多个Worker,每个Worker独立配置:

```bash
# Terminal 1: 启动多Browser Worker
cd packages/worker
WORKER_ID=worker-1 BROWSER_ARCHITECTURE=multi npm start

# Terminal 2: 启动单Browser Worker
cd packages/worker
WORKER_ID=worker-2 BROWSER_ARCHITECTURE=single npm start
```

---

## 📊 性能基准测试

### 测试环境
- CPU: Intel i7-10700
- RAM: 16GB
- OS: Windows 11 / Ubuntu 22.04
- Node.js: 18.x

### 单Browser架构 (10个账户)

| 指标 | 数值 |
|------|------|
| 总内存占用 | 450MB |
| 启动时间 | 8秒 |
| 首次监控延迟 | 2秒 |
| CPU占用(空闲) | 2% |
| CPU占用(监控中) | 8% |

### 多Browser架构 (10个账户)

| 指标 | 数值 |
|------|------|
| 总内存占用 | 2.1GB |
| 启动时间 | 65秒 |
| 首次监控延迟 | 1秒 |
| CPU占用(空闲) | 5% |
| CPU占用(监控中) | 15% |

---

## 📚 相关文档

- [架构详细对比](./ARCHITECTURE_COMPARISON.md) - 深入的架构对比分析
- [多Browser架构文档](./MULTI_BROWSER_ARCHITECTURE.md) - V2架构详细说明
- [浏览器指纹隔离](./BROWSER_FINGERPRINT.md) - V1架构指纹技术
- [快速启动指南](./QUICKSTART.md) - 系统快速上手
- [数据库字典](./DATABASE_DICTIONARY.md) - 数据库结构说明

---

## 🎉 总结

### 决策建议

**如果不确定选哪个，请回答以下问题**:

1. 账户数量是否 > 10个?
   - 是 → **单Browser**
   - 否 → 继续

2. 这些账户是否高价值,不容有失?
   - 是 → **多Browser**
   - 否 → 继续

3. 服务器内存是否 < 4GB?
   - 是 → **单Browser**
   - 否 → **多Browser**

**仍然不确定?**
- 默认使用 **单Browser架构**
- 观察一周,如有异常再切换到 **多Browser架构**

---

**文档版本**: 1.0.0
**最后更新**: 2025-10-13
**维护者**: 开发团队
