# HisCrm-IM 系统完整文档总索引

**创建日期**: 2025-10-18
**版本**: 1.0.0
**状态**: ✅ 完成

---

## 📚 文档概览

本文档将 HisCrm-IM 系统分为三个核心模块，为每个模块提供完整的系统文档。

```
┌─────────────────────────────────────────────────────────┐
│           HisCrm-IM 系统文档总体结构                     │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  ┌──────────────────┐  ┌──────────────────┐             │
│  │  Admin Web       │  │  Master Server   │             │
│  │  (端口 3001)      │  │  (端口 3000)      │             │
│  │                  │  │                  │             │
│  │ 📄 01-系统文档   │  │ 📄 02-系统文档   │             │
│  └──────────────────┘  └──────────────────┘             │
│                                                           │
│            ┌──────────────────────────┐                 │
│            │   Worker (端口 4000+)    │                 │
│            │                          │                 │
│            │ 📄 03-系统文档-第一部分   │                 │
│            │ 📄 04-系统文档-第二部分   │                 │
│            └──────────────────────────┘                 │
│                                                           │
└─────────────────────────────────────────────────────────┘
```

---

## 🎯 快速导航

### 我是新手，想快速了解系统

**推荐阅读顺序**:

1. **从整体理解系统**
   - 阅读: `系统架构与核心流程.md` (现有文档)
   - 时间: 10 分钟

2. **了解三个模块的作用**
   - Admin Web: 理解管理后台的功能和页面
   - Master: 理解中央协调的流程
   - Worker: 理解浏览器自动化和爬虫

3. **跟踪一个完整的流程**
   - 账户登录流程: 从 Admin Web → Master → Worker → Browser
   - 时间: 20 分钟

---

### 我需要部署系统

**推荐阅读顺序**:

1. **Admin Web 部署**
   - 📄 [01-ADMIN-WEB-系统文档.md](#admin-web-系统文档) → 部署说明
   - 命令: `npm install && npm start`

2. **Master 部署**
   - 📄 [02-MASTER-系统文档.md](#master-系统文档) → 部署说明
   - 命令: `npm start` 或 `pm2 start ...`

3. **Worker 部署**
   - 📄 [03-WORKER-系统文档-第一部分.md](#worker-系统文档) → 核心模块
   - 📄 [04-WORKER-系统文档-第二部分.md](#worker-系统文档) → 部署运维
   - 命令: `WORKER_ID=worker-1 PORT=4000 npm start`

---

### 我需要修复某个功能

**按模块查找**:

| 功能 | 模块 | 文档位置 |
|------|------|---------|
| 登录界面、账户管理、消息查看 | Admin Web | [01-ADMIN-WEB](#admin-web-系统文档) |
| 登录会话、Worker 管理、数据库 | Master | [02-MASTER](#master-系统文档) |
| 浏览器自动化、爬虫、多Browser | Worker | [03/04-WORKER](#worker-系统文档) |

---

## 📄 文档详解

### Admin Web 系统文档

**文件**: `01-ADMIN-WEB-系统文档.md`

**内容概览**:

| 章节 | 说明 | 关键内容 |
|------|------|---------|
| 系统概述 | Admin Web 职责定位 | 技术栈、访问方式 |
| 架构设计 | 整体架构和目录结构 | React 组件层级 |
| 核心功能 | 五大功能模块 | 账户管理、登录管理、消息管理等 |
| 页面说明 | 各页面详细说明 | AccountsPage、MessageManagementPage 等 |
| Socket.IO 通信 | 实时通信机制 | 事件监听、上下文实现 |
| API 调用 | HTTP API 接口 | 账户、Worker、消息查询 API |
| 数据流 | 登录流程数据流 | Admin → Master → Worker → Browser |
| 状态管理 | 全局和局部状态 | Socket 上下文、自定义 Hooks |
| 部署说明 | 开发和生产部署 | npm start、环境变量 |

**关键页面文件**:
- `packages/admin-web/src/pages/AccountsPage.js` - 账户管理
- `packages/admin-web/src/pages/MessageManagementPage.js` - 消息管理
- `packages/admin-web/src/pages/LoginManagementPage.js` - 登录管理
- `packages/admin-web/src/services/socketContext.js` - Socket 上下文

**关键流程**:

```
用户点击登录按钮
    ↓
Admin Web 发送 Socket 事件
    ↓
Master 创建会话，转发给 Worker
    ↓
Worker 启动浏览器，提取二维码
    ↓
Admin Web 显示二维码弹窗
    ↓
用户扫码登录 (在手机上)
    ↓
Worker 检测到登录成功，保存 Cookie
    ↓
Admin Web 关闭弹窗，显示成功提示
```

---

### Master 系统文档

**文件**: `02-MASTER-系统文档.md`

**内容概览**:

| 章节 | 说明 | 关键内容 |
|------|------|---------|
| 系统概述 | Master 职责定位 | 中央协调器、核心流程 |
| 架构设计 | 内部架构和目录结构 | Socket 服务器、业务逻辑层 |
| 核心模块 | 五个核心模块详解 | WorkerManager、LoginHandler、TaskScheduler 等 |
| 数据库设计 | 完整数据库表结构 | accounts、workers、login_sessions 等 8 个表 |
| Socket.IO 通信 | 三个命名空间 | /worker、/admin、/client |
| HTTP API | 完整 API 端点列表 | 账户、Worker、消息、通知 API |
| 业务流程 | 四个核心流程 | Worker 注册、账户登录、任务调度、离线处理 |
| 部署说明 | 开发和生产部署 | npm start、PM2、环境变量 |

**核心数据库表**:

```
accounts              - 社交媒体账户
workers               - Worker 节点
login_sessions        - 登录会话 (临时)
comments              - 爬取的评论
direct_messages       - 爬取的私信
notifications         - 通知队列
worker_configs        - Worker 配置
worker_runtime        - Worker 运行状态
```

**三个命名空间通信**:

```
/worker
  ├── Worker 注册
  ├── 心跳上报
  ├── 二维码发送
  ├── 登录状态更新
  └── 监控数据上报

/admin
  ├── 启动登录请求
  ├── 二维码准备完毕
  ├── 登录成功/失败通知
  └── 实时消息推送

/client
  └── 桌面/移动客户端通知
```

---

### Worker 系统文档

**文件**:
- `03-WORKER-系统文档-第一部分.md`
- `04-WORKER-系统文档-第二部分.md`

**第一部分内容**:

| 章节 | 说明 | 关键内容 |
|------|------|---------|
| 系统概述 | Worker 职责定位 | 浏览器自动化、爬虫、隔离 |
| 架构设计 | 内部架构和目录结构 | Socket 客户端、平台管理 |
| 核心模块 | 五个核心模块 | 入口、Socket 客户端、注册、心跳、事件监听 |
| 多Browser架构 | 关键设计 | 每账户一个 Browser 进程 |
| 平台系统 | 动态加载平台 | PlatformManager、PlatformBase、DouyinPlatform |

**第二部分内容**:

| 章节 | 说明 | 关键内容 |
|------|------|---------|
| 任务管理 | MonitorTask 执行 | 随机间隔、递归调度 |
| Socket.IO 通信 | 消息协议详解 | 14 个事件详细说明 |
| 数据存储 | 文件结构和格式 | 指纹、Cookie、上下文、截图 |
| 错误处理 | 错误分类和重试 | 网络错误、超时、重试机制 |
| 部署运维 | 启动和监控 | PM2、日志、监控指标 |

**多Browser架构原理**:

```
每个账户 = 1 个独立 Browser 进程

Browser 1 (Account A)          Browser 2 (Account B)
├── Chromium 进程              ├── Chromium 进程
├── data/browser_A/            ├── data/browser_B/
│   ├── 指纹: fp_A.json        │   ├── 指纹: fp_B.json
│   └── Cookie: cookie_A.json  │   └── Cookie: cookie_B.json
└── 完全隔离                    └── 完全隔离

优势: 100% 指纹隔离，无关联风险
劣势: 每个 Browser ~200MB 内存，建议最多 10 个账户/Worker
```

**平台系统架构**:

```
PlatformManager (平台管理器)
├── 自动加载平台脚本
├── 管理平台实例
└── 获取支持的平台列表

PlatformBase (平台基类)
├── 通用接口定义
├── 登录、爬虫、通知方法
└── 公共工具方法

DouyinPlatform (具体实现)
├── 二维码登录
├── 评论爬虫
└── 私信爬虫

XiaohongshuPlatform (可扩展)
├── 二维码登录
├── 评论爬虫
└── 私信爬虫
```

---

## 🔄 通信流程图

### 完整的账户登录流程

```
Admin Web (3001)
    │
    │ 1. 用户点击【登录】
    │
    ├──→ Socket: master:login:start
    │    {account_id, worker_id}
    │
Master (3000)
    │
    │ 2. 创建 login_sessions 记录
    │ 3. 查询 Worker 代理配置
    │
    ├──→ Socket: master:login:start
    │    {account_id, session_id, platform, proxy}
    │
Worker (4000+)
    │
    │ 4. 获取账户专属 Browser
    │ 5. 加载指纹和 Cookie
    │ 6. 导航到登录页
    │ 7. 等待二维码加载
    │ 8. 提取二维码 (Base64)
    │
    ├──→ Socket: worker:login:qrcode
    │    {session_id, qr_code_data}
    │
Master (3000)
    │
    │ 9. 更新 login_sessions (status: scanning)
    │
    ├──→ Socket: login:qrcode:ready
    │    {session_id, qr_code_data, expires_at}
    │
Admin Web (3001)
    │
    │ 10. 显示二维码弹窗
    │ 11. 倒计时 5 分钟
    │ 12. 用户使用手机扫码登录
    │
Worker (4000+)
    │
    │ 13. 轮询登录状态
    │ 14. 检测到登录成功
    │ 15. 提取 cookies + user_info
    │ 16. 保存到本地文件
    │
    ├──→ Socket: worker:login:status
    │    {session_id, status: success, cookies, user_info, fingerprint}
    │
Master (3000)
    │
    │ 17. 更新 accounts 表
    │    - login_status: logged_in
    │    - credentials: cookies
    │    - user_info: 用户信息
    │    - cookies_valid_until: 7 天后
    │
    ├──→ Socket: login:success
    │    {session_id, account_id, user_info}
    │
Admin Web (3001)
    │
    │ 18. 关闭二维码弹窗
    │ 19. 显示成功提示
    │ 20. 刷新账户列表
    │
完成 ✅
```

---

## 📊 系统通信总览

```
┌─────────────┐
│  Admin Web  │ (React 3001)
└──────┬──────┘
       │ Socket.IO /admin
       │ HTTP REST API
       │
┌──────▼──────┐
│   Master    │ (Node.js 3000)
└──────┬──────┘
       │ Socket.IO /worker
       │ HTTP REST API
       │
   ┌───┴────┬────────┐
   │        │        │
┌──▼──┐ ┌──▼──┐ ┌──▼──┐
│ W1  │ │ W2  │ │ W3  │ (Node.js 4000+)
└─────┘ └─────┘ └─────┘

每个 Worker 管理多个 Browser:
  W1 → Browser(Account A) + Browser(Account B)
  W2 → Browser(Account C) + Browser(Account D)
  W3 → Browser(Account E) + Browser(Account F)
```

---

## 🚀 快速启动清单

### 第一步: 安装依赖

```bash
# 根目录
npm install

# 或 pnpm
pnpm install
```

### 第二步: 启动 Master

```bash
cd packages/master
npm start
# 或 pm2
pm2 start src/index.js --name "hiscrm-master"
```

### 第三步: 启动 Worker

```bash
cd packages/worker
WORKER_ID=worker-1 PORT=4000 npm start

# 多个 Worker
WORKER_ID=worker-2 PORT=4001 npm start &
WORKER_ID=worker-3 PORT=4002 npm start &
```

### 第四步: 启动 Admin Web

```bash
cd packages/admin-web
npm start
# 访问 http://localhost:3001
```

### 验证系统正常运行

```bash
# 1. 检查 Master 是否运行
curl http://localhost:3000/health

# 2. 检查 Admin Web 是否运行
curl http://localhost:3001

# 3. 检查数据库是否初始化
ls -la packages/master/data/master.db

# 4. 查看 Master 日志
tail -f packages/master/logs/master.log

# 5. 查看 Worker 日志
tail -f packages/worker/logs/worker.log
```

---

## 💡 核心概念速查

| 概念 | 说明 | 相关文档 |
|------|------|---------|
| **账户隔离** | 每个账户独立 Browser 进程，完全隔离 | Worker 第一部分 |
| **指纹隔离** | 随机生成并持久化浏览器指纹 | Worker 第二部分 |
| **二维码登录** | 通过 Worker 自动化提取二维码 | Master |
| **任务调度** | Master 定期分配监控任务给 Worker | Master |
| **心跳监控** | Worker 每 10 秒发送心跳，Master 检查离线 | Master |
| **平台系统** | 动态加载平台脚本支持多平台 | Worker 第一部分 |
| **多 Worker** | 支持多个 Worker 节点并行运行 | Master、Worker |
| **代理支持** | 支持 HTTP/HTTPS/Socks5 代理 | Worker 第二部分 |

---

## 📞 常见问题速查

| 问题 | 位置 | 解决方案 |
|------|------|---------|
| 如何添加新账户？ | Admin Web 文档 | 账户管理页面 |
| 如何启动登录？ | Admin Web + Master 文档 | 点击【登录】按钮 |
| 如何查看消息？ | Admin Web 文档 | 消息管理页面 |
| 如何添加 Worker？ | Worker + Master 文档 | 启动新 Worker 进程 |
| 如何配置代理？ | Admin Web + Worker 文档 | 代理管理页面 |
| 如何查看日志？ | 各文档部署说明 | tail -f logs/ |
| 如何扩展平台？ | Worker 第一部分 | 创建新的 Platform 类 |
| 如何性能优化？ | Worker 第二部分 | 减少内存占用、限制并发 |

---

## 📝 文档维护计划

| 任务 | 频率 | 负责人 |
|------|------|--------|
| 更新 API 文档 | 每次 API 变更后 | 后端开发 |
| 更新流程图 | 每次架构变更后 | 架构设计 |
| 更新部署说明 | 每次升级后 | 运维 |
| 更新常见问题 | 每周 | 技术支持 |

---

## 🎓 学习路径建议

### 初级 (1-2 天)
- [ ] 阅读系统架构概览
- [ ] 理解三个模块的作用
- [ ] 跟踪一个完整的登录流程
- [ ] 在本地成功部署系统

### 中级 (3-5 天)
- [ ] 研究 Admin Web 前端代码
- [ ] 研究 Master 数据库设计
- [ ] 研究 Worker 多 Browser 架构
- [ ] 修复一个简单的 Bug

### 高级 (1-2 周)
- [ ] 深入理解 Socket.IO 通信机制
- [ ] 深入理解 Playwright 浏览器自动化
- [ ] 添加一个新的平台支持
- [ ] 优化系统性能

---

## 📚 相关资源

### 技术文档
- [React 18 官方文档](https://react.dev)
- [Socket.IO 官方文档](https://socket.io/docs)
- [Playwright 官方文档](https://playwright.dev)
- [SQLite 官方文档](https://www.sqlite.org/docs.html)
- [Ant Design 官方文档](https://ant.design)

### 项目文档
- [CLAUDE.md](../CLAUDE.md) - 开发指南
- [系统架构与核心流程.md](./系统架构与核心流程.md) - 架构文档
- [Master 端设计方案.md](./Master端设计方案.md) - Master 设计

---

## 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| 1.0.0 | 2025-10-18 | 初版发布 |

---

**最后更新**: 2025-10-18
**维护者**: 开发团队
**状态**: ✅ 完整
