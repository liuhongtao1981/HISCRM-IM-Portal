# 平台加载调试指南

## 问题现象

下拉列表只显示抖音，不显示小红书。

## 调试步骤

### 1. 启动 Master 并查看日志

```bash
cd packages/master
npm start
```

查看控制台输出，应该会看到类似的日志：

```
[platform-manager] ✓ Loaded platform: 抖音 (douyin) ...
[platform-manager] ✓ Loaded platform: 小红书 (xiaohongshu) ...
```

### 2. 调用 API 端点进行测试

打开另一个终端，执行：

```bash
curl http://localhost:3000/api/v1/platforms
```

### 3. 查看完整的日志输出

在启动 Master 的终端中，应该会看到详细的调试日志：

```
[platforms-api] Step 1: Fetching platforms from database accounts
[platforms-api] Found 0 platforms from database accounts

[platforms-api] Step 2: Fetching platforms from Worker registry
[platforms-api] Found 0 workers

[platforms-api] Step 3: Scanning filesystem for platforms
[platform-manager] Scanning platforms directory: /path/to/packages/worker/src/platforms
[platform-manager] Found 3 entries in platforms directory
[platform-manager] Checking entry: base (isDirectory: true)
[platform-manager]   -> Skipping base
[platform-manager] Checking entry: douyin (isDirectory: true)
[platform-manager]   -> Looking for config at: /path/to/.../douyin/config.json
[platform-manager]   -> Found platform: douyin (抖音)
[platform-manager] Checking entry: xiaohongshu (isDirectory: true)
[platform-manager]   -> Looking for config at: /path/to/.../xiaohongshu/config.json
[platform-manager]   -> Found platform: xiaohongshu (小红书)
[platform-manager] Scanned 2 platforms from filesystem

[platforms-api] Found 2 platforms
```

## 期望的最终响应

```json
{
  "success": true,
  "data": [
    {
      "value": "douyin",
      "label": "抖音",
      "enabled": true,
      "source": "filesystem"
    },
    {
      "value": "xiaohongshu",
      "label": "小红书",
      "enabled": true,
      "source": "filesystem"
    }
  ],
  "total": 2
}
```

## 如果只显示一个平台，检查清单

### ✓ 检查 1：文件系统扫描是否正常

查看日志中 "Step 3" 的输出：
- [ ] 是否看到 "Scanning platforms directory"？
- [ ] 是否看到正确的目录路径？
- [ ] 是否看到了 3 个条目 (base, douyin, xiaohongshu)？

**如果没有**: 路径计算可能有问题

### ✓ 检查 2：config.json 是否存在

```bash
# 验证文件存在
ls packages/worker/src/platforms/douyin/config.json
ls packages/worker/src/platforms/xiaohongshu/config.json
```

### ✓ 检查 3：config.json 是否有效

```bash
# 查看文件内容
cat packages/worker/src/platforms/douyin/config.json
cat packages/worker/src/platforms/xiaohongshu/config.json
```

确保：
- [ ] JSON 格式正确（使用 `jq` 验证：`jq . packages/worker/src/platforms/douyin/config.json`）
- [ ] 包含 `"platform"` 字段
- [ ] 包含 `"displayName"` 字段
- [ ] 包含 `"enabled"` 字段（应该是 true）

## 常见问题排查

### 问题 1：找不到平台目录

**症状**：日志中看到 "Worker platforms directory not found at: ..."

**原因**：路径计算错误

**解决**：
1. 检查项目结构是否正确
2. 确保 `packages/worker/src/platforms/` 目录存在
3. 检查 Master 启动位置是否正确

### 问题 2：找到目录但找不到平台

**症状**：日志中看到 "Found 0 platforms from filesystem"

**原因**：
- config.json 不存在或损坏
- config.json 格式错误
- 平台目录名称拼写错误

**解决**：
1. 验证每个平台目录中都有 config.json
2. 使用 JSON 验证工具检查格式
3. 查看日志中的 "Looking for config at" 路径

### 问题 3：config.json 格式错误

**症状**：日志中看到 "Failed to parse config for platform xiaohongshu"

**原因**：JSON 语法错误

**解决**：
```bash
# 使用 jq 验证
jq . packages/worker/src/platforms/xiaohongshu/config.json
# 如果输出错误，说明 JSON 格式有问题
```

## 修复步骤

如果上述检查发现问题，按以下步骤修复：

### Step 1: 验证目录结构

```bash
find packages/worker/src/platforms -type f -name "config.json"
```

应该输出：
```
packages/worker/src/platforms/douyin/config.json
packages/worker/src/platforms/xiaohongshu/config.json
```

### Step 2: 验证 config.json 内容

```bash
jq '.platform, .displayName' packages/worker/src/platforms/xiaohongshu/config.json
```

应该输出：
```
"xiaohongshu"
"小红书"
```

### Step 3: 重启 Master

```bash
# Kill 现有进程
pkill -f "npm start" || true

# 重启
cd packages/master
npm start
```

### Step 4: 再次测试 API

```bash
curl http://localhost:3000/api/v1/platforms
```

## 调试技巧

### 启用更详细的日志

在 `platforms.js` 中将 `logger.debug` 改为 `logger.info`：

```javascript
logger.info('Step 1: Fetching platforms from database accounts');  // 改为 info
```

### 添加临时调试代码

在 API 端点中添加临时输出：

```javascript
const platforms = Array.from(platformsSet.values()).sort(...);
console.log('=== PLATFORMS ===');
console.log(JSON.stringify(platforms, null, 2));
console.log('==================');
```

### 使用浏览器开发者工具

1. 打开 Admin Web: http://localhost:3001
2. 打开开发者工具 (F12)
3. 查看 Network 标签
4. 刷新页面
5. 查看 `/api/v1/platforms` 的请求和响应

---

**诊断日期**: 2025-10-20
**问题**: 小红书平台未显示
**状态**: 已添加详细调试日志，准备排查
