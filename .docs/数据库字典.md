# 数据库字典 - HisCrm-IM 社交媒体监控系统

**版本**: 1.0.0
**数据库类型**: SQLite 3.x
**ORM**: 无 (直接使用 better-sqlite3)
**最后更新**: 2025-10-13

---

## 📚 目录

- [数据库架构概览](#数据库架构概览)
- [浏览器实例架构](#浏览器实例架构)
- [主控数据库 (master.db)](#主控数据库-masterdb)
- [Worker数据库 (worker_{id}.db)](#worker数据库-worker_iddb)
- [数据关系图](#数据关系图)
- [常用查询示例](#常用查询示例)

---

## 数据库架构概览

### 系统架构分布

```
HisCrm-IM 系统
├── Master (主控服务)
│   └── data/master.db              # 主控数据库
│       ├── accounts                # 7张表
│       ├── comments
│       ├── direct_messages
│       ├── notifications
│       ├── workers
│       ├── client_sessions
│       └── notification_rules
│
└── Worker (监控进程)
    ├── Worker-1 进程
    │   ├── Browser实例 (Chromium)
    │   │   ├── Context-1 (account-123)  ← 独立的浏览器上下文
    │   │   ├── Context-2 (account-456)
    │   │   └── Context-3 (account-789)
    │   │
    │   └── data/browser/worker-1/
    │       ├── account-123_state.json  # Context-1的登录状态
    │       ├── account-456_state.json  # Context-2的登录状态
    │       ├── account-789_state.json  # Context-3的登录状态
    │       └── worker_1.db             # Worker-1本地数据库 (2张表)
    │           ├── monitor_tasks
    │           └── crawl_cache
    │
    ├── Worker-2 进程
    │   ├── Browser实例
    │   │   ├── Context (account-101)
    │   │   └── Context (account-202)
    │   │
    │   └── data/browser/worker-2/
    │       ├── account-101_state.json
    │       ├── account-202_state.json
    │       └── worker_2.db
    │
    └── Worker-3 进程
        ├── Browser实例
        │   └── Context (account-303)
        │
        └── data/browser/worker-3/
            ├── account-303_state.json
            └── worker_3.db
```

---

## 浏览器实例架构

### Worker进程模型

```
Worker进程 (worker-1)
    │
    └── Browser实例 (Chromium) ← 1个Worker只有1个Browser
            │
            ├── Context-1 (account-123)  ← 独立的浏览器上下文
            │   ├── Cookies
            │   ├── LocalStorage
            │   ├── SessionStorage
            │   └── Storage State → account-123_state.json
            │
            ├── Context-2 (account-456)  ← 独立的浏览器上下文
            │   ├── Cookies
            │   ├── LocalStorage
            │   ├── SessionStorage
            │   └── Storage State → account-456_state.json
            │
            └── Context-3 (account-789)  ← 独立的浏览器上下文
                ├── Cookies
                ├── LocalStorage
                ├── SessionStorage
                └── Storage State → account-789_state.json
```

### 关键特性

| 层级 | 说明 | 数量关系 |
|------|------|---------|
| **Worker进程** | Node.js进程 | 系统中有多个Worker |
| **Browser实例** | Playwright Chromium实例 | 1个Worker = 1个Browser |
| **BrowserContext** | 隔离的浏览器上下文 | 1个Browser = 多个Context |
| **Storage State** | 持久化的登录状态 | 1个Context = 1个State文件 |

### 数据隔离层次

1. **Worker级隔离**: 每个Worker独立数据目录 `data/browser/worker-{id}/`
2. **Context级隔离**: 每个账户独立BrowserContext (Cookies、Storage完全隔离)
3. **Storage级隔离**: 每个账户独立State文件 `{accountId}_state.json`
4. **Database级隔离**: 每个Worker独立SQLite数据库 `worker_{id}.db`

### 性能优势

| 维度 | 传统方案 | 当前方案 | 优势 |
|------|---------|---------|------|
| Browser启动 | 每账户1个Browser | 每Worker1个Browser | 启动快10倍+ |
| 内存占用 | 10账户 ≈ 2GB | 10账户 ≈ 300MB | 节省85%内存 |
| Context创建 | N/A | <100ms | 轻量级 |
| 并发处理 | 进程间切换 | Context并行 | 高效 |

### 代码实现

```javascript
// packages/worker/src/index.js
browserManager = new BrowserManager(WORKER_ID, {
  headless: true,
  dataDir: `./data/browser/${WORKER_ID}`  // Worker级隔离
});

// packages/worker/src/browser/browser-manager.js
// 启动Browser (每个Worker只启动一次)
const browser = await chromium.launch();

// 为每个账户创建独立的Context
const context = await browser.newContext({
  storageState: `${dataDir}/${accountId}_state.json`,  // Context级隔离
  viewport: { width: 1920, height: 1080 },
  userAgent: '...',
  // 可选: 每个Context可以有独立的代理
  proxy: { server: 'http://proxy.com:8080' }
});

// Context管理 (accountId -> context映射)
this.contexts = new Map();
this.contexts.set(accountId, context);
```

---

## 主控数据库 (master.db)

**位置**: `packages/master/data/master.db`
**Schema**: `packages/master/src/database/schema.sql`

### 表结构概览

| 表名 | 记录类型 | 主要用途 |
|------|---------|---------|
| accounts | 账户信息 | 社交媒体账户配置 |
| comments | 评论数据 | 监控到的评论 |
| direct_messages | 私信数据 | 监控到的私信 |
| notifications | 通知队列 | 待推送的通知 |
| workers | Worker节点 | Worker注册和健康状态 |
| client_sessions | 客户端会话 | 客户端连接管理 |
| notification_rules | 通知规则 | 自定义过滤规则 |

详细的表结构请参考原 data-model.md 文档。

---

## Worker数据库 (worker_{id}.db)

**位置**: `packages/worker/data/browser/worker-{id}/worker_{id}.db`
**Schema**: `packages/worker/src/database/schema.sql`

### 表结构概览

| 表名 | 记录类型 | 主要用途 |
|------|---------|---------|
| monitor_tasks | 监控任务 | Worker本地任务调度 |
| crawl_cache | 抓取缓存 | 去重缓存,避免重复检测 |

### 文件组织

```
data/browser/worker-1/
├── account-123_state.json    # Context-1 Storage State (Cookies等)
├── account-456_state.json    # Context-2 Storage State
├── account-789_state.json    # Context-3 Storage State
└── worker_1.db               # Worker本地数据库
    ├── monitor_tasks         # 任务表
    └── crawl_cache          # 缓存表
```

---

## 数据关系图

### Master数据库关系

```
accounts (1) ──< (N) comments
accounts (1) ──< (N) direct_messages
accounts (1) ──< (N) notifications
accounts (N) ──> (1) workers (assigned_worker_id)
accounts (1) ──< (N) notification_rules

client_sessions (独立表,无外键)
```

### Worker数据库关系

```
monitor_tasks (引用 Master.accounts.id,但无外键约束)
crawl_cache (引用 Master.accounts.id,但无外键约束)
```

**注意**: Worker数据库不使用外键约束,通过account_id字段引用Master数据库的账户。

---

## 常用查询示例

### 1. 获取账户的未读消息统计

```sql
SELECT
  a.id,
  a.account_name,
  (SELECT COUNT(*) FROM comments WHERE account_id = a.id AND is_read = 0) AS unread_comments,
  (SELECT COUNT(*) FROM direct_messages WHERE account_id = a.id AND is_read = 0) AS unread_messages
FROM accounts a
WHERE a.status = 'active';
```

### 2. 获取Worker负载情况

```sql
SELECT
  w.id,
  w.host,
  w.assigned_accounts,
  COUNT(a.id) AS actual_accounts,
  w.status,
  (strftime('%s', 'now') - w.last_heartbeat) AS seconds_since_heartbeat
FROM workers w
LEFT JOIN accounts a ON a.assigned_worker_id = w.id
WHERE w.status = 'online'
GROUP BY w.id
ORDER BY w.assigned_accounts ASC;
```

### 3. 获取账户的历史消息 (合并评论和私信)

```sql
SELECT * FROM (
  SELECT
    id,
    'comment' AS type,
    content,
    author_name AS from_name,
    detected_at,
    created_at,
    is_read
  FROM comments
  WHERE account_id = ?

  UNION ALL

  SELECT
    id,
    'message' AS type,
    content,
    sender_name AS from_name,
    detected_at,
    created_at,
    is_read
  FROM direct_messages
  WHERE account_id = ?
)
ORDER BY detected_at DESC
LIMIT ? OFFSET ?;
```

---

## 数据保留策略

### 自动清理规则

```sql
-- 1. 历史消息 (30天)
DELETE FROM comments WHERE detected_at < (strftime('%s', 'now') - 2592000);
DELETE FROM direct_messages WHERE detected_at < (strftime('%s', 'now') - 2592000);

-- 2. 通知记录 (7天)
DELETE FROM notifications WHERE is_sent = 1 AND created_at < (strftime('%s', 'now') - 604800);

-- 3. 离线Worker (7天)
DELETE FROM workers WHERE status = 'offline' AND last_heartbeat < (strftime('%s', 'now') - 604800);

-- 4. Worker缓存 (自动过期)
DELETE FROM crawl_cache WHERE expires_at < strftime('%s', 'now');
```

---

## 性能优化

### 1. WAL模式配置

```javascript
// Master数据库
db.pragma('journal_mode = WAL');
db.pragma('synchronous = NORMAL');
db.pragma('cache_size = -64000'); // 64MB缓存

// Worker数据库
db.pragma('journal_mode = WAL');
db.pragma('synchronous = NORMAL');
```

### 2. 批量插入使用事务

```javascript
const insertStmt = db.prepare('INSERT INTO comments (...) VALUES (?, ?, ...)');
const insertMany = db.transaction((comments) => {
  for (const c of comments) {
    insertStmt.run(c.id, c.account_id, ...);
  }
});
insertMany(comments); // 一次性提交
```

---

## 安全注意事项

### 1. 凭证加密

```javascript
// accounts表的credentials字段必须加密存储
const crypto = require('crypto');

function encryptCredentials(plaintext, key) {
  const iv = crypto.randomBytes(16);
  const cipher = crypto.createCipheriv('aes-256-cbc', key, iv);
  let encrypted = cipher.update(plaintext, 'utf8', 'base64');
  encrypted += cipher.final('base64');
  return iv.toString('base64') + ':' + encrypted;
}
```

### 2. SQL注入防护

```javascript
// ❌ 危险
const query = `SELECT * FROM accounts WHERE account_name = '${name}'`;

// ✅ 安全
const stmt = db.prepare('SELECT * FROM accounts WHERE account_name = ?');
const account = stmt.get(name);
```

---

## 相关文档

- [数据模型设计](./specs/001-worker/data-model.md)
- [实施计划](./specs/001-worker/plan.md)
- [Worker数据隔离实施](./.docs/archive/IMPLEMENTATION_COMPLETE.md)

---

**文档版本**: 1.0.0
**最后更新**: 2025-10-13
**维护者**: 开发团队
