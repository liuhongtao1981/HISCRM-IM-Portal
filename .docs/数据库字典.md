# æ•°æ®åº“å­—å…¸ - HisCrm-IM ç¤¾äº¤åª’ä½“ç›‘æ§ç³»ç»Ÿ

**ç‰ˆæœ¬**: 1.0.0
**æ•°æ®åº“ç±»å‹**: SQLite 3.x
**ORM**: æ—  (ç›´æ¥ä½¿ç”¨ better-sqlite3)
**æœ€åæ›´æ–°**: 2025-10-13

---

## ğŸ“š ç›®å½•

- [æ•°æ®åº“æ¶æ„æ¦‚è§ˆ](#æ•°æ®åº“æ¶æ„æ¦‚è§ˆ)
- [æµè§ˆå™¨å®ä¾‹æ¶æ„](#æµè§ˆå™¨å®ä¾‹æ¶æ„)
- [ä¸»æ§æ•°æ®åº“ (master.db)](#ä¸»æ§æ•°æ®åº“-masterdb)
- [Workeræ•°æ®åº“ (worker_{id}.db)](#workeræ•°æ®åº“-worker_iddb)
- [æ•°æ®å…³ç³»å›¾](#æ•°æ®å…³ç³»å›¾)
- [å¸¸ç”¨æŸ¥è¯¢ç¤ºä¾‹](#å¸¸ç”¨æŸ¥è¯¢ç¤ºä¾‹)

---

## æ•°æ®åº“æ¶æ„æ¦‚è§ˆ

### ç³»ç»Ÿæ¶æ„åˆ†å¸ƒ

```
HisCrm-IM ç³»ç»Ÿ
â”œâ”€â”€ Master (ä¸»æ§æœåŠ¡)
â”‚   â””â”€â”€ data/master.db              # ä¸»æ§æ•°æ®åº“
â”‚       â”œâ”€â”€ accounts                # 7å¼ è¡¨
â”‚       â”œâ”€â”€ comments
â”‚       â”œâ”€â”€ direct_messages
â”‚       â”œâ”€â”€ notifications
â”‚       â”œâ”€â”€ workers
â”‚       â”œâ”€â”€ client_sessions
â”‚       â””â”€â”€ notification_rules
â”‚
â””â”€â”€ Worker (ç›‘æ§è¿›ç¨‹)
    â”œâ”€â”€ Worker-1 è¿›ç¨‹
    â”‚   â”œâ”€â”€ Browserå®ä¾‹ (Chromium)
    â”‚   â”‚   â”œâ”€â”€ Context-1 (account-123)  â† ç‹¬ç«‹çš„æµè§ˆå™¨ä¸Šä¸‹æ–‡
    â”‚   â”‚   â”œâ”€â”€ Context-2 (account-456)
    â”‚   â”‚   â””â”€â”€ Context-3 (account-789)
    â”‚   â”‚
    â”‚   â””â”€â”€ data/browser/worker-1/
    â”‚       â”œâ”€â”€ account-123_state.json  # Context-1çš„ç™»å½•çŠ¶æ€
    â”‚       â”œâ”€â”€ account-456_state.json  # Context-2çš„ç™»å½•çŠ¶æ€
    â”‚       â”œâ”€â”€ account-789_state.json  # Context-3çš„ç™»å½•çŠ¶æ€
    â”‚       â””â”€â”€ worker_1.db             # Worker-1æœ¬åœ°æ•°æ®åº“ (2å¼ è¡¨)
    â”‚           â”œâ”€â”€ monitor_tasks
    â”‚           â””â”€â”€ crawl_cache
    â”‚
    â”œâ”€â”€ Worker-2 è¿›ç¨‹
    â”‚   â”œâ”€â”€ Browserå®ä¾‹
    â”‚   â”‚   â”œâ”€â”€ Context (account-101)
    â”‚   â”‚   â””â”€â”€ Context (account-202)
    â”‚   â”‚
    â”‚   â””â”€â”€ data/browser/worker-2/
    â”‚       â”œâ”€â”€ account-101_state.json
    â”‚       â”œâ”€â”€ account-202_state.json
    â”‚       â””â”€â”€ worker_2.db
    â”‚
    â””â”€â”€ Worker-3 è¿›ç¨‹
        â”œâ”€â”€ Browserå®ä¾‹
        â”‚   â””â”€â”€ Context (account-303)
        â”‚
        â””â”€â”€ data/browser/worker-3/
            â”œâ”€â”€ account-303_state.json
            â””â”€â”€ worker_3.db
```

---

## æµè§ˆå™¨å®ä¾‹æ¶æ„

### Workerè¿›ç¨‹æ¨¡å‹

```
Workerè¿›ç¨‹ (worker-1)
    â”‚
    â””â”€â”€ Browserå®ä¾‹ (Chromium) â† 1ä¸ªWorkeråªæœ‰1ä¸ªBrowser
            â”‚
            â”œâ”€â”€ Context-1 (account-123)  â† ç‹¬ç«‹çš„æµè§ˆå™¨ä¸Šä¸‹æ–‡
            â”‚   â”œâ”€â”€ Cookies
            â”‚   â”œâ”€â”€ LocalStorage
            â”‚   â”œâ”€â”€ SessionStorage
            â”‚   â””â”€â”€ Storage State â†’ account-123_state.json
            â”‚
            â”œâ”€â”€ Context-2 (account-456)  â† ç‹¬ç«‹çš„æµè§ˆå™¨ä¸Šä¸‹æ–‡
            â”‚   â”œâ”€â”€ Cookies
            â”‚   â”œâ”€â”€ LocalStorage
            â”‚   â”œâ”€â”€ SessionStorage
            â”‚   â””â”€â”€ Storage State â†’ account-456_state.json
            â”‚
            â””â”€â”€ Context-3 (account-789)  â† ç‹¬ç«‹çš„æµè§ˆå™¨ä¸Šä¸‹æ–‡
                â”œâ”€â”€ Cookies
                â”œâ”€â”€ LocalStorage
                â”œâ”€â”€ SessionStorage
                â””â”€â”€ Storage State â†’ account-789_state.json
```

### å…³é”®ç‰¹æ€§

| å±‚çº§ | è¯´æ˜ | æ•°é‡å…³ç³» |
|------|------|---------|
| **Workerè¿›ç¨‹** | Node.jsè¿›ç¨‹ | ç³»ç»Ÿä¸­æœ‰å¤šä¸ªWorker |
| **Browserå®ä¾‹** | Playwright Chromiumå®ä¾‹ | 1ä¸ªWorker = 1ä¸ªBrowser |
| **BrowserContext** | éš”ç¦»çš„æµè§ˆå™¨ä¸Šä¸‹æ–‡ | 1ä¸ªBrowser = å¤šä¸ªContext |
| **Storage State** | æŒä¹…åŒ–çš„ç™»å½•çŠ¶æ€ | 1ä¸ªContext = 1ä¸ªStateæ–‡ä»¶ |

### æ•°æ®éš”ç¦»å±‚æ¬¡

1. **Workerçº§éš”ç¦»**: æ¯ä¸ªWorkerç‹¬ç«‹æ•°æ®ç›®å½• `data/browser/worker-{id}/`
2. **Contextçº§éš”ç¦»**: æ¯ä¸ªè´¦æˆ·ç‹¬ç«‹BrowserContext (Cookiesã€Storageå®Œå…¨éš”ç¦»)
3. **Storageçº§éš”ç¦»**: æ¯ä¸ªè´¦æˆ·ç‹¬ç«‹Stateæ–‡ä»¶ `{accountId}_state.json`
4. **Databaseçº§éš”ç¦»**: æ¯ä¸ªWorkerç‹¬ç«‹SQLiteæ•°æ®åº“ `worker_{id}.db`

### æ€§èƒ½ä¼˜åŠ¿

| ç»´åº¦ | ä¼ ç»Ÿæ–¹æ¡ˆ | å½“å‰æ–¹æ¡ˆ | ä¼˜åŠ¿ |
|------|---------|---------|------|
| Browserå¯åŠ¨ | æ¯è´¦æˆ·1ä¸ªBrowser | æ¯Worker1ä¸ªBrowser | å¯åŠ¨å¿«10å€+ |
| å†…å­˜å ç”¨ | 10è´¦æˆ· â‰ˆ 2GB | 10è´¦æˆ· â‰ˆ 300MB | èŠ‚çœ85%å†…å­˜ |
| Contextåˆ›å»º | N/A | <100ms | è½»é‡çº§ |
| å¹¶å‘å¤„ç† | è¿›ç¨‹é—´åˆ‡æ¢ | Contextå¹¶è¡Œ | é«˜æ•ˆ |

### ä»£ç å®ç°

```javascript
// packages/worker/src/index.js
browserManager = new BrowserManager(WORKER_ID, {
  headless: true,
  dataDir: `./data/browser/${WORKER_ID}`  // Workerçº§éš”ç¦»
});

// packages/worker/src/browser/browser-manager.js
// å¯åŠ¨Browser (æ¯ä¸ªWorkeråªå¯åŠ¨ä¸€æ¬¡)
const browser = await chromium.launch();

// ä¸ºæ¯ä¸ªè´¦æˆ·åˆ›å»ºç‹¬ç«‹çš„Context
const context = await browser.newContext({
  storageState: `${dataDir}/${accountId}_state.json`,  // Contextçº§éš”ç¦»
  viewport: { width: 1920, height: 1080 },
  userAgent: '...',
  // å¯é€‰: æ¯ä¸ªContextå¯ä»¥æœ‰ç‹¬ç«‹çš„ä»£ç†
  proxy: { server: 'http://proxy.com:8080' }
});

// Contextç®¡ç† (accountId -> contextæ˜ å°„)
this.contexts = new Map();
this.contexts.set(accountId, context);
```

---

## ä¸»æ§æ•°æ®åº“ (master.db)

**ä½ç½®**: `packages/master/data/master.db`
**Schema**: `packages/master/src/database/schema.sql`

### è¡¨ç»“æ„æ¦‚è§ˆ

| è¡¨å | è®°å½•ç±»å‹ | ä¸»è¦ç”¨é€” |
|------|---------|---------|
| accounts | è´¦æˆ·ä¿¡æ¯ | ç¤¾äº¤åª’ä½“è´¦æˆ·é…ç½® |
| comments | è¯„è®ºæ•°æ® | ç›‘æ§åˆ°çš„è¯„è®º |
| direct_messages | ç§ä¿¡æ•°æ® | ç›‘æ§åˆ°çš„ç§ä¿¡ |
| notifications | é€šçŸ¥é˜Ÿåˆ— | å¾…æ¨é€çš„é€šçŸ¥ |
| workers | WorkerèŠ‚ç‚¹ | Workeræ³¨å†Œå’Œå¥åº·çŠ¶æ€ |
| client_sessions | å®¢æˆ·ç«¯ä¼šè¯ | å®¢æˆ·ç«¯è¿æ¥ç®¡ç† |
| notification_rules | é€šçŸ¥è§„åˆ™ | è‡ªå®šä¹‰è¿‡æ»¤è§„åˆ™ |

è¯¦ç»†çš„è¡¨ç»“æ„è¯·å‚è€ƒåŸ data-model.md æ–‡æ¡£ã€‚

---

## Workeræ•°æ®åº“ (worker_{id}.db)

**ä½ç½®**: `packages/worker/data/browser/worker-{id}/worker_{id}.db`
**Schema**: `packages/worker/src/database/schema.sql`

### è¡¨ç»“æ„æ¦‚è§ˆ

| è¡¨å | è®°å½•ç±»å‹ | ä¸»è¦ç”¨é€” |
|------|---------|---------|
| monitor_tasks | ç›‘æ§ä»»åŠ¡ | Workeræœ¬åœ°ä»»åŠ¡è°ƒåº¦ |
| crawl_cache | æŠ“å–ç¼“å­˜ | å»é‡ç¼“å­˜,é¿å…é‡å¤æ£€æµ‹ |

### æ–‡ä»¶ç»„ç»‡

```
data/browser/worker-1/
â”œâ”€â”€ account-123_state.json    # Context-1 Storage State (Cookiesç­‰)
â”œâ”€â”€ account-456_state.json    # Context-2 Storage State
â”œâ”€â”€ account-789_state.json    # Context-3 Storage State
â””â”€â”€ worker_1.db               # Workeræœ¬åœ°æ•°æ®åº“
    â”œâ”€â”€ monitor_tasks         # ä»»åŠ¡è¡¨
    â””â”€â”€ crawl_cache          # ç¼“å­˜è¡¨
```

---

## æ•°æ®å…³ç³»å›¾

### Masteræ•°æ®åº“å…³ç³»

```
accounts (1) â”€â”€< (N) comments
accounts (1) â”€â”€< (N) direct_messages
accounts (1) â”€â”€< (N) notifications
accounts (N) â”€â”€> (1) workers (assigned_worker_id)
accounts (1) â”€â”€< (N) notification_rules

client_sessions (ç‹¬ç«‹è¡¨,æ— å¤–é”®)
```

### Workeræ•°æ®åº“å…³ç³»

```
monitor_tasks (å¼•ç”¨ Master.accounts.id,ä½†æ— å¤–é”®çº¦æŸ)
crawl_cache (å¼•ç”¨ Master.accounts.id,ä½†æ— å¤–é”®çº¦æŸ)
```

**æ³¨æ„**: Workeræ•°æ®åº“ä¸ä½¿ç”¨å¤–é”®çº¦æŸ,é€šè¿‡account_idå­—æ®µå¼•ç”¨Masteræ•°æ®åº“çš„è´¦æˆ·ã€‚

---

## å¸¸ç”¨æŸ¥è¯¢ç¤ºä¾‹

### 1. è·å–è´¦æˆ·çš„æœªè¯»æ¶ˆæ¯ç»Ÿè®¡

```sql
SELECT
  a.id,
  a.account_name,
  (SELECT COUNT(*) FROM comments WHERE account_id = a.id AND is_read = 0) AS unread_comments,
  (SELECT COUNT(*) FROM direct_messages WHERE account_id = a.id AND is_read = 0) AS unread_messages
FROM accounts a
WHERE a.status = 'active';
```

### 2. è·å–Workerè´Ÿè½½æƒ…å†µ

```sql
SELECT
  w.id,
  w.host,
  w.assigned_accounts,
  COUNT(a.id) AS actual_accounts,
  w.status,
  (strftime('%s', 'now') - w.last_heartbeat) AS seconds_since_heartbeat
FROM workers w
LEFT JOIN accounts a ON a.assigned_worker_id = w.id
WHERE w.status = 'online'
GROUP BY w.id
ORDER BY w.assigned_accounts ASC;
```

### 3. è·å–è´¦æˆ·çš„å†å²æ¶ˆæ¯ (åˆå¹¶è¯„è®ºå’Œç§ä¿¡)

```sql
SELECT * FROM (
  SELECT
    id,
    'comment' AS type,
    content,
    author_name AS from_name,
    detected_at,
    created_at,
    is_read
  FROM comments
  WHERE account_id = ?

  UNION ALL

  SELECT
    id,
    'message' AS type,
    content,
    sender_name AS from_name,
    detected_at,
    created_at,
    is_read
  FROM direct_messages
  WHERE account_id = ?
)
ORDER BY detected_at DESC
LIMIT ? OFFSET ?;
```

---

## æ•°æ®ä¿ç•™ç­–ç•¥

### è‡ªåŠ¨æ¸…ç†è§„åˆ™

```sql
-- 1. å†å²æ¶ˆæ¯ (30å¤©)
DELETE FROM comments WHERE detected_at < (strftime('%s', 'now') - 2592000);
DELETE FROM direct_messages WHERE detected_at < (strftime('%s', 'now') - 2592000);

-- 2. é€šçŸ¥è®°å½• (7å¤©)
DELETE FROM notifications WHERE is_sent = 1 AND created_at < (strftime('%s', 'now') - 604800);

-- 3. ç¦»çº¿Worker (7å¤©)
DELETE FROM workers WHERE status = 'offline' AND last_heartbeat < (strftime('%s', 'now') - 604800);

-- 4. Workerç¼“å­˜ (è‡ªåŠ¨è¿‡æœŸ)
DELETE FROM crawl_cache WHERE expires_at < strftime('%s', 'now');
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. WALæ¨¡å¼é…ç½®

```javascript
// Masteræ•°æ®åº“
db.pragma('journal_mode = WAL');
db.pragma('synchronous = NORMAL');
db.pragma('cache_size = -64000'); // 64MBç¼“å­˜

// Workeræ•°æ®åº“
db.pragma('journal_mode = WAL');
db.pragma('synchronous = NORMAL');
```

### 2. æ‰¹é‡æ’å…¥ä½¿ç”¨äº‹åŠ¡

```javascript
const insertStmt = db.prepare('INSERT INTO comments (...) VALUES (?, ?, ...)');
const insertMany = db.transaction((comments) => {
  for (const c of comments) {
    insertStmt.run(c.id, c.account_id, ...);
  }
});
insertMany(comments); // ä¸€æ¬¡æ€§æäº¤
```

---

## å®‰å…¨æ³¨æ„äº‹é¡¹

### 1. å‡­è¯åŠ å¯†

```javascript
// accountsè¡¨çš„credentialså­—æ®µå¿…é¡»åŠ å¯†å­˜å‚¨
const crypto = require('crypto');

function encryptCredentials(plaintext, key) {
  const iv = crypto.randomBytes(16);
  const cipher = crypto.createCipheriv('aes-256-cbc', key, iv);
  let encrypted = cipher.update(plaintext, 'utf8', 'base64');
  encrypted += cipher.final('base64');
  return iv.toString('base64') + ':' + encrypted;
}
```

### 2. SQLæ³¨å…¥é˜²æŠ¤

```javascript
// âŒ å±é™©
const query = `SELECT * FROM accounts WHERE account_name = '${name}'`;

// âœ… å®‰å…¨
const stmt = db.prepare('SELECT * FROM accounts WHERE account_name = ?');
const account = stmt.get(name);
```

---

## ç›¸å…³æ–‡æ¡£

- [æ•°æ®æ¨¡å‹è®¾è®¡](./specs/001-worker/data-model.md)
- [å®æ–½è®¡åˆ’](./specs/001-worker/plan.md)
- [Workeræ•°æ®éš”ç¦»å®æ–½](./.docs/archive/IMPLEMENTATION_COMPLETE.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0
**æœ€åæ›´æ–°**: 2025-10-13
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ
