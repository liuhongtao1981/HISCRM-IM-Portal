# ç™»å½•æµç¨‹ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“‹ å½“å‰é—®é¢˜åˆ†æ

### ç”¨æˆ·æ„Ÿå—ï¼š
> "é€šè¿‡ Worker è°ƒç”¨ç™»å½•é¡µé¢ï¼Œè·å–äºŒç»´ç å‘é€ç»™å®¢æˆ·ï¼Œå®¢æˆ·æ‰«ç åï¼ŒWorker è‡ªåŠ¨æ£€æµ‹ç™»å½•æˆåŠŸåè¿”å›ç»™ Webã€‚ç›®å‰çœ‹ç¨æ˜¾å¤æ‚ï¼Œä½†åœ¨ Web ç«¯åˆæ— æ³•æ¨¡æ‹Ÿç™»å½•ã€‚"

### æ ¸å¿ƒçŸ›ç›¾ï¼š
- âœ… **å¿…è¦æ€§**: Worker å±‚æ˜¯å¿…é¡»çš„ï¼ˆæµè§ˆå™¨ç¯å¢ƒã€Cookie ç®¡ç†ã€åçˆ¬è™«ï¼‰
- âš ï¸ **å¤æ‚æ€§**: å¤šå±‚é€šä¿¡é“¾è·¯ã€äº‹ä»¶ä¼ é€’ã€çŠ¶æ€åŒæ­¥è¾ƒä¸ºå¤æ‚

## ğŸ’¡ ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ä¿æŒæ¶æ„ï¼Œä¼˜åŒ–ä½“éªŒï¼ˆæ¨èï¼‰âœ¨

**æ ¸å¿ƒæ€è·¯**: ä¿æŒä¸‰å±‚æ¶æ„ï¼Œä½†ç®€åŒ–äº¤äº’æµç¨‹ï¼Œæå‡å“åº”é€Ÿåº¦

#### 1.1 ä¸€é”®ç™»å½•

**å½“å‰æµç¨‹**:
```
ç”¨æˆ·ç‚¹å‡»"ç™»å½•" â†’ å¼¹å‡ºç¡®è®¤æ¡† â†’ ç­‰å¾… QR ç  â†’ å¼¹å‡º QR æ¨¡æ€æ¡† â†’ ç­‰å¾…æ‰«ç 
```

**ä¼˜åŒ–å**:
```javascript
// AccountsPage.js
const handleQuickLogin = async (account) => {
  // ç›´æ¥å¯åŠ¨ï¼Œä¸å¼¹ç¡®è®¤æ¡†
  const sessionId = startLogin(account.id, account.assigned_worker_id);
  
  // ç«‹å³æ˜¾ç¤º"åŠ è½½ä¸­"æ¨¡æ€æ¡†
  setLoadingModalVisible(true);
  setLoadingMessage('æ­£åœ¨å¯åŠ¨ç™»å½•æµç¨‹...');
  
  // ç­‰å¾… QR ç ï¼ˆè®¾ç½®è¶…æ—¶ï¼‰
  const qrTimeout = setTimeout(() => {
    message.error('QR ç åŠ è½½è¶…æ—¶ï¼Œè¯·é‡è¯•');
    setLoadingModalVisible(false);
  }, 10000);
};
```

**æ•ˆæœ**: 
- âœ… å‡å°‘ç”¨æˆ·ç‚¹å‡»æ¬¡æ•°
- âœ… æ›´å¿«çš„è§†è§‰åé¦ˆ
- âœ… æ›´æµç•…çš„ä½“éªŒ

#### 1.2 åˆå¹¶çŠ¶æ€æ˜¾ç¤º

**å½“å‰**: ç™»å½•ç®¡ç†é¡µé¢ + QR ç æ¨¡æ€æ¡†ï¼ˆä¸¤ä¸ªç•Œé¢ï¼‰

**ä¼˜åŒ–**: åœ¨è´¦æˆ·åˆ—è¡¨ç›´æ¥æ˜¾ç¤ºç™»å½•çŠ¶æ€å¡ç‰‡

```javascript
// AccountsPage.js
const LoginStatusCard = ({ account }) => {
  const { loginSessions } = useSocket();
  const activeSession = loginSessions.find(
    s => s.account_id === account.id && s.status === 'scanning'
  );
  
  if (!activeSession) return null;
  
  return (
    <Card size="small" style={{ marginTop: 8 }}>
      <Row gutter={16} align="middle">
        <Col span={8}>
          <Image 
            src={activeSession.qr_code_data} 
            width={120}
            preview={false}
          />
        </Col>
        <Col span={16}>
          <Space direction="vertical">
            <Text strong>è¯·ä½¿ç”¨æŠ–éŸ³æ‰«ç ç™»å½•</Text>
            <Statistic.Countdown 
              value={activeSession.expires_at * 1000}
              format="mm:ss"
            />
            <Button 
              size="small" 
              onClick={() => handleRefreshQR(account.id)}
            >
              åˆ·æ–°äºŒç»´ç 
            </Button>
          </Space>
        </Col>
      </Row>
    </Card>
  );
};
```

**æ•ˆæœ**:
- âœ… æ— éœ€è·³è½¬é¡µé¢
- âœ… åœ¨è´¦æˆ·åˆ—è¡¨ç›´æ¥çœ‹åˆ°ç™»å½•çŠ¶æ€
- âœ… æ”¯æŒå¤šä¸ªè´¦æˆ·åŒæ—¶ç™»å½•

#### 1.3 å¢åŠ è¿›åº¦æŒ‡ç¤ºå™¨

æ˜¾ç¤ºè¯¦ç»†çš„ç™»å½•æ­¥éª¤ï¼š

```javascript
const LoginProgress = ({ status }) => {
  const steps = [
    { key: 'init', title: 'åˆå§‹åŒ–æµè§ˆå™¨', icon: <RocketOutlined /> },
    { key: 'loading', title: 'åŠ è½½ç™»å½•é¡µé¢', icon: <LoadingOutlined /> },
    { key: 'qrcode', title: 'ç­‰å¾…æ‰«ç ', icon: <QrcodeOutlined /> },
    { key: 'verifying', title: 'éªŒè¯ç™»å½•', icon: <SafetyOutlined /> },
    { key: 'success', title: 'ç™»å½•æˆåŠŸ', icon: <CheckCircleOutlined /> },
  ];
  
  return (
    <Steps 
      current={getCurrentStep(status)} 
      items={steps}
      size="small"
    />
  );
};
```

#### 1.4 æ™ºèƒ½é‡è¯•æœºåˆ¶

```javascript
// ç™»å½•å¤±è´¥è‡ªåŠ¨é‡è¯•
const handleLoginWithRetry = async (account, maxRetries = 3) => {
  for (let i = 0; i < maxRetries; i++) {
    try {
      await startLogin(account.id, account.assigned_worker_id);
      break; // æˆåŠŸåˆ™é€€å‡º
    } catch (error) {
      if (i === maxRetries - 1) {
        message.error(`ç™»å½•å¤±è´¥: ${error.message}`);
      } else {
        message.warning(`ç™»å½•å¤±è´¥ï¼Œ${3 - i} ç§’åé‡è¯•...`);
        await sleep(3000);
      }
    }
  }
};
```

---

### æ–¹æ¡ˆ 2: å¼•å…¥ WebSocket ç›´è¿ï¼ˆé«˜çº§ï¼‰ğŸš€

**æ ¸å¿ƒæ€è·¯**: Admin Web ç›´æ¥ä¸ Worker å»ºç«‹ WebSocket è¿æ¥ï¼Œå‡å°‘ Master ä¸­è½¬

#### æ¶æ„è°ƒæ•´ï¼š

```
å½“å‰: Admin Web â†â†’ Master â†â†’ Worker
ä¼˜åŒ–: Admin Web â†â†’ Master (ç®¡ç†åŠŸèƒ½)
              â†“
              â†˜â†’ Worker (å®æ—¶åŠŸèƒ½ï¼Œç›´è¿)
```

#### ä¼˜ç‚¹ï¼š
- âœ… å‡å°‘æ¶ˆæ¯ä¼ é€’å»¶è¿Ÿ
- âœ… é™ä½ Master è´Ÿè½½
- âœ… æ›´å¿«çš„ QR ç æ˜¾ç¤º

#### ç¼ºç‚¹ï¼š
- âš ï¸ éœ€è¦ Worker æš´éœ² WebSocket ç«¯å£
- âš ï¸ éœ€è¦é¢å¤–çš„é‰´æƒæœºåˆ¶
- âš ï¸ å¢åŠ æ¶æ„å¤æ‚åº¦

#### å®ç°ç¤ºä¾‹ï¼š

```javascript
// Worker ç«¯
const io = require('socket.io')(3002, {
  cors: { origin: 'http://localhost:3001' }
});

io.use(async (socket, next) => {
  // éªŒè¯ tokenï¼ˆä» Master è·å–ï¼‰
  const token = socket.handshake.auth.token;
  const valid = await validateToken(token);
  if (valid) next();
  else next(new Error('Authentication failed'));
});

io.on('connection', (socket) => {
  socket.on('login:start', async (data) => {
    // ç›´æ¥å¤„ç†ç™»å½•è¯·æ±‚
    const qrCode = await platformManager.startLogin(data);
    socket.emit('login:qrcode', qrCode);
  });
});
```

```javascript
// Admin Web ç«¯
const workerSocket = io('http://localhost:3002', {
  auth: { token: masterToken }
});

workerSocket.on('login:qrcode', (data) => {
  // ç›´æ¥æ˜¾ç¤º QR ç ï¼Œæ— éœ€ Master ä¸­è½¬
  setQRCode(data);
});
```

**è¯„ä¼°**: ä»…åœ¨æœ‰æ˜ç¡®æ€§èƒ½ç“¶é¢ˆæ—¶æ‰è€ƒè™‘æ­¤æ–¹æ¡ˆ

---

### æ–¹æ¡ˆ 3: é¢„åŠ è½½æµè§ˆå™¨ä¸Šä¸‹æ–‡ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰âš¡

**æ ¸å¿ƒæ€è·¯**: Worker é¢„å…ˆå¯åŠ¨æµè§ˆå™¨ï¼Œå‡å°‘ç­‰å¾…æ—¶é—´

#### 3.1 å¯åŠ¨æ—¶é¢„çƒ­

```javascript
// Worker å¯åŠ¨æ—¶é¢„åˆ›å»ºæµè§ˆå™¨å®ä¾‹
class BrowserPool {
  constructor() {
    this.warmBrowsers = [];
  }
  
  async prewarmBrowsers(count = 3) {
    logger.info(`Prewarming ${count} browser contexts...`);
    for (let i = 0; i < count; i++) {
      const context = await this.browserManager.createContext();
      this.warmBrowsers.push(context);
    }
    logger.info('Browser prewarm completed');
  }
  
  async getBrowser() {
    // ä¼˜å…ˆä½¿ç”¨é¢„çƒ­çš„æµè§ˆå™¨
    if (this.warmBrowsers.length > 0) {
      return this.warmBrowsers.pop();
    }
    return await this.browserManager.createContext();
  }
}
```

**æ•ˆæœ**:
- âœ… QR ç ç”Ÿæˆé€Ÿåº¦ä» 5-10 ç§’é™ä½åˆ° 1-2 ç§’
- âœ… ç”¨æˆ·æ„ŸçŸ¥å»¶è¿Ÿå¤§å¹…é™ä½

#### 3.2 è´¦æˆ·çŠ¶æ€ç¼“å­˜

```javascript
// ç¼“å­˜å·²ç™»å½•è´¦æˆ·çš„ Context
class ContextCache {
  constructor() {
    this.cache = new Map(); // accountId -> context
  }
  
  async getOrCreate(accountId) {
    if (this.cache.has(accountId)) {
      const context = this.cache.get(accountId);
      // éªŒè¯ Context æ˜¯å¦æœ‰æ•ˆ
      if (await this.isContextValid(context)) {
        return context;
      }
    }
    
    // åˆ›å»ºæ–° Context
    const context = await this.createNewContext(accountId);
    this.cache.set(accountId, context);
    return context;
  }
}
```

---

### æ–¹æ¡ˆ 4: æ·»åŠ ç™»å½•æ–¹å¼é€‰æ‹©ï¼ˆæ‰©å±•æ€§ï¼‰ğŸ¯

**æ ¸å¿ƒæ€è·¯**: æ”¯æŒå¤šç§ç™»å½•æ–¹å¼ï¼Œé™ä½ç”¨æˆ·é—¨æ§›

#### 4.1 æ”¯æŒçš„ç™»å½•æ–¹å¼

```javascript
const LoginMethodSelector = ({ account, onSelect }) => {
  const methods = [
    {
      key: 'qrcode',
      title: 'äºŒç»´ç ç™»å½•',
      description: 'ä½¿ç”¨æŠ–éŸ³ App æ‰«ç ç™»å½•ï¼ˆæ¨èï¼‰',
      icon: <QrcodeOutlined />,
      available: true,
    },
    {
      key: 'cookie',
      title: 'Cookie ç™»å½•',
      description: 'å¯¼å…¥å·²æœ‰çš„ Cookieï¼ˆé€‚åˆæ‰¹é‡å¯¼å…¥ï¼‰',
      icon: <KeyOutlined />,
      available: true,
    },
    {
      key: 'password',
      title: 'è´¦å·å¯†ç ç™»å½•',
      description: 'ä½¿ç”¨è´¦å·å¯†ç ç™»å½•ï¼ˆä¸æ¨èï¼‰',
      icon: <LockOutlined />,
      available: false, // æŠ–éŸ³å·²ä¸æ”¯æŒ
    },
  ];
  
  return (
    <Radio.Group 
      onChange={(e) => onSelect(e.target.value)}
      defaultValue="qrcode"
    >
      <Space direction="vertical">
        {methods.map(method => (
          <Radio 
            key={method.key} 
            value={method.key}
            disabled={!method.available}
          >
            <Space>
              {method.icon}
              <div>
                <Text strong>{method.title}</Text>
                <br />
                <Text type="secondary" style={{ fontSize: 12 }}>
                  {method.description}
                </Text>
              </div>
            </Space>
          </Radio>
        ))}
      </Space>
    </Radio.Group>
  );
};
```

#### 4.2 Cookie å¿«é€Ÿå¯¼å…¥

```javascript
// æ”¯æŒæ‰¹é‡ Cookie å¯¼å…¥
const CookieImportModal = () => {
  const handleImport = async (cookieText) => {
    try {
      // è§£æ Cookie
      const cookies = parseCookieString(cookieText);
      
      // å‘é€åˆ° Worker
      await socket.emit('master:login:cookie', {
        account_id: account.id,
        cookies: cookies,
      });
      
      message.success('Cookie å¯¼å…¥æˆåŠŸï¼Œæ­£åœ¨éªŒè¯...');
    } catch (error) {
      message.error(`å¯¼å…¥å¤±è´¥: ${error.message}`);
    }
  };
  
  return (
    <Modal title="å¯¼å…¥ Cookie" visible={visible}>
      <TextArea 
        rows={6}
        placeholder="è¯·ç²˜è´´ Cookie å­—ç¬¦ä¸²..."
      />
      <Button onClick={handleImport}>å¯¼å…¥</Button>
    </Modal>
  );
};
```

**æ•ˆæœ**:
- âœ… æ”¯æŒå¤šç§ç™»å½•æ–¹å¼
- âœ… æ‰¹é‡è´¦æˆ·å¿«é€Ÿå¯¼å…¥
- âœ… é€‚åº”ä¸åŒåœºæ™¯éœ€æ±‚

---

### æ–¹æ¡ˆ 5: ç§»åŠ¨ç«¯æ‰«ç ä¼˜åŒ–ï¼ˆä½“éªŒï¼‰ğŸ“±

**æ ¸å¿ƒæ€è·¯**: ä¼˜åŒ–ç§»åŠ¨è®¾å¤‡æ‰«ç ä½“éªŒ

#### 5.1 å“åº”å¼ QR ç 

```javascript
const ResponsiveQRCode = ({ qrData }) => {
  const isMobile = useIsMobile();
  
  return (
    <div style={{ 
      textAlign: 'center',
      padding: isMobile ? 16 : 24 
    }}>
      <QRCode 
        value={qrData}
        size={isMobile ? 200 : 300}  // ç§»åŠ¨ç«¯æ›´å°
        level="H"  // é«˜çº é”™ç‡
      />
      
      {isMobile && (
        <Alert
          message="é•¿æŒ‰è¯†åˆ«äºŒç»´ç "
          type="info"
          showIcon
          style={{ marginTop: 16 }}
        />
      )}
    </div>
  );
};
```

#### 5.2 QR ç åˆ†äº«

```javascript
// æ”¯æŒå°† QR ç å‘é€åˆ°å¾®ä¿¡/é‚®ä»¶
const ShareQRCode = ({ qrData }) => {
  const handleShare = async (method) => {
    if (method === 'wechat') {
      // ç”Ÿæˆåˆ†äº«é“¾æ¥
      const shareUrl = await generateShareUrl(qrData);
      window.open(shareUrl);
    } else if (method === 'email') {
      // å‘é€é‚®ä»¶
      await sendQRCodeEmail(qrData);
    }
  };
  
  return (
    <Space>
      <Button icon={<WechatOutlined />} onClick={() => handleShare('wechat')}>
        å‘é€åˆ°å¾®ä¿¡
      </Button>
      <Button icon={<MailOutlined />} onClick={() => handleShare('email')}>
        å‘é€åˆ°é‚®ç®±
      </Button>
    </Space>
  );
};
```

---

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å¤æ‚åº¦ | æ•ˆæœ | å¼€å‘æˆæœ¬ | æ¨èåº¦ |
|------|--------|------|----------|--------|
| æ–¹æ¡ˆ1: ä¼˜åŒ–ä½“éªŒ | â­ | â­â­â­â­â­ | â­â­ | â­â­â­â­â­ |
| æ–¹æ¡ˆ2: WebSocketç›´è¿ | â­â­â­â­ | â­â­â­ | â­â­â­â­â­ | â­â­ |
| æ–¹æ¡ˆ3: é¢„åŠ è½½æµè§ˆå™¨ | â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­â­ |
| æ–¹æ¡ˆ4: å¤šç™»å½•æ–¹å¼ | â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­â­ |
| æ–¹æ¡ˆ5: ç§»åŠ¨ç«¯ä¼˜åŒ– | â­â­ | â­â­â­ | â­â­ | â­â­â­ |

## ğŸ¯ æ¨èå®æ–½é¡ºåº

### ç¬¬ä¸€é˜¶æ®µï¼ˆç«‹å³å®æ–½ï¼‰ï¼š
1. âœ… **ä¸€é”®ç™»å½•** - å»æ‰ç¡®è®¤å¼¹çª—ï¼Œç›´æ¥å¯åŠ¨
2. âœ… **è¿›åº¦æŒ‡ç¤ºå™¨** - è®©ç”¨æˆ·çŸ¥é“å½“å‰çŠ¶æ€
3. âœ… **åˆå¹¶çŠ¶æ€æ˜¾ç¤º** - åœ¨è´¦æˆ·åˆ—è¡¨ç›´æ¥æ˜¾ç¤ºç™»å½•å¡ç‰‡

### ç¬¬äºŒé˜¶æ®µï¼ˆ1-2 å‘¨ï¼‰ï¼š
4. âš¡ **é¢„åŠ è½½æµè§ˆå™¨** - æå‡å“åº”é€Ÿåº¦
5. ğŸ”„ **æ™ºèƒ½é‡è¯•** - ç™»å½•å¤±è´¥è‡ªåŠ¨é‡è¯•
6. ğŸ¯ **å¤šç™»å½•æ–¹å¼** - æ”¯æŒ Cookie å¯¼å…¥

### ç¬¬ä¸‰é˜¶æ®µï¼ˆå¯é€‰ï¼‰ï¼š
7. ğŸ“± **ç§»åŠ¨ç«¯ä¼˜åŒ–** - å¦‚æœæœ‰ç§»åŠ¨ç«¯ç”¨æˆ·
8. ğŸš€ **WebSocket ç›´è¿** - å¦‚æœæ€§èƒ½æˆä¸ºç“¶é¢ˆ

## ğŸ”§ æ ¸å¿ƒä¿®æ”¹æ–‡ä»¶

### æ–¹æ¡ˆ 1 å®æ–½æ–‡ä»¶æ¸…å•ï¼š

```
packages/admin-web/src/
  pages/
    AccountsPage.js           [ä¿®æ”¹] æ·»åŠ ä¸€é”®ç™»å½•ã€çŠ¶æ€å¡ç‰‡
    LoginManagementPage.js    [ç®€åŒ–] å‡å°‘åŠŸèƒ½ï¼Œä¸“æ³¨å†å²è®°å½•
  components/
    LoginStatusCard.js        [æ–°å¢] ç™»å½•çŠ¶æ€å¡ç‰‡ç»„ä»¶
    LoginProgressSteps.js     [æ–°å¢] è¿›åº¦æŒ‡ç¤ºå™¨ç»„ä»¶
  services/
    socketContext.js          [ä¿®æ”¹] ä¼˜åŒ–äº‹ä»¶å¤„ç†
```

## ğŸ’¡ æœ€ç»ˆå»ºè®®

**æˆ‘çš„å»ºè®®æ˜¯é‡‡ç”¨"æ–¹æ¡ˆ 1 + æ–¹æ¡ˆ 3"çš„ç»„åˆ**ï¼š

1. **ä¿æŒä¸‰å±‚æ¶æ„ä¸å˜**ï¼ˆå¿…è¦æ€§ï¼‰
   - Admin Web â†â†’ Master â†â†’ Worker
   - è¿™æ˜¯ç”±æŠ€æœ¯é™åˆ¶å†³å®šçš„ï¼Œä¸èƒ½ç»•è¿‡

2. **ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ**ï¼ˆæ–¹æ¡ˆ 1ï¼‰
   - ä¸€é”®ç™»å½•
   - åœ¨è´¦æˆ·åˆ—è¡¨ç›´æ¥æ˜¾ç¤ºç™»å½•çŠ¶æ€
   - æ·»åŠ è¿›åº¦æŒ‡ç¤ºå™¨
   - æ™ºèƒ½é‡è¯•æœºåˆ¶

3. **æå‡æ€§èƒ½**ï¼ˆæ–¹æ¡ˆ 3ï¼‰
   - Worker é¢„çƒ­æµè§ˆå™¨å®ä¾‹
   - ç¼“å­˜å·²ç™»å½•è´¦æˆ·çš„ Context
   - å‡å°‘ç”¨æˆ·ç­‰å¾…æ—¶é—´

**é¢„æœŸæ•ˆæœ**ï¼š
- âœ… æ¶æ„ä¿æŒç®€å•æ¸…æ™°
- âœ… ç”¨æˆ·ä½“éªŒå¤§å¹…æå‡
- âœ… å“åº”é€Ÿåº¦æ˜¾è‘—åŠ å¿«
- âœ… å¼€å‘æˆæœ¬å¯æ§

æ‚¨è§‰å¾—è¿™ä¸ªæ–¹æ¡ˆå¦‚ä½•ï¼Ÿæˆ‘å¯ä»¥ç«‹å³å¼€å§‹å®æ–½ç¬¬ä¸€é˜¶æ®µçš„ä¼˜åŒ–ã€‚

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**: 2025-10-16  
**ç»´æŠ¤äººå‘˜**: Development Team
