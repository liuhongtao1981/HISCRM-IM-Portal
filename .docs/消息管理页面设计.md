# 消息管理页面设计文档

## 概述

消息管理页面是一个用于查询和管理消息（评论和私信）的功能模块。用户可以：
- 查看全部评论和私信
- 按账号筛选
- 查看今日消息（有特殊颜色区分）
- 设置自动刷新间隔

## 实现文件

### 前端

#### 1. [packages/admin-web/src/pages/MessageManagementPage.js](../packages/admin-web/src/pages/MessageManagementPage.js)
- **作用**: 消息管理主页面组件
- **功能**:
  - 显示评论和私信统计卡片
  - 标签页切换（评论/私信）
  - 时间过滤和搜索
  - 自动刷新控制（10/30/60秒可选）
  - 今日消息高亮显示（红色背景）
  - 定时刷新功能

#### 2. [packages/admin-web/src/services/api.js](../packages/admin-web/src/services/api.js)（已更新）
- **新增 API**:
  - `messagesAPI.getComments(params)` - 获取评论列表
  - `messagesAPI.getDirectMessages(params)` - 获取私信列表
  - `messagesAPI.getMessageStats()` - 获取消息统计

#### 3. [packages/admin-web/src/App.js](../packages/admin-web/src/App.js)（已更新）
- **新增菜单项**: "💬 消息管理" → `/messages`
- **新增路由**: `<Route path="/messages" element={<MessageManagementPage />} />`

### 后端

#### [packages/master/src/api/routes/messages.js](../packages/master/src/api/routes/messages.js)（已扩展）

**新增两个 GET 端点**:

##### 1. `/api/v1/comments`
查询评论列表

**查询参数**:
- `account_id` (可选): 账户ID筛选
- `sort` (可选, 默认='created_at'): 排序字段
  - `created_at`: 按创建时间
  - `detected_at`: 按检测时间
- `order` (可选, 默认='desc'): 排序顺序
  - `asc`: 升序
  - `desc`: 降序
- `created_at_start` (可选): 开始时间戳（Unix）
- `created_at_end` (可选): 结束时间戳（Unix）
- `limit` (可选, 默认=100): 返回数量

**响应示例**:
```json
{
  "success": true,
  "data": [
    {
      "id": "comment-xxx",
      "account_id": "acc-xxx",
      "content": "这是一条评论",
      "creator_name": "用户名",
      "video_id": "video-xxx",
      "platform": "douyin",
      "created_at": 1634567890,
      "detected_at": 1634567895
    }
  ],
  "count": 1
}
```

##### 2. `/api/v1/direct-messages`
查询私信列表

**查询参数**:
- `account_id` (可选): 账户ID筛选
- `direction` (可选): 方向筛选
  - `inbound`: 入站（接收）
  - `outbound`: 出站（发送）
- `sort` (可选, 默认='created_at'): 排序字段
- `order` (可选, 默认='desc'): 排序顺序
- `created_at_start` (可选): 开始时间戳（Unix）
- `created_at_end` (可选): 结束时间戳（Unix）
- `limit` (可选, 默认=100): 返回数量

**响应示例**:
```json
{
  "success": true,
  "data": [
    {
      "id": "dm-xxx",
      "account_id": "acc-xxx",
      "content": "这是一条私信",
      "sender_name": "发送者",
      "direction": "inbound",
      "platform": "douyin",
      "created_at": 1634567890,
      "detected_at": 1634567895
    }
  ],
  "count": 1
}
```

## 前端实现细节

### 页面结构

```
消息管理页面
├── 页面标题 + 刷新间隔选择
├── 统计卡片行
│   ├── 总评论数
│   ├── 今日评论数
│   ├── 总私信数
│   └── 今日私信数
├── 筛选卡片
│   ├── 消息类型（全部/今日）
│   └── 搜索框
└── 标签页
    ├── 评论表格
    │   ├── 时间（今日高亮红色）
    │   ├── 账号
    │   ├── 评论内容
    │   ├── 发布者
    │   ├── 视频ID
    │   └── 来源
    └── 私信表格
        ├── 时间（今日高亮红色）
        ├── 账号
        ├── 私信内容
        ├── 发送者
        ├── 方向
        └── 来源
```

### 今日消息识别

```javascript
// 判断是否为今日消息
const isToday = (timestamp) => {
  const date = dayjs.unix(timestamp);
  return date.isSame(dayjs(), 'day');
};

// 时间单元格渲染（红色标记）
<span style={{
  color: today ? '#ff4d4f' : undefined,
  fontWeight: today ? 'bold' : 'normal',
  backgroundColor: today ? '#fff2f0' : 'transparent',
  padding: '2px 6px',
  borderRadius: '4px'
}}>
  {today ? '【今日】' : ''}{date.format('MM-DD HH:mm:ss')}
</span>
```

### 自动刷新功能

```javascript
// 刷新间隔选择
<Select
  style={{ width: 120 }}
  value={refreshInterval}
  onChange={setRefreshInterval}
>
  <Option value={10}>每10秒刷新</Option>
  <Option value={30}>每30秒刷新</Option>
  <Option value={60}>每60秒刷新</Option>
  <Option value={999999}>不自动刷新</Option>
</Select>

// 定时器实现
useEffect(() => {
  const interval = setInterval(() => {
    if (activeTab === 'comments') {
      fetchComments();
    } else {
      fetchDirectMessages();
    }
  }, refreshInterval * 1000);

  return () => clearInterval(interval);
}, [activeTab, filters, refreshInterval]);
```

## 测试脚本

**位置**: [tests/test-message-management.js](../tests/test-message-management.js)

**测试项目**:
1. 获取全部评论
2. 按时间倒序排序
3. 获取今日评论
4. 按账号筛选评论
5. 获取全部私信
6. 按方向筛选私信（入站/出站）
7. 验证 API 响应格式

**运行方式**:
```bash
node tests/test-message-management.js
```

## 使用示例

### 获取今日评论（按最新优先排序）

```javascript
const params = {
  created_at_start: dayjs().startOf('day').unix(),
  sort: 'created_at',
  order: 'desc',
  limit: 100
};
const response = await api.get('/api/v1/comments', { params });
```

### 获取特定账号的私信（入站，最新优先）

```javascript
const params = {
  account_id: 'acc-59112c67-ff87-44e3-9176-44313ce2b0b6',
  direction: 'inbound',
  sort: 'created_at',
  order: 'desc',
  limit: 50
};
const response = await api.get('/api/v1/direct-messages', { params });
```

## 颜色方案

| 元素 | 颜色 | 说明 |
|------|------|------|
| 评论账号 Tag | Blue (#1890ff) | 评论来源标识 |
| 私信账号 Tag | Green (#52c41a) | 私信来源标识 |
| 今日消息背景 | Red (#ff2f0) | 浅红色背景 |
| 今日消息文字 | Red (#ff4d4f) | 红色文字 |
| 入站方向 Tag | Cyan | 接收消息 |
| 出站方向 Tag | Orange | 发送消息 |

## 数据库表字段映射

### comments 表
```
- id: 评论ID
- account_id: 账户ID
- content: 评论内容
- creator_name: 发布者名称
- video_id: 视频ID
- platform: 平台（douyin等）
- created_at: 创建时间戳
- detected_at: 检测时间戳
```

### direct_messages 表
```
- id: 私信ID
- account_id: 账户ID
- content: 私信内容
- sender_name: 发送者名称
- direction: 方向（inbound/outbound）
- platform: 平台（douyin等）
- created_at: 创建时间戳
- detected_at: 检测时间戳
```

## 未来改进

1. **消息搜索**: 实现全文搜索功能
2. **消息标记**: 支持标记重要消息
3. **批量操作**: 支持批量删除/导出
4. **消息详情**: 点击查看完整消息详情
5. **通知集成**: 与通知系统联动显示新消息
6. **数据导出**: 支持导出为 CSV/Excel
7. **高级筛选**: 支持更多筛选条件组合
