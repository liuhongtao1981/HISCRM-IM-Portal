# HisCrm-IM 系统文档快速参考

**版本**: 1.0.0 | **日期**: 2025-10-18 | **打印友好**: ✅

---

## 📋 文档清单

| # | 文件名 | 大小 | 模块 | 重点 |
|---|--------|------|------|------|
| 0 | 00-系统文档总索引.md | 导航 | 全局 | 📍 从这里开始 |
| 1 | 01-ADMIN-WEB-系统文档.md | 完整 | Admin | 前端UI和通信 |
| 2 | 02-MASTER-系统文档.md | 完整 | Master | 数据库和调度 |
| 3 | 03-WORKER-系统文档-第一部分.md | 上 | Worker | 架构和平台系统 |
| 4 | 04-WORKER-系统文档-第二部分.md | 下 | Worker | 任务和部署 |
| 📄 | 快速参考-系统文档.md | 本文 | 全局 | 速查表 |

---

## 🎯 按使用场景查找

### 我是新开发者

```
1. 阅读系统架构 (15分钟)
   → 00-系统文档总索引.md → 架构部分

2. 跟踪账户登录流程 (20分钟)
   → 00-系统文档总索引.md → 通信流程图

3. 本地部署系统 (30分钟)
   → 各模块的"部署说明"章节

4. 运行第一个测试 (15分钟)
   → Admin Web 界面 http://localhost:3001
```

**总耗时**: 约 1.5 小时

---

### 我需要修复一个 Bug

```
步骤 1: 确定 Bug 所在模块
  Bug 在前端UI? → Admin Web 文档
  Bug 在中间协调? → Master 文档
  Bug 在浏览器自动化? → Worker 文档

步骤 2: 找到相关代码
  查阅文档的"关键代码位置"或"目录结构"

步骤 3: 理解相关流程
  查阅文档的"业务流程"或"数据流"部分

步骤 4: 修复并测试
  参考文档的"错误处理"或"常见问题"
```

---

### 我需要添加一个新功能

```
功能是 UI 新增?
  → Admin Web 文档 → 页面说明

功能是数据存储?
  → Master 文档 → 数据库设计

功能是支持新平台?
  → Worker 文档 → 平台系统

功能是支持新爬虫?
  → Worker 文档 → MonitorTask 监控任务
```

---

### 我需要部署到生产环境

```
1. Master 部署 (5分钟)
   pm2 start packages/master/src/index.js --name "hiscrm-master"

2. Worker 部署 (10分钟)
   pm2 start packages/worker/src/index.js \
     --env WORKER_ID=worker-1 \
     --env PORT=4000

3. Admin Web 部署 (5分钟)
   npm run build
   部署到 Web 服务器或 Electron

4. 验证系统 (5分钟)
   curl http://master-ip:3000/health
```

**详见**: 各文档的"部署说明"章节

---

## 🏗️ 系统架构一览

```
┌─────────────────────────────────┐
│    Admin Web (React 3001)        │
│  ┌─────────────────────────────┐ │
│  │ • 账户管理                   │ │
│  │ • 登录管理 (二维码)          │ │
│  │ • 消息查看 (评论/私信)       │ │
│  │ • Worker 管理                │ │
│  │ • 代理配置                   │ │
│  └─────────────────────────────┘ │
└──────────────┬────────────────────┘
               │ Socket.IO /admin
               │ HTTP REST /api/v1
               │
┌──────────────▼────────────────────┐
│   Master (Node.js 3000)           │
│  ┌─────────────────────────────┐  │
│  │ • Socket.IO 三向通信        │  │
│  │   - /worker (Worker通信)    │  │
│  │   - /admin (Admin通信)      │  │
│  │   - /client (客户端通知)    │  │
│  │                             │  │
│  │ • Worker 生命周期管理       │  │
│  │   - 注册、心跳、离线检测    │  │
│  │   - 账户分配、任务调度      │  │
│  │                             │  │
│  │ • 登录会话协调              │  │
│  │   - 二维码流程              │  │
│  │   - Cookie 保存             │  │
│  │                             │  │
│  │ • SQLite 数据库             │  │
│  │   - 8 个核心表              │  │
│  └─────────────────────────────┘  │
└──────────────┬────────────────────┘
               │ Socket.IO /worker
               │
    ┌──────────┼──────────┐
    │          │          │
┌───▼──────┐ ┌─▼──────┐ ┌─▼──────┐
│ Worker 1 │ │Worker 2│ │Worker N│
│(4000)    │ │(4001)  │ │(400N)  │
└───┬──────┘ └─┬──────┘ └─┬──────┘
    │          │          │
  Browser1  Browser3  Browser5
  Browser2  Browser4  Browser6

  (每 Browser = 1 Account)
  (每 Browser ~200MB 内存)
  (建议每 Worker 10 个账户)
```

---

## 📡 通信协议速查

### Socket.IO 三向通信

**Admin ↔ Master** (`/admin` 命名空间):
- Admin → Master: `master:login:start` (启动登录)
- Master → Admin: `login:qrcode:ready` (二维码就绪)
- Master → Admin: `login:success` (登录成功)
- Master → Admin: `notification:new` (新通知)

**Worker ↔ Master** (`/worker` 命名空间):
- Worker → Master: `worker:register` (注册)
- Worker → Master: `worker:heartbeat` (心跳)
- Worker → Master: `worker:login:qrcode` (发送二维码)
- Worker → Master: `worker:login:status` (登录状态)
- Worker → Master: `worker:message:detected` (监控数据)
- Master → Worker: `master:task:assign` (任务分配)
- Master → Worker: `master:login:start` (登录请求)

### HTTP REST API

**Base URL**: `http://localhost:3000/api/v1`

| Method | Path | 说明 |
|--------|------|------|
| GET | /accounts | 获取账户列表 |
| POST | /accounts | 创建账户 |
| PUT | /accounts/:id | 更新账户 |
| DELETE | /accounts/:id | 删除账户 |
| GET | /workers | Worker 列表 |
| GET | /comments | 评论列表 |
| GET | /direct-messages | 私信列表 |
| GET | /notifications | 通知列表 |

---

## 💾 数据库表速查

**Master SQLite 数据库** (`packages/master/data/master.db`):

| 表名 | 用途 | 关键字段 |
|------|------|---------|
| accounts | 账户信息 | id, platform, login_status, credentials |
| workers | Worker 节点 | id, status, assigned_accounts |
| login_sessions | 登录会话 | id, status, qr_code_data |
| comments | 评论 | id, account_id, content, detected_at |
| direct_messages | 私信 | id, account_id, content, direction |
| notifications | 通知 | id, type, title, is_sent |
| worker_configs | Worker 配置 | id, max_accounts, env_vars |
| worker_runtime | Worker 运行时 | id, process_id, status |

---

## 📁 关键文件位置

### Admin Web
```
packages/admin-web/
├── src/pages/AccountsPage.js           # 账户管理页
├── src/pages/MessageManagementPage.js  # 消息管理页
├── src/services/socketContext.js       # Socket 通信
└── src/services/api.js                 # HTTP API
```

### Master
```
packages/master/
├── src/communication/socket-server.js  # Socket 服务
├── src/socket/worker-namespace.js      # Worker 通信
├── src/socket/admin-namespace.js       # Admin 通信
├── src/scheduler/task-scheduler.js     # 任务调度
├── src/login/login-handler.js          # 登录处理
└── src/database/                       # 数据库 DAO
```

### Worker
```
packages/worker/
├── src/index.js                        # 入口
├── src/platform-manager.js             # 平台管理
├── src/platforms/base/                 # 平台基类
├── src/platforms/douyin/               # 抖音平台
├── src/browser/browser-manager-v2.js   # 多Browser管理
└── src/handlers/                       # 任务处理
```

---

## 🔑 核心概念解释

### 账户隔离 (Account Isolation)
每个账户使用独立的 Browser 进程，完全隔离数据和指纹。

```
Account A ──→ Browser 1 (独立进程)
Account B ──→ Browser 2 (独立进程)
Account C ──→ Browser 3 (独立进程)

优势:
✅ 100% 隔离，无关联风险
✅ 进程间无影响
✅ 持久化指纹

缺点:
❌ 每个 Browser ~200MB 内存
```

### 浏览器指纹 (Browser Fingerprint)
用户代理、视口、时区、WebGL 等 15+ 项指纹特征。

```
指纹保存: packages/worker/data/browser/worker-1/
         fingerprints/account-123_fingerprint.json

每次启动相同账户时:
1. 加载指纹文件
2. 应用到 Browser 启动参数
3. 保证一致性，通过反爬虫检测
```

### Cookie 存储 (Cookie Storage)
登录成功后保存 Cookie 和存储状态到本地文件。

```
保存位置: packages/worker/data/browser/worker-1/
         storage-states/account-123_storage.json

下次启动相同账户时:
1. 加载 Cookie 文件
2. 设置为 Browser 初始状态
3. 无需重新登录
4. 内存中也保存备份
```

### 任务调度 (Task Scheduling)
Master 定期检查并分配监控任务给 Worker。

```
TaskScheduler 每 30 秒执行一次:
1. 查询 login_status='logged_in' AND status='active' 的账户
2. 分配到对应的 Worker
3. Worker 创建 MonitorTask
4. MonitorTask 每 15-30 秒随机执行一次
```

### 心跳监控 (Heartbeat Monitoring)
Worker 定期发送心跳，Master 检测离线。

```
Worker 每 10 秒发送心跳
    ↓
Master 记录 last_heartbeat
    ↓
HeartbeatMonitor 每 15 秒检查
    ↓
如果 > 30 秒无心跳 → 标记为 offline
    ↓
撤销该 Worker 的所有任务
```

---

## ⚡ 性能指标参考

| 指标 | 值 | 说明 |
|------|-----|------|
| Browser 内存占用 | ~200MB | 单个 Browser 进程 |
| Browser 启动时间 | ~5s | 冷启动 |
| 每 Worker 建议账户数 | 10 | 内存和并发考虑 |
| 监控间隔 | 15-30s | 随机间隔，防止反爬 |
| 心跳间隔 | 10s | Worker 定期发送 |
| 任务调度间隔 | 30s | Master 定期分配 |
| Socket 重连延迟 | 1-5s | 指数退避 |
| 二维码有效期 | 5min | 登录会话超时 |
| Cookie 有效期 | 7 days | 默认值 |

---

## 🐛 常见问题速查

| 问题 | 原因 | 解决 |
|------|------|------|
| 登录卡在二维码 | Browser 启动失败 | `npx playwright install` |
| 连接不到 Master | Master 未运行 | `npm start` in master/ |
| 消息无法显示 | API 错误 | 检查 Master 日志 |
| 内存持续增长 | Browser 未关闭 | 重启 Worker |
| Worker 离线 | 心跳超时 | 检查网络连接 |
| 二维码显示错误 | 选择器过期 | 更新平台脚本 |
| 指纹被检测 | 指纹不稳定 | 检查指纹文件 |
| 代理连接失败 | 代理配置错误 | 检查代理服务器 |

---

## 🚀 快速启动命令

```bash
# 安装依赖
npm install

# 启动 Master
cd packages/master && npm start &

# 启动 Worker 1
cd packages/worker && WORKER_ID=worker-1 PORT=4000 npm start &

# 启动 Worker 2
cd packages/worker && WORKER_ID=worker-2 PORT=4001 npm start &

# 启动 Admin Web
cd packages/admin-web && npm start &

# 验证
curl http://localhost:3000/health     # Master
curl http://localhost:3001            # Admin Web
tail -f packages/master/logs/*.log     # 查看日志
```

---

## 📞 获取帮助

| 需求 | 资源 |
|------|------|
| 系统架构 | 00-系统文档总索引.md |
| Admin Web 前端 | 01-ADMIN-WEB-系统文档.md |
| Master 后端 | 02-MASTER-系统文档.md |
| Worker 爬虫 | 03/04-WORKER-系统文档.md |
| 快速开始 | QUICKSTART.md |
| API 文档 | 各模块文档的"API"章节 |
| 故障排查 | 各模块文档的"常见问题"章节 |

---

## 📊 文档更新历史

| 日期 | 版本 | 更新内容 |
|------|------|---------|
| 2025-10-18 | 1.0.0 | 初版发布，包含 Admin/Master/Worker 完整文档 |

---

**✅ 任务完成**: 系统文档归档完成！

📚 **四个核心文档**:
- 00-系统文档总索引.md (导航)
- 01-ADMIN-WEB-系统文档.md (前端)
- 02-MASTER-系统文档.md (后端)
- 03/04-WORKER-系统文档.md (爬虫)

📄 **快速参考**:
- 快速参考-系统文档.md (本文)

🎯 **从这里开始**: [00-系统文档总索引.md](00-系统文档总索引.md)
