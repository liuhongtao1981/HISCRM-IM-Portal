# 共享路径配置系统

## 🎯 概述

为了解决路径配置的分散问题，系统实现了统一的共享路径配置模块，确保 Master 和 Worker 都能通过同一个配置源获取关键路径信息，避免路径硬编码带来的维护困难。

---

## 📦 核心文件

### 1. 共享配置模块
**文件**: `packages/shared/config/paths.js`

```javascript
/**
 * 所有路径配置（相对于项目根目录）
 */
const PATHS = {
  // 项目根目录
  project_root: PROJECT_ROOT,

  // Master 相关
  master: {
    src: path.join(PROJECT_ROOT, 'packages/master/src'),
    data: path.join(PROJECT_ROOT, 'packages/master/data'),
    logs: path.join(PROJECT_ROOT, 'packages/master/logs'),
    database: path.join(PROJECT_ROOT, 'packages/master/data/master.db'),
  },

  // Worker 相关
  worker: {
    src: path.join(PROJECT_ROOT, 'packages/worker/src'),
    data: path.join(PROJECT_ROOT, 'packages/worker/data'),
    logs: path.join(PROJECT_ROOT, 'packages/worker/logs'),
    // ⭐ 关键：平台目录的统一配置
    platforms: path.join(PROJECT_ROOT, 'packages/worker/src/platforms'),
  },

  // 其他相关
  admin: { /* ... */ },
  shared: { /* ... */ },
  docs: { /* ... */ },
};
```

**特点**:
- ✅ 所有路径都相对于项目根目录计算
- ✅ 自动计算 `PROJECT_ROOT` (从 packages/shared/config 向上4层)
- ✅ 包含辅助函数: `validatePath()`, `getRelativePath()`
- ✅ 一处定义，全局使用

---

## 🔌 集成点

### Master 端 - 平台 API 路由
**文件**: `packages/master/src/api/routes/platforms.js`

```javascript
// ✅ 导入共享配置
const { PATHS } = require('@hiscrm-im/shared/config/paths');

/**
 * 从文件系统扫描所有可用的平台
 */
function scanAvailablePlatforms() {
  const platformsSet = new Map();

  try {
    // ✅ 使用共享配置中的平台路径
    const platformsDir = PATHS.worker.platforms;

    logger.debug(`Scanning platforms directory: ${platformsDir}`);

    if (!fs.existsSync(platformsDir)) {
      logger.warn(`Worker platforms directory not found at: ${platformsDir}`);
      return platformsSet;
    }

    // ... 扫描目录和加载 config.json
  }
}
```

**改进**:
- 之前: 使用相对路径 `path.join(__dirname, '../../../../../...')`
- 现在: 使用共享配置 `PATHS.worker.platforms`
- 优势: 路径计算统一、维护更容易、不易出错

---

### Worker 端 - 平台管理器
**文件**: `packages/worker/src/platform-manager.js`

```javascript
// ✅ 导入共享配置
const { PATHS } = require('@hiscrm-im/shared/config/paths');

class PlatformManager {
  /**
   * 自动扫描并加载平台脚本
   * 使用共享的路径配置确保 Master 和 Worker 使用相同的平台目录
   */
  async loadPlatforms() {
    // ✅ 使用共享配置而不是硬编码
    const platformsDir = PATHS.worker.platforms;

    try {
      const entries = fs.readdirSync(platformsDir, { withFileTypes: true });

      for (const entry of entries) {
        // ... 加载平台
      }
    }
  }
}
```

**改进**:
- 之前: `const platformsDir = path.join(__dirname, 'platforms');`
- 现在: `const platformsDir = PATHS.worker.platforms;`
- 优势: 与 Master 使用完全相同的路径配置

---

## 🏗️ 系统架构

```
┌─────────────────────────────────────────┐
│      Shared Path Configuration          │
│  packages/shared/config/paths.js        │
│                                         │
│  const PATHS = {                        │
│    worker: {                            │
│      platforms: '/full/path/...'        │
│    }                                    │
│  }                                      │
└─────────────────────────────────────────┘
              ▲                ▲
              │                │
              ├────────────────┤
              │                │
              │                │
    ┌─────────┴───────┐   ┌───┴──────────┐
    │   Master        │   │   Worker     │
    │                 │   │              │
    │ platforms.js    │   │ platform-    │
    │ 扫描平台        │   │ manager.js   │
    │                 │   │ 加载平台     │
    └─────────────────┘   └──────────────┘
```

---

## 📊 改进对比

### 修改前 - 分散的路径配置

| 组件 | 路径定义方式 | 问题 |
|------|-----------|------|
| Master platforms.js | 复杂相对路径计算 | ❌ 容易出错，难以维护 |
| Worker platform-manager.js | 简单相对路径 | ❌ 与 Master 不一致 |
| Admin Web | 硬编码 API 地址 | ❌ 无法共享配置 |

### 修改后 - 统一的共享配置

| 组件 | 路径定义方式 | 优点 |
|------|-----------|------|
| Master platforms.js | 共享配置 `PATHS.worker.platforms` | ✅ 统一、清晰、易维护 |
| Worker platform-manager.js | 共享配置 `PATHS.worker.platforms` | ✅ 完全一致 |
| Admin Web | 通过 Master API 动态获取 | ✅ 无需关心路径 |

---

## 🎯 关键改进点

### 1. 单一数据源 (Single Source of Truth)
```javascript
// ❌ 修改前：每个地方都需要定义路径
// Master: path.join(__dirname, '../../../../../...')
// Worker: path.join(__dirname, 'platforms')

// ✅ 修改后：统一使用共享配置
// Master: PATHS.worker.platforms
// Worker: PATHS.worker.platforms
```

### 2. 路径计算集中化
```javascript
// ✅ packages/shared/config/paths.js
function getProjectRoot() {
  // 自动计算项目根目录
  return path.resolve(__dirname, '../../../');
}

const PROJECT_ROOT = getProjectRoot();

const PATHS = {
  worker: {
    platforms: path.join(PROJECT_ROOT, 'packages/worker/src/platforms'),
  }
};
```

### 3. 可扩展的配置结构
```javascript
// ✅ 已支持的路径
PATHS.master.database
PATHS.master.logs
PATHS.worker.platforms
PATHS.worker.data
PATHS.shared.utils

// ✅ 未来可添加
PATHS.worker.cache
PATHS.worker.screenshots
PATHS.admin.uploads
```

---

## 🚀 如何使用

### 在任何模块中导入共享配置

```javascript
// ✅ 导入
const { PATHS, getProjectRoot, validatePath } =
  require('@hiscrm-im/shared/config/paths');

// ✅ 使用平台目录
const platformsDir = PATHS.worker.platforms;

// ✅ 使用数据库路径
const dbPath = PATHS.master.database;

// ✅ 验证路径是否存在
validatePath('platforms', PATHS.worker.platforms);

// ✅ 获取项目根目录
const rootDir = getProjectRoot();

// ✅ 获取相对路径
const relativePath = getRelativePath(PATHS.worker.platforms);
```

---

## 📝 修改清单

| 文件 | 改动 | 目的 |
|------|------|------|
| `packages/shared/config/paths.js` | 新建 | 统一路径配置 |
| `packages/master/src/api/routes/platforms.js` | 导入 PATHS，更新 scanAvailablePlatforms() | 使用共享配置 |
| `packages/worker/src/platform-manager.js` | 导入 PATHS，更新 loadPlatforms() | 使用共享配置 |

---

## ✨ 后续扩展建议

### 1. 环境特定配置
```javascript
// 可在共享配置中添加环境感知
const PATHS = {
  isDevelopment: process.env.NODE_ENV !== 'production',
  isProduction: process.env.NODE_ENV === 'production',

  // 根据环境使用不同的配置
  database: process.env.NODE_ENV === 'production'
    ? '/var/data/master.db'
    : path.join(PROJECT_ROOT, 'packages/master/data/master.db'),
};
```

### 2. 配置验证
```javascript
// 启动时验证所有关键路径
function validateAllPaths() {
  const criticalPaths = [
    PATHS.worker.platforms,
    PATHS.master.database,
  ];

  criticalPaths.forEach(p => validatePath(p));
}
```

### 3. 动态路径注册
```javascript
// 允许运行时注册新路径
PATHS.register('cache', path.join(PROJECT_ROOT, '.cache'));
```

---

## 🔄 测试验证

### 1. 验证 Master 能正确扫描平台

```bash
# 启动 Master
cd packages/master
npm start

# 查看日志
# 应该看到类似的输出：
# Scanning platforms directory: /full/path/to/packages/worker/src/platforms
# Found 2 entries in platforms directory
# Found platform: douyin (抖音)
# Found platform: xiaohongshu (小红书)
```

### 2. 验证 Worker 能正确加载平台

```bash
# 启动 Worker
cd packages/worker
npm start

# 查看日志
# 应该看到类似的输出：
# ✓ Loaded platform: 抖音 (douyin) v1.0.0
# ✓ Loaded platform: 小红书 (xiaohongshu) v1.0.0
# Platform manager initialized with 2 platforms
```

### 3. 验证 Admin Web 显示正确的平台列表

```bash
# 启动 Admin Web
cd packages/admin-web
npm start

# 打开 http://localhost:3001/accounts
# 点击"新建账户"
# 验证平台下拉框显示：
# - 抖音
# - 小红书
# 都应该出现！
```

---

## 💡 技术细节

### 路径计算过程

```
packages/shared/config/paths.js 的位置:
e:\HISCRM-IM-main\packages\shared\config\paths.js

__dirname = e:\HISCRM-IM-main\packages\shared\config

path.resolve(__dirname, '../../../') 计算:
  ../config → e:\HISCRM-IM-main\packages\shared
  ../shared → e:\HISCRM-IM-main\packages
  ../packages → e:\HISCRM-IM-main

PROJECT_ROOT = e:\HISCRM-IM-main

PATHS.worker.platforms =
  path.join(PROJECT_ROOT, 'packages/worker/src/platforms')
  = e:\HISCRM-IM-main\packages\worker\src\platforms
```

### 为什么需要共享配置？

1. **一致性**: Master 和 Worker 必须访问相同的平台目录
2. **可维护性**: 如果目录结构改变，只需修改一处
3. **可测试性**: 易于在测试时替换路径
4. **可扩展性**: 未来可添加更多配置选项

---

## 📚 相关文档

- [12-多平台动态配置实现.md](./12-多平台动态配置实现.md) - 动态平台加载方案
- [13-多平台动态配置修复.md](./13-多平台动态配置修复.md) - 文件系统扫描修复

---

## ✅ 完成清单

- ✅ 创建共享路径配置模块 (`packages/shared/config/paths.js`)
- ✅ 更新 Master 平台 API 使用共享配置
- ✅ 更新 Worker 平台管理器使用共享配置
- ✅ 验证 Master 和 Worker 使用一致的路径
- ✅ 创建此文档说明架构改进

---

**完成日期**: 2025-10-20
**方案**: 共享路径配置系统
**状态**: ✅ 实现完成

系统现在通过单一的共享路径配置，确保 Master 和 Worker 都能正确发现和加载平台，路径不再分散，维护更加简单！
