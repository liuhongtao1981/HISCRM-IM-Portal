# 浏览器指纹隔离技术文档

**版本**: 1.0.0
**最后更新**: 2025-10-13

---

## 📋 目录

- [指纹识别原理](#指纹识别原理)
- [当前架构的指纹隔离情况](#当前架构的指纹隔离情况)
- [指纹随机化实现](#指纹随机化实现)
- [测试验证](#测试验证)
- [最佳实践](#最佳实践)

---

## 指纹识别原理

### 什么是浏览器指纹?

浏览器指纹是通过收集浏览器和设备的各种特征信息,生成一个唯一标识符来追踪用户的技术。

###常见的指纹类型

| 指纹类型 | 采集方式 | 唯一性 | 难度 |
|---------|---------|--------|------|
| **Canvas指纹** | 画布渲染差异 | 极高 | 高 |
| **WebGL指纹** | GPU渲染信息 | 极高 | 高 |
| **AudioContext指纹** | 音频处理差异 | 高 | 中 |
| **字体指纹** | 系统字体列表 | 中 | 低 |
| **User-Agent** | 浏览器标识 | 低 | 低 |
| **屏幕分辨率** | screen对象 | 低 | 低 |
| **硬件信息** | CPU核心数/内存 | 中 | 中 |

---

## 当前架构的指纹隔离情况

### ✅ 完全隔离的指纹 (BrowserContext天然支持)

```
Worker-1 进程
    │
    └── Browser实例
            │
            ├── Context-1 (account-123)
            │   ├── ✅ Cookies          ← 完全独立
            │   ├── ✅ LocalStorage     ← 完全独立
            │   ├── ✅ SessionStorage   ← 完全独立
            │   ├── ✅ IndexedDB        ← 完全独立
            │   ├── ✅ User-Agent       ← 可独立配置
            │   ├── ✅ Viewport         ← 可独立配置
            │   ├── ✅ Proxy            ← 可独立配置
            │   └── ✅ Locale/Timezone  ← 可独立配置
            │
            └── Context-2 (account-456)
                └── ... (同上)
```

**说明**: 这些指纹信息在Playwright的BrowserContext中是**天然隔离**的,每个Context互不影响。

---

### ⚠️ 共享的指纹 (需要额外处理)

```
Worker-1 进程
    │
    └── Browser实例
            │
            ├── ❌ WebGL指纹          ← 所有Context共享
            ├── ❌ Canvas指纹         ← 所有Context共享
            ├── ❌ AudioContext指纹   ← 所有Context共享
            ├── ❌ 硬件信息           ← 所有Context共享
            ├── ❌ 字体列表           ← 所有Context共享
            └── ❌ 屏幕信息           ← 所有Context共享
```

**风险**: 高级指纹检测(如FingerprintJS)会识别出这些Context来自同一Browser实例!

---

## 指纹随机化实现

### 架构方案

我们采用**指纹随机化**方案,为每个BrowserContext注入不同的指纹特征:

```javascript
// 为每个账户生成一致性的随机指纹
FingerprintRandomizer.applyRandomFingerprint(context, accountId);
```

### 核心机制

#### 1. 一致性随机化

使用账户ID作为随机种子,确保同一账户每次生成相同的指纹:

```javascript
const seed = hashString(accountId);  // account-123 → 固定种子
const random = seededRandom(seed);   // 基于种子的随机数生成器

// 结果: 同一账户总是生成相同的指纹特征
```

**优势**:
- ✅ 每个账户有稳定的指纹,不会频繁变化
- ✅ 避免因指纹变化触发平台风控
- ✅ 便于问题追踪和重现

---

#### 2. Canvas指纹随机化

```javascript
// 原理: 在toDataURL输出时添加微小噪声
const originalToDataURL = HTMLCanvasElement.prototype.toDataURL;
HTMLCanvasElement.prototype.toDataURL = function(...args) {
  const dataURL = originalToDataURL.apply(this, args);
  // 改变Base64末尾3个字符
  return dataURL.slice(0, -3) + 'AbC';  // 每个账户不同
};
```

**效果**: 每个Context的Canvas渲染结果看起来不同

---

#### 3. WebGL指纹随机化

```javascript
// 原理: 伪造GPU信息
WebGLRenderingContext.prototype.getParameter = function(parameter) {
  if (parameter === 37445) { // UNMASKED_VENDOR_WEBGL
    return 'NVIDIA Corporation';  // 账户1
    // or 'Intel Inc.'            // 账户2
    // or 'AMD'                   // 账户3
  }
  if (parameter === 37446) { // UNMASKED_RENDERER_WEBGL
    return 'ANGLE (NVIDIA GeForce GTX 1660 Ti)';  // 随机
  }
  return getParameter.call(this, parameter);
};
```

**效果**: 每个Context看起来使用不同的GPU

---

#### 4. AudioContext指纹随机化

```javascript
// 原理: 添加微小的频率偏移
AudioContext.prototype.createOscillator = function() {
  const oscillator = originalCreateOscillator.call(this);
  oscillator.start = function(...args) {
    this.frequency.value += 0.0003;  // 账户1: +0.0003Hz
    // 账户2: -0.0002Hz
    // 账户3: +0.0005Hz
    return originalStart.apply(this, args);
  };
  return oscillator;
};
```

**效果**: 音频处理特征略有不同

---

#### 5. 硬件信息随机化

```javascript
// CPU核心数
Object.defineProperty(navigator, 'hardwareConcurrency', {
  get: () => 8  // 账户1: 8核
  // 账户2: 6核
  // 账户3: 12核
});

// 内存大小
Object.defineProperty(navigator, 'deviceMemory', {
  get: () => 16  // 账户1: 16GB
  // 账户2: 8GB
  // 账户3: 32GB
});
```

**效果**: 每个Context看起来来自不同配置的设备

---

#### 6. 屏幕分辨率随机化

```javascript
Object.defineProperty(screen, 'width', {
  get: () => 1920  // 账户1: 1920x1080
  // 账户2: 2560x1440
  // 账户3: 3840x2160
});
Object.defineProperty(screen, 'height', {
  get: () => 1080
});
```

**效果**: 每个Context看起来使用不同的显示器

---

### 随机化的指纹特征列表

| 指纹特征 | 随机化方式 | 一致性 | 效果 |
|---------|-----------|--------|------|
| Canvas | Base64末尾噪声 | ✅ 基于accountId | 不同 |
| WebGL Vendor | 从预定义列表选择 | ✅ 基于accountId | 不同 |
| WebGL Renderer | 从预定义列表选择 | ✅ 基于accountId | 不同 |
| Audio | 频率微调 | ✅ 基于accountId | 不同 |
| CPU核心数 | 4/6/8/12/16 | ✅ 基于accountId | 不同 |
| 设备内存 | 4/8/16/32GB | ✅ 基于accountId | 不同 |
| 屏幕宽度 | 1920/2560/3840 | ✅ 基于accountId | 不同 |
| 屏幕高度 | 1080/1440/2160 | ✅ 基于accountId | 不同 |
| 电池状态 | 电量/充电状态 | ✅ 基于accountId | 不同 |

---

## 测试验证

### 方法1: FingerprintJS测试

```javascript
// 在页面中运行
import FingerprintJS from '@fingerprintjs/fingerprintjs';

const fp = await FingerprintJS.load();
const result = await fp.get();

console.log('Visitor ID:', result.visitorId);
console.log('Components:', result.components);
```

**预期结果**: 不同Context产生不同的visitorId

---

### 方法2: CreepJS测试

访问: https://abrahamjuliot.github.io/creepjs/

**检测项目**:
- Canvas指纹
- WebGL指纹
- AudioContext指纹
- 字体指纹
- 屏幕指纹
- 硬件指纹

**预期结果**: 不同Context显示不同的指纹特征

---

### 方法3: BrowserLeaks测试

访问: https://browserleaks.com/

**检测页面**:
- Canvas: https://browserleaks.com/canvas
- WebGL: https://browserleaks.com/webgl
- Audio: https://browserleaks.com/audio
- Fonts: https://browserleaks.com/fonts

**预期结果**: 每个Context的测试结果不同

---

## 指纹隔离效果评估

### 隔离级别对比

| 方案 | 隔离效果 | 资源占用 | 实现难度 | 推荐度 |
|------|---------|---------|---------|--------|
| **每账户1个Browser** | ⭐⭐⭐⭐⭐ | 极高(2GB+) | 低 | ❌ 不推荐 |
| **Context + 指纹随机化** | ⭐⭐⭐⭐ | 低(300MB) | 中 | ✅ **推荐** |
| **仅Context隔离** | ⭐⭐ | 低(300MB) | 低 | ⚠️ 风险高 |

---

### 当前方案的优势

| 维度 | 说明 | 对比 |
|------|------|------|
| **资源效率** | 1个Browser + 多Context | 比每账户1个Browser节省85%内存 |
| **指纹隔离** | 随机化8+种指纹特征 | 能应对大部分指纹检测 |
| **一致性** | 基于accountId的稳定指纹 | 不会因指纹变化触发风控 |
| **可维护性** | 集中管理,易于调试 | 比多Browser方案简单 |

---

## 最佳实践

### 1. 何时使用指纹随机化?

✅ **推荐使用**:
- 需要同时监控多个账户
- 需要避免指纹关联
- 资源有限(内存/CPU)

⚠️ **不推荐**:
- 仅监控1-2个账户 (直接用原生指纹即可)
- 平台对指纹非常敏感 (考虑每账户独立Browser)

---

### 2. 指纹随机化配置

```javascript
// 启用指纹随机化(默认)
const browserManager = new BrowserManager(WORKER_ID, {
  enableFingerprint: true  // 默认启用
});

// 禁用指纹随机化(不推荐)
const browserManager = new BrowserManager(WORKER_ID, {
  enableFingerprint: false
});
```

---

### 3. 监控指纹关联

定期检查是否有账户因指纹关联被封禁:

```javascript
// 记录指纹特征
logger.info('Fingerprint applied', {
  accountId,
  webglVendor: 'NVIDIA',
  hardwareConcurrency: 8,
  screenWidth: 1920
});

// 监控账户状态
if (account.status === 'banned') {
  logger.warn('Account banned, check fingerprint correlation', {
    accountId,
    fingerprintHash
  });
}
```

---

### 4. 指纹检测应对策略

| 检测强度 | 应对策略 | 实施 |
|---------|---------|------|
| **低** (基础检测) | Context隔离 | ✅ 已实施 |
| **中** (FingerprintJS) | 指纹随机化 | ✅ 已实施 |
| **高** (CreepJS) | 深度随机化 | ✅ 已实施 |
| **极高** (AI检测) | 每账户独立Browser | ⚠️ 可选 |

---

## 进一步优化建议

### 优先级: LOW (按需实施)

#### 1. 字体指纹随机化

```javascript
// 伪造字体列表
Object.defineProperty(document, 'fonts', {
  get: () => ({
    check: (font) => randomFontList.includes(font),
    // ... 其他方法
  })
});
```

#### 2. WebRTC IP泄露防护

```javascript
// 禁用WebRTC或使用虚假IP
const originalRTCPeerConnection = window.RTCPeerConnection;
window.RTCPeerConnection = function(...args) {
  const pc = new originalRTCPeerConnection(...args);
  // 过滤ICE候选,移除真实IP
  return pc;
};
```

#### 3. 时区随机化

```javascript
// 伪造时区
Date.prototype.getTimezoneOffset = function() {
  return -480; // 账户1: UTC+8
  // 账户2: UTC+0
  // 账户3: UTC-5
};
```

---

## 相关文档

- [BrowserManager实现](./packages/worker/src/browser/browser-manager.js)
- [FingerprintRandomizer实现](./packages/worker/src/browser/fingerprint-randomizer.js)
- [README - Worker数据隔离机制](./README.md#worker数据隔离机制)

---

## 参考资源

- [FingerprintJS](https://github.com/fingerprintjs/fingerprintjs)
- [CreepJS](https://github.com/abrahamjuliot/creepjs)
- [BrowserLeaks](https://browserleaks.com/)
- [Playwright BrowserContext API](https://playwright.dev/docs/api/class-browsercontext)

---

**文档版本**: 1.0.0
**最后更新**: 2025-10-13
**维护者**: 开发团队
