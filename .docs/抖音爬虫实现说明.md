# 抖音爬虫实现说明

## 概述

抖音平台爬虫采用**混合策略**：模拟真实用户操作 + API拦截获取数据，兼顾隐蔽性和准确性。

## 核心策略

### 1. 模拟真实用户行为
- 使用 Playwright 浏览器自动化
- 导航到真实页面（评论管理/私信管理）
- 随机延迟模拟人类操作
- 滚动页面触发懒加载

### 2. API 拦截获取数据
- 使用 `page.route()` 拦截网络请求
- 捕获后端API返回的JSON数据
- 不阻断请求，保持页面正常运行
- 自动获取所有 Cookie 和认证 Token

### 3. 双重保障机制
- 优先使用API拦截的数据（结构化、准确）
- 如果API未触发，回退到DOM元素提取
- 确保在任何情况下都能获取数据

## 技术实现

### 评论爬取流程

```javascript
async crawlComments(account) {
  // 1. 创建页面
  const page = await this.getOrCreatePage(account.id);

  // 2. 设置API拦截器
  const apiResponses = [];
  await page.route('**/comment/list/select/**', async (route) => {
    const response = await route.fetch();
    const body = await response.json();
    apiResponses.push(body);
    await route.fulfill({ response });
  });

  // 3. 导航到评论管理页面
  await this.navigateToCommentManage(page);
  // URL: https://creator.douyin.com/creator-micro/interactive/comment

  // 4. 滚动页面触发API
  await this.scrollPageToLoadMore(page);

  // 5. 解析API数据
  const comments = this.parseCommentsFromAPI(apiResponses);

  // 6. 如果没有数据，回退到DOM提取
  if (comments.length === 0) {
    const domComments = await this.extractComments(page);
    comments.push(...domComments);
  }

  return { comments, stats: { recent_comments_count: comments.length } };
}
```

### 私信爬取流程

```javascript
async crawlDirectMessages(account) {
  // 1. 创建页面
  const page = await this.getOrCreatePage(account.id);

  // 2. 设置API拦截器
  const apiResponses = [];
  await page.route('**/message/get_by_user_init**', async (route) => {
    const response = await route.fetch();
    const body = await response.json();
    apiResponses.push(body);
    await route.fulfill({ response });
  });

  // 3. 导航到私信管理页面
  await this.navigateToMessageManage(page);
  // URL: https://creator.douyin.com/creator-micro/data/following/chat

  // 4. 滚动页面触发API
  await this.scrollPageToLoadMore(page);

  // 5. 解析API数据
  const messages = this.parseMessagesFromAPI(apiResponses);

  // 6. 如果没有数据，回退到DOM提取
  if (messages.length === 0) {
    const domMessages = await this.extractDirectMessages(page);
    messages.push(...domMessages);
  }

  return { directMessages: messages, stats: { recent_dms_count: messages.length } };
}
```

## 关键API端点

### 评论API
- **URL**: `/web/api/third_party/aweme/api/comment/read/aweme/v1/web/comment/list/select/`
- **参数**:
  - `aweme_id`: 视频ID
  - `cursor`: 分页游标
  - `count`: 每页数量（默认10）
  - `comment_select_options`: 筛选选项
  - `sort_options`: 排序选项
- **响应结构**:
```json
{
  "status_code": 0,
  "comments": [
    {
      "cid": "评论ID",
      "text": "评论内容",
      "user": {
        "uid": "用户ID",
        "nickname": "用户昵称",
        "avatar_thumb": { "url_list": ["头像URL"] }
      },
      "create_time": 1234567890,
      "digg_count": 10,
      "reply_id": "回复的评论ID",
      "ip_label": "IP属地"
    }
  ],
  "cursor": 10,
  "has_more": true,
  "total": 100
}
```

### 私信API
- **URL**: `https://imapi.snssdk.com/v2/message/get_by_user_init`
- **响应结构**: (需要根据实际数据调整)
```json
{
  "data": {
    "conversations": [
      {
        "conversation_id": "会话ID",
        "user": {
          "uid": "用户ID",
          "nickname": "用户昵称"
        },
        "last_message": {
          "msg_id": "消息ID",
          "content": "消息内容",
          "create_time": 1234567890,
          "msg_type": "text"
        }
      }
    ]
  }
}
```

## 数据字段映射

### 评论数据
| 平台字段 | 系统字段 | 说明 |
|---------|---------|------|
| `cid` | `platform_comment_id` | 评论唯一ID |
| `text` | `content` | 评论内容 |
| `user.nickname` | `author_name` | 评论者昵称 |
| `user.uid` / `user.sec_uid` | `author_id` | 评论者ID |
| `user.avatar_thumb.url_list[0]` | `author_avatar` | 评论者头像 |
| `aweme_id` | `post_id` | 作品ID |
| `reply_id` | `reply_to_comment_id` | 回复的评论ID |
| `digg_count` | `like_count` | 点赞数 |
| `create_time` | `create_time` | 创建时间（秒级时间戳）|
| `ip_label` | `ip_label` | IP属地 |

### 私信数据
| 平台字段 | 系统字段 | 说明 |
|---------|---------|------|
| `msg_id` | `platform_message_id` | 消息唯一ID |
| `content` / `text` | `content` | 消息内容 |
| `user.nickname` | `sender_name` | 发送者昵称 |
| `user.uid` | `sender_id` | 发送者ID |
| `user.avatar_thumb.url_list[0]` | `sender_avatar` | 发送者头像 |
| `conversation_id` | `conversation_id` | 会话ID |
| `msg_type` | `message_type` | 消息类型 |
| `create_time` | `create_time` | 创建时间 |

## 辅助功能

### 页面滚动触发懒加载
```javascript
async scrollPageToLoadMore(page) {
  // 滚动到底部
  await page.evaluate(() => window.scrollTo(0, document.body.scrollHeight));
  await page.waitForTimeout(1000);

  // 滚动回顶部
  await page.evaluate(() => window.scrollTo(0, 0));
  await page.waitForTimeout(500);

  // 滚动到中间
  await page.evaluate(() => window.scrollTo(0, document.body.scrollHeight / 2));
  await page.waitForTimeout(500);
}
```

### DOM 元素提取（回退方案）
使用灵活的CSS选择器匹配动态类名：
```javascript
// 评论元素
'[class*="comment-item"], [class*="comment-list"] > div, .semi-table-row'

// 昵称
'[class*="nickname"], [class*="author"], [class*="username"]'

// 内容
'[class*="comment-content"], [class*="text-content"], [class*="content-text"]'

// 时间
'[class*="time"], [class*="date"], [class*="timestamp"]'
```

## 优势

### ✅ 隐蔽性强
- 模拟真实用户浏览器行为
- 自动携带所有认证信息（Cookie、Token）
- 不直接调用API，避免被检测

### ✅ 数据准确
- 直接获取后端API的结构化数据
- 无需解析复杂的DOM结构
- 字段映射清晰，便于维护

### ✅ 稳定可靠
- API拦截 + DOM提取双重保障
- 页面结构变化时仍能工作
- 错误处理完善，不会导致进程崩溃

### ✅ 易于扩展
- 新增API拦截只需添加 `page.route()`
- 数据解析逻辑独立，便于调整
- 支持分页和增量抓取

## 注意事项

### 1. API响应结构可能变化
- 需要根据实际响应调整 `parseCommentsFromAPI()` 和 `parseMessagesFromAPI()`
- 建议在测试环境先验证数据结构

### 2. 频率控制
- 已实现随机延迟（1-3秒）
- 建议设置合理的爬取间隔（15-30分钟）
- 避免短时间内大量请求

### 3. 认证有效期
- 依赖浏览器上下文的登录状态
- 需要定期检查登录状态
- Cookie过期时需要重新登录

### 4. 错误处理
- 网络超时：自动重试
- 页面加载失败：记录日志并跳过
- API拦截失败：回退到DOM提取

## 测试建议

### 单元测试
1. 测试API拦截器是否正确捕获请求
2. 测试数据解析是否正确映射字段
3. 测试DOM回退方案是否生效

### 集成测试
1. 使用真实账号测试完整爬取流程
2. 验证评论和私信数据的完整性
3. 测试多账号并发爬取的稳定性

### 性能测试
1. 测试单次爬取的耗时
2. 测试内存占用是否合理
3. 测试浏览器进程是否正常释放

## 未来优化方向

1. **增量抓取**: 只获取最新的评论/私信，避免重复
2. **智能分页**: 自动处理API的分页参数
3. **数据去重**: 基于 `platform_comment_id` 去重
4. **通知推送**: 新评论/私信实时推送到客户端
5. **情感分析**: 对评论内容进行情感分析
6. **关键词监控**: 监控敏感词并及时通知

## 相关文件

- 平台实现: `packages/worker/src/platforms/douyin/platform.js`
- 基类定义: `packages/worker/src/platforms/base/platform-base.js`
- 通信桥接: `packages/worker/src/platforms/base/worker-bridge.js`
- 配置文件: `packages/worker/src/platforms/douyin/config.json`

## 参考资料

- [Playwright API文档](https://playwright.dev/docs/api/class-page)
- [Playwright 网络拦截](https://playwright.dev/docs/network)
- [抖音创作者中心](https://creator.douyin.com/)
