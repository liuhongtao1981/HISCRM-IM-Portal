# ç›‘æ§åˆ·æ–°æ—¶é—´é…ç½®è¯´æ˜

**æœ€åæ›´æ–°**: 2025-10-13

---

## ğŸ¯ å¿«é€Ÿå›ç­”

### å½“å‰é…ç½®

| é¡¹ç›® | é»˜è®¤å€¼ | å¯é…ç½®èŒƒå›´ | è¯´æ˜ |
|------|--------|-----------|------|
| **è¯„è®ºåˆ·æ–°** | 30ç§’ | 10-300ç§’ | ä¸ç§ä¿¡ä½¿ç”¨ç›¸åŒé—´éš” |
| **ç§ä¿¡åˆ·æ–°** | 30ç§’ | 10-300ç§’ | ä¸è¯„è®ºä½¿ç”¨ç›¸åŒé—´éš” |

**å…³é”®ç‚¹**:
- âœ… è¯„è®ºå’Œç§ä¿¡**ä½¿ç”¨åŒä¸€ä¸ªåˆ·æ–°é—´éš”**ï¼ˆ`monitor_interval`ï¼‰
- âœ… æ¯æ¬¡åˆ·æ–°ä¼š**åŒæ—¶æ£€æµ‹**è¯„è®ºå’Œç§ä¿¡
- âœ… æ¯ä¸ªè´¦æˆ·å¯ä»¥**ç‹¬ç«‹é…ç½®**åˆ·æ–°é—´éš”

---

## ğŸ“Š è¯¦ç»†è¯´æ˜

### 1. é…ç½®ä½ç½®

#### æ•°æ®åº“é»˜è®¤å€¼
```sql
-- packages/master/src/database/schema.sql:15
CREATE TABLE IF NOT EXISTS accounts (
  ...
  monitor_interval INTEGER DEFAULT 30,  -- é»˜è®¤30ç§’
  ...
);
```

#### æ¨¡å‹é»˜è®¤å€¼
```javascript
// packages/shared/models/Account.js:73
this.monitor_interval = data.monitor_interval || 30;  // é»˜è®¤30ç§’
```

#### é™æµå™¨é»˜è®¤å€¼
```javascript
// packages/worker/src/handlers/rate-limiter.js:26
this.defaultInterval = 30;  // é»˜è®¤30ç§’é—´éš”
```

### 2. ç›‘æ§ä»»åŠ¡æ‰§è¡Œæµç¨‹

```javascript
// packages/worker/src/handlers/monitor-task.js:106-158

async execute() {
  // æ¯æ¬¡æ‰§è¡Œä¼šåŒæ—¶æ£€æµ‹è¯„è®ºå’Œç§ä¿¡

  // 1. çˆ¬å–è¯„è®º
  const rawComments = await this.crawler.crawlComments(this.account);

  // 2. è§£æè¯„è®º
  const parsedComments = this.commentParser.parse(rawComments);

  // 3. è¿‡æ»¤æ–°è¯„è®º
  const newComments = this.cacheHandler.filterNew(...);

  // 4. çˆ¬å–ç§ä¿¡ (åœ¨åŒä¸€æ¬¡æ‰§è¡Œä¸­)
  const rawDMs = await this.crawler.crawlDirectMessages(this.account);

  // 5. è§£æç§ä¿¡
  const parsedDMs = this.dmParser.parse(rawDMs);

  // 6. è¿‡æ»¤æ–°ç§ä¿¡
  const newDMs = this.cacheHandler.filterNew(...);

  // 7. ä¸ŠæŠ¥æ–°æ¶ˆæ¯
  if (newComments.length > 0 || newDMs.length > 0) {
    this.messageReporter.reportAll(this.account.id, {
      comments: newComments,
      directMessages: newDMs,
    });
  }
}
```

**æ‰§è¡Œç‰¹ç‚¹**:
- âœ… è¯„è®ºå’Œç§ä¿¡åœ¨**åŒä¸€æ¬¡å¾ªç¯**ä¸­æ£€æµ‹
- âœ… ä½¿ç”¨**ç›¸åŒçš„æ—¶é—´é—´éš”**
- âœ… ä¸€æ¬¡æ‰§è¡ŒåŒ…å«å®Œæ•´çš„æ£€æµ‹æµç¨‹

### 3. å®šæ—¶æ‰§è¡Œæœºåˆ¶

```javascript
// packages/worker/src/handlers/monitor-task.js:40-71

async start() {
  // ç«‹å³æ‰§è¡Œä¸€æ¬¡
  this.execute();

  // è®¾ç½®å®šæ—¶æ‰§è¡Œ
  const intervalMs = this.account.monitor_interval * 1000;  // è½¬æ¢ä¸ºæ¯«ç§’
  this.intervalId = setInterval(() => {
    this.execute();
  }, intervalMs);

  logger.info(`Monitor task started with ${this.account.monitor_interval}s interval`);
}
```

**ç¤ºä¾‹**: å¦‚æœ `monitor_interval = 30`
```
0ç§’:  æ‰§è¡Œä¸€æ¬¡ (ç«‹å³)
30ç§’: æ‰§è¡Œç¬¬äºŒæ¬¡
60ç§’: æ‰§è¡Œç¬¬ä¸‰æ¬¡
90ç§’: æ‰§è¡Œç¬¬å››æ¬¡
...
```

---

## âš™ï¸ é…ç½®æ–¹å¼

### 1. æ·»åŠ è´¦æˆ·æ—¶é…ç½®

#### Webç®¡ç†åå°
```javascript
// packages/admin-web/src/pages/AccountsPage.js:266
<Form.Item name="monitor_interval" label="ç›‘æ§é—´éš”ï¼ˆç§’ï¼‰" initialValue={30}>
  <Input type="number" placeholder="ç›‘æ§é—´éš”" />
</Form.Item>
```

#### æ¡Œé¢å®¢æˆ·ç«¯
```javascript
// packages/desktop-client/src/renderer/components/AddAccountDialog.jsx:134-138
<FormItem
  label="ç›‘æ§é—´éš”(ç§’)"
  name="monitor_interval"
  rules={[
    { required: true, message: 'è¯·è¾“å…¥ç›‘æ§é—´éš”' },
    { type: 'number', min: 10, max: 300, message: 'ç›‘æ§é—´éš”å¿…é¡»åœ¨10-300ç§’ä¹‹é—´' },
  ]}
>
  <Input type="number" placeholder="30" />
</FormItem>
```

### 2. æ›´æ–°è´¦æˆ·é…ç½®

#### APIæ–¹å¼
```bash
# PUT /api/accounts/:id
curl -X PUT http://localhost:3000/api/accounts/acc-123 \
  -H "Content-Type: application/json" \
  -d '{
    "monitor_interval": 60
  }'
```

#### ç¨‹åºå†…æ›´æ–°
```javascript
// packages/worker/src/handlers/monitor-task.js:165-178

updateAccount(updates) {
  const oldInterval = this.account.monitor_interval;

  Object.assign(this.account, updates);

  // å¦‚æœç›‘æ§é—´éš”æ”¹å˜,é‡å¯ä»»åŠ¡
  if (updates.monitor_interval && updates.monitor_interval !== oldInterval) {
    logger.info(`Restarting task due to interval change: ${oldInterval}s -> ${updates.monitor_interval}s`);

    this.stop().then(() => {
      this.start();
    });
  }
}
```

**ç‰¹ç‚¹**:
- âœ… æ”¯æŒåŠ¨æ€ä¿®æ”¹
- âœ… ä¿®æ”¹åè‡ªåŠ¨é‡å¯ä»»åŠ¡
- âœ… æ–°é—´éš”ç«‹å³ç”Ÿæ•ˆ

---

## ğŸ”’ é™åˆ¶å’ŒéªŒè¯

### 1. èŒƒå›´é™åˆ¶

#### æ¨¡å‹éªŒè¯
```javascript
// packages/shared/models/Account.js:105-107
if (this.monitor_interval < 10 || this.monitor_interval > 300) {
  errors.push('Monitor interval must be 10-300 seconds');
}
```

#### è¡¨å•éªŒè¯
```javascript
// packages/desktop-client/src/renderer/components/AddAccountDialog.jsx:138
{ type: 'number', min: 10, max: 300, message: 'ç›‘æ§é—´éš”å¿…é¡»åœ¨10-300ç§’ä¹‹é—´' }
```

### 2. é™åˆ¶è¯´æ˜

| é™åˆ¶ç±»å‹ | å€¼ | åŸå›  |
|---------|-----|------|
| **æœ€å°é—´éš”** | 10ç§’ | é˜²æ­¢é¢‘ç¹è¯·æ±‚è§¦å‘å¹³å°é™æµ |
| **æœ€å¤§é—´éš”** | 300ç§’(5åˆ†é’Ÿ) | ç¡®ä¿åŠæ—¶æ€§,é¿å…æ¶ˆæ¯å»¶è¿Ÿè¿‡å¤§ |
| **æ¨èå€¼** | 30ç§’ | å¹³è¡¡å®æ—¶æ€§å’Œèµ„æºæ¶ˆè€— |

### 3. å¹³å°é™æµä¿æŠ¤

```javascript
// packages/worker/src/handlers/rate-limiter.js

class RateLimiter {
  // é»˜è®¤30ç§’é—´éš”
  defaultInterval = 30;

  // æœ€å°é—´éš”10ç§’
  minInterval = 10;

  // æœ€å¤§é—´éš”300ç§’
  maxInterval = 300;

  // æ£€æµ‹åˆ°é™æµæ—¶è‡ªåŠ¨å¢åŠ é—´éš”
  async checkRateLimit(accountId, response) {
    if (this.isRateLimited(response)) {
      const currentInterval = this.intervals.get(accountId) || this.defaultInterval;
      const newInterval = Math.min(currentInterval * 2, this.maxInterval);

      this.updateInterval(accountId, newInterval);
      logger.warn(`Rate limited! Increased interval to ${newInterval}s`);
    }
  }
}
```

**è‡ªåŠ¨è°ƒæ•´é€»è¾‘**:
```
æ£€æµ‹åˆ°é™æµ â†’ é—´éš”ç¿»å€
30ç§’ â†’ 60ç§’ â†’ 120ç§’ â†’ 240ç§’ â†’ 300ç§’(æœ€å¤§)
        â†“
    æ¢å¤æ­£å¸¸ â†’ é€æ­¥é™ä½å›30ç§’
```

---

## ğŸ“ˆ å®æ—¶æ€§åˆ†æ

### ä¸åŒé—´éš”çš„æ•ˆæœ

| é—´éš” | å»¶è¿ŸèŒƒå›´ | èµ„æºå ç”¨ | é€‚ç”¨åœºæ™¯ |
|------|---------|---------|---------|
| **10ç§’** | 0-10ç§’ | é«˜ | é«˜ä»·å€¼è´¦æˆ·,éœ€è¦æå¿«å“åº” |
| **30ç§’** | 0-30ç§’ | ä¸­ | **æ¨è**,å¹³è¡¡å®æ—¶æ€§å’Œèµ„æº |
| **60ç§’** | 0-60ç§’ | ä½ | æ™®é€šè´¦æˆ·,å¯æ¥å—å»¶è¿Ÿ |
| **120ç§’** | 0-120ç§’ | å¾ˆä½ | ä½ä¼˜å…ˆçº§è´¦æˆ· |
| **300ç§’** | 0-300ç§’ | æä½ | å¤‡ç”¨è´¦æˆ·,ä»…éœ€å®šæœŸæ£€æŸ¥ |

### èµ„æºæ¶ˆè€—ä¼°ç®—

å‡è®¾10ä¸ªè´¦æˆ·:

| é—´éš” | æ¯å°æ—¶è¯·æ±‚æ¬¡æ•° | CPUå ç”¨ | å†…å­˜å ç”¨ |
|------|---------------|---------|---------|
| 10ç§’ | 36,000æ¬¡ | ~15% | ~2.5GB |
| 30ç§’ | 12,000æ¬¡ | ~8% | ~2.2GB |
| 60ç§’ | 6,000æ¬¡ | ~5% | ~2.1GB |

**è¯´æ˜**: å†…å­˜ä¸»è¦ç”±Browserè¿›ç¨‹å ç”¨(~200MB/è´¦æˆ·),ä¸é—´éš”å…³ç³»ä¸å¤§

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•1: éªŒè¯åˆ·æ–°é—´éš”

```javascript
// å¯åŠ¨WorkeråæŸ¥çœ‹æ—¥å¿—
Workerè¿›ç¨‹å¯åŠ¨:
âœ“ Browser manager initialized
âœ“ Task runner started

ç›‘æ§ä»»åŠ¡å¯åŠ¨ (account-123):
Monitor task started with 30s interval

æ‰§è¡Œæ—¥å¿—:
[10:00:00] Executing monitor task (count: 1) - ç«‹å³æ‰§è¡Œ
[10:00:30] Executing monitor task (count: 2) - 30ç§’å
[10:01:00] Executing monitor task (count: 3) - 60ç§’å
[10:01:30] Executing monitor task (count: 4) - 90ç§’å
```

### æµ‹è¯•2: ä¿®æ”¹åˆ·æ–°é—´éš”

```bash
# 1. åˆå§‹é…ç½®30ç§’
curl http://localhost:3000/api/accounts/acc-123
# è¿”å›: { "monitor_interval": 30 }

# 2. ä¿®æ”¹ä¸º60ç§’
curl -X PUT http://localhost:3000/api/accounts/acc-123 \
  -d '{"monitor_interval": 60}'

# 3. è§‚å¯Ÿæ—¥å¿—
Workeræ—¥å¿—:
Restarting task due to interval change: 30s -> 60s
Stopping monitor task for account acc-123
Monitor task stopped
Starting monitor task with 60s interval
Monitor task started with 60s interval
```

### æµ‹è¯•3: éªŒè¯åŒæ—¶æ£€æµ‹

```javascript
// æŸ¥çœ‹å•æ¬¡æ‰§è¡Œæ—¥å¿—
[10:00:00] Executing monitor task (count: 1)
[10:00:02] Crawling comments...
[10:00:05] Found 3 raw comments
[10:00:05] Parsing comments...
[10:00:05] Filtering new comments... (2 new)
[10:00:06] Crawling direct messages...  // â† åŒä¸€æ¬¡æ‰§è¡Œ
[10:00:08] Found 1 raw DM
[10:00:08] Parsing DMs...
[10:00:08] Filtering new DMs... (1 new)
[10:00:09] Reporting 2 comments and 1 DM
[10:00:09] Monitor execution completed
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. æ¨èé…ç½®

| è´¦æˆ·ç±»å‹ | æ¨èé—´éš” | åŸå›  |
|---------|---------|------|
| **VIPå®¢æˆ·** | 10-15ç§’ | éœ€è¦æå¿«å“åº” |
| **æ™®é€šè´¦æˆ·** | 30ç§’ | å¹³è¡¡å®æ—¶æ€§å’Œèµ„æº |
| **ä½ä¼˜å…ˆçº§** | 60-120ç§’ | é™ä½èµ„æºæ¶ˆè€— |
| **å¤‡ç”¨è´¦æˆ·** | 180-300ç§’ | ä»…å®šæœŸæ£€æŸ¥ |

### 2. æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### æ–¹æ¡ˆ1: åˆ†çº§ç›‘æ§
```javascript
// é«˜ä¼˜å…ˆçº§è´¦æˆ·: 10ç§’
account_vip.monitor_interval = 10;

// æ™®é€šè´¦æˆ·: 30ç§’
account_normal.monitor_interval = 30;

// ä½ä¼˜å…ˆçº§è´¦æˆ·: 60ç§’
account_low.monitor_interval = 60;
```

#### æ–¹æ¡ˆ2: åŠ¨æ€è°ƒæ•´
```javascript
// å·¥ä½œæ—¶é—´: 30ç§’
if (isBusinessHours()) {
  account.monitor_interval = 30;
}

// éå·¥ä½œæ—¶é—´: 120ç§’
else {
  account.monitor_interval = 120;
}
```

#### æ–¹æ¡ˆ3: æ™ºèƒ½é—´éš”
```javascript
// æ ¹æ®æ¶ˆæ¯é¢‘ç‡è‡ªåŠ¨è°ƒæ•´
if (highMessageRate) {
  // æ¶ˆæ¯é¢‘ç¹ â†’ ç¼©çŸ­é—´éš”
  account.monitor_interval = 15;
} else if (lowMessageRate) {
  // æ¶ˆæ¯ç¨€å°‘ â†’ å»¶é•¿é—´éš”
  account.monitor_interval = 60;
}
```

### 3. é¿å…çš„é…ç½®

âŒ **è¿‡å°çš„é—´éš” (<10ç§’)**
```javascript
// å±é™©! å¯èƒ½è§¦å‘å¹³å°é™æµ
account.monitor_interval = 5;  // âŒ ä¸æ¨è
```

âŒ **æ‰€æœ‰è´¦æˆ·ä½¿ç”¨ç›¸åŒçš„æœ€å°é—´éš”**
```javascript
// å±é™©! èµ„æºæ¶ˆè€—è¿‡å¤§
accounts.forEach(acc => {
  acc.monitor_interval = 10;  // âŒ ä¸æ¨è
});
```

âŒ **é¢‘ç¹ä¿®æ”¹é—´éš”**
```javascript
// ä½æ•ˆ! æ¯æ¬¡ä¿®æ”¹éƒ½ä¼šé‡å¯ä»»åŠ¡
setInterval(() => {
  account.monitor_interval = Math.random() * 100;  // âŒ ä¸æ¨è
}, 10000);
```

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜1: æ¶ˆæ¯å»¶è¿Ÿè¿‡å¤§

**ç—‡çŠ¶**: å®é™…æ¶ˆæ¯10åˆ†é’Ÿå‰å‘é€,ç°åœ¨æ‰æ”¶åˆ°

**å¯èƒ½åŸå› **:
1. `monitor_interval` è®¾ç½®è¿‡å¤§ (å¦‚300ç§’)
2. Workerè¿›ç¨‹å¡é¡¿
3. çˆ¬è™«æ‰§è¡Œæ—¶é—´è¿‡é•¿

**è§£å†³æ–¹æ¡ˆ**:
```javascript
// 1. æ£€æŸ¥å½“å‰é—´éš”
GET /api/accounts/:id
// è¿”å›: { "monitor_interval": 300 }  â† é—´éš”è¿‡å¤§!

// 2. è°ƒæ•´ä¸ºæ›´çŸ­çš„é—´éš”
PUT /api/accounts/:id
{ "monitor_interval": 30 }

// 3. è§‚å¯ŸWorkeræ—¥å¿—
// ç¡®è®¤ä»»åŠ¡æ­£å¸¸æ‰§è¡Œ
```

### é—®é¢˜2: é¢‘ç¹è§¦å‘é™æµ

**ç—‡çŠ¶**: æ—¥å¿—ä¸­é¢‘ç¹å‡ºç° "Rate limited" è­¦å‘Š

**å¯èƒ½åŸå› **:
1. `monitor_interval` è®¾ç½®è¿‡å° (<10ç§’)
2. å¤šä¸ªè´¦æˆ·åŒæ—¶è¯·æ±‚
3. å¹³å°é™æµç­–ç•¥å˜åŒ–

**è§£å†³æ–¹æ¡ˆ**:
```javascript
// 1. å¢åŠ ç›‘æ§é—´éš”
PUT /api/accounts/:id
{ "monitor_interval": 60 }

// 2. æ£€æŸ¥RateLimiterè‡ªåŠ¨è°ƒæ•´
// Workeræ—¥å¿—ä¼šæ˜¾ç¤º:
// "Rate limited! Increased interval to 60s"

// 3. ç­‰å¾…é™æµæ¢å¤ (é€šå¸¸5-30åˆ†é’Ÿ)
```

### é—®é¢˜3: ä»»åŠ¡ä¸æ‰§è¡Œ

**ç—‡çŠ¶**: Workerå¯åŠ¨,ä½†ç›‘æ§ä»»åŠ¡æ²¡æœ‰æ‰§è¡Œ

**å¯èƒ½åŸå› **:
1. è´¦æˆ·æœªåˆ†é…åˆ°Worker
2. è´¦æˆ·çŠ¶æ€ä¸º 'paused'
3. Workerä¸Masterè¿æ¥æ–­å¼€

**æ’æŸ¥æ­¥éª¤**:
```javascript
// 1. æ£€æŸ¥è´¦æˆ·åˆ†é…çŠ¶æ€
GET /api/accounts/:id
// è¿”å›: { "assigned_worker_id": null }  â† æœªåˆ†é…!

// 2. æ£€æŸ¥è´¦æˆ·çŠ¶æ€
// è¿”å›: { "status": "paused" }  â† å·²æš‚åœ!

// 3. æ£€æŸ¥Workerè¿æ¥
// Workeræ—¥å¿—åº”æ˜¾ç¤º:
// "âœ“ Connected to master"
// "âœ“ Registered with master (3 accounts assigned)"
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç›‘æ§ä»»åŠ¡å¤„ç†å™¨æºç ](../packages/worker/src/handlers/monitor-task.js)
- [è´¦æˆ·æ¨¡å‹å®šä¹‰](../packages/shared/models/Account.js)
- [é™æµå™¨å®ç°](../packages/worker/src/handlers/rate-limiter.js)
- [æ•°æ®åº“Schema](../packages/master/src/database/schema.sql)
- [å¤šBrowseræ¶æ„è¯¦è§£](./architecture/å¤šBrowseræ¶æ„è¯¦è§£.md)

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **ç»Ÿä¸€é—´éš”**: è¯„è®ºå’Œç§ä¿¡ä½¿ç”¨**åŒä¸€ä¸ªåˆ·æ–°é—´éš”** (`monitor_interval`)
2. **é»˜è®¤å€¼**: 30ç§’ (å¹³è¡¡å®æ—¶æ€§å’Œèµ„æºæ¶ˆè€—)
3. **å¯é…ç½®**: 10-300ç§’èŒƒå›´,æ¯ä¸ªè´¦æˆ·ç‹¬ç«‹é…ç½®
4. **åŒæ—¶æ£€æµ‹**: æ¯æ¬¡åˆ·æ–°ä¼šåŒæ—¶çˆ¬å–è¯„è®ºå’Œç§ä¿¡
5. **åŠ¨æ€è°ƒæ•´**: æ”¯æŒè¿è¡Œæ—¶ä¿®æ”¹,è‡ªåŠ¨é‡å¯ä»»åŠ¡

### å¿«é€Ÿé…ç½®

```javascript
// æ¨èé…ç½® (30ç§’)
{
  "account_name": "æµ‹è¯•è´¦æˆ·",
  "platform": "douyin",
  "monitor_interval": 30  // â† è¯„è®ºå’Œç§ä¿¡éƒ½æ˜¯30ç§’
}

// VIPè´¦æˆ· (10ç§’)
{
  "monitor_interval": 10  // æ›´å¿«å“åº”
}

// ä½ä¼˜å…ˆçº§ (120ç§’)
{
  "monitor_interval": 120  // é™ä½èµ„æºæ¶ˆè€—
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0
**æœ€åæ›´æ–°**: 2025-10-13
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ
