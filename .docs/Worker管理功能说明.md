# Worker ç®¡ç†åŠŸèƒ½è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

Worker æ˜¯ç³»ç»Ÿä¸­çš„å·¥ä½œèŠ‚ç‚¹ï¼Œè´Ÿè´£æ‰§è¡Œå…·ä½“çš„æŠ–éŸ³è´¦æˆ·ç›‘æ§ä»»åŠ¡ã€‚Master æœåŠ¡è´Ÿè´£ç®¡ç†å’Œè°ƒåº¦ Workerï¼ŒAdmin Web æä¾›å¯è§†åŒ–ç®¡ç†ç•Œé¢ã€‚

## Worker ç®¡ç†æœºåˆ¶

### 1. Worker æ³¨å†Œæµç¨‹

```
Worker å¯åŠ¨ â†’ è¿æ¥ Master Socket.IO â†’ å‘é€æ³¨å†Œè¯·æ±‚ â†’ Master è®°å½•å¹¶åˆ†é…è´¦æˆ·
```

**æ³¨å†Œä¿¡æ¯**ï¼š
- `worker_id`: Worker å”¯ä¸€æ ‡è¯†
- `host`: Worker ä¸»æœºåœ°å€
- `port`: Worker æœåŠ¡ç«¯å£
- `version`: Worker ç‰ˆæœ¬
- `capabilities`: Worker èƒ½åŠ›åˆ—è¡¨
- `max_accounts`: æœ€å¤§å¯ç®¡ç†è´¦æˆ·æ•°

### 2. å¿ƒè·³ç›‘æ§

- Worker æ¯ 10 ç§’å‘é€å¿ƒè·³åŒ…
- Master è¶…æ—¶é˜ˆå€¼ï¼š30 ç§’
- è¶…è¿‡é˜ˆå€¼æ ‡è®°ä¸ºç¦»çº¿
- è‡ªåŠ¨é‡æ–°åˆ†é…ç¦»çº¿ Worker çš„è´¦æˆ·

### 3. è´¦æˆ·åˆ†é…ç­–ç•¥

Master è‡ªåŠ¨åˆ†é…è´¦æˆ·ç»™ Workerï¼š
- è´Ÿè½½å‡è¡¡ï¼šä¼˜å…ˆåˆ†é…ç»™è´Ÿè½½è¾ƒä½çš„ Worker
- å®¹é‡é™åˆ¶ï¼šä¸è¶…è¿‡ Worker çš„ `max_accounts`
- æ•…éšœè½¬ç§»ï¼šç¦»çº¿ Worker çš„è´¦æˆ·é‡æ–°åˆ†é…

## Worker ç®¡ç†é¡µé¢åŠŸèƒ½

### è®¿é—®è·¯å¾„
`http://localhost:3001/workers`

### åŠŸèƒ½ç‰¹æ€§

#### 1. å®æ—¶ç›‘æ§é¢æ¿

**ç»Ÿè®¡å¡ç‰‡**ï¼š
- **æ€» Worker æ•°**ï¼šç³»ç»Ÿä¸­æ³¨å†Œçš„æ‰€æœ‰ Worker
- **åœ¨çº¿ Worker**ï¼šå½“å‰æ´»è·ƒçš„ Worker èŠ‚ç‚¹
- **ç›‘æ§è´¦æˆ·æ•°**ï¼šæ‰€æœ‰ Worker æ­£åœ¨ç›‘æ§çš„è´¦æˆ·æ€»æ•°
- **æ€»å®¹é‡ä½¿ç”¨ç‡**ï¼šç³»ç»Ÿæ•´ä½“è´Ÿè½½ç™¾åˆ†æ¯”

#### 2. Worker åˆ—è¡¨

**æ˜¾ç¤ºä¿¡æ¯**ï¼š
- Worker IDï¼šå”¯ä¸€æ ‡è¯†ç¬¦
- çŠ¶æ€ï¼šåœ¨çº¿/ç¦»çº¿/é”™è¯¯/ç¹å¿™
- ä¸»æœºç«¯ç‚¹ï¼š`host:port`
- è´¦æˆ·è´Ÿè½½ï¼šè¿›åº¦æ¡æ˜¾ç¤º `å½“å‰/æœ€å¤§`
- æœ€åå¿ƒè·³ï¼šå®æ—¶å¿ƒè·³çŠ¶æ€
- ç‰ˆæœ¬å·ï¼šWorker ç‰ˆæœ¬ä¿¡æ¯
- å¯åŠ¨æ—¶é—´ï¼šWorker å¯åŠ¨æ—¶é—´æˆ³

**çŠ¶æ€è¯´æ˜**ï¼š
- ğŸŸ¢ **åœ¨çº¿**ï¼ˆonlineï¼‰ï¼šæ­£å¸¸è¿è¡Œ
- âšª **ç¦»çº¿**ï¼ˆofflineï¼‰ï¼šå¤±å»è¿æ¥
- ğŸ”´ **é”™è¯¯**ï¼ˆerrorï¼‰ï¼šè¿è¡Œå¼‚å¸¸
- ğŸ”µ **ç¹å¿™**ï¼ˆbusyï¼‰ï¼šè´Ÿè½½è¾ƒé«˜

#### 3. Worker è¯¦æƒ…

ç‚¹å‡»"è¯¦æƒ…"æŒ‰é’®æŸ¥çœ‹ï¼š
- åŸºæœ¬ä¿¡æ¯ï¼ˆIDã€ç‰ˆæœ¬ã€ä¸»æœºã€ç«¯å£ï¼‰
- è¿è¡ŒçŠ¶æ€ï¼ˆçŠ¶æ€ã€å¿ƒè·³æ—¶é—´ã€å¯åŠ¨æ—¶é—´ï¼‰
- è´Ÿè½½ä¿¡æ¯ï¼ˆåˆ†é…è´¦æˆ·æ•°ã€æœ€å¤§å®¹é‡ï¼‰
- ä»£ç†é…ç½®ï¼ˆå¦‚æœæœ‰ï¼‰
- ç‰¹æ®Šèƒ½åŠ›ï¼ˆcapabilitiesï¼‰
- åˆ†é…çš„è´¦æˆ·åˆ—è¡¨

#### 4. å®æ—¶åˆ·æ–°

- è‡ªåŠ¨æ¯ 5 ç§’åˆ·æ–°çŠ¶æ€
- æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®
- å¿ƒè·³æ—¶é—´å®æ—¶æ›´æ–°

## æŠ€æœ¯å®ç°

### å‰ç«¯ç»„ä»¶ ([WorkersPage.js](../packages/admin-web/src/pages/WorkersPage.js))

```javascript
// ä¸»è¦åŠŸèƒ½
- å®šæ—¶åˆ·æ–°ï¼ˆ5ç§’ï¼‰
- çŠ¶æ€æ ‡ç­¾å¯è§†åŒ–
- è´Ÿè½½è¿›åº¦æ¡æ˜¾ç¤º
- è¯¦æƒ…æ¨¡æ€æ¡†
```

### API æ¥å£

#### GET /api/v1/workers
è·å–æ‰€æœ‰ Worker åˆ—è¡¨

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "data": [
    {
      "id": "worker-1",
      "host": "localhost",
      "port": 4001,
      "status": "online",
      "assigned_accounts": 3,
      "max_accounts": 10,
      "last_heartbeat": 1697123456,
      "started_at": 1697120000,
      "version": "1.0.0",
      "capabilities": ["douyin", "multi-browser"]
    }
  ]
}
```

#### GET /api/v1/workers/:id
è·å–å•ä¸ª Worker è¯¦æƒ…

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "data": {
    "id": "worker-1",
    "host": "localhost",
    "port": 4001,
    "status": "online",
    "assigned_accounts": 3,
    "max_accounts": 10,
    "last_heartbeat": 1697123456,
    "started_at": 1697120000,
    "version": "1.0.0",
    "capabilities": ["douyin", "multi-browser"],
    "proxy_id": "proxy-123",
    "assigned_accounts_list": [
      {
        "id": "acc-1",
        "account_name": "æµ‹è¯•è´¦æˆ·1",
        "platform": "douyin"
      }
    ]
  }
}
```

### æ•°æ®åº“è¡¨ç»“æ„

**workers è¡¨**ï¼š
```sql
CREATE TABLE workers (
  id TEXT PRIMARY KEY,          -- Worker ID
  host TEXT,                     -- ä¸»æœºåœ°å€
  port INTEGER,                  -- ç«¯å£å·
  status TEXT DEFAULT 'offline', -- çŠ¶æ€
  assigned_accounts INTEGER DEFAULT 0, -- åˆ†é…è´¦æˆ·æ•°
  last_heartbeat INTEGER,        -- æœ€åå¿ƒè·³æ—¶é—´
  started_at INTEGER,            -- å¯åŠ¨æ—¶é—´
  version TEXT,                  -- ç‰ˆæœ¬å·
  proxy_id TEXT,                 -- ä»£ç† IDï¼ˆå¯é€‰ï¼‰
  metadata TEXT                  -- JSON å…ƒæ•°æ®ï¼ˆcapabilitiesç­‰ï¼‰
)
```

## Worker å¯åŠ¨ä¸é…ç½®

### ç¯å¢ƒå˜é‡ (.env)

```bash
WORKER_ID=worker-1              # Worker å”¯ä¸€æ ‡è¯†
MASTER_HOST=localhost           # Master æœåŠ¡åœ°å€
MASTER_PORT=3000               # Master æœåŠ¡ç«¯å£
MAX_ACCOUNTS=10                # æœ€å¤§ç®¡ç†è´¦æˆ·æ•°
HEADLESS=true                  # æµè§ˆå™¨æ— å¤´æ¨¡å¼
```

### å¯åŠ¨ Worker

```bash
cd packages/worker
npm start

# æˆ–å¼€å‘æ¨¡å¼
npm run dev
```

### Worker æ—¥å¿—

```
packages/worker/logs/
â”œâ”€â”€ worker.log         # ä¸»æ—¥å¿—
â”œâ”€â”€ worker-error.log   # é”™è¯¯æ—¥å¿—
â””â”€â”€ browser-*.log      # æµè§ˆå™¨æ—¥å¿—
```

## ç›‘æ§æŒ‡æ ‡

### æ€§èƒ½æŒ‡æ ‡
- **å¿ƒè·³å»¶è¿Ÿ**ï¼š< 1 ç§’
- **è´¦æˆ·åˆ‡æ¢æ—¶é—´**ï¼š< 5 ç§’
- **å†…å­˜å ç”¨**ï¼š~200MB/è´¦æˆ·
- **CPU ä½¿ç”¨ç‡**ï¼š< 50%

### å¥åº·æ£€æŸ¥
- å¿ƒè·³è¶…æ—¶ï¼š30 ç§’
- è‡ªåŠ¨é‡è¿ï¼š3 æ¬¡é‡è¯•
- æ•…éšœæ¢å¤ï¼š< 1 åˆ†é’Ÿ

## å¸¸è§é—®é¢˜

### 1. Worker æ˜¾ç¤ºç¦»çº¿

**å¯èƒ½åŸå› **ï¼š
- Worker è¿›ç¨‹æœªå¯åŠ¨
- ç½‘ç»œè¿æ¥ä¸­æ–­
- Master æœåŠ¡é‡å¯

**è§£å†³æ–¹æ³•**ï¼š
```bash
# æ£€æŸ¥ Worker è¿›ç¨‹
ps aux | grep worker

# é‡å¯ Worker
cd packages/worker
npm restart

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/worker.log
```

### 2. è´¦æˆ·åˆ†é…ä¸å‡

**å¯èƒ½åŸå› **ï¼š
- Worker å®¹é‡è®¾ç½®ä¸ä¸€è‡´
- éƒ¨åˆ† Worker ç¦»çº¿

**è§£å†³æ–¹æ³•**ï¼š
- è°ƒæ•´ `MAX_ACCOUNTS` ç¯å¢ƒå˜é‡
- ç¡®ä¿æ‰€æœ‰ Worker åœ¨çº¿
- æ‰‹åŠ¨é‡æ–°åˆ†é…è´¦æˆ·

### 3. å¿ƒè·³è¶…æ—¶

**å¯èƒ½åŸå› **ï¼š
- Worker è´Ÿè½½è¿‡é«˜
- ç½‘ç»œå»¶è¿Ÿ

**è§£å†³æ–¹æ³•**ï¼š
- å‡å°‘ Worker è´¦æˆ·æ•°
- ä¼˜åŒ–ç½‘ç»œè¿æ¥
- å¢åŠ å¿ƒè·³è¶…æ—¶é˜ˆå€¼

## æœªæ¥æ”¹è¿›

1. **Worker æ§åˆ¶åŠŸèƒ½**
   - è¿œç¨‹å¯åŠ¨/åœæ­¢
   - é…ç½®çƒ­æ›´æ–°
   - æ—¥å¿—æŸ¥çœ‹

2. **é«˜çº§è°ƒåº¦ç­–ç•¥**
   - åŸºäºåœ°ç†ä½ç½®åˆ†é…
   - åŸºäºä»£ç†åˆ†ç»„
   - ä¼˜å…ˆçº§é˜Ÿåˆ—

3. **ç›‘æ§å¢å¼º**
   - å®æ—¶æ€§èƒ½å›¾è¡¨
   - å‘Šè­¦é€šçŸ¥
   - å†å²æ•°æ®åˆ†æ

## ç›¸å…³æ–‡æ¡£

- [Master-Worker æ¶æ„è¯´æ˜](./æ¶æ„è®¾è®¡.md)
- [è´¦æˆ·ç®¡ç†è¯´æ˜](./è´¦æˆ·ç®¡ç†åŠŸèƒ½è¯´æ˜.md)
- [ä»£ç†ç®¡ç†è¯´æ˜](./ä»£ç†å¯†ç ç¼–è¾‘ä¿®å¤.md)