# Master ç«¯è®¾è®¡æ–¹æ¡ˆ

**ç‰ˆæœ¬**: 2.0.0
**æ—¥æœŸ**: 2025-10-16
**è´Ÿè´£æ¨¡å—**: ä¸»æ§æœåŠ¡å™¨ (Master Server)

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
3. [æ ¸å¿ƒæ¨¡å—](#æ ¸å¿ƒæ¨¡å—)
4. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
5. [é€šä¿¡åè®®](#é€šä¿¡åè®®)
6. [æ ¸å¿ƒæµç¨‹](#æ ¸å¿ƒæµç¨‹)
7. [éƒ¨ç½²è¯´æ˜](#éƒ¨ç½²è¯´æ˜)

---

## ğŸ¯ æ¦‚è¿°

### èŒè´£å®šä½

Master æ˜¯æ•´ä¸ªç³»ç»Ÿçš„**ä¸­å¤®åè°ƒå™¨**ï¼Œè´Ÿè´£ï¼š
- âœ… Worker æ³¨å†Œä¸ç”Ÿå‘½å‘¨æœŸç®¡ç†
- âœ… è´¦æˆ·åˆ†é…ä¸ä»»åŠ¡è°ƒåº¦
- âœ… ç™»å½•ä¼šè¯ç®¡ç†ï¼ˆäºŒç»´ç ç™»å½•åè°ƒï¼‰
- âœ… æ•°æ®æŒä¹…åŒ–ï¼ˆè´¦æˆ·å‡­æ®ã€ç›‘æ§æ•°æ®ï¼‰
- âœ… Admin Web é€šä¿¡ï¼ˆå®æ—¶çŠ¶æ€æ¨é€ï¼‰

### æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Node.js | 18.x LTS | è¿è¡Œæ—¶ |
| Express | 4.x | HTTP æœåŠ¡å™¨ |
| Socket.IO | 4.x | WebSocket é€šä¿¡ |
| SQLite | 3.x (better-sqlite3) | æ•°æ®åº“ |
| Winston | 3.x | æ—¥å¿— |

### ç«¯å£é…ç½®

- **HTTP/Socket.IO**: 3000 (é»˜è®¤)
- **ç¯å¢ƒå˜é‡**: `PORT`, `DB_PATH`

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Master Server (ç«¯å£ 3000)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  HTTP API    â”‚  â”‚  Socket.IO   â”‚  â”‚   Database   â”‚      â”‚
â”‚  â”‚  (Express)   â”‚  â”‚   Server     â”‚  â”‚   (SQLite)   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                 â”‚                  â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å±‚                        â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ WorkerManager â”‚ LoginHandler â”‚ TaskScheduler     â”‚    â”‚
â”‚  â”‚ HeartbeatMonitor â”‚ AccountAssigner â”‚ ...         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â–²                           â–²
              â”‚                           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Admin Web       â”‚       â”‚   Workers       â”‚
    â”‚   /admin          â”‚       â”‚   /worker       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç›®å½•ç»“æ„

```
packages/master/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.js                     # å…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ api/routes/                  # HTTP API
â”‚   â”‚   â”œâ”€â”€ accounts.js              # è´¦æˆ·ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ workers.js               # Worker ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ worker-lifecycle.js      # Worker ç”Ÿå‘½å‘¨æœŸ
â”‚   â”‚   â”œâ”€â”€ proxies.js               # ä»£ç†ç®¡ç†
â”‚   â”‚   â””â”€â”€ messages.js              # æ¶ˆæ¯æŸ¥è¯¢
â”‚   â”œâ”€â”€ communication/               # é€šä¿¡å±‚
â”‚   â”‚   â”œâ”€â”€ socket-server.js         # Socket.IO æœåŠ¡å™¨
â”‚   â”‚   â”œâ”€â”€ session-manager.js       # ä¼šè¯ç®¡ç†
â”‚   â”‚   â””â”€â”€ notification-broadcaster.js  # é€šçŸ¥å¹¿æ’­
â”‚   â”œâ”€â”€ socket/                      # Socket å‘½åç©ºé—´
â”‚   â”‚   â””â”€â”€ admin-namespace.js       # Admin å‘½åç©ºé—´
â”‚   â”œâ”€â”€ worker_manager/              # Worker ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ registration.js          # Worker æ³¨å†Œ
â”‚   â”‚   â”œâ”€â”€ account-assigner.js      # è´¦æˆ·åˆ†é…
â”‚   â”‚   â”œâ”€â”€ lifecycle-manager.js     # ç”Ÿå‘½å‘¨æœŸç®¡ç†
â”‚   â”‚   â””â”€â”€ local-process-manager.js # æœ¬åœ°è¿›ç¨‹ç®¡ç†
â”‚   â”œâ”€â”€ scheduler/                   # è°ƒåº¦å™¨
â”‚   â”‚   â””â”€â”€ task-scheduler.js        # ä»»åŠ¡è°ƒåº¦
â”‚   â”œâ”€â”€ monitor/                     # ç›‘æ§
â”‚   â”‚   â””â”€â”€ heartbeat.js             # å¿ƒè·³ç›‘æ§
â”‚   â”œâ”€â”€ login/                       # ç™»å½•ç®¡ç†
â”‚   â”‚   â””â”€â”€ login-handler.js         # ç™»å½•ä¼šè¯å¤„ç†
â”‚   â””â”€â”€ database/                    # æ•°æ®åº“
â”‚       â”œâ”€â”€ init.js                  # åˆå§‹åŒ–
â”‚       â”œâ”€â”€ schema.sql               # è¡¨ç»“æ„
â”‚       â”œâ”€â”€ migrations/              # è¿ç§»è„šæœ¬
â”‚       â””â”€â”€ *-dao.js                 # æ•°æ®è®¿é—®å¯¹è±¡
â”œâ”€â”€ data/                            # æ•°æ®ç›®å½•
â”‚   â””â”€â”€ master.db                    # SQLite æ•°æ®åº“
â””â”€â”€ logs/                            # æ—¥å¿—ç›®å½•
```

---

## ğŸ§© æ ¸å¿ƒæ¨¡å—

### 1. Socket.IO æœåŠ¡å™¨

**æ–‡ä»¶**: `src/communication/socket-server.js`

**åŠŸèƒ½**:
- åˆå§‹åŒ– Socket.IO æœåŠ¡å™¨
- åˆ›å»ºä¸‰ä¸ªå‘½åç©ºé—´ï¼š`/worker`, `/admin`, `/client`
- é…ç½® CORS å’Œä¼ è¾“æ–¹å¼

**å‘½åç©ºé—´èŒè´£**:
- `/worker` - Worker è¿æ¥ï¼Œæ¥æ”¶å¿ƒè·³ã€ç™»å½•æ•°æ®ã€ç›‘æ§æ•°æ®
- `/admin` - Admin Web è¿æ¥ï¼Œå‘é€ç™»å½•è¯·æ±‚ã€æ¥æ”¶çŠ¶æ€æ›´æ–°
- `/client` - Desktop/Mobile å®¢æˆ·ç«¯è¿æ¥ï¼Œæ¨é€é€šçŸ¥

---

### 2. Worker ç®¡ç†å™¨

**æ–‡ä»¶**: `src/worker_manager/`

#### 2.1 æ³¨å†Œç®¡ç† (`registration.js`)

**èŒè´£**:
- Worker æ³¨å†ŒéªŒè¯
- å­˜å‚¨åˆ° `workers` è¡¨
- ç»´æŠ¤å†…å­˜ä¸­çš„ Worker ç¼“å­˜
- Worker ä¸‹çº¿å¤„ç†

#### 2.2 è´¦æˆ·åˆ†é…å™¨ (`account-assigner.js`)

**èŒè´£**:
- æ ¹æ® Worker èƒ½åŠ›ï¼ˆcapabilitiesï¼‰åˆ†é…è´¦æˆ·
- è´Ÿè½½å‡è¡¡ï¼ˆæŒ‰ `assigned_accounts` æ’åºï¼‰
- å‘é€ä»»åŠ¡åˆ†é…æ¶ˆæ¯åˆ° Worker

**åˆ†é…ç­–ç•¥**:
1. æŸ¥æ‰¾æ”¯æŒè¯¥å¹³å°çš„ Worker
2. æŒ‰è´Ÿè½½æ’åºï¼ˆassigned_accounts ASCï¼‰
3. é€‰æ‹©è´Ÿè½½æœ€ä½çš„ Worker
4. æ›´æ–°æ•°æ®åº“å¹¶å‘é€ä»»åŠ¡

#### 2.3 ç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨ (`lifecycle-manager.js`)

**èŒè´£**:
- å¯åŠ¨ Worker è¿›ç¨‹ï¼ˆforkï¼‰
- åœæ­¢ Worker è¿›ç¨‹ï¼ˆSIGTERMï¼‰
- é‡å¯ Worker è¿›ç¨‹
- ç®¡ç† Worker é…ç½®

**æ”¯æŒæ“ä½œ**:
- `startWorker(workerId)` - ä»é…ç½®å¯åŠ¨ Worker
- `stopWorker(workerId)` - ä¼˜é›…åœæ­¢ Worker
- `restartWorker(workerId)` - é‡å¯ Worker

---

### 3. ç™»å½•å¤„ç†å™¨

**æ–‡ä»¶**: `src/login/login-handler.js`

**èŒè´£**: åè°ƒè´¦æˆ·ç™»å½•æµç¨‹ï¼ˆäºŒç»´ç ç™»å½•ï¼‰

**æ ¸å¿ƒæ–¹æ³•**:
- `createLoginSession()` - åˆ›å»ºç™»å½•ä¼šè¯ï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆæœŸï¼‰
- `handleQRCodeReady()` - æ¥æ”¶äºŒç»´ç å¹¶å¹¿æ’­ç»™ Admin
- `handleLoginSuccess()` - ä¿å­˜ Cookieã€ç”¨æˆ·ä¿¡æ¯ã€æŒ‡çº¹åˆ°æ•°æ®åº“
- `handleLoginFailed()` - å¤„ç†ç™»å½•å¤±è´¥
- `handleQRCodeRefreshed()` - å¤„ç†äºŒç»´ç åˆ·æ–°
- `cleanupExpiredSessions()` - å®šæ—¶æ¸…ç†è¿‡æœŸä¼šè¯

**ç™»å½•æˆåŠŸæ—¶ä¿å­˜çš„æ•°æ®**:
- `accounts.credentials` - Cookie æ•°ç»„ï¼ˆJSONï¼‰
- `accounts.user_info` - ç”¨æˆ·ä¿¡æ¯ï¼ˆæ˜µç§°ã€å¤´åƒã€æŠ–éŸ³å·ç­‰ï¼‰
- `accounts.fingerprint` - æµè§ˆå™¨æŒ‡çº¹é…ç½®
- `accounts.login_status` - æ›´æ–°ä¸º `logged_in`
- `accounts.last_login_time` - ç™»å½•æ—¶é—´
- `accounts.cookies_valid_until` - Cookie æœ‰æ•ˆæœŸï¼ˆé»˜è®¤7å¤©ï¼‰

---

### 4. ä»»åŠ¡è°ƒåº¦å™¨

**æ–‡ä»¶**: `src/scheduler/task-scheduler.js`

**èŒè´£**: å®šæœŸæ£€æŸ¥å¹¶åˆ†é…ç›‘æ§ä»»åŠ¡

**è°ƒåº¦é€»è¾‘**:
1. æ¯ 30 ç§’æ‰§è¡Œä¸€æ¬¡
2. æŸ¥è¯¢éœ€è¦ç›‘æ§çš„è´¦æˆ·ï¼š
   - `login_status = 'logged_in'`
   - `status = 'active'`
   - `assigned_worker_id IS NOT NULL`
3. æŒ‰ Worker åˆ†ç»„
4. å‘æ¯ä¸ª Worker å‘é€ `master:task:assign` æ¶ˆæ¯

---

### 5. å¿ƒè·³ç›‘æ§

**æ–‡ä»¶**: `src/monitor/heartbeat.js`

**èŒè´£**: ç›‘æ§ Worker å¿ƒè·³ï¼Œæ ‡è®°ç¦»çº¿ Worker

**ç›‘æ§é€»è¾‘**:
1. æ¯ 15 ç§’æ£€æŸ¥ä¸€æ¬¡
2. æŸ¥è¯¢è¶…è¿‡ 30 ç§’æœªå‘é€å¿ƒè·³çš„ Worker
3. æ ‡è®°ä¸º `offline`
4. æ’¤é”€è¯¥ Worker çš„æ‰€æœ‰ä»»åŠ¡ï¼ˆ`assigned_worker_id = NULL`ï¼‰

---

## ğŸ’¾ æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æ„

#### 1. accounts - è´¦æˆ·è¡¨

**ç”¨é€”**: å­˜å‚¨ç¤¾äº¤åª’ä½“è´¦æˆ·ä¿¡æ¯å’Œç™»å½•å‡­æ®

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | TEXT | UUID |
| platform | TEXT | å¹³å°åç§°ï¼ˆdouyin, xiaohongshuï¼‰ |
| account_name | TEXT | è´¦æˆ·åç§° |
| account_id | TEXT | å¹³å°è´¦æˆ·IDï¼ˆå¦‚æŠ–éŸ³å·ï¼‰ |
| credentials | TEXT | JSON: {cookies: [...]} |
| user_info | TEXT | JSON: {nickname, avatar, douyin_id, ...} |
| fingerprint | TEXT | JSON: æµè§ˆå™¨æŒ‡çº¹é…ç½® |
| status | TEXT | active/inactive |
| login_status | TEXT | not_logged_in/logging_in/logged_in/login_failed |
| monitor_interval | INTEGER | ç›‘æ§é—´éš”ï¼ˆç§’ï¼‰ |
| last_login_time | INTEGER | æœ€åç™»å½•æ—¶é—´ |
| cookies_valid_until | INTEGER | Cookie æœ‰æ•ˆæœŸ |
| assigned_worker_id | TEXT | åˆ†é…çš„ Worker ID |

**ç´¢å¼•**:
- `idx_accounts_status`
- `idx_accounts_login_status`
- `idx_accounts_worker`
- `idx_accounts_platform_account`

#### 2. workers - Worker èŠ‚ç‚¹è¡¨

**ç”¨é€”**: å­˜å‚¨ Worker æ³¨å†Œä¿¡æ¯å’ŒçŠ¶æ€

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | TEXT | Worker ID |
| host | TEXT | ä¸»æœºåœ°å€ |
| port | INTEGER | ç«¯å£ |
| status | TEXT | connected/disconnected/offline |
| assigned_accounts | INTEGER | å·²åˆ†é…è´¦æˆ·æ•° |
| last_heartbeat | INTEGER | æœ€åå¿ƒè·³æ—¶é—´ |
| started_at | INTEGER | å¯åŠ¨æ—¶é—´ |
| version | TEXT | Worker ç‰ˆæœ¬ |
| metadata | TEXT | JSON: æ‰©å±•ä¿¡æ¯ |

#### 3. login_sessions - ç™»å½•ä¼šè¯è¡¨

**ç”¨é€”**: è·Ÿè¸ªç™»å½•è¿‡ç¨‹ï¼ˆä¸´æ—¶æ•°æ®ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | TEXT | ä¼šè¯ ID (UUID) |
| account_id | TEXT | å…³è”è´¦æˆ· |
| worker_id | TEXT | æ‰§è¡Œ Worker |
| status | TEXT | pending/scanning/success/failed/expired |
| login_method | TEXT | qrcode/password/cookie |
| qr_code_data | TEXT | äºŒç»´ç  Base64 |
| qr_code_url | TEXT | äºŒç»´ç  URL |
| error_message | TEXT | é”™è¯¯ä¿¡æ¯ |
| expires_at | INTEGER | è¿‡æœŸæ—¶é—´ï¼ˆ5åˆ†é’Ÿï¼‰ |
| logged_in_at | INTEGER | ç™»å½•æˆåŠŸæ—¶é—´ |
| created_at | INTEGER | åˆ›å»ºæ—¶é—´ |

#### 4. comments - è¯„è®ºè¡¨

**ç”¨é€”**: å­˜å‚¨ç›‘æ§åˆ°çš„è¯„è®º

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | TEXT | UUID |
| account_id | TEXT | å…³è”è´¦æˆ· |
| platform_comment_id | TEXT | å¹³å°è¯„è®º ID |
| content | TEXT | è¯„è®ºå†…å®¹ |
| author_name | TEXT | ä½œè€…åç§° |
| author_id | TEXT | ä½œè€… ID |
| post_id | TEXT | å¸–å­ ID |
| post_title | TEXT | å¸–å­æ ‡é¢˜ |
| is_read | BOOLEAN | æ˜¯å¦å·²è¯» |
| detected_at | INTEGER | æ£€æµ‹æ—¶é—´ |
| created_at | INTEGER | åˆ›å»ºæ—¶é—´ |

#### 5. direct_messages - ç§ä¿¡è¡¨

**ç”¨é€”**: å­˜å‚¨ç›‘æ§åˆ°çš„ç§ä¿¡

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | TEXT | UUID |
| account_id | TEXT | å…³è”è´¦æˆ· |
| platform_message_id | TEXT | å¹³å°æ¶ˆæ¯ ID |
| content | TEXT | æ¶ˆæ¯å†…å®¹ |
| sender_name | TEXT | å‘é€è€…åç§° |
| sender_id | TEXT | å‘é€è€… ID |
| direction | TEXT | inbound/outbound |
| is_read | BOOLEAN | æ˜¯å¦å·²è¯» |
| detected_at | INTEGER | æ£€æµ‹æ—¶é—´ |
| created_at | INTEGER | åˆ›å»ºæ—¶é—´ |

#### 6. worker_configs - Worker é…ç½®è¡¨

**ç”¨é€”**: å­˜å‚¨ Worker é…ç½®ä¿¡æ¯

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | TEXT | Worker ID |
| max_accounts | INTEGER | æœ€å¤§è´¦æˆ·æ•° |
| headless | BOOLEAN | æ— å¤´æ¨¡å¼ |
| env_vars | TEXT | JSON: ç¯å¢ƒå˜é‡ |
| created_at | INTEGER | åˆ›å»ºæ—¶é—´ |
| updated_at | INTEGER | æ›´æ–°æ—¶é—´ |

#### 7. worker_runtime - Worker è¿è¡Œæ—¶çŠ¶æ€è¡¨

**ç”¨é€”**: å­˜å‚¨ Worker è¿è¡Œæ—¶çŠ¶æ€

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | TEXT | Worker ID |
| process_id | INTEGER | è¿›ç¨‹ PID |
| status | TEXT | running/stopped/error |
| started_at | INTEGER | å¯åŠ¨æ—¶é—´ |
| stopped_at | INTEGER | åœæ­¢æ—¶é—´ |
| error_message | TEXT | é”™è¯¯ä¿¡æ¯ |
| updated_at | INTEGER | æ›´æ–°æ—¶é—´ |

#### 8. proxies - ä»£ç†æœåŠ¡å™¨è¡¨

**ç”¨é€”**: å­˜å‚¨ä»£ç†æœåŠ¡å™¨é…ç½®

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | TEXT | UUID |
| name | TEXT | ä»£ç†åç§° |
| server | TEXT | host:port |
| protocol | TEXT | http/https/socks5 |
| username | TEXT | ç”¨æˆ·å |
| password | TEXT | å¯†ç  |
| country | TEXT | å›½å®¶ |
| city | TEXT | åŸå¸‚ |
| status | TEXT | active/inactive |
| success_rate | REAL | æˆåŠŸç‡ |
| last_check_time | INTEGER | æœ€åæ£€æŸ¥æ—¶é—´ |
| response_time | INTEGER | å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ |
| created_at | INTEGER | åˆ›å»ºæ—¶é—´ |
| updated_at | INTEGER | æ›´æ–°æ—¶é—´ |

---

## ğŸ”Œ é€šä¿¡åè®®

### Socket.IO æ¶ˆæ¯æ ¼å¼

#### Worker â†’ Master æ¶ˆæ¯

| æ¶ˆæ¯ç±»å‹ | è¯´æ˜ | æ•°æ®å­—æ®µ |
|---------|------|---------|
| `worker:register` | Worker æ³¨å†Œ | workerId, host, port, capabilities, maxAccounts, version |
| `worker:heartbeat` | å¿ƒè·³ | workerId, stats, timestamp |
| `worker:login:qrcode` | äºŒç»´ç å°±ç»ª | session_id, qr_code_data, qr_code_url |
| `worker:login:status` | ç™»å½•çŠ¶æ€æ›´æ–° | session_id, status, cookies, user_info, fingerprint |
| `worker:message:detected` | ç›‘æ§æ•°æ® | type, account_id, messages |

#### Master â†’ Worker æ¶ˆæ¯

| æ¶ˆæ¯ç±»å‹ | è¯´æ˜ | æ•°æ®å­—æ®µ |
|---------|------|---------|
| `master:task:assign` | ä»»åŠ¡åˆ†é… | accounts[] |
| `master:task:revoke` | ä»»åŠ¡æ’¤é”€ | accountIds[] |
| `master:login:start` | ç™»å½•è¯·æ±‚ | sessionId, accountId, platform, proxy |

#### Admin Web â†” Master æ¶ˆæ¯

**Admin â†’ Master**:
| æ¶ˆæ¯ç±»å‹ | è¯´æ˜ | æ•°æ®å­—æ®µ |
|---------|------|---------|
| `admin:login:start` | å‘èµ·ç™»å½• | accountId, workerId |
| `admin:request:login-sessions` | è¯·æ±‚ç™»å½•ä¼šè¯åˆ—è¡¨ | - |

**Master â†’ Admin**:
| æ¶ˆæ¯ç±»å‹ | è¯´æ˜ | æ•°æ®å­—æ®µ |
|---------|------|---------|
| `login:qrcode:ready` | äºŒç»´ç å°±ç»ª | session_id, account_id, qr_code_data, expires_at |
| `login:success` | ç™»å½•æˆåŠŸ | session_id, account_id, user_info, logged_in_at |
| `login:failed` | ç™»å½•å¤±è´¥ | session_id, error_message, error_type |
| `login:qrcode:refreshed` | äºŒç»´ç åˆ·æ–° | session_id, qr_code_data |
| `login:qrcode:expired` | äºŒç»´ç è¿‡æœŸ | session_id |

---

## ğŸ”„ æ ¸å¿ƒæµç¨‹

### æµç¨‹ 1: Worker æ³¨å†Œä¸å¿ƒè·³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Worker  â”‚                           â”‚ Master  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                     â”‚
     â”‚  1. è¿æ¥ Socket.IO (/worker)       â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                                     â”‚
     â”‚  2. worker:register                 â”‚
     â”‚     {workerId, capabilities, ...}   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                                     â”‚
     â”‚                             3. å­˜å‚¨åˆ° workers è¡¨
     â”‚                             4. ç¼“å­˜åˆ°å†…å­˜
     â”‚                                     â”‚
     â”‚  5. worker:registered               â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                     â”‚
     â”‚  6. worker:heartbeat (æ¯10ç§’)       â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                                     â”‚
     â”‚                             7. æ›´æ–° last_heartbeat
     â”‚                                     â”‚
     â”‚                             8. HeartbeatMonitor æ£€æŸ¥ (æ¯15ç§’)
     â”‚                                - è¶…è¿‡30ç§’æ— å¿ƒè·³ â†’ offline
     â”‚                                - æ’¤é”€è¯¥Workerçš„ä»»åŠ¡
     â”‚                                     â”‚
```

---

### æµç¨‹ 2: è´¦æˆ·ç™»å½•æµç¨‹ï¼ˆå®Œæ•´ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Admin Webâ”‚         â”‚ Master  â”‚         â”‚ Worker  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                   â”‚                   â”‚
     â”‚ 1. admin:login:start                 â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚
     â”‚                   â”‚                   â”‚
     â”‚           2. åˆ›å»º login_sessions      â”‚
     â”‚              (status: pending)        â”‚
     â”‚                   â”‚                   â”‚
     â”‚                   â”‚ 3. master:login:start
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                   â”‚                   â”‚
     â”‚                   â”‚           4. å¯åŠ¨ Browser
     â”‚                   â”‚           5. è®¿é—®ç™»å½•é¡µ
     â”‚                   â”‚           6. æ£€æµ‹ç™»å½•æ–¹å¼
     â”‚                   â”‚           7. æå–äºŒç»´ç 
     â”‚                   â”‚                   â”‚
     â”‚                   â”‚ 8. worker:login:qrcode
     â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                   â”‚   {qr_code_data}  â”‚
     â”‚           9. æ›´æ–° login_sessions      â”‚
     â”‚              (status: scanning)       â”‚
     â”‚                   â”‚                   â”‚
     â”‚ 10. login:qrcode:ready                â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
     â”‚                   â”‚                   â”‚
     â”‚ 11. æ˜¾ç¤ºäºŒç»´ç     â”‚                   â”‚
     â”‚                   â”‚                   â”‚
     â”‚                   â”‚           12. è½®è¯¢ç™»å½•çŠ¶æ€
     â”‚                   â”‚               (æ¯2ç§’)
     â”‚                   â”‚                   â”‚
     â”‚ [ç”¨æˆ·æ‰«ç ]        â”‚                   â”‚
     â”‚                   â”‚                   â”‚
     â”‚                   â”‚           13. æ£€æµ‹åˆ°ç™»å½•æˆåŠŸ
     â”‚                   â”‚           14. æå–æ•°æ®:
     â”‚                   â”‚               - cookies
     â”‚                   â”‚               - user_info
     â”‚                   â”‚               - fingerprint
     â”‚                   â”‚                   â”‚
     â”‚                   â”‚ 15. worker:login:status
     â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                   â”‚   {status: success,
     â”‚                   â”‚    cookies, user_info,
     â”‚                   â”‚    fingerprint}
     â”‚           16. æ›´æ–°æ•°æ®åº“:             â”‚
     â”‚               a. login_sessions       â”‚
     â”‚                  (status: success)    â”‚
     â”‚               b. accounts             â”‚
     â”‚                  - login_status       â”‚
     â”‚                  - credentials        â”‚
     â”‚                  - user_info          â”‚
     â”‚                  - fingerprint        â”‚
     â”‚                  - cookies_valid_untilâ”‚
     â”‚                   â”‚                   â”‚
     â”‚ 17. login:success â”‚                   â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
     â”‚   {user_info}     â”‚                   â”‚
     â”‚                   â”‚                   â”‚
     â”‚ 18. å…³é—­å¼¹çª—      â”‚                   â”‚
     â”‚     åˆ·æ–°è´¦æˆ·åˆ—è¡¨  â”‚                   â”‚
     â”‚                   â”‚                   â”‚
```

---

### æµç¨‹ 3: ä»»åŠ¡è°ƒåº¦ä¸ç›‘æ§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚TaskSchedulerâ”‚              â”‚ Master  â”‚              â”‚ Worker  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚                          â”‚                        â”‚
       â”‚ 1. å®šæ—¶å™¨è§¦å‘ (æ¯30ç§’)   â”‚                        â”‚
       â”‚                          â”‚                        â”‚
       â”‚ 2. æŸ¥è¯¢éœ€è¦ç›‘æ§çš„è´¦æˆ·    â”‚                        â”‚
       â”‚    (login_status=logged_in,                      â”‚
       â”‚     status=active)       â”‚                        â”‚
       â”‚                          â”‚                        â”‚
       â”‚ 3. æŒ‰ Worker åˆ†ç»„        â”‚                        â”‚
       â”‚                          â”‚                        â”‚
       â”‚ 4. å‘é€ä»»åŠ¡              â”‚                        â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                        â”‚
       â”‚                          â”‚                        â”‚
       â”‚                          â”‚ 5. master:task:assign  â”‚
       â”‚                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                          â”‚   {accounts: [...]}    â”‚
       â”‚                          â”‚                        â”‚
       â”‚                          â”‚                 6. åˆ›å»º MonitorTask
       â”‚                          â”‚                 7. è®¡ç®—éšæœºé—´éš”
       â”‚                          â”‚                    (15-30ç§’)
       â”‚                          â”‚                        â”‚
       â”‚                          â”‚                 8. æ‰§è¡Œç›‘æ§:
       â”‚                          â”‚                    - è·å– Browser
       â”‚                          â”‚                    - çˆ¬å–è¯„è®º
       â”‚                          â”‚                    - çˆ¬å–ç§ä¿¡
       â”‚                          â”‚                        â”‚
       â”‚                          â”‚ 9. worker:message:detected
       â”‚                          â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                          â”‚   {type, account_id,   â”‚
       â”‚                          â”‚    messages: [...]}    â”‚
       â”‚                  10. å­˜å‚¨åˆ°æ•°æ®åº“:                â”‚
       â”‚                      - comments è¡¨                â”‚
       â”‚                      - direct_messages è¡¨         â”‚
       â”‚                          â”‚                        â”‚
       â”‚                  11. æ£€æŸ¥é€šçŸ¥è§„åˆ™                â”‚
       â”‚                  12. æ¨é€é€šçŸ¥ (å¦‚éœ€è¦)           â”‚
       â”‚                          â”‚                        â”‚
       â”‚                          â”‚                 13. è®¡ç®—ä¸‹æ¬¡é—´éš”
       â”‚                          â”‚                 14. å¾ªç¯æ‰§è¡Œ
       â”‚                          â”‚                        â”‚
```

---

### æµç¨‹ 4: Worker ç¦»çº¿å¤„ç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚HeartbeatMonitor              â”‚ Master  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚                           â”‚
       â”‚ 1. å®šæ—¶å™¨è§¦å‘ (æ¯15ç§’)    â”‚
       â”‚                           â”‚
       â”‚ 2. æŸ¥è¯¢è¶…æ—¶ Worker        â”‚
       â”‚    (last_heartbeat < now-30s)
       â”‚                           â”‚
       â”‚ 3. å‘ç° worker-1 è¶…æ—¶     â”‚
       â”‚                           â”‚
       â”‚ 4. æ ‡è®°ä¸º offline         â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                           â”‚
       â”‚                    5. UPDATE workers
       â”‚                       SET status='offline'
       â”‚                           â”‚
       â”‚ 6. æ’¤é”€ä»»åŠ¡               â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                           â”‚
       â”‚                    7. UPDATE accounts
       â”‚                       SET assigned_worker_id=NULL
       â”‚                       WHERE assigned_worker_id='worker-1'
       â”‚                           â”‚
       â”‚ 8. è®°å½•æ—¥å¿—               â”‚
       â”‚    "Worker worker-1 marked as offline"
       â”‚                           â”‚
       â”‚ 9. ç­‰å¾…ä¸‹æ¬¡è°ƒåº¦é‡æ–°åˆ†é…   â”‚
       â”‚                           â”‚
```

---

## ğŸš€ éƒ¨ç½²è¯´æ˜

### ç¯å¢ƒå˜é‡

```bash
# .env æ–‡ä»¶
PORT=3000
DB_PATH=./data/master.db
LOG_LEVEL=info
NODE_ENV=production
```

### å¯åŠ¨å‘½ä»¤

**å¼€å‘ç¯å¢ƒ**:
```bash
npm run dev
# æˆ–
node src/index.js
```

**ç”Ÿäº§ç¯å¢ƒ (PM2)**:
```bash
pm2 start src/index.js --name "hiscrm-master"
pm2 logs hiscrm-master
pm2 restart hiscrm-master
```

### æ•°æ®åº“åˆå§‹åŒ–

- é¦–æ¬¡å¯åŠ¨ä¼šè‡ªåŠ¨åˆ›å»ºæ•°æ®åº“å’Œè¡¨
- æ•°æ®åº“ä½ç½®: `packages/master/data/master.db`
- è¿ç§»è„šæœ¬è‡ªåŠ¨æ‰§è¡Œ: `src/database/migrations/`

### æ—¥å¿—

- æ—¥å¿—ä½ç½®: `packages/master/logs/master.log`
- æŸ¥çœ‹æ—¥å¿—: `tail -f packages/master/logs/master.log`

---

## ğŸ“Š HTTP API ç«¯ç‚¹

### è´¦æˆ·ç®¡ç†
- `GET /api/v1/accounts` - è·å–è´¦æˆ·åˆ—è¡¨
- `POST /api/v1/accounts` - åˆ›å»ºè´¦æˆ·
- `PUT /api/v1/accounts/:id` - æ›´æ–°è´¦æˆ·
- `DELETE /api/v1/accounts/:id` - åˆ é™¤è´¦æˆ·

### Worker ç®¡ç†
- `GET /api/v1/workers` - è·å– Worker åˆ—è¡¨
- `GET /api/v1/workers/:id` - è·å– Worker è¯¦æƒ…
- `POST /api/v1/workers/:id/lifecycle/start` - å¯åŠ¨ Worker
- `POST /api/v1/workers/:id/lifecycle/stop` - åœæ­¢ Worker
- `POST /api/v1/workers/:id/lifecycle/restart` - é‡å¯ Worker

### æ¶ˆæ¯æŸ¥è¯¢
- `GET /api/v1/messages/comments` - è·å–è¯„è®ºåˆ—è¡¨
- `GET /api/v1/messages/direct-messages` - è·å–ç§ä¿¡åˆ—è¡¨

### ç»Ÿè®¡ä¿¡æ¯
- `GET /api/v1/statistics` - è·å–ç³»ç»Ÿç»Ÿè®¡
- `GET /api/v1/status` - è·å–ç³»ç»ŸçŠ¶æ€
- `GET /health` - å¥åº·æ£€æŸ¥

---

## ğŸ” å®‰å…¨æ€§è€ƒè™‘

### æ•°æ®åŠ å¯†ï¼ˆå¾…å®ç°ï¼‰
- Cookie ä½¿ç”¨ AES-256 åŠ å¯†å­˜å‚¨
- æ•æ„Ÿé…ç½®åŠ å¯†

### Socket.IO è®¤è¯ï¼ˆå¾…å®ç°ï¼‰
- Token éªŒè¯
- å‘½åç©ºé—´æƒé™æ§åˆ¶

### API æƒé™æ§åˆ¶ï¼ˆå¾…å®ç°ï¼‰
- JWT Token è®¤è¯
- è§’è‰²æƒé™ç®¡ç†

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Worker ç«¯è®¾è®¡æ–¹æ¡ˆ](./Workerç«¯è®¾è®¡æ–¹æ¡ˆ.md)
- [Admin Web è®¾è®¡æ–¹æ¡ˆ](./AdminWebè®¾è®¡æ–¹æ¡ˆ.md)
- [Shared æ¨¡å—è¯´æ˜](./shared-æ¨¡å—è¯´æ˜.md)
- [å¿«é€Ÿå¼€å§‹æŒ‡å—](./QUICKSTART.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0.0
**æœ€åæ›´æ–°**: 2025-10-16
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ
