# 实时消息推送系统使用指南

## 系统架构

```
┌─────────┐         ┌─────────┐         ┌──────────────┐         ┌─────────────┐
│ Worker  │────────▶│ Master  │────────▶│  Admin Web   │         │  Database   │
│(爬虫检测)│  Socket │(处理转发)│  Socket │ (Toast通知)  │         │(notifications)│
└─────────┘         └─────────┘         └──────────────┘         └─────────────┘
                        │  │
                        │  └───────────▶ Desktop Client (桌面通知)
                        └───────────────▶ Mobile Client (推送通知)
```

## 1. Worker 端推送通知

### 1.1 基本用法

在任何平台脚本中（继承自 `PlatformBase`）调用：

```javascript
// packages/worker/src/platforms/douyin/platform.js
class DouyinPlatform extends PlatformBase {
  async crawlComments(account) {
    try {
      const comments = await this.scrapeComments(account.id);

      // 发现新评论时推送通知
      if (comments.length > 0) {
        await this.pushNotification({
          type: 'comment',
          accountId: account.id,
          title: `收到 ${comments.length} 条新评论`,
          content: `账号 "${account.account_name}" 有新评论`,
          data: {
            comments: comments,  // 完整数据
            count: comments.length,
            preview: comments[0].content,  // 第一条预览
          },
          relatedId: comments[0].id,  // 关联的评论 ID
          priority: 'normal',  // 优先级: low/normal/high/urgent
        });
      }

      return { comments, stats: { recent_comments_count: comments.length } };
    } catch (error) {
      logger.error('Failed to crawl comments:', error);
      throw error;
    }
  }
}
```

### 1.2 通知类型和参数

```javascript
await this.pushNotification({
  // 必填字段
  type: string,           // 'comment' | 'direct_message' | 'system' | 'account_status'
  title: string,          // 通知标题
  content: string,        // 通知内容

  // 可选字段
  accountId: string,      // 关联账户 ID
  data: object,           // 附加数据（任意 JSON 对象）
  relatedId: string,      // 关联的评论/私信 ID
  priority: string,       // 优先级: 'low' | 'normal' | 'high' | 'urgent'
});
```

### 1.3 常见场景示例

#### 场景 1: 新评论通知

```javascript
await this.pushNotification({
  type: 'comment',
  accountId: account.id,
  title: '新评论',
  content: `${comment.author_name} 评论了你的作品`,
  data: {
    comment_id: comment.id,
    author: comment.author_name,
    content: comment.content,
    post_title: comment.post_title,
  },
  relatedId: comment.id,
  priority: 'normal',
});
```

#### 场景 2: 新私信通知

```javascript
await this.pushNotification({
  type: 'direct_message',
  accountId: account.id,
  title: '新私信',
  content: `${message.sender_name} 给你发送了私信`,
  data: {
    message_id: message.id,
    sender: message.sender_name,
    content: message.content,
  },
  relatedId: message.id,
  priority: 'high',  // 私信优先级更高
});
```

#### 场景 3: 账号状态异常

```javascript
await this.pushNotification({
  type: 'account_status',
  accountId: account.id,
  title: '账号登录过期',
  content: `账号 "${account.account_name}" 需要重新登录`,
  data: {
    reason: 'Cookie过期',
    error_code: 'AUTH_EXPIRED',
  },
  priority: 'urgent',  // 紧急通知
});
```

#### 场景 4: 系统通知

```javascript
await this.pushNotification({
  type: 'system',
  title: 'Worker 启动成功',
  content: `Worker ${this.workerId} 已成功启动并连接到 Master`,
  data: {
    worker_id: this.workerId,
    capabilities: ['douyin', 'xiaohongshu'],
  },
  priority: 'low',
});
```

## 2. Master 端处理

### 2.1 自动处理流程

Master 收到通知后会自动：
1. ✅ 验证通知字段完整性
2. ✅ 保存通知到数据库 (`notifications` 表)
3. ✅ 实时转发到所有连接的客户端
4. ✅ 标记通知为已发送

### 2.2 数据库存储

```sql
CREATE TABLE notifications (
  id TEXT PRIMARY KEY,               -- UUID
  type TEXT NOT NULL,                -- 'comment' | 'direct_message' | 'system' | 'account_status'
  account_id TEXT,                   -- 关联账户 ID
  related_id TEXT,                   -- 关联的评论/私信 ID
  title TEXT NOT NULL,               -- 通知标题
  content TEXT NOT NULL,             -- 通知内容
  data TEXT,                         -- JSON 格式的附加数据
  is_sent BOOLEAN DEFAULT 0,         -- 是否已发送
  sent_at INTEGER,                   -- 发送时间戳
  created_at INTEGER NOT NULL,       -- 创建时间戳
  FOREIGN KEY (account_id) REFERENCES accounts(id)
);
```

### 2.3 查询通知 API

```javascript
// packages/master/src/notification/notification-handler.js

// 获取通知列表
const notifications = await notificationHandler.getNotifications({
  type: 'comment',        // 可选: 按类型过滤
  accountId: 'xxx',       // 可选: 按账户过滤
  limit: 50,              // 分页: 每页数量
  offset: 0,              // 分页: 偏移量
  unreadOnly: false,      // 可选: 仅未读
});

// 获取通知统计
const stats = await notificationHandler.getNotificationStats();
// 返回:
// {
//   total: 1234,
//   sent: 1200,
//   pending: 34,
//   today: 56,
//   by_type: {
//     comment: 800,
//     direct_message: 300,
//     system: 100,
//     account_status: 34
//   }
// }

// 清理旧通知 (保留最近 30 天)
const deletedCount = await notificationHandler.cleanupOldNotifications(30);
```

## 3. Admin Web 端接收

### 3.1 监听实时通知

```javascript
// packages/admin-web/src/services/socketContext.js

useEffect(() => {
  if (!socket) return;

  // 监听新通知
  socket.on('notification:new', (notification) => {
    console.log('收到新通知:', notification);

    // 显示 Toast 通知
    showToast(notification);

    // 更新未读计数
    updateUnreadCount();

    // 可选: 播放提示音
    playNotificationSound();
  });

  return () => {
    socket.off('notification:new');
  };
}, [socket]);
```

### 3.2 通知对象结构

```javascript
{
  id: 'uuid',                    // 通知 ID
  type: 'comment',               // 通知类型
  title: '新评论',               // 标题
  content: '张三 评论了你的作品', // 内容
  data: {                        // 附加数据 (已解析)
    comment_id: 'xxx',
    author: '张三',
    content: '评论内容...',
    post_title: '作品标题'
  },
  account: {                     // 关联账户信息 (如果有)
    id: 'xxx',
    account_name: '我的账号',
    platform: 'douyin',
    user_info: {
      nickname: '用户昵称',
      avatar: 'https://...',
      douyin_id: 'xxx'
    }
  },
  priority: 'normal',            // 优先级
  created_at: 1234567890000,     // 创建时间戳
  timestamp: 1234567890000       // 发送时间戳
}
```

### 3.3 Toast 通知示例 (使用 Ant Design)

```javascript
import { notification } from 'antd';
import { CommentOutlined, MessageOutlined, WarningOutlined } from '@ant-design/icons';

function showToast(notif) {
  // 根据类型选择图标和颜色
  let config = {
    placement: 'bottomRight',
    duration: 4.5,
  };

  switch (notif.type) {
    case 'comment':
      config.icon = <CommentOutlined style={{ color: '#1890ff' }} />;
      break;
    case 'direct_message':
      config.icon = <MessageOutlined style={{ color: '#52c41a' }} />;
      break;
    case 'account_status':
      config.icon = <WarningOutlined style={{ color: '#faad14' }} />;
      config.duration = 0;  // 不自动关闭
      break;
    default:
      break;
  }

  notification.open({
    ...config,
    message: notif.title,
    description: notif.content,
    onClick: () => {
      // 点击跳转到详情
      if (notif.type === 'comment' && notif.related_id) {
        window.location.href = `/messages/comments/${notif.related_id}`;
      } else if (notif.type === 'direct_message' && notif.related_id) {
        window.location.href = `/messages/dms/${notif.related_id}`;
      }
    },
  });
}
```

## 4. 消息历史查看

### 4.1 创建消息历史页面

```javascript
// packages/admin-web/src/pages/NotificationsPage.js
import React, { useEffect, useState } from 'react';
import { Table, Tag, Space, Button } from 'antd';

function NotificationsPage() {
  const [notifications, setNotifications] = useState([]);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    fetchNotifications();
  }, []);

  const fetchNotifications = async () => {
    setLoading(true);
    try {
      const response = await fetch('/api/v1/notifications?limit=100');
      const data = await response.json();
      setNotifications(data.notifications);
    } catch (error) {
      console.error('Failed to fetch notifications:', error);
    } finally {
      setLoading(false);
    }
  };

  const columns = [
    {
      title: '类型',
      dataIndex: 'type',
      key: 'type',
      width: 120,
      render: (type) => {
        const colorMap = {
          comment: 'blue',
          direct_message: 'green',
          system: 'gray',
          account_status: 'orange',
        };
        return <Tag color={colorMap[type]}>{type}</Tag>;
      },
    },
    {
      title: '标题',
      dataIndex: 'title',
      key: 'title',
    },
    {
      title: '内容',
      dataIndex: 'content',
      key: 'content',
      ellipsis: true,
    },
    {
      title: '账户',
      dataIndex: ['account', 'account_name'],
      key: 'account',
      render: (name) => name || '-',
    },
    {
      title: '时间',
      dataIndex: 'created_at',
      key: 'created_at',
      render: (timestamp) => new Date(timestamp).toLocaleString(),
    },
  ];

  return (
    <div>
      <Space style={{ marginBottom: 16 }}>
        <Button type="primary" onClick={fetchNotifications}>
          刷新
        </Button>
      </Space>
      <Table
        columns={columns}
        dataSource={notifications}
        rowKey="id"
        loading={loading}
        pagination={{ pageSize: 20 }}
      />
    </div>
  );
}

export default NotificationsPage;
```

### 4.2 添加 API 路由 (Master)

```javascript
// packages/master/src/api/routes/notifications.js
const express = require('express');

function createNotificationsRouter(notificationHandler) {
  const router = express.Router();

  // GET /api/v1/notifications - 获取通知列表
  router.get('/', async (req, res) => {
    try {
      const { type, accountId, limit = 50, offset = 0 } = req.query;

      const notifications = await notificationHandler.getNotifications({
        type,
        accountId,
        limit: parseInt(limit),
        offset: parseInt(offset),
      });

      res.json({
        success: true,
        notifications,
      });
    } catch (error) {
      res.status(500).json({
        success: false,
        error: error.message,
      });
    }
  });

  // GET /api/v1/notifications/stats - 获取统计信息
  router.get('/stats', async (req, res) => {
    try {
      const stats = await notificationHandler.getNotificationStats();
      res.json({
        success: true,
        stats,
      });
    } catch (error) {
      res.status(500).json({
        success: false,
        error: error.message,
      });
    }
  });

  return router;
}

module.exports = createNotificationsRouter;
```

## 5. 最佳实践

### 5.1 通知优先级建议

- **urgent (紧急)**: 账号被封禁、登录过期、系统错误
- **high (高)**: 私信、@提及、重要评论
- **normal (普通)**: 普通评论、点赞通知
- **low (低)**: 系统信息、统计报告

### 5.2 避免通知轰炸

```javascript
// 使用防抖机制，合并相同类型的通知
class NotificationDebouncer {
  constructor(pushFn, delay = 5000) {
    this.pushFn = pushFn;
    this.delay = delay;
    this.queue = new Map();  // type -> notifications[]
    this.timers = new Map();  // type -> timer
  }

  push(notification) {
    const { type } = notification;

    // 加入队列
    if (!this.queue.has(type)) {
      this.queue.set(type, []);
    }
    this.queue.get(type).push(notification);

    // 清除旧定时器
    if (this.timers.has(type)) {
      clearTimeout(this.timers.get(type));
    }

    // 设置新定时器
    const timer = setTimeout(() => {
      this.flush(type);
    }, this.delay);

    this.timers.set(type, timer);
  }

  flush(type) {
    const notifications = this.queue.get(type);
    if (!notifications || notifications.length === 0) return;

    // 合并多条通知
    if (notifications.length === 1) {
      this.pushFn(notifications[0]);
    } else {
      this.pushFn({
        type,
        title: `收到 ${notifications.length} 条${this.getTypeLabel(type)}`,
        content: '点击查看详情',
        data: {
          notifications,
          count: notifications.length,
        },
        priority: 'normal',
      });
    }

    // 清理
    this.queue.delete(type);
    this.timers.delete(type);
  }

  getTypeLabel(type) {
    const labels = {
      comment: '新评论',
      direct_message: '新私信',
      system: '系统通知',
      account_status: '账号通知',
    };
    return labels[type] || '通知';
  }
}

// 使用示例
const debouncer = new NotificationDebouncer(
  (notif) => this.pushNotification(notif),
  5000  // 5秒内的通知合并
);

// 爬虫检测到新消息时
comments.forEach(comment => {
  debouncer.push({
    type: 'comment',
    accountId: account.id,
    title: '新评论',
    content: `${comment.author_name} 评论了你的作品`,
    data: { comment },
  });
});
```

### 5.3 性能优化

```javascript
// 定期清理旧通知 (保留最近 30 天)
setInterval(async () => {
  try {
    const deletedCount = await notificationHandler.cleanupOldNotifications(30);
    logger.info(`Cleaned up ${deletedCount} old notifications`);
  } catch (error) {
    logger.error('Failed to cleanup old notifications:', error);
  }
}, 24 * 60 * 60 * 1000);  // 每天执行一次
```

## 6. 完整调用示例

### Worker 端完整示例

```javascript
// packages/worker/src/platforms/douyin/platform.js
class DouyinPlatform extends PlatformBase {
  async crawlComments(account) {
    try {
      logger.info(`Crawling comments for account ${account.id}`);

      // 1. 爬取评论
      const comments = await this.scrapeComments(account.id);

      // 2. 过滤新评论 (假设有缓存机制)
      const newComments = comments.filter(c => !this.isCommentCached(c.id));

      if (newComments.length > 0) {
        logger.info(`Found ${newComments.length} new comments`);

        // 3. 推送通知
        if (newComments.length === 1) {
          // 单条评论 - 详细通知
          const comment = newComments[0];
          await this.pushNotification({
            type: 'comment',
            accountId: account.id,
            title: '新评论',
            content: `${comment.author_name}: ${comment.content.substring(0, 50)}...`,
            data: { comment },
            relatedId: comment.id,
            priority: 'normal',
          });
        } else {
          // 多条评论 - 汇总通知
          await this.pushNotification({
            type: 'comment',
            accountId: account.id,
            title: `收到 ${newComments.length} 条新评论`,
            content: `账号 "${account.account_name}" 有新评论`,
            data: {
              comments: newComments,
              count: newComments.length,
              preview: newComments[0].content,
            },
            relatedId: newComments[0].id,
            priority: 'normal',
          });
        }

        // 4. 缓存新评论 ID
        newComments.forEach(c => this.cacheCommentId(c.id));
      }

      return {
        comments: newComments,
        stats: {
          recent_comments_count: newComments.length,
          total_comments: comments.length,
        },
      };
    } catch (error) {
      logger.error(`Failed to crawl comments for account ${account.id}:`, error);

      // 爬取失败也推送通知
      await this.pushNotification({
        type: 'system',
        accountId: account.id,
        title: '评论爬取失败',
        content: `账号 "${account.account_name}" 评论爬取出错: ${error.message}`,
        data: {
          error: error.message,
          stack: error.stack,
        },
        priority: 'high',
      });

      throw error;
    }
  }
}
```

## 7. 故障排查

### 7.1 通知未收到

1. 检查 Worker 是否连接到 Master:
   ```bash
   # Master 日志
   grep "Worker connected" packages/master/logs/master.log
   ```

2. 检查通知是否推送:
   ```bash
   # Worker 日志
   grep "Notification pushed" packages/worker/logs/worker.log
   ```

3. 检查 Master 是否接收:
   ```bash
   # Master 日志
   grep "Notification saved to database" packages/master/logs/master.log
   ```

4. 检查 Admin Web 是否连接:
   ```javascript
   // 浏览器控制台
   console.log('Socket connected:', socket.connected);
   ```

### 7.2 数据库查询

```sql
-- 查看最近的通知
SELECT * FROM notifications
ORDER BY created_at DESC
LIMIT 10;

-- 统计通知数量
SELECT type, COUNT(*) as count
FROM notifications
GROUP BY type;

-- 查看未发送的通知
SELECT * FROM notifications
WHERE is_sent = 0;
```

## 8. 总结

实时消息推送系统已完整实现：
- ✅ Worker 推送接口
- ✅ Master 处理和转发
- ✅ 数据库持久化
- ✅ 实时广播到客户端

下一步可以：
1. 在 Admin Web 中实现 Toast 通知 UI
2. 创建消息历史查看页面
3. 添加未读消息计数
4. 实现 Desktop Client 的桌面通知
5. 实现 Mobile Client 的推送通知
