# ç™»å½•æ•°æ®ä¿å­˜åŠŸèƒ½å®ç°æŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-16
**ç‰ˆæœ¬**: 1.0.0
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ é—®é¢˜æè¿°

åœ¨åŸæœ‰å®ç°ä¸­,Worker ç™»å½•æˆåŠŸå:
- âŒ Cookie åªä¿å­˜åœ¨ Worker æœ¬åœ°æ–‡ä»¶,æ²¡æœ‰åŒæ­¥åˆ° Master æ•°æ®åº“
- âŒ ç”¨æˆ·ä¿¡æ¯(æ˜µç§°ã€å¤´åƒã€æŠ–éŸ³å·)æ²¡æœ‰ä¿å­˜
- âŒ æµè§ˆå™¨æŒ‡çº¹é…ç½®æ²¡æœ‰ä¿å­˜åˆ°æ•°æ®åº“
- âŒ Admin Web æ— æ³•æŸ¥çœ‹ç™»å½•å‡­æ®å’Œç”¨æˆ·ä¿¡æ¯

å¯¼è‡´çš„é—®é¢˜:
- é‡å¯ Master åæ— æ³•æŸ¥çœ‹è´¦æˆ·çš„ç™»å½•çŠ¶æ€å’Œä¿¡æ¯
- æ— æ³•é›†ä¸­ç®¡ç†è´¦æˆ·çš„ Cookie å’Œå‡­æ®
- Admin ç•Œé¢æ— æ³•æ˜¾ç¤ºç™»å½•çš„ç”¨æˆ·ä¿¡æ¯

---

## ğŸ¯ å®æ–½ç›®æ ‡

å°†ç™»å½•æˆåŠŸåçš„å®Œæ•´æ•°æ®ä¿å­˜åˆ° Master æ•°æ®åº“çš„ `accounts` è¡¨:
- âœ… Cookie æ•°ç»„ (`credentials` å­—æ®µ)
- âœ… ç”¨æˆ·ä¿¡æ¯ - æ˜µç§°ã€å¤´åƒã€æŠ–éŸ³å·ç­‰ (`user_info` å­—æ®µ)
- âœ… æµè§ˆå™¨æŒ‡çº¹é…ç½® (`fingerprint` å­—æ®µ)
- âœ… Cookie æœ‰æ•ˆæœŸ (`cookies_valid_until` å­—æ®µ)

---

## ğŸ—ï¸ æ¶æ„è¯´æ˜

### æ•°æ®è¡¨è®¾è®¡

#### `accounts` è¡¨
å­˜å‚¨è´¦æˆ·çš„**é•¿æœŸæ•°æ®å’Œç™»å½•å‡­æ®**:

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `credentials` | TEXT (JSON) | Cookie æ•°ç»„,æ ¼å¼: `{"cookies": [{name, value, domain, ...}]}` |
| `user_info` | TEXT (JSON) | ç”¨æˆ·ä¿¡æ¯,æ ¼å¼: `{nickname, avatar, douyin_id, uid, ...}` |
| `fingerprint` | TEXT (JSON) | æµè§ˆå™¨æŒ‡çº¹é…ç½® (15+ ç§æŒ‡çº¹ç‰¹å¾) |
| `login_status` | TEXT | ç™»å½•çŠ¶æ€: `logged_in`, `logging_in`, `not_logged_in`, `login_failed` |
| `last_login_time` | INTEGER | æœ€åç™»å½•æ—¶é—´ (Unix æ—¶é—´æˆ³) |
| `cookies_valid_until` | INTEGER | Cookie æœ‰æ•ˆæœŸ (Unix æ—¶é—´æˆ³,é»˜è®¤ 7 å¤©) |

#### `login_sessions` è¡¨
å­˜å‚¨**ç™»å½•ä¼šè¯è¿‡ç¨‹**è®°å½• (ä¸´æ—¶æ•°æ®):

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `id` | TEXT | ä¼šè¯ ID (UUID) |
| `account_id` | TEXT | å…³è”çš„è´¦æˆ· ID |
| `status` | TEXT | ä¼šè¯çŠ¶æ€: `pending`, `scanning`, `success`, `failed`, `expired` |
| `qr_code_data` | TEXT | äºŒç»´ç  Base64 æ•°æ® |
| `created_at` | INTEGER | åˆ›å»ºæ—¶é—´ |
| `expires_at` | INTEGER | è¿‡æœŸæ—¶é—´ (5 åˆ†é’Ÿ) |

**è¯´æ˜**:
- `accounts` è¡¨å­˜å‚¨è´¦æˆ·çš„ç™»å½•å‡­æ®å’Œé•¿æœŸæ•°æ®
- `login_sessions` è¡¨ä»…ç”¨äºè·Ÿè¸ªç™»å½•è¿‡ç¨‹(äºŒç»´ç æ‰«ç æµç¨‹)
- Admin Web çš„ `/accounts` é¡µé¢æ˜¾ç¤º `accounts` è¡¨æ•°æ®
- Admin Web çš„ `/login` é¡µé¢æ˜¾ç¤º `login_sessions` è¡¨æ•°æ®

---

## ğŸ“¦ å®æ–½æ­¥éª¤

### 1. æ•°æ®åº“è¿ç§»

åˆ›å»ºè¿ç§»è„šæœ¬ `001_add_user_info_and_fingerprint.sql`:

```sql
-- æ·»åŠ  user_info å­—æ®µ (JSONæ ¼å¼,å­˜å‚¨ç”¨æˆ·ä¿¡æ¯)
ALTER TABLE accounts ADD COLUMN user_info TEXT;

-- æ·»åŠ  fingerprint å­—æ®µ (JSONæ ¼å¼,å­˜å‚¨æµè§ˆå™¨æŒ‡çº¹é…ç½®)
ALTER TABLE accounts ADD COLUMN fingerprint TEXT;

-- æ·»åŠ ç´¢å¼•ä»¥ä¾¿å¿«é€ŸæŸ¥è¯¢
CREATE INDEX IF NOT EXISTS idx_accounts_platform_account
  ON accounts(platform, account_id);
```

**ä½ç½®**: [packages/master/src/database/migrations/001_add_user_info_and_fingerprint.sql](../packages/master/src/database/migrations/001_add_user_info_and_fingerprint.sql)

### 2. Worker ç«¯ä¿®æ”¹

#### ä¿®æ”¹ `platform-base.js`

åœ¨ç™»å½•æˆåŠŸå,è·å– Cookie å’ŒæŒ‡çº¹,å¹¶å‘é€åˆ° Master:

```javascript
// packages/worker/src/platforms/base/platform-base.js:136-161

if (loginStatus.isLoggedIn) {
  // ç™»å½•æˆåŠŸ!
  clearInterval(checkTimer);

  logger.info(`[Login Monitor] Login successful for account ${accountId}`);

  // ä¿å­˜ç™»å½•çŠ¶æ€(Cookieã€Storage)
  await this.saveLoginState(page, accountId);

  // è·å– Cookie å’ŒæŒ‡çº¹æ•°æ®ä»¥å‘é€åˆ° Master
  const cookies = await page.context().cookies();
  const fingerprint = this.browserManager.getOrCreateFingerprintConfig(accountId);

  // é€šçŸ¥ Master â†’ Admin Web (åŒ…å« Cookieã€ç”¨æˆ·ä¿¡æ¯ã€æŒ‡çº¹)
  this.sendLoginStatus(sessionId, 'success', {
    account_id: accountId,
    user_info: loginStatus.userInfo,
    cookies: cookies,  // å‘é€ Cookie æ•°ç»„
    fingerprint: fingerprint,  // å‘é€æŒ‡çº¹é…ç½®
    cookies_valid_until: Math.floor(Date.now() / 1000) + (86400 * 7), // 7å¤©æœ‰æ•ˆæœŸ
    timestamp: Date.now(),
  });

  logger.info(`[Login Monitor] Sent login success with ${cookies.length} cookies and fingerprint`);

  resolve(true);
}
```

**ä¿®æ”¹æ–‡ä»¶**: [packages/worker/src/platforms/base/platform-base.js:136-161](../packages/worker/src/platforms/base/platform-base.js#L136-L161)

### 3. Master ç«¯ä¿®æ”¹

#### ä¿®æ”¹ `LoginHandler.handleLoginSuccess()`

æ¥æ”¶å¹¶ä¿å­˜å®Œæ•´çš„ç™»å½•æ•°æ®åˆ° `accounts` è¡¨:

```javascript
// packages/master/src/login/login-handler.js:131-210

handleLoginSuccess(sessionId, cookies = null, cookiesValidUntil = null,
                   realAccountId = null, userInfo = null, fingerprint = null) {
  try {
    const session = this.getSession(sessionId);
    if (!session) {
      logger.warn(`Session not found: ${sessionId}`);
      return;
    }

    const now = Math.floor(Date.now() / 1000);

    // æ›´æ–°ç™»å½•ä¼šè¯çŠ¶æ€
    const sessionStmt = this.db.prepare(`
      UPDATE login_sessions
      SET status = 'success', logged_in_at = ?
      WHERE id = ?
    `);
    sessionStmt.run(now, sessionId);

    // æ£€æŸ¥å½“å‰è´¦æˆ·IDæ˜¯å¦ä¸ºä¸´æ—¶ID
    const account = this.db.prepare(`SELECT account_id FROM accounts WHERE id = ?`)
      .get(session.account_id);
    const isTemporaryId = account && account.account_id.startsWith('temp_');

    // æ„å»ºæ›´æ–° SQL
    let updateSql = `
      UPDATE accounts
      SET login_status = 'logged_in',
          last_login_time = ?,
          cookies_valid_until = ?,
          credentials = ?,
          user_info = ?,
          fingerprint = ?
    `;

    const params = [
      now,
      cookiesValidUntil || now + 86400 * 7,
      cookies ? JSON.stringify({ cookies }) : '{}',
      userInfo ? JSON.stringify(userInfo) : null,
      fingerprint ? JSON.stringify(fingerprint) : null,
    ];

    // å¦‚æœæä¾›äº†çœŸå®IDä¸”å½“å‰æ˜¯ä¸´æ—¶ID,åˆ™æ›´æ–° account_id
    if (realAccountId && isTemporaryId) {
      updateSql += ', account_id = ?';
      params.push(realAccountId);
      logger.info(`Updating temporary account_id to real ID: ${account.account_id} -> ${realAccountId}`);
    }

    updateSql += ' WHERE id = ?';
    params.push(session.account_id);

    const accountStmt = this.db.prepare(updateSql);
    accountStmt.run(...params);

    logger.info(`Login success for session ${sessionId}, account ${session.account_id}`);
    logger.info(`Saved: ${cookies ? cookies.length : 0} cookies, user_info: ${userInfo ? userInfo.nickname || 'unknown' : 'null'}, fingerprint: ${fingerprint ? 'yes' : 'no'}`);

    // æ¨é€ç»™ç®¡ç†å‘˜
    if (this.adminNamespace) {
      this.adminNamespace.broadcastToAdmins('login:success', {
        session_id: sessionId,
        account_id: session.account_id,
        worker_id: session.worker_id,
        logged_in_at: now,
        user_info: userInfo,  // åŒ…å«ç”¨æˆ·ä¿¡æ¯
        timestamp: Date.now(),
      });
    }

    // æ¸…ç†ä¼šè¯ç¼“å­˜(ç™»å½•æˆåŠŸåä¸å†éœ€è¦)
    this.sessions.delete(sessionId);

  } catch (error) {
    logger.error('Failed to handle login success:', error);
  }
}
```

**ä¿®æ”¹æ–‡ä»¶**: [packages/master/src/login/login-handler.js:131-210](../packages/master/src/login/login-handler.js#L131-L210)

#### ä¿®æ”¹ Socket å¤„ç†å™¨

åœ¨ `index.js` ä¸­ä¿®æ”¹ç™»å½•æˆåŠŸå¤„ç†å™¨,ä¼ é€’å®Œæ•´æ•°æ®:

```javascript
// packages/master/src/index.js:270-282

tempHandlers.onLoginSuccess = (data) => {
  // æå–çœŸå®çš„è´¦æˆ·ID (ä» user_info.uid æˆ– user_info.douyin_id)
  const realAccountId = data.user_info ? (data.user_info.uid || data.user_info.douyin_id) : null;

  loginHandler.handleLoginSuccess(
    data.session_id,
    data.cookies,           // Cookie æ•°ç»„
    data.cookies_valid_until,
    realAccountId,          // çœŸå®è´¦æˆ·ID
    data.user_info,         // ç”¨æˆ·ä¿¡æ¯
    data.fingerprint        // æµè§ˆå™¨æŒ‡çº¹
  );
};
```

**ä¿®æ”¹æ–‡ä»¶**: [packages/master/src/index.js:270-282](../packages/master/src/index.js#L270-L282)

### 4. Admin Web ä¿®æ”¹

#### ä¿®æ”¹ `AccountsPage.js`

åœ¨è´¦æˆ·ç®¡ç†é¡µé¢æ·»åŠ åˆ—æ˜¾ç¤º:
- ç”¨æˆ·ä¿¡æ¯(å¤´åƒ + æ˜µç§°/æŠ–éŸ³å·)
- ç™»å½•çŠ¶æ€
- Cookie çŠ¶æ€(æ•°é‡ + æœ‰æ•ˆæœŸ)

```javascript
// packages/admin-web/src/pages/AccountsPage.js

// è§£æå¹¶å±•ç¤ºç”¨æˆ·ä¿¡æ¯
const renderUserInfo = (record) => {
  try {
    const userInfo = record.user_info ? JSON.parse(record.user_info) : null;
    if (!userInfo) return '-';

    return (
      <Space>
        {userInfo.avatar && (
          <img
            src={userInfo.avatar}
            alt="avatar"
            style={{ width: 24, height: 24, borderRadius: '50%' }}
          />
        )}
        <span>{userInfo.nickname || userInfo.douyin_id || '-'}</span>
      </Space>
    );
  } catch (e) {
    return '-';
  }
};

// è§£æå¹¶å±•ç¤º Cookie çŠ¶æ€
const renderCookieStatus = (record) => {
  try {
    const credentials = record.credentials ? JSON.parse(record.credentials) : null;
    const cookieCount = credentials && credentials.cookies ? credentials.cookies.length : 0;
    const validUntil = record.cookies_valid_until;
    const now = Math.floor(Date.now() / 1000);
    const isExpired = validUntil && validUntil < now;

    if (cookieCount === 0) {
      return <Tag color="default">æ—  Cookie</Tag>;
    }

    return (
      <Space direction="vertical" size={0}>
        <Tag color={isExpired ? 'red' : 'green'}>
          {cookieCount} ä¸ª Cookie
        </Tag>
        {validUntil && (
          <span style={{ fontSize: 12, color: isExpired ? '#ff4d4f' : '#999' }}>
            {isExpired ? 'å·²è¿‡æœŸ' : `æœ‰æ•ˆæœŸè‡³ ${new Date(validUntil * 1000).toLocaleDateString()}`}
          </span>
        )}
      </Space>
    );
  } catch (e) {
    return '-';
  }
};

// è¡¨æ ¼åˆ—æ·»åŠ :
{
  title: 'ç”¨æˆ·ä¿¡æ¯',
  key: 'user_info',
  width: 150,
  render: (_, record) => renderUserInfo(record),
},
{
  title: 'ç™»å½•çŠ¶æ€',
  dataIndex: 'login_status',
  key: 'login_status',
  width: 100,
  render: (status) => {
    const statusMap = {
      logged_in: { color: 'success', text: 'å·²ç™»å½•' },
      logging_in: { color: 'processing', text: 'ç™»å½•ä¸­' },
      login_failed: { color: 'error', text: 'ç™»å½•å¤±è´¥' },
      not_logged_in: { color: 'default', text: 'æœªç™»å½•' },
    };
    const config = statusMap[status] || statusMap.not_logged_in;
    return <Tag color={config.color}>{config.text}</Tag>;
  },
},
{
  title: 'Cookie çŠ¶æ€',
  key: 'cookie_status',
  width: 120,
  render: (_, record) => renderCookieStatus(record),
}
```

**ä¿®æ”¹æ–‡ä»¶**: [packages/admin-web/src/pages/AccountsPage.js:119-283](../packages/admin-web/src/pages/AccountsPage.js#L119-L283)

---

## âœ… å®æ–½ç»“æœ

### æ•°æ®æµç¨‹

```
ç™»å½•æˆåŠŸ
    â†“
Worker æå–æ•°æ®:
  - page.context().cookies() â†’ Cookie æ•°ç»„
  - browserManager.getOrCreateFingerprintConfig() â†’ æŒ‡çº¹é…ç½®
  - extractUserInfo() â†’ ç”¨æˆ·ä¿¡æ¯ (nickname, avatar, douyin_id)
    â†“
Worker â†’ Master Socket:
  worker:login:status {
    status: 'success',
    cookies: [{...}, {...}],
    user_info: {nickname, avatar, douyin_id, ...},
    fingerprint: {userAgent, viewport, webgl, ...},
    cookies_valid_until: timestamp
  }
    â†“
Master LoginHandler:
  - æ›´æ–° accounts è¡¨:
    * credentials = JSON.stringify({cookies})
    * user_info = JSON.stringify(userInfo)
    * fingerprint = JSON.stringify(fingerprint)
    * login_status = 'logged_in'
    * last_login_time = now
    * cookies_valid_until = now + 7å¤©
  - æ›´æ–° login_sessions è¡¨:
    * status = 'success'
    * logged_in_at = now
    â†“
Admin Web æ˜¾ç¤º:
  - ç”¨æˆ·å¤´åƒ + æ˜µç§°/æŠ–éŸ³å·
  - ç™»å½•çŠ¶æ€æ ‡ç­¾ (ç»¿è‰²"å·²ç™»å½•")
  - Cookie æ•°é‡ + æœ‰æ•ˆæœŸ
```

### æ•°æ®åº“ç¤ºä¾‹

#### `accounts` è¡¨æ•°æ®ç¤ºä¾‹:

```json
{
  "id": "acc-xxx",
  "platform": "douyin",
  "account_name": "æµ‹è¯•è´¦å·",
  "account_id": "1864722759",  // ç™»å½•åè‡ªåŠ¨æ›´æ–°ä¸ºçœŸå®æŠ–éŸ³å·
  "login_status": "logged_in",
  "credentials": "{\"cookies\": [{\"name\":\"sessionid\",\"value\":\"xxx\",\"domain\":\".douyin.com\",...}, ...]}",
  "user_info": "{\"nickname\":\"è‹è‹\",\"douyin_id\":\"1864722759\",\"avatar\":\"https://...\",\"followers\":\"123\"}",
  "fingerprint": "{\"userAgent\":\"Mozilla/5.0...\",\"viewport\":{\"width\":1920,\"height\":1080},\"webgl\":{\"vendor\":\"Intel Inc.\",\"renderer\":\"ANGLE...\"}}",
  "last_login_time": 1729123456,
  "cookies_valid_until": 1729728256,
  "assigned_worker_id": "worker-abc",
  "created_at": 1729000000,
  "updated_at": 1729123456
}
```

---

## ğŸ¨ Admin Web ç•Œé¢å˜åŒ–

### è´¦æˆ·ç®¡ç†é¡µé¢ (`/accounts`)

**æ–°å¢åˆ—**:
1. **ç”¨æˆ·ä¿¡æ¯** - æ˜¾ç¤ºå¤´åƒ + æ˜µç§°/æŠ–éŸ³å·
2. **ç™»å½•çŠ¶æ€** - æ ‡ç­¾æ˜¾ç¤º: å·²ç™»å½•(ç»¿è‰²) / æœªç™»å½•(ç°è‰²) / ç™»å½•ä¸­(è“è‰²) / ç™»å½•å¤±è´¥(çº¢è‰²)
3. **Cookie çŠ¶æ€** - æ˜¾ç¤º Cookie æ•°é‡ + æœ‰æ•ˆæœŸ,è¿‡æœŸæ˜¾ç¤ºçº¢è‰²

**ç¤ºä¾‹æ•ˆæœ**:
```
| ç”¨æˆ·ä¿¡æ¯          | ç™»å½•çŠ¶æ€  | Cookie çŠ¶æ€      |
|------------------|----------|-----------------|
| ğŸ§‘ è‹è‹           | âœ… å·²ç™»å½• | ğŸŸ¢ 25 ä¸ª Cookie  |
| (å¤´åƒ) 1864722759 |          | æœ‰æ•ˆæœŸè‡³ 2025-10-23 |
```

**åŠŸèƒ½æ”¹è¿›**:
- å·²ç™»å½•çš„è´¦æˆ·,"ç™»å½•"æŒ‰é’®è‡ªåŠ¨ç¦ç”¨
- Cookie è¿‡æœŸæ—¶æ˜¾ç¤ºçº¢è‰²è­¦å‘Š
- ç‚¹å‡»ç”¨æˆ·ä¿¡æ¯å¯æŸ¥çœ‹å®Œæ•´ JSON æ•°æ®(å¯é€‰åŠŸèƒ½,åç»­å®ç°)

---

## ğŸ“Š æŠ€æœ¯ç»†èŠ‚

### Cookie å­˜å‚¨æ ¼å¼

```json
{
  "cookies": [
    {
      "name": "sessionid",
      "value": "xxx",
      "domain": ".douyin.com",
      "path": "/",
      "expires": 1729728256,
      "httpOnly": true,
      "secure": true,
      "sameSite": "Lax"
    },
    ...
  ]
}
```

### ç”¨æˆ·ä¿¡æ¯æ ¼å¼

```json
{
  "nickname": "è‹è‹",
  "douyin_id": "1864722759",
  "uid": "1864722759",
  "avatar": "https://p3.douyinpic.com/aweme/...",
  "followers": "123",
  "following": "45",
  "signature": "ä¸ªæ€§ç­¾å"
}
```

### æµè§ˆå™¨æŒ‡çº¹æ ¼å¼

```json
{
  "accountId": "acc-xxx",
  "createdAt": 1729123456789,
  "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36...",
  "viewport": {"width": 1920, "height": 1080},
  "webgl": {
    "vendor": "Google Inc.",
    "renderer": "ANGLE (Intel, Intel(R) UHD Graphics 630)"
  },
  "canvas": {"noise": "A3d"},
  "audio": {"noise": 0.0001},
  "hardware": {
    "cores": 8,
    "memory": 16
  },
  "screen": {
    "width": 1920,
    "height": 1080,
    "colorDepth": 24,
    "pixelRatio": 1
  },
  "locale": "zh-CN",
  "timezone": "Asia/Shanghai",
  "fonts": ["Arial", "Helvetica", ...],
  "plugins": 4
}
```

---

## ğŸ”’ å®‰å…¨æ€§

1. **Cookie åŠ å¯†**:
   - å½“å‰å­˜å‚¨ä¸ºæ˜æ–‡ JSON
   - **å»ºè®®**: åç»­ä½¿ç”¨ AES-256 åŠ å¯† `credentials` å­—æ®µ
   - å‚è€ƒ: `packages/shared/utils/encryption.js` (éœ€åˆ›å»º)

2. **æ•°æ®è®¿é—®æ§åˆ¶**:
   - API éœ€è¦éªŒè¯ç®¡ç†å‘˜æƒé™
   - Socket.IO å‘½åç©ºé—´éš”ç¦» (`/admin`)

3. **æ—¥å¿—è„±æ•**:
   - æ—¥å¿—ä¸­ä¸è¾“å‡ºå®Œæ•´ Cookie å€¼
   - åªè®°å½• Cookie æ•°é‡å’Œç±»å‹

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. å•å…ƒæµ‹è¯•

```bash
# æµ‹è¯• LoginHandler
cd packages/master
npm test -- login-handler.test.js
```

### 2. é›†æˆæµ‹è¯•

```bash
# å®Œæ•´ç™»å½•æµç¨‹æµ‹è¯•
cd packages/worker
node test-douyin-login-interactive.js
```

**éªŒè¯ç‚¹**:
1. âœ… Worker ç™»å½•æˆåŠŸåå‘é€å®Œæ•´æ•°æ®
2. âœ… Master æ­£ç¡®ä¿å­˜åˆ° `accounts` è¡¨
3. âœ… Admin Web æ­£ç¡®æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯å’Œ Cookie çŠ¶æ€
4. âœ… æ•°æ®åº“å­—æ®µ `user_info`, `fingerprint` ä¸ä¸º NULL
5. âœ… Cookie æœ‰æ•ˆæœŸæ­£ç¡®è®¡ç®—(7å¤©å)

### 3. æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤

1. å¯åŠ¨ Master å’Œ Worker:
   ```bash
   npm run dev
   ```

2. æ‰“å¼€ Admin Web: http://localhost:3001/accounts

3. æ·»åŠ æµ‹è¯•è´¦æˆ·å¹¶å¯åŠ¨ç™»å½•

4. æ‰«ç ç™»å½•æˆåŠŸå,æ£€æŸ¥:
   - "ç”¨æˆ·ä¿¡æ¯"åˆ—æ˜¾ç¤ºå¤´åƒå’Œæ˜µç§°
   - "ç™»å½•çŠ¶æ€"æ˜¾ç¤º"å·²ç™»å½•"(ç»¿è‰²)
   - "Cookie çŠ¶æ€"æ˜¾ç¤º Cookie æ•°é‡å’Œæœ‰æ•ˆæœŸ

5. æŸ¥è¯¢æ•°æ®åº“éªŒè¯:
   ```bash
   sqlite3 packages/master/data/master.db
   SELECT id, login_status, json_extract(user_info, '$.nickname') as nickname,
          json_array_length(credentials, '$.cookies') as cookie_count,
          cookies_valid_until
   FROM accounts WHERE login_status='logged_in';
   ```

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

1. **Cookie åŠ å¯†**: ä½¿ç”¨ AES-256 åŠ å¯† `credentials` å­—æ®µ
2. **æŒ‡çº¹è¯¦æƒ…æŸ¥çœ‹**: åœ¨ Admin Web æ·»åŠ "æŸ¥çœ‹æŒ‡çº¹"æŒ‰é’®
3. **Cookie åˆ·æ–°**: å®šæœŸåˆ·æ–°å³å°†è¿‡æœŸçš„ Cookie
4. **ç™»å½•å‡­æ®å¯¼å‡º**: æ”¯æŒå¯¼å‡º Cookie ç”¨äºè°ƒè¯•
5. **å¤šè´¦æˆ·æ‰¹é‡ç™»å½•**: æ”¯æŒé€‰æ‹©å¤šä¸ªè´¦æˆ·æ‰¹é‡ç™»å½•
6. **ç™»å½•å†å²**: è®°å½•æ¯æ¬¡ç™»å½•çš„æ—¶é—´å’Œ IP

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [è´¦æˆ·çº§æµè§ˆå™¨éš”ç¦»ç™»å½•æµç¨‹è®¾è®¡](.docs/è´¦æˆ·çº§æµè§ˆå™¨éš”ç¦»ç™»å½•æµç¨‹è®¾è®¡.md)
- [é€šç”¨å¹³å°è„šæœ¬ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ](.docs/worker-é€šç”¨å¹³å°è„šæœ¬ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ.md)
- [æ•°æ®åº“å­—å…¸](.docs/archive/æ•°æ®åº“å­—å…¸.md)
- [CLAUDE.md](../CLAUDE.md) - é¡¹ç›®å¼€å‘æŒ‡å—

---

## ğŸ¯ æ€»ç»“

### å®ç°çš„åŠŸèƒ½

âœ… **Worker ç«¯**:
- ç™»å½•æˆåŠŸåæå– Cookieã€ç”¨æˆ·ä¿¡æ¯ã€æµè§ˆå™¨æŒ‡çº¹
- é€šè¿‡ Socket.IO å‘é€å®Œæ•´æ•°æ®åˆ° Master

âœ… **Master ç«¯**:
- æ¥æ”¶å¹¶ä¿å­˜åˆ° `accounts` è¡¨çš„ 3 ä¸ªå­—æ®µ: `credentials`, `user_info`, `fingerprint`
- æ›´æ–°ç™»å½•çŠ¶æ€å’Œæœ‰æ•ˆæœŸ
- æ”¯æŒä¸´æ—¶ ID è‡ªåŠ¨æ›´æ–°ä¸ºçœŸå®è´¦æˆ· ID

âœ… **æ•°æ®åº“**:
- æ·»åŠ  `user_info` å’Œ `fingerprint` å­—æ®µ
- åˆ›å»ºç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

âœ… **Admin Web**:
- æ˜¾ç¤ºç”¨æˆ·å¤´åƒå’Œæ˜µç§°
- æ˜¾ç¤ºç™»å½•çŠ¶æ€æ ‡ç­¾
- æ˜¾ç¤º Cookie æ•°é‡å’Œæœ‰æ•ˆæœŸ
- Cookie è¿‡æœŸæ—¶çº¢è‰²è­¦å‘Š

### ä¼˜åŠ¿

1. **é›†ä¸­ç®¡ç†**: æ‰€æœ‰ç™»å½•å‡­æ®é›†ä¸­å­˜å‚¨åœ¨ Master æ•°æ®åº“
2. **å¯è§†åŒ–**: Admin Web å¯æŸ¥çœ‹æ¯ä¸ªè´¦æˆ·çš„ç™»å½•çŠ¶æ€å’Œä¿¡æ¯
3. **å¯ç»´æŠ¤**: Cookie å’ŒæŒ‡çº¹æŒä¹…åŒ–,é‡å¯åæ— éœ€é‡æ–°ç™»å½•
4. **å¯æ‰©å±•**: ä¸ºåç»­çš„ Cookie åˆ·æ–°ã€æ‰¹é‡ç™»å½•ç­‰åŠŸèƒ½æ‰“ä¸‹åŸºç¡€

---

**å®æ–½å®Œæˆæ—¥æœŸ**: 2025-10-16
**å®æ–½äººå‘˜**: Claude Code
**å®¡æ ¸çŠ¶æ€**: å¾…æµ‹è¯•éªŒè¯
