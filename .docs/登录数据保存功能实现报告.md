# 登录数据保存功能实现报告

**日期**: 2025-10-16
**版本**: 1.0.0
**状态**: ✅ 已完成

---

## 📋 问题描述

在原有实现中,Worker 登录成功后:
- ❌ Cookie 只保存在 Worker 本地文件,没有同步到 Master 数据库
- ❌ 用户信息(昵称、头像、抖音号)没有保存
- ❌ 浏览器指纹配置没有保存到数据库
- ❌ Admin Web 无法查看登录凭据和用户信息

导致的问题:
- 重启 Master 后无法查看账户的登录状态和信息
- 无法集中管理账户的 Cookie 和凭据
- Admin 界面无法显示登录的用户信息

---

## 🎯 实施目标

将登录成功后的完整数据保存到 Master 数据库的 `accounts` 表:
- ✅ Cookie 数组 (`credentials` 字段)
- ✅ 用户信息 - 昵称、头像、抖音号等 (`user_info` 字段)
- ✅ 浏览器指纹配置 (`fingerprint` 字段)
- ✅ Cookie 有效期 (`cookies_valid_until` 字段)

---

## 🏗️ 架构说明

### 数据表设计

#### `accounts` 表
存储账户的**长期数据和登录凭据**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `credentials` | TEXT (JSON) | Cookie 数组,格式: `{"cookies": [{name, value, domain, ...}]}` |
| `user_info` | TEXT (JSON) | 用户信息,格式: `{nickname, avatar, douyin_id, uid, ...}` |
| `fingerprint` | TEXT (JSON) | 浏览器指纹配置 (15+ 种指纹特征) |
| `login_status` | TEXT | 登录状态: `logged_in`, `logging_in`, `not_logged_in`, `login_failed` |
| `last_login_time` | INTEGER | 最后登录时间 (Unix 时间戳) |
| `cookies_valid_until` | INTEGER | Cookie 有效期 (Unix 时间戳,默认 7 天) |

#### `login_sessions` 表
存储**登录会话过程**记录 (临时数据):

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | TEXT | 会话 ID (UUID) |
| `account_id` | TEXT | 关联的账户 ID |
| `status` | TEXT | 会话状态: `pending`, `scanning`, `success`, `failed`, `expired` |
| `qr_code_data` | TEXT | 二维码 Base64 数据 |
| `created_at` | INTEGER | 创建时间 |
| `expires_at` | INTEGER | 过期时间 (5 分钟) |

**说明**:
- `accounts` 表存储账户的登录凭据和长期数据
- `login_sessions` 表仅用于跟踪登录过程(二维码扫码流程)
- Admin Web 的 `/accounts` 页面显示 `accounts` 表数据
- Admin Web 的 `/login` 页面显示 `login_sessions` 表数据

---

## 📦 实施步骤

### 1. 数据库迁移

创建迁移脚本 `001_add_user_info_and_fingerprint.sql`:

```sql
-- 添加 user_info 字段 (JSON格式,存储用户信息)
ALTER TABLE accounts ADD COLUMN user_info TEXT;

-- 添加 fingerprint 字段 (JSON格式,存储浏览器指纹配置)
ALTER TABLE accounts ADD COLUMN fingerprint TEXT;

-- 添加索引以便快速查询
CREATE INDEX IF NOT EXISTS idx_accounts_platform_account
  ON accounts(platform, account_id);
```

**位置**: [packages/master/src/database/migrations/001_add_user_info_and_fingerprint.sql](../packages/master/src/database/migrations/001_add_user_info_and_fingerprint.sql)

### 2. Worker 端修改

#### 修改 `platform-base.js`

在登录成功后,获取 Cookie 和指纹,并发送到 Master:

```javascript
// packages/worker/src/platforms/base/platform-base.js:136-161

if (loginStatus.isLoggedIn) {
  // 登录成功!
  clearInterval(checkTimer);

  logger.info(`[Login Monitor] Login successful for account ${accountId}`);

  // 保存登录状态(Cookie、Storage)
  await this.saveLoginState(page, accountId);

  // 获取 Cookie 和指纹数据以发送到 Master
  const cookies = await page.context().cookies();
  const fingerprint = this.browserManager.getOrCreateFingerprintConfig(accountId);

  // 通知 Master → Admin Web (包含 Cookie、用户信息、指纹)
  this.sendLoginStatus(sessionId, 'success', {
    account_id: accountId,
    user_info: loginStatus.userInfo,
    cookies: cookies,  // 发送 Cookie 数组
    fingerprint: fingerprint,  // 发送指纹配置
    cookies_valid_until: Math.floor(Date.now() / 1000) + (86400 * 7), // 7天有效期
    timestamp: Date.now(),
  });

  logger.info(`[Login Monitor] Sent login success with ${cookies.length} cookies and fingerprint`);

  resolve(true);
}
```

**修改文件**: [packages/worker/src/platforms/base/platform-base.js:136-161](../packages/worker/src/platforms/base/platform-base.js#L136-L161)

### 3. Master 端修改

#### 修改 `LoginHandler.handleLoginSuccess()`

接收并保存完整的登录数据到 `accounts` 表:

```javascript
// packages/master/src/login/login-handler.js:131-210

handleLoginSuccess(sessionId, cookies = null, cookiesValidUntil = null,
                   realAccountId = null, userInfo = null, fingerprint = null) {
  try {
    const session = this.getSession(sessionId);
    if (!session) {
      logger.warn(`Session not found: ${sessionId}`);
      return;
    }

    const now = Math.floor(Date.now() / 1000);

    // 更新登录会话状态
    const sessionStmt = this.db.prepare(`
      UPDATE login_sessions
      SET status = 'success', logged_in_at = ?
      WHERE id = ?
    `);
    sessionStmt.run(now, sessionId);

    // 检查当前账户ID是否为临时ID
    const account = this.db.prepare(`SELECT account_id FROM accounts WHERE id = ?`)
      .get(session.account_id);
    const isTemporaryId = account && account.account_id.startsWith('temp_');

    // 构建更新 SQL
    let updateSql = `
      UPDATE accounts
      SET login_status = 'logged_in',
          last_login_time = ?,
          cookies_valid_until = ?,
          credentials = ?,
          user_info = ?,
          fingerprint = ?
    `;

    const params = [
      now,
      cookiesValidUntil || now + 86400 * 7,
      cookies ? JSON.stringify({ cookies }) : '{}',
      userInfo ? JSON.stringify(userInfo) : null,
      fingerprint ? JSON.stringify(fingerprint) : null,
    ];

    // 如果提供了真实ID且当前是临时ID,则更新 account_id
    if (realAccountId && isTemporaryId) {
      updateSql += ', account_id = ?';
      params.push(realAccountId);
      logger.info(`Updating temporary account_id to real ID: ${account.account_id} -> ${realAccountId}`);
    }

    updateSql += ' WHERE id = ?';
    params.push(session.account_id);

    const accountStmt = this.db.prepare(updateSql);
    accountStmt.run(...params);

    logger.info(`Login success for session ${sessionId}, account ${session.account_id}`);
    logger.info(`Saved: ${cookies ? cookies.length : 0} cookies, user_info: ${userInfo ? userInfo.nickname || 'unknown' : 'null'}, fingerprint: ${fingerprint ? 'yes' : 'no'}`);

    // 推送给管理员
    if (this.adminNamespace) {
      this.adminNamespace.broadcastToAdmins('login:success', {
        session_id: sessionId,
        account_id: session.account_id,
        worker_id: session.worker_id,
        logged_in_at: now,
        user_info: userInfo,  // 包含用户信息
        timestamp: Date.now(),
      });
    }

    // 清理会话缓存(登录成功后不再需要)
    this.sessions.delete(sessionId);

  } catch (error) {
    logger.error('Failed to handle login success:', error);
  }
}
```

**修改文件**: [packages/master/src/login/login-handler.js:131-210](../packages/master/src/login/login-handler.js#L131-L210)

#### 修改 Socket 处理器

在 `index.js` 中修改登录成功处理器,传递完整数据:

```javascript
// packages/master/src/index.js:270-282

tempHandlers.onLoginSuccess = (data) => {
  // 提取真实的账户ID (从 user_info.uid 或 user_info.douyin_id)
  const realAccountId = data.user_info ? (data.user_info.uid || data.user_info.douyin_id) : null;

  loginHandler.handleLoginSuccess(
    data.session_id,
    data.cookies,           // Cookie 数组
    data.cookies_valid_until,
    realAccountId,          // 真实账户ID
    data.user_info,         // 用户信息
    data.fingerprint        // 浏览器指纹
  );
};
```

**修改文件**: [packages/master/src/index.js:270-282](../packages/master/src/index.js#L270-L282)

### 4. Admin Web 修改

#### 修改 `AccountsPage.js`

在账户管理页面添加列显示:
- 用户信息(头像 + 昵称/抖音号)
- 登录状态
- Cookie 状态(数量 + 有效期)

```javascript
// packages/admin-web/src/pages/AccountsPage.js

// 解析并展示用户信息
const renderUserInfo = (record) => {
  try {
    const userInfo = record.user_info ? JSON.parse(record.user_info) : null;
    if (!userInfo) return '-';

    return (
      <Space>
        {userInfo.avatar && (
          <img
            src={userInfo.avatar}
            alt="avatar"
            style={{ width: 24, height: 24, borderRadius: '50%' }}
          />
        )}
        <span>{userInfo.nickname || userInfo.douyin_id || '-'}</span>
      </Space>
    );
  } catch (e) {
    return '-';
  }
};

// 解析并展示 Cookie 状态
const renderCookieStatus = (record) => {
  try {
    const credentials = record.credentials ? JSON.parse(record.credentials) : null;
    const cookieCount = credentials && credentials.cookies ? credentials.cookies.length : 0;
    const validUntil = record.cookies_valid_until;
    const now = Math.floor(Date.now() / 1000);
    const isExpired = validUntil && validUntil < now;

    if (cookieCount === 0) {
      return <Tag color="default">无 Cookie</Tag>;
    }

    return (
      <Space direction="vertical" size={0}>
        <Tag color={isExpired ? 'red' : 'green'}>
          {cookieCount} 个 Cookie
        </Tag>
        {validUntil && (
          <span style={{ fontSize: 12, color: isExpired ? '#ff4d4f' : '#999' }}>
            {isExpired ? '已过期' : `有效期至 ${new Date(validUntil * 1000).toLocaleDateString()}`}
          </span>
        )}
      </Space>
    );
  } catch (e) {
    return '-';
  }
};

// 表格列添加:
{
  title: '用户信息',
  key: 'user_info',
  width: 150,
  render: (_, record) => renderUserInfo(record),
},
{
  title: '登录状态',
  dataIndex: 'login_status',
  key: 'login_status',
  width: 100,
  render: (status) => {
    const statusMap = {
      logged_in: { color: 'success', text: '已登录' },
      logging_in: { color: 'processing', text: '登录中' },
      login_failed: { color: 'error', text: '登录失败' },
      not_logged_in: { color: 'default', text: '未登录' },
    };
    const config = statusMap[status] || statusMap.not_logged_in;
    return <Tag color={config.color}>{config.text}</Tag>;
  },
},
{
  title: 'Cookie 状态',
  key: 'cookie_status',
  width: 120,
  render: (_, record) => renderCookieStatus(record),
}
```

**修改文件**: [packages/admin-web/src/pages/AccountsPage.js:119-283](../packages/admin-web/src/pages/AccountsPage.js#L119-L283)

---

## ✅ 实施结果

### 数据流程

```
登录成功
    ↓
Worker 提取数据:
  - page.context().cookies() → Cookie 数组
  - browserManager.getOrCreateFingerprintConfig() → 指纹配置
  - extractUserInfo() → 用户信息 (nickname, avatar, douyin_id)
    ↓
Worker → Master Socket:
  worker:login:status {
    status: 'success',
    cookies: [{...}, {...}],
    user_info: {nickname, avatar, douyin_id, ...},
    fingerprint: {userAgent, viewport, webgl, ...},
    cookies_valid_until: timestamp
  }
    ↓
Master LoginHandler:
  - 更新 accounts 表:
    * credentials = JSON.stringify({cookies})
    * user_info = JSON.stringify(userInfo)
    * fingerprint = JSON.stringify(fingerprint)
    * login_status = 'logged_in'
    * last_login_time = now
    * cookies_valid_until = now + 7天
  - 更新 login_sessions 表:
    * status = 'success'
    * logged_in_at = now
    ↓
Admin Web 显示:
  - 用户头像 + 昵称/抖音号
  - 登录状态标签 (绿色"已登录")
  - Cookie 数量 + 有效期
```

### 数据库示例

#### `accounts` 表数据示例:

```json
{
  "id": "acc-xxx",
  "platform": "douyin",
  "account_name": "测试账号",
  "account_id": "1864722759",  // 登录后自动更新为真实抖音号
  "login_status": "logged_in",
  "credentials": "{\"cookies\": [{\"name\":\"sessionid\",\"value\":\"xxx\",\"domain\":\".douyin.com\",...}, ...]}",
  "user_info": "{\"nickname\":\"苏苏\",\"douyin_id\":\"1864722759\",\"avatar\":\"https://...\",\"followers\":\"123\"}",
  "fingerprint": "{\"userAgent\":\"Mozilla/5.0...\",\"viewport\":{\"width\":1920,\"height\":1080},\"webgl\":{\"vendor\":\"Intel Inc.\",\"renderer\":\"ANGLE...\"}}",
  "last_login_time": 1729123456,
  "cookies_valid_until": 1729728256,
  "assigned_worker_id": "worker-abc",
  "created_at": 1729000000,
  "updated_at": 1729123456
}
```

---

## 🎨 Admin Web 界面变化

### 账户管理页面 (`/accounts`)

**新增列**:
1. **用户信息** - 显示头像 + 昵称/抖音号
2. **登录状态** - 标签显示: 已登录(绿色) / 未登录(灰色) / 登录中(蓝色) / 登录失败(红色)
3. **Cookie 状态** - 显示 Cookie 数量 + 有效期,过期显示红色

**示例效果**:
```
| 用户信息          | 登录状态  | Cookie 状态      |
|------------------|----------|-----------------|
| 🧑 苏苏           | ✅ 已登录 | 🟢 25 个 Cookie  |
| (头像) 1864722759 |          | 有效期至 2025-10-23 |
```

**功能改进**:
- 已登录的账户,"登录"按钮自动禁用
- Cookie 过期时显示红色警告
- 点击用户信息可查看完整 JSON 数据(可选功能,后续实现)

---

## 📊 技术细节

### Cookie 存储格式

```json
{
  "cookies": [
    {
      "name": "sessionid",
      "value": "xxx",
      "domain": ".douyin.com",
      "path": "/",
      "expires": 1729728256,
      "httpOnly": true,
      "secure": true,
      "sameSite": "Lax"
    },
    ...
  ]
}
```

### 用户信息格式

```json
{
  "nickname": "苏苏",
  "douyin_id": "1864722759",
  "uid": "1864722759",
  "avatar": "https://p3.douyinpic.com/aweme/...",
  "followers": "123",
  "following": "45",
  "signature": "个性签名"
}
```

### 浏览器指纹格式

```json
{
  "accountId": "acc-xxx",
  "createdAt": 1729123456789,
  "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36...",
  "viewport": {"width": 1920, "height": 1080},
  "webgl": {
    "vendor": "Google Inc.",
    "renderer": "ANGLE (Intel, Intel(R) UHD Graphics 630)"
  },
  "canvas": {"noise": "A3d"},
  "audio": {"noise": 0.0001},
  "hardware": {
    "cores": 8,
    "memory": 16
  },
  "screen": {
    "width": 1920,
    "height": 1080,
    "colorDepth": 24,
    "pixelRatio": 1
  },
  "locale": "zh-CN",
  "timezone": "Asia/Shanghai",
  "fonts": ["Arial", "Helvetica", ...],
  "plugins": 4
}
```

---

## 🔒 安全性

1. **Cookie 加密**:
   - 当前存储为明文 JSON
   - **建议**: 后续使用 AES-256 加密 `credentials` 字段
   - 参考: `packages/shared/utils/encryption.js` (需创建)

2. **数据访问控制**:
   - API 需要验证管理员权限
   - Socket.IO 命名空间隔离 (`/admin`)

3. **日志脱敏**:
   - 日志中不输出完整 Cookie 值
   - 只记录 Cookie 数量和类型

---

## 🧪 测试建议

### 1. 单元测试

```bash
# 测试 LoginHandler
cd packages/master
npm test -- login-handler.test.js
```

### 2. 集成测试

```bash
# 完整登录流程测试
cd packages/worker
node test-douyin-login-interactive.js
```

**验证点**:
1. ✅ Worker 登录成功后发送完整数据
2. ✅ Master 正确保存到 `accounts` 表
3. ✅ Admin Web 正确显示用户信息和 Cookie 状态
4. ✅ 数据库字段 `user_info`, `fingerprint` 不为 NULL
5. ✅ Cookie 有效期正确计算(7天后)

### 3. 手动测试步骤

1. 启动 Master 和 Worker:
   ```bash
   npm run dev
   ```

2. 打开 Admin Web: http://localhost:3001/accounts

3. 添加测试账户并启动登录

4. 扫码登录成功后,检查:
   - "用户信息"列显示头像和昵称
   - "登录状态"显示"已登录"(绿色)
   - "Cookie 状态"显示 Cookie 数量和有效期

5. 查询数据库验证:
   ```bash
   sqlite3 packages/master/data/master.db
   SELECT id, login_status, json_extract(user_info, '$.nickname') as nickname,
          json_array_length(credentials, '$.cookies') as cookie_count,
          cookies_valid_until
   FROM accounts WHERE login_status='logged_in';
   ```

---

## 📝 后续优化建议

1. **Cookie 加密**: 使用 AES-256 加密 `credentials` 字段
2. **指纹详情查看**: 在 Admin Web 添加"查看指纹"按钮
3. **Cookie 刷新**: 定期刷新即将过期的 Cookie
4. **登录凭据导出**: 支持导出 Cookie 用于调试
5. **多账户批量登录**: 支持选择多个账户批量登录
6. **登录历史**: 记录每次登录的时间和 IP

---

## 📚 相关文档

- [账户级浏览器隔离登录流程设计](.docs/账户级浏览器隔离登录流程设计.md)
- [通用平台脚本系统设计方案](.docs/worker-通用平台脚本系统设计方案.md)
- [数据库字典](.docs/archive/数据库字典.md)
- [CLAUDE.md](../CLAUDE.md) - 项目开发指南

---

## 🎯 总结

### 实现的功能

✅ **Worker 端**:
- 登录成功后提取 Cookie、用户信息、浏览器指纹
- 通过 Socket.IO 发送完整数据到 Master

✅ **Master 端**:
- 接收并保存到 `accounts` 表的 3 个字段: `credentials`, `user_info`, `fingerprint`
- 更新登录状态和有效期
- 支持临时 ID 自动更新为真实账户 ID

✅ **数据库**:
- 添加 `user_info` 和 `fingerprint` 字段
- 创建索引优化查询性能

✅ **Admin Web**:
- 显示用户头像和昵称
- 显示登录状态标签
- 显示 Cookie 数量和有效期
- Cookie 过期时红色警告

### 优势

1. **集中管理**: 所有登录凭据集中存储在 Master 数据库
2. **可视化**: Admin Web 可查看每个账户的登录状态和信息
3. **可维护**: Cookie 和指纹持久化,重启后无需重新登录
4. **可扩展**: 为后续的 Cookie 刷新、批量登录等功能打下基础

---

**实施完成日期**: 2025-10-16
**实施人员**: Claude Code
**审核状态**: 待测试验证
