# äºŒç»´ç ç™»å½•æµç¨‹è¯¦è§£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ä» Admin Web åˆ›å»ºè´¦æˆ·åˆ°æ‰«ç ç™»å½•çš„å®Œæ•´æµç¨‹ã€‚

## ğŸ”„ å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Admin Web  â”‚         â”‚   Master    â”‚         â”‚   Worker    â”‚         â”‚  ç”¨æˆ·æ‰‹æœº   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                       â”‚                       â”‚                       â”‚
       â”‚ 1. åˆ›å»ºè´¦æˆ·            â”‚                       â”‚                       â”‚
       â”‚ (å¡«å†™åŸºæœ¬ä¿¡æ¯)         â”‚                       â”‚                       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                       â”‚
       â”‚                       â”‚                       â”‚                       â”‚
       â”‚                       â”‚ 2. ä¿å­˜è´¦æˆ·åˆ°æ•°æ®åº“     â”‚                       â”‚
       â”‚                       â”‚    åˆ†é… Worker        â”‚                       â”‚
       â”‚                       â”‚                       â”‚                       â”‚
       â”‚ 3. åˆ›å»ºæˆåŠŸ âœ“          â”‚                       â”‚                       â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚                       â”‚
       â”‚                       â”‚                       â”‚                       â”‚
       â”‚ 4. ç‚¹å‡»"ç™»å½•"æŒ‰é’®      â”‚                       â”‚                       â”‚
       â”‚    startLogin()       â”‚                       â”‚                       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                       â”‚
       â”‚                       â”‚                       â”‚                       â”‚
       â”‚                       â”‚ 5. åˆ›å»º login_session â”‚                       â”‚
       â”‚                       â”‚    å‘é€ç™»å½•è¯·æ±‚       â”‚                       â”‚
       â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
       â”‚                       â”‚                       â”‚                       â”‚
       â”‚                       â”‚                       â”‚ 6. æ‰“å¼€æµè§ˆå™¨         â”‚
       â”‚                       â”‚                       â”‚    å¯¼èˆªåˆ°æŠ–éŸ³ç™»å½•é¡µ   â”‚
       â”‚                       â”‚                       â”‚    ç”ŸæˆäºŒç»´ç          â”‚
       â”‚                       â”‚                       â”‚                       â”‚
       â”‚                       â”‚ 7. QRç å°±ç»ªäº‹ä»¶       â”‚                       â”‚
       â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
       â”‚                       â”‚                       â”‚                       â”‚
       â”‚ 8. å¹¿æ’­ QR ç æ•°æ®      â”‚                       â”‚                       â”‚
       â”‚    (Base64 å›¾ç‰‡)      â”‚                       â”‚                       â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚                       â”‚
       â”‚                       â”‚                       â”‚                       â”‚
       â”‚ 9. æ˜¾ç¤º QR ç æ¨¡æ€æ¡†    â”‚                       â”‚                       â”‚
       â”‚    (QRCodeModal)      â”‚                       â”‚                       â”‚
       â”‚                       â”‚                       â”‚                       â”‚
       â”‚                       â”‚                       â”‚                       â”‚ 10. ç”¨æˆ·æ‰«ç 
       â”‚                       â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                       â”‚                       â”‚                       â”‚
       â”‚                       â”‚                       â”‚ 11. æ£€æµ‹ç™»å½•æˆåŠŸ      â”‚
       â”‚                       â”‚                       â”‚     è·å– cookies      â”‚
       â”‚                       â”‚                       â”‚                       â”‚
       â”‚                       â”‚ 12. ç™»å½•æˆåŠŸäº‹ä»¶      â”‚                       â”‚
       â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
       â”‚                       â”‚                       â”‚                       â”‚
       â”‚                       â”‚ 13. æ›´æ–°è´¦æˆ·çŠ¶æ€      â”‚                       â”‚
       â”‚                       â”‚     ä¿å­˜ cookies      â”‚                       â”‚
       â”‚                       â”‚                       â”‚                       â”‚
       â”‚ 14. å¹¿æ’­ç™»å½•æˆåŠŸ       â”‚                       â”‚                       â”‚
       â”‚     å…³é—­ QR æ¨¡æ€æ¡†     â”‚                       â”‚                       â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚                       â”‚
       â”‚                       â”‚                       â”‚                       â”‚
       â”‚ 15. æ˜¾ç¤ºæˆåŠŸæç¤º âœ“     â”‚                       â”‚                       â”‚
       â”‚                       â”‚                       â”‚                       â”‚
```

## ğŸ¯ è¯¦ç»†æ­¥éª¤è¯´æ˜

### æ­¥éª¤ 1-3: åˆ›å»ºè´¦æˆ·

**å‰ç«¯æ“ä½œ** ([AccountsPage.js:66-85](../packages/admin-web/src/pages/AccountsPage.js#L66-L85))

```javascript
// 1. ç®¡ç†å‘˜å¡«å†™è¡¨å•
const values = {
  platform: 'douyin',      // å¹³å°
  account_name: 'æµ‹è¯•è´¦æˆ·', // è´¦æˆ·åç§°
  account_id: 'test_001',  // è´¦æˆ·ID
  credentials: '{}',       // åˆå§‹å‡­è¯ï¼ˆç©ºå¯¹è±¡ï¼‰
  monitor_interval: 30,    // ç›‘æ§é—´éš”
  status: 'active'         // çŠ¶æ€
};

// 2. æäº¤åˆ°åç«¯ API
await accountsAPI.createAccount(values);
```

**åç«¯å¤„ç†** ([accounts.js:83-129](../packages/master/src/api/routes/accounts.js#L83-L129))

```javascript
// Master æ¥æ”¶è¯·æ±‚
router.post('/api/v1/accounts', async (req, res) => {
  // éªŒè¯å¿…å¡«å­—æ®µ
  if (!platform || !account_name || !account_id || !credentials) {
    return res.status(400).json({ error: 'Missing required fields' });
  }

  // åˆ›å»ºè´¦æˆ·
  const account = new Account({ ...req.body });
  const createdAccount = accountsDAO.create(account);

  // åˆ†é…ç»™ Worker
  accountAssigner.assignNewAccount(createdAccount);

  res.json({ success: true, data: createdAccount });
});
```

**æ•°æ®åº“è®°å½•**:
```sql
INSERT INTO accounts (
  id, platform, account_name, account_id,
  credentials, status, login_status, assigned_worker_id
) VALUES (
  'uuid-xxx',
  'douyin',
  'æµ‹è¯•è´¦æˆ·',
  'test_001',
  '{}',  -- åˆå§‹ä¸ºç©º
  'active',
  'not_logged_in',  -- åˆå§‹æœªç™»å½•
  'worker-1'  -- å·²åˆ†é… Worker
);
```

### æ­¥éª¤ 4: å¯åŠ¨ç™»å½•æµç¨‹

**å‰ç«¯æ“ä½œ** ([AccountsPage.js:108-123](../packages/admin-web/src/pages/AccountsPage.js#L108-L123))

```javascript
// ç®¡ç†å‘˜ç‚¹å‡»"ç™»å½•"æŒ‰é’®
const handleStartLogin = (account) => {
  // æ£€æŸ¥æ˜¯å¦å·²åˆ†é… Worker
  if (!account.assigned_worker_id) {
    message.error('è¯¥è´¦æˆ·å°šæœªåˆ†é… Worker');
    return;
  }

  Modal.confirm({
    title: 'å¯åŠ¨ç™»å½•æµç¨‹',
    content: `ç¡®å®šè¦ä¸ºè´¦æˆ· "${account.account_name}" å¯åŠ¨ç™»å½•æµç¨‹å—ï¼Ÿ`,
    onOk: () => {
      // è°ƒç”¨ Socket.IO å¯åŠ¨ç™»å½•
      startLogin(account.id, account.assigned_worker_id);
    },
  });
};
```

**Socket.IO é€šä¿¡** ([socketContext.js:135-151](../packages/admin-web/src/services/socketContext.js#L135-L151))

```javascript
const startLogin = (accountId, workerId) => {
  const sessionId = `session-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

  // å‘é€åˆ° Master çš„ admin namespace
  socket.emit('master:login:start', {
    account_id: accountId,
    worker_id: workerId,
    session_id: sessionId,
  });

  message.info('æ­£åœ¨å¯åŠ¨ç™»å½•æµç¨‹...');
};
```

### æ­¥éª¤ 5-6: Master åˆ›å»ºä¼šè¯å¹¶é€šçŸ¥ Worker

**Master å¤„ç†** ([admin-namespace.js](../packages/master/src/socket/admin-namespace.js))

```javascript
// æ¥æ”¶ç™»å½•å¯åŠ¨è¯·æ±‚
socket.on('master:login:start', ({ account_id, worker_id, session_id }) => {
  // 1. åˆ›å»ºç™»å½•ä¼šè¯
  const session = loginHandler.createLoginSession(
    account_id,
    worker_id,
    'qrcode'  // ç™»å½•æ–¹æ³•
  );

  // 2. é€šè¿‡ worker namespace å‘é€ç»™æŒ‡å®š Worker
  workerNamespace.to(worker_id).emit('worker:start_login', {
    account_id,
    session_id: session.id,
  });
});
```

**æ•°æ®åº“è®°å½•**:
```sql
INSERT INTO login_sessions (
  id, account_id, worker_id, status,
  login_method, expires_at, created_at
) VALUES (
  'session-xxx',
  'account-id',
  'worker-1',
  'pending',
  'qrcode',
  unix_timestamp + 300,  -- 5åˆ†é’Ÿåè¿‡æœŸ
  unix_timestamp
);
```

**Worker å¤„ç†** ([douyin-login-handler.js:60-156](../packages/worker/src/browser/douyin-login-handler.js#L60-L156))

```javascript
async startLogin(accountId, sessionId) {
  // 1. åˆ›å»ºæˆ–è·å– Browser Context
  const context = await this.browserManager.getOrCreateContext(accountId);

  // 2. åˆ›å»ºæ–°é¡µé¢
  const page = await context.newPage();

  // 3. å¯¼èˆªåˆ°æŠ–éŸ³ç™»å½•é¡µ
  await page.goto('https://www.douyin.com/');

  // 4. ç‚¹å‡»ç™»å½•æŒ‰é’®
  await this.clickLoginButton(page);

  // 5. ç­‰å¾…äºŒç»´ç å‡ºç°
  await this.waitForQRCode(page);

  // 6. æˆªå–äºŒç»´ç å›¾ç‰‡
  const qrElement = await page.locator('.qrcode-container').first();
  const screenshot = await qrElement.screenshot();
  const qrCodeData = `data:image/png;base64,${screenshot.toString('base64')}`;

  // 7. é€šçŸ¥ Master äºŒç»´ç å·²å°±ç»ª
  this.notifyQRCodeReady(accountId, sessionId, qrCodeData);

  // 8. ç›‘å¬ç™»å½•æˆåŠŸ
  this.monitorLoginSuccess(page, accountId, sessionId);
}
```

### æ­¥éª¤ 7-8: Worker å‘é€ QR ç ç»™ Master

**Worker é€šçŸ¥** ([douyin-login-handler.js:710-728](../packages/worker/src/browser/douyin-login-handler.js#L710-L728))

```javascript
notifyQRCodeReady(accountId, sessionId, qrCodeData, qrCodeUrl) {
  this.socketClient.emit('worker:qrcode:ready', {
    account_id: accountId,
    session_id: sessionId,
    qr_code_data: qrCodeData,  // Base64 ç¼–ç çš„å›¾ç‰‡
    qr_code_url: qrCodeUrl,    // å¯é€‰çš„ URL
    timestamp: Date.now(),
  });
}
```

**Master å¤„ç†** ([login-handler.js:79-120](../packages/master/src/login/login-handler.js#L79-L120))

```javascript
handleQRCodeReady(sessionId, qrCodeData, qrCodeUrl) {
  // 1. æ›´æ–°æ•°æ®åº“
  this.db.prepare(`
    UPDATE login_sessions
    SET qr_code_data = ?, qr_code_url = ?, status = 'scanning'
    WHERE id = ?
  `).run(qrCodeData, qrCodeUrl, sessionId);

  // 2. å¹¿æ’­ç»™æ‰€æœ‰ç®¡ç†å‘˜å®¢æˆ·ç«¯
  this.adminNamespace.broadcastToAdmins('login:qrcode:ready', {
    session_id: sessionId,
    account_id: session.account_id,
    worker_id: session.worker_id,
    qr_code_data: qrCodeData,
    qr_code_url: qrCodeUrl,
    expires_at: session.expires_at,
    timestamp: Date.now(),
  });
}
```

### æ­¥éª¤ 9: å‰ç«¯æ˜¾ç¤ºäºŒç»´ç 

**Socket.IO ç›‘å¬** ([socketContext.js:79-83](../packages/admin-web/src/services/socketContext.js#L79-L83))

```javascript
// ç›‘å¬ QR ç å°±ç»ªäº‹ä»¶
socket.on('login:qrcode:ready', (data) => {
  console.log('QR code ready:', data);
  setQRCodeData(data);  // ä¿å­˜åˆ°çŠ¶æ€
  message.success(`è´¦æˆ· ${data.account_id} çš„ QR ç å·²å‡†å¤‡å°±ç»ª`);
});
```

**æ¨¡æ€æ¡†æ˜¾ç¤º** ([QRCodeModal.js:60-141](../packages/admin-web/src/components/QRCodeModal.js#L60-L141))

```javascript
const QRCodeModal = ({ visible, onClose, qrCodeData }) => {
  return (
    <Modal
      title="æ‰«æäºŒç»´ç ç™»å½•"
      open={visible}
      onCancel={onClose}
    >
      {/* æ˜¾ç¤º Base64 å›¾ç‰‡ */}
      <Image
        src={qrCodeData.qr_code_data}
        alt="QR Code"
        style={{ maxWidth: '300px' }}
      />

      {/* æ˜¾ç¤ºå€’è®¡æ—¶ */}
      <Progress percent={progress} />
      <Text>å‰©ä½™æ—¶é—´: {formatTime(timeLeft)}</Text>

      {/* æ˜¾ç¤ºè´¦æˆ·ä¿¡æ¯ */}
      <Text>è´¦æˆ· ID: {qrCodeData.account_id}</Text>
      <Text>Worker ID: {qrCodeData.worker_id}</Text>
      <Text>ä¼šè¯ ID: {qrCodeData.session_id}</Text>
    </Modal>
  );
};
```

### æ­¥éª¤ 10-11: ç”¨æˆ·æ‰«ç ç™»å½•

**Worker ç›‘å¬ç™»å½•æˆåŠŸ** ([douyin-login-handler.js:465-614](../packages/worker/src/browser/douyin-login-handler.js#L465-L614))

```javascript
async monitorLoginSuccess(page, accountId, sessionId) {
  try {
    // æ–¹æ³•1: ç›‘å¬ URL å˜åŒ–
    await page.waitForURL(/user|profile/, { timeout: 300000 });

    // æ–¹æ³•2: æ£€æµ‹ç”¨æˆ·å¤´åƒå…ƒç´ 
    await page.waitForSelector('.user-avatar', { timeout: 5000 });

    // æ–¹æ³•3: æ£€æŸ¥ localStorage
    const isLoggedIn = await page.evaluate(() => {
      return !!localStorage.getItem('user_info');
    });

    if (isLoggedIn) {
      await this.handleLoginSuccess(page, accountId, sessionId);
    }

  } catch (error) {
    logger.error('Login monitoring failed:', error);
    this.notifyLoginFailed(accountId, sessionId, error.message);
  }
}
```

**è·å– Cookies** ([douyin-login-handler.js:585-604](../packages/worker/src/browser/douyin-login-handler.js#L585-L604))

```javascript
async handleLoginSuccess(page, accountId, sessionId) {
  // 1. ä¿å­˜ storage stateï¼ˆåŒ…å« cookies å’Œ localStorageï¼‰
  await this.browserManager.saveStorageState(accountId);

  // 2. è·å– cookies ä¿¡æ¯
  const cookies = await page.context().cookies();
  const cookiesValidUntil = this.calculateCookiesExpiry(cookies);

  // 3. é€šçŸ¥ Master ç™»å½•æˆåŠŸ
  this.notifyLoginSuccess(accountId, sessionId, cookies, cookiesValidUntil);
}
```

### æ­¥éª¤ 12-13: Worker é€šçŸ¥ Master ç™»å½•æˆåŠŸ

**Worker é€šçŸ¥** ([douyin-login-handler.js:640-654](../packages/worker/src/browser/douyin-login-handler.js#L640-L654))

```javascript
notifyLoginSuccess(accountId, sessionId, cookies, cookiesValidUntil) {
  this.socketClient.emit('worker:login:success', {
    account_id: accountId,
    session_id: sessionId,
    cookies: cookies,  // å®Œæ•´çš„ cookies æ•°ç»„
    cookies_valid_until: cookiesValidUntil,
    timestamp: Date.now(),
  });
}
```

**Master å¤„ç†** ([login-handler.js:128-179](../packages/master/src/login/login-handler.js#L128-L179))

```javascript
handleLoginSuccess(sessionId, cookies, cookiesValidUntil) {
  // 1. æ›´æ–°ç™»å½•ä¼šè¯çŠ¶æ€
  this.db.prepare(`
    UPDATE login_sessions
    SET status = 'success', logged_in_at = ?
    WHERE id = ?
  `).run(now, sessionId);

  // 2. æ›´æ–°è´¦æˆ·ç™»å½•çŠ¶æ€å’Œå‡­è¯
  this.db.prepare(`
    UPDATE accounts
    SET login_status = 'logged_in',
        last_login_time = ?,
        cookies_valid_until = ?,
        credentials = ?
    WHERE id = ?
  `).run(now, cookiesValidUntil, JSON.stringify({ cookies }), accountId);

  // 3. å¹¿æ’­ç»™ç®¡ç†å‘˜
  this.adminNamespace.broadcastToAdmins('login:success', {
    session_id: sessionId,
    account_id: accountId,
    worker_id: workerId,
    logged_in_at: now,
  });
}
```

### æ­¥éª¤ 14-15: å‰ç«¯æ˜¾ç¤ºæˆåŠŸ

**Socket.IO ç›‘å¬** ([socketContext.js:86-90](../packages/admin-web/src/services/socketContext.js#L86-L90))

```javascript
// ç™»å½•æˆåŠŸ
socket.on('login:success', (data) => {
  console.log('Login success:', data);
  message.success(`è´¦æˆ· ${data.account_id} ç™»å½•æˆåŠŸ`);
  setQRCodeData(null);  // å…³é—­æ¨¡æ€æ¡†
});
```

## ğŸ” å…³é”®æ•°æ®ç»“æ„

### è´¦æˆ·å¯¹è±¡ (Account)

```javascript
{
  id: "uuid-xxx",
  platform: "douyin",
  account_name: "æµ‹è¯•è´¦æˆ·",
  account_id: "test_001",
  credentials: "{\"cookies\": [...]}",  // ç™»å½•æˆåŠŸåä¿å­˜
  status: "active",
  login_status: "logged_in",  // not_logged_in | logged_in | login_failed
  monitor_interval: 30,
  last_check_time: 1697123456,
  last_login_time: 1697123456,
  cookies_valid_until: 1697209856,
  assigned_worker_id: "worker-1",
  created_at: 1697123456,
  updated_at: 1697123456
}
```

### ç™»å½•ä¼šè¯å¯¹è±¡ (LoginSession)

```javascript
{
  id: "session-xxx",
  account_id: "account-id",
  worker_id: "worker-1",
  status: "scanning",  // pending | scanning | success | failed | expired
  login_method: "qrcode",
  qr_code_data: "data:image/png;base64,...",  // Base64 å›¾ç‰‡
  qr_code_url: "https://douyin.com/qr/xxx",  // å¯é€‰
  error_message: null,
  expires_at: 1697123756,  // 5åˆ†é’Ÿå
  logged_in_at: null,
  created_at: 1697123456
}
```

### QR ç æ•°æ® (å‰ç«¯)

```javascript
{
  session_id: "session-xxx",
  account_id: "account-id",
  worker_id: "worker-1",
  qr_code_data: "data:image/png;base64,...",
  qr_code_url: "https://douyin.com/qr/xxx",
  expires_at: 1697123756,
  timestamp: 1697123456789
}
```

## ğŸ“¡ Socket.IO äº‹ä»¶åˆ—è¡¨

### Admin â†’ Master

| äº‹ä»¶å | æ–¹å‘ | å‚æ•° | è¯´æ˜ |
|--------|------|------|------|
| `master:login:start` | Admin â†’ Master | `{ account_id, worker_id, session_id }` | å¯åŠ¨ç™»å½•æµç¨‹ |
| `admin:status:request` | Admin â†’ Master | - | è¯·æ±‚ç³»ç»ŸçŠ¶æ€ |
| `admin:login_sessions:list` | Admin â†’ Master | - | è¯·æ±‚ç™»å½•ä¼šè¯åˆ—è¡¨ |

### Master â†’ Admin

| äº‹ä»¶å | æ–¹å‘ | å‚æ•° | è¯´æ˜ |
|--------|------|------|------|
| `login:qrcode:ready` | Master â†’ Admin | `{ session_id, qr_code_data, ... }` | äºŒç»´ç å·²å‡†å¤‡ |
| `login:success` | Master â†’ Admin | `{ session_id, account_id, ... }` | ç™»å½•æˆåŠŸ |
| `login:failed` | Master â†’ Admin | `{ session_id, error_message, ... }` | ç™»å½•å¤±è´¥ |
| `login:qrcode:expired` | Master â†’ Admin | `{ session_id }` | äºŒç»´ç è¿‡æœŸ |
| `login:qrcode:refreshed` | Master â†’ Admin | `{ session_id, qr_code_data, ... }` | äºŒç»´ç åˆ·æ–° |

### Master â†” Worker

| äº‹ä»¶å | æ–¹å‘ | å‚æ•° | è¯´æ˜ |
|--------|------|------|------|
| `worker:start_login` | Master â†’ Worker | `{ account_id, session_id }` | é€šçŸ¥ Worker å¯åŠ¨ç™»å½• |
| `worker:qrcode:ready` | Worker â†’ Master | `{ account_id, session_id, qr_code_data }` | Worker ä¸ŠæŠ¥äºŒç»´ç  |
| `worker:login:success` | Worker â†’ Master | `{ account_id, session_id, cookies, ... }` | Worker ä¸ŠæŠ¥ç™»å½•æˆåŠŸ |
| `worker:login:failed` | Worker â†’ Master | `{ account_id, session_id, error_message }` | Worker ä¸ŠæŠ¥ç™»å½•å¤±è´¥ |

## âš ï¸ å¸¸è§é—®é¢˜

### 1. åˆ›å»ºè´¦æˆ·æ—¶ credentials å­—æ®µå¦‚ä½•å¡«å†™ï¼Ÿ

**æ–¹æ¡ˆA: å…è®¸ç©ºå¯¹è±¡**
```javascript
// å‰ç«¯å¡«å†™
credentials: '{}'  // ç©º JSON å¯¹è±¡

// åç«¯ä¿®æ”¹éªŒè¯é€»è¾‘,å…è®¸ç©ºå¯¹è±¡
const credentials = req.body.credentials || '{}';
```

**æ–¹æ¡ˆB: éšè—å­—æ®µ**
```javascript
// å‰ç«¯ä¸æ˜¾ç¤º credentials å­—æ®µ
// åç«¯è‡ªåŠ¨è®¾ç½®ä¸ºç©ºå¯¹è±¡
credentials: credentials || '{}'
```

### 2. äºŒç»´ç ä¸æ˜¾ç¤ºæ€ä¹ˆåŠï¼Ÿ

æ£€æŸ¥æ­¥éª¤:
1. ç¡®è®¤è´¦æˆ·å·²åˆ†é… Worker: `assigned_worker_id` ä¸ä¸ºç©º
2. ç¡®è®¤ Worker å·²è¿æ¥: Master æ—¥å¿—ä¸­æœ‰ "Worker registered"
3. ç¡®è®¤ Socket.IO äº‹ä»¶æ­£å¸¸: æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹ WebSocket è¿æ¥
4. ç¡®è®¤ Worker æµè§ˆå™¨å¯åŠ¨æˆåŠŸ: Worker æ—¥å¿—ä¸­æœ‰ "Browser launched"
5. æ£€æŸ¥ Worker ç«¯çš„äºŒç»´ç æˆªå›¾é€»è¾‘

### 3. ç™»å½•æˆåŠŸå credentials ä¸ºç©ºï¼Ÿ

è¿™æ˜¯å› ä¸ºå½“å‰å®ç°ä¸­ Worker æ²¡æœ‰å°† cookies å‘é€ç»™ Masterã€‚

**è§£å†³æ–¹æ³•**: ä¿®æ”¹ä»£ç å°† cookies ä¸Šä¼ 

å‚è§æœ¬æ–‡æ¡£ "æ­¥éª¤ 12-13" éƒ¨åˆ†çš„å®ç°ã€‚

### 4. äºŒç»´ç è¿‡æœŸæ€ä¹ˆåŠï¼Ÿ

è‡ªåŠ¨å¤„ç†:
- äºŒç»´ç æœ‰æ•ˆæœŸ: 5åˆ†é’Ÿ
- Master å®šæ—¶æ¸…ç†è¿‡æœŸä¼šè¯
- å‰ç«¯æ˜¾ç¤ºè¿‡æœŸæç¤º
- ç”¨æˆ·éœ€è¦é‡æ–°ç‚¹å‡»"ç™»å½•"æŒ‰é’®

## ğŸ“ å¼€å‘å»ºè®®

### å‰ç«¯ä¼˜åŒ–

1. **è‡ªåŠ¨åˆ·æ–°äºŒç»´ç **: å¿«è¿‡æœŸæ—¶è‡ªåŠ¨è¯·æ±‚åˆ·æ–°
2. **å¤šçª—å£æ”¯æŒ**: å…è®¸åŒæ—¶ä¸ºå¤šä¸ªè´¦æˆ·ç™»å½•
3. **ç™»å½•å†å²**: æ˜¾ç¤ºè´¦æˆ·çš„ç™»å½•å†å²è®°å½•
4. **é”™è¯¯é‡è¯•**: ç™»å½•å¤±è´¥åæä¾›é‡è¯•æŒ‰é’®

### åç«¯ä¼˜åŒ–

1. **Cookies åŒæ­¥**: Worker ç™»å½•æˆåŠŸåè‡ªåŠ¨ä¸Šä¼  cookies
2. **ä¼šè¯æ¸…ç†**: å®šæ—¶æ¸…ç†è¿‡æœŸçš„ç™»å½•ä¼šè¯
3. **å¹¶å‘æ§åˆ¶**: é™åˆ¶åŒæ—¶ç™»å½•çš„è´¦æˆ·æ•°é‡
4. **æ—¥å¿—è®°å½•**: è¯¦ç»†è®°å½•ç™»å½•æµç¨‹çš„æ¯ä¸ªæ­¥éª¤

### Worker ä¼˜åŒ–

1. **äºŒç»´ç åˆ·æ–°**: å¿«è¿‡æœŸæ—¶è‡ªåŠ¨åˆ·æ–°äºŒç»´ç 
2. **ç™»å½•æ£€æµ‹**: æ›´å¯é çš„ç™»å½•æˆåŠŸæ£€æµ‹é€»è¾‘
3. **é”™è¯¯å¤„ç†**: è¯¦ç»†çš„é”™è¯¯åˆ†ç±»å’Œå¤„ç†
4. **èµ„æºæ¸…ç†**: ç™»å½•å®ŒæˆååŠæ—¶æ¸…ç†é¡µé¢èµ„æº

## ğŸ”— ç›¸å…³æ–‡ä»¶

- å‰ç«¯é¡µé¢: [AccountsPage.js](../packages/admin-web/src/pages/AccountsPage.js)
- Socket Context: [socketContext.js](../packages/admin-web/src/services/socketContext.js)
- QR ç ç»„ä»¶: [QRCodeModal.js](../packages/admin-web/src/components/QRCodeModal.js)
- Master ç™»å½•å¤„ç†: [login-handler.js](../packages/master/src/login/login-handler.js)
- Worker ç™»å½•å¤„ç†: [douyin-login-handler.js](../packages/worker/src/browser/douyin-login-handler.js)
- Admin Namespace: [admin-namespace.js](../packages/master/src/socket/admin-namespace.js)
- è´¦æˆ· API: [accounts.js](../packages/master/src/api/routes/accounts.js)

## ğŸ“š å»¶ä¼¸é˜…è¯»

- [æ•°æ®åº“å­—å…¸](æ•°æ®åº“å­—å…¸.md)
- [å¤šBrowseræ¶æ„è¯¦è§£](architecture/å¤šBrowseræ¶æ„è¯¦è§£.md)
- [CLAUDE.md](../CLAUDE.md) - é¡¹ç›®å¼€å‘æŒ‡å—
