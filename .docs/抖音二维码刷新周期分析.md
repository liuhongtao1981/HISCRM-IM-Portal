# 抖音二维码刷新周期分析报告

**分析日期**: 2025-10-20
**系统**: HisCRM-IM
**平台**: 抖音 (Douyin)

## 📊 当前实现的二维码刷新参数

### 核心时间配置

| 参数 | 值 | 说明 |
|------|-----|------|
| **QR_CODE_LIFETIME** | 150,000 ms | **二维码有效期：2分30秒（150秒）** |
| **LOGIN_CHECK_INTERVAL** | 2,000 ms | 轮询登录状态的间隔：每2秒检查一次 |
| **QR_CODE_TIMEOUT** | 30,000 ms | 等待二维码加载的超时：30秒 |
| **POPUP_WAIT_TIME** | 5,000 ms | 等待登录浮层弹出的时间：5秒 |
| **LOGIN_TIMEOUT** | 300,000 ms | 总体登录超时：5分钟 |
| **maxQRCodeRefreshes** | 3 | 最多刷新二维码次数：3次 |

**源文件**: [packages/worker/src/browser/douyin-login-handler.js:32-36](packages/worker/src/browser/douyin-login-handler.js#L32-L36)

---

## 🔄 二维码刷新流程

### 1. **登录流程启动**
```
开始登录 → 导航到首页 → 等待登录浮层(5秒) → 等待二维码加载
→ 提取二维码(Base64) → 开始轮询登录状态
```

### 2. **轮询登录状态**（每2秒检查一次）
轮询函数: `startLoginStatusPolling()` [line 458](packages/worker/src/browser/douyin-login-handler.js#L458)

```javascript
const pollInterval = setInterval(async () => {
  // 1. 检查是否已登录
  const isLoggedIn = await this.checkLoginStatus(session.page);

  if (isLoggedIn) {
    // 登录成功，停止轮询
    return;
  }

  // 2. 检查二维码是否过期
  if (qrCodeAge > this.QR_CODE_LIFETIME) {  // 超过 150秒
    if (refreshCount < 3) {
      // 3. 刷新二维码（重新加载页面）
      await this.refreshQRCode(accountId, sessionId);
    } else {
      // 达到最大刷新次数，登录失败
      throw new Error('QR code refresh limit exceeded');
    }
  }
}, this.LOGIN_CHECK_INTERVAL);  // 每2秒轮询一次
```

### 3. **二维码刷新的具体步骤**
`refreshQRCode()` 函数 [line 389](packages/worker/src/browser/douyin-login-handler.js#L389):

1. **重新加载页面** - `page.reload()`
2. **等待登录浮层** - 等待5秒
3. **等待新二维码加载** - 最多30秒
4. **提取新二维码** - Base64编码截图
5. **更新会话信息** - 重置计时器 (`qrCodeGeneratedAt = Date.now()`)
6. **通知Master** - 发送新二维码

---

## 📈 二维码生命周期时间轴

```
t = 0秒        二维码生成
↓ (+150秒)
t = 150秒      ⏰ 二维码过期 (第1个二维码失效)
              └→ 自动触发 refreshQRCode()
              └→ 页面重新加载
              └→ 新二维码生成
↓ (+150秒)
t = 300秒      ⏰ 第2个二维码过期
              └→ 自动触发 refreshQRCode()
              └→ 页面重新加载
              └→ 新二维码生成
↓ (+150秒)
t = 450秒      ⏰ 第3个二维码过期
              └→ 自动触发 refreshQRCode()
              └→ 页面重新加载
              └→ 新二维码生成
↓ (+150秒)
t = 600秒      ⏰ 达到最大刷新次数 (3次)
              └→ ❌ 登录失败 - "QR code refresh limit exceeded"
```

**总体最长登录时间**: **~600秒 (10分钟)** = 4个二维码周期

---

## 🔍 抖音真实行为 vs 当前实现

### 问题诊断

你提到"二维码刷新时间与抖音真实的不同"，这可能有以下几种情况：

| 情况 | 当前实现 | 抖音真实 | 影响 |
|------|---------|---------|------|
| **刷新频率** | 150秒刷新一次 | ❓ 需要验证 | 如果抖音刷新更快，用户体验会差 |
| **检查间隔** | 每2秒检查 | ❓ 需要验证 | 如果不同，可能导致漏掉过期提示 |
| **最多刷新次数** | 3次 | ❓ 需要验证 | 如果抖音允许更多/更少刷新 |

### 需要验证的具体数据

要准确获知抖音的真实二维码刷新周期，需要：

1. **观察网络请求** - 查看前端每次刷新二维码时的API调用
2. **检查过期提示** - 页面上是否有"二维码已过期，请刷新"的提示及其触发时间
3. **分析JavaScript代码** - 抖音前端的二维码管理逻辑
4. **抓包分析** - 监控二维码相关的网络流量

---

## 🛠️ 如何获取真实的抖音二维码刷新周期

### 方法1: 浏览器DevTools观察

1. 打开 https://www.douyin.com/login
2. 打开DevTools → Network标签
3. 过滤包含"qrcode"、"login"的请求
4. 观察并记录以下时间点：
   - 第一个二维码出现的时间
   - 二维码变化（刷新）的时间间隔
   - 过期提示出现的时间
   - 新二维码生成的时间

### 方法2: 浏览器Console监控

```javascript
// 在DevTools Console中执行以下代码

// 监控二维码元素变化
const qrImg = document.querySelector('img[alt="二维码"]');
let lastSrc = qrImg?.src;
let refreshTimes = [];
let startTime = Date.now();

const observer = new MutationObserver(() => {
  const newSrc = qrImg?.src;
  if (newSrc !== lastSrc) {
    lastSrc = newSrc;
    const elapsed = (Date.now() - startTime) / 1000;
    refreshTimes.push(elapsed);
    console.log(`🔄 QR Code Refreshed at ${elapsed}s`);
    console.log('Refresh intervals (seconds):',
      refreshTimes.slice(1).map((t, i) => t - refreshTimes[i]).filter(v => v > 1));
  }
});

observer.observe(document.body, {
  subtree: true,
  attributes: true,
  attributeFilter: ['src']
});

// 每10秒打印一次统计信息
setInterval(() => {
  console.log(`⏱️  Elapsed: ${((Date.now() - startTime) / 1000).toFixed(1)}s`);
  console.log(`📊 Refresh count: ${refreshTimes.length}`);
  if (refreshTimes.length > 1) {
    const intervals = refreshTimes.slice(1).map((t, i) => t - refreshTimes[i]).filter(v => v > 1);
    console.log(`📈 Average interval: ${(intervals.reduce((a, b) => a + b, 0) / intervals.length).toFixed(1)}s`);
  }
}, 10000);
```

### 方法3: Playwright自动化监控脚本

创建脚本 `packages/worker/scripts/monitor-douyin-qr-refresh.js`:

```javascript
const { chromium } = require('playwright');

async function monitorQRRefresh() {
  const browser = await chromium.launch({ headless: false });
  const page = await browser.newPage();

  const refreshLog = [];
  let lastQRCode = null;
  let startTime = Date.now();

  // 监控所有响应中的二维码数据
  page.on('response', response => {
    const url = response.url();
    if (url.includes('qrcode') || url.includes('login')) {
      const elapsed = (Date.now() - startTime) / 1000;
      console.log(`[${elapsed.toFixed(1)}s] Response: ${url}`);
      refreshLog.push({ timestamp: elapsed, url });
    }
  });

  // 监控DOM变化
  await page.goto('https://www.douyin.com/login');

  await page.evaluate(() => {
    const qrImg = document.querySelector('img[alt="二维码"]');
    if (!qrImg) return;

    let lastSrc = qrImg.src;
    let refreshCount = 0;
    let startTime = Date.now();

    const checkInterval = setInterval(() => {
      const newSrc = qrImg?.src;
      if (newSrc && newSrc !== lastSrc) {
        lastSrc = newSrc;
        refreshCount++;
        const elapsed = (Date.now() - startTime) / 1000;
        console.log(`🔄 QR Refresh #${refreshCount} at ${elapsed.toFixed(1)}s`);
      }
    }, 1000);

    // 监听页面关闭
    window.addEventListener('beforeunload', () => {
      clearInterval(checkInterval);
    });
  });

  // 保持页面开放30分钟以观察多个刷新周期
  await page.waitForTimeout(30 * 60 * 1000);
  await browser.close();
}

monitorQRRefresh().catch(console.error);
```

运行方式:
```bash
cd packages/worker
node scripts/monitor-douyin-qr-refresh.js
```

---

## 📝 当前代码的关键位置

| 功能 | 文件 | 行号 |
|------|------|------|
| 时间配置 | `douyin-login-handler.js` | [32-36](packages/worker/src/browser/douyin-login-handler.js#L32-L36) |
| 二维码刷新逻辑 | `douyin-login-handler.js` | [389-431](packages/worker/src/browser/douyin-login-handler.js#L389-L431) |
| 轮询登录状态 | `douyin-login-handler.js` | [458-530](packages/worker/src/browser/douyin-login-handler.js#L458-L530) |
| 登录状态检查 | `douyin-login-handler.js` | [537-583](packages/worker/src/browser/douyin-login-handler.js#L537-L583) |

---

## 🎯 下一步建议

1. **运行监控脚本** - 使用方法3中的脚本在真实抖音上观察二维码刷新周期
2. **对比数据** - 将实际观察数据与当前实现的150秒对比
3. **调整参数** - 如果发现不符，修改 `QR_CODE_LIFETIME` 值
4. **测试验证** - 修改后进行登录测试，确保功能正常

---

## 📞 相关问题排查

**Q: 为什么用户反映二维码刷新太快/太慢?**
- 检查 `QR_CODE_LIFETIME` 的值是否合理
- 检查浏览器的系统时间是否准确
- 查看日志中 "QR code expired" 的时间间隔

**Q: 如何禁用自动刷新?**
修改 [douyin-login-handler.js:484](packages/worker/src/browser/douyin-login-handler.js#L484):
```javascript
// 改为
if (qrCodeAge > this.QR_CODE_LIFETIME * 999) { // 禁用刷新
```

**Q: 如何增加最大刷新次数?**
修改 [douyin-login-handler.js:69](packages/worker/src/browser/douyin-login-handler.js#L69):
```javascript
maxQRCodeRefreshes: 5, // 改为5次
```

