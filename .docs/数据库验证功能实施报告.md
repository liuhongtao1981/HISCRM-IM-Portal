# 数据库验证功能实施报告

**日期**: 2025-10-14
**版本**: 1.0.0
**状态**: ✅ 已完成

## 概述

为了防止类似 "Failed to fetch login sessions" 这样的数据库结构错误,我们在 Master 服务启动时添加了自动数据库结构验证功能。该功能会检查所有必需的表、字段和索引是否存在,并在发现问题时提供详细的错误信息。

## 问题背景

原始错误: `Failed to fetch login sessions`

根本原因:
1. 数据库 schema 中缺少 `login_sessions` 表定义
2. `accounts` 表缺少登录相关的字段 (`login_status`, `last_login_time`, `cookies_valid_until`)
3. 启动时没有验证数据库结构的完整性

## 实施内容

### 1. 修复 Schema 定义

**文件**: [packages/master/src/database/schema.sql](../packages/master/src/database/schema.sql)

#### 1.1 添加 login_sessions 表

```sql
-- ============================================
-- 8. login_sessions - 登录会话表
-- ============================================
CREATE TABLE IF NOT EXISTS login_sessions (
  id TEXT PRIMARY KEY,
  account_id TEXT NOT NULL,
  worker_id TEXT,
  status TEXT NOT NULL DEFAULT 'pending',
  login_method TEXT NOT NULL DEFAULT 'qrcode',
  qr_code_data TEXT,
  qr_code_url TEXT,
  error_message TEXT,
  expires_at INTEGER NOT NULL,
  logged_in_at INTEGER,
  created_at INTEGER NOT NULL,
  FOREIGN KEY (account_id) REFERENCES accounts(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_login_sessions_status ON login_sessions(status);
CREATE INDEX IF NOT EXISTS idx_login_sessions_account ON login_sessions(account_id);
CREATE INDEX IF NOT EXISTS idx_login_sessions_created ON login_sessions(created_at);
```

#### 1.2 扩展 accounts 表

```sql
CREATE TABLE IF NOT EXISTS accounts (
  -- ... 其他字段 ...
  login_status TEXT DEFAULT 'not_logged_in',      -- 新增
  last_login_time INTEGER,                         -- 新增
  cookies_valid_until INTEGER,                     -- 新增
  -- ... 其他字段 ...
);

CREATE INDEX IF NOT EXISTS idx_accounts_login_status ON accounts(login_status);  -- 新增
```

### 2. 创建数据库验证工具

**文件**: [packages/master/src/database/schema-validator.js](../packages/master/src/database/schema-validator.js) (新增)

#### 核心功能

1. **结构定义**: 维护完整的数据库 schema 定义作为验证基准
2. **表验证**: 检查每个表是否存在以及字段/索引是否完整
3. **错误报告**: 提供详细的缺失字段和索引列表
4. **修复建议**: 自动生成 ALTER TABLE SQL 语句用于修复

#### 验证的表和字段

| 表名 | 字段数 | 索引数 |
|------|--------|--------|
| accounts | 14 | 3 |
| comments | 11 | 3 |
| direct_messages | 10 | 3 |
| notifications | 10 | 2 |
| workers | 9 | 1 |
| client_sessions | 8 | 1 |
| notification_rules | 6 | 1 |
| login_sessions | 11 | 3 |

#### 关键 API

```javascript
const { validateDatabaseSchema, generateFixSQL } = require('./schema-validator');

// 验证整个数据库
const result = validateDatabaseSchema(db);
// result.valid: boolean
// result.tables: { [tableName]: { valid, missingColumns, missingIndexes } }
// result.summary: { totalTables, validTables, invalidTables, missingTables }

// 生成修复 SQL
const fixSQL = generateFixSQL(result);
```

### 3. 集成到启动流程

**文件**: [packages/master/src/database/init.js](../packages/master/src/database/init.js)

#### 修改点

```javascript
function initDatabase(dbPath = './data/master.db', options = {}) {
  const { validateSchema = true, strictValidation = true } = options;

  // ... 创建数据库、执行 schema.sql ...

  // 新增: 验证数据库结构
  if (validateSchema) {
    const validationResult = validateDatabaseSchema(db);

    if (!validationResult.valid) {
      if (strictValidation) {
        throw new Error('Database schema validation failed');
      } else {
        logger.warn('Schema validation failed but continuing');
      }
    }
  }

  return db;
}
```

#### 配置选项

- `validateSchema` (默认: true) - 是否启用验证
- `strictValidation` (默认: true) - 验证失败时是否抛出异常

### 4. 修复其他相关问题

#### 4.1 修复 admin-namespace.js 查询

**文件**: [packages/master/src/socket/admin-namespace.js](../packages/master/src/socket/admin-namespace.js)

**问题**: SQL 查询引用了不存在的 `w.name` 字段

```javascript
// 修改前
w.name as worker_name

// 修改后
w.id as worker_name  // workers 表只有 id 字段
```

#### 4.2 修复 workspace 依赖

**文件**: [packages/master/package.json](../packages/master/package.json)

添加 shared 包依赖:

```json
"dependencies": {
  "@hiscrm-im/shared": "workspace:*",
  // ... 其他依赖 ...
}
```

**文件**: [packages/shared/package.json](../packages/shared/package.json)

添加 winston 依赖:

```json
"dependencies": {
  "uuid": "^9.0.1",
  "winston": "^3.11.0"
}
```

## 测试验证

### 测试脚本

创建了 [test-db-validation.js](../packages/master/test-db-validation.js) 进行功能验证。

### 测试结果

```bash
cd packages/master && node test-db-validation.js
```

✅ **测试1**: 验证完整的数据库结构 - **通过**
- 所有 8 个表验证通过
- 所有字段和索引正确

✅ **测试2**: 验证缺失字段的数据库 - **通过**
- 成功检测到缺失的字段和索引
- 提供详细的错误信息

✅ **测试3**: 非严格验证模式 - **通过**
- 验证失败但不抛出异常
- 允许服务继续运行

## 启动日志示例

```
2025-10-14 11:39:56.774 [database-init] info: Validating database schema...
2025-10-14 11:39:56.775 [schema-validator] info: Starting database schema validation...
2025-10-14 11:39:56.776 [schema-validator] info: ✓ Table 'accounts' validation passed
2025-10-14 11:39:56.776 [schema-validator] info: ✓ Table 'comments' validation passed
2025-10-14 11:39:56.776 [schema-validator] info: ✓ Table 'direct_messages' validation passed
2025-10-14 11:39:56.777 [schema-validator] info: ✓ Table 'notifications' validation passed
2025-10-14 11:39:56.777 [schema-validator] info: ✓ Table 'workers' validation passed
2025-10-14 11:39:56.778 [schema-validator] info: ✓ Table 'client_sessions' validation passed
2025-10-14 11:39:56.778 [schema-validator] info: ✓ Table 'notification_rules' validation passed
2025-10-14 11:39:56.778 [schema-validator] info: ✓ Table 'login_sessions' validation passed
2025-10-14 11:39:56.778 [schema-validator] info:
2025-10-14 11:39:56.778 [schema-validator] info: Database Schema Validation Summary:
2025-10-14 11:39:56.778 [schema-validator] info:   Total tables: 8
2025-10-14 11:39:56.779 [schema-validator] info:   Valid tables: 8
2025-10-14 11:39:56.779 [schema-validator] info:   Invalid tables: 0
2025-10-14 11:39:56.779 [schema-validator] info: ✓ Database schema validation PASSED
2025-10-14 11:39:56.779 [database-init] info: Database schema validation passed ✓
```

## 收益

### 1. 问题早期发现
- 在启动时立即发现数据库结构问题
- 避免运行时出现 "no such column" 错误

### 2. 清晰的错误信息
- 精确指出缺失的表、字段和索引
- 提供具体的修复建议

### 3. 开发体验改善
- 新开发者首次启动时能快速发现配置问题
- 数据库迁移后能立即验证迁移结果

### 4. 生产环境保障
- 防止因数据库结构不完整导致的服务异常
- 支持非严格模式用于特殊场景

## 使用指南

### 正常启动 (默认行为)

```bash
cd packages/master
npm start
```

数据库验证会自动执行,验证失败会阻止服务启动。

### 跳过验证 (不推荐)

修改 `src/index.js`:

```javascript
db = initDatabase(DB_PATH, { validateSchema: false });
```

### 非严格模式

```javascript
db = initDatabase(DB_PATH, { strictValidation: false });
```

验证失败会记录警告但不会阻止启动。

### 手动验证现有数据库

```javascript
const Database = require('better-sqlite3');
const { validateDatabaseSchema } = require('./src/database/schema-validator');

const db = new Database('./data/master.db');
const result = validateDatabaseSchema(db);
console.log(result);
```

## 维护指南

### 添加新表时

1. 在 `schema.sql` 中添加 CREATE TABLE 语句
2. 在 `schema-validator.js` 的 `REQUIRED_SCHEMA` 中添加表定义:

```javascript
const REQUIRED_SCHEMA = {
  // ... 现有表 ...
  new_table_name: {
    columns: ['id', 'field1', 'field2', ...],
    indexes: ['idx_new_table_field1', ...],
  },
};
```

3. 更新数据库字典文档

### 添加新字段时

1. 在 `schema.sql` 中更新 CREATE TABLE 语句
2. 在 `schema-validator.js` 的对应表定义中添加字段名
3. 如果添加索引,同时更新 indexes 数组

## 相关文件

### 新增文件
- [packages/master/src/database/schema-validator.js](../packages/master/src/database/schema-validator.js) - 验证工具
- [packages/master/test-db-validation.js](../packages/master/test-db-validation.js) - 测试脚本

### 修改文件
- [packages/master/src/database/schema.sql](../packages/master/src/database/schema.sql) - Schema 定义
- [packages/master/src/database/init.js](../packages/master/src/database/init.js) - 数据库初始化
- [packages/master/src/socket/admin-namespace.js](../packages/master/src/socket/admin-namespace.js) - 查询修复
- [packages/master/package.json](../packages/master/package.json) - 依赖配置
- [packages/shared/package.json](../packages/shared/package.json) - 依赖配置

## 性能影响

- 验证时间: < 100ms (8个表)
- 内存开销: 可忽略
- 仅在启动时执行一次,对运行时性能无影响

## 未来改进

1. **数据库迁移工具**: 自动执行 ALTER TABLE 修复缺失字段
2. **版本管理**: 支持 schema 版本号和升级路径
3. **自定义验证规则**: 允许定义字段类型、约束等更详细的验证
4. **持续监控**: 运行时定期验证关键表结构

## 总结

✅ 成功实现了启动时的数据库结构验证功能
✅ 修复了 `login_sessions` 表缺失的问题
✅ 添加了完整的测试用例
✅ 提供了清晰的错误提示和使用文档

这个功能将帮助团队更快地发现和解决数据库结构问题,提升系统的健壮性和可维护性。
